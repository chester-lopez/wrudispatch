var a=function(t,e){$("body").on("click","#overlay #close",function(t){$(this).parents("#overlay").remove()});var i=new URLSearchParams(window.location.search),s=CRYPTO.DECRYPT(i.get("data")),n=s._ids||[],r=s.username||"",a=s.name||"",l=s.clientId||"",o=Number(s.escalation),d={};function m(t,e){e.events_captured=e.events_captured||{};var i,s,n=OBJECT.sortByKey(e.events_captured),r=0;return Object.keys(n).forEach(e=>{n[e]==t?i=Number(e):i&&!s&&(s=Number(e),r+=s-i,i=null,s=null)}),i&&!s&&(r=0),r}function c(t,e,i="first"){e.events_captured=e.events_captured||{};var s=OBJECT.sortByKey(e.events_captured),n=0;return Object.keys(s).forEach(e=>{s[e]==t&&("first"!=i||n||(n=Number(e)),"last"==i&&(n=Number(e))),t||("first"!=i||n||(n=Number(e)),"last"==i&&(n=Number(e)))}),n}function h(t=""){var e={color:"label-default",text:""};return"plan"==t&&(e={color:"label-info",text:"Plan"}),"assigned"==t&&(e={color:"label-brown",text:"Assigned"}),"scheduled"==t&&(e={color:"label-default",text:"Scheduled"}),"queueingAtOrigin"==t&&(e={color:"label-warning",text:"Queueing (Origin)"}),"processingAtOrigin"==t&&(e={color:"label-lime",text:"Processing (Origin)"}),"idlingAtOrigin"==t&&(e={color:"label-purple",text:"Idling (Origin)"}),"in_transit"==t&&(e={color:"label-orange",text:"In Transit"}),"onSite"==t&&(e={color:"label-blue",text:"On-Site"}),"returning"==t&&(e={color:"label-pink",text:"Returning"}),"complete"==t&&(e={color:"label-success",text:"Complete"}),"incomplete"==t&&(e={color:"label-danger",text:"Incomplete"}),"deleted"==t&&(e={color:"label-default",text:"Deleted"}),{html:`<span class="label ${e.color} label-transparent">${e.text.toUpperCase()}</span>`,color:e.color,text:e.text}}if(n.length>0){var u=[],b=[];n.forEach(t=>{u.push(t._id)}),d._id={$in:u},$.ajax({url:`/api/remarks/${l}/${JSON.stringify(d)}`,method:"GET",timeout:9e4}).done(function(t){if(b=t,t.length>0){var e='<option value="" selected="true" disabled="disabled">Select Shipment Number</option>';t.forEach(t=>{var i=n.find(e=>e._id==t._id);e+=`<option value="${t._id}">${t._id} - ${i.delay}, Escalation ${o}</option>`}),$("#body-main").html(`<div style="height: 100%;background-color: #00800014;">\n                                        <div style="background-color: green;width: 100%;height: 10em;display: inline-block;"></div>\n                                        <div class="remarks-container">\n                                            <div class="col-sm-12 pt-4 pb-2 pr-4 pl-4">\n                                                <h3 class="text-dark">Shipment Entry Remarks</h3>\n                                                <h5 class="mt-5">Hello <b>${a||""}</b>,<br><br><br>Please select the shipment number you wish to add your remarks.</h5>\n                                                <select id="sn" class="form-control mt-2">${e}</select>\n                                            </div>\n                                            <div id="remarks-container" class="col-sm-12 pt-0 pl-4 pr-4 pb-4"></div>\n                                        </div>\n                                    </div>`),$("#sn").change(function(){var t=$(this).val();$("#remarks-container").html(`<h5>Please add your remarks in the textbox below.</h5>\n                                                <textarea id="${t}-remarks" class="form-control" placeholder="Add your remarks here..."></textarea>\n                                                <a href="javascript:void(0);" id="${t}-view" class="d-block mt-3">Click to view the shipment details</a>\n                                                <button id="${t}-btn" class="btn btn-success mt-4" disabled>Submit</button>`),$(`#${t}-remarks`).keyup(function(){$(`#${t}-btn`).attr("disabled",""==$(this).val().trim())}),$(`#${t}-view`).click(function(){var e=new class{constructor(t){t.events_captured=t.events_captured||{},t.destination=t.destination||[],t.destination[0]=t.destination[0]||{},m("entered_origin",t);var e=m("queueingAtOrigin",t),i=m("processingAtOrigin",t),s=m("idlingAtOrigin",t),n=m("in_transit",t),r=t._user||{},a=t._origin||{},l=t._destination||{},o=t._route||{},d=t._vehicle||{},u=t._driver||{},b=t._checker||{},p=t._region||{},T=t._cluster||{},g=t._trailer||{},$=r.name||t.username,_=c("entered_origin",t)||c("queueingAtOrigin",t)||c("processingAtOrigin",t)||c("idlingAtOrigin",t),v=_?c("in_transit",t,"last")-_:0,E=["in_transit","complete","incomplete"].includes(t.status)?DATETIME.DH(v||0):"-",y="-"==E?"-":DATETIME.HH_MM(null,E).hour_minute,M="-"==E?"-":DATETIME.HH_MM(null,5).hour_minute,f=!!a.short_name&&a.short_name.indexOf(" PL")>-1;"_API_"==$&&($="Server"),this._id=t._id,this.ticket_number=t.ticket_number||"-",this.departure_date=DATETIME.FORMAT(t.departure_date),this.region=p.region||"-",this.cluster=T.cluster||"-",this.origin=a.short_name||"-",this.route=t.route||"-",this.destination=l.short_name||"-",this.etd=DATETIME.FORMAT(t.destination[0].etd),this.eta=DATETIME.FORMAT(t.destination[0].eta),this.target_transit_time=DATETIME.HH_MM(null,o.transit_time).hour_minute,this.target_cico_time=DATETIME.HH_MM(null,a.cico).hour_minute,this.vehicle=d.name||"-",this.conduction_number=d["Tractor Conduction"]||"-",this.trailer=g._id||"-",this.pal_cap=g.pal_cap||"-",this.driver=u.name||"-",this.checker=b.name||"-",this.comments=t.comments||"-",this.entered_datetime=DATETIME.FORMAT(c(null,t)),this.queueing_datetime=DATETIME.FORMAT(c("queueingAtOrigin",t)),this.queueingDuration=DATETIME.HH_MM(e).hour_minute,this.processing_datetime=DATETIME.FORMAT(c("processingAtOrigin",t)),this.processingDuration=DATETIME.HH_MM(i).hour_minute,this.idling_datetime=DATETIME.FORMAT(c("idlingAtOrigin",t)),this.idlingDuration=DATETIME.HH_MM(s).hour_minute,this.cico=["in_transit","onSite","returning","complete","incomplete"].includes(t.status)?y:"-",this.cico_capped=["in_transit","onSite","returning","complete","incomplete"].includes(t.status)?E>5&&f?M:y:"-",this.transit_datetime=["in_transit","onSite","returning","complete","incomplete"].includes(t.status)?DATETIME.FORMAT(c("in_transit",t,"last")):"-",this.transitDuration=["in_transit","onSite","returning","complete","incomplete"].includes(t.status)?DATETIME.HH_MM(n).hour_minute:"-",this.onSite_datetime=["onSite","returning","complete","incomplete"].includes(t.status)?DATETIME.FORMAT(c("onSite",t,"last")):"-",this.returning_datetime=["returning","complete","incomplete"].includes(t.status)?DATETIME.FORMAT(c("returning",t,"last")):"-",this.complete_datetime=["complete"].includes(t.status)?DATETIME.FORMAT(c("complete",t,"last")):"-",this.status=h(t.status).html,this.statusText=h(t.status).text,this.scheduled_date=DATETIME.FORMAT(t.scheduled_date,"MMM DD, YYYY"),this.shift_schedule=t.shift_schedule||"-",this.posted_by=$,this.posting_date=DATETIME.FORMAT(t.posting_date),this.late_entry=t.late_entry?"Yes".bold():"No",this.ongoingHTML="complete"!=t.status?'<span class="ongoing" style="width: 7px;height: 7px;background: #00a548;border-radius: 20px;top: 14px;margin-left: 4px;position: absolute;"></span>':"";var k="";Object.keys(t.esc1_remarks||{}).forEach(e=>{var i=t.esc1_remarks[e];k+=`${i.remarks}<div class="font-11 text-muted mb-1">${i.username} | ${DATETIME.FORMAT(Number(e))}</div>`});var A="";Object.keys(t.esc2_remarks||{}).forEach(e=>{var i=t.esc2_remarks[e];A+=`${i.remarks}<div class="font-11 text-muted mb-1">${i.username} | ${DATETIME.FORMAT(Number(e))}</div>`});var D="";Object.keys(t.esc3_remarks||{}).forEach(e=>{var i=t.esc3_remarks[e];D+=`${i.remarks}<div class="font-11 text-muted mb-1">${i.username} | ${DATETIME.FORMAT(Number(e))}</div>`}),this.esc1_remarks=k||"-",this.esc2_remarks=A||"-",this.esc3_remarks=D||"-",this.history=t.history||{}}tbl(){var t="width: 50%;float: left !important;padding-bottom: 2px;",e='style="font-weight: bold;vertical-align:top;"';return{tr:t,tdFirst:e,empty:`<tr style="${t}">\n                            <td class="tdFirst" ${e}>&nbsp;</td>\n                            <td>&nbsp;</td>\n                        </tr>`,getTr:(i,s,n="",r="",a)=>`<tr style="${a||t} ${n}">\n                                <td class="tdFirst" ${e}>${i}</td>\n                                <td ${r}>${s?`: ${s}`:""}</td>\n                            </tr>`}}historyHTML(t={}){var e="";const i=t.original,s=OBJECT.sortByKey(t),n={};if(Object.keys(s).reverse().forEach(function(e){n[e]=t[e]}),Object.keys(n).forEach(t=>{if(!["original","vehicle"].includes(t)){var i=DATETIME.FORMAT(new Date(Number(t)),"MMM D, YYYY, h:mm A"),s=n[t]||"-";if(s.indexOf("System - Status updated")>-1){var r=GET.TEXT_BETWEEN(s,"<status>","</status>")||GET.TEXT_BETWEEN(s,"'","'");e+=` <div class="pt-3">\n                                    <small class="text-muted">${i}</small>\n                                    <div>Status updated to ${h(r).html}</div>\n                                </div>`}else if(s.indexOf("Manual - Status updated")>-1){r=GET.TEXT_BETWEEN(s,"<status>","</status>")||GET.TEXT_BETWEEN(s,"'","'");var a=GET.TEXT_BETWEEN(s,"<username>","</username>");e+=` <div class="pt-3">\n                                    <small class="text-muted">${i}</small>\n                                    <div>Status manually updated to ${h(r).html} by ${a||"-"}.</div>\n                                </div>`}else(r=GET.TEXT_BETWEEN(s,"<status>","</status>"))&&(s=s.replace(`<status>${r}</status>`,h(r).html)),e+=` <div class="pt-3">\n                                    <small class="text-muted">${i}</small>\n                                    <div>${s}</div>\n                                </div>`}}),i){var r=JSON.parse(i);e+=` <div class="pt-3">\n                            <small class="text-muted">${DATETIME.FORMAT(new Date(r.posting_date),"MMM D, YYYY, h:mm A")}</small>\n                            <div>Entry posted with status ${h(r.status).html}</div>\n                        </div>`}return e}fullView(){return`<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;z-index:999999 !important;">\n                        <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">\n                            <div role="document" class="modal-dialog modal-lg" style="margin:20px auto;width:90%;">\n                                <div class="modal-content">\n                                    <div class="modal-header pb-2">\n                                        <button type="button" class="close" id="close" aria-hidden="true">×</button>\n                                        <div class="float-left">\n                                            <h4 class="modal-title" id="myModalLabel2">\n                                                <b>${this._id}${"wilcon"==l?` | ${this.ticket_number}`:""}</b> \n                                                <div style="display: inline-block;top: -4px;position: relative;margin-left: 2px;font-size: 12px;">${this.status}</div>\n                                            </h4>\n                                            <div>Full Entry Details</div>\n                                        </div>\n                                    </div>\n                                    <div class="modal-body row p-0" max-height: 480px;overflow-y: auto;>\n                                        <div class="main-details col-sm-9" style="border-right: 1px solid #eee;padding: 15px 0px 10px 30px !important;">\n                                            <table>\n                                                <tbody>\n                                                    ${this.tbl().getTr("Region",this.region)}\n                                                    ${this.tbl().getTr("Origin",this.origin)}\n                                                    ${this.tbl().getTr("Cluster",this.cluster)}\n                                                    ${this.tbl().getTr("Destination",this.destination)}\n                                                    ${this.tbl().getTr("Route",this.route)} ${this.tbl().empty} \n\n                                                    ${this.tbl().empty} ${this.tbl().empty}\n\n                                                    ${this.tbl().getTr("Vehicle",this.vehicle)}\n                                                    ${this.tbl().getTr("Trailer",this.trailer)}\n                                                    ${this.tbl().getTr("Pal Cap",this.pal_cap)}\n                                                    ${this.tbl().getTr("Conduction #",this.conduction_number)}\n\n                                                    ${this.tbl().empty} ${this.tbl().empty}\n\n                                                    ${"wilcon"==l?`\n                                                        ${this.tbl().getTr("Driver",this.driver)}\n                                                        ${this.tbl().getTr("Checker",this.checker)}\n\n                                                        ${this.tbl().empty} ${this.tbl().empty}\n                                                    `:""}\n\n                                                    ${this.tbl().getTr("Check In Date & Time",this.entered_datetime)} ${this.tbl().empty}\n                                                    ${this.tbl().getTr("Queueing Duration",this.queueingDuration)} ${this.tbl().empty}\n                                                    ${this.tbl().getTr("Processing Duration",this.processingDuration)} ${this.tbl().empty}\n                                                    ${this.tbl().getTr("Idling Duration",this.idlingDuration)} ${this.tbl().empty}\n                                                    ${this.tbl().getTr("Check Out Date & Time",this.transit_datetime)} ${this.tbl().empty}\n\n                                                    ${this.tbl().empty} ${this.tbl().empty}\n\n                                                    ${this.tbl().getTr("CICO Time",this.cico)}\n                                                    ${this.tbl().getTr("Target CICO Time",this.target_cico_time)}\n                                                    ${this.tbl().getTr("Transit Time",this.transitDuration)}\n                                                    ${this.tbl().getTr("Target Transit Time",this.target_transit_time)}\n\n                                                    ${this.tbl().empty} ${this.tbl().empty}\n                                                    \n                                                    ${l?`\n                                                        ${this.tbl().getTr("On-Site Date & Time",this.onSite_datetime)} ${this.tbl().empty}\n                                                        ${this.tbl().getTr("Returned Date & Time",this.returning_datetime)} ${this.tbl().empty}\n                                                        ${this.tbl().getTr("Completion Date & Time",this.complete_datetime)} ${this.tbl().empty}\n                                                    `:` \n                                                        ${this.tbl().getTr("Completion Date & Time",this.complete_datetime)}\n                                                    `}\n                                                </tbody>\n                                            </table>\n                                            <div class="border-bottom mb-2 mt-2"></div>\n                                            <table>\n                                                <tbody>\n                                                    ${this.tbl().getTr("Late Entry",this.late_entry)}\n                                                    ${this.tbl().getTr("Comments",this.comments)}\n\n                                                    ${this.tbl().empty} ${this.tbl().empty}\n\n                                                    ${"wilcon"==l?`\n                                                        ${this.tbl().getTr("Scheduled Date",this.scheduled_date)}\n                                                        ${this.tbl().getTr("Shift Schedule",this.shift_schedule)}\n                                                    `:""}\n                                                    \n                                                    ${this.tbl().getTr("Posted By",this.posted_by)}\n                                                    ${this.tbl().getTr("Posting Date",this.posting_date)}\n                                                </tbody>\n                                            </table>\n                                            <div class="border-bottom mb-2 mt-2"></div>\n                                            <table>\n                                                <tbody>\n                                                    ${this.tbl().getTr("Escalation 1 Remarks",this.esc1_remarks,"","","padding-bottom: 2px;")}\n                                                    ${this.tbl().getTr("Escalation 2 Remarks",this.esc2_remarks,"","","padding-bottom: 2px;")}\n                                                    ${this.tbl().getTr("Escalation 3 Remarks",this.esc3_remarks,"","","padding-bottom: 2px;")}\n                                                </tbody>\n                                            </table>\n                                        </div>\n                                        <div class="history-details col-sm-3" style="overflow-y: auto;padding-right:30px;">\n                                            <h5 class="mb-1">Logs</h5>\n                                            ${this.historyHTML(this.history)}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>`}}(b.find(e=>e._id==t));$("body").append(e.fullView())}),$(`#${t}-btn`).click(function(){var e=$(`#${t}-remarks`).val();if(""==e.trim())alert("Error: Please fill in the textbox.");else{var i={},s=n.find(e=>e._id==t);1==o&&(i[`esc1_remarks.${(new Date).getTime()}`]={remarks:e,username:r,type:s.type}),2==o&&(i[`esc2_remarks.${(new Date).getTime()}`]={remarks:e,username:r,type:s.type}),3==o&&(i[`esc3_remarks.${(new Date).getTime()}`]={remarks:e,username:r,type:s.type}),Object.keys(i).length>0&&($(`#${t}-remarks`).attr("disabled",!0),$(`#${t}-btn`).html('<i class="la la-spin la-spinner"></i> Submit').attr("disabled",!0),i[`history.${(new Date).getTime()}`]=`<username>${r}</username> added a comment/remark.`,GET.AJAX({url:`/api/remarks/${l}/${r}/${t}`,method:"PUT",headers:{"Content-Type":"application/json; charset=utf-8"},data:JSON.stringify(i)},function(e){if(1==e.ok){toastr.info("Remarks submitted."),$(`#${t}-btn`).html("Submit").attr("disabled",!0),$(`#${t}-remarks`).attr("disabled",!1).val("");var i=e.docs[0],s=b.findIndex(t=>t._id==i._id);b[s]=i}else toastr.error("Something went wrong</br></br>Error Code - ec023/03")},function(t){console.log(t),toastr.error("Something went wrong</br></br>Error Code - ec023/03")}))}})})}else alert("Error: Shipment does not exist.")})}else alert("Error: Empty shipment list.")};