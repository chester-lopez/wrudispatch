/************** GLOBAL VARIABLES **************/
var vehiclePersonnelCalendarOptions = {
    rest_days: { optionTitle: "Rest Days", label: "Rest Day",   hex: "#0070C0" },
    on_leave:  { optionTitle: "On Leave",  label: "On Leave",   hex: "#0070C0" },
    suspended: { optionTitle: "Suspended", label: "Suspended",  hex: "#C65911" },
    absent:    { optionTitle: "Absences",  label: "Absent",     hex: "#FF0000" },
    awol:      { optionTitle: "AWOL",      label: "AWOL",       hex: "#FF0000" },
};
/************** END GLOBAL VARIABLES **************/

function matcher(query, data,opt) {
    // https://jsfiddle.net/adigas/2g1q5ypn/
    // console.log(query,data);

    var id = $(data.element).parent().attr("id");

    var arrTerm = (query.term||"").split(",");
    var term1 = (arrTerm[0]||"")._trim().toUpperCase();
    var term2 = (arrTerm[1]||"")._trim().toUpperCase();

    var text = (data.text||"").toUpperCase();
    
    var fullSubText = ($(data.element).attr("data-subtext")||"").replace(/<br>/g," ").toUpperCase();
    var arrSubText = ($(data.element).attr("data-subtext")||"").split("<br>");
    var subText1 = (arrSubText[0]||"")._trim().toUpperCase();
    var subText2 = (arrSubText[1]||"")._trim().toUpperCase();
    var subText3 = (arrSubText[2]||"")._trim().toUpperCase();

    if(id == "route"){
        if(!query.term || (!term2 && text.indexOf(term1) > -1) || ((text.indexOf(term1) > -1 || subText1.indexOf(term1) > -1) && subText2.indexOf(term2) > -1)){
            return data;
        }
        else return null;
    } else if(id == "vehicle_id"){
        var tempSubText = (subText2.indexOf("TRAILER") > -1) ? subText3 : subText2;
        if(!query.term || text.indexOf(term1) > -1 || subText1.indexOf(term1) > -1 || tempSubText.indexOf(term1) > -1){
            return data;
        }
        else return null;
        // var tempSubtext = [];
        // arrSubText.forEach(val => {
        //     if(val.indexOf("Trailer") == -1){
        //         tempSubtext.push(val);
        //     }
        // });
        // tempSubtext = tempSubtext.join(" ").toUpperCase();

        // if(!query.term || text.indexOf(term1) > -1 || tempSubtext.indexOf(term1) > -1){
        //     return data;
        // }
        // else return null;
    } else {
        if(fullSubText.indexOf(term1) > -1 || text.indexOf(term1) > -1){
            return data;
        }
        else return null;
    }
};
function templateResult(state) {
    return $(state.element).attr('data-subtext') ? 
            $('<div><b>' + state.text + '</b><div class="text-muted">'
            + ($(state.element).attr('data-subtext')||"")
            + '</div></div>') 
            : 
            $('<div>' + state.text + '</div>');
};
function formatResult(result, container, query, escapeMarkup) {
    var markup=[];
    window.Select2.util.markMatch(result.text, query.term, markup, escapeMarkup);
    if (result.isNew) {
        return markup.join("");
    } else {
        return '<span class="post-tag">'+markup.join("")+'</span><span class="item-multiplier">×&nbsp;'+result.count+'</span>';
    }
};
function templateResult(state) {
    return $(state.element).attr('data-subtext') ? 
            $('<div><b>' + state.text + '</b><div class="text-muted">'
            + ($(state.element).attr('data-subtext')||"")
            + '</div></div>') 
            : 
            $('<div>' + state.text + '</div>');
};
function getSelect2Options(){
    /******** CUSTOMERS ********/
    G_SELECT2["form-customers"] = `<option value="">&nbsp;</option>`;
    (LIST["customers"]||[]).forEach(val => {
        var subtext = "Customer Number: " + val._id;
        (!val.delete) ? G_SELECT2["form-customers"] += `<option value="${val._id}" data-subtext="${subtext}">${val.name}</option>` : null;
    });
    /******** END CUSTOMERS ********/


    /******** VEHICLES ********/
    G_SELECT2["form-vehicles"] = `<option value="">&nbsp;</option>`;
    G_SELECT2["form-vehicles-admin"] = `<option value="">&nbsp;</option>`;
    (LIST["vehicles"]||[]).filter(x => !x.underMaintenance).forEach(val => {
        var status = VEHICLES.STATUS.find(x => x.id == (val.status || "")) || {value: "Available"};
        var subtext = "";
        var subtextAdmin = "";
        try {
            function getSubtext(type) {
                var _array_ = [];
                var _custom_ = clientCustom.gSelect2.vehicles[type] || [];
                _custom_.forEach(_val_ => {
                    switch(_val_) {
                        case "trailer":
                            var trailer = getTrailer(val.name);
                            var trailerValue = (trailer) ? "Straight Truck" : (val["Trailer"]||"-");
                            _array_.push(`Trailer: ${trailerValue}`);
                            break;
                        case "plate_number":
                            _array_.push(`Plate Number: ${val["Plate Number"] || "-"}`);
                            break;
                        case "truck_number":
                            _array_.push(`Truck Number: ${val["Truck Number"] || "-"}`);
                            break;
                        case "conduction_number":
                            _array_.push(`Conduction #: ${val["Tractor Conduction"]||"-"}`);
                            break;
                        case "availability":
                            _array_.push(`Availability: ${status.value}`);
                            break;
                        default:
                            // code block
                    } 
                });
                return _array_.join("<br>");
            }
            subtext = getSubtext("subtext");
            subtextAdmin = getSubtext("subtextAdmin");
        } catch(error){}

        // do not remove username. Used in "checkSelectedVehicleWithinGeofence" function
        G_SELECT2["form-vehicles-admin"] += `<option value="${val._id}" username="${val.username}" data-subtext="${subtextAdmin}">${val.name}</option>`;
        G_SELECT2["form-vehicles"] += `<option value="${val._id}" username="${val.username}" data-subtext="${subtext}">${val.name}</option>`;
    });
    /******** END VEHICLES ********/

    /******** VEHICLES SECTION ********/
    G_SELECT2["form-vehicles_section"] = `<option value="">&nbsp;</option>`;
    (LIST["vehicles_section"]||[]).forEach(val => {
        (!val.delete) ? G_SELECT2["form-vehicles_section"] += `<option value="${val._id}">${val.section}</option>` : null;
    });
    /******** END VEHICLES SECTION ********/

    /******** VEHICLES COMPANY ********/
    G_SELECT2["form-vehicles_company"] = `<option value="">&nbsp;</option>`;
    (LIST["vehicles_company"]||[]).forEach(val => {
        (!val.delete) ? G_SELECT2["form-vehicles_company"] += `<option value="${val._id}">${val.company}</option>` : null;
    });
    /******** END VEHICLES COMPANY ********/

    /******** REGIONS ********/
    G_SELECT2["form-regions"] = `<option value="">&nbsp;</option>`;
    const sortedRegions = ARRAY.OBJECT.sort((LIST["regions"]||[]),"sequence",{sortType:"asc"});
    sortedRegions.forEach(val => {
        (!val.delete) ? G_SELECT2["form-regions"] += `<option value="${val._id}">${val.code}</option>` : null;
    });
    /******** END REGIONS ********/

    /******** CLUSTERS ********/
    G_SELECT2["form-clusters"] = `<option value="">&nbsp;</option>`;
    (LIST["clusters"]||[]).forEach(val => {
        (!val.delete) ? G_SELECT2["form-clusters"] += `<option value="${val._id}">${val.cluster}</option>` : null;
    });
    /******** END CLUSTERS ********/
    
    /******** VEHICLE PERSONNEL ********/
    // G_SELECT2["form-vehicle_personnel"] = `<option value="">&nbsp;</option>`;
    // (LIST["vehicle_personnel"]||[]).forEach(val => {
    //     var subtext = `Occupation: ${val.occupation||"-"}<br>ID Number: ${val.id_number||"-"}`;
    //     G_SELECT2["form-vehicle_personnel"] += `<option value="${val._id}" data-subtext="${subtext}">${val.name}</option>`;
    // });
    /******** END VEHICLE PERSONNEL ********/

    /******** VEHICLE PERSONNEL SECTION ********/
    G_SELECT2["form-vehicle_personnel_section"] = `<option value="">&nbsp;</option>`;
    (LIST["vehicle_personnel_section"]||[]).forEach(val => {
        (!val.delete) ? G_SELECT2["form-vehicle_personnel_section"] += `<option value="${val._id}">${val.section}</option>` : null;
    });
    /******** END VEHICLE PERSONNEL SECTION ********/

    /******** VEHICLE PERSONNEL COMPANY ********/
    G_SELECT2["form-vehicle_personnel_company"] = `<option value="">&nbsp;</option>`;
    (LIST["vehicle_personnel_company"]||[]).forEach(val => {
        (!val.delete) ? G_SELECT2["form-vehicle_personnel_company"] += `<option value="${val._id}">${val.company}</option>` : null;
    });
    /******** END VEHICLE PERSONNEL COMPANY ********/
    
    /******** CHASSIS ********/
    G_SELECT2["form-chassis"] = `<option value="">&nbsp;</option>`;
    (LIST["chassis"]||[]).forEach(val => {
        var type = (getChassisType(val.type_id)||{}).type;
        var section = (getChassisSection(val.section_id)||{}).section;
        var company = (getChassisCompany(val.company_id)||{}).company;

        var subtext = `Chassis Type: ${type||"-"}<br>Section: ${section||"-"}<br>Company: ${company||"-"}`;
        G_SELECT2["form-chassis"] += `<option value="${val._id}" data-subtext="${subtext}">${val._id}</option>`;
    });
    /******** END CHASSIS ********/

    /******** CHASSIS SECTION ********/
    G_SELECT2["form-chassis_section"] = `<option value="">&nbsp;</option>`;
    (LIST["chassis_section"]||[]).forEach(val => {
        (!val.delete) ? G_SELECT2["form-chassis_section"] += `<option value="${val._id}">${val.section}</option>` : null;
    });
    /******** END CHASSIS SECTION ********/

    /******** CHASSIS COMPANY ********/
    G_SELECT2["form-chassis_company"] = `<option value="">&nbsp;</option>`;
    (LIST["chassis_company"]||[]).forEach(val => {
        (!val.delete) ? G_SELECT2["form-chassis_company"] += `<option value="${val._id}">${val.company}</option>` : null;
    });
    /******** END CHASSIS COMPANY ********/

    /******** CHASSIS TYPE ********/
    G_SELECT2["form-chassis_type"] = `<option value="">&nbsp;</option>`;
    (LIST["chassis_type"]||[]).forEach(val => {
        (!val.delete) ? G_SELECT2["form-chassis_type"] += `<option value="${val._id}">${val.type}</option>` : null;
    });
    /******** END CHASSIS TYPE ********/
    
    /******** SHIFT SCHEDULE ********/
    G_SELECT2["form-shift_schedule"] = ``;
    (LIST["shift_schedule"]||[]).forEach(val => {
        G_SELECT2["form-shift_schedule"] += `<option value="${val._id}">${val._id}</option>`;
    });
    /******** END SHIFT SCHEDULE ********/
    
    /******** TRAILERS ********/
    G_SELECT2["form-trailers"] = `<option value="">&nbsp;</option><option disabled>Straight Truck</option>`;
    (LIST["trailers"]||[]).forEach(val => {
        var subtext = `Pal Cap: ${val.pal_cap||"-"}<br>Region: ${val.region||"-"}<br>Cluster: ${val.cluster||"-"}<br>Site: ${val.site||"-"}`;
        G_SELECT2["form-trailers"] += `<option value="${val._id}" data-subtext="${subtext}">${val._id}</option>`;
    });
    /******** END TRAILERS ********/

    
    
    /******** GEOFENCES ********/
    G_SELECT2["form-geofences"] = `<option value="">&nbsp;</option>`;
    const sortedGeofences = ARRAY.OBJECT.sort((LIST["geofences"]||[]),"short_name",{sortType:"asc"});
    sortedGeofences.forEach(val => {
        val.code ? G_SELECT2["form-geofences"] += `<option value="${val._id}">${val.short_name}</option>` : null;
    });
    /******** END GEOFENCES ********/


    /******** ROUTES ********/
    var routes = LIST["routes"] || [];
    try {
        if((clientCustom.defaultOrigin.roles||[]).includes(USER.role)){
            routes = (LIST["routes"]||[]).filter(x => x.origin_id && x.origin_id.toString() == clientCustom.defaultOrigin.id);
        } 
    } catch(error) {}

    G_SELECT2["form-routes"] = `<option value="">&nbsp;</option>`;
    (routes||[]).forEach(val => {
        var origin = getGeofence(val.origin_id) || {};
        var destination = getGeofence(val.destination_id) || {};

        var subtext = `Origin: ${origin.short_name} (${origin.site_name||"-"})<br>Destination: ${destination.short_name} (${destination.site_name||"-"})`;
        G_SELECT2["form-routes"] += `<option value="${val._id}" data-subtext="${subtext}">${val._id}</option>`;
    });
    /******** END ROUTES ********/
};
function getDuration(status,obj){
    obj.events_captured = obj.events_captured || {};
    var events_captured = OBJECT.sortByKey(obj.events_captured);
    var duration = 0;
    var start,end;
    Object.keys(events_captured).forEach(key => {
        if(events_captured[key] == status){
            start = Number(key);
        } else {
            if(start && !end){
                end = Number(key);
                duration += end - start;
                start = null;
                end = null;
            }
        }
    });
    if(start && !end){
        duration = 0;
    }
    return duration;
}
function getDateTime(status,obj,type="first"){
    obj.events_captured = obj.events_captured || {};
    var events_captured = OBJECT.sortByKey(obj.events_captured);
    var datetime = 0;
    Object.keys(events_captured).forEach(key => {
        if(events_captured[key] == status){
            if(type == "first" && !datetime){
                datetime = Number(key);
            }
            if(type == "last"){
                datetime = Number(key);
            }
        }
        if(!status){
            if(type == "first" && !datetime){
                datetime = Number(key);
            }
            if(type == "last"){
                datetime = Number(key);
            }
        }
    });
    return datetime;
}
function getNextDateTime(key, obj){
    key = JSON.stringify(key);
    obj.events_captured = obj.events_captured || {};
    var events_captured = OBJECT.sortByKey(obj.events_captured);

    var keys = Object.keys(events_captured);
    var nextIndex = keys.indexOf(key) +1;

    return Number(keys[nextIndex] || key);
}
function withinSchedule(date,minMaxTime,allowAllGreaterMinTime){
    date = moment(new Date(date)).format("MM/DD/YYYY");

    var _withinSchedule_ = false;
    var shiftArr = (minMaxTime||"").split(" - ");
    var shiftMinTime = shiftArr[0];
    var shiftMaxTime = shiftArr[1];
    var beginningTime = moment(shiftMinTime, 'h:mm A');
    var endTime = moment(shiftMaxTime, 'h:mm A');
    var dateTemp = (!beginningTime.isBefore(endTime)) ? moment(new Date(date)).add(1,"day").format("MM/DD/YYYY") : date;
    var minTime = new Date(`${date}, ${shiftMinTime}`).getTime();
    var maxTime = new Date(`${dateTemp}, ${shiftMaxTime}`).getTime();
    var currentTime = new Date().getTime();

    console.log(date);
    
    // (allowAllGreaterMinTime && now < minSchedule) // allowAllGreaterMinTime is true and NOW is less than minimum schedule -- for cases like user choosing future dates. Eg. Today is 07/28/2021, 8:00 AM. but user wants to schedule for 07/30/2021, 10:00 AM. 
    // (currentTime >= minTime && currentTime <= maxTime) is only valid when today is 07/28/2021, 8:00 AM and schedule picked is 07/28/2021, 6:00 AM - 10:00 AM
    if((currentTime >= minTime && currentTime <= maxTime) || (allowAllGreaterMinTime && currentTime < minTime)){
        _withinSchedule_ = true;
    }
    return _withinSchedule_;
}
function isFinishedLoading(arr,isNew,callback){
    var condition = true;
    arr.forEach(val => {
        if((CLIENT.loadInBackground||[]).includes(val)){
            if(!GGS.STATUS[val]){
                condition = false;
            }
        }
    });
    if(condition == true && isNew) callback();
}

/************** CLASSES **************/
class Dispatch {
    constructor(obj,table_id,viewOnly) {
        LIST["dispatch"] = LIST["dispatch"] || [];
        obj.events_captured = obj.events_captured || {};
        obj.destination = obj.destination || [];
        obj.destination[0] = obj.destination[0] || {};

        function getValue(_list_,_key_,_val_,_autoVal_,_newObjVal_,_arr_){
            _val_ = _val_ || {};
            var str;
            if(_list_){
                if(_autoVal_) str = (LIST[_key_].find(x => x._id == _val_) || {})[_autoVal_];
                else str = LIST[_key_].find(x => x._id == _val_) || {};
                (_newObjVal_) ? obj[_newObjVal_] = str : null;
            } else {
                if(_arr_){
                    str = {};
                    _arr_.forEach(val => {
                        str[val] = `<small class="font-italic text-muted">loading...</small>`;
                    });
                } else 
                    str = `<small class="font-italic text-muted">loading...</small>`;
            }
            return str;
        }

        var disabledArr = [];
        if(["complete"].includes(obj.status)){
            if(authorizationLevel.administrator()){
                disabledArr = ["statusUpdate","edit","edit-admin"];
            } else {
                disabledArr = ["statusUpdate","edit","edit-admin","delete"];
            }
        }
        if(["in_transit","incomplete"].includes(obj.status)){ 
            if(authorizationLevel.administrator()){
                disabledArr = [];
            } else {
                disabledArr = ["statusUpdate","edit","edit-admin"];
            }
        }
        if(["in_transit","complete","incomplete"].includes(obj.status)){ 
            if(authorizationLevel.administrator()){} 
            else {
                disabledArr.push("delete");
            }
        }
        
        var loadView_ReadOnly = (GGS.STATUS.REGIONS && GGS.STATUS.CLUSTERS && GGS.STATUS.GEOFENCES && GGS.STATUS.VEHICLES && GGS.STATUS.ROUTES) ? [] : ["edit","edit-admin","view"],
            entered_origin = getDuration("entered_origin",obj),
            queueingAtOrigin = getDuration("queueingAtOrigin",obj),
            processingAtOrigin = getDuration("processingAtOrigin",obj),
            idlingAtOrigin = getDuration("idlingAtOrigin",obj),
            in_transit = getDuration("in_transit",obj),
            onDelivery = getDuration("onDelivery",obj),
            action = TABLE.ROW_BUTTONS(PAGE.GET(),{loadView:loadView_ReadOnly,readonlyArr:loadView_ReadOnly,adminArr:["edit-admin"],status:obj.status,username:obj.username,disabledArr}),
            user = getUser(obj.username) || {},
            posted_by = ((USER.username == obj.username)?"You":(user.name || obj.username)),
            postedByWithName = user.name || obj.username,
            origin = getValue(LIST["geofences"],"geofences",obj.origin_id,null,"_origin",["short_name"]),
            destination = getValue(LIST["geofences"],"geofences",obj.destination[0].location_id,null,"_destination",["short_name"]),
            region = getValue(LIST["regions"]&&LIST["geofences"],"regions",origin.region_id,"code","_region"),
            cluster = getValue(LIST["clusters"]&&LIST["geofences"],"clusters",origin.cluster_id,"cluster","_cluster"),
            vehicle = getValue(LIST["vehicles"],"vehicles",obj.vehicle_id,null,"_vehicle",["name","Trailer"]),
            route = getValue(LIST["routes"],"routes",obj.route,null,"_route",["transit_time"]),
            trailer = getValue(LIST["trailers"],"trailers",(obj.trailer||vehicle["Trailer"]),null,null,["_id","pal_cap"]),
            chassis = getValue(LIST["chassis"],"chassis",(obj.chassis),null,null,["_id"]),
            driver = getValue(LIST["vehicle_personnel"],"vehicle_personnel",(obj.driver_id),null,null,["name"]),
            checker = getValue(LIST["vehicle_personnel"],"vehicle_personnel",(obj.checker_id),null,null,["name"]),
            helper = getValue(LIST["vehicle_personnel"],"vehicle_personnel",(obj.helper_id),null,null,["name"]),
            index = LIST["dispatch"].findIndex(x => x._id == obj._id),
            beforeCheckOutTime = getDateTime("entered_origin",obj) || getDateTime("queueingAtOrigin",obj) || getDateTime("processingAtOrigin",obj) || getDateTime("idlingAtOrigin",obj) || getDateTime("dispatched",obj),

            cico_time2_calcAtOrigin = (beforeCheckOutTime) ?  (getDateTime("onDelivery",obj,"last") - beforeCheckOutTime) : 0,
            cico_time2_dhAtOrigin = (["onDelivery","complete","incomplete"].includes(obj.status)) ? DATETIME.DH(cico_time2_calcAtOrigin || 0) : "-",
            cico_time2_hhmmAtOrigin = (cico_time2_dhAtOrigin == "-")?"-":DATETIME.HH_MM(null,cico_time2_dhAtOrigin).hour_minute,


            cico_time_calcAtOrigin = (beforeCheckOutTime) ?  (getDateTime("in_transit",obj,"last") - beforeCheckOutTime) : 0,
            cico_time_dhAtOrigin = (["in_transit","complete","incomplete"].includes(obj.status)) ? DATETIME.DH(cico_time_calcAtOrigin || 0) : "-",
            cico_time_hhmmAtOrigin = (cico_time_dhAtOrigin == "-")?"-":DATETIME.HH_MM(null,cico_time_dhAtOrigin).hour_minute,
            cico_time_5AtOrigin =(cico_time_dhAtOrigin == "-")?"-": DATETIME.HH_MM(null,5.0).hour_minute,
            isPL = (origin.short_name) ? (origin.short_name.indexOf(" PL") > -1) : false;

        if(viewOnly){
            action = TABLE.ROW_BUTTONS(PAGE.GET(),{customButtons:["view"],loadView:loadView_ReadOnly,readonlyArr:loadView_ReadOnly,username:obj.username});
        }
        (table_id) ? $(`${table_id} th:last-child`).css({"min-width":action.width,"width":action.width}) : null;

        if(obj._id){
            (obj._row) ? null : obj._row = GENERATE.RANDOM(36);
            (index > -1) ? LIST["dispatch"][index] = obj : LIST["dispatch"].push(obj);
            // var a = [];
            // LIST[x.urlPath].forEach(aa => {
            //     a.push(aa._id);
            // })
            // console.log("1".a.join(", "));
        }

        (posted_by == "_API_") ? posted_by = `${CLIENT.name} Server` : null;

        var attachmentsHTML = "";
        if(obj.attachments){
            obj.attachments.forEach((val,i) => {
                attachmentsHTML += `<div style="font-weight: normal;">${i+1}. <a href="${val.url}" target="_blank">${val.filename||"-"}</a></div>`;
            });
        }
        
        var customersHTML = "";
        const customers = [];
        if(obj.customers){
            obj.customers.forEach((val,i) => {
                customersHTML += `<div style="font-weight: normal;">${i+1}. ${val.number||"-"} - ${val.name||"-"}</div>`;
                customers.push(val.name||"-");
            });
        }

        this._row = obj._row;
        this._id = obj._id;
        this.ticket_number = obj.ticket_number||"-";
        this.departure_date = DATETIME.FORMAT(obj.departure_date);
        this.departure__date = DATETIME.FORMAT(obj.departure_date,"MMM DD, YYYY");
        this.departure__time = DATETIME.FORMAT(obj.departure_date,"hh:mm A");
        this.region = region || "-";
        this.cluster = cluster || "-";
        this.origin = origin.short_name || "-";
        this.originSiteCode = origin.code || "-";
        this.route = obj.route || "-";
        this.destination = `${(destination.short_name || "-")}${GET.LENGTH(destination.length).text}`;
        this.etd = DATETIME.FORMAT(obj.destination[0].etd);
        this.eta = DATETIME.FORMAT(obj.destination[0].eta);
        this.target_transit_time = DATETIME.HH_MM(null,route.transit_time).hour_minute;
        this.target_cico_time = DATETIME.HH_MM(null,origin.cico).hour_minute;

        this.vehicle = vehicle.name || "-";

        const truckGeofence = getGeofence(vehicle["Site"],"short_name") || {};
        this.truck_region = (getRegion(truckGeofence.region_id) || {}).code || "-";
        this.truck_cluster = (getCluster(truckGeofence.cluster_id) || {}).cluster || "-";
        this.truck_site = vehicle["Site"] || "-";
        this.plate_number = vehicle["Plate Number"] || "-";
        this.truck_number = vehicle["Truck Number"] || "-";
        this.chassis = chassis._id || "-";

        this.conduction_number = vehicle["Tractor Conduction"] || "-";
        this.trailer = trailer._id || "-";
        this.pal_cap = trailer.pal_cap || "-";

        this.driver = driver.name || "-";
        this.checker = checker.name || "-";
        this.helper = helper.name || "-";
        this.comments = obj.comments || "-";

        this.support_unit = obj.support_unit || "-";
        this.shipment_type = obj.shipment_type || "-";
        this.delivery_sequence = obj.delivery_sequence || "-";
        this.mdsd_usage = obj.mdsd_usage || "-";
        this.customers = customers.join(", ");
        
        // this.dispatched_datetime = DATETIME.FORMAT(getDateTime("dispatched",obj));
        this.onDelivery_datetime = DATETIME.FORMAT(getDateTime("onDelivery",obj));
        this.entered_datetime = DATETIME.FORMAT(getDateTime(null,obj));
        this.queueing_datetime = DATETIME.FORMAT(getDateTime("queueingAtOrigin",obj));
        this.queueingDuration = DATETIME.HH_MM(queueingAtOrigin).hour_minute;
        this.queueingDurationDh = queueingAtOrigin ? GET.ROUND_OFF(DATETIME.DH(queueingAtOrigin)) + " h" : '-';
        this.processing_datetime = DATETIME.FORMAT(getDateTime("processingAtOrigin",obj));
        var processing_out_datetime = getDateTime("processingAtOrigin",obj,"last");
        this.processing_out_datetime = DATETIME.FORMAT(getNextDateTime(processing_out_datetime, obj));
        this.processingDuration = DATETIME.HH_MM(processingAtOrigin).hour_minute;
        this.processingDurationDh = processingAtOrigin ? GET.ROUND_OFF(DATETIME.DH(processingAtOrigin)) + " h" : '-';
        this.idling_datetime = DATETIME.FORMAT(getDateTime("idlingAtOrigin",obj));
        this.idlingDuration = DATETIME.HH_MM(idlingAtOrigin).hour_minute;
        this.idlingDurationDh = idlingAtOrigin ? GET.ROUND_OFF(DATETIME.DH(idlingAtOrigin)) + " h" : '-';
        this.cico2 = (["onDelivery","complete","incomplete"].includes(obj.status)) ? cico_time2_hhmmAtOrigin : "-";
        this.cico = (["in_transit","onSite","returning","complete","incomplete"].includes(obj.status)) ? cico_time_hhmmAtOrigin : "-";
        this.cicoDh = (["in_transit","onSite","returning","complete","incomplete"].includes(obj.status) && GET.ROUND_OFF(cico_time_dhAtOrigin)) ?  GET.ROUND_OFF(cico_time_dhAtOrigin) + " h" : "-";
        this.cico_capped = (["in_transit","onSite","returning","complete","incomplete"].includes(obj.status)) ? ((cico_time_dhAtOrigin>5 && isPL)?cico_time_5AtOrigin:cico_time_hhmmAtOrigin) : "-";
        this.transit_datetime = (["in_transit","onSite","returning","complete","incomplete"].includes(obj.status)) ? DATETIME.FORMAT(getDateTime("in_transit",obj,"last")) : "-";
        this.deliveryDuration = (["onDelivery","complete","incomplete"].includes(obj.status)) ? DATETIME.HH_MM(onDelivery).hour_minute : "-";
        this.transitDuration = (["in_transit","onSite","returning","complete","incomplete"].includes(obj.status)) ? DATETIME.HH_MM(in_transit).hour_minute : "-";
        this.transitDurationDh = (["in_transit","onSite","returning","complete","incomplete"].includes(obj.status) && in_transit) ? GET.ROUND_OFF(DATETIME.DH(in_transit)) + " h" : "-";
        this.onSite_datetime = (["onSite","returning","complete","incomplete"].includes(obj.status)) ? DATETIME.FORMAT(getDateTime("onSite",obj,"last")) : "-";
        this.returning_datetime = (["returning","complete","incomplete"].includes(obj.status)) ? DATETIME.FORMAT(getDateTime("returning",obj,"last")) : "-";
        this.complete_datetime = (["complete"].includes(obj.status)) ? DATETIME.FORMAT(getDateTime("complete",obj,"last")) : "-";
        this.incomplete_datetime = (["incomplete"].includes(obj.status)) ? DATETIME.FORMAT(getDateTime("incompleteByReturningToOrigin",obj,"last")) : "-";
        this.status = GET.STATUS(obj.status).html;
        this.statusText = GET.STATUS(obj.status).text;
        this.statusCode = obj.status;
        this.scheduled_date = DATETIME.FORMAT(obj.scheduled_date,"MMM DD, YYYY");
        this.shift_schedule = obj.shift_schedule || "-";
        this.posted_by = posted_by;
        this.postedByWithName = postedByWithName;
        this.posting_date = DATETIME.FORMAT(obj.posting_date);
        this.late_entry = obj.late_entry ? "Yes".bold() : "No";
        this.action = action.buttons;

        this.customersHTML = customersHTML;
        this.attachmentsHTML = attachmentsHTML;

        this.ongoingHTML = (obj.status != "complete") ? `<span class="ongoing" style="width: 7px;height: 7px;background: #00a548;border-radius: 20px;top: 14px;margin-left: 4px;position: absolute;"></span>` : "";

        var esc1_remarks = "";
        Object.keys(obj.esc1_remarks||{}).forEach(key => {
            var val = obj.esc1_remarks[key];
            var user = getUser(val.username) || {};
            esc1_remarks += `${val.remarks}<div class="font-11 text-muted mb-1">${user.name || val.username} | ${DATETIME.FORMAT(Number(key))}</div>`;
        });
        var esc2_remarks = "";
        Object.keys(obj.esc2_remarks||{}).forEach(key => {
            var val = obj.esc2_remarks[key];
            var user = getUser(val.username) || {};
            esc2_remarks += `${val.remarks}<div class="font-11 text-muted mb-1">${user.name || val.username} | ${DATETIME.FORMAT(Number(key))}</div>`;
        });
        var esc3_remarks = "";
        Object.keys(obj.esc3_remarks||{}).forEach(key => {
            var val = obj.esc3_remarks[key];
            var user = getUser(val.username) || {};
            esc3_remarks += `${val.remarks}<div class="font-11 text-muted mb-1">${user.name || val.username} | ${DATETIME.FORMAT(Number(key))}</div>`;
        });
        this.esc1_remarks = esc1_remarks || "-";
        this.esc2_remarks = esc2_remarks || "-";
        this.esc3_remarks = esc3_remarks || "-";

        // <td>Traffic as per driver.<div class="font-11 text-muted mb-1">Marielle Pamaran | Mar 18, 2021, 05:00 AM</div></td>

        this.history = obj.history || {};
    }

    row() {
        return {
            '_row':  this._row,
            '_id': this._id,
            'Ticket Number': this.ticket_number,
            'Departure Date': this.departure_date,
            'Departure__Date': this.departure__date,
            'Departure__Time': this.departure__time,
            'Region': this.region,
            'Cluster': this.cluster,
            'Origin': this.origin,
            'Origin Site Code': this.originSiteCode,
            'Customers': this.customers,
            'Route': this.route,
            'Destination': this.destination,
            'ETD': this.etd,
            'ETA': this.eta,
            'Target Transit Time': this.target_transit_time,
            'Target CICO Time': this.target_cico_time,
            'Vehicle': this.vehicle,
            'Plate Number': this.plate_number,
            'Truck Number': this.truck_number,
            'Truck Base': this.truck_site,
            'Truck Base Region': this.truck_region,
            'Truck Base Cluster': this.truck_cluster,
            'Trailer': this.trailer,
            'Chassis': this.chassis,
            'Conduction Number': this.conduction_number,
            'Pal Cap': this.pal_cap,
            'Driver': this.driver,
            'Checker': this.checker,
            'Helper': this.helper,
            'Support Unit': this.support_unit,
            'Shipment Type': this.shipment_type,
            'Delivery Sequence': this.delivery_sequence,
            'MDSD Usage': this.mdsd_usage,
            'Comments': this.comments,
            'Queueing Duration': this.queueingDuration,
            'Processing Duration':this.processingDuration,
            'Idling Duration':this.idlingDuration,
            'CICO Time2': this.cico2,
            'CICO Time': this.cico,
            'CICO Time (Capped)': this.cico_capped,
            'Transit Duration': this.transitDuration,
            'Delivery Duration': this.deliveryDuration,
            'Status': this.status,
            'Scheduled Date': this.scheduled_date,
            'Shift Schedule': this.shift_schedule,
            'Posted By': this.posted_by,
            'Posting Date': this.posting_date,
            'Late Entry': this.late_entry,
            'Action': this.action,
        };
    }

    html(){
        return `<div class="container-parent col-sm-12 p-0 text-dark p-0" _row="${this._row}">
                    <div class="container-header pt-2 pl-4 pr-4 pb-2">
                        <span class="container-header-title">${this._id || "-"}${this.ongoingHTML}</span>
                        <div class="container-header-body">${this.departure_date}, ${this.route}, ${this.vehicle}</div>
                        <i class="la la-angle-up" style="display:none;"></i>
                    </div>
                    <div class="container-body pr-4 pb-2" style="display:none;">
                        <div><span style="display: table-cell;width: 120px;">Departure Date</span><span style="display: table-cell;">${this.departure_date}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Region</span><span style="display: table-cell;">${this.region}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Cluster</span><span style="display: table-cell;">${this.cluster}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Origin</span><span style="display: table-cell;">${this.origin}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Route</span><span style="display: table-cell;">${this.route}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Destination</span><span style="display: table-cell;">${this.destination}</span></div>
                        <div><span style="display: table-cell;width: 120px;">ETD</span><span style="display: table-cell;">${this.etd}</span></div>
                        <div><span style="display: table-cell;width: 120px;">ETA</span><span style="display: table-cell;">${this.eta}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Target Transit Time</span><span style="display: table-cell;">${this.target_transit_time}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Target CICO Time</span><span style="display: table-cell;">${this.target_cico_time}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Vehicle</span><span style="display: table-cell;">${this.vehicle}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Trailer</span><span style="display: table-cell;">${this.trailer}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Chassis</span><span style="display: table-cell;">${this.chassis}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Conduction #</span><span style="display: table-cell;">${this.conduction_number}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Pal Cap</span><span style="display: table-cell;">${this.pal_cap}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Driver</span><span style="display: table-cell;">${this.driver}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Checker</span><span style="display: table-cell;">${this.checker}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Helper</span><span style="display: table-cell;">${this.helper}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Comments</span><span style="display: table-cell;">${this.comments}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Queueing Duration</span><span style="display: table-cell;"><div>${this.queueingDuration}</div></span></div>
                        <div><span style="display: table-cell;width: 120px;">Processing Duration</span><span style="display: table-cell;"><div>${this.processingDuration}</div></span></div>
                        <div><span style="display: table-cell;width: 120px;">Idling Duration</span><span style="display: table-cell;"><div>${this.idlingDuration}</div></span></div>
                        <div><span style="display: table-cell;width: 120px;">CICO Time</span><span style="display: table-cell;"><div>${this.cico}</div></span></div>
                        <div><span style="display: table-cell;width: 120px;">'CICO Time (Capped)</span><span style="display: table-cell;"><div>${this.cico_capped}</div></span></div>
                        <div><span style="display: table-cell;width: 120px;">Transit Duration</span><span style="display: table-cell;"><div>${this.transitDuration}</div></span></div>
                        <div><span style="display: table-cell;width: 120px;">Scheduled Date</span><span style="display: table-cell;">${this.scheduled_date}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Shift Schedule</span><span style="display: table-cell;">${this.shift_schedule}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Posted By</span><span style="display: table-cell;">${this.posted_by}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Posting Date</span><span style="display: table-cell;">${this.posting_date}</span></div>
                        <div><span style="display: table-cell;width: 120px;">Late Entry</span><span style="display: table-cell;">${this.late_entry}</span></div>
                    </div>
                </div>`;
    }

    tbl() {
        var tr = `width: 50%;float: left !important;padding-bottom: 2px;`;
        var tdFirst = `style="width: 200px;font-weight: bold;vertical-align:top;"`;
        return {
            tr,
            tdFirst,
            empty:  `<tr style="${tr}">
                        <td ${tdFirst}>&nbsp;</td>
                        <td>&nbsp;</td>
                    </tr>`,
            getTr: (key,value,color="",attr="",customTr) => {
                return `<tr style="${customTr||tr} ${color}">
                            <td ${tdFirst}>${key}</td>
                            <td ${attr}>${(value?`: ${value}`:"")}</td>
                        </tr>`
            }
                
        };
    }

    de_html(de){
        var runningDurationType = "Transit";
        if(de["Delay Type"].indexOf("Queueing") > -1) runningDurationType = "Queueing";
        if(de["Delay Type"].indexOf("CICO") > -1) runningDurationType = "CICO";

        var trailerChassis = "";
        if(clientCustom.columns.dispatch.list.includes("trailer"))
            trailerChassis += `<div><b style="width:60px;display: inline-block;">Trailer</b>: ${this.trailer}</div>`;
        if(clientCustom.columns.dispatch.list.includes("chassis"))
            trailerChassis += `<div><b style="width:60px;display: inline-block;">Chassis</b>: ${this.chassis}</div>`;

        return `<div id="overlay" attr_row="${de._row}" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                    <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                        <div role="document" class="modal-dialog modal-lg" style="margin:20px auto;">
                            <div class="modal-content">
                                <div class="modal-header pb-2">
                                    <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                    <div class="float-left">
                                        <h4 class="modal-title" id="myModalLabel2">${this._id.bold()} | Escalation ${de["Escalation"]}</h4>
                                        <div>
                                            <div><b style="width:60px;display: inline-block;">Vehicle</b>: ${this.vehicle}</div>
                                            ${trailerChassis}
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-body row pl-3 pr-3 pt-2">
                                    <table style="margin: 0px 30px;">
                                        <tbody>
                                            ${this.tbl().getTr("Delay Type",de["Delay Type"],"color:#ca294b;")}
                                            ${this.tbl().getTr("Site",de["Destination"],"color:#ca294b;")}
                                            ${this.tbl().getTr(`Running ${runningDurationType} Duration`,"...","color:#ca294b;", "_duration")}
                                            ${this.tbl().empty}
                                        </tbody>
                                    </table>
                                    <div class="border-bottom mt-2"></div>
                                    <table style="margin: 0px 30px;">
                                        <tbody>
                                            ${this.tbl().empty} ${this.tbl().empty}
            
                                            ${this.tbl().getTr("Region",this.region)}
                                            ${this.tbl().getTr("Target Transit Time",this.target_transit_time)}
                                            ${this.tbl().getTr("Cluster",this.cluster)}
                                            ${this.tbl().getTr("Target CICO Time",this.target_cico_time)}
                                            ${this.tbl().getTr("Route",this.route)} ${this.tbl().empty} 
                                            
                                            ${this.tbl().empty} ${this.tbl().empty}
            
                                            ${this.tbl().getTr("Origin",this.origin)}
                                            ${this.tbl().getTr("Destination",this.destination)}
            
                                            ${this.tbl().empty} ${this.tbl().empty}

                                            ${(CLIENT.id == "wilcon")?`
                                                ${this.tbl().getTr("Driver",this.driver)}
                                                ${this.tbl().getTr("Checker",this.checker)}
                                                ${this.tbl().getTr("Helper",this.helper)} ${this.tbl().empty}

                                                ${this.tbl().empty} ${this.tbl().empty}
                                            `:""}
            
                                            ${this.tbl().getTr("Check In Date & Time",this.entered_datetime)}
                                            ${this.tbl().getTr("Status","")}
                                            ${this.tbl().getTr("Queueing Duration",this.queueingDuration)}
                                            <tr style="${this.tbl().tr}">
                                                <td colspan=2><div class="font-18" style="display: contents;">${this.status}</div></td>
                                            </tr>
            
                                        ${(de["Delay Type"].indexOf("Queueing") > -1) ? `
                                            ${this.tbl().empty} ${this.tbl().empty}
                                            ${this.tbl().empty} ${this.tbl().getTr("Posted By",this.posted_by)}
                                            ${this.tbl().empty} ${this.tbl().getTr("Posted On",this.posting_date)}
                                        ` : `
                                            ${this.tbl().getTr("Processing Duration",this.processingDuration)} ${this.tbl().empty}
                                            ${this.tbl().getTr("Idling Duration",this.idlingDuration)} ${this.tbl().getTr("Posted By",this.posted_by)}
                                            ${this.tbl().getTr("Check Out Date & Time",this.transit_datetime)} ${this.tbl().getTr("Posted On",this.posting_date)}
                                            ${this.tbl().getTr("CICO Time",this.cico)}
                                        `}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
    }
    
    fullView(){
        return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;z-index:999999 !important;">
                    <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                        <div role="document" class="modal-dialog modal-lg" style="margin:20px auto;width:90%;">
                            <div class="modal-content">
                                <div class="modal-header pb-2">
                                    <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                    <div class="float-left">
                                        <h4 class="modal-title" id="myModalLabel2">
                                            <b>${this._id}</b> 
                                            <div style="display: inline-block;top: -4px;position: relative;margin-left: 2px;font-size: 12px;">${this.status}</div>
                                        </h4>
                                        <div>Full Entry Details</div>
                                    </div>
                                </div>
                                <div class="modal-body row p-0" max-height: 480px;overflow-y: auto;>
                                    <div class="main-details col-sm-9" style="border-right: 1px solid #eee;padding: 15px 0px 10px 30px !important;">
                                        <table>
                                            <tbody>
                                                ${(CLIENT.id == "wilcon")?`
                                                    ${this.tbl().getTr("Ticket Number",this.ticket_number)} ${this.tbl().empty}
                                                `:`
                                                    ${this.tbl().getTr("Shipment Type",this.shipment_type)} ${this.tbl().empty}
                                                `}

                                                ${this.tbl().empty} ${this.tbl().empty}

                                                ${this.tbl().getTr("Region",this.region)}
                                                ${this.tbl().getTr("Origin",this.origin)}
                                                ${this.tbl().getTr("Cluster",this.cluster)}
                                                ${this.tbl().getTr("Destination",this.destination)}
                                                ${this.tbl().getTr("Route",this.route)} ${this.tbl().empty} 

                                                ${this.tbl().empty} ${this.tbl().empty}

                                                ${this.tbl().getTr("Vehicle",this.vehicle)}
                                                ${(CLIENT.id == "wilcon")?`
                                                    ${this.tbl().getTr("Chassis",this.chassis)}
                                                    ${this.tbl().getTr("Driver",this.driver)}
                                                    ${this.tbl().getTr("Checker",this.checker)}
                                                    ${this.tbl().getTr("Helper",this.helper)} ${this.tbl().empty}

                                                    ${this.tbl().empty} ${this.tbl().empty}
                                                `:`
                                                    ${this.tbl().getTr("Trailer",this.trailer)}
                                                    ${this.tbl().getTr("Pal Cap",this.pal_cap)}
                                                    ${this.tbl().getTr("Conduction #",this.conduction_number)}

                                                    ${this.tbl().empty} ${this.tbl().empty}
                                                `}

                                                ${this.tbl().getTr("Check In Date & Time",this.entered_datetime)} ${this.tbl().empty}
                                                ${this.tbl().getTr("Queueing Duration",this.queueingDuration)} ${this.tbl().empty}
                                                ${this.tbl().getTr("Processing Duration",this.processingDuration)} ${this.tbl().empty}
                                                ${this.tbl().getTr("Idling Duration",this.idlingDuration)} ${this.tbl().empty}
                                                ${this.tbl().getTr("Check Out Date & Time",this.transit_datetime)} ${this.tbl().empty}

                                                ${this.tbl().empty} ${this.tbl().empty}

                                                ${this.tbl().getTr("CICO Time",this.cico)}
                                                ${this.tbl().getTr("Target CICO Time",this.target_cico_time)}
                                                ${this.tbl().getTr("Transit Time",this.transitDuration)}
                                                ${this.tbl().getTr("Target Transit Time",this.target_transit_time)}

                                                ${this.tbl().empty} ${this.tbl().empty}
                                                
                                                ${(clientCustom.roundtrip)?`
                                                    ${this.tbl().getTr("On-Site Date & Time",this.onSite_datetime)} ${this.tbl().empty}
                                                    ${this.tbl().getTr("Returned Date & Time",this.returning_datetime)} ${this.tbl().empty}
                                                    ${this.tbl().getTr("Completion Date & Time",this.complete_datetime)} ${this.tbl().empty}
                                                `:` 
                                                    ${this.tbl().getTr("Completion Date & Time",this.complete_datetime)}
                                                `}
                                            </tbody>
                                        </table>
                                        <div class="border-bottom mb-2 mt-2"></div>
                                        <div class="col-sm-12 p-0 mb-3">
                                            <b>Attachments</b>
                                            <div class="col-sm-12">
                                                <div class="col-sm-12 pl-3">${this.attachmentsHTML || "-"}</div>
                                            </div>
                                        </div>
                                        <table>
                                            <tbody>
                                                ${this.tbl().getTr("Late Entry",this.late_entry)}
                                                ${this.tbl().getTr("Comments",this.comments)}

                                                ${this.tbl().empty} ${this.tbl().empty}

                                                ${(CLIENT.id == "wilcon")?`
                                                    ${this.tbl().getTr("Scheduled Date",this.scheduled_date)}
                                                    ${this.tbl().getTr("Shift Schedule",this.shift_schedule)}
                                                `:""}
                                                
                                                ${this.tbl().getTr("Posted By",this.posted_by)}
                                                ${this.tbl().getTr("Posting Date",this.posting_date)}
                                            </tbody>
                                        </table>
                                        <div class="border-bottom mb-2 mt-2"></div>
                                        <table>
                                            <tbody>
                                                ${this.tbl().getTr("Escalation 1 Remarks",this.esc1_remarks,"","","padding-bottom: 2px;")}
                                                ${this.tbl().getTr("Escalation 2 Remarks",this.esc2_remarks,"","","padding-bottom: 2px;")}
                                                ${this.tbl().getTr("Escalation 3 Remarks",this.esc3_remarks,"","","padding-bottom: 2px;")}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="history-details col-sm-3" style="overflow-y: auto;padding-right:30px;">
                                        <h5 class="mb-1">Logs</h5>
                                        ${DISPATCH.FUNCTION.history(this.history)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
    }
    
    fullView_2(){
        return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;z-index:999999 !important;">
                    <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                        <div role="document" class="modal-dialog modal-lg" style="margin:20px auto;width:90%;">
                            <div class="modal-content">
                                <div class="modal-header pb-2">
                                    <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                    <div class="float-left">
                                        <h4 class="modal-title" id="myModalLabel2">
                                            <b>${this._id}</b> 
                                            <div style="display: inline-block;top: -4px;position: relative;margin-left: 2px;font-size: 12px;">${this.status}</div>
                                        </h4>
                                        <div>Full Entry Details</div>
                                    </div>
                                </div>
                                <div class="modal-body row p-0" max-height: 480px;overflow-y: auto;>
                                    <div class="main-details col-sm-9" style="border-right: 1px solid #eee;padding: 15px 0px 10px 30px !important;">
                                        <table style="width:100%;">
                                            <tbody>
                                                ${this.tbl().getTr("Origin",this.origin)}
                                                ${this.tbl().getTr("Origin Site Code",this.originSiteCode)}
                                            </tbody>
                                        </table>
                                        <div class="col-sm-12 p-0 mb-3">
                                            <b>Delivery For (Customer(s))</b>
                                            <div class="col-sm-12">
                                                <div class="col-sm-12 pl-3">${this.customersHTML || "-"}</div>
                                            </div>
                                        </div>
                                        <table style="width:100%;">
                                            <tbody>
                                                ${this.tbl().empty} ${this.tbl().empty}

                                                ${this.tbl().getTr("Truck Plate Number",this.vehicle)}
                                                ${this.tbl().getTr("Truck Base",this.truck_site)}
                                                ${this.tbl().getTr("Support Unit?",this.support_unit)}
                                                ${this.tbl().getTr("Base Region",this.truck_region)}
                                                ${this.tbl().empty} ${this.tbl().getTr("Cluster",this.truck_cluster)}
                                                ${this.tbl().empty} ${this.tbl().getTr("Pallet Capacity",this.pal_cap)}

                                                ${this.tbl().empty} ${this.tbl().empty}

                                                ${this.tbl().getTr("Shipment Type",this.shipment_type)} ${this.tbl().empty}
                                                ${this.tbl().getTr("Delivery Sequence",this.delivery_sequence)} ${this.tbl().empty}
                                                ${this.tbl().getTr("MDSD Usage",this.mdsd_usage)} ${this.tbl().empty}

                                                ${this.tbl().empty} ${this.tbl().empty}

                                                ${this.tbl().getTr("Check In Date & Time",this.entered_datetime)} ${this.tbl().empty}
                                                ${this.tbl().getTr("Check Out Date & Time",this.onDelivery_datetime)} ${this.tbl().empty}
                                                ${this.tbl().getTr("Completion Date & Time",this.complete_datetime)}

                                                ${this.tbl().empty} ${this.tbl().empty}

                                            </tbody>
                                        </table>
                                        <div class="col-sm-12 p-0 mb-3 mt-3">
                                            <b>Attachments</b>
                                            <div class="col-sm-12">
                                                <div class="col-sm-12 pl-3">${this.attachmentsHTML || "-"}</div>
                                            </div>
                                        </div>
                                        <table style="width:100%;">
                                            <tbody>
                                                ${this.tbl().getTr("Comments",this.comments)} ${this.tbl().empty}

                                                ${this.tbl().empty} ${this.tbl().empty}
                                                
                                                ${this.tbl().getTr("Posted By",this.posted_by)}
                                                ${this.tbl().getTr("Posting Date",this.posting_date)}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="history-details col-sm-3" style="overflow-y: auto;padding-right:30px;">
                                        <h5 class="mb-1">Logs</h5>
                                        ${DISPATCH.FUNCTION.history(this.history)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
    }
}
class loadInBackground {
    constructor(urlPath,type){
        this.urlPath = urlPath;
        this.type = type;
        this.failed = 0;
    }

    load(){
        var self = this;

        if(LIST[self.urlPath] && LIST[self.urlPath].length > 0){
            GGS.STATUS[self.type] = true;
            self.g_select_settings();
            TABLE.FINISH_LOADING.START_CHECK();
        } else {
            var skip = 0,
                getData = function(length){
                    if(length == null || length == LIMIT){
                        $.ajax({ 
                            url: `/api/${self.urlPath}/${CLIENT.id}/${USER.username}/all/${JSON.stringify({})}/${skip}/${LIMIT}`, 
                            method: "GET", 
                            timeout: 90000, 
                            headers: {
                                "Authorization": SESSION_TOKEN
                            },
                            async: true
                        }).done(function (docs) {
                            console.log(`${self.urlPath.toUpperCase()}:`,docs);
                            if(!docs.error){
                                length = docs.length;

                                LIST[self.urlPath] = LIST[self.urlPath] || [];
                                docs.forEach(val => {
                                    var index = LIST[self.urlPath].findIndex(x => x._id.toString() == val._id.toString());
                                    if(index > -1){
                                        LIST[self.urlPath][index] = val;
                                    } else {
                                        val._row = GENERATE.RANDOM(36);
                                        LIST[self.urlPath].push(val);
                                    }
                                });
        
                                skip+= length;
                                getData(length);
                            } else {
                                if(self.failed != 5){
                                    setTimeout(function(){
                                        self.failed++;
                                        self.load();
                                    },1000);
                                }
                            }
                        }).fail(function(error){
                            console.log(`Error in GGS - ${self.urlPath}`,error);
                            if(self.failed != 5){
                                setTimeout(function(){
                                    self.failed++;
                                    self.load();
                                },1000);
                            }
                        });
                    } else {
                        TABLE.WATCH({urlPath:self.urlPath});// BEFORE START_CHECK
                        GGS.STATUS[self.type] = true;
                        self.g_select_settings();
                        TABLE.FINISH_LOADING.START_CHECK();
                    }
                };
            getData();
        }
    }
    g_select_settings(){
        const self = this;
        function getSettings(val){
            var obj = {};
            if(self.urlPath == "regions"){
                obj = {
                    id: val._id,
                    value: val.code
                };
            }
            if(self.urlPath == "clusters"){
                obj = {
                    id: val._id,
                    value: val.cluster,
                    region_id: val.region_id
                };
            }
            if(self.urlPath == "geofences"){
                obj = {
                    id: val._id,
                    value: val.short_name,
                    code: val.code
                };
            }
            return obj;
        }
        G_SELECT[self.urlPath] = [];
        (LIST[self.urlPath]||[]).forEach(val => {
            G_SELECT[self.urlPath].push(getSettings(val));
        });
        G_SELECT[self.urlPath] = SORT.ARRAY_OBJECT( G_SELECT[self.urlPath],"value",{sortType:"asc"}); 
    }
}
class Table {
    constructor(x){
        this.id = x.id;
        this.urlPath = x.urlPath;
        this.perColumnSearch = x.perColumnSearch;
        this.url = x.url || `${x.urlPath}/${CLIENT.id}/${USER.username}/all`;
        this.goto = x.goto;
        this.initializeCallback = x.initializeCallback;
        this.modal = x.modal;
        this.filterType = x.filterType || "server";
        
        this.dataTableOptions = {
            language: { search: '', searchPlaceholder: "Search table", sLengthMenu: "_MENU_" },
            responsive: true
        };
        this.dataTableOptions = $.extend(this.dataTableOptions,x.dataTableOptions);

        this._skip = 0;

        this._loadId = null;

        this.autoPopulateData = (x.autoPopulateData == false) ? false : true;
    }

    get skip(){ return this._skip; }
    set skip(val){ this._skip = val; }

    get filter(){ return this._filter || {}; }
    set filter(val){ this._filter = val; }

    get customFilter(){ return this._customFilter || []; }
    set customFilter(val){ this._customFilter = val; }

    get filterDataExtend(){ return this._filterDataExtend || []; }
    set filterDataExtend(val){ this._filterDataExtend = val; }

    get progressBar(){ return this._progressBar; }
    set progressBar(val){ this._progressBar = val; }

    get loadId(){ return this._loadId; }
    set loadId(val){ this._loadId = val; }

    setButtons(x){ 
        const self = this;

        var goto = self.goto,
            pageButtons = PAGE_FUNCTIONALITIES[goto].buttons.table || [],
            dt_buttons = x.dt_buttons || [],
            loadView = x.loadView || [],
            dispatcherCondition = x.dispatcherCondition,
            actions = x.actions || {},
            defaultActionOptions = x.defaultActionOptions || {};
            
        var details = {
            create: {
                tooltipTitle: "Create New Record",
                text: "Create",
                class: "create-btn", 
                icon: "la-plus"
            },
            import: {
                tooltipTitle: "Import Batch File",
                text: "Import",
                class: "import-btn", 
                icon: "la-file-upload"
            },
            refresh: {
                tooltipTitle: "Refresh Table",
                icon: "la-refresh"
            },
            filter: {
                tooltipTitle: "Filter",
                icon: "la-filter"
            },
            export: {
                tooltipTitle: "Export Options",
                icon: "la-file-export"
            },
            report: {
                tooltipTitle: "Generate Report",
                icon: "la-download"
            },
            column: {
                tooltipTitle: "Customize Display Options",
                icon: "la-columns"
            },
            search: {
                tooltipTitle: "Search Table",
                icon: "la-search"
            },
            data_maintenance: {
                tooltipTitle: "Data Maintenance",
                text: "Data Maintenance",
                class: "data_maintenance-btn",
                icon: "la-tasks"
            },
            summary: {
                tooltipTitle: "Switch View Mode",
                icon: "la-eye"
            },
        };
        var defaultActions = {
            refresh: function(){ 
                self.countRows(); 

                if (typeof defaultActionOptions.refresh === 'function') { defaultActionOptions.refresh(); }
            },
            column: function(){
                $(`#export-container`).hide("slide", {direction:'right'},100);
                $(`#filter-container`).hide("slide", {direction:'right'},100);
                $(`#cv-container`).toggle("slide", {direction:'right'},100);

                if (typeof defaultActionOptions.column === 'function') { defaultActionOptions.column(); }
            },
            filter: function(){
                $(`#export-container`).hide("slide", {direction:'right'},100);
                $(`#cv-container`).hide("slide", {direction:'right'},100);
                $(`#filter-container`).toggle("slide", {direction:'right'},100);

                if (typeof defaultActionOptions.filter === 'function') { defaultActionOptions.filter(); }
            },
            export: function(){
                $(`#filter-container`).hide("slide", {direction:'right'},100);
                $(`#cv-container`).hide("slide", {direction:'right'},100);
                $(`#export-container`).toggle("slide", {direction:'right'},100);

                if (typeof defaultActionOptions.export === 'function') { defaultActionOptions.export(); }
            },
            search: function(){
                var ths = "";
                (self.dataTableOptions.columns||[]).forEach(val => { 
                    if(val.visible) {
                        ths += (val.searchable != false) ? '<th><input type="text" class="form-control input-sm" placeholder="Search..."></th>' : '<th></th>';
                    }
                });
                $(`.row-filter`).html(ths).toggle(); 

                $(self.id).find('.row-filter input').on('keyup change', function() {
                    self.dt.column($(this).parent().index() + ':visible').search(this.value).draw();
                });
            },
        };
        function addToDtButtons(val){
            var button = details[val];
            var condClass = (dispatcherCondition == null || dispatcherCondition == true) ? "" : "dispatcherCondition";
            var icon = (loadView.includes(val)) ? "la-spin la-spinner" : button.icon;
            var className = (dt_buttons.length == 0) ? "ml-1" : "";
            className += (loadView.includes(val)) ? " disabled" : "";

            dt_buttons.push({
                text: `<i class="la ${icon}" data-toggle="tooltip" title="${button.tooltipTitle}"></i> ${button.text||""}`,
                className: `${button.class||""} ${className} ${condClass}`,
                action: function ( e, dt, node, config ) {
                    if (typeof actions[val] === 'function') { actions[val](); }
                    else if (typeof defaultActions[val] === 'function') { defaultActions[val](); }
                },
            });
        }
        pageButtons.forEach(val => {
            if(["create","import"].includes(val)){
                if(PERMISSION[goto].create != "none"){
                    addToDtButtons(val);
                }
            } else {
                addToDtButtons(val);
            }
        });
        self.dataTableOptions.buttons = dt_buttons;
    }
    initialize(){
        const self = this;

        self.tableFilter();

        LIST[this.urlPath] = LIST[this.urlPath] || [];

        if ($.fn.DataTable.isDataTable(this.id) ) {
            $(self.id).DataTable().clear().destroy();
        } else {
            if(!self.modal){
                PAGE.DISPLAY();
                $('#filter-container input, #filter-container select, #filter-container button').attr("disabled",true);
            }
        }

        $(`.dt-button .la-refresh`).addClass("la-spin disabled");
        $(`.dt-button .la-refresh`).parents(".dt-button").addClass("disabled");
        $(`.cb-container .la-refresh`).addClass("la-spin disabled");
        
        this.dt = $(this.id).DataTable(this.dataTableOptions);

        $(self.id).on('page.dt length.dt draw.dt', function () {
            PAGE.TOOLTIP();
            TABLE.FINISH_LOADING.START_CHECK();

            $(`${self.id} thead tr th`).each((i,el) => {
                if(!$(el).is(":visible")){
                    $(`${self.id} tr:not(.child)`).each((i1,el1) => {
                        $(el1).find("td").eq(i).hide();
                    });
                }
            });
        });

        $(`.dt-button [data-toggle="tooltip"]`).each((i,el) => {
            var title = $(el).attr("data-original-title") || $(el).attr("title");
            $(el).parents(".dt-button").attr({"data-toggle":"tooltip","data-original-title":title});
            $(el).removeAttr("data-toggle data-original-title");
        });
        PAGE.TOOLTIP();

        if(self.perColumnSearch){
            $(self.id).find('thead').append(`<tr class="row-filter"></tr>`);
           
        }

        $(`.row-filter`).hide();
        TABLE.WATCH({
            urlPath:self.urlPath,
            rowData:self.addRow,
            options:function(){TABLE.FINISH_LOADING.START_CHECK();}
        });
        if (typeof this.filterListener === 'function') { this.filterListener(); }


        // always put end of datatable
        if (typeof this.initializeCallback === 'function') { this.initializeCallback(); }


        /******* COLUMN VISIBILITY *******/
        const customColumn = (self.dataTableOptions.columns||[]);
        if(customColumn){
            $(`.page-box`).append(SLIDER.COLUMN_VISIBILITY(customColumn));
            $('span.toggle-vis').on( 'click', function (e) {
                var index = $(this).attr('data-column'),
                    column = self.dt.column(index);

                column.visible( ! column.visible() );
                
                customColumn[index].visible = column.visible();
                customColumn[index].bVisible = column.visible(); 
                
                $(self.id).attr("style","");

                $(`${self.id} thead tr th`).each((i,el) => {
                    if(!$(el).is(":visible")){
                        $(`${self.id} tr:not(.child)`).each((i1,el1) => {
                            $(el1).find("td").eq(i).hide();
                        });
                    }
                });
                
                var ths = "";
                customColumn.forEach(val => { 
                    if(val.visible) {
                        ths += (val.searchable != false) ? '<th><input type="text" class="form-control input-sm" placeholder="Search..."></th>' : '<th></th>';
                    }
                });
                $(`.row-filter`).html(ths);

                $(self.id).find('.row-filter input').on('keyup change', function() {
                    self.dt.column($(this).parent().index() + ':visible').search(this.value).draw();
                });
            });
        }
        /******* END COLUMN VISIBILITY *******/
        
        /******* EXPORT OPTIONS *******/
        $(`.page-box`).append(SLIDER.EXPORT()); 
        TABLE.TOOLBAR(self.dt);
        $(`.buttons-copy span`).html("Copy Table");
        $(`.buttons-csv span`).html("Export Table As CSV File");
        $(`.buttons-excel span`).html("Export Table As Excel File");
        /******* END EXPORT OPTIONS *******/
    }
    hideProgressBar(){
        $(`#progress-striped-active .progress-bar`).css("width",`0%`).html(`0%`);
        $("div.tbl-progress-bar").hide();
    }
    tableFilter(){
        const self = this;

        USER.filters[self.urlPath] = USER.filters[self.urlPath] || {};

        var filter = {};
        const userDefinedFilter = USER.filters[self.urlPath];

        if(typeof userDefinedFilter == 'string'){
            try { filter = JSON.parse(USER.filters[self.urlPath]) } catch(error) {}
        }
        if(typeof userDefinedFilter == 'object'){
            filter = userDefinedFilter;
        }
        self.filter = (Object.keys(USER.filters[self.urlPath]).length == 0) ? 
                        {} :  //(self.filter||{})
                        filter;

        (self.customFilter||[]).forEach(val => {
            if(val.dataType == "array"){
                if(val.type == "concat"){
                    self.filter[val.field] = self.filter[val.field] || {};

                    (self.filter[val.field]||{}).$in = ((self.filter[val.field]||{}).$in||[]).concat(val.value||[]);
                    console.log("self.filter",self.filter);
                }
            }
            if(val.dataType == "string"){
                self.filter[val.field] = val.value;
            }
        });
    }
    retrieveData(length,loadId){
        const self = this;

        self.tableFilter();

        console.log("loadId",loadId,self.loadId);

        if(!loadId || loadId == self.loadId){
            if(length == null && self.progressBar){
                self.progressBar.reset();
            }
            if(length == null || length == LIMIT){
                var finalFilter = (self.filterType == 'basic') ? {} : self.filter;
                var filterExtend = (self.filter)?`/${JSON.stringify(finalFilter)}`:``;
    
                $.ajax({
                    url: `/api/${self.url}${filterExtend}/${self.skip}/${LIMIT}`,
                    method: "get",
                    timeout: 90000, // 1 minute and 30 seconds
                    headers: {
                        "Authorization": SESSION_TOKEN
                    },
                    async: true
                }).done(function (docs) {
                    console.log(`${self.goto}:`,docs);
                    if(!docs.error){
                        length = docs.length;
    
                        self.display();
    
                        if(docs.error){
                            toastr.error(docs.error.message);
                        } else {
                            self.skip += length;
                            
                            if(!loadId || loadId == self.loadId){
                                if(self.modal || [self.goto].includes(PAGE.GET())){
                                    if (typeof self.populateRows === 'function') { self.populateRows(docs); }
                                    ($(self.id).length > 0) ? self.retrieveData(length,loadId) : null;
                                }
                            }
                        }
                        TABLE.FINISH_LOADING.START_CHECK();
                    }
                });
            } else {
                self.hideProgressBar();
                self.display();

                if (typeof self.customPopulate === 'function') { self.customPopulate(); }
            }
        }
    }
    display(){
        const self = this;

        if (typeof FILTER.CALLBACK === 'function') { FILTER.CALLBACK(true); }
        $(`#filter-btn`).html("Apply").removeClass("disabled");
        $(`#reset-btn`).html("Reset All").removeClass("disabled");
        
        $(`.dt-button .la-refresh`).removeClass("la-spin");
        $(`.dt-button .la-refresh`).parents(".dt-button").removeClass("disabled");
        if(FILTER.STATUS == "reset") $(`.cb-container .la-refresh`).removeClass("la-spin");
        else $(`.cb-container .la-refresh`).removeClass("la-spin disabled");

        $('#search,#searchTerm').attr("disabled",false).html(`<i class="la la-search m-0"></i>`);

        if(self.filterDataExtend !== true) {
            $('#filter-container input, #filter-container select, #filter-container button').attr("disabled",false);
            $(`#filter-container button,#filter-container a`).removeClass("disabled");
        }
    }
    watch(){

    }
    populateRows(data,byPass){
        const self = this;

        self.tableFilter();

        if(self.filterType == 'basic'){
            var filtered = LIST[self.urlPath].filter(x => {
                var condition = true;
                Object.keys(self.filter).forEach(key => {
                    if(self.filter[key] && self.filter[key].$in){
                        (!(self.filter[key].$in||[]).includes(x[key])) ? condition = false : null;
                    } else {
                        (self.filter[key] && x[key] != self.filter[key]) ? condition = false : null;
                    }
                });
                return condition;
            });
    
            data = filtered;
        }
        
        if($(self.id).length > 0 && data.length > 0){
            // donePopulate = true; - dispatch only
            // $(`#search-btn`).css({"pointer-events":"","color":""});  - dispatch only
            
            var rows = [];
            $.each(data, function(i,val){
                var index = LIST[self.urlPath].findIndex(x => x._id.toString() == val._id.toString());
                
                (val._row) ? null : val._row = GENERATE.RANDOM(36);
                (index > -1) ? LIST[self.urlPath][index] = val : LIST[self.urlPath].push(val);

                if(self.autoPopulateData || byPass){
                    rows.push(self.addRow(val));
                }
            });
            if(self.autoPopulateData || byPass){
                self.dt.rows.add(rows).draw(false);
            }

            TABLE.FINISH_LOADING.START_CHECK();

            if(!byPass){
                $("div.tbl-progress-bar").show();
    
                self.progressBar ? self.progressBar.calculate() : null;
            }
        }
        if(data.length == 0){
            $(".dataTables_empty").text("No data available in table");
        }
        
        // initializeOtherSettings();
    }
    updateRows(data){
        const self = this;
        
        if($(self.id).length > 0 && data.length > 0){
            $.each(data, function(i,val){
                var rowNode = self.dt.row(`[_row="${val._row}"]`).node();
                (rowNode) ? self.dt.row(rowNode).data(self.addRow(val)) : null;
            });
        }
    }
    countRows(){
        const self = this;
        self.tableFilter();

        var finalFilter = (self.filterType == 'basic') ? {} : self.filter;

        $.ajax({
            url: `/api/${self.urlPath}/${CLIENT.id}/${USER.username}/all/${JSON.stringify(finalFilter)}/count`,
            method: "get",
            timeout: 90000, // 1 minute and 30 seconds
            headers: {
                "Authorization": SESSION_TOKEN
            },
            async: true
        }).done(function (count) {
            self.progressBar = new ProgressBar(count);
            self.skip = 0;
            (self.filterType == 'basic') ? null : LIST[self.urlPath] = [];
            
            if(self.dt) { //  && !disableClearTable - dispatch only
                self.dt.clear().draw();
                $(".dataTables_empty").text("Loading...");
            }
            
            self.retrieveData(undefined,self.loadId);
        });
    }
    preLoadData(){
        
    }
}
/************** END CLASSES **************/

/************** USER INTERFACE **************/
var PROFILE = {
    FUNCTION:{
        init:function(){
            var doc = null,
                myRegions = [],
                myClusters = [],
                myGeofences = [],
                _new_ = false;
            
            PAGE.DISPLAY();

            if(ISMOBILE){
                $(`#dl-btn,#dl-odb-btn,#edit-btn`).parent().addClass("m-2");
                $(`#dl-btn,#dl-odb-btn,#edit-btn`).css("width","100%");
                $(`#dl-btn,#dl-odb-btn`).css("margin-top","20px");
                $(`#edit-btn,#dl-odb-btn`).removeClass("mt-2").addClass("mt-0");
                $(`.panel.panel-profile`).addClass("mb-0");
                $(`.page-box`).addClass("p-0");
                $(`.main-content`).addClass("p-0");
            }

            $.ajax({ 
                url:  `/api/users/${CLIENT.id}/${USER.username}/${USER.username}/incharge`,
                method: "GET", 
                timeout: 90000, 
                headers: {
                    "Authorization": SESSION_TOKEN
                },
                async: true
            }).done(function (docs) {
                doc = docs[0];
                if(doc){
                    USER.fullName = doc.name;
                    USER.email = doc.email;
                    USER.phoneNumber = doc.phoneNumber;
                    TABLE.FINISH_LOADING.START_CHECK();
                }
            });

            var tries = 0;
            $(`#dl-btn`).click(function(){
                $(`#dl-btn,#dl-odb-btn,#edit-btn`).attr("disabled",true);
                $(`#dl-btn i`).removeClass("la-user").addClass("la-spin la-spinner");
                $.ajax({
                    "url": `https://${CLIENT.ggsURL}/comGpsGate/api/v.1/applications/${CLIENT.appId}/users/${USER.username}?Identifier=Username`,
                    "method": "GET",
                    "headers": {
                        "Authorization": USER.apiKey
                    },
                    timeout: 90000,
                    async: true
                }).done(function (docs) {
                    tries = 0;
                    var body = {}
                        name = `${docs.name} ${docs.surname}`._trim();
                    if(name) body.name = name;
                    if(docs.email) body.email = docs.email;
                    if(docs.phoneNumber) body.phoneNumber = docs.phoneNumber;

                    if(Object.keys(body).length > 0){
                        GET.AJAX({
                            url: `/api/users/${CLIENT.id}/${USER.username}/${USER.username}`,
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8",
                                "Authorization": SESSION_TOKEN
                            },
                            data: JSON.stringify(body)
                        }, function(docs){
                            $(`#dl-btn,#dl-odb-btn,#edit-btn`).attr("disabled",false);
                            $(`#dl-btn i`).addClass("la-user").removeClass("la-spin la-spinner");
                            toastr.success("Profile updated successfully.");
                        });
                    } else {
                        toastr.warning("You profile in WRU Main is empty. No changes has been made.");
                    }
                }).fail(function(error){
                    if(error.status == 0 && tries < MAX_TRIES){
                        tries++;
                        $(`#dl-btn`).click();
                    }
                    TOASTR.ERROR(error);
                });
            });
            $(`#dl-odb-btn`).click(function(){
                $(`#dl-btn,#dl-odb-btn,#edit-btn`).attr("disabled",true);
                $.ajax({
                    url: `/api/users/${CLIENT.id}/${USER.username}/download/${CLIENT.allowDownloadFromOtherDB.toLowerCase()}`,
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8",
                        "Authorization": SESSION_TOKEN
                    },
                    async: true,
                    data: JSON.stringify({}),
                    timeout: 90000, // 1 minute and 30 seconds
                }).done(function (docs) {
                    $(`#dl-btn,#dl-odb-btn,#edit-btn`).attr("disabled",false);
                    $(`#dl-odb-btn i`).addClass("la-user").removeClass("la-spin la-spinner");
                    toastr.success("Profile updated successfully.");
                });
            });
            $(`#edit-btn`).click(function(){
                var subtitle = `This will only update you profile in WRU Dispatch and not in <u data-toggle="tooltip" title="${CLIENT.ggsURL}">WRU Main</u>.`;
                $(`body`).append(modalViews.user.create("Edit Profile",null,USER,subtitle));

                PAGE.TOOLTIP();
                
                $(`#modal #role,#modal #priv-title`).parent().remove();
                $(`#modal .modal-dialog.modal-md`).removeClass("modal-md").addClass("modal-sm").css({"width":""});
                $(`#modal .modal-body > div`).removeClass("col-sm-5").addClass("col-sm-12");

                GET.INTLTELINPUT("#modal #phoneNumber");

                $(`#modal #submit`).click(function(){
                    var body = {}
                        name = ($(`#modal #name`).val()||"")._trim(),
                        email = ($(`#modal #email`).val()|"")._trim(),
                        __phoneNumber = ($("#modal #phoneNumber").val()||"")._trim(),
                        phoneNumber = GET.INTLTELINPUT_VALUE("#modal #phoneNumber");
                    if(name) body.name = name;
                    if(email) body.email = email;
                    if(__phoneNumber) body.phoneNumber = phoneNumber;

                    if(ALERT.REQUIREDFIELDS("#modal-error",$(this).parents("#overlay"))){}
                    else {
                        $(`#modal #submit`).attr("disabled",true).html(`<i class="la la-spin la-spinner"></i> Submit`);
                        $(`#dl-btn,#dl-odb-btn,#edit-btn`).attr("disabled",true);
                        $.ajax({
                            url: `/api/users/${CLIENT.id}/${USER.username}/${USER.username}`,
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8",
                                "Authorization": SESSION_TOKEN
                            },
                            async: true,
                            data: JSON.stringify(body),
                            timeout: 90000, // 1 minute and 30 seconds
                        }).done(function (docs) {
                            toastr.success("Profile updated successfully.");
                            $(`#overlay`).remove();
                            $(`#dl-btn,#dl-odb-btn,#edit-btn`).attr("disabled",false);
                        });
                    }
                });
            });

            
            /******** TABLE CHECK ********/
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                isFinishedLoading(["REGIONS","CLUSTERS","GEOFENCES"], true, function(){
                    var obj = (LIST["geofences"]) ? (getGeofence(USER.dc) || {}) : {};
                    $(`[granted_dc]`).html(obj.short_name || "N/A");
                });
                if(doc && !_new_){
                    console.log(doc);
                    _new_ = true;

                    function getLocationsInCharge(obj){
                        function isInCharge(escalation,type){
                            return (obj[`${escalation}_${type}`]||[]).includes(USER.username);
                        }

                        var lq = [], oc = [], ot = [];

                        isInCharge("esc1","lq") ? lq.push("E-1") : null;
                        isInCharge("esc1","oc") ? oc.push("E-1") : null;
                        isInCharge("esc1","ot") ? ot.push("E-1") : null;
                        isInCharge("esc2","lq") ? lq.push("E-2") : null;
                        isInCharge("esc2","oc") ? oc.push("E-2") : null;
                        isInCharge("esc2","ot") ? ot.push("E-2") : null;
                        isInCharge("esc3","lq") ? lq.push("E-3") : null;
                        isInCharge("esc3","oc") ? oc.push("E-3") : null;
                        isInCharge("esc3","ot") ? ot.push("E-3") : null;

                        
                        var text = [];
                        (lq.length > 0) ? text.push(`Long Queueing - ${lq.join(",")}`) : null;
                        (oc.length > 0) ? text.push(`Over CICO - ${oc.join(",")}`) : null;
                        (ot.length > 0) ? text.push(`Over Transit - ${ot.join(",")}`) : null;

                        return text;
                    }
                    doc.myRegions.forEach((val,i) => {
                        myRegions.push(`${val.code || "-"}<div class="font-italic font-11 text-muted mb-1">${getLocationsInCharge(val).join(" | ")}</div>`);
                    });
                    doc.myClusters.forEach((val,i) => {
                        myClusters.push(`${val.cluster || "-"}<div class="font-italic font-11 text-muted mb-1">${getLocationsInCharge(val).join(" | ")}</div>`);
                    });
                    doc.myGeofences.forEach((val,i) => {
                        myGeofences.push(`${val.short_name || "-"}<div class="font-italic font-11 text-muted mb-1">${getLocationsInCharge(val).join(" | ")}</div>`);
                    });
                    $(`[regions]`).html(myRegions.join("") || "-");
                    $(`[clusters]`).html(myClusters.join("") || "-");
                    $(`[geofences]`).html(myGeofences.join("") || "-");
                }
            }
            TABLE.FINISH_LOADING.START_CHECK();
            /******** END TABLE CHECK ********/
        },
    }
};
var SETTINGS = {
    FUNCTION:{
        stream:null,
        init:function(){
            var table = new Table({
                id: "#tbl-sessions",
                urlPath: "sessions",
                goto: "settings",
                dataTableOptions: {
                    columns: CUSTOM.COLUMN.settings,
                    paging: false,
                    order: [[ 1, "desc" ]],
                    createdRow: function (row, data, dataIndex) {
                        var style = (SESSION_TOKEN == data._id)?`background-color: #ebf8f0`:"",
                            _row = data._row;
                        $(row).attr(`_row`, data._row);
                        $(row).attr('style', style);
                        table.rowListeners(_row,data._id);
                    },
                }
            });
            table.addRow = function(obj){
                var isCurrentSession = (obj._id == SESSION_TOKEN),
                    device_info = obj.device_info || {metadata:{}},
                    logout_btn = (isCurrentSession)?"<small><small>CURRENT SESSION</small></small>":`<td><button class="btn btn-danger pl-2 pr-2 pt-1 pb-1" logout><small>Logout</small></button></td>`,
                    icon = (device_info.device == "mobile") ? "la la-mobile" : "la la-desktop";
    
                return {
                    '_id': obj._id,
                    '_row':  obj._row,
                    'Device Info': `<div>
                                        <i style="font-size: 30px;" class="${icon} mr-2"></i>
                                        <div class="d-inline-block">
                                            <div>${device_info.browser}</div>
                                            <small class="text-muted">${device_info.metadata.ip}</small>
                                        </div>
                                    </div>`,
                    'Last Accessed': DATETIME.FORMAT(obj.timestamp,"MM/DD/YYYY hh:mm A"),
                    'Expiry': DATETIME.FORMAT(obj.expiry,"MM/DD/YYYY hh:mm A"),
                    'Location': `${device_info.metadata.city}, ${device_info.metadata.region}, ${device_info.metadata.country}`,
                    'Action': logout_btn,
                };
            };
            table.rowListeners = function(_row,_id){
                const self = this;
                $(self.id).on('click', `[_row="${_row}"] [logout],[_row="${_row}"] + tr.child [logout]`,function(e){
                    e.stopImmediatePropagation();
                    var obj = LIST[self.urlPath].find(x => x._id.toString() == _id.toString());
                    if(obj){
                        MODAL.CONFIRMATION({
                            confirmCloseCondition: true,
                            confirmCallback: function(){
                                $.ajax({ 
                                    url: `/api/sessions/${CLIENT.id}/${USER.username}/${obj._id}`, 
                                    method: "DELETE", 
                                    timeout: 90000,
                                    headers: {
                                        "Authorization": SESSION_TOKEN
                                    },
                                    async: true
                                }).done(function (docs) {
                                    if(docs.ok == 1){
                                        $(`#confirm-modal`).remove();
                                        $(self.id).DataTable().row(`[_row="${_row}"]`).remove().draw(false);
                                    }
                                });
                            }
                        });
                    }
                });
            };
            table.filterListener = function(_row,_id){
                // push_notification
                var default_push_notification = USER.settings.push_notification || "toast";

                $(`[name="push_notification"][value="${default_push_notification}"]`).prop("checked",true);

                $(`[name="push_notification"]`).change(function(){
                    var push_notification = $(this).val();
                    var element = $(this);

                    console.log("push_notification",push_notification);
                    if(push_notification == "desktop"){
                        try {
                            Notification.requestPermission().then(function(result) {
                                console.log(result);
                                if(result == "granted"){
                                    updateSettings();
                                } else {
                                    alert("Push notification request was denied. Please enable them in your browser if you've changed your mind.");
                                    $(`[name="push_notification"][value="${default_push_notification}"]`).prop("checked",true);
                                }
                            });
                        } catch(error){}
                    } else {
                        updateSettings();
                    }
                    function updateSettings(){
                        $(element).parent().parent().append(`<i class="ml-2 la la-spin la-spinner"></i>`);
                        $(`[name="push_notification"]`).parents(".fancy-radio").css({"pointer-events":"none","color":"#c4c4c4"});

                        GET.AJAX({
                            url: `api/users/${CLIENT.id}/${USER.username}/${USER.username}`,
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8",
                                "Authorization": SESSION_TOKEN
                            },
                            data: JSON.stringify({"settings.push_notification":push_notification})
                        }, function(docs){
                            toastr.success("Push notification settings updated successfully.",null,{timeOut: 1500});
                            console.log("Update Settings push_notification: ",docs);
                            $(`[name="push_notification"]`).parents(".fancy-radio").find(".la-spinner").remove();
                            $(`[name="push_notification"]`).parents(".fancy-radio").css({"pointer-events":"unset","color":"unset"});
                        }, function(error){
                            console.log("error",error);
                        });
                    }
                });

                $(`#toast-test`).click(function(){
                    
                    var sound = document.getElementById("audio01");
                    sound.play();

                    var redDot = `<span style="background-color:red; display:inline-block;border-radius:20px; width:7px;height:7px;margin-right:4px;"></span>`;
                    toastr.error(`${redDot}<b>00000000</b> | Escalation 1<br>Running CICO Duration: 04:35`,"",{
                        positionClass: "toast-bottom-right toastr-white-bg",
                        showDuration: "300",
                        closeButton: true,
                        hideDuration: "1000",
                        timeOut: "20000",
                    });
                });

                $(`#desktop-test`).click(function(){
                    try {
                        Notification.requestPermission().then(function(result) {
                            console.log(result);
                            if(result == "granted"){
                                var sound = document.getElementById("audio01");
                                sound.play();
                                new Notification(`00000000 | Escalation 1`, { body: `Running CICO Duration: 04:35` });
                            } else {
                                alert("Push notification request was denied. Please enable them in your browser if you've changed your mind.");
                            }
                        });
                    } catch(error){}
                });

                // end push_notification
            };
            table.initialize();
            table.countRows();
        }
    }
};
var DASHBOARD = {
    FUNCTION: {
        init:function(){
            USER.filters.dashboard = USER.filters.dashboard || {};
            
            try {
                USER.filters.dashboard = JSON.parse(USER.filters.dashboard);
            } catch(error) {}

            PAGE.DISPLAY();

            if(Object.keys(USER.filters.dashboard).length > 0){
                $(`#reset-btn`).show();
            }
            $(`#reset-btn`).click(function(){
                saveFilter({});
            });

            if(ISMOBILE){
                $(`.panel.panel-profile`).addClass("mb-0");
                $(`.main-content`).addClass("p-0");
                $(`#dashboard-page`).css({"padding":"15px","padding-bottom":"0px","margin-top":"50px"});
                $(`.summary-parent`).parent().addClass("p-1");
                $(`.summary-parent`).parent().next().addClass("p-1");
                $(`.summary-parent`).removeClass("mr-1").addClass("mr-0");
                $(`#_date`).parents(".col-sm-12").addClass("pl-1 pr-1");
                $(`#_date`).parents(".col-sm-12").find("span.float-right").css({width:"49.5%","max-width":"unset"});
                $(`#_regions`).addClass("nav-tabs-mobile");
                $(`#_regions`).parent().removeClass().addClass("col-sm-12 p-0");
                $(`.switch-toggle`).parent().css("width","49.5%");
                $(`.switch-toggle`).css("height","34px");
                $(`.switch-toggle > label`).css("line-height","34px");
                $(`#_site`).parent().removeAttr("style").css({position:"fixed",top:"69px",width:"100%",background:"white","box-shadow":"0 4px 8px -4px #c6c6c6",height:"28px"});
                $(`#_site`).css("width","100%");
            }

            var table_id = "#tbl-dashboard",
                urlPath1 = "dashboard",
                urlPath = "dispatch",
                done = false,
                _new_ = {
                    GEOFENCES: true,
                    REGIONS: true
                },
                newlyLoaded = true,
                filter = USER.filters.dashboard.region || "ALL",
                _siteFilter = USER.filters.dashboard.baseplant || "",
                selectedDate = USER.filters.dashboard.selectedDate || new Date(),
                currentView = USER.filters.dashboard.currentView || "destination",
                calendarview = USER.filters.dashboard.calendarview || "day",
                summary = null,
                columnIndexes = {},
                resetSummaryData = function(){
                    summary = {
                        in_transit: 0,
                        total_shipment: 0,
                        incomplete: 0,
                        scheduled: 0,
                        assigned: 0,
                        queueingAtOrigin: 0,
                        processingAtOrigin: 0,
                        onSite: 0,
                        returning: 0,
                        complete: 0,
                    }; 
                },
                dt = $(table_id).DataTable({
                    columns: TABLE.COL_ROW(CUSTOM.COLUMN.dashboard()).column,
                    order: [[ 1, "asc" ]],
                    dom: 't',
                    pageLength: 1000,
                    scrollX: true,
                    scrollY: "calc(100vh - 340px)",
                    paging: false,
                    createdRow: function (row, data, dataIndex) {
                        var _row = data._row;
                        $(row).attr(`_row`, _row);

                        function miniDTListener(columnTitle,status){
                            var columnIndex = columnIndexes[columnTitle] || -1;
                            if(columnIndex >= 0){
                                $($(row).find("td").eq(columnIndex)).click(function(){ addDataToDT({status, el:this}); });
                            }
                        }
                        
                        miniDTListener("In Transit",["in_transit"]);
                        miniDTListener("Total Shipment",null);
                        miniDTListener("Incomplete",["incomplete"]);
                        miniDTListener("Scheduled",["scheduled"]);
                        miniDTListener("Assigned",["assigned"]);
                        miniDTListener("Queueing",["queueingAtOrigin"]);
                        miniDTListener("Processing",["processingAtOrigin"]);
                        miniDTListener("On-Site",["onSite"]);
                        miniDTListener("Returning",["returning"]);
                        miniDTListener("Complete",["complete"]);

                        // Within CICO Time
                        // $($(row).find("td").eq(8)).click(function(){ addDataToDT({status: null, el:this, w_in_cico:true}); });
                    },
                }),
                random = GENERATE.RANDOM(36),
                populatePage = function(_r_){
                    resetSummaryData();
                    done = false;
                    $(`#icon-date`).removeClass("la-calendar").addClass("la-spin la-spinner");
                    $(`#_regions`).css("pointer-events","none");
                    $(`[name="view-d"]`).attr("disabled",true);
                    $(`.switch-toggle`).css("opacity","0.7");
                    LIST[urlPath1] = {};
                    LIST[urlPath] = [];
                    
                    if(random != _r_){
                        random = _r_;
                    }

                    $(`#dashboard-page .summary-container b`).html(`<i class="la la-spin la-spinner" style="opacity: 0.3;"></i>`);
                    $(`#_date`).attr("disabled",true);
                    if(dt) {
                        dt.clear().draw();
                        $(".dataTables_empty").text("Loading...");
                    }

                    var skip = 0,
                        errorTries = 0,
                        getData = function(length){
                            if(length == null || length == LIMIT){
                                // , status:{$ne:"plan"} - plan is still counted in TOTAL SHIPMENT

                                var finalSelectedDate = DATETIME.FORMAT(new Date(selectedDate),"MM/DD/YYYY");
                                if(calendarview == "month"){
                                    var monthYear = moment(selectedDate).format("MM/DD/YYYY").split("/");
                                    console.log('selectedDate',selectedDate)
                                    var month = monthYear[0];
                                    var year = monthYear[2];

                                    // month in moment is 0 based, so 9 is actually october, subtract 1 to compensate
                                    // array is 'year', 'month', 'day', etc
                                    var startDate = moment([year, month - 1]);
                                
                                    // Clone the value before .endOf()
                                    var endDate = moment(startDate).endOf('month');

                                    finalSelectedDate = `${startDate.format("MM/DD/YYYY")} - ${endDate.format("MM/DD/YYYY")}`;
                                    console.log("finalSelectedDate",finalSelectedDate)
                                }
                                var  dateFilter = FILTER.DATERANGE(finalSelectedDate),
                                    _filter = {posting_date: dateFilter};
                                if(clientCustom.filterType.dashboard == "postingDate-scheduledDate"){
                                    if(moment(selectedDate).format("MM/DD/YYYY") == DEFAULT_DATE){
                                        _filter = {
                                            $or: [
                                                {  
                                                    $and: [
                                                        {
                                                            posting_date: dateFilter
                                                        },
                                                        {
                                                            $or: [
                                                                {
                                                                    scheduled_date: {
                                                                        $exists: false
                                                                    }
                                                                },
                                                                {
                                                                    scheduled_date: dateFilter
                                                                }
                                                            ]
                                                            
                                                        },
                                                        {
                                                            status: {$nin:["plan"]}
                                                        }
                                                    ]
                                                },
                                                {
                                                    $and: [
                                                        {
                                                            scheduled_date: dateFilter
                                                        },
                                                        {
                                                            status: {$nin:["plan"]}
                                                        }
                                                    ]
                                                },
                                                {
                                                    $and: [
                                                        {
                                                            scheduled_date: {
                                                                $gte: dateFilter.$lt,
                                                                $lt: dateFilter.$gte,
                                                            }
                                                        },
                                                        {
                                                            posting_date: {
                                                                $gte: dateFilter.$lt,
                                                                $lt: dateFilter.$gte,
                                                            }
                                                        },
                                                        {
                                                            status: {$nin:["plan","complete","incomplete"]}
                                                        }
                                                    ]
                                                }
                                            ],
                                        };
                                    } else {
                                        _filter = {
                                            $or: [
                                                {  
                                                    $and: [
                                                        {
                                                            posting_date: dateFilter
                                                        },
                                                        {
                                                            $or: [
                                                                {
                                                                    scheduled_date: {
                                                                        $exists: false
                                                                    }
                                                                },
                                                                {
                                                                    scheduled_date: dateFilter
                                                                }
                                                            ]
                                                            
                                                        },
                                                        {
                                                            status: {$nin:["plan"]}
                                                        }
                                                    ]
                                                },
                                                {
                                                    $and: [
                                                        {
                                                            scheduled_date: dateFilter
                                                        },
                                                        {
                                                            status: {$nin:["plan"]}
                                                        }
                                                    ]
                                                },
                                            ],
                                        };
                                    }
                                }
                                GET.AJAX({
                                    url: `api/${urlPath}/${CLIENT.id}/${USER.username}/all/${JSON.stringify(_filter)}/${skip}/${LIMIT}`,
                                    method: "GET",
                                    headers: {
                                        "Authorization": SESSION_TOKEN
                                    },
                                }, function(docs){
                                    console.log("Dashboard",docs);
                                    if(random == _r_){
                                        if(!docs.error){
                                            length = docs.length;

                                            if (typeof DASHBOARD.FUNCTION.addDataToTable === 'function') { docs = DASHBOARD.FUNCTION.addDataToTable(docs); }
                                            
                                            // ADD _ROW
                                            LIST[urlPath] = LIST[urlPath].concat(docs); // always put after loop. Adding other docs inside loop
                                            $(`#_regions`).css("pointer-events","unset");
                                            skip+=length;
                                            getData(length);
                                            
                                            _new_.GEOFENCES = true;
                                            TABLE.FINISH_LOADING.START_CHECK();
                                        } else {
                                            if(errorTries < 5){
                                                errorTries++;
                                                getData(length);
                                            } else {

                                            }
                                        }
                                    }
                                }, function(error){
                                    console.log("error",error);
                                    if(errorTries < 5){
                                        errorTries++;
                                        getData(length);
                                    } else {

                                    }
                                });
                            
                            } else {
                                $(`#dashboard-page [in_transit]`).html(summary.in_transit);
                                $(`#dashboard-page [total_shipment]`).html(summary.total_shipment);
                                $(`#dashboard-page [incomplete]`).html(summary.incomplete);
                                $(`#dashboard-page [scheduled]`).html(summary.scheduled);
                                $(`#dashboard-page [assigned]`).html(summary.assigned);
                                $(`#dashboard-page [queueingAtOrigin]`).html(summary.queueingAtOrigin);
                                $(`#dashboard-page [processingAtOrigin]`).html(summary.processingAtOrigin);
                                $(`#dashboard-page [onSite]`).html(summary.onSite);
                                $(`#dashboard-page [returning]`).html(summary.returning);
                                $(`#dashboard-page [complete]`).html(summary.complete);

                                $(`#_date`).attr("disabled",false);
                                $(`#icon-date`).removeClass("la-spin la-spinner").addClass("la-calendar");
                                $(`[name="view-d"]`).attr("disabled",false);
                                $(`.switch-toggle`).css("opacity","1");
                                // countdown(5);
                                done = true;
                                
                                if(done && !_new_.REGIONS  && !_new_.GEOFENCES){
                                    loadFilter();
                                }
                            }
                        };

                    getData();
                },
                populateWithGeofence = function(){
                    resetSummaryData();

                    if(LIST[urlPath1] && Object.keys(LIST[urlPath1]).length > 0){
                        Object.keys(LIST[urlPath1]||{}).forEach(key => {
                            var oldData =  JSON.stringify(LIST[urlPath1][key]);
    
                            LIST[urlPath1][key].w_in_cico = 0;
                            var location_id = LIST[urlPath1][key].location_id;
                            var geofence = getGeofence(location_id);
                            if(geofence){
                                // console.log(filter,geofence.region_id,(filter == "ALL" || filter.toString() == geofence.region_id.toString()))
                                // do not merge condition. it removes the data from table. (check else statement)
                                if(filter == "ALL" || filter.toString() == geofence.region_id.toString()){
                                    LIST[urlPath1][key].plant = geofence.short_name;
                                    LIST[urlPath1][key].region_id = geofence.region_id;
                                    
                                    // updateTableAndSummary(key, (oldData != JSON.stringify(LIST[urlPath1][key])));
                                }
                                updateTableAndSummary(key, (oldData != JSON.stringify(LIST[urlPath1][key])));
                            } else {
                                console.log("NONE",location_id)
                                LIST[urlPath1][key].plant = "-";
                                updateTableAndSummary(key, (oldData != JSON.stringify(LIST[urlPath1][key])));
                                // dt.row(`[_row="${LIST[urlPath1][key]._row}"]`).remove().draw(false);
                            }
                        });
                    }
                },
                saveFilter = function(setFilter){
                    if(!newlyLoaded){
                        var __filter__ = {};
                        if(new Date(selectedDate).toDateString() != new Date().toDateString()) __filter__.selectedDate = selectedDate;
                        if(filter != "ALL") __filter__.region = filter;
                        if(_siteFilter != "") __filter__.baseplant = _siteFilter;
                        if(currentView != "destination") __filter__.currentView = currentView;
                        if(calendarview != "day") __filter__.calendarview = calendarview;
                        
                        USER.filters.dashboard = setFilter || __filter__;
                        GET.AJAX({
                            url: `/api/users/${CLIENT.id}/${USER.username}/${USER.username}`,
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8",
                                "Authorization": SESSION_TOKEN
                            },
                            data: JSON.stringify({"filter.dashboard":JSON.stringify(USER.filters.dashboard)})
                        }, function(docs){
                            if(setFilter){
                                PAGE.GO_TO();
                            }
                            console.log("docs",docs);
                        });    
                    }
                },
                loadFilter = function(){
                    if(Object.keys(USER.filters.dashboard).length > 0){
                        $(`#reset-btn`).attr("style","text-decoration: underline;");
                    }
                    $(`#_regions #${filter}`).trigger("click");
                    $(`#_site`).val(_siteFilter).trigger("change");
                    newlyLoaded = false;
                },
                setColumnIndexes = function(){
                    dt.columns().every( function () {
                        columnIndexes[this.header().textContent._trim()] = this.index()-1;
                    });
                },
                addDataToDT = function(x){
                    var modal_parent_id = (ISMOBILE) ? "#mini-monitor-container" : "#tbl-mini-monitor",
                        _dt = null,
                        initializeModalDT = function(){
                            _dt =  $(modal_parent_id).DataTable({
                                columns: CUSTOM.COLUMN.dispatch(),
                                dom: 'lBfrtip',
                                language: { search: '', searchPlaceholder: "Search", sLengthMenu: "_MENU_" },
                                buttons: TABLE.BUTTONS({
                                    goto: PAGE.GET(),
                                    actions:{
                                        column: function(){
                                            $(`#cv-container`).toggle("slide", {direction:'right'},100);
                                        }
                                    }
                                }),
                                order: [[ 19, "desc" ]],
                                createdRow: function (row, data, dataIndex) {
                                    var _row = data._row,
                                        _id = data._id;
                                    $(row).attr(`_row`, _row);
                                    
                                    TABLE.ROW_LISTENER({table_id: modal_parent_id,_row,urlPath:urlPath,_id,});
                                },
                            });

                            $(`#overlay`).append(SLIDER.COLUMN_VISIBILITY(CUSTOM.COLUMN.dispatch()));
                            $(`#cv-container`).css({"top":"0px","height":"100%"});
                            $('span.toggle-vis').on( 'click', function (e) {
                                var index = $(this).attr('data-column'),
                                    column = _dt.column(index);

                                column.visible( ! column.visible() );
                                CUSTOM.COLUMN.dispatch()[index].visible = column.visible();
                                CUSTOM.COLUMN.dispatch()[index].bVisible = column.visible();
                                $(modal_parent_id).attr("style","");

                                $(`${modal_parent_id} thead tr th`).each((i,el) => {
                                    if(!$(el).is(":visible")){
                                        $(`${modal_parent_id} tr:not(.child)`).each((i1,el1) => {
                                            $(el1).find("td").eq(i).hide();
                                        });
                                    }
                                });
                            });
                            
                            $(modal_parent_id).on('page.dt length.dt draw.dt', function () {
                                $(`${modal_parent_id} thead tr th`).each((i,el) => {
                                    if(!$(el).is(":visible")){
                                        $(`${modal_parent_id} tr:not(.child)`).each((i1,el1) => {
                                            $(el1).find("td").eq(i).hide();
                                        });
                                    }
                                });
                            });
                        };
                    if(done === true){
                        var _rows = [];
                        var _obj_ = Object.keys(LIST[urlPath1]).filter(key => LIST[urlPath1][key]._row == $(x.el).parent().attr("_row")).map(key => LIST[urlPath1][key])[0] || {};
                        console.log("_obj_",_obj_)
                        var location_id = _obj_.location_id;
                        var geofence = getGeofence(location_id) || {cico:0};
                        var addtnlTitle = (x.w_in_cico) ? `<h5 class="mt-1 mb-0 text-muted font-lighter">In CICO Time</h5>` : "";
                        var statusFunction = function(){
                            var arr = [];
                            x.status.forEach(val => {
                                arr.push(GET.STATUS(val).text.capitalize());
                            });
                            return arr.join(", ");
                        };
                        var titleStatus = (x.title) ? x.title : ((x.status) ? statusFunction() : "All Status");

                        $(`body`).append(MODAL.MINI_MONITOR({title:`<h3 class="mb-0 mt-0 font-lighter">${_obj_.plant}</h3><h5 class="mt-1 mb-0 text-muted font-lighter">${titleStatus.capitalize()}</h5>${addtnlTitle}`}));
                        if(!ISMOBILE){
                            initializeModalDT();
                        }
                        LIST[urlPath].forEach((obj,i) => {
                            obj.destination[0] = obj.destination[0] || {};
                            var otherCondition = (x.w_in_cico) ? ((obj.actual_time_lapse <= geofence.cico) ? true : false) : true,
                                key = (currentView == "destination") ? obj.destination[0].location_id : obj.origin_id;

                            // console.log(x.status,obj._id,obj.status,key==location_id,otherCondition,((!x.status || x.status.includes(obj.status)) && key == location_id && otherCondition))
                            if((!x.status || x.status.includes(obj.status)) && key == location_id && otherCondition){
                                var de = new Dispatch(obj,null,true);

                                if(ISMOBILE){
                                    $(modal_parent_id).append(de.html());

                                    $(`[_row="${obj._row}"] > .container-header`).click(function(){
                                        var el = $(this).parent(),
                                            index = LIST[urlPath].findIndex(x => x._row == $(el).attr("_row")),
                                            obj = LIST[urlPath][index] || {},
                                            removeActive = function(_el){
                                                $(_el).removeClass("active");
                                                $(_el).find(".container-body").slideUp(100,null,function(){
                                                    $(_el).find(".container-header-body").slideDown(50);
                                                });
                                                $(_el).find(".la-angle-up").hide();
                                                $(_el).find(".container-header-title .ongoing").css("opacity",1);
                                                $(_el).find(".container-header-title > [status]").remove();
                                            };
                                        if($(el).hasClass("active")){
                                            removeActive(el);
                                        } else {
                                            $(`.container-parent`).each((i,el1) => { removeActive(el1); });
                                            $(el).addClass("active");
                                            $(el).find(".container-body").slideDown(100,null,function(){
                                                $(el).find(".container-header-body").slideUp(50);
                                                $(el).find(".la-angle-up").slideDown(50);
                                            });
                                            $(el).find(".container-header-title .ongoing").css("opacity",0);
                                            $(el).find(".container-header-title").append(`<span status> - ${obj.status.capitalize()}</span>`);
                                        }
                                    });    
                                } else {
                                    _rows.push(de.row());
                                }
                            }
                        });
                        if(!ISMOBILE){
                            _dt.rows.add(_rows).draw(false);
                        }
                    } else {
                        toastr.info("Please wait while data is loading.");
                    }
                };
            
            setColumnIndexes();
            $(`[name="view-d"][value="${currentView}"]`).prop("checked",true);

            
            TABLE.WATCH({urlPath});

            function updateTableAndSummary(key,condition){
                if((_siteFilter == LIST[urlPath1][key].plant || !_siteFilter) && (filter == LIST[urlPath1][key].region_id || !filter || (filter && filter.toLowerCase() == 'all'))){
                    var scheduledCount = LIST[urlPath1][key].scheduled,
                        queueingCount = LIST[urlPath1][key].queueingAtOrigin,
                        processingCount = LIST[urlPath1][key].processingAtOrigin,
                        onSiteCount = LIST[urlPath1][key].onSite,
                        returningCount = LIST[urlPath1][key].returning,
                        complete = LIST[urlPath1][key].complete,
                        _data = {
                            '_row': LIST[urlPath1][key]._row,
                            'Region':  LIST[urlPath1][key].region_id || "-",
                            'Plant':  LIST[urlPath1][key].plant || `<small class="font-italic text-muted">loading...</small>`,
                            'In Transit': LIST[urlPath1][key].in_transit,
                            'Total Shipment': LIST[urlPath1][key].total_shipment,
                            'Incomplete': LIST[urlPath1][key].incomplete,
                            'Scheduled': scheduledCount,
                            'Assigned': LIST[urlPath1][key].assigned,
                            'Queueing': queueingCount,
                            'Processing': processingCount,
                            'On-Site': onSiteCount,
                            'Returning': returningCount,
                            'Complete': complete,
                        },
                        htmlRow = $(`[_row="${LIST[urlPath1][key]._row}"]`).length,
                        rowNode = dt.row(`[_row="${LIST[urlPath1][key]._row}"]`).node();
                        
                    if (condition == null || condition == true) (rowNode) ? dt.row(rowNode).data(_data).draw(false) : dt.row.add(_data).draw(false);

                    // console.log(condition,LIST[urlPath1][key]);
                    summary.in_transit += LIST[urlPath1][key].in_transit;
                    summary.total_shipment += LIST[urlPath1][key].total_shipment;
                    summary.incomplete += LIST[urlPath1][key].incomplete;
                    summary.scheduled += LIST[urlPath1][key].scheduled;
                    summary.assigned += LIST[urlPath1][key].assigned;
                    summary.queueingAtOrigin += LIST[urlPath1][key].queueingAtOrigin;
                    summary.processingAtOrigin += LIST[urlPath1][key].processingAtOrigin;
                    summary.onSite += LIST[urlPath1][key].onSite;
                    summary.returning += LIST[urlPath1][key].returning;
                    summary.complete += LIST[urlPath1][key].complete;
                }
                
                $(`#dashboard-page [in_transit]`).html(summary.in_transit);
                $(`#dashboard-page [total_shipment]`).html(summary.total_shipment);
                $(`#dashboard-page [incomplete]`).html(summary.incomplete);
                $(`#dashboard-page [scheduled]`).html(summary.scheduled);
                $(`#dashboard-page [assigned]`).html(summary.assigned);
                $(`#dashboard-page [queueingAtOrigin]`).html(summary.queueingAtOrigin);
                $(`#dashboard-page [processingAtOrigin]`).html(summary.processingAtOrigin);
                $(`#dashboard-page [onSite]`).html(summary.onSite);
                $(`#dashboard-page [returning]`).html(summary.returning);
                $(`#dashboard-page [complete]`).html(summary.complete);
            }
            
            DASHBOARD.FUNCTION.addDataToTable = function(data,fetched,deletedObj){
                if(data){
                    if(data.length > 0){
                        data.forEach((val,i) => {
                            if(new Date(val.posting_date).setHours(0,0,0,0) == new Date(selectedDate).setHours(0,0,0,0) || 
                                new Date(val.scheduled_date).setHours(0,0,0,0) == new Date(selectedDate).setHours(0,0,0,0) || 
                                ["scheduled","assigned","queueingAtOrigin","processingAtOrigin","idlingAtOrigin","in_transit","onSite","returning"].includes(val.status)) {
                                var destination = val.destination[0] || {},
                                    key = (currentView == "destination") ? destination.location_id : val.origin_id,
                                    oldData = (LIST[urlPath1][key]) ? LIST[urlPath1][key].data[val._id] : null;
                                if(key){
                                    (data[i]._row) ? null : data[i]._row = GENERATE.RANDOM(36);
            
                                    if(LIST[urlPath1][key]){
                                        if(oldData){
                                            LIST[urlPath1][key][oldData.status] --;
                                        } else {
                                            (val.status != "plan") ? LIST[urlPath1][key].total_shipment ++ : null;
                                        }
                                    } else {
                                        LIST[urlPath1][key] = {
                                            _row: GENERATE.RANDOM(36),
                                            // _id: val._id,
                                            // plant: val.destination[0].location_id,
                                            location_id: key,
                                            destination_id: destination.location_id,
                                            in_transit: 0,
                                            total_shipment: 0,
                                            incomplete: 0,
                                            scheduled: 0,
                                            assigned: 0,
                                            queueingAtOrigin: 0,
                                            processingAtOrigin: 0,
                                            onSite: 0,
                                            returning: 0,
                                            complete: 0,
                                            data: {}
                                        };
                                        (val.status != "plan") ? LIST[urlPath1][key].total_shipment ++ : null;
                                    }
                                    LIST[urlPath1][key].data[val._id] = {status:val.status};
                                    if(LIST[urlPath1][key][val.status] != null){
                                        LIST[urlPath1][key][val.status] ++;
                                    }
                                }
                            }
                        });
    
                        resetSummaryData();
                        
                        Object.keys(LIST[urlPath1]).forEach(key => { updateTableAndSummary(key); });
                    } 
                } else {
                    var destination = deletedObj.destination[0] || {},
                        key = (currentView == "destination") ? destination.location_id : deletedObj.origin_id,
                        oldData = (LIST[urlPath1][key]) ? LIST[urlPath1][key].data[deletedObj._id] : null;
                    if(oldData){
                        LIST[urlPath1][key][oldData.status] --;
                        delete LIST[urlPath1][key].data[deletedObj._id];
                    }
                    LIST[urlPath1][key].total_shipment --;
                    resetSummaryData();

                    if(LIST[urlPath1][key].total_shipment === 0){
                        $(`#dashboard-page [in_transit]`).html(summary.in_transit);
                        $(`#dashboard-page [total_shipment]`).html(summary.total_shipment);
                        $(`#dashboard-page [incomplete]`).html(summary.incomplete);
                        $(`#dashboard-page [scheduled]`).html(summary.scheduled);
                        $(`#dashboard-page [assigned]`).html(summary.assigned);
                        $(`#dashboard-page [queueingAtOrigin]`).html(summary.queueingAtOrigin);
                        $(`#dashboard-page [processingAtOrigin]`).html(summary.processingAtOrigin);
                        $(`#dashboard-page [onSite]`).html(summary.onSite);
                        $(`#dashboard-page [returning]`).html(summary.returning);
                        $(`#dashboard-page [complete]`).html(summary.complete);
                        dt.row(`[_row="${LIST[urlPath1][key]._row}"]`).remove().draw(false);

                        delete LIST[urlPath1][key];
                    }
                        
                    Object.keys(LIST[urlPath1]).forEach(key => { updateTableAndSummary(key); });
                }

                if(fetched === false){
                    _new_.GEOFENCES = true;
                    TABLE.FINISH_LOADING.START_CHECK();
                }
                return data;
            };
                
            PAGE.TOOLTIP(); // add after dt is initialized

            function initializeExportButton(){
                $('#export-container').html('');
                TABLE.TOOLBAR(dt, function(){
                    var _date = calendarview == "day" ? moment(selectedDate).format("MM.DD.YYYY") : moment(selectedDate).format("MM.YYYY");
                    var _region = filter && filter.toLowerCase() != 'all' ? (getRegion(filter)||{}).code || '-' : 'All';
                    return `Deployment Dashboard - ${currentView.capitalize()} View - Region ${_region} - Filter ${calendarview.capitalize()} - ${_date}`
                }, function (xlsx) {
                    var sheet = xlsx.xl.worksheets['sheet1.xml'];
                    var clRow = $('row', sheet);

                    var alphabet = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];
                    var total = [{ k: alphabet[0], v: 'Total' }];
                    
                    console.log(Object.keys(clRow).length);
                    //update Row
                    clRow.each(function () {
                        $(this).find('v').each((i,el) => {
                            var content = $(el).get(0).innerHTML;
                            total[i+1] = total[i+1] || { k: alphabet[i+1], v: 0 };
                            total[i+1].v += Number(content);
                        });
                    });
                    console.log("total",total);
             
                    function Addrow(index,data) {
                        msg='<row r="'+index+'">'
                        for(i=0;i<data.length;i++){
                            var key=data[i].k;
                            
                            var value=data[i].v;
                            if(i == 0){
                                msg += '<c t="inlineStr" r="' + key + index + '" >';
                                msg += '<is>';
                                msg +=  '<t xml:space="preserve">'+value+'</t>';
                                msg+=  '</is>';
                                msg+='</c>';
                            } else {
                                msg += '<c r="' + key + index + '" s="65" >';
                                msg +=    '<v>'+value+'</v>';
                                msg+='</c>';
                            }
                        }
                        msg += '</row>';
                        return msg;
                    }

                    //insert
                    var r1 = Addrow(Object.keys(clRow).length-1, total);
                    
                    sheet.childNodes[0].childNodes[1].innerHTML =  sheet.childNodes[0].childNodes[1].innerHTML + r1;
                });
                $(`.buttons-copy`).remove();
                $(`.buttons-csv`).remove();
                $(`.buttons-excel span`).html('<i class="la la-file-download"></i>');
            }
            // populatePage(random);

            /******** EVENT LISTENER ********/
            $('#_date').replaceWith(`<input id="_date" class="form-control" type="text" readonly>`);
            $(`#_date`).daterangepicker({
                opens: 'left',
                singleDatePicker:true,
                autoUpdateInput: false,
                maxDate: new Date(),
                startDate: DATETIME.FORMAT(new Date(selectedDate),"MM/DD/YYYY"),
                autoApply: true
            }, function(start, end, label) {
                $($(this)["0"].element).val(DATETIME.FORMAT(new Date(start),"MM/DD/YYYY"));
                selectedDate = new Date(start);
                saveFilter();
                populatePage(GENERATE.RANDOM(36));
            }).on('apply.daterangepicker', function (ev, picker) {
                $(this).val(DATETIME.FORMAT(new Date(picker.startDate),"MM/DD/YYYY"));
                selectedDate = new Date(picker.startDate);
                saveFilter();
                populatePage(GENERATE.RANDOM(36));

            });
            $(`#_date`).trigger('apply.daterangepicker',{ startDate: DATETIME.FORMAT(new Date(selectedDate),"MM/DD/YYYY") });


            $(`[calendarview]`).click(function(){
                calendarview = $(this).attr("calendarview");

                initializeExportButton();

                if(calendarview == "day"){
                    $('#_date').replaceWith(`<input id="_date" class="form-control" type="text" readonly>`);
                    $(`#_date`).daterangepicker({
                        opens: 'left',
                        singleDatePicker:true,
                        autoUpdateInput: false,
                        maxDate: new Date(),
                        startDate: DATETIME.FORMAT(new Date(selectedDate),"MM/DD/YYYY"),
                        autoApply: true
                    }, function(start, end, label) {
                        $($(this)["0"].element).val(DATETIME.FORMAT(new Date(start),"MM/DD/YYYY"));
                        selectedDate = new Date(start);
                        saveFilter();
                        populatePage(GENERATE.RANDOM(36));
                    }).on('apply.daterangepicker', function (ev, picker) {
                        $(this).val(DATETIME.FORMAT(new Date(picker.startDate),"MM/DD/YYYY"));
                        selectedDate = new Date(picker.startDate);
                        saveFilter();
                        populatePage(GENERATE.RANDOM(36));

                    });
                    $(`#_date`).trigger('apply.daterangepicker',{ startDate: DATETIME.FORMAT(new Date(selectedDate),"MM/DD/YYYY") });
                }
                if(calendarview == "month"){
                    $('#_date').replaceWith(`<input id="_date" class="form-control" type="text" readonly>`);
                    $('#_date').datepicker('remove').datepicker({
                        format: "mm/yyyy",
                        minViewMode: 1,
                        autoclose: true,
                        todayHighlight: true,
                        endDate: new Date()
                    }).on("changeDate",function (e) {
                        selectedDate = new Date(e.date);
                        saveFilter();
                        populatePage(GENERATE.RANDOM(36));
                    }).datepicker("setDate",new Date(selectedDate));
                }
                $(`[calendarview]`).removeClass("active");
                $(`[calendarview="${calendarview}"]`).addClass("active");
                $(this).parents(".dropdown").find(".dropdown-toggle b").html(calendarview.toUpperCase());

                saveFilter();
            });
            $(`[calendarview="${calendarview}"]`).trigger("click");
            
            $(`[name="view-d"]`).change(function(){
                currentView = $(`[name="view-d"]:checked`).val();

                initializeExportButton();

                saveFilter();
                populatePage(GENERATE.RANDOM(36));
            });
            /******** END EVENT LISTENER ********/

            /******** TABLE CHECK ********/
            var loadFilterGeofence = false;
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                isFinishedLoading(["GEOFENCES"], _new_.GEOFENCES, function(){
                    _new_.GEOFENCES = false;
                    populateWithGeofence();
                    if(done && !_new_.REGIONS && !_new_.GEOFENCES && !loadFilterGeofence){
                        loadFilterGeofence = true;
                        loadFilter();
                    }
                });
                isFinishedLoading(["REGIONS"], _new_.REGIONS, function(){
                    _new_.REGIONS = false;
                    var _regionData = SORT.ARRAY_OBJECT(LIST["regions"],"sequence",{sortType:"asc"});
                    $(`#_regions`).append(`<li class="active"><a id="ALL" class="summary-tab" href="javascript:void(0)" role="tab" data-toggle="tab">ALL</a></li>`);
                    _regionData.forEach(val => {
                        $(`#_regions`).append(`<li><a id="${val._id}" class="summary-tab" href="javascript:void(0)" role="tab" data-toggle="tab">${val.code}</a></li>`);
                    });
                    $(`.summary-tab`).css({"border-radius":"2px","margin-bottom":"3px"});
                    $(`#_regions [role="tab"]`).click(function(){
                        filter = $(this).attr("id");
                        
                        var _filter = (filter == "ALL") ? "" : filter,
                            TBL = $(table_id).DataTable();
                        console.log(filter,_filter,_siteFilter);
                        // $(table_id).DataTable().search(`${_filter} ${_siteFilter}`).draw();
                        TBL.column(0).search(_filter).draw();
                        TBL.column(1).search(_siteFilter,true,false).draw();

                        initializeExportButton();

                        saveFilter();
                        populateWithGeofence();

                    });
                    $(`#_site`).show().select2({placeholder: "Choose Site (Base Plant)",allowClear: true}).val("").change(function(){
                        _siteFilter = $(this).val() || "";
                        
                        var _filter = (filter == "ALL") ? "" : filter,
                            TBL = $(table_id).DataTable();
                        // console.log(filter,_filter,_siteFilter);
                        // TBL.search(`${_filter} ${_siteFilter}`).draw();
                            
                        TBL.column(0).search(_filter).draw();
                        TBL.column(1).search(_siteFilter,true,false).draw();

                        initializeExportButton();

                        saveFilter();

                        resetSummaryData();
                        Object.keys(LIST[urlPath1]).forEach(key => { updateTableAndSummary(key); });
                    });
                    if(done && !_new_.REGIONS  && !_new_.GEOFENCES){
                        loadFilter();
                    }
                });
            }
            /******** END TABLE CHECK ********/


            /******** GET TAGS ********/
            var getTag = function(tries){
                    GET.AJAX({
                        "url": `https://${CLIENT.ggsURL}/comGpsGate/api/v.1/applications/${CLIENT.appId}/tags?FromIndex=0&PageSize=1000`,
                        "method": "GET",
                        "headers": {
                            "Authorization": USER.apiKey
                        },
                    }, function(response){
                        console.log("Tags:",response);
                        var _siteOptions = `<option value="">Choose Site (Base Plant)</option>`;
                        response.forEach(val => {
                            if(val.name.indexOf("A_Base Plant:") > -1){
                                
                                var tempName = val.name.split(": "),
                                    plant = tempName[1];
                                if(plant == "STA ROSA PL") plant = "STAROSA PL";
                                _siteOptions += `<option value="${plant}">${plant}</option>`;
                            }
                        });
                        $(`#_site`).html(_siteOptions);
                    }, function(error){
                        console.log(error);
                        if(error.status == 0 && tries < MAX_TRIES){
                            tries++;
                            getTag(tries);
                        }
                        TOASTR.ERROR(error);
                    });
                };
            getTag(0);
            /******** END GET TAGS ********/
        }
    }
};
var DE_DASHBOARD = {
    FUNCTION: {
        init:function(){
            PAGE.DISPLAY();
            DE_DASHBOARD.FUNCTION.setBadge();
            $(`#_regions`).parent().addClass("mb-1");
            $(`#_regions`).css("border","none");

            var table_id = "#tbl-ot,#tbl-lq,#tbl-oc",
                urlPath = "notifications",
                _new1_ = true,
                _new2_ = true,
                filter = "ALL",
                basePlants = [],
                _siteFilter = [],
                _baseplantFilter = "",
                selectedDate = new Date(),
                dt_options = function(title){
                    return {
                        columns: TABLE.COL_ROW(CUSTOM.COLUMN.de_dashboard).column,
                        order: [[ 0, "asc" ]],
                        dom: 't',
                        // scrollX: "100%",
                        scrollY: "350px",
                        paging: false,
                        createdRow: function (row, data, dataIndex) {
                            $(row).attr(`_row`, data._row);
                            $($(row).find("td").eq(0)).hover(function(e) {
                                $(this).css({"text-decoration":e.type === "mouseenter"?"underline":"none",
                                                "cursor":e.type === "mouseenter"?"pointer":"default"});
                            });
                            $($(row).find("td").eq(0)).click(function(){ 
                                moreInfoModal(data);
                            });
                        }
                    };
                },
                populatePage = function(){
                    done = false;
                    $(`#filter-container`).css("pointer-events","none");
                    $(`.switch-toggle`).css("opacity","0.7");

                    $(`#dashboard-page .summary-container b`).html(`<i class="la la-spin la-spinner" style="opacity: 0.3;"></i>`);

                    $(".dataTables_empty").text("Loading...");
                    GET.AJAX({
                        url: `api/${urlPath}/${CLIENT.id}/${USER.username}/all/de/${JSON.stringify({timestamp: FILTER.DATERANGE()})}/0/0`,
                        method: "GET",
                        headers: {
                            "Authorization": SESSION_TOKEN
                        },
                    }, function(docs){
                        $(`#filter-container`).css("pointer-events","unset");
                        console.log(`DE Dashboard`,docs);

                        function perDelayType(table_id,delay_type,_dt_){
                            var rows = [],
                                _dt = $(table_id).DataTable(),
                                filtered = docs.filter(x => x.delay_type == delay_type);
                            $.each(filtered, function(i,val){
                                var same = LIST[urlPath].find(x=> x.dispatch_id == val.dispatch_id && x.delay_type == val.delay_type);
                                var statusArr = [];
                                if(_dt_ == "lq") statusArr = ["queueingAtOrigin"];
                                if(_dt_ == "oc") statusArr = ["processingAtOrigin","idlingAtOrigin"];
                                if(_dt_ == "ot") statusArr = ["in_transit"];

                                if(!same && statusArr.includes(val.dispatch_status)){
                                    rows.push(DE_DASHBOARD.FUNCTION.createRow(val));
                                }
                            });
                            _dt.rows.add(rows).draw(false);
                            DE_DASHBOARD.FUNCTION.setSummary(_dt_);
                        }
                            
                        perDelayType("#tbl-lq","Long Queueing","lq");
                        perDelayType("#tbl-oc","Over CICO","oc");
                        perDelayType("#tbl-ot","Over Transit","ot");

                    }, function(error){
                        console.log("error",error);
                    });
                },
                moreInfoModal = function(x={}){
                    GET.AJAX({
                        url: `/api/dispatch/${CLIENT.id}/${USER.username}/${x.SN}`,
                        method: "GET",
                        headers: {
                            "Authorization": SESSION_TOKEN
                        },
                    }, function(docs){
                        console.log("docs",docs);
                        var obj = docs[0];
                        if(obj){
                            // obj.id = obj._id;
                            $("html, body,#modal").animate({ scrollTop: 0 }, "fast");

                            var de = new Dispatch(obj);
                            $(`body`).append(de.de_html(x));

                        } else {

                        }
                        
                    });
                };
            // moreInfoModal({SN:"21715099","Delay Type":"Long Queueing","Duration":"00:01","Destination":"AAA","Escalation":"1"})
            $(`#tbl-lq,#tbl-oc`).DataTable(dt_options("Location"));
            $(`#tbl-ot`).DataTable(dt_options("Destination"));

            
            $(".dataTables_empty").text("Loading...");

            DE_CHECKDUPS = setInterval(function(){
                // duration
                // console.log("LIST[urlPath]",LIST[urlPath]);
                if(LIST[urlPath]){
                    LIST[urlPath].forEach(val => {
                        // console.log(val);
                        var diff = new Date().getTime() - new Date(val.timestamp).getTime();
                        var dh = DATETIME.DH(diff);
                        var sum = dh + Number(val.timelapse);
                        var hhmm = DATETIME.HH_MM(null,sum);
                        
                        $($(`[_row="${val._row}"] > td`)[2]).html(hhmm.hour_minute);
                        $(`#overlay[attr_row="${val._row}"] [_duration]`).html(`: ${hhmm.hour_minute}`);

                        var _table_id_ = "";
                        if(val.delay_type == "Long Queueing") _table_id_ = "#tbl-lq";
                        if(val.delay_type == "Over CICO") _table_id_ = "#tbl-oc";
                        if(val.delay_type == "Over Transit") _table_id_ = "#tbl-ot";

                        if(BASE_PLANTS){
                            var dt = $(_table_id_).DataTable();
                            var currentValue = $($(`[_row="${val._row}"] > td`)[4]).text();
                            var base = BASE_PLANTS.find(x => x.usersIds.includes(val.dispatch_vehicle_id));
                            if(base){
                                if(currentValue != base.plant){
                                    var rowNode = dt.row(`[_row="${val._row}"]`).node();
                                    var rowIndex = dt.row(rowNode).index();
                                    dt.cell({row: rowIndex, column:7}).data(base.plant).draw(false);
                                }
                            } else {
                                $($(`[_row="${val._row}"] > td`)[4]).text("-");
                            }
                        }
                        //attr_row
                    });
                }
                // end duration

                var types = ["lq","oc","ot"];

                types.forEach(val => {
                    var arr = [],
                        rowIndexes = [],
                        statusArr = [];
                    $(`#tbl-${val}`).DataTable().column(2).data().sort().each(v => { arr.push(v); }); // get all data (column 2)
                    
                    if(val == "lq") statusArr = ["queueingAtOrigin"];
                    if(val == "oc") statusArr = ["processingAtOrigin","idlingAtOrigin"];
                    if(val == "ot") statusArr = ["in_transit"];

                    var tempArr = [];
                    // Fix Delay Escalation Dashboard showing Queueing (Destination) etc
                    arr.forEach(sn => { // must be BEFORE the filter
                        var de = LIST["dispatch"].find(x => x._id == sn);
                        if(de && !statusArr.includes(de.status)){
                            tempArr.push(sn);
                            tempArr.push(sn); // push twice
                        }
                    });
                    arr = arr.filter((e, i, a) => a.indexOf(e) !== i); // filter duplicate data

                    arr = arr.concat(tempArr);

                    $(`#tbl-${val}`).DataTable().rows( function ( idx, data, node ) {             
                        if(arr.includes(data.SN)){
                            rowIndexes.push(idx);
                            arr = jQuery.grep(arr, function(value) { return value != data.SN; });  // remove the duplicate from array           
                        }
                        return false;
                    });   

                    rowIndexes.forEach(idx => {
                        // remove duplicate row/s
                        $(`#tbl-${val}`).DataTable().row(idx).remove().draw(false);
                    });
                });
            },1000);
            
            $(`.dataTables_scrollBody`).css("overflow-x","hidden");
            $(`.summary-container`).css({"margin-right":"unset","border":"unset"});
            TABLE.WATCH({urlPath:"dispatch"});

            /******** EVENT LISTENER ********/
            /******** END EVENT LISTENER ********/

            /******** TABLE CHECK ********/
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                isFinishedLoading(["GEOFENCES","VEHICLES"], _new1_, function(){
                    _new1_ = false;

                    var _siteOptions = ``;
                    LIST["geofences"].forEach(val => {
                        _siteOptions += `<option value="${val.short_name}">${val.short_name}</option>`;
                    });
                    $(`#_site`).html(_siteOptions);
                    
                    LIST[urlPath] = [];
                    populatePage();
                });
                isFinishedLoading(["REGIONS"], _new2_, function(){
                    _new2_ = false;

                    var _regionData = SORT.ARRAY_OBJECT(LIST["regions"],"sequence",{sortType:"asc"});
                    $(`#_regions`).append(`<li class="active"><a id="ALL" class="summary-tab" href="javascript:void(0)" role="tab" data-toggle="tab">ALL</a></li>`);
                    _regionData.forEach(val => {
                        $(`#_regions`).append(`<li><a id="${val._id}" class="summary-tab" href="javascript:void(0)" role="tab" data-toggle="tab">${val.code}</a></li>`);
                    });
                    $(`.summary-tab`).css({"border-radius":"2px","margin-bottom":"3px"});
                    $(`#_regions [role="tab"]`).click(function(){
                        filter = $(this).attr("id");

                        _siteFilter = (_siteFilter || []).filter(x => x);

                        var _filter = (filter == "ALL") ? "" : filter;
                        $(table_id).DataTable().columns(0).search(_filter); // REGION
                        $(table_id).DataTable().columns(4).search(_siteFilter.join("|"),true,false); // SITE
                        $(table_id).DataTable().columns(7).search(_baseplantFilter); // BASE PLANT
                        $(table_id).DataTable().draw();

                        DE_DASHBOARD.FUNCTION.setSummary(null,{region_id:_filter,site:_siteFilter,base:_baseplantFilter});
                    });
                    
                    $(`#_site`).show().select2({placeholder: "Choose Site",allowClear: true}).change(function(){
                        $(`#_site`).parent().find(".select2").css({width:"unset","min-width":"160px"});
                        _siteFilter = $(this).val();

                        _siteFilter = (_siteFilter || []).filter(x => x);

                        var _filter = (filter == "ALL") ? "" : filter;
                        $(table_id).DataTable().columns(0).search(_filter); // REGION
                        $(table_id).DataTable().columns(4).search(_siteFilter.join("|"),true,false); // SITE
                        $(table_id).DataTable().columns(7).search(_baseplantFilter); // BASE PLANT
                        $(table_id).DataTable().draw();

                        DE_DASHBOARD.FUNCTION.setSummary(null,{region_id:_filter,site:_siteFilter,base:_baseplantFilter});
                    });
                    $(`#_site`).parent().find(".select2").css({width:"160px"});
                    $(`#_site`).parent().find(".select2-selection").css({height:"32px"});
                    $(`#_baseplant`).show().select2({placeholder: "Choose Unit Base Plant",allowClear: true}).val("").change(function(){
                        _baseplantFilter = $(this).val();

                        _siteFilter = (_siteFilter || []).filter(x => x);

                        var _filter = (filter == "ALL") ? "" : filter;
                        $(table_id).DataTable().columns(0).search(_filter); // REGION
                        $(table_id).DataTable().columns(4).search(_siteFilter.join("|"),true,false); // SITE
                        $(table_id).DataTable().columns(7).search(_baseplantFilter); // BASE PLANT
                        $(table_id).DataTable().draw();

                        DE_DASHBOARD.FUNCTION.setSummary(null,{region_id:_filter,site:_siteFilter,base:_baseplantFilter});
                    });
                    $(`#_baseplant`).parent().find(".select2-selection").css({height:"32px"});
                });
            };
            TABLE.FINISH_LOADING.CHECK();
            /******** END TABLE CHECK ********/
        
            /******** GET TAGS ********/
            BASE_PLANTS = null;
            var getTag = function(tries){
                GET.AJAX({
                    "url": `https://${CLIENT.ggsURL}/comGpsGate/api/v.1/applications/${CLIENT.appId}/tags?FromIndex=0&PageSize=1000`,
                    "method": "GET",
                    "headers": {
                        "Authorization": USER.apiKey
                    },
                }, function(response){
                    BASE_PLANTS = BASE_PLANTS || [];
                    console.log("Tags:",response);
                    var _baseplantOptions = `<option value="">Choose Unit Base Plant</option>`;
                    response.forEach(val => {
                        if(val.name.indexOf("A_Base Plant:") > -1){
                            var tempName = val.name.split(": "),
                                plant = tempName[1];
                            if(plant == "STA ROSA PL") plant = "STAROSA PL";

                            _baseplantOptions += `<option value="${plant}">${plant}</option>`;

                            BASE_PLANTS.push({
                                plant,
                                usersIds: val.usersIds
                            });
                        }
                    });
                    $(`#_baseplant`).html(_baseplantOptions);
                }, function(error){
                    console.log(error);
                    if(error.status == 0 && tries < MAX_TRIES){
                        tries++;
                        getTag(tries);
                    }
                    TOASTR.ERROR(error);
                });
                };
            getTag(0);
            /******** END GET TAGS ********/

            /******** REAL TIME DATE&TIME ********/
            var interval = setInterval(function() {
                var momentNow = moment();
                $('[_DATE_]').html(momentNow.format('MM/DD/YYYY'));
                $('[_TIME_]').html(momentNow.format('HH:mm')); // hh:mm A
            }, 100);
            /******** END REAL TIME DATE&TIME ********/
        },
        createRow: function(obj,dispatch){
            LIST["dispatch"] = LIST["dispatch"] || [];
            dispatch = dispatch || obj.dispatchDetails || {destination:[]};

            // console.log(dispatch);
            
            var urlPath = "notifications",
                vehicle_id = obj.dispatch_vehicle_id || dispatch.vehicle_id,
                vehicle = getVehicle(vehicle_id),
                destination = dispatch.destination[0] || {location_id:""},
                location_id = obj.dispatch_location_id || destination.location_id,
                geofence = getGeofence(location_id),
                index = LIST[urlPath].findIndex(x => x.id == obj.id),
                dIndex = LIST["dispatch"].findIndex(x => x._id == dispatch._id);
                
            obj.region_id = geofence.region_id;

            if(!obj.dispatch_vehicle_id){
                obj.id = obj._id;
                obj.dispatch_vehicle_id = vehicle_id;
                obj.dispatch_status = dispatch.status;
            }


            (obj._row) ? null : obj._row = GENERATE.RANDOM(36);
            (index > -1) ? LIST[urlPath][index] = obj : LIST[urlPath].push(obj);

            // (dispatch._row) ? null : dispatch._row = GENERATE.RANDOM(36);
            // (dIndex > -1) ? LIST["dispatch"][dIndex] = dispatch : LIST["dispatch"].push(dispatch);

            return TABLE.COL_ROW(null,{
                'Region ID': geofence.region_id,
                'Delay Type': obj.delay_type,
                'SN': obj.dispatch_id,
                '_row':  obj._row,
                'Plate No': vehicle.name || "-",
                'Base Plant': "...",
                'Destination': obj.site || "-",
                'Duration': "...",
                'Escalation': obj.escalation || "-",
            }).row;
        },
        addDataToTable: function(obj){
            return new Promise((resolve,reject) => {
                LIST["dispatch"] = LIST["dispatch"] || [];
                var dispatch = LIST["dispatch"].find(x => x._id == obj.dispatch_id),
                    setColRow = function(){
                        resolve(DE_DASHBOARD.FUNCTION.createRow(obj,dispatch));
                    };
                if(dispatch){
                    setColRow();
                } else {
                    GET.AJAX({
                        url: `/api/dispatch/${CLIENT.id}/${USER.username}/${obj.dispatch_id}`,
                        method: "GET",
                        headers: {
                            "Authorization": SESSION_TOKEN
                        },
                    }, function(docs){
                        var doc = docs[0];
                        if(doc) LIST["dispatch"].push(doc);
                        dispatch = doc || {destination:[]};
                        setColRow();
                    });
                }
            });
        },
        setSummary: function(_dt_,filter){
            var count = {
                ot: {1:0,2:0,3:0},
                lq: {1:0,2:0,3:0},
                oc: {1:0,2:0,3:0},
            },
            fltered = LIST["notifications"];
            if(filter){
                fltered = LIST["notifications"].filter(x => (((filter.region_id)?x.region_id==filter.region_id:true) && 
                                                        ((filter.site && filter.site.length>0)?filter.site.includes(x.site):true) && 
                                                        ((filter.base)?x.site==filter.base:true)));
            }

            $.each(fltered, function(i,val){
                if(val.delay_type == "Over Transit" && (!_dt_ || _dt_ == "ot")) count.ot[val.escalation]++; 
                if(val.delay_type == "Long Queueing" && (!_dt_ || _dt_ == "lq")) count.lq[val.escalation]++; 
                if(val.delay_type == "Over CICO" && (!_dt_ || _dt_ == "oc")) count.oc[val.escalation]++; 
            });
            Object.keys(count).forEach(key => {
                Object.keys(count[key]).forEach(key1 => {
                    if(!_dt_ || _dt_ == key){
                        $(`[${key}_esc_${key1}]`).html(count[key][key1] || "-");
                    }
                });
            });
        },
        setBadge: function(type){
            if(!type || PAGE.GET() == "de_dashboard") DE_NOTIF_COUNT = [];
            // if(type == "add") DE_NOTIF_COUNT ++;
            // if(type == "sub") DE_NOTIF_COUNT --;

            if(DE_NOTIF_COUNT.length == 0 || PAGE.GET() == "de_dashboard"){
                $(`#de_dashboard-badge`).hide();
            } else {
                $(`#de_dashboard-badge`).show();
            }

            $(`#de_dashboard-badge`).html(DE_NOTIF_COUNT.length);
        }
    }
};
const OTD_DASHBOARD = {
    init: function(){
        var _new_ = true;


        // declare variables
        var dt = null;
        var areaChart = null;
        const refreshTime = 180000; // 3 minutes
        const filter = { timestamp: FILTER.DATERANGE() };
        var formattedDate = moment().format('MM/DD/YYYY');

        // paginationId is to know which data should be loaded. This is in case pagination() was called and 
        // still loading the data at 30% then the user decided to change the date. This will load the data again.
        // By checking the paginationId and
        var paginationId = null;


        function initializePageElements(){
            // initialize datatable
            dt = $('#summary-tbl').DataTable({
                dom: 't',
                paging: false,
                order: [[ 0, "asc" ]],
                scrollX: true,
                scrollY: "calc(100vh - 340px)",
                createdRow: function (row, data, dataIndex) {
                    var _row = GENERATE.RANDOM(36);
                    $(row).attr(`_row`, _row).css("cursor","pointer");

                    // row double click listener
                    $(document).on("dblclick",`#summary-tbl [_row="${_row}"]`,function(e) {
                        e.preventDefault();

                        var el = $(".more-info-container");

                        if(el.length > 0){
                            // remove old container/slider
                            el.hide("slide", {direction:'right'},100, function(){ 
                                el.remove();
                            
                                // add the new slider (wait for 100ms)
                                slideMoreInfo(data[14],_row,data[0]);
                                clearSelection();
                            });
                        } else {
                            // add the new slider
                            const obj = data[14] || { sortedEvents: [], totalVehicles: 0 };
                            slideMoreInfo(obj,_row,data[0]);
                            clearSelection();
                        }
                    });
                },
            });

            // initialize datepicker
            $(`#_date`).daterangepicker({
                opens: 'left',
                autoUpdateInput: false,
                singleDatePicker:true,
                autoApply: true,
                locale: {
                    format: 'MM/DD/YYYY'
                }
            }, function(start, end, label) { }).on('apply.daterangepicker', function(ev,picker){

                // update the value of 'formattedDate'
                formattedDate = moment(new Date(picker.startDate)).format('MM/DD/YYYY');

                // update this element's values
                $(this).val(formattedDate);
                $(this).data('daterangepicker').setStartDate(formattedDate);
                $(this).data('daterangepicker').setEndDate(formattedDate);

                // update filter timestamp
                filter.timestamp = FILTER.DATERANGE(formattedDate);

                // load summary data based on the date selected by the user
                loadSummaryData();
                
            }).val(moment().format("MM/DD/YYYY"));

            // initialize area chart
            // general config and options
            var chartLabels = ['12:00 AM to 7:00 AM', '7:01 AM to 9:00 AM', '9:01 AM to 12:00 PM', '12:01 PM to 3:00 PM', '3:01 PM to 5:00 PM', '5:01 PM to 11:59 PM'];
            var scalesOptions = {
                xAxes: [
                {
                    gridLines:
                    {
                        display: false
                    }
                }],
                yAxes: [
                {
                    gridLines:
                    {
                        color: '#eff3f6',
                        drawBorder: false,
                    },
                }]
            };
            // area chart
            var ctxAreaChart = document.getElementById("area-chart").getContext("2d");
            areaChart = new Chart(ctxAreaChart,
            {
                type: 'line',
                data:
                {
                    labels: chartLabels,
                    datasets: [
                    {
                        data: [],
                        label: 'Number',
                        backgroundColor: 'rgba(2, 162, 73, 0.25)',
                        borderColor: 'rgb(2, 162, 73)',
                        borderWidth: 2,
                    }, ],
                },
                options:
                {
                    responsive: true,
                    scales: scalesOptions,
                    elements:
                    {
                        point:
                        {
                            radius: 2,
                        },
                    },
                    legend:
                    {
                        position: 'right'
                    }
                }
            });
            // end initialize area chart
        }

        // function that gets data from the database in batch. 
        // will only call the callback function when ALL data is retreived
        function pagination(x){
            // set this functions paginationId as the last paginationId
            const selfPaginationId = paginationId;

            // display 'Loading...' in chart
            $('#area-chart-loading').html("Loading... 0%");

            // count total documents (filtered)
            $.ajax({
                url: x.countURL,
                method: "GET",
                timeout: 90000, // 1 minute and 30 seconds
                headers: {
                    "Authorization": SESSION_TOKEN
                },
                async: true
            }).done(function (count) {
                console.log("count",count);

                var pb = new ProgressBar(count);
                var docs = [];
                var skip = 0;

                function retrieveData(length){
                    if(length == null || length == LIMIT){
                        $.ajax({
                            url: `${x.dataURL}/${skip}/${LIMIT}`,
                            method: "GET",
                            timeout: 90000, // 1 minute and 30 seconds
                            headers: {
                                "Authorization": SESSION_TOKEN
                            },
                            async: true
                        }).done(function (_docs_) {
                            if(!_docs_.error){
                                length = _docs_.length;
        
                                if(_docs_.error){
                                    toastr.error(_docs_.error.message);
                                } else {
                                    skip += length;
                                    docs = docs.concat(_docs_);
                                    var percent = pb.calculate();
                                    
                                    $('#area-chart-loading').html(`Loading... ${percent}%`);
                                    
                                    // check if pagination Ids are still the same. Do not continue if not the same
                                    if(selfPaginationId == paginationId){
                                        retrieveData(length);
                                    }
                                }
                            }
                        });
                    } else {
                        $('#area-chart-loading').html(`Loading... 100%`);
                        // check if pagination Ids are still the same. Do not continue if not the same
                        if(selfPaginationId == paginationId){
                            x.callback(docs);
                        }
                        if(!x.doNotRemoveTable){
                            $(`#report-hidden,#overlay,#temp-link,[data-SheetName]`).remove();
                        }
                    }
                }
                retrieveData();
            });
        }

        // draws the chart based on 'chartData' value passed
        function updateAreaChart(chartData){
            $('#area-chart-loading').hide();

            var newDataset = {
                data: chartData,
                label: 'Number',
                backgroundColor: 'rgba(2, 162, 73, 0.25)',
                borderColor: 'rgb(2, 162, 73)',
                borderWidth: 2,
            };
            areaChart.data.datasets.pop();
            areaChart.data.datasets.push(newDataset);
            areaChart.update();
        }

        // function that resets the value in the dashboard
        function resetSummaryData(){
            $('#export-container').html("");
            $('#last-refresh').html("-");
            $(`[summary]`).each((i,el) => {
                ($(el).attr("summary").indexOf("percent") > -1) ? $(el).html("-%") : $(el).html(0);
            });
            updateAreaChart([]);
            dt.clear().draw();
        }

        // load summary data
        function loadSummaryData(){
            // set paginationId.
            paginationId = GENERATE.RANDOM(6);

            // reset summary data and show 'Loading...'
            resetSummaryData();
            $('#area-chart-loading').show();
            
            // clear interval of loading data
            clearInterval(INTERVALS.otd_dashboard);

            // get data from db in batch
            pagination({
                countURL: `/api/events/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                dataURL: `/api/events/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}`,
                callback: function(docs){
                    // sort data by vehicle and then time
                    docs.sort(function (a, b) {
                        return a.USER_NAME.localeCompare(b.USER_NAME) || new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
                    });
                    console.log(docs);

                    // add button and add event to button. Download data as Excel (originally in Reports page.)
                    $('#export-container').html(`
                        <div class="dt-buttons">
                            <button class="dt-button buttons-excel buttons-html5" tabindex="0" aria-controls="summary-tbl" type="button" data-toggle="tooltip" title="Download OTD Report (.xls)">
                                <span><i class="la la-file-download"></i></span>
                            </button>
                        </div>`);
                    $(`.buttons-excel`).click(function(){
                        REPORTS.UI.REPORTS.OTDR("On Time Departure",docs,formattedDate,formattedDate);
                    });
                    PAGE.TOOLTIP();

                    // declare variables. 
                    const processedDocs = REPORTS.UI.REPORTS.OTDR("",docs,formattedDate,formattedDate,true);
                    const summaryTotals = processedDocs.summaryTotals;
                    const summaryObject = processedDocs.summaryObject;
                    const individualObject = processedDocs.individualObject;

                    // update the total summary values
                    Object.keys(summaryTotals).forEach(key => {
                        $(`[summary="${key}"]`).html(summaryTotals[key]);
                    });

                    // update area chart
                    updateAreaChart([
                        summaryTotals["12:00 AM - 07:00 AM-number"],
                        summaryTotals["7:01 AM - 9:00 AM-number"],
                        summaryTotals["9:01 AM - 12:00 PM-number"],
                        summaryTotals["12:01 PM - 3:00 PM-number"],
                        summaryTotals["3:01 PM - 5:00 PM-number"],
                        summaryTotals["5:01 PM - 11:59 PM-number"],
                    ]);

                    // update last refresh time
                    $('#last-refresh').html(moment().format("MMM DD, YYYY, hh:mm A"));

                    // add datatable rows
                    const rows = [];
                    Object.keys(summaryObject).forEach(dc => {
                        rows.push([
                            dc,
                            summaryObject[dc]["totalVehicles"],
                            summaryObject[dc]["12:00 AM - 07:00 AM-number"],
                            summaryObject[dc]["12:00 AM - 07:00 AM-percent"],
                            summaryObject[dc]["7:01 AM - 9:00 AM-number"],
                            summaryObject[dc]["7:01 AM - 9:00 AM-percent"],
                            summaryObject[dc]["9:01 AM - 12:00 PM-number"],
                            summaryObject[dc]["9:01 AM - 12:00 PM-percent"],
                            summaryObject[dc]["12:01 PM - 3:00 PM-number"],
                            summaryObject[dc]["12:01 PM - 3:00 PM-percent"],
                            summaryObject[dc]["3:01 PM - 5:00 PM-number"],
                            summaryObject[dc]["3:01 PM - 5:00 PM-percent"],
                            summaryObject[dc]["5:01 PM - 11:59 PM-number"],
                            summaryObject[dc]["5:01 PM - 11:59 PM-percent"],
                            individualObject[dc] //index 14
                        ]);
                    });
                    dt.rows.add(rows).draw(false);
                    

                    // set interval to refresh summary data. Tip: comment out during development
                    // only set interval if filter date is today
                    if(moment().isSame( moment(formattedDate),'d')){
                        INTERVALS.otd_dashboard = setInterval(function(){
                            loadSummaryData();
                        }, refreshTime); // 3 minutes
                    }
                }
            });
        }

        // show the slider more info when summary row is double clicked
        function slideMoreInfo(obj,_row,dc){
            // declase variables (slider html)
            const headerLeftHTML = `<h4 style="color: #151b26;margin: 6px 0 0px;">${dc}</h4>`;
            const bodyTitleHTML = `<div style="color: #151b26;line-height: 21px;">
                                        <div>Total Events: <b>${obj.sortedEvents.length||0}</b></div>
                                        <div>Total Vehicles: <b>${obj.totalVehicles||0}</b></div>
                                    </div>`;
            const bodyContentHTML = `<table id="individual-tbl" class="display" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th>Date & Time</th>
                                                <th>Duration</th>
                                                <th>Vehicle</th>
                                                <th>Status</th>
                                                <th>Check Out</th>
                                                <th>Check In</th>
                                                <th>Truck Base Site</th>
                                                <th>Equipt No</th>
                                                <th>Check In Date & Time</th>
                                                <th>Truck Base Site Code</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>`;
            // append to html
            $(`.page-box.row`).append(SLIDER.MORE_INFO.view({_row, headerLeftHTML, headerRightButtons: null, bodyTitleHTML, bodyContentHTML}));
            // slide the element
            $(`.more-info-container`).toggle("slide", {direction:'right'},100);
            // update max height
            $(`.main-details,.log-details`).css({"max-height": $(`body`).innerHeight()-90, "overflow-y": "auto"});

            
            // initialize datatable
            const iDt = $('#individual-tbl').DataTable({
                dom: 't',
                paging: false,
                order: [[ 0, "asc" ]],
                scrollX: true,
                scrollY: "calc(100vh - 260px)",
                columnDefs: [
                    { targets: [0,8], type:"date" },
                ]
            });
            
            // add datatable rows
            const rows = [];
            obj.sortedEvents.forEach(val => {
                rows.push([
                    `${val["Date"]}, ${val["Time"]}`,
                    val["Duration"],
                    val["Vehicle"],
                    val["Status"],
                    val["Check Out"],
                    val["Check In"],
                    val["Truck Base Site"],
                    val["Equipt No"],
                    `${val["Check In Date"]}, ${val["Check In Time"]}`,
                    val["Truck Base Site Code"],
                ]);
            });
            iDt.rows.add(rows).draw(false);
        }

        

        /******** TABLE CHECK ********/
        TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
            isFinishedLoading(["VEHICLES"], _new_, function(){
                _new_ = false;
                PAGE.DISPLAY();

                initializePageElements();

                // load summary data based on today's date
                loadSummaryData();
            });
        }
        TABLE.FINISH_LOADING.START_CHECK();
        /******** END TABLE CHECK ********/
    }
};
var DISPATCH = {
    detectStatus: function(body){
        const CLIENT_OPTIONS = {
            "coket1": { ggsURL: "coca-cola.server93.com",    appId: 9,     scheduledEntry: false,     allowTempStatus: true,     allowIncompleteUpdateStatus: true,     ignoreDestinationEvents: false,     statusOption: { default: "assigned", insideOrigin: "assigned",     insideOriginEvent: "entered_origin",    enRouteToDestination: "in_transit" }    },
            "coket2": { ggsURL: "coca-cola.server93.com",    appId: 4,     scheduledEntry: false,     allowTempStatus: false,    allowIncompleteUpdateStatus: false,    ignoreDestinationEvents: true,      statusOption: { default: "assigned", insideOrigin: "assigned",     insideOriginEvent: "entered_origin",    enRouteToDestination: "onDelivery" }    },
            "wilcon": { ggsURL: "wru.server93.com",          appId: 427,   scheduledEntry: true,      allowTempStatus: true,     allowIncompleteUpdateStatus: false,    ignoreDestinationEvents: false,     statusOption: { default: "assigned", insideOrigin: "assigned",     insideOriginEvent: "entered_origin",    enRouteToDestination: "in_transit" }    },
        };

        // maximum number of times to call an API when it returned an error
        const MAX_TRIES = 5;

        // maximum number of hours between event time and current time
        // events beyond that time difference are ignored
        const MAX_HOURDIFF = 24;
        return new Promise((resolve,reject) => {
            // option for current client
            const clientOption = CLIENT_OPTIONS[CLIENT.id];
                                
            // initialize timezone and date formats
            const now_ms = moment().valueOf(); // get current time in milliseconds

            // get Main credentials
            const ggsURL = clientOption.ggsURL;
            const appId = clientOption.appId;

            // check whether NOW is within schedule date
            function isNowWithinSchedule(minDate,shiftTime){
                // format date to MMM DD, YYYY
                minDate = moment(minDate).format("MMM DD, YYYY");

                // split shift schedule into minimum and maximum time.
                // Sample Original format: 12:00 AM - 3:00 PM
                shiftTime = (shiftTime||"").split(" - ");

                const minTime = shiftTime[0]; // minimum time - 12:00 AM
                const maxTime = shiftTime[1]; // maximum time - 3:00 PM

                // convert minimum time to moment object
                const minTimeMoment = moment(minTime);
                // convert maximum time to moment object
                const maxTimeMoment = moment(maxTime);
                // if maximum time is before minimum time, add 1 day to date
                // Reason: shifts like "July 28, 2021 - 8:00 PM - 1:00 AM"
                // Goal: Min DateTime = July 28, 2021, 8:00 PM
                //       Max DateTime = July 29, 2021, 1:00 AM
                const maxDate = (maxTimeMoment.isBefore(minTimeMoment)) ? moment(minDate).add(1,"day") : minDate;
                
                // activate entry XX minutes BEFORE scheduled date and time. Default value is 0.
                // Eg. Schedule: July 28, 2021 (8:00 PM - 1:00 AM)
                //     activateInMinutes: 60
                //     Result: Activate entry on July 28, 2021, 7:00 PM
                const minutes = (clientOption||{}).activateInMinutes || 0;

                // get the minimum date and time minus X minutes in milliseconds
                const minSchedule = moment(`${minDate}, ${minTime}`).subtract(minutes,"minutes").valueOf();
                // get the maximum date and time in milliseconds
                const maxSchedule = moment(`${maxDate}, ${maxTime}`).valueOf();

                // return true if NOW is between minimum schedule and maximum schedule
                return (now_ms >= minSchedule && now_ms <= maxSchedule);
            }

            // check if RULE_NAME meets the condition
            function getIndexOf(text,arr,op){
                var cond = null;
                arr.forEach(val => {
                    if(op == "or" && !cond){
                        cond = (text.indexOf(val) > -1);
                    }
                    if(op == "and" && (cond == null || cond == true)){
                        cond = (text.indexOf(val) > -1);
                    }
                });
                return cond;
            };

            // declare variables
            var __tempStat = null;
            var late_data_entry = null;
            var events_captured = {};

            // variables sent by client
            const geofenceId = body.geofenceId;
            const scheduled_date = body.scheduled_date;
            const shift_schedule = body.shift_schedule;
            const __originalObj = body.__originalObj;
            const route = body.route;
            const vehicle_id = Number((body.vehicle||{})._id);
            const vehicleUsername = (body.vehicle||{}).username;
            const __status = body.__status;
            const dGeofence = body.dGeofence;
            const geofence = body.geofence;
            const roundtrip = clientCustom.roundtrip;
            const checkSchedule = body.checkSchedule; // boolean - whether the function should check for Schedule or not
            const apiKey = USER.apiKey;

            // sent by client because of Previous Check-In feature. User can select a different check-in-check-out
            // and this function should be able to detect shipment's status based on their selection
            const previousCheckInOriginGeofence = body.previousCheckInOriginGeofence;
            const previousCheckInDestinationGeofence = body.previousCheckInDestinationGeofence;

            // Custom client options
            // Custom status
            const defaultStatus = clientOption.statusOption.default;
            const insideOriginStatus = clientOption.statusOption.insideOrigin;
            const insideOriginEventStatus = clientOption.statusOption.insideOriginEvent;
            const enRouteToDestinationStatus = clientOption.statusOption.enRouteToDestination;

            // allow incomplete shipment update its status
            const allowIncompleteUpdateStatus = clientOption.allowIncompleteUpdateStatus;

            // if dispatch entry is set to make a scheduled/advanced entry
            const scheduledEntry = clientOption.scheduledEntry;

            // whether to ignore the destination events or not
            const ignoreDestinationEvents = clientOption.ignoreDestinationEvents;

            // whether to allow the function to save temp status. Temp status are used to save event times that did not meet the other conditions.
            // Useful for clients that depends on event times PER geofence. 
            const allowTempStatus = clientOption.allowTempStatus;
            
            // Geofence ID should not be null of undefined
            if(geofenceId){

                // If 'checkSchedule' is false OR
                // 'checkSchedule' is true AND 
                // either 'scheduledEntry' is false OR 
                // 'scheduledEntry' is true AND current dateTime is within the scheduled date and shift
                if(!checkSchedule || (checkSchedule && (!scheduledEntry || (scheduledEntry && isNowWithinSchedule(scheduled_date,shift_schedule))))){
                    
                    console.log("DELTE",previousCheckInOriginGeofence,previousCheckInDestinationGeofence);
                    // check if original route and vehicle is same as current
                    if((__originalObj && (__originalObj.route == route && __originalObj.vehicle_id == Number(vehicle_id))) && (!previousCheckInOriginGeofence && !previousCheckInDestinationGeofence)){
                        // return empty object 
                        resolve({});
                    } else {
                        const ignoreStatus = ["complete","scheduled"];
                        if( !allowIncompleteUpdateStatus ){
                            ignoreStatus.push("incomplete");
                        }
                        console.log("DELTE",previousCheckInOriginGeofence,previousCheckInDestinationGeofence);
                        // if vehicle username is not null or undefined AND status is not in the array
                        if(vehicleUsername && !ignoreStatus.includes(__status) ){

                            // function that checks whether the vehicle is inside the geofence or not (WRU Main)
                            function isVehicleInsideGeofenceId(tries){
                                tries = tries || 0;

                                // destination geofence
                                const destinationGeofenceName = dGeofence.short_name;
                                // origin geofence
                                const originShortName = geofence.short_name;

                                // function that determins what the status of the shipment should be based on the vehicle's location history
                                function determineShipmentStatus(oEvents,dEvents,byPassHourDiff){
                                    // note: byPassHourDiff is used to not check the time difference between the event time and current time

                                    // value will change depending on where the truck is
                                    // set status to Client's default shipment status
                                    var status = defaultStatus;
                                    
                                    // used to know the time difference between the event time and current time
                                    // value will change when the truck left the origin. The new value will be used to check
                                    // the time difference between the event time and Check-out time
                                    var tempDateTime = now_ms;


                                    // used for CokeT2
                                    var isOnDelivery = false;
                                    var storedDispatched = false;

                                    // ------------> Origin
                                    // loop origin events
                                    for(var i = oEvents.length-1; i >= 0; i--){

                                        const val = oEvents[i];

                                        // convert time to milliseconds
                                        const eventDate = moment(val.timestamp).valueOf();
                                        // calculate time difference between event time and 'tempDateTime'
                                        const hourDiff = (byPassHourDiff === true) ? 0 : Math.abs(tempDateTime - eventDate) / 36e5;

                                        // print necessary data for debugging
                                        console.log("oEvents",val.RULE_NAME,val.stage,!events_captured[eventDate],hourDiff < MAX_HOURDIFF);

                                        // in transit
                                        // do not remove status = in_transit.
                                        if(((val.RULE_NAME == "Inside Geofence" && val.stage == "end") || (val.RULE_NAME == "Outside Geofence" && val.stage == "start")) && late_data_entry == true && status != enRouteToDestinationStatus && hourDiff < MAX_HOURDIFF) {
                                                status = enRouteToDestinationStatus;
                                                events_captured[eventDate] = enRouteToDestinationStatus;
                                                
                                                tempDateTime = eventDate;
                                        }
                                        
                                        // save event as idlingAtOrigin if RULE_NAME consists "Inside" and "Idle" strings
                                        if(getIndexOf(val.RULE_NAME,["Inside","Idle"],"and") && !events_captured[eventDate] && hourDiff < MAX_HOURDIFF){
                                            events_captured[eventDate] = "idlingAtOrigin";
                                        }

                                        // save event as processingAtOrigin if RULE_NAME consists "Inside" and "Processing" strings
                                        if(getIndexOf(val.RULE_NAME,["Inside","Processing"],"and") && !events_captured[eventDate] && hourDiff < MAX_HOURDIFF){
                                            events_captured[eventDate] = "processingAtOrigin";
                                        }

                                        // save event as queueingAtOrigin if RULE_NAME consists "Inside" and "Queueing" strings
                                        if(getIndexOf(val.RULE_NAME,["Inside","Queueing"],"and") && !events_captured[eventDate] && hourDiff < MAX_HOURDIFF){
                                            events_captured[eventDate] = "queueingAtOrigin";
                                        }
                                        
                                        // Left the geofence
                                        // "!isOnDelivery && !storedDispatched" is added to check that the shipment is neither detected as On Delivery or Dispatched yet
                                        // The status should be based on the latest data ONLY and not by geofence unlike CokeT1 and Wilcon
                                        if((val.RULE_NAME == "Check Out" && val.stage == "start") && late_data_entry == true && status != enRouteToDestinationStatus && !isOnDelivery && !storedDispatched) {
                                            status = enRouteToDestinationStatus;
                                            events_captured[eventDate] = enRouteToDestinationStatus;
                                            tempDateTime = eventDate;
                                            isOnDelivery = true;
                                        }
                                        // Entered the geofence
                                        // "!storedDispatched" is added to check that the shipment is not yet tagged as Dispatched
                                        // The status should be based on the latest data ONLY and not by geofence unlike CokeT1 and Wilcon
                                        if((val.RULE_NAME == "Check Out" && val.stage == "end") && !events_captured[eventDate] && !storedDispatched) {
                                            events_captured[eventDate] = insideOriginStatus;
                                            storedDispatched = true;
                                        }

                                        // save event as tempStatus for events that do not fall under idlingAtOrigin, processingAtOrigin, or queueingAtOrigin, etc
                                        if(allowTempStatus && !events_captured[eventDate] && hourDiff < MAX_HOURDIFF){
                                            events_captured[eventDate] = "tempStatus";
                                        }
                                    }

                                    // if late entry and no 'enRouteToDestinationStatus' timestamp
                                    if(late_data_entry == true && !OBJECT.getKeyByValue(events_captured,enRouteToDestinationStatus)){
                                        // last timestamp will be 'enRouteToDestinationStatus'
                                        events_captured[now_ms] = enRouteToDestinationStatus;
                                    }

                                    // sort eventsCaptured by key (timestamp/eventDate) in ascending order
                                    const sortedEvents = OBJECT.sortByKey(events_captured);

                                    // change first status event to "entered_origin" or 'insideOriginEventStatus'
                                    // Note: "entered_origin" is just for reference when the truck entered the origin geofence. It is not a status.
                                    Object.keys(sortedEvents).forEach((key,i) => {
                                        if(i == 0){
                                            // if first timestamp is not in transit, change value to entered_origin
                                            (sortedEvents[key] != enRouteToDestinationStatus) ? sortedEvents[key] = insideOriginEventStatus : null
                                        }
                                    });

                                    // loop to delete "tempStatus"
                                    Object.keys(sortedEvents).forEach(key => {
                                        (sortedEvents[key] == "tempStatus") ? delete sortedEvents[key] : null;
                                    });
                                    
                                    // had to loop again because when "tempStatus" is deleted, sortedEvents[lastTimestamp] ends up to be undefined
                                    const lastTimestamp = Object.keys(sortedEvents).map(key => { return Number(key); }).sort().reverse()[0];
                                    
                                    // set events_captured equal to its sorted version
                                    events_captured = sortedEvents;

                                    // print necessary data for debugging
                                    console.log("sortedEvents",status,sortedEvents);

                                    // status is equal to the last timestamp's status value
                                    status = sortedEvents[lastTimestamp] || defaultStatus;
                                    // if status is equal to 'insideOriginEventStatus', change it to the proper status or  'insideOriginStatus'
                                    // ex. For CokeT1/Wilcon, 'insideOriginEventStatus' is 'entered_origin' but 'insideOriginStatus' is 'assigned'
                                    (status == insideOriginEventStatus) ? status = insideOriginStatus : null;



                                    // ------------> Destination
                                    // Check if its late entry 
                                    if(late_data_entry == true && !ignoreDestinationEvents){

                                        // get leaving time by status based on events captured
                                        const enRouteDateTime = OBJECT.getKeyByValue(events_captured,enRouteToDestinationStatus);

                                        status = enRouteToDestinationStatus;

                                        // loop destination events
                                        dEvents.forEach(val => {
                                            // convert time to milliseconds
                                            const eventDate = moment(val.timestamp).valueOf();
                                            // calculate time difference between event time and 'tempDateTime'
                                            const hourDiff = (byPassHourDiff === true) ? 0 : Math.abs(tempDateTime - eventDate) / 36e5;

                                            // in_transit/onDelivery (if no enRouteDateTime)
                                            if(val.stage == "start" && !enRouteDateTime && hourDiff < MAX_HOURDIFF){
                                                events_captured[eventDate] = enRouteToDestinationStatus;
                                            }
                                            // end in_transit/onDelivery (if no enRouteDateTime)

                                            if(roundtrip) {
                                                // onSite
                                                // save event as onSite if conditions are the same as entering a geofence (destination geofence)
                                                if(!((val.RULE_NAME == "Inside Geofence" && val.stage == "end") || (val.RULE_NAME == "Outside Geofence" && val.stage == "start")) && status == enRouteToDestinationStatus && !events_captured[eventDate]){
                                                    status = "onSite";
                                                    events_captured[eventDate] = "onSite";
                                                }
                                                // end onSite
                                                

                                                // returning
                                                // save event as returning if conditions are the same as leaving a geofence (destination geofence)
                                                if(((val.RULE_NAME == "Inside Geofence" && val.stage == "end") || (val.RULE_NAME == "Outside Geofence" && val.stage == "start")) && status == "onSite" && !events_captured[eventDate]){
                                                    status = "returning";
                                                    events_captured[eventDate] = "returning";
                                                }
                                                // end returning
                                            } else {
                                                // complete
                                                // save event as complete when the truck entered the destination geofence
                                                if(status == enRouteToDestinationStatus && !events_captured[eventDate] && (Number(enRouteDateTime) < eventDate) && hourDiff < MAX_HOURDIFF){
                                                    status = "complete";
                                                    events_captured[eventDate] = "complete";
                                                }
                                                // end complete
                                            }
                                        });
                                    }

                                    return status;
                                };

                                console.log("DELTE",previousCheckInOriginGeofence,previousCheckInDestinationGeofence);
                                // if no previous check-in geofences sent
                                if(!previousCheckInOriginGeofence && !previousCheckInDestinationGeofence){
                                    
                                    function loadVehiclesHistory(){

                                        // declare client query to be able to close connection later
                                        $.ajax({
                                            url: `/api/vehicles_history/${CLIENT.id}/${USER.username}/${vehicle_id}`,
                                            method: "GET",
                                            timeout: 90000 ,
                                            headers: {
                                                "Authorization": SESSION_TOKEN
                                            },
                                            async: true
                                        }).done(function (docs) {
                                            console.log("docs!!",docs);

                                            
                                            if(docs.length > 0){
                                                const doc = docs[0];
                                                
                                                const loc = doc.location || []; // don't name it 'location', it will refresh page (page.location??)

                                                // late entry - Truck selected is outside the origin
                                                if(late_data_entry) {
                                                    // loop location history - latest to oldest
                                                    for(var i = loc.length-1; i >= 0; i--){

                                                        // if location is shipment's origin
                                                        if(loc[i].short_name == originShortName){
                                                            // >>>>> Truck selected has left the origin <<<<<
                                                            
                                                            // late entry is true
                                                            late_data_entry = true;

                                                            // determine shipment status
                                                            // will automatically be saved as IN TRANSIT or ON DELIVERY.
                                                            __tempStat = determineShipmentStatus(loc[i].events,[]);

                                                            break;
                                                        } else {
                                                            // if location is shipment's destination
                                                            if(loc[i].short_name == destinationGeofenceName){
                                                                // remove the last location (detected as shipment's destination)
                                                                // ex. 
                                                                // loc = [ { short_name: "ABC" }, { short_name: "EFG" }, { short_name: "HIJ" }, { short_name: "KLM" } ] 
                                                                // destination = "HIJ"
                                                                // locationsBeforeDestination = [ { short_name: "ABC" }, { short_name: "EFG" } ] 
                                                                const locationsBeforeDestination = loc.slice(0, i);

                                                                // used to check if the origin is found???
                                                                var prevHasOrigin = false;

                                                                // loop locationsBeforeDestination - latest to oldest
                                                                for(var j = locationsBeforeDestination.length-1; j >= 0; j--){
                                                                    // if it kept on looping and location is the destination again, break loop
                                                                    if(locationsBeforeDestination[j].short_name == destinationGeofenceName){
                                                                        break;
                                                                    }
                                                                    // if location is origin,
                                                                    // >>>>> Truck selected has left the origin and is already at destination. <<<<<
                                                                    if(locationsBeforeDestination[j].short_name == originShortName){
                                                                        // late entry is true
                                                                        late_data_entry = true;
                                                                        // determine shipment status
                                                                        __tempStat = determineShipmentStatus(locationsBeforeDestination[j].events,loc[i].events);
                                                                        prevHasOrigin = true;
                                                                        break;
                                                                    }
                                                                }
                                                                // >>>>> Truck selected is NOT within the origin. It is assumed that the truck is enroute to origin <<<<<
                                                                if(!prevHasOrigin){
                                                                    // late entry is false
                                                                    late_data_entry = false;
                                                                    // make set it to Client's default shipment status
                                                                    __tempStat = defaultStatus;
                                                                }
                                                                break;
                                                            }
                                                        }
                                                    }

                                                    // even after looping the vehicle's location history and __tempStat is still null then,
                                                    // >>>>> Truck selected is NOT within the origin. It is assumed that the truck is enroute to origin <<<<<
                                                    if(__tempStat == null) {
                                                        // make set it to Client's default inside origin status
                                                        __tempStat = defaultStatus;
                                                        // late entry is false
                                                        late_data_entry = false;
                                                    }
                                                } else {
                                                    // >>>>> Truck selected is within the origin <<<<<
                                                    
                                                    // get the last location of the truck and check if it is the shipment's origin
                                                    if(loc[loc.length-1].short_name == originShortName){
                                                        // determine shipment status
                                                        __tempStat = determineShipmentStatus(loc[loc.length-1].events);
                                                    }
                                                    
                                                    // if '__tempStat' is null, then 
                                                    if(__tempStat == null) {
                                                        // make set it to Client's default inside origin status
                                                        __tempStat = insideOriginStatus;
                                                        // late entry is false
                                                        late_data_entry = false;
                                                    }
                                                }
                                                
                                                // sort events_captured
                                                const sortedEvents = OBJECT.sortByKey(events_captured);
                                                events_captured = sortedEvents;

                                                // added this just in case __tempStat is null
                                                __tempStat = __tempStat || defaultStatus;

                                                // print necessary data for debugging
                                                console.log("EYOOOEOEOEOOEOEO",late_data_entry,__tempStat,events_captured);
                                                
                                                // return data
                                                resolve({
                                                    status: __tempStat,
                                                    late_data_entry,
                                                    events_captured,
                                                });

                                            } else {                                                
                                                // return error
                                                resolve({
                                                    status: __tempStat,
                                                    late_data_entry: false,
                                                    events_captured,
                                                });
                                            }
                                        }).fail(error => {
                                            console.log("Error",error);

                                            // if the request returned an error, we will try until the number of maximum tries is reached
                                            if(error.status == 0 && tries < MAX_TRIES){
                                                tries++;
                                                isVehicleInsideGeofenceId(tries);
                                            } else {
                                                // if maximum tries is reached, resolve this dbName function
                                                reject("Vehicles History",error);
                                            }
                                        });
                                    }
                                    
                                    // get the list of users/trucks inside the geofence (WRU Main)
                                    $.ajax({
                                        url: `https://${ggsURL}/comGpsGate/api/v.1/applications/${appId}/geofences/${geofenceId}/users?FromIndex=0&PageSize=500`,
                                        method: "GET",
                                        timeout: 90000 ,
                                        headers: {
                                            "Authorization": apiKey
                                        },
                                        async: true
                                    }).done(function (docs) {
                                        console.log("docs!!",docs);

                                        // print necessary data for debugging
                                        // console.log("Vehicles1:",JSON.stringify(docs));

                                        // if the truck is inside the geofence, late_data_entry is false. Else, true
                                        // Ex. docs = [ { id: "A", username: "123" }, { id: "B", username: "456" } ] 
                                        // !docs.some(x => x.username == "555"); -----> true
                                        // !docs.some(x => x.username == "456"); -----> false
                                        late_data_entry = !docs.some(x => x.username == vehicleUsername);
                                        
                                        // load vehicle history
                                        loadVehiclesHistory();
                                    }).fail(error => {
                                        console.log("Error",error);
                                        // if the request returned an error, we will try until the number of maximum tries is reached
                                        if(error.status == 0 && tries < MAX_TRIES){
                                            tries++;
                                            isVehicleInsideGeofenceId(tries);
                                        } else {
                                            // if maximum tries is reached, resolve this dbName function
                                            reject("GGS Geofences 01",error);
                                        }
                                    });
                                } else {
                                    console.log("DELTE",previousCheckInOriginGeofence,previousCheckInDestinationGeofence);
                                    if(previousCheckInOriginGeofence && previousCheckInDestinationGeofence){

                                        // late entry is true (there's data for 'previousCheckInDestinationGeofence' too)
                                        late_data_entry = true;

                                        // print necessary data for debugging
                                        console.log(previousCheckInDestinationGeofence.short_name,destinationGeofenceName);

                                        // if location is destination
                                        if(previousCheckInDestinationGeofence.short_name == destinationGeofenceName){
                                            // determine shipment status -- 'previousCheckInOriginGeofence' and 'previousCheckInDestinationGeofence' is passed
                                            __tempStat = determineShipmentStatus(previousCheckInOriginGeofence.events,(previousCheckInDestinationGeofence||{}).events,true);
                                        } else {
                                            // determine shipment status -- only 'previousCheckInOriginGeofence'
                                            __tempStat = determineShipmentStatus(previousCheckInOriginGeofence.events,[],true);
                                        }

                                        // sort events_captured
                                        var tempEventsCaptured = OBJECT.sortByKey(events_captured);
                                        events_captured = tempEventsCaptured;

                                        // print necessary data for debugging
                                        console.log("EYOOOEOEOEOOEOEO1111111111",late_data_entry,__tempStat,events_captured);

                                        // return data
                                        resolve({
                                            status: __tempStat,
                                            late_data_entry,
                                            events_captured: events_captured
                                        });
                                    } else {
                                        // ---> There's only data for 'previousCheckInOriginGeofence'

                                        // get the list of users/trucks inside the geofence (WRU Main)
                                        $.ajax({
                                            url: `https://${ggsURL}/comGpsGate/api/v.1/applications/${appId}/geofences/${geofenceId}/users?FromIndex=0&PageSize=500`,
                                            method: "GET",
                                            timeout: 90000 ,
                                            headers: {
                                                "Authorization": apiKey
                                            },
                                            async: true
                                        }).done(function (docs) {
                                            console.log("docs!!",docs);

                                            // print necessary data for debugging
                                            // console.log("Vehicles2:",JSON.stringify(docs));

                                            // if the truck is inside the geofence, late_data_entry is false. Else, true
                                            // Ex. docs = [ { id: "A", username: "123" }, { id: "B", username: "456" } ] 
                                            // !docs.some(x => x.username == "555"); -----> true
                                            // !docs.some(x => x.username == "456"); -----> false
                                            late_data_entry = !docs.some(x => x.username == vehicleUsername);
                                            
                                            // determine shipment status
                                            __tempStat = determineShipmentStatus(previousCheckInOriginGeofence.events,[],true);

                                            // sort events_captured
                                            const sortedEvents = OBJECT.sortByKey(events_captured);
                                            events_captured = sortedEvents;

                                            // print necessary data for debugging
                                            console.log("EYOOOEOEOEOOEOEO222222222",late_data_entry,__tempStat,events_captured);

                                            resolve({
                                                status: __tempStat,
                                                late_data_entry,
                                                events_captured: events_captured
                                            });
                                        }).fail(error => {
                                            console.log("Error",error);
                                            // if the request returned an error, we will try until the number of maximum tries is reached
                                             if(error.status == 0 && tries < MAX_TRIES){
                                                tries++;
                                                isVehicleInsideGeofenceId(tries);
                                            } else {
                                                // if maximum tries is reached, resolve this dbName function
                                                reject("GGS Geofences 02",error);
                                            }
                                        });
                                    }
                                }
                            }

                            isVehicleInsideGeofenceId();
                        } else {
                            // return empty object 
                            resolve({});
                        }
                    }
                } else {
                    // if current time is not within schedule, status is "scheduled"
                    if(checkSchedule && scheduledEntry && !isNowWithinSchedule(scheduled_date,shift_schedule)){
                        resolve({
                            status: "scheduled",
                            late_data_entry: false,
                            events_captured: {},
                        });
                    } else {
                        // return the Client's default shipment status
                        resolve({
                            status: defaultStatus,
                            late_data_entry: false,
                            events_captured: {},
                        });
                    }
                }
            } else {
                // incomplete data. Status is PLAN
                resolve({
                    status: "plan",
                    late_data_entry: false,
                    events_captured: {},
                });
            } 
        });
    },
    FUNCTION: {
        monitoring: function(){
            /******** TABLE ********/
            var urlParams = new URLSearchParams(window.location.search),
                __data = CRYPTO.DECRYPT(urlParams.get('data')),
                table_id = '#tbl-dispatch',
                urlPath = "dispatch",
                uniTitle = "Dispatch Entry",
                filter = USER.filters[urlPath] || {},
                dt = null,
                _new_ = true,
                _new2_ = true,
                _new3_ = true,
                donePopulate = false,
                rowData = function(obj){
                    var de = new Dispatch(obj,table_id);
                    return TABLE.COL_ROW(null,de.row()).row;
                },
                populateTable = function(newlyLoaded,disableClearTable,doNotClearList,_filter_){
                    if(!doNotClearList) LIST[urlPath] = [];
                    filter = _filter_ || USER.filters[urlPath] || {};
                    try {
                        filter = JSON.parse(filter);
                    } catch(error){}
                    
                    inTransitData = false;

                    // var defaultFilter = {
                    //     $or: [
                    //         {
                    //             posting_date: FILTER.DATERANGE()
                    //         },
                    //         {
                    //             status: {
                    //                 $nin: ["plan","complete","incomplete"]
                    //             }
                    //         }
                    //     ]
                    // };
                    var __filter = ($.isEmptyObject(filter)) ? {posting_date: FILTER.DATERANGE()} : filter;
                    if(clientCustom.filterType.dashboard == "postingDate-scheduledDate"){
                        if(__filter.posting_date && !__filter.scheduled_date){
                            var tempFilter = {
                                $or: [
                                    {
                                        posting_date:  __filter.posting_date
                                    },
                                    {
                                        $and: [
                                            {
                                                scheduled_date:  __filter.posting_date
                                            },
                                            {
                                                status: { $ne: "scheduled" }
                                            }
                                        ]
                                    },
                                    // {
                                    //     status: {
                                    //         $nin: ["plan","complete","incomplete"]
                                    //     }
                                    // }
                                ]
                            };
                            Object.keys(__filter).forEach(key => {
                                if(__filter[key] && key != "posting_date"){
                                    tempFilter[key] = __filter[key];
                                }
                            });
                            __filter = tempFilter;
                        }
                        USER.filters.dispatch = __filter;

                    }
                    console.log(__filter);
                    var dt_buttons = TABLE.BUTTONS({
                        goto: PAGE.GET(),
                        loadView: ["create","create-admin","import"],
                        actions:{
                            "create": function(){ // create-admin
                                $(`body`).append(MODAL.CREATE.EMPTY(`Create New ${uniTitle}`,modalViews.dispatch.form[CLIENT.id]()));
                                DISPATCH.FUNCTION.form({asAdmin:true});
                            },
                            import: function(){
                                $(`body`).append(MODAL.CREATE.EMPTY(`Import Batch File`,modalViews.dispatch.import()));
                                DISPATCH.FUNCTION.import({});
                            },
                            refresh: function(){
                                populateTable(null);
                            },
                            column: function(){
                                $(`#export-container`).hide("slide", {direction:'right'},100);
                                $(`#filter-container`).hide("slide", {direction:'right'},100);
                                $(`#clone-container`).hide("slide", {direction:'right'},100);
                                $(`#cv-container`).toggle("slide", {direction:'right'},100);
                            },
                            filter: function(){
                                $(`#export-container`).hide("slide", {direction:'right'},100);
                                $(`#cv-container`).hide("slide", {direction:'right'},100);
                                $(`#clone-container`).hide("slide", {direction:'right'},100);
                                $(`#filter-container`).toggle("slide", {direction:'right'},100);
                            },
                            export: function(){
                                $(`#filter-container`).hide("slide", {direction:'right'},100);
                                $(`#cv-container`).hide("slide", {direction:'right'},100);
                                $(`#clone-container`).hide("slide", {direction:'right'},100);
                                $(`#export-container`).toggle("slide", {direction:'right'},100);
                            },
                            clone: function(){
                                $(`#export-container`).hide("slide", {direction:'right'},100);
                                $(`#cv-container`).hide("slide", {direction:'right'},100);
                                $(`#filter-container`).hide("slide", {direction:'right'},100);
                                $(`#clone-container`).toggle("slide", {direction:'right'},100);
                            },
                        }
                    });
                    
                    donePopulate = false;
                    if(dt && !disableClearTable) {
                        dt.clear().draw();
                        $(".dataTables_empty").text("Loading...");
                    }
                    GET.AJAX({
                        url: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(__filter)}/count`,
                        method: "GET",
                        headers: {
                            "Authorization": SESSION_TOKEN
                        },
                    }, function(count){
                        var minWidth = 1, maxWidth = 1, origPerc = 0,totalPerc = 0;
                        console.log("count",count);
                        TABLE.POPULATE({
                            url:`${urlPath}/${CLIENT.id}/${USER.username}/all`,
                            goto: PAGE.GET(),
                            commentTitle: uniTitle,
                            withFilter: true,
                            filter: __filter,
                            urlPath,
                            withPagination: true,
                            newlyLoaded,
                            dataTableOptions: {
                                columns: TABLE.COL_ROW(CUSTOM.COLUMN.dispatch()).column,
                                createdRow: function (row, data, dataIndex) {
                                    var _row = data._row,
                                        _id = data._id;
                                    $(row).attr(`_row`, data._row);
                                    
                                    TABLE.ROW_LISTENER({table_id,_row,urlPath:urlPath,_id,
                                        deleteURL: `/api/${urlPath}/${CLIENT.id}/${USER.username}/${_id}`,
                                        editCallback: function(){
                                            $(`body`).append(MODAL.CREATE.EMPTY(`Update ${uniTitle}`,modalViews.dispatch.form[CLIENT.id]()));
                                            DISPATCH.FUNCTION.form({_id:data._id,asAdmin:true});
                                            $("html, body,#modal").animate({ scrollTop: 0 }, "fast");
                                        },
                                        additionalListeners: function(){
                                            $(table_id).on('click', `[_row="${_row}"] [statusUpdate],[_row="${_row}"] + tr.child [statusUpdate]`,function(e){
                                                e.stopImmediatePropagation();

                                                var obj = LIST[urlPath].find(x => x._id && x._id.toString() == _id.toString());
                                                if(!obj){}
                                                else {
                                                    $(`body`).append(modalViews.dispatch.statusUpdate(obj._id));
                                                    DISPATCH.FUNCTION.status(_id);
                                                }
                                            });
                                        }
                                    });
                                },
                                order: clientCustom.columnOrder.dispatch,
                                dom: 'lB<"toolbar">frti<"tbl-progress-bar">p',
                                buttons: dt_buttons
                            },
                            table_id,
                            initializeCallback: function(data,_dt){
                                dt = _dt;
                                searchEvent();
                                initializeFilter();
                                TABLE.WATCH({urlPath,rowData,options:function(){TABLE.FINISH_LOADING.START_CHECK();}});
                                
                                $(table_id).on( 'search.dt length.dt page.dt', function () {
                                    isFinishedLoading(["GEOFENCES","VEHICLES","TRAILERS","VEHICLES_HISTORY","ROUTES","VEHICLE_PERSONNEL"], true, function(){
                                        TABLE.FINISH_LOADING.UPDATE();
                                        setTimeout(function(){ TABLE.FINISH_LOADING.UPDATE(); },300);
                                    });
                                });

                                // // initialize loading bar
                                $("div.tbl-progress-bar").html(LOADING.PROGRESSBAR.UI()).css({position:"absolute",left:"0px",bottom:"-6px",width:"160px",height:"20px"});
                                LOADING.PROGRESSBAR.INITIALIZE();
                            },
                            populateCallback: function(data){
                                if($(table_id).length > 0){
                                    donePopulate = true;
                                    $(`#search-btn`).css({"pointer-events":"","color":""});
                                    
                                    var rows = [];
                                    $.each(data, function(i,val){
                                        rows.push(rowData(val));
                                    });
                                    dt.rows.add(rows).draw(false);
                                    TABLE.FINISH_LOADING.START_CHECK();

                                    
                                    $("div.tbl-progress-bar").show();
                                    var a = count/LIMIT;
                                    var wholeNumber = Math.floor(a);
                                    var modulo = a % 1;
                                    if(modulo > 0) wholeNumber++
                                    (origPerc) ? null : origPerc = (100 / wholeNumber);
                                    totalPerc = totalPerc + origPerc;
                                    minWidth = maxWidth;
                                    maxWidth = Math.floor(totalPerc);
                                    LOADING.PROGRESSBAR.MOVE(minWidth,maxWidth);
                                }
                            },
                        });
                    });
                },
                // getInTransitData = function(){
                //     if(!inTransitData){
                //         GET.AJAX({
                //             url: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify({status:"in_transit"})}/0/0`,
                //             method: "GET",
                //             headers: {
                //                 "Authorization": SESSION_TOKEN
                //             },
                //         }, function(docs){
                //             inTransitData = true;
                //             console.log("All",docs);
                //             var rows = [];
                //             var inEye = [];
                //             $.each(docs, function(i,val){
                //                 var obj = LIST[urlPath].find(x => x._id == val._id) || {};

                //                 var rowNode = dt.row(`[_row="${obj._row}"]`).node();
                //                 if(rowNode){
                //                     // dt.row(rowNode).data(rowData(val));
                //                 } else {
                //                     val.inEye = true;
                //                     var newVal = rowData(val);
                //                     rows.push(newVal);
                //                     inEye.push(newVal._row);
                //                 }
                //             });
                //             if($(`.la-eye-slash`).length == 1) {
                //                 $.fn.dataTable.ext.search.push(
                //                     function(settings, data, dataIndex) {
                //                         return !inEye.includes($(dt.row(dataIndex).node()).attr('_row'));
                //                     }
                //                 );
                //             }
                //             dt.rows.add(rows).draw(false);
                //         });
                //     }
                // },
                initializeFilter = function(){
                    $(`.page-box`).append(SLIDER.COLUMN_VISIBILITY(CUSTOM.COLUMN.dispatch())); 
                    $('span.toggle-vis').on( 'click', function (e) {
                        var index = $(this).attr('data-column'),
                            column = dt.column(index);

                        column.visible( ! column.visible() );
                        CUSTOM.COLUMN.dispatch()[index].visible = column.visible();
                        CUSTOM.COLUMN.dispatch()[index].bVisible = column.visible();
                        $(table_id).attr("style","");

                        $(`${table_id} thead tr th`).each((i,el) => {
                            if(!$(el).is(":visible")){
                                $(`${table_id} tr:not(.child)`).each((i1,el1) => {
                                    $(el1).find("td").eq(i).hide();
                                });
                            }
                        });
                    });
                    
                    $(`.page-box`).append(SLIDER.EXPORT()); 
                    TABLE.TOOLBAR(dt,() => { 
                        const title = (CLIENT.id == "coket2") ? "T2 Dispatch Entries | WRU Dispatch" : "Dispatch Entries | WRU Dispatch";
                        return title; 
                    } );
                    $(`.buttons-copy span`).html("Copy Table");
                    $(`.buttons-csv span`).html("Export Table As CSV File");
                    $(`.buttons-excel span`).html("Export Table As Excel File");

                    $(`#_departure_date,#_posting_date,#_scheduled_date,#clone_posting_date`).daterangepicker({
                        opens: 'left',
                        timePicker: true,
                        locale: {
                            format: 'MM/DD/YYYY hh:mm A'
                        },
                        autoUpdateInput: false,
                        autoApply: true
                    }, function(start, end, label) {
                        FILTER.INITIALIZE($(this)["0"].element,start,end,'MM/DD/YYYY hh:mm A');
                        $('.clearable').trigger("input");
                    }).on('apply.daterangepicker', function (ev, picker) {
                        FILTER.INITIALIZE($(this),picker.startDate,picker.endDate,'MM/DD/YYYY hh:mm A');
                        $('.clearable').trigger("input");
                    });
                    $(`#_region`).change(function(){
                        $(`#_cluster`).val("all");
                    });
                    $(`#_cluster`).change(function(){
                        $(`#_region`).val("all");
                    });

                    // console.log("HI",filter)

                    if(filter.departure_date) FILTER.INITIALIZE(`#_departure_date`,filter.departure_date["$gte"],filter.departure_date["$lt"],'MM/DD/YYYY hh:mm A');
                    if(filter.scheduled_date) FILTER.INITIALIZE(`#_scheduled_date`,filter.scheduled_date["$gte"],filter.scheduled_date["$lt"],'MM/DD/YYYY hh:mm A');
                    if(filter.posting_date) FILTER.INITIALIZE(`#_posting_date`,filter.posting_date["$gte"],filter.posting_date["$lt"],'MM/DD/YYYY hh:mm A');
                    if(filter.status) $(`#_status`).val(filter.status);
                    if(filter.region) $(`#_region`).val(filter.region);
                    if(filter.cluster) $(`#_cluster`).val(decodeURIComponent(filter.cluster));
                    if(filter.origin_id) $(`#_origin_id`).val(filter.origin_id);
                    if(filter.destination_id) $(`#_destination_id`).val(filter.destination_id);
                    if(filter.departure_date || filter.posting_date || filter.scheduled_date || filter.status || filter.region || filter.cluster || filter.origin_id || filter.destination_id) {
                        $(`#filter-container`).toggle("slide", {direction:'right'},100);
                        $('.clearable').trigger("input");
                        FILTER.STATUS = "new";
                    }
                    
                    FILTER.RESET({
                        dateEl: `#_posting_date`,
                        dateElnoVal: `#_departure_date,#_scheduled_date`,
                        selectEl: `#_status,#_region,#_cluster,#_origin_id,#_destination_id`,
                        urlPath,
                        populateTable
                    });
                    $(`#filter-btn`).click(function(){
                        filter = {};
                        var _departure_date = $(`#_departure_date`).val(),
                            _scheduled_date = $(`#_scheduled_date`).val() || "",
                            _posting_date = (_departure_date || _scheduled_date) ? $(`#_posting_date`).val() : ( $(`#_posting_date`).val() || DEFAULT_DATE),
                            _status = $(`#_status`).val(),
                            _region = $(`#_region`).val(),
                            _cluster = $(`#_cluster`).val(),
                            _origin_id = $(`#_origin_id`).val() || "",
                            _destination_id = $(`#_destination_id`).val(),
                            ___origin_id = [];
                        console.log("_departure_date",_departure_date,_posting_date);
                        (!_departure_date.isEmpty()) ? filter["departure_date"] = FILTER.DATERANGE(_departure_date,true,true) : null;
                        (!_posting_date.isEmpty()) ? filter["posting_date"] = FILTER.DATERANGE(_posting_date,true,true) : null; 
                        (!_scheduled_date.isEmpty()) ? filter["scheduled_date"] = FILTER.DATERANGE(_scheduled_date,true,true) : null; 
                        (!_origin_id.isEmpty() && _origin_id != "all") ? filter["origin_id"] = _origin_id : null; 
                        (!_destination_id.isEmpty() && _destination_id != "all") ? filter["destination_id"] = _destination_id : null; 
                        (_status != "all") ? filter["status"] = _status : null;
                        if(_region != "all") {
                            filter["region"] = encodeURIComponent(_region);
                            var geofences = LIST["geofences"].filter(x => x.region_id == _region);
                            geofences.forEach(val => {
                                ___origin_id.push(val._id);
                            });
                        }
                        if(_cluster != "all") {
                            filter["cluster"] = encodeURIComponent(_cluster);
                            var geofences = LIST["geofences"].filter(x => x.cluster_id == _cluster);
                            geofences.forEach(val => {
                                ___origin_id.push(val._id);
                            });
                        }
                        (___origin_id.length > 0) ? filter.origin_id = {$in:___origin_id} : null;

                        // var _data_ = {};
                        if(FILTER.STATUS != "reset") {} else {
                            FILTER.STATUS = "new";
                        }

                        USER.filters.dispatch = filter;

                        console.log(USER.filters.dispatch);
                        
                        GET.AJAX({
                            url: `/api/users/${CLIENT.id}/${USER.username}/${USER.username}`,
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8",
                                "Authorization": SESSION_TOKEN
                            },
                            data: JSON.stringify({"filter.dispatch":JSON.stringify(filter)})
                        }, function(docs){
                            console.log("docs",docs);
                        });

                        $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");

                        populateTable();
                    });

                    $(`#clone-btn`).click(function(){
                        filter = {};
                        var clone_posting_date = $(`#clone_posting_date`).val();
                        console.log("clone_posting_date",clone_posting_date);
                        
                        GET.AJAX({
                            url: `/api/dispatch/${CLIENT.id}/${USER.username}/clone/${JSON.stringify({posting_date: FILTER.DATERANGE(clone_posting_date,true,true)})}`,
                            method: "GET",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8",
                                "Authorization": SESSION_TOKEN
                            }
                        }, function(docs){
                            console.log("Clone",docs);
                            $(`#clone-btn`).html(`Apply`).removeClass("disabled");
                        });

                        $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");
                    });
                },
                searchEvent = function(){
                    var searchText = null,
                        origFilter = null,
                        removeSearchResult = false;
                    dt.on('search.dt', function () {
                        if(dt.page.info().recordsDisplay === 0 && dt.search()){
                            if(donePopulate === true){
                                if($(`#search-alert`).html().isEmpty()) {
                                    $(`#search-alert`).html(ALERT.HTML.INFO(`<span id="alert-message">Click <u id="search-btn" style="cursor: pointer;">here</u> to search for Shipment Number: <b id="search-text">${dt.search()}</b> through all records.</span><span id="no-result-message" style="display:none;"></span>`,"m-3",true)).show();
                                    $(`#search-btn`).click(function(){
                                        $(`#search-btn`).css({"pointer-events":"none","color":"#aaadae"});
                                        searchText = dt.search();
                                        // removeSearchResult = false;
                                        origFilter = filter;
                                        filter = {_id:dt.search()};
                                        populateTable(null,true,true,filter);
                                    });
                                } else {
                                    if(searchText === dt.search()){
                                        $(`#alert-message`).hide();
                                        $(`#no-result-message`).html(`No result for Shipment Number: <b id="search-text">${searchText}</b>.`).show();
                                        searchText = null;
                                    } else {
                                        $(`#alert-message`).hide().show();
                                        $(`#no-result-message`).html("").hide();
                                        $(`#search-text`).html(dt.search());
                                    }
                                }
                            }
                        } else {
                            $(`#search-alert`).html("").hide();
                            if(origFilter) {
                                filter = origFilter;
                                origFilter = null;
                            }
                        }
                    });
                };
            __data.for = urlPath;

            
            try {
                filter = JSON.parse(filter);
            } catch (error) {}
            
            LIST[urlPath] = [];
            populateTable(true);
            /******** END TABLE ********/

            $(`#_status`).select2();

            /******** TABLE CHECK ********/
            //,"CUSTOMERS"
            // ,"CUSTOMERS"
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                isFinishedLoading(["REGIONS","CLUSTERS","GEOFENCES","VEHICLES","TRAILERS","CHASSIS","ROUTES","USERS","VEHICLE_PERSONNEL","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE"], _new_, function(){
                    if(dt){
                        _new_ = false;
                        
                        $.each(LIST[urlPath], function(i,val){
                            var rowNode = dt.row(`[_row="${val._row}"]`).node();
                            (rowNode) ? dt.row(rowNode).data(rowData(val)) : null;
                        });
                        TABLE.FINISH_LOADING.UPDATE();
                    }
                    
                });
                isFinishedLoading(["GEOFENCES","VEHICLES","TRAILERS","CHASSIS","ROUTES","VEHICLE_PERSONNEL","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE"], true, function(){
                    TABLE.FINISH_LOADING.UPDATE();
                });
                isFinishedLoading(["REGIONS","CLUSTERS"], _new2_, function(){
                    if(dt){
                        _new2_ = false;
                        var regionOptions = `<option value="all">All</option>`,
                            clusterOptions = `<option value="all">All</option>`;
                        LIST["regions"].forEach(val => {
                            regionOptions += `<option value="${val._id}">${val.code}</option>`;
                        });
                        LIST["clusters"].forEach(val => {
                            clusterOptions += `<option value="${val._id}">${val.cluster}</option>`;
                        });
                        $(`#_region`).html(regionOptions).select2();
                        $(`#_cluster`).html(clusterOptions).select2();
                    }
                });
                isFinishedLoading(["GEOFENCES"], _new3_, function(){
                    if(dt){
                        _new3_ = false;
                        var options = `<option value="all">All</option>`;
                        LIST["geofences"].forEach(val => {
                            options += `<option value="${val._id}">${val.short_name}</option>`;
                        });
                        $(`#_origin_id`).html(options).select2().val(filter.origin_id||"all").trigger("change");
                        $(`#_destination_id`).html(options).select2().val(filter.destination_id||"all").trigger("change");
                    }
                });
            }
            TABLE.FINISH_LOADING.START_CHECK();
            /******** END TABLE CHECK ********/
        },
        form: function(__data){
            console.log("__data",__data)
            var regex = /^\d{8}$/;

            // LOAD SELECT 2 OPTIONS FOR: ORIGIN,DESTINATION,VEHICLES
            getSelect2Options();

            LIST["dispatch"] = LIST["dispatch"] || [];

            var _id = __data._id,
                __status = "",
                __tempStat = null,
                __events_captured = {},
                __originalObj = null,
                originOptions = G_SELECT2["form-geofences"] ,
                vehiclesOptions = G_SELECT2["form-vehicles-admin"],
                trailersOptions = G_SELECT2["form-trailers"],
                routesOptions = G_SELECT2["form-routes"],// LIST["routes"],
                shiftScheduleOptions = G_SELECT2["form-shift_schedule"],
                late_data_entry = null,
                ORIGIN_ID,
                DESTINATION_ID,
                TRAILER,
                disabledSumitButton = false,
                previousCheckInOriginGeofence = null,
                previousCheckInDestinationGeofence = null,
                initialize_buttons = {
                    new: function(){
                        $(`#submit`).text("Submit");
                        $(`#loading-text`).remove();
                    }
                },
                disableFields = function(status){
                    if(status){
                        if(["in_transit"].includes(status)){
                            if(authorizationLevel.administrator()){} 
                            else {
                                $(`#modal input,#modal textarea,#modal select`).attr("disabled",true);
                                $(`#new-destination`).remove();
                                $(`#comments,#new-file`).attr("disabled",false);
                                $(`#modal table > tbody > tr > td input:disabled`).parents("tr").css("background-color","#eee");
                            }
                        }
                    }
                };

            initializeElements();
            
            function initializeElements(){
                var destination_index = 1,
                    checkSelectedVehicleWithinGeofence = function(){
                        return new Promise((resolve,reject) => {
                            var scheduled_date = $(`#scheduled_date`).val(),
                                shift_schedule = $(`#shift_schedule option:selected`).val(),
                                route = ($(`#route`).val()||"")._trim(),
                                vehicle_id = $(`#vehicle_id option:selected`).val();
                            
                            vehicleDoneLoading = false;

                            __tempStat = null;
                            __events_captured = {};
                            late_data_entry = null;

                            $(`#overlay #alert`).html("");
                            
                            var vehicleUsername  = $(`#vehicle_id option:selected`).attr("username");
                            var vehicle_id = $(`#vehicle_id`).val();
                            var geofence =  getGeofence(ORIGIN_ID || $('#origin_id').val()) || {};
                            var geofenceId = geofence.geofence_id;

                            const dGeofence = getGeofence(DESTINATION_ID) || {};
                            $(`#submit`).html(`<i class="la la-spinner la-spin mr-2"></i>Detecting vehicle's location..`).attr("disabled",true);
                            DISPATCH.detectStatus({
                                checkSchedule: true,
                                geofenceId,
                                scheduled_date,
                                shift_schedule,
                                __originalObj,
                                route,
                                previousCheckInOriginGeofence,
                                previousCheckInDestinationGeofence,
                                __status,
                                vehicle: {
                                    _id: vehicle_id,
                                    username: vehicleUsername,
                                },
                                dGeofence: {
                                    short_name: dGeofence.short_name
                                },
                                geofence: {
                                    short_name: geofence.short_name,
                                },
                            }).then(docs => {
                                console.log("Docs",docs);

                                if(docs.error){
                                    reject({
                                        message: docs.message
                                    });
                                } else {
                                    (docs.events_captured) ? __events_captured = docs.events_captured : null;
                                    (docs.late_data_entry) ? late_data_entry = docs.late_data_entry : null;

                                    __tempStat = docs.status || "assigned";

                                    resolve();
                                }
                            });
                        });
                    },
                    checkVehicleInfoAndScheduledDateTime = function(){
                        return new Promise((resolve,reject) => {
                            var scheduled_date = $(`#scheduled_date`).val(),
                                shift_schedule = $(`#shift_schedule option:selected`).val(),
                                vehicle_id = $(`#vehicle_id option:selected`).val(),
                                driver_id = $(`#driver_id option:selected`).val(),
                                checker_id = $(`#checker_id option:selected`).val(),
                                helper_id = $(`#helper_id option:selected`).val();
                            if(CLIENT.id == "wilcon" && vehicle_id && driver_id && scheduled_date && shift_schedule){
                                $(`#modal #alert`).html(`<i class="la la-spin la-spinner font-18 mb-3"></i>`);
                                disabledSumitButton = true;
                                $(`#submit`).attr("disabled",true);
                                var $or = [ // note: array index is important for dispatch router.
                                    { vehicle_id: Number(vehicle_id), },
                                    { driver_id },
                                ];
                                if(checker_id){
                                    $or.push({ checker_id });
                                }
                                if(helper_id){
                                    $or.push({ helper_id });
                                }
                                var filter = {
                                    $and: [
                                        { $or },
                                        { scheduled_date: new Date(scheduled_date).toISOString(), },
                                        { shift_schedule, },
                                        { status: { $nin: ["plan","complete","incomplete"]}, }
                                    ],
                                };
                                $.ajax({
                                    url: `/api/dispatch/${CLIENT.id}/${USER.username}/vehicle_info/${JSON.stringify(filter)}`,
                                    method: "GET",
                                    timeout: 90000, // 1 minute and 30 seconds
                                    headers: {
                                        "Authorization": SESSION_TOKEN
                                    },
                                    async: true
                                }).done(function (docs) {
                                    console.log("docs",docs);
                                    if(docs.length > 0){
                                        var message = [];
                                        // var faults = {};
                                        docs.forEach(val => {
                                            if(val._id != _id){
                                                if(val.vehicle_id == Number(vehicle_id)){
                                                    message.push(`• Truck is already assigned to shipment ${val._id}.`);
                                                }
                                                if(val.driver_id.toString() == driver_id.toString()){
                                                    message.push(`• Driver is already assigned to shipment ${val._id}.`);
                                                }
                                                if(checker_id && val.checker_id.toString() == checker_id.toString()){
                                                    message.push(`• Checker is already assigned to shipment ${val._id}.`);
                                                }
                                                if(helper_id && val.helper_id.toString() == helper_id.toString()){
                                                    message.push(`• Helper is already assigned to shipment ${val._id}.`);
                                                }
                                            }
                                        });
                                        if(message.length > 0){
                                            $(`#modal #alert`).html(ALERT.HTML.ERROR(`<b>Error:</b><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${message.join("<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;")}`,"ml-0 mr-0 mt-0 mb-3"));
                                            $("#modal").animate({ scrollTop: 0 }, "fast");
                                            disabledSumitButton = true;
                                            $(`#submit`).attr("disabled",true);
                                        } else {
                                            $(`#modal #alert`).html("");
                                            $("#modal").animate({ scrollTop: 0 }, "fast");
                                            disabledSumitButton = false;
                                            $(`#submit`).attr("disabled",false);
                                        }
                                    } else {
                                        $(`#modal #alert`).html("");
                                        $("#modal").animate({ scrollTop: 0 }, "fast");
                                        disabledSumitButton = false;
                                        $(`#submit`).attr("disabled",false);
                                    }
                                    resolve();
                                });
                            } else {
                                resolve();
                            }
                        });
                    };

                /******** ORIGIN ********/
                if((clientCustom.defaultOrigin.roles||[]).includes(USER.role)){
                    var origin = getGeofence(clientCustom.defaultOrigin.id);
                    if(origin) $(`#origin`).val(origin.short_name);
                } 
                $(`#origin_id`).html(originOptions).select2({
                    sorter: data => data.sort((a, b) => a.text.localeCompare(b.text)),
                }).val("").on("select2:select", function() {
                    const geofence = getGeofence($(this).val()) || {};
                    $('#origin_code').val(geofence.code || '');
                }).trigger("change");
                /******** END ORIGIN ********/

                /******** SCHEDULED DATE ********/
                var NEXT_DAY = moment(new Date(DEFAULT_DATE)).add(1,"days").format("MM/DD/YYYY");
                $(`#scheduled_date`).daterangepicker({
                    opens: 'left',
                    autoApply: true,
                    singleDatePicker:true,
                    autoUpdateInput: false,
                    minDate: DATETIME.FORMAT(new Date(),"MM/DD/YYYY"),
                    locale: {
                        format: 'MM/DD/YYYY',
                    //   cancelLabel: 'Clear'
                    }
                }, function(start, end, label) { }).on('apply.daterangepicker', function(ev,picker){
                    var formattedDate = moment(new Date(picker.startDate)).format('MM/DD/YYYY');
                    $(this).val(formattedDate);
                    $(this).data('daterangepicker').setStartDate(formattedDate);
                    $(this).data('daterangepicker').setEndDate(formattedDate);
                    $(`#shift_schedule`).attr("disabled",false);

                    if(formattedDate == DEFAULT_DATE){
                        (LIST["shift_schedule"]||[]).forEach(val => {
                            if(withinSchedule(formattedDate,val._id,true)){
                                $(`#shift_schedule option[value="${val._id}"]`).removeAttr("disabled");
                            } else {
                                $(`#shift_schedule option[value="${val._id}"]`).attr("disabled","disabled");
                            }
                        });
                    } else {
                        $(`#shift_schedule option`).removeAttr("disabled");
                    }
                    $(`#shift_schedule`).val("").select2().attr("disabled",false);

                    setDriverChecker($(`#driver_id`).val(),$(`#checker_id`).val(),$(`#helper_id`).val());
                });
                /******** END SCHEDULED DATE ********/

                /******** SHIFT SCHEDULE ********/
                $(`#shift_schedule`).html(shiftScheduleOptions).select2().val("").on("select2:select", function() {
                    // checkSelectedVehicleWithinGeofence();
                    checkVehicleInfoAndScheduledDateTime();
                }).trigger("change").attr("disabled",true);
                /******** END SHIFT SCHEDULE ********/

                /******** TRAILERS ********/
                function truckOrTrailerTableInfo(type,_id){
                    const info = (type == "trailer" ? getTrailer(_id) : getVehicle(_id)) || {};
                    const geofence = getGeofence(info["Site"] || info.site || "","short_name") || {};
                    const region = getRegion(geofence.region_id) || {};
                    const cluster = getCluster(geofence.cluster_id) || {};

                    $(`[${type}-based] td[trailer]`).html(_id || "-");
                    $(`[${type}-based] td[cluster]`).html(cluster.cluster || info["Cluster"] || info.cluster || "-");
                    $(`[${type}-based] td[base]`).html(info["Site"] || info.site || "-");
                    $(`[${type}-based] td[region]`).html(cluster.cluster || info["Region"] || info.region || "-");
                    $(`[${type}-based] td[pallet_type],td[pallet_capacity]`).html(info["Pal Cap"] || info.pal_cap || "-");
                }
                $(`#trailer`).html(trailersOptions).select2().val("").on("select2:select", function() {
                    // checkSelectedVehicleWithinGeofence(7);
                }).change(function(){
                    if($(this).val() != null){
                        TRAILER = $(this).val() || "";
                        truckOrTrailerTableInfo("trailer",TRAILER);
                    }
                }).prop("disabled",true);
                /******** END TRAILERS ********/

                /******** CHASSIS ********/
                $(`#chassis`).html(G_SELECT2["form-chassis"]).select2({
                    matcher: matcher,
                    templateResult: templateResult
                }).val("").on("select2:select", function() {
                    // checkSelectedVehicleWithinGeofence(7);
                }).change(function(){
                    if($(this).val() != null){
                        var chassis = getChassis( $(this).val() || "" ) || {};
                        var type = (getChassisType(chassis.type_id)||{}).type;
                        var section = (getChassisSection(chassis.section_id)||{}).section;
                        var company = (getChassisCompany(chassis.company_id)||{}).company;
                        $(`td[chassis_type]`).html(type || "-");
                        $(`td[section]`).html(section || "-");
                        $(`td[company]`).html(company || "-");
                    }
                }).prop("disabled",true);
                /******** END CHASSIS ********/

                /******** VEHICLES ********/
                var originalVehicle;
                $(`#vehicle_id`).html(vehiclesOptions).select2({
                    matcher: matcher,
                    templateResult: templateResult
                }).val("").on("select2:select", function() {
                    // checkSelectedVehicleWithinGeofence(7);
                }).change(function(){
                    const vehicleId = $(this).val();
                    
                    // disable if vehicleId is empty/null. Enable if has value
                    $(`#trailer,#chassis`).prop("disabled",!vehicleId);

                    var vehicle = getVehicle(vehicleId) || {};
                    var trailer = getTrailer(vehicle.name);
                    var sameVehicleAndTrailer = vehicle.name == vehicle["Trailer"];

                    // Straight Truck
                    if(trailer || sameVehicleAndTrailer) {
                        $(`#trailer,#chassis`).prop("disabled",true);
                        if(clientCustom.editableTrailer) $(`#trailer`).val("Straight Truck").change();
                        $(`td[trailer]`).html("Straight Truck");

                        if(trailer){
                            TRAILER = trailer._id || "";
                            truckOrTrailerTableInfo("trailer",TRAILER);
                        } else {
                            TRAILER = vehicle["Trailer"];
                            truckOrTrailerTableInfo("truck",vehicleId);
                        }

                    } else {
                        trailer = getTrailer(originalVehicle || vehicle["Trailer"]);
                        if(trailer){
                            TRAILER = trailer._id || "";

                            if(clientCustom.editableTrailer) $(`#trailer`).val(TRAILER).change();
                            $(`td[trailer]`).html(TRAILER || "-");

                            truckOrTrailerTableInfo("trailer",TRAILER);
                        } else {
                            trailer = {};
                            truckOrTrailerTableInfo("trailer");
                        }
                    }
                    originalVehicle = null;
                
                    $(`td[conduction_number]`).html(vehicle["Tractor Conduction"] || "-");

                    if($('#trailer').val() == undefined){
                        truckOrTrailerTableInfo("truck",vehicleId);
                    }

                    setDriverChecker();
                    checkVehicleInfoAndScheduledDateTime();
                    previousCheckIns();
                });
                /******** END VEHICLES ********/


                /******** CUSTOMERS ********/
                // $('#customers').html(G_SELECT2['form-customers']).select2({
                //     tokenSeparators: [","],
                //     sorter: data => data.sort((a, b) => a.text.localeCompare(b.text)),
                //     matcher: matcher,
                //     templateResult: templateResult
                // });
                $("#customers").select2({
                    minimumInputLength: 3,
                    tokenSeparators: [","],
                    templateResult: (state) => {
                        var html = $('<span></span>');
                        if(state.number) {
                            html = $(`<div>
                                        <b>${state.name}</b>
                                        <div class="text-muted">${state.number}</div>
                                        <div class="text-muted">${state.region}${state.regionCode ? ` (${state.regionCode})` : ''}</div>
                                        <div class="text-muted">${state.dc}</div>
                                    </div>`)
                        }
                        if(state.loading){
                            html = $('<span>' + state.text + '</span>');
                        }
                        return html;
                    },
                    sorter: data => data.sort((a, b) => a.text.localeCompare(b.text)),
                    ajax: {
                        url: function (params) {
                            return `api/customers/${CLIENT.id}/${USER.username}/keyword/` + params.term;
                        },
                        dataType: 'json',
                        type: "GET",
                        quietMillis: 1000,
                        headers: {
                            "Authorization" : SESSION_TOKEN,
                            "Content-Type" : "application/json",
                        },
                        processResults: function (data, params) {
                            console.log("data",data);
                            return {
                                results: $.map(data, function (item) {
                                    const term = params.term.toLowerCase();
                                    const nameHighlighted = item.name.toLowerCase().replace(term,`<u>${term}</u>`);
                                    const _idHighlighted = item.number.toLowerCase().replace(term,`<u>${term}</u>`);
                                    const region = (getRegion(item.region_id)||{}).name || "Unknown Region";
                                    const regionCode = (getRegion(item.region_id)||{}).code || "";
                                    const dc = (getGeofence(item.dc_id)||{}).short_name || "Unknown DC";

                                    return {
                                        name: nameHighlighted.toUpperCase(),
                                        number: _idHighlighted.toUpperCase(),
                                        region: region,
                                        regionCode: regionCode,
                                        dc: dc,

                                        text: item.name,
                                        id: item._id
                                    }
                                })
                            };
                        },
                    }
                });
                /******** END CUSTOMERS ********/


                /******** PREVIOUS CHECK-INS ********/
                function previousCheckIns(){
                    var vehiclesHistory = getVehicleHistory($("#vehicle_id").val()) || {};
                    
                    $(`#previous-checkins tbody`).html("");
                    $(`[name="checkin"]`).prop("checked",false);
                    previousCheckInOriginGeofence = null;
                    previousCheckInDestinationGeofence = null;

                    var loc = (vehiclesHistory.location||[]);
                    var reversedLoc = [...loc].reverse();
                    var countCheckIns = 0;
                    reversedLoc.forEach((val,i) => {
                        if(countCheckIns < 5) {
                            val.events = val.events || [];
                            var destination = reversedLoc[i-1] || {};
                            var first = null;
                            var last = null;
                            var radioButton = `<input type="radio" disabled>`;
                            var originSelected = getGeofence(ORIGIN_ID);
    
                            val.events.forEach(eVal => {
                                (!first && eVal.RULE_NAME.indexOf("Inside") > -1) ? first = eVal : null; // should be the first eVal
                                last = (eVal.RULE_NAME.indexOf("Outside") > -1) ? eVal : {}; // whatever the last Outside eVal detected
                            });
    
                            if(val.short_name == (originSelected||{}).short_name){
                                countCheckIns ++;
                                radioButton = `<input type="radio" name="checkin" value="${i}">`;
    
                                var tr = $(`<tr>
                                            <td>${radioButton}</td>
                                            <td>${DATETIME.FORMAT((first||{}).timestamp)}</td>
                                            <td>${DATETIME.FORMAT((last||{}).timestamp)}</td>
                                            <td>${val.short_name}</td>
                                            <td>${destination.short_name || "-"}</td>
                                        </tr>`);
                                $(`#previous-checkins tbody`).append(tr);
    
                            
    
                                if(__originalObj && first){
                                    Object.keys((__originalObj.events_captured||{})).forEach(key => {
                                        if(moment(Number(key)).format('HH:mm') === moment(first.timestamp).format('HH:mm')){
                                            $(tr).find(`[name="checkin"]`).prop("checked",true);
                                        }
                                    });
                                }
                            }
                        }
                    });

                    // if($(`[name="checkin"]:checked`).length == 0){
                    //     $($(`[name="checkin"]`).get(0)).prop("checked",true);
                    // }
                    
                    $(`[name="checkin"]`).change(function(){
                        var checked = $(this).prop("checked");

                        if(checked) {
                            var index = $(this).val();
    
                            previousCheckInOriginGeofence = reversedLoc[index];
    
                            var destinationSelected = getGeofence(DESTINATION_ID);
                            var destinationIndex = null;
    
                            for(var i = index-1; i >= 0; i--){
                                // console.log("reversedLoc[i]",i,reversedLoc[i]);
                                if(destinationSelected.short_name == reversedLoc[i].short_name){
                                    destinationIndex = i;
                                    break;
                                }
                            }
                            destinationIndex = (!destinationIndex || destinationIndex < 0) ? (index-1) : destinationIndex;
                            previousCheckInDestinationGeofence = reversedLoc[destinationIndex];
    
                            console.log("INDEX",index);
                            console.log("ORIGIN",previousCheckInOriginGeofence);
                            console.log("destinationIndex",destinationIndex);
                            console.log("DESTINATION",previousCheckInDestinationGeofence);
                        }
                    }).trigger("change");
                }
                /******** END PREVIOUS CHECK-INS ********/
            

                /******** VEHICLE PERSONNEL ********/
                $(`#driver_id,#checker_id,#helper_id`).html("").select2();

                function setDriverChecker(driver_id,checker_id,helper_id){
                    if(CLIENT.id == "wilcon"){
                        var __original = __originalObj || {};
                        /******** VEHICLE PERSONNEL ********/
                        function personnelList(occupation,idType,value){
                            var listHTML = `<option value="">&nbsp;</option>`;
                            var tempList = LIST["vehicle_personnel"].filter(x => x.occupation == occupation);
                            var defaultPersonnel = LIST["vehicle_personnel"].find(x => (x.vehicle_id||"").toString() == $(`#vehicle_id`).val() && $(`#vehicle_id`).val() && x.occupation == occupation) || {};
                            var originalPersonnel = LIST["vehicle_personnel"].find(x => x.name == value || __original[idType]) || {};
                            var unavailablePersonnel = [];
                            
                            tempList.forEach(val => {
                                var dates = val.dates || {};
                                var scheduled_date = new Date($(`#scheduled_date`).val()).toISOString();
                                var arr = [];

                                Object.keys(dates).forEach(key => {
                                    var selectedDates = dates[key] || [];
                                    if(selectedDates.includes(scheduled_date)){
                                        arr.push(vehiclePersonnelCalendarOptions[key].label);
                                    }
                                });
                                var text = (arr.length > 0) ? ` (${arr.join(", ")})` : "";
                                var disabled = (arr.length > 0) ? "disabled" : "";
                                listHTML += `<option value="${val._id}" ${disabled}>${val.name||"No Name"}${text}</option>`;
                                if(arr.length > 0){
                                    unavailablePersonnel.push(val._id);
                                }
                            });
                            var finalPersonnel = "";
                            (unavailablePersonnel.includes(value)) ? null : finalPersonnel = value;
                            (unavailablePersonnel.includes(originalPersonnel._id)) ? null : finalPersonnel = originalPersonnel._id;
                            (unavailablePersonnel.includes(defaultPersonnel._id)) ? null : finalPersonnel = defaultPersonnel._id;
                            $(`#${idType}`).empty().html(listHTML).select2().val(finalPersonnel).on("select2:select", function() {
                                checkVehicleInfoAndScheduledDateTime();
                            }).trigger("change");
                        }
                        personnelList("Driver","driver_id",driver_id);
                        personnelList("Checker","checker_id",checker_id);
                        personnelList("Helper","helper_id",helper_id);
                        /******** END VEHICLE PERSONNEL ********/
                    }
                }
                /******** END VEHICLE PERSONNEL ********/

                /******** ROUTES ********/
                $(`#route`).html(routesOptions).select2({
                    matcher: matcher,
                    templateResult: templateResult
                }).val("").on("select2:select", function() {
                    // checkSelectedVehicleWithinGeofence(7);
                }).change(function(){
                    var route = getRoute($(this).val());
                    if(route){
                        var origin = getGeofence(route.origin_id);
                        var destination = getGeofence(route.destination_id);
                        ORIGIN_ID = origin._id;
                        DESTINATION_ID = destination._id;
                        $(`#origin`).val(`${origin.short_name} (${origin.site_name || "-"})`);
                        $(`[location]`).val(`${destination.short_name} (${destination.site_name || "-"})`);
                    } else {
                        $(`#origin,[location]`).val("");
                        ORIGIN_ID = "";
                        DESTINATION_ID = "";
                    }
                    route_and_transitTime(null,route);
                    previousCheckIns();
                });
                
                if((clientCustom.defaultOrigin.roles||[]).includes(USER.role)){
                    var origin = getGeofence(clientCustom.defaultOrigin.id);
                    $(`#route`).on('select2:open', function (e) {
                        $(".select2-search__field").val(`${origin.short_name},`).focus();
                    });
                }
                /******** END ROUTES ********/

                // should be after all field initializations.
                $(`#scheduled_date`).trigger('apply.daterangepicker',{startDate: NEXT_DAY});

                /******** AUTOFILL ********/
                var id_index = null,
                    has_id = false;
                
                if(_id){
                    $(`.main-content .clearfix`).css({"pointer-events": "none"});
                    $(`#loading-text`).show();
                    has_id = true;
                    id_index = LIST["dispatch"].findIndex(x => x._id == _id);
                    var obj = LIST["dispatch"][id_index];
                    __originalObj = obj;

                    if(!(clientCustom.previousCheckIns.status||[]).includes((__originalObj||{}).status)){
                        $(`#previous-checkins-container`).remove();
                    }
                    
                    if(id_index >= 0){
                        populateDispatchEntry();
                    } else {
                        GET.AJAX({
                            url: `/api/dispatch/${CLIENT.id}/${USER.username}/${_id}`,
                            method: "GET",
                            headers: {
                                "Authorization": SESSION_TOKEN
                            },
                        }, function(docs){
                            $(`.main-content .clearfix`).css({"pointer-events": ""});
                            obj = docs[0];
                            if(obj){
                                __originalObj = obj;
                                populateDispatchEntry();
                            } else {
                                has_id = false;
                                initialize_buttons.new();
                                addNewDestinationRow();	
                                disableFields();
                            }
                        });
                    }
                    function populateDispatchEntry(){
                        $(`#loading-text`).remove();
                        $(`.main-content .clearfix`).css({"pointer-events": ""});

                        __status = obj.status;

                        $.each(obj.destination, function(i,val){
                            addNewDestinationRow(val,obj.route);
                        });

                        originalVehicle = obj.trailer;

                        
                        if(obj.scheduled_date){
                            $(`#scheduled_date`).trigger('apply.daterangepicker',{startDate: obj.scheduled_date});
                        }

                        CUSTOM.FORM.dispatch[CLIENT.id]().forEach(val => {
                            var value = obj[val.key] || val.alternativeValue || "";
                            if(val.dataType == "dateTime"){
                                value = DATETIME.FORMAT(obj[val.key],"MM/DD/YYYY, hh:mm A","");

                                if(val.inputType == "val"){
                                    var date = moment(new Date(obj[val.key])).format("MM/DD/YYYY, hh:mm A");
                                    $(val.id).data('daterangepicker').setStartDate(date);
                                    $(val.id).data('daterangepicker').setEndDate(date);
                                }
                            }
                            if(val.dataType == "date"){
                                value = DATETIME.FORMAT(obj[val.key],"MM/DD/YYYY","");

                                if(val.inputType == "val"){
                                    var date = moment(new Date(obj[val.key])).format("MM/DD/YYYY");
                                    $(val.id).data('daterangepicker').setStartDate(date);
                                    $(val.id).data('daterangepicker').setEndDate(date);
                                }
                            }

                            // set value
                            if(value) {
                                $(val.id)[val.inputType](value);
                                $('[name="'+val.id+'"][value="'+value+'"]').prop("checked",true);
                            }

                            // options
                            if(val.readonly) $(val.id).attr("readonly",val.readonly);
                            if(val.trigger) $(val.id).trigger(val.trigger).trigger("select2:select");
                        });

                        ATTACHMENTS.set(obj.attachments);
                        
                        if(obj.destination.length == 0){
                            addNewDestinationRow();
                        }
                        route_and_transitTime(obj);
                        disableFields(obj.status);
                    }
                } else {
                    $(`#previous-checkins-container`).remove();
                    initialize_buttons.new();
                    addNewDestinationRow();	
                    disableFields();
                }
                /******** END AUTOFILL ********/

                /******** DESTINATION ********/
                $(`#new-destination`).click(function(){
                    addNewDestinationRow();		
                });
                function addNewDestinationRow(data,routeId){
                    data = data || {};
                    (destination_index < 1) ? destination_index = 1 : null;
                    var _row = DISPATCH.FUNCTION.add_row.destination(destination_index,data,routeId);
                    destination_index ++;	
                    $(`[_row="${_row}"] [delete-destination]`).click(function(){
                        $(this).parent().parent().remove();	
                        if($('#tbl-destination > tbody > tr').length > 0){
                            $('#tbl-destination > tbody > tr').each(function(index, tr) {
                                destination_index = index+1; 
                                $(tr).children().eq(0).html(destination_index);
                            });
                            (destination_index > 0) ? destination_index ++ : null;
                        } else {
                            destination_index = 1;
                        }
                        route_and_transitTime();
                    });
                }
                /******** END DESTINATION ********/
                
                /******** ROUTE & TRANSIT TIME ********/
                function route_and_transitTime(obj,route){
                    obj = obj || {};
                    var __r = route || getRoute(obj.route || $(`#route`).val());
                    if(__r){
                        var transit_hh_mm = DATETIME.HH_MM(null,__r.transit_time),
                            destination = getGeofence(__r.destination_id) || {},
                            cico_hh_mm = DATETIME.HH_MM(null,destination.cico)

                        $(`[transit_time]`).html(`${transit_hh_mm.hour} : ${transit_hh_mm.minute}`);
                        $(`[cico]`).html(`${cico_hh_mm.hour} : ${cico_hh_mm.minute}`);
                    } else {
                        $(`[transit_time],[cico]`).html(`<span class="text-muted">HH</span> : <span class="text-muted">MM</span>`);
                    }
                }
                /******** END ROUTE & TRANSIT TIME ********/

                /******** ATTACHMENT ********/
                ATTACHMENTS.initialize();
                /******** END ATTACHMENT ********/

                /******** SUBMIT ENTRY ********/
                $(`#submit`).click(function(){
                    var status = "assigned",
                        // body = {},
                        buttonDefaultText = (!has_id) ? "Submit" : "Update",
                        buttonLoadingText = (!has_id) ? "Submitting.." : "Updating..",
                        button = $(this);
                    
                    $(`#modal-error`).hide();

                    // check if all fields have value
                    var body = {
                        shipment_number: ($(`#shipment_number`).val()||"")._trim(),
                        ticket_number: ($(`#ticket_number`).val()||"")._trim(),
                        scheduled_date: $(`#scheduled_date`).val(),
                        shift_schedule: $(`#shift_schedule option:selected`).val(),
                        origin_id: ORIGIN_ID,
                        route: ($(`#route`).val()||"")._trim(),
                        destination: [{ location_id: DESTINATION_ID }],
                        vehicle_id: Number($(`#vehicle_id option:selected`).val()),
                        trailer: TRAILER,
                        driver_id: $(`#driver_id option:selected`).val(),
                        checker_id: $(`#checker_id option:selected`).val(),
                        helper_id: $(`#helper_id option:selected`).val(),
                        chassis: $(`#chassis option:selected`).val(),
                        comments: ($(`#comments`).val()||"")._trim(),
                        customers: $('#customers').val(),
                        support_unit: $('[name="support_unit"]:checked').val(),
                        shipment_type: $('[name="shipment_type"]:checked').val(),
                        delivery_sequence: $('[name="delivery_sequence"]:checked').val(),
                        mdsd_usage: $('[name="mdsd_usage"]:checked').val(),
                        attachments: ATTACHMENTS.get(CLIENT.dsName),
                        version: VERSION
                    };

                    body.origin_id = (!ORIGIN_ID) ? $(`#origin_id option:selected`).val() : ORIGIN_ID;
                    body.scheduled_date = (body.scheduled_date) ? new Date(body.scheduled_date).toISOString() : null;

                    // delete properties with empty or null values
                    Object.keys(body).forEach(key => { (!body[key]) ? delete body[key] : null; });

                    var invalid = false,
                        errorType = "",
                        vehicleChanged = false,
                        historyOptions = {
                            fields: [
                                {
                                    key: "vehicle_id",
                                    customTitle: "Vehicle",
                                    dataExtended: true,
                                    data: LIST["vehicles"],
                                    dataCompareKey: "_id",
                                    dataValueKey: "name",
                                    customExternalFunction: function(){
                                        vehicleChanged = true;
                                    }
                                },
                                {
                                    key: "origin_id",
                                    customTitle: "Origin",
                                    dataExtended: true,
                                    data: LIST["geofences"],
                                    dataCompareKey: "_id",
                                    dataValueKey: "short_name"
                                },
                                {
                                    key: "driver_id",
                                    customTitle: "Driver",
                                    dataExtended: true,
                                    data: LIST["vehicle_personnel"],
                                    dataCompareKey: "_id",
                                    dataValueKey: "name"
                                },
                                {
                                    key: "checker_id",
                                    customTitle: "Checker",
                                    dataExtended: true,
                                    data: LIST["vehicle_personnel"],
                                    dataCompareKey: "_id",
                                    dataValueKey: "name"
                                },
                                {
                                    key: "helper_id",
                                    customTitle: "Helper",
                                    dataExtended: true,
                                    data: LIST["vehicle_personnel"],
                                    dataCompareKey: "_id",
                                    dataValueKey: "name"
                                },
                                {
                                    key: "scheduled_date",
                                    type: "date",
                                    format: "MMM DD, YYYY"
                                },
                                {
                                    key: "status",
                                    type: "status",
                                },
                                {
                                    key: "late_entry",
                                    type: "bool",
                                },
                                {
                                    key: "destination",
                                    custom: true,
                                    customFunction: function(original,updated){
                                        var __fromDestination = getGeofence(original[0].location_id) || {};
                                        var __toDestination = getGeofence(updated[0].location_id) || {};
                                        var isSame = __fromDestination.short_name == __toDestination.short_name;

                                        return (!isSame) ? `• Destination changed from '${__fromDestination.short_name||""}' to '${__toDestination.short_name||""}'.` : null;
                                    }
                                },
                                {
                                    key: "attachments",
                                    type: "attachments"
                                },
                                {
                                    customTitle: "Delivery For (Customer(s))",
                                    key: "customers",
                                    type: "array"
                                },
                                {
                                    customTitle: "MDSD Usage",
                                    key: "mdsd_usage",
                                },
                            ]
                        };
                        
                    !__data._id ? _id = body.shipment_number : null; 

                    (clientCustom.requiredFields.dispatch||[]).forEach(val => {
                        MODAL.FIELDCHECK(val,body[val], () => { invalid = true; });

                        if(val == "shipment_number" && !regex.test(_id)) 
                            errorType = "invalid-shipment-number";
                    });

                    if(disabledSumitButton === true){
                        $('#modal-error').html(ALERT.HTML.ERROR("Please fill all the required fields.",".")).show();
                        $("#modal").animate({ scrollTop: 0 }, "fast");
                    } else if(errorType == "invalid-shipment-number") {
                        $('#modal-error').html(ALERT.HTML.ERROR("Invalid shipment number indicated. Field should contain eight (8) numerical digit.",".")).show();
                        $("#modal").animate({ scrollTop: 0 }, "fast");
                        $(`#shipment_number`).css({"background-color":"#ffe4e4"});
                    } else {
                        body._id = body.shipment_number;
                        delete body.shipment_number;

                        if(invalid === true) {
                            // warn staut is PLAN
                            MODAL.CONFIRMATION({
                                content: `You have not filled in all of the required fields. This will be saved as <span class="text-info font-bold">PLAN</span><sup style="font-size: 8px;">**</sup> instead. Do you wish to proceed?<span style="font-size: 9px;margin-left: 15px;font-style: italic;" class="d-block text-left mt-5">**Shipments with status <span class="text-info font-bold">PLAN</span> will be ignored during event process.</span>`,
                                confirmCloseCondition: true,
                                confirmButtonText: "Proceed",
                                confirmBGStyle: "background-color:#64b03a;",
                                confirmCallback: function(){
                                    status = "plan";
                                    SUBMITFORM();
                                    $(`#confirm-modal`).remove(); 
                                }
                            });
                        } else {
                            if(body.shipment_type == "Pick-up"){
                                // ignore check vehicle
                                body.late_entry = false;
                                (__status) ? status = __status : null;

                                SUBMITFORM();
                            } else {
                                checkSelectedVehicleWithinGeofence().then(() => {
                                    body.late_entry = late_data_entry;
                                    
                                    (__tempStat) ? __status = __tempStat : null;
                                    (__status && __status != "plan") ? status = __status : null;
    
                                    SUBMITFORM();
    
                                }).catch(error => {
                                    console.log(error);
                                    $('#modal-error').html(ALERT.HTML.ERROR(error.message,".")).show();
                                    $("#modal").animate({ scrollTop: 0 }, "fast");
                                    $(`#submit`).html('Submit').attr("disabled",false);
                                });
                            }
                        } 
                    }

                    function SUBMITFORM(){
                        var url = `/api/dispatch/${CLIENT.id}/${USER.username}`,
                            method = "POST";

                        body.status = status;
                    
                        // wilcon
                        if(body.scheduled_date && !withinSchedule(body.scheduled_date,body.shift_schedule)){
                            if(status != "plan"){
                                status = "scheduled";
                                body.status = status;
                            }
                        }
                        // end wilcon

                        // check for difference (if update only)
                        var selectedCheckIn = false;
                        historyOptions.excludeKeys = ["events_captured"];
                        historyOptions.customChanges = [
                            function(){
                                var message = null;
                                if(previousCheckInOriginGeofence || previousCheckInDestinationGeofence){
                                    if(__originalObj){
                                        var found = false;
                                        Object.keys((__originalObj.events_captured||{})).forEach(key => {
                                            if(moment(Number(key)).format('HH:mm:ss') === moment(previousCheckInOriginGeofence.events[0].timestamp).format('HH:mm:ss')){
                                                found = true;
                                            }
                                        });
                                        if(found == true){
                                            message = null;
                                        } else {
                                            var checkinTime = DATETIME.FORMAT(previousCheckInOriginGeofence.events[0].timestamp);
                                            message = `Selected <u>${checkinTime}</u> check-in date & time.`;
                                            selectedCheckIn = true;
                                        }
                                    } else {
                                        message = null;
                                    }
                                } else {
                                    message = null;
                                }
                                return message;
                            } 
                        ];

                        body = HISTORY.check(__originalObj,body,USER.username,historyOptions);
                        body.selectedCheckIn = selectedCheckIn;

                        var changesKey = false;
                        Object.keys(body).forEach(key => {
                            (key.indexOf("history.") > -1 ) ? changesKey = key : null;
                        });

                        if(__originalObj){
                            if(__originalObj.route != body.route || Number(__originalObj.vehicle_id) != Number(body.vehicle_id) || previousCheckInOriginGeofence || previousCheckInDestinationGeofence){
                                body.events_captured = __events_captured;
                            } else {
                                body.events_captured = __originalObj.events_captured;
                            }
                        } else {
                            body.events_captured = __events_captured;
                        }
                        
                        if(changesKey && !["plan"].includes(__originalObj.status) ) {// can make, if no hisotry, submit button will remain disabled..
                            MODAL.CONFIRMATION_W_FIELD({
                                content: `Please provide a reason for updating this entry.`,
                                confirmCloseCondition: true,
                                confirmButtonText: "Submit",
                                cancelButtonText: "Cancel",
                                confirmCallback: function(field_val){
                                    body[changesKey] += `<br><br>Reason for update: ${field_val.bold()}`;
                                    _submit_();
                                },
                                cancelCallback: function(){
                                    $(`#submit`).html(`Submit`).attr("disabled",false);
                                }
                            });
                        } else {
                            _submit_();
                        }
                        // end check for difference (if update only)

                        function _submit_(){
                            $(`.main-content .clearfix`).css({"pointer-events": "none"});
                            $(button).html(`<i class="la la-spinner la-spin mr-2"></i>${buttonLoadingText}`).attr("disabled",true);

                            if(has_id === true){
                                url = `/api/dispatch/${CLIENT.id}/${USER.username}/${_id}`;
                                method = "PUT";
                            } else {
                                if(CLIENT.id != "wilcon"){
                                    body = $.extend(body,{_id});
                                }
                            }
                            
                            if(body.late_entry === true){
                                var inTransitKey = OBJECT.getKeyByValue(__events_captured, body.status);
                                var date =  (inTransitKey) ? new Date(Number(inTransitKey)) : new Date();
                                
                                body.departure_date = date.toISOString();

                                if(!inTransitKey){
                                    body.events_captured[date.getTime()] = body.status;
                                    body.events_captured = OBJECT.sortByKey(body.events_captured);
                                }

                                if(body.route){
                                    body.destination[0].etd = date.toISOString();

                                    var _route = getRoute(body.route);
                                    var transit_time = DATETIME.HH_MM(null,_route.transit_time);
                                    var hours = transit_time.hour;
                                    var minutes = transit_time.minute;
                            
                                    (hours)?date.setHours(date.getHours() + Number(hours)):null;
                                    (minutes)?date.setMinutes(date.getMinutes() + Number(minutes)):null;
                                    
                                    body.destination[0].eta = date.toISOString();
                                }
                            }
                            body.vehicleChanged = vehicleChanged;
                            GET.AJAX({
                                url,
                                method,
                                headers: {
                                    "Content-Type": "application/json; charset=utf-8",
                                    "Authorization": SESSION_TOKEN
                                },
                                data: JSON.stringify(body)
                            }, function(docs){
                                $(`#confirm-modal,#overlay`).remove(); 
                                if(docs.ok == 1){
                                    console.log(docs);
                                    var message,sticky = false;
                                    if(clientCustom.autoGeneratedId === true){
                                        message = `<br>Shipment Number: <b>${docs.sequence}</b>`;
                                        sticky = true;
                                    }
                                    (method == "PUT") ? TOASTR.UPDATEDSUCCESSFULLY() : TOASTR.CREATEDSUCCESSFULLY(message,sticky);
                                    $(`.main-content .clearfix`).css({"pointer-events": ""});
                                    $(`#overlay`).remove();
                                } else {
                                    console.log(docs.error);
                                    $(button).html(buttonDefaultText).attr("disabled",false);
                                    $(`.main-content .clearfix`).css({"pointer-events": ""});
                                    TOASTR.ERROR({statusText:"Shipment # already exists."},`<br><br><a id="toastr-link" href="javascript:void(0);">Click here to Load Existing Entry</a><br><br>or Tap anywhere to close`,{ timeOut: 0, extendedTimeOut: 0 });
                                    $("body").on('click', `#toastr-link`,function(e){
                                        e.stopImmediatePropagation();
                                        // do not use _id or shipment_number for value of {_id:...}. It will use the previous form ID.
                                        // should also be before body.append.
                                        var __id = ($(`#shipment_number`).val()||"")._trim();
                                        $(`#overlay`).remove();
                                        $(`body`).append(MODAL.CREATE.EMPTY(`View Dispatch Entry`,modalViews.dispatch.form[CLIENT.id]()));
                                        DISPATCH.FUNCTION.form({ _id: __id });
                                        $("html, body,#modal").animate({ scrollTop: 0 }, "fast");
                                    });
                                }
                            },function(error){
                                console.log(error);
                                $(button).html(buttonDefaultText).attr("disabled",false);
                                $(`.main-content .clearfix`).css({"pointer-events": ""});
                                if(error.status == 409){
                                    TOASTR.ERROR({statusText:"Shipment # already exists."},`<br><br><a id="toastr-link" href="javascript:void(0);">Click here to Load Existing Entry</a><br><br>or Tap anywhere to close`,{ timeOut: 0, extendedTimeOut: 0 });
                                    $("body").on('click', `#toastr-link`,function(e){
                                        e.stopImmediatePropagation();
                                        // do not use _id or shipment_number for value of {_id:...}. It will use the previous form ID.
                                        // should also be before body.append.
                                        var __id = ($(`#shipment_number`).val()||"")._trim();
                                        $(`#overlay`).remove();
                                        $(`body`).append(MODAL.CREATE.EMPTY(`View Dispatch Entry`,modalViews.dispatch.form[CLIENT.id]()));
                                        DISPATCH.FUNCTION.form({ _id: __id });
                                        $("html, body,#modal").animate({ scrollTop: 0 }, "fast");
                                    });
                                } else {
                                    TOASTR.ERROR(error.responseJSON);
                                }
                            });
                        }
                    }
                });
                /******** END SUBMIT ENTRY ********/
            }
        },
        status: function(_id){
            $("html, body").animate({ scrollTop: 0 }, "fast");

            if(_id != null){
                var obj = LIST["dispatch"].find(x => x._id.toString() == _id.toString());
                if(obj){
                    // check if shipment data is complete
                    obj.destination[0] = obj.destination[0] || {};

                    var allRequiredFields = true;
                    (clientCustom.requiredFields.dispatch||[]).forEach(val => {
                        (val == "shipment_number") ? val = "_id" : null;
                        (!obj[val]) ? allRequiredFields = false : null;
                    });

                    $(`[status]`).removeClass("active disabled").addClass("inactive");
                    $(`[status="${obj.status}"]`).removeClass("inactive").addClass("active");

                    if(allRequiredFields === true){
                        var allowedButtons = `[status=assigned]`,
                            statusSelector = function(arr){
                                var newArr = [];
                                arr.forEach(stat => {
                                    newArr.push(`[status=${stat}]`);
                                });
                                return newArr.join(",");
                            };
                        
                        $(`[status]`).addClass("disabled");

                        if(["plan"].includes(obj.status)){
                            allowedButtons = statusSelector([obj.status,"assigned"]);
                        } else if(["assigned"].includes(obj.status)){
                            allowedButtons = statusSelector([obj.status,"plan","dispatched","queueingAtOrigin","processingAtOrigin","idlingAtOrigin","in_transit","incomplete"]);
                        } else if(["dispatched"].includes(obj.status)){
                            allowedButtons = statusSelector([obj.status,"plan","assigned","onDelivery","incomplete"]);
                        } else if(["queueingAtOrigin"].includes(obj.status)){
                            allowedButtons = statusSelector([obj.status,"plan","assigned","processingAtOrigin","idlingAtOrigin","in_transit","incomplete"]);
                        } else if(["processingAtOrigin"].includes(obj.status)){
                            allowedButtons = statusSelector([obj.status,"plan","assigned","queueingAtOrigin","idlingAtOrigin","in_transit","incomplete"]);
                        } else if(["idlingAtOrigin"].includes(obj.status)){
                            allowedButtons = statusSelector([obj.status,"plan","assigned","queueingAtOrigin","processingAtOrigin","in_transit","incomplete"]);
                        } else if(["in_transit"].includes(obj.status)){
                            allowedButtons = statusSelector([obj.status,"plan","assigned","queueingAtOrigin","processingAtOrigin","idlingAtOrigin","onSite","complete","incomplete"]);
                        } else if(["onDelivery"].includes(obj.status)){
                            allowedButtons = statusSelector([obj.status,"plan","assigned","dispatched","complete","incomplete"]);
                        } else if(["onSite"].includes(obj.status)){
                            allowedButtons = statusSelector([obj.status,"plan","assigned","queueingAtOrigin","processingAtOrigin","idlingAtOrigin","in_transit","returning","incomplete"]);
                        } else if(["returning"].includes(obj.status)){
                            allowedButtons = statusSelector([obj.status,"plan","assigned","queueingAtOrigin","processingAtOrigin","idlingAtOrigin","in_transit","onSite","complete","incomplete"]);
                        } else if(["incomplete"].includes(obj.status)){
                            allowedButtons = statusSelector([obj.status,"plan","assigned","queueingAtOrigin","processingAtOrigin","idlingAtOrigin","in_transit","onSite","returning","complete","incomplete"]);
                        }

                        $(allowedButtons).click(function(){
                            var new_status = $(this).attr("status");
                            var route = getRoute(obj.route);
                            if(obj.status == "incomplete" && new_status != obj.status){
                                MODAL.CONFIRMATION_W_FIELD({
                                    content: `You are about to change the status of this entry from Incomplete to ${GET.STATUS(new_status).text}. Please indicate your reason/s below.`,
                                    confirmCloseCondition: true,
                                    confirmButtonText: "Submit",
                                    cancelButtonText: "Cancel",
                                    confirmCallback: function(field_val){
                                        GET.AJAX({
                                            url: `/api/dispatch/${CLIENT.id}/${USER.username}/status/${_id}`,
                                            method: "PUT",
                                            headers: {
                                                "Content-Type": "application/json; charset=utf-8",
                                                "Authorization": SESSION_TOKEN
                                            },
                                            data: JSON.stringify({ status: new_status, i_c_reason: field_val || "", transit_time: (route||{}).transit_time, statusText: GET.STATUS(new_status).text })
                                        }, function(docs){
                                            if(docs.ok == 1){
                                                $(`#confirm-modal,#overlay`).remove(); 
                                                TOASTR.UPDATEDSUCCESSFULLY();
                                            } else {
                                                $(`#confirm-modal`).remove();
                                                toastr.error("Something went wrong</br></br>Error Code - ec005/03");
                                            }
                                        });
                                    }
                                });
                            } else {
                                MODAL.CONFIRMATION({
                                    content: `Are you sure you want to update the status?`,
                                    confirmCloseCondition: true,
                                    confirmCallback: function(){
                                        GET.AJAX({
                                            url: `/api/dispatch/${CLIENT.id}/${USER.username}/status/${_id}`,
                                            method: "PUT",
                                            headers: {
                                                "Content-Type": "application/json; charset=utf-8",
                                                "Authorization": SESSION_TOKEN
                                            },
                                            data: JSON.stringify({ status: new_status, transit_time: (route||{}).transit_time })
                                        }, function(docs){
                                            if(docs.ok == 1){
                                                $(`#confirm-modal,#overlay`).remove(); 
                                                TOASTR.UPDATEDSUCCESSFULLY();
                                            } else {
                                                $(`#confirm-modal`).remove();
                                                toastr.error("Something went wrong</br></br>Error Code - ec005/03");
                                            }
                                        });
                                    }
                                });
                            }
                        }).removeClass("disabled");
                    } else {
                        $(`#incomplete-data`).text("Unable to update status if shipment data is incomplete.");
                        $(`[status]`).addClass("disabled");
                        $(`[status=${obj.status}]`).removeClass("disabled");
                    }
                } else {
                    toastr.error("Something went wrong</br></br>Error Code - ec005/01");
                }
            } else {
                toastr.error("Something went wrong</br></br>Error Code - ec005/02");
            }
        },
        history: function(history={}){
            var str = "";
            var paddingTop = "pt-3";
                
            const original = history.original;
            
            const sorted = OBJECT.sortByKey(history);
            const ordered = {};
            Object.keys(sorted).reverse().forEach(function(key) {
                ordered[key] = history[key];
            });
            
            Object.keys(ordered).forEach(key => {
                if(!["original","vehicle"].includes(key)){
                    var _key = DATETIME.FORMAT(new Date(Number(key)),"MMM D, YYYY, h:mm A"),
                        _desc = ordered[key] || "-";
                        
                    if(_desc.indexOf("System - Status updated") > -1){
                        // ' -> old setup. Do not remove.
                        var status = GET.TEXT_BETWEEN(_desc,"<status>","</status>") || GET.TEXT_BETWEEN(_desc,"'","'");
                        str += ` <div class="${paddingTop}">
                                    <small class="text-muted">${_key}</small>
                                    <div>Status updated to ${GET.STATUS(status).html}</div>
                                </div>`;
                    } else if(_desc.indexOf("Manual - Status updated") > -1){
                        var status = GET.TEXT_BETWEEN(_desc,"<status>","</status>") || GET.TEXT_BETWEEN(_desc,"'","'");
                        var username = GET.TEXT_BETWEEN(_desc,"<username>","</username>");
                        var user = getUser(username) || {};
                        str += ` <div class="${paddingTop}">
                                    <small class="text-muted">${_key}</small>
                                    <div>Status manually updated to ${GET.STATUS(status).html} by ${user.name||username||"-"}.</div>
                                </div>`;
                    } else {
                        var status = GET.TEXT_BETWEEN(_desc,"<status>","</status>");
                        var username = GET.TEXT_BETWEEN(_desc,"<username>","</username>");
                        var user = getUser(username) || {};
                        if(status){
                            _desc = _desc.replace(`<status>${status}</status>`,GET.STATUS(status).html);
                        }
                        if(user.name){
                            _desc = _desc.replace(`<username>${username}</username>`,user.name||username);
                        }

                        str += ` <div class="${paddingTop}">
                                    <small class="text-muted">${_key}</small>
                                    <div>${_desc}</div>
                                </div>`;
                    }
                }              
            });
            if(original){
                var _obj = JSON.parse(original);
                console.log("_obj",_obj);
                str += ` <div class="${paddingTop}">
                            <small class="text-muted">${DATETIME.FORMAT(new Date(_obj.posting_date),"MMM D, YYYY, h:mm A")}</small>
                            <div>Entry posted with status ${GET.STATUS(_obj.status).html}</div>
                        </div>`;
            } 
            return str;
        },
        import: function(){
            $(`#download-template-btn`).click(function(){
                if(CLIENT.id == "wilcon"){
                    if(GGS.STATUS.SHIFT_SCHEDULE && GGS.STATUS.VEHICLES && GGS.STATUS.ROUTES) {
                        $(`body`).append(CUSTOM.IMPORT_TEMPLATE.dispatch.wilcon());
                        exportTableToExcel("Wilcon Import Template");
                    } else {
                        toastr.info("Data is still loading. Please try again in few seconds.");
                    }
                }
                if(CLIENT.id == "coket1"){
                    $(`body`).append(CUSTOM.IMPORT_TEMPLATE.dispatch.coket1());
                    exportTableToExcel("CokeT1 Import Template");
                }
                $(`#report-hidden,#temp-link,[data-SheetName]`).remove();
            });


            var fileExtension = ["xls","xlsx","ods"];
            $('.dropify').dropify();
            $(`.dropify`).change(function(){
                $(`[success_count],[error_count]`).html(0);
                $(`[error_list],[warning_list]`).html("");
                $(`#reportDL`).hide();
            });
            $(`#import-btn`).click(function(){
                $(this).html(`<i class="la la-spinner la-spin mr-2"></i>Import`).attr("disabled",true);
                $(`.dropify-wrapper`).css("pointer-events","none");
                _read(`.dropify`);
            });


            var dayOffLabel = Object.keys(vehiclePersonnelCalendarOptions).map(i => vehiclePersonnelCalendarOptions[i].label).join("/");
            var requiredFields = {
                coket1: [
                    { name: "Shipment Number", key: "_id", required: true, identifier: true },
                    { name: "Origin", required: true, error: ["Origin does not exist in database."] },
                    { name: "Destination", required: true, error: ["Destination does not exist in database."] },
                    { name: "Truck Name", required: true, error: ["Truck Name does not exist in database."] },
                    { name: "Comments", key: "comments", required: false },
                ],
                wilcon: [
                    { name: "Scheduled Date", required: true, codependent: "Shift Schedule", error: ["Scheduled Date entered is not a valid date.","Scheduled Date is before current date/time."] },
                    { name: "Shift Schedule", required: true, codependent: "Scheduled Date", error: ["Shift Schedule is before current date/time.","Shift Schedule does not exist in database."] },
                    { name: "Ticket Number", key: "ticket_number", required: true },
                    { name: "Route", required: true, error: ["Route does not exist in database."] },
                    { name: "Truck Name", required: true, error: ["Truck Name does not exist in database."] },
                    { name: "Driver", required: true, error: ["Driver's Name does not exist in database.","Selected Driver is on "+dayOffLabel+"."] },
                    { name: "Checker", error: ["Checker's Name does not exist in database.","Selected Checker is on "+dayOffLabel+"."] },
                    { name: "Helper", error: ["Helper's Name does not exist in database.","Selected Helper is on "+dayOffLabel+"."] },
                    { name: "Comments", key: "comments", required: false },
                ],
            },
            identifierKey = (requiredFields[CLIENT.id].find(x => x.identifier === true)||{}).name;
            
            function _read(el){
                var ext = $(el).val().split('.').pop().toLowerCase();
                
                console.log(fileExtension,ext);
                if(fileExtension.includes(ext) == true){
                    var reader = new FileReader();
                    reader.onload = function () {
                        var result = reader.result;
                        // console.log(result);
                        var workbook = XLSX.read(result, { type: 'binary' }),
                            XL_row_object = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[workbook.SheetNames[0]],{defval: ""}),
                            finalRowObject = [];

                        $.each(XL_row_object, function(key,value){
                            // XL_row_object[key].key = GENERATE.RANDOM(36);
                            var hasValue = false;
                            requiredFields[CLIENT.id].forEach(_val_ => {
                                if(XL_row_object[key][_val_.name]){
                                    hasValue = true;
                                }
                            });
                            if(hasValue === true){
                                finalRowObject.push(XL_row_object[key]);
                            }
                        });
                        console.log("finalRowObject",finalRowObject)
                        // requiredFields[CLIENT.id].forEach(_val_ => {
                        checkData(finalRowObject,$(el)[0].files[0].name);
                    };
                    // start reading the file. When it is done, calls the onload event defined above.
                    ($(el)[0].files.length > 0) ? reader.readAsBinaryString($(el)[0].files[0]) : console.log("No file selected.");
                } else {
                    toastr.error(`Only ${fileExtension.join(", ")} files are allowed.`);
                    
                    $(`#import-btn`).html(`Import`).attr("disabled",false);
                    $(`.dropify-wrapper`).css("pointer-events","");
                    $(`.dropify-clear`).click();
                }
            }
            function checkData(import_data,filename){
                var errorList = {},
                    warningList = {},
                    totalRows = import_data.length,
                    snList = [],
                    batchedData = [],
                    importData = [],
                    finalImportData = import_data,
                    fixDate = function(str){ // do not delete yet. might be useful
                        str = str._trim();
                        
                        var final = "",
                            index = 0,
                            arr = str.split(""),
                            _charAt = ["number","number","/","number","number","/","number","number","number","number","space","number","number",":","number","number",":","number","number","space","AM/PM/am/pm"];

                        alignDateWithFormat();
                        function alignDateWithFormat(){
                            $.each(_charAt, function(i, format) { 
                                index = i;
                                if(format == "number"){
                                    if(isNaN(Number(arr[i]))){
                                        if(arr[i-1] == ":" || arr[i-1] == "/"){
                                            arr.insert(i,"0");
                                        } else {
                                            arr.insert(i-1,"0");
                                        }
                                        return false;
                                    }
                                } else if(format == "space"){
                                    if(arr[i] != " "){
                                        arr.insert(i," ");
                                        return false;
                                    }
                                } else if(format == "/"){
                                    if(arr[i] != format){
                                        arr.insert(i,"/");
                                        return false;
                                    }
                                } else if(format == ":"){
                                    if(arr[i] != format){
                                        arr.insert(i,":");
                                        return false;
                                    }
                                }  else if(format == "AM/PM/am/pm"){
                                    if(format.indexOf(arr[i]) == -1){
                                        arr.insert(i,"AM");
                                        return false;
                                    }
                                }
                            });
                            if(index >= _charAt.length-1) {
                                var new_date = arr.join("");
                                new_date = new_date._trim();
                                final = Date.parse(new_date);
                            } else {
                                alignDateWithFormat();
                            }
                        }
                        return final;
                    },
                    parseDateExcel = (excelTimestamp) => {
                        const secondsInDay = 24 * 60 * 60;
                        const excelEpoch = new Date(1899, 11, 31);
                        const excelEpochAsUnixTimestamp = excelEpoch.getTime();
                        const missingLeapYearDay = secondsInDay * 1000;
                        const delta = excelEpochAsUnixTimestamp - missingLeapYearDay;
                        const excelTimestampAsUnixTimestamp = excelTimestamp * secondsInDay * 1000;
                        const parsed = excelTimestampAsUnixTimestamp + delta;
                        return isNaN(parsed) ? null : parsed;
                    };
                
                if(import_data.length > 0){
                    var count = 0;
                    import_data.forEach((val,i) => {
                        var origin = getGeofence(val["Origin"],"short_name"),
                            destination = getGeofence(val["Destination"],"short_name"),
                            route = getRoute(val["Route"]),
                            vehicle = getVehicle(val["Truck Name"],"name"),
                            driver = (LIST["vehicle_personnel"]||[]).find(x => x.name.toString() == val["Driver"].toString() && x.occupation == "Driver"),
                            checker = (LIST["vehicle_personnel"]||[]).find(x => x.name.toString() == val["Checker"].toString() && x.occupation == "Checker"),
                            helper = (LIST["vehicle_personnel"]||[]).find(x => x.name.toString() == val["Helper"].toString() && x.occupation == "Helper"),
                            scheduled_date = DATETIME.FORMAT(parseDateExcel(val["Scheduled Date"]),"MM/DD/YYYY"),
                            shift_schedule = getShiftSchedule(val["Shift Schedule"]),
                            errorShipment = false;

                        function isDayOff(dates){
                            var dayOff = false;
                            var momentScheduledDate = moment(scheduled_date, 'MM/DD/YYYY', true);
                            console.log(momentScheduledDate.isValid(),scheduled_date,dates);
                            if(momentScheduledDate.isValid()){
                                var scheduled_dateISO = new Date(scheduled_date).toISOString();
        
                                Object.keys(dates).forEach(key => {
                                    var selectedDates = dates[key] || [];
                                    if(selectedDates.includes(scheduled_dateISO)){
                                        dayOff = true;
                                    }
                                });
                            }
                            return dayOff;
                        }
                        
                        isDayOff((driver||{}).dates || {}) ? driver = null : null;
                        isDayOff((checker||{}).dates || {}) ? checker = null : null;
                        isDayOff((helper||{}).dates || {}) ? helper = null : null;

                        var checkIfDone = function(){
                                if(count == import_data.length){
                                    FETCH();
                                }
                            },
                            obj = {
                                origin_id: "",
                                route: "",
                                destination: [{}],
                                vehicle_id: 0,
                                username: USER.username,
                                status: "assigned",
                                posting_date: new Date().toISOString(),
                                late_entry: false,
                                driver_id: "",
                                checker_id: "",
                                helper_id: "",
                                events_captured: {}
                            },
                            addToNoteList = function(text,causes,key,type,isField){
                                key = key || (Number(val.__rowNum__) + 1);
                                if(type == "error"){
                                    var causesHTML = (causes) ? `<ul level=2><li>${causes.join("</li><li>")}</li></ul>` : "";
                                    (errorList[key]) ? errorList[key].push(text+causesHTML) : errorList[key] = [(text+causesHTML)];
                                    // (errorList[key]) ? errorList[key].push(text) : errorList[key] = [text];
                                    errorShipment = true;
                                } 
                                if(type == "warning"){
                                    var causesHTML = (causes) ? `<ul level=2><li>${causes.join("</li><li>")}</li></ul>` : "";
                                    text = (isField === true) ? `<small class="text-muted">[FIELD NOT SAVED]</small> ${text}` : text;
                                    (warningList[key]) ? warningList[key].push(text+causesHTML) : warningList[key] = [(text+causesHTML)];
                                }
                                obj.status = "plan";
                            },
                            checkSelectedVehicleWithinGeofence = function(){
                                return new Promise((resolve,reject) => {
                                    if(["plan","scheduled"].includes(obj.status)) {
                                        resolve();
                                    } else {

                                        DISPATCH.detectStatus({
                                            geofenceId: origin.geofence_id,
                                            scheduled_date,
                                            shift_schedule,
                                            route,
                                            __status: obj.status,
                                            vehicle: {
                                                _id: vehicle._id,
                                                username: vehicle.username,
                                            },
                                            dGeofence: {
                                                short_name: destination.short_name
                                            },
                                            geofence: {
                                                short_name: origin.short_name,
                                            },
                                        }).then(docs => {
                                            console.log("docs!!",docs);

                                            if(docs.error){
                                                reject({
                                                    message: docs.message
                                                });
                                            } else {
                                                (docs.events_captured) ? obj.events_captured = docs.events_captured : null;
                                                (docs.late_data_entry) ? obj.late_data_entry = docs.late_data_entry : null;
                                                
                                                obj.status = docs.status || "assigned";

                                                resolve();
                                            }
                                        });
                                    }
                                });
                            },
                            checkVehicleInfoAndScheduledDateTime = function(){
                                return new Promise((resolve,reject) => {
                                    console.log("scheduled_date",scheduled_date)
                                    if(CLIENT.id == "wilcon" && vehicle && driver && scheduled_date && shift_schedule && scheduled_date != "-"){
                                        var $or = [ // note: array index is important for dispatch router.
                                            { vehicle_id: Number(vehicle._id), },
                                            { driver_id: driver._id },
                                        ];
                                        if(checker){
                                            $or.push( { checker_id: checker._id } );
                                        }
                                        if(helper){
                                            $or.push( { helper_id: helper._id } );
                                        }
                                        var filter = {
                                            $and: [
                                                { $or },
                                                { scheduled_date: new Date(scheduled_date).toISOString(), },
                                                { shift_schedule: shift_schedule._id, },
                                                { status: { $nin: ["plan","complete","incomplete"]}, }
                                            ],
                                        };
                                        $.ajax({
                                            url: `/api/dispatch/${CLIENT.id}/${USER.username}/vehicle_info/${JSON.stringify(filter)}`,
                                            method: "GET",
                                            timeout: 90000, // 1 minute and 30 seconds
                                            headers: {
                                                "Authorization": SESSION_TOKEN
                                            },
                                            async: true
                                        }).done(function (docs) {
                                            console.log("docs",docs);
                                            if(docs.length > 0){
                                                var message = [];
                                                docs.forEach(val => {
                                                    if(val.vehicle_id == Number(vehicle._id)){
                                                        message.push(`Truck is already assigned to shipment # ${val._id}.`);
                                                    }
                                                    if(val.driver_id.toString() == driver._id.toString()){
                                                        message.push(`Driver is already assigned to shipment # ${val._id}.`);
                                                    }
                                                    if(checker && val.checker_id.toString() == checker._id.toString()){
                                                        message.push(`Checker is already assigned to shipment # ${val._id}.`);
                                                    }
                                                    if(helper && val.helper_id.toString() == helper._id.toString()){
                                                        message.push(`Helper is already assigned to shipment # ${val._id}.`);
                                                    }
                                                });
                                                if(message.length > 0){
                                                    addToNoteList(`<b>Error:</b><br><ul level=2><li>${message.join("</li><li>")}</li></ul>`,null,val[identifierKey],"error");
                                                }
                                            }
                                            resolve();
                                        });
                                    } else {
                                        resolve();
                                    }
                                });
                            };
                            
                        if((val[identifierKey]||val.__rowNum__).toString()._trim()){
                            requiredFields[CLIENT.id].forEach(_val_ => {
                                if(val[_val_.name].toString()._trim()){
                                    // okay
                                    if(_val_.key){
                                        obj[_val_.key] = val[_val_.name].toString()._trim();
                                    } else {
                                        checkkkkk(_val_.name,_val_.error);
                                    }
                                } else {
                                    if(_val_.required === true){
                                        // error
                                        addToNoteList(`Missing data in '${_val_.name}'. `,null,val[identifierKey],"warning");
                                    } else {
                                        if(_val_.codependent){
                                            if(val[_val_.codependent]){
                                                // error
                                                addToNoteList(`Missing data in '${_val_.name}'. `,null,val[identifierKey],"warning");
                                            } else {
                                                // okay. no error
                                                obj[_val_.key] = "";
                                            }
                                        }
                                    }
                                }
                            });
                            
                            // make checkVehicleInfoAndScheduledDateTime() first because status might be "PLAN" if same driver/checker/vehicle etc.
                            checkVehicleInfoAndScheduledDateTime().then(function(){
                                checkSelectedVehicleWithinGeofence().then(function(){
                                    console.log("importData",importData);
                                    var message = [];
                                    importData.forEach(_val => {
                                        if(_val.status != "plan"){
                                            if(_val.scheduled_date == obj.scheduled_date && _val.shift_schedule == obj.shift_schedule) {
                                                if(Number(_val.vehicle_id) == Number(obj.vehicle_id)){
                                                    message.push(`Truck is already assigned to ROW #: ${Number(_val.__rowNum__)+1}.`);
                                                }
                                                if(obj.driver_id && (_val.driver_id||"").toString() == (obj.driver_id||"").toString()){
                                                    message.push(`Driver is already assigned to ROW #: ${Number(_val.__rowNum__)+1}.`);
                                                }
                                                if(obj.checker_id && (_val.checker_id||"").toString() == (obj.checker_id||"").toString()){
                                                    message.push(`Checker is already assigned to ROW #: ${Number(_val.__rowNum__)+1}.`);
                                                }
                                                if(obj.helper_id && (_val.helper_id||"").toString() == (obj.helper_id||"").toString()){
                                                    message.push(`Helper is already assigned to ROW #: ${Number(_val.__rowNum__)+1}.`);
                                                }
                                            }
                                        }
                                    });
                                    if(message.length > 0){
                                        addToNoteList(`<b>Error:</b><br><ul level=2><li>${message.join("</li><li>")}</li></ul>`,null,val[identifierKey],"error");
                                    }
                                    
                                    if(obj.status == "plan"){
                                        addToNoteList(`Incomplete data. Shipment is saved as <b style="color: #5bc0de;">PLAN</b>.`,null,val[identifierKey],"warning");
                                    }
                                    if(errorShipment === false){
                                        snList.push(obj._id);
                                        obj.__rowNum__ = val.__rowNum__;
                                        importData.push(obj);
                                    }
    
                                    count++;
                                    checkIfDone();
                                });
                            });
                        } else {
                            addToNoteList(`Missing data in '${identifierKey}'.`,null,val[identifierKey],"error");
                        }
                        
                        function checkkkkk(columnKey,error){
                            if(columnKey == "Origin"){
                                if(origin){
                                    obj.origin_id = origin._id;
                                    if(obj.origin_id && obj.destination[0].location_id){
                                        var _route = LIST["routes"].find(x => (x.origin_id == origin._id && destination && x.destination_id == destination._id));
                                        if(_route){
                                            obj.route = _route._id;
                                        } else {
                                            addToNoteList(`Invalid data in 'Route'.  Possible causes:`,["The origin and destination is not a valid route."],val[identifierKey],"warning",true);
                                        }
                                    }
                                } else {
                                    addToNoteList(`Invalid data in '${columnKey}'.  Possible causes:`,error,val[identifierKey],"warning",true);
                                }
                            }

                            if(columnKey == "Destination"){
                                if(destination){
                                    obj.destination[0].location_id = destination._id;
                                    if(obj.origin_id && obj.destination[0].location_id){
                                        var _route = LIST["routes"].find(x => (x.origin_id == origin._id && destination && x.destination_id == destination._id));
                                        if(_route){
                                            obj.route = _route._id;
                                        } else {
                                            addToNoteList(`Invalid data in 'Route'.  Possible causes:`,["The origin and destination is not a valid route."],val[identifierKey],"warning",true);
                                        }
                                    }
                                } else {
                                    addToNoteList(`Invalid data in '${columnKey}'.  Possible causes:`,error,val[identifierKey],"warning",true);
                                }
                            }

                            if(columnKey == "Route"){
                                if(route){
                                    obj.route = route._id;
                                    
                                    obj.origin_id = route.origin_id;
                                    obj.destination[0].location_id = route.destination_id;

                                    origin = getGeofence(route.origin_id);
                                    destination = getGeofence(route.destination_id);
                                } else {
                                    addToNoteList(`Invalid data in '${columnKey}'.  Possible causes:`,error,val[identifierKey],"warning",true);
                                }
                            }

                            if(columnKey == "Truck Name"){
                                if(vehicle){
                                    obj.vehicle_id = vehicle._id;
                                } else {
                                    addToNoteList(`Invalid data in '${columnKey}'.  Possible causes:`,error,val[identifierKey],"warning",true);
                                }
                            }

                            if(columnKey == "Driver"){
                                if(driver){
                                    obj.driver_id = driver._id;
                                } else {
                                    addToNoteList(`Invalid data in '${columnKey}'.  Possible causes:`,error,val[identifierKey],"warning",true);
                                }
                            }

                            if(columnKey == "Checker"){
                                if(checker){
                                    obj.checker_id = checker._id;
                                } else {
                                    addToNoteList(`Invalid data in '${columnKey}'.  Possible causes:`,error,val[identifierKey],"warning",true);
                                }
                            }

                            if(columnKey == "Helper"){
                                if(helper){
                                    obj.helper_id = helper._id;
                                } else {
                                    addToNoteList(`Invalid data in '${columnKey}'.  Possible causes:`,error,val[identifierKey],"warning",true);
                                }
                            }

                            function getMaxDateSchedule(){
                                var shiftArr = (shift_schedule._id||"").split(" - ");
                                var shiftMinTime = shiftArr[0];
                                var shiftMaxTime = shiftArr[1];
                                var beginningTime = moment(shiftMinTime, 'h:mm A');
                                var endTime = moment(shiftMaxTime, 'h:mm A');
                                var dateTemp = (!beginningTime.isBefore(endTime)) ? moment(new Date(formattedScheduledDate)).add(1,"day").format("MM/DD/YYYY") : formattedScheduledDate;

                                return `${dateTemp}, ${shiftMaxTime}`;
                            }

                            if(columnKey == "Scheduled Date"){
                                var momentScheduledDate = moment(scheduled_date, 'MM/DD/YYYY', true);
                                var formattedScheduledDate = momentScheduledDate.format("MM/DD/YYYY");
                                if(momentScheduledDate.isValid()){
                                    if(obj.status != "plan" && shift_schedule){
                                        
                                        if(moment(getMaxDateSchedule(), 'MM/DD/YYYY, hh:mm A', true).isBefore() || moment(getMaxDateSchedule(), 'MM/DD/YYYY, h:mm A', true).isBefore()){
                                            addToNoteList(`Invalid data in '${columnKey}'.  Possible causes:`,error,val[identifierKey],"error",true);
                                        } else {
                                            obj.scheduled_date = new Date(scheduled_date).toISOString();
                                            if(withinSchedule(scheduled_date,shift_schedule._id)) {
                                                obj.status = "assigned";
                                            } else {
                                                obj.status = "scheduled";
                                            }
                                        }
                                    }
                                } else {
                                    addToNoteList(`Invalid data in '${columnKey}'.  Possible causes:`,error,val[identifierKey],"error",true);
                                }
                            }

                            if(columnKey == "Shift Schedule"){
                                if(shift_schedule){
                                    var momentScheduledDate = moment(scheduled_date, 'MM/DD/YYYY', true);
                                    var formattedScheduledDate = momentScheduledDate.format("MM/DD/YYYY");

                                    if(obj.status != "plan" && momentScheduledDate.isValid()){
                                        if(moment(getMaxDateSchedule(), 'MM/DD/YYYY, hh:mm A', true).isBefore() || moment(getMaxDateSchedule(), 'MM/DD/YYYY, h:mm A', true).isBefore()){
                                            addToNoteList(`Invalid data in '${columnKey}'.  Possible causes:`,error,val[identifierKey],"error",true);
                                        } else {
                                            obj.shift_schedule = shift_schedule._id;
                                            if(withinSchedule(scheduled_date,shift_schedule._id)) {
                                                obj.status = "assigned";
                                            } else {
                                                obj.status = "scheduled";
                                            }
                                        }
                                    }
                                } else {
                                    addToNoteList(`Invalid data in '${columnKey}'.  Possible causes:`,error,val[identifierKey],"error",true);
                                }
                            }
                        }
                        
                    });
                } else {
                    errorList["--"] = [`Empty columns`];
                    FETCH();
                }
                function FETCH(){
                    function addToNoteList(text,causes,key,type,isField){
                        if(type == "error"){
                            (errorList[key]) ? errorList[key].push(text) : errorList[key] = [text];
                        } 
                        if(type == "warning"){
                            var causesHTML = (causes) ? `<ul level=2><li>${causes.join("</li><li>")}</li></ul>` : "";
                            text = (isField === true) ? `<small class="text-muted">[FIELD NOT SAVED]</small> ${text}` : text;
                            (warningList[key]) ? warningList[key].push(text+causesHTML) : warningList[key] = [(text+causesHTML)];
                        }
                    }
                    GET.AJAX({
                        url: `/api/dispatch/${CLIENT.id}/${USER.username}/batch/${JSON.stringify(snList)}`,
                        method: "GET",
                        headers: {
                            "Authorization": SESSION_TOKEN
                        },
                    }, function(docs){
                        docs.forEach(val => {
                            addToNoteList("Shipment number already exists",null,val._id,"error");
                            importData = $.grep(importData, function(x){ return x._id != val._id});
                        });
                        importData.forEach(val => {
                            batchedData.push(val);
                        });
                        
                        console.log("Temp Final:",finalImportData);
                        console.log("Error List:",errorList);
                        console.log("Batched Data:",batchedData);
                        if(batchedData.length > 0){
                            GET.AJAX({
                                url: `/api/dispatch/${CLIENT.id}/${USER.username}/batch`,
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json; charset=utf-8",
                                    "Authorization": SESSION_TOKEN
                                },
                                data: JSON.stringify({batchedData}),
                            }, function(docs){
                                if(!docs.error){
                                    reportImport(batchedData.length);
                                } else {
                                    console.log(docs.error);
                                    batchedData.forEach(val => {
                                        if(docs.error.status == 409){
                                            errorList[val._id||val.ticket_number] = ["Record already exists."];
                                        } else {
                                            errorList[val._id||val.ticket_number] = [docs.error.statusText];
                                        }
                                    });
                                    reportImport(0);
                                }
                            }, function(error) {
                                console.log(error);
                                batchedData.forEach(val => {
                                    if(error.status == 409){
                                        errorList[val._id||val.ticket_number] = ["Record already exists."];
                                    } else {
                                        errorList[val._id||val.ticket_number] = [error.statusText];
                                    }
                                });
                                reportImport(0);
                            });
                        } else {
                            reportImport(0);
                        }
                        function reportImport(success_count){
                            Object.keys(errorList).forEach(key => {
                                if(warningList[key]){
                                    delete warningList[key];
                                }
                            });

                            toastr.info("Done. Please check the report for import details.");
                            $(`[success_count]`).html(success_count);
                            $(`[error_count]`).html(Object.keys(errorList).length);
                            var errorHTML = (Object.keys(errorList).length > 0) ? "" : "--",
                                warningHTML = (Object.keys(warningList).length > 0) ? "" : "--",
                                regex = /(<([^>]+)>)|(&lt;([^>]+)&gt;)/ig,
                                addLine = function(){
                                    return `----------------------------------------------------------------------------------`;
                                },
                                reportDL = `Report Import:\n\n${addLine()}\nFilename: ${filename}\nDate and time: ${DATETIME.FORMAT(new Date())}\nTotal # of Rows: ${totalRows} rows\n${addLine()}\nSuccessful imports: ${success_count} rows\nWarnings:`,
                                nbsp = function(num){
                                    var str = "";
                                    for(var i = 0; i < num; i++){
                                        str += "\u00a0";
                                    }
                                    return str;
                                },
                                htmlToText = function(appendAttr,listAttr){
                                    $(`body`).append(`<ul ${appendAttr} style="display:none;">${$(`[${listAttr}]`).html()}</ul>`);
                                    var snHTML = $(`[${appendAttr}] sn`);
                                    snHTML.each((i,sn) => {
                                        var text = $(sn).text();
                                        $(sn).html(`${nbsp(3)}_BIGBULLET_ ${text}`);
                                    });
    
                                    var level2HTML = $(`[${appendAttr}] ul[level=2]`);
                                    level2HTML.each((i,ul) => {
                                        var ulText = $(ul).html(),
                                            text = ulText.replace(/<li>/g,`\n${nbsp(12)}_SMALLBULLET_ `).replace(/<\/li>/g,"");
                                        $(ul).html(text);
                                    });
                                    
                                    var level1HTML = $(`[${appendAttr}] ul[level=1]`);
                                    level1HTML.each((i,ul) => {
                                        var ulText = $(ul).html(),
                                            text = ulText.replace(/<li>/g,`${nbsp(7)}_DASH_ `).replace(/<\/li>/g,"\n ");
                                        $(ul).html(text);
                                    });
                                    var noTags = $(`[${appendAttr}]`).html().replace(regex , "").replace(/^\s*[\r\n]/gm,"")._trim().replace(/&nbsp;/g," ").replace(/_BIGBULLET_/g,"•").replace(/_SMALLBULLET_/g,"∙").replace(/_DASH_/g,"-");
                                    reportDL += `\n${noTags}`;
                                };
                            Object.keys(warningList).forEach(key => {
                                warningHTML += `<li>
                                                    <sn><span class="text-muted">${identifierKey||"Row #"}: </span><b>${key}</b></sn>
                                                    <ul level=1><li>${warningList[key].join("</li><li>")}</li></ul>
                                                </li>`;
                            });
                            $(`[warning_list]`).html(warningHTML);
                            htmlToText("warning_note","warning_list");

                            reportDL += `\n${addLine()}\nUnsuccessful imports: ${Object.keys(errorList).length} rows\nErrors:`
                            Object.keys(errorList).forEach(key => {
                                errorHTML += `<li>
                                                <sn><span class="text-muted">${identifierKey||"Row #"}: </span><b>${key}</b></sn>
                                                <ul level=1><li>${errorList[key].join("</li><li>")}</li></ul>
                                            </li>`;
                            });
                            $(`[error_list]`).html(errorHTML);
                            htmlToText("error_note","error_list");
                            reportDL += `\n${addLine()}`;

                            $(`[warning_note],[error_note]`).remove();

                            $(`#import-btn`).html(`Import`).attr("disabled",false);
                            $(`.dropify-wrapper`).css("pointer-events","");
                            $(`.dropify-clear`).click();
                            $(`#reportDL`).attr("href",`data:text/plain;charset=UTF-8,${encodeURIComponent(reportDL)}`).show();
                        }
                    });
                }
            }
        },
        add_row:{
            destination:function(i,data,routeId,noAction){
                var _row = GENERATE.RANDOM(36),
                    destination = getGeofence(data.location_id) || {},
                    route = getRoute(routeId) || {},
                    transit_hh_mm = DATETIME.HH_MM(null,route.transit_time),
                    cico_hh_mm = DATETIME.HH_MM(null,destination.cico),
                    readonly = (noAction===true)?"readonly":"",
                    new_row = `<tr _row="${_row}">
                                <td class="text-muted">${i}</td>
                                <td><input location type="text" class="form-control" autocomplete="off" readonly></td>
                                <td transit_time>${transit_hh_mm.hour||`<span class="text-muted">HH</span>`} : ${transit_hh_mm.minute||`<span class="text-muted">MM</span>`}</td>
                                <td cico>${cico_hh_mm.hour||`<span class="text-muted">HH</span>`} : ${cico_hh_mm.minute||`<span class="text-muted">MM</span>`}</td>
                            </tr>`;
                $(`#tbl-destination tbody`).append(new_row);
                return _row;
            },
        }, 
        monitoring_deleted: function(){
            var dispatchModule = (CLIENT.id == "wilcon") ? "dispatch_mod2_deleted" : "dispatch_deleted";

            /******** TABLE ********/
            var urlParams = new URLSearchParams(window.location.search),
                __data = CRYPTO.DECRYPT(urlParams.get('data')),
                table_id = '#tbl-dispatch_deleted',
                urlPath = "user_action",
                uniTitle = "Dispatch Entry (Deleted)",
                filter = USER.filters.dispatch_deleted || {},
                dt = null,
                _new_ = true,
                donePopulate = false,
                rowData = function(obj){
                    var de = new Dispatch(obj,table_id);
                    var row = de.row();
                    
                    row["Deleted By"] = obj.deleted_by||"-";
                    row["Deleted Date"] = DATETIME.FORMAT(obj.deleted_date);
                    return TABLE.COL_ROW(null,row).row;
                },
                populateTable = function(newlyLoaded,disableClearTable,doNotClearList,_filter_){
                    if(!doNotClearList) LIST[urlPath] = [];
                    filter = _filter_ || USER.filters.dispatch_deleted || {};
                    try {
                        filter = JSON.parse(filter);
                    } catch(error){}

                    var __filter = ($.isEmptyObject(filter)) ? {timestamp: FILTER.DATERANGE()} : filter;
                    __filter.collection = "dispatch";

                    var dt_buttons = TABLE.BUTTONS({
                        goto: PAGE.GET(),
                        loadView: ["create","create-admin","import"],
                        actions:{
                            refresh: function(){
                                populateTable(null);
                            },
                            column: function(){
                                $(`#export-container`).hide("slide", {direction:'right'},100);
                                $(`#filter-container`).hide("slide", {direction:'right'},100);
                                $(`#cv-container`).toggle("slide", {direction:'right'},100);
                            },
                            filter: function(){
                                $(`#export-container`).hide("slide", {direction:'right'},100);
                                $(`#cv-container`).hide("slide", {direction:'right'},100);
                                $(`#filter-container`).toggle("slide", {direction:'right'},100);
                            },
                            export: function(){
                                $(`#filter-container`).hide("slide", {direction:'right'},100);
                                $(`#cv-container`).hide("slide", {direction:'right'},100);
                                $(`#export-container`).toggle("slide", {direction:'right'},100);
                            },
                        }
                    });
                    
                    donePopulate = false;
                    if(dt && !disableClearTable) {
                        dt.clear().draw();
                        $(".dataTables_empty").text("Loading...");
                    }
                    GET.AJAX({
                        url: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(__filter)}/count`,
                        method: "GET",
                        headers: {
                            "Authorization": SESSION_TOKEN
                        },
                    }, function(count){
                        var minWidth = 1, maxWidth = 1, origPerc = 0,totalPerc = 0;
                        console.log("count",count);
                        TABLE.POPULATE({
                            url:`${urlPath}/${CLIENT.id}/${USER.username}/all`,
                            goto: PAGE.GET(),
                            commentTitle: uniTitle,
                            withFilter: true,
                            filter: __filter,
                            urlPath,
                            withPagination: true,
                            newlyLoaded,
                            dataTableOptions: {
                                columns: TABLE.COL_ROW(CUSTOM.COLUMN[dispatchModule]).column,
                                createdRow: function (row, data, dataIndex) {
                                    var _row = data._row,
                                        _id = data._id;
                                    $(row).attr(`_row`, data._row);
                                    
                                    TABLE.ROW_LISTENER({table_id,_row,urlPath:urlPath,_id,
                                        additionalListeners: function(){
                                        }
                                    });
                                },
                                order: [[ 1, "desc" ]],
                                dom: 'lB<"toolbar">frti<"tbl-progress-bar">p',
                                buttons: dt_buttons
                            },
                            table_id,
                            initializeCallback: function(data,_dt){
                                dt = _dt;
                                searchEvent();
                                initializeFilter();
                                
                                $(table_id).on( 'search.dt length.dt page.dt', function () {
                                    if(GGS.STATUS.REGIONS && GGS.STATUS.CLUSTERS && GGS.STATUS.GEOFENCES && GGS.STATUS.VEHICLES && GGS.STATUS.ROUTES){
                                        TABLE.FINISH_LOADING.UPDATE();
                                        setTimeout(function(){ TABLE.FINISH_LOADING.UPDATE(); },300);
                                    }
                                });

                                // // initialize loading bar
                                $("div.tbl-progress-bar").html(LOADING.PROGRESSBAR.UI()).css({position:"absolute",left:"0px",bottom:"-6px",width:"160px",height:"20px"});
                                LOADING.PROGRESSBAR.INITIALIZE();
                            },
                            populateCallback: function(data){
                                if($(table_id).length > 0){
                                    donePopulate = true;
                                    $(`#search-btn`).css({"pointer-events":"","color":""});
                                    
                                    var rows = [];
                                    $.each(data, function(i,val){
                                        var _deData={};
                                        try {
                                            _deData = JSON.parse(val.data);
                                        } catch(error){}
                                        _deData.deleted_by = val.username;
                                        _deData.deleted_date = val.timestamp;
                                        rows.push(rowData(_deData));
                                    });
                                    dt.rows.add(rows).draw(false);
                                    TABLE.FINISH_LOADING.START_CHECK();

                                    
                                    $("div.tbl-progress-bar").show();
                                    var a = count/LIMIT;
                                    var wholeNumber = Math.floor(a);
                                    var modulo = a % 1;
                                    if(modulo > 0) wholeNumber++
                                    (origPerc) ? null : origPerc = (100 / wholeNumber);
                                    totalPerc = totalPerc + origPerc;
                                    minWidth = maxWidth;
                                    maxWidth = Math.floor(totalPerc);
                                    LOADING.PROGRESSBAR.MOVE(minWidth,maxWidth);
                                }
                            },
                        });
                    });
                },
                initializeFilter = function(){
                    $(`.page-box`).append(SLIDER.COLUMN_VISIBILITY(CUSTOM.COLUMN[dispatchModule])); 
                    $('span.toggle-vis').on( 'click', function (e) {
                        var index = $(this).attr('data-column'),
                            column = dt.column(index);

                        column.visible( ! column.visible() );
                        CUSTOM.COLUMN[dispatchModule][index].visible = column.visible();
                        CUSTOM.COLUMN[dispatchModule][index].bVisible = column.visible();
                        $(table_id).attr("style","");

                        $(`${table_id} thead tr th`).each((i,el) => {
                            if(!$(el).is(":visible")){
                                $(`${table_id} tr:not(.child)`).each((i1,el1) => {
                                    $(el1).find("td").eq(i).hide();
                                });
                            }
                        });
                    });
                    
                    $(`.page-box`).append(SLIDER.EXPORT()); 
                    TABLE.TOOLBAR(dt);
                    $(`.buttons-copy span`).html("Copy Table");
                    $(`.buttons-csv span`).html("Export Table As CSV File");
                    $(`.buttons-excel span`).html("Export Table As Excel File");

                    $(`#_timestamp,#_posting_date`).daterangepicker({
                        opens: 'left',
                        timePicker: true,
                        locale: {
                            format: 'MM/DD/YYYY hh:mm A'
                        },
                        autoUpdateInput: false,
                        autoApply: true
                    }, function(start, end, label) {
                        FILTER.INITIALIZE($(this)["0"].element,start,end,'MM/DD/YYYY hh:mm A');
                        $('.clearable').trigger("input");
                    }).on('apply.daterangepicker', function (ev, picker) {
                        FILTER.INITIALIZE($(this),picker.startDate,picker.endDate,'MM/DD/YYYY hh:mm A');
                        $('.clearable').trigger("input");
                    });

                    if(filter.timestamp) FILTER.INITIALIZE(`#_timestamp`,filter.timestamp["$gte"],filter.timestamp["$lt"],'MM/DD/YYYY hh:mm A');
                    if(filter.posting_date) FILTER.INITIALIZE(`#_posting_date`,filter.posting_date["$gte"],filter.posting_date["$lt"],'MM/DD/YYYY hh:mm A');
                    if(filter.timestamp || filter.posting_date) {
                        $(`#filter-container`).toggle("slide", {direction:'right'},100);
                        $('.clearable').trigger("input");
                        FILTER.STATUS = "new";
                    }
                    
                    FILTER.RESET({
                        dateEl: `#_timestamp`,
                        dateElnoVal: `#_posting_date`,
                        urlPath: "dispatch_deleted",
                        populateTable
                    });
                    $(`#filter-btn`).click(function(){
                        filter = {};
                        var _posting_date = $(`#_posting_date`).val() || "",
                            _timestamp = (_posting_date) ? $(`#_timestamp`).val() : ( $(`#_timestamp`).val() || DEFAULT_DATE);

                        (!_timestamp.isEmpty()) ? filter["timestamp"] = FILTER.DATERANGE(_timestamp,true,true) : null;
                        (!_posting_date.isEmpty()) ? filter["posting_date"] = FILTER.DATERANGE(_posting_date,true,true) : null; 

                        if(FILTER.STATUS != "reset") {} 
                        else {
                            FILTER.STATUS = "new";
                        }

                        USER.filters.dispatch_deleted = filter;
                        
                        GET.AJAX({
                            url: `/api/users/${CLIENT.id}/${USER.username}/${USER.username}`,
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8",
                                "Authorization": SESSION_TOKEN
                            },
                            data: JSON.stringify({"filter.dispatch":JSON.stringify(filter)})
                        }, function(docs){
                            console.log("docs",docs);
                        });

                        $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");

                        populateTable();
                    });
                },
                searchEvent = function(){
                    var searchText = null,
                        origFilter = null,
                        removeSearchResult = false;
                    dt.on('search.dt', function () {
                        if(dt.page.info().recordsDisplay === 0 && dt.search()){
                            if(donePopulate === true){
                                if($(`#search-alert`).html().isEmpty()) {
                                    $(`#search-alert`).html(ALERT.HTML.INFO(`<span id="alert-message">Click <u id="search-btn" style="cursor: pointer;">here</u> to search for Shipment Number: <b id="search-text">${dt.search()}</b> through all records.</span><span id="no-result-message" style="display:none;"></span>`,"m-3",true)).show();
                                    $(`#search-btn`).click(function(){
                                        $(`#search-btn`).css({"pointer-events":"none","color":"#aaadae"});
                                        searchText = dt.search();
                                        // removeSearchResult = false;
                                        origFilter = filter;
                                        filter = {unique_filter:`_id: ${dt.search()}`};
                                        populateTable(null,true,true,filter);
                                    });
                                } else {
                                    if(searchText === dt.search()){
                                        $(`#alert-message`).hide();
                                        $(`#no-result-message`).html(`No result for Shipment Number: <b id="search-text">${searchText}</b>.`).show();
                                        searchText = null;
                                    } else {
                                        $(`#alert-message`).hide().show();
                                        $(`#no-result-message`).html("").hide();
                                        $(`#search-text`).html(dt.search());
                                    }
                                }
                            }
                        } else {
                            $(`#search-alert`).html("").hide();
                            if(origFilter) {
                                filter = origFilter;
                                origFilter = null;
                            }
                        }
                    });
                };
            __data.for = urlPath;

            
            try {
                filter = JSON.parse(filter);
            } catch (error) {}
            
            LIST[urlPath] = [];
            populateTable(true);
            /******** END TABLE ********/

            /******** TABLE CHECK ********/
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                // do not remove ROUTES. For Create/edit
                isFinishedLoading(["REGIONS","CLUSTERS","GEOFENCES","VEHICLES","TRAILERS","ROUTES","VEHICLE_PERSONNEL"], _new_, function(){
                    if(dt){
                        _new_ = false;
                       
                        $.each(LIST["dispatch"], function(i,val){
                            var rowNode = dt.row(`[_row="${val._row}"]`).node();
                            (rowNode) ? dt.row(rowNode).data(rowData(val)) : null;
                        });
    
                        TABLE.FINISH_LOADING.UPDATE();
                    }
                });
            }
            TABLE.FINISH_LOADING.START_CHECK();
            /******** END TABLE CHECK ********/
        },
    }
};
var SHIFT_SCHEDULE = {
    FUNCTION: {
        init: function(){
            var urlPath = "shift_schedule",
                _new_ = true,  
                table = new Table({
                    id: "#tbl-shift_schedule",
                    urlPath,
                    goto: "shift_schedule",
                    dataTableOptions: {
                        columns: TABLE.COL_ROW(CUSTOM.COLUMN.shift_schedule).column,
                        createdRow: function (row, data, dataIndex) {
                            var _row = data._row;
                            $(row).attr(`_row`,_row);
                            table.rowListeners(_row,data._id);
                        },
                        dom: 'lB<"toolbar">frti<"tbl-progress-bar">p',
                    },
                    initializeCallback: function(){
                        TABLE.WATCH({urlPath,rowData:table.addRow,options:function(){TABLE.FINISH_LOADING.START_CHECK();}});
                        TABLE.FINISH_LOADING.UPDATE();
                    }
                });
            table.setButtons({
                loadView: ["create"],
                actions:{
                    create: function(){
                        initializeModal({
                            url: `/api/${urlPath}/${CLIENT.id}/${USER.username}`,
                            method: "POST"
                        });
                    },
                }
            });
            table.addRow = function(obj){
                var action = TABLE.ROW_BUTTONS(PAGE.GET());
                $(`${table.id} th:last-child`).css({"min-width":action.width,"width":action.width});

                return TABLE.COL_ROW(null,{
                    '_id': obj._id,
                    '_row':  obj._row,
                    'Action': action.buttons,
                }).row;
            };
            table.rowListeners = function(_row,_id){
                TABLE.ROW_LISTENER({table_id:table.id,_row,urlPath,_id,initializeModal});
            };

            var initializeModal = function(x){
                var title = (x.method == "PUT") ? `Edit Shift Schedule` : `Create Shift Schedule`,
                    modalElements = function(obj){
                        obj = obj || {};
                        var timeOptions = [
                            { id: "12:00 AM" },
                            { id: "1:00 AM" },
                            { id: "2:00 AM" },
                            { id: "3:00 AM" },
                            { id: "4:00 AM" },
                            { id: "5:00 AM" },
                            { id: "6:00 AM" },
                            { id: "7:00 AM" },
                            { id: "8:00 AM" },
                            { id: "9:00 AM" },
                            { id: "10:00 AM" },
                            { id: "11:00 AM" },
                            { id: "12:00 PM" },
                            { id: "1:00 PM" },
                            { id: "2:00 PM" },
                            { id: "3:00 PM" },
                            { id: "4:00 PM" },
                            { id: "5:00 PM" },
                            { id: "6:00 PM" },
                            { id: "7:00 PM" },
                            { id: "8:00 PM" },
                            { id: "9:00 PM" },
                            { id: "10:00 PM" },
                            { id: "11:00 PM" },
                        ];
                        return [
                            {title:"Start of Shift",id:"start_shift",type:"select",options:timeOptions,attr:"doNotSave=true"},
                            {title:"End of Shift",id:"end_shift",type:"select",options:timeOptions,attr:"doNotSave=true"},
                            {id:"_id",type:"text"},
                        ];
                    };
                    $(`body`).append(MODAL.CREATE.BASIC({ title, el: modalElements(x.obj) }));

                    $(`#_id`).parent().hide();

                    $(`#start_shift`).change(function(){
                        if($(`#start_shift`).val() && $(`#end_shift`).val()){
                            $(`#_id`).val(`${$(`#start_shift option:selected`).val()} - ${$(`#end_shift option:selected`).val()}`);
                        }
                    });
                    $(`#end_shift`).change(function(){
                        if($(`#start_shift`).val() && $(`#end_shift`).val()){
                            $(`#_id`).val(`${$(`#start_shift option:selected`).val()} - ${$(`#end_shift option:selected`).val()}`);
                        }
                    });

                    MODAL.SUBMIT(x);
            };

            /******** TABLE CHECK ********/
            LIST[urlPath] = LIST[urlPath] || [];
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                isFinishedLoading(["SHIFT_SCHEDULE"], _new_, function(){
                    _new_ = false;

                    table.initialize();
                    table.populateRows(LIST[urlPath]);
                    table.hideProgressBar();
                });
            }
            /******** END TABLE CHECK ********/

            TABLE.FINISH_LOADING.START_CHECK();
        }
    }
};
var REPORTS = {
    columns: {
        actualCICO: {
            name: 'Actual CICO',
            description: 'Actual duration of stay inside the origin site'
        },
        actualCICOAve: {
            name: 'Actual CICO',
            description: 'Average of actual duration of stay inside the origin site'
        },
        arrivalDate: {
            name: 'Arrival Date',
            description: 'Actual date of return to the origin site after delivery'
        },
        arrivalTime: {
            name: 'Arrival Time',
            description: 'Actual time of return to the origin site after delivery'
        },

        baseSite: {
            name: 'Base Site',
            description: 'Site where the vehicle was accounted and will serve as its home base'
        },
        baseSiteCode: {
            name: 'Base Site Code',
            description: 'Numerical identifier of the base site'
        },
        baseSiteRegion: {
            name: 'Base Site Region',
            description: 'Region where the base site is located'
        },

        cicoTarget: {
            name: 'CICO Target',
            description: 'Maximum duration of stay inside the origin site'
        },
        cicoWithCapping: { // 5 hours
            name: 'CICO with Capping',
            description: 'Duration of stay inside the origin site that exceeded to 5 hrs will automatically rolled back to 5 hrs'
        },
        cicoWithCappingAve: {
            name: 'CICO with Capping',
            description: 'Average duration of stay inside the origin site that exceeded to 5 hrs will automatically rolled back to 5 hrs'
        },
        cicoWithCapping_1: { // 3 hours
            name: 'CICO with Capping',
            description: 'Duration of stay inside the origin site that exceeded to 3 hrs will automatically rolled back to 3 hrs'
        },
        cicoVariance: {
            name: 'CICO Variance',
            description: 'Excess CICO (with capping) duration from the CICO target'
        },
        checkInDate: {
            name: 'Check In Date',
            description: 'Actual date of entry to the origin site'
        },
        checkInTime: {
            name: 'Check In Time',
            description: 'Actual time of entry to the origin site'
        },
        checkOutDate: {
            name: 'Check Out Date',
            description: 'Actual date of departure to the origin site'
        },
        checkOutTime: {
            name: 'Check Out Time',
            description: 'Actual time of departure to the origin site'
        },
        completionDate: {
            name: 'Completion Date',
            description: 'Actual date of arrival to the destination site'
        },
        completionTime: {
            name: 'Completion Time',
            description: 'Actual time of arrival to the destination site'
        },
        comments: {
            name: 'Comments',
            description: 'Remarks concerning with the shipment'
        },
        customerNo: (x) => {
            return {
                name: 'Customer No. (' + x + ')',
                description: 'Identification or reference number of a Coke customer'
            };
        },
        customerName: (x) => {
            return {
                name: 'Customer Name (' + x + ')',
                description: 'Word that identifies the recipient of ordered Coke products'
            };
        },

        delay: {
            name: 'Delay',
            description: 'Situation that hamper the productivity of the operaton'
        },
        deliveryDuration: {
            name: 'Delivery Duration',
            description: 'Amount of time spent on shipment delivery'
        },
        deliverySequence: {
            name: 'Delivery Sequence',
            description: 'Tells if the shipment assigned is initial or re-load'
        },
        destination: {
            name: 'Destination',
            description: 'Site to receive the shipment'
        },

        escalation: {
            name: 'Escalation',
            description: 'Level of severety of the delay encountered'
        },
        estTransitDuration: {
            name: 'Est. Transit Duration',
            description: 'Estimated amount of time in transporting shipment from origin site to destination site'
        },

        idlingDuration: {
            name: 'Idling Duration',
            description: 'Duration of stay inside the idling area geofence'
        },
        idlingDurationAve: {
            name: 'Idling Duration',
            description: 'Average duration of stay inside the idling area geofence'
        },

        lapseTime: {
            name: 'Lapse Time',
            description: 'Amount of time exceeds to the estimated transit duration'
        },
        lapseTimeAve: {
            name: 'Average Lapse Time',
            description: 'Average of the amount of time exceeds to the estimated transit duration'
        },
        longQueueing: {
            name: 'Long Queueing',
            description: 'Count of shipment that encountered Long Queueing Delay'
        },
        
        mdsdUsage: {
            name: 'MDSD Usage',
            description: 'Identifies if the shipment will use MDSD to its transaction or not'
        },

        occurrenceDate: {
            name: 'Occurrence Date',
            description: 'Actual date of delay encounter'
        },
        occurrenceTime: {
            name: 'Occurrence Time',
            description: 'Actual time of delay encounter'
        },
        origin: {
            name: 'Origin',
            description: 'Site where the shipment originates'
        },
        origin_1: {
            name: 'Origin',
            description: 'Source Name'
        },
        originSiteCode: {
            name: 'Origin Site Code',
            description: 'Numerical identifier of the origin'
        },
        originRegion: {
            name: 'Origin Region',
            description: 'Region where the origin site is located'
        },
        overTransitDuration: {
            name: 'Over Transit Duration',
            description: 'Count of posted shipment that the transporting time exceeds the estimated transit duration'
        },
        overCICO: {
            name: 'Over CICO',
            description: 'Count of shipment that encountered Over CICO Delay'
        },
        overTransit: {
            name: 'Over Transit',
            description: 'Count of shipment that encountered Over Transit Delay'
        },
        
        palCap: {
            name: 'Pal Cap',
            description: 'Trailer capacity in pallets'
        },
        processingDuration: {
            name: 'Processing Duration',
            description: 'Duration of stay inside the processing area geofence'
        },
        processingDurationAve: {
            name: 'Processing Duration',
            description: 'Average duration of stay inside the processing area geofence'
        },

        queueingDuration: {
            name: 'Queueing Duration',
            description: 'Duration of stay inside the queueing area geofence'
        },
        queueingDurationAve: {
            name: 'Queueing Duration',
            description: 'Average duration of stay inside the queueing area geofence'
        },

        remarksTransit: {
            name: 'Remarks',
            description: 'Identifier if the transit duration is  "Over Transit"'
        },
        remarksCico: {
            name: 'Remarks',
            description: 'Identifier if the shipment is "In CICO" or "Over CICO"'
        },
        remarksCicoAve: {
            name: 'Remarks',
            description: 'Identifier if the average duration of stay inside the origin site is "In CICO" or "Over CICO"'
        },
        remarksTrippage: {
            name: 'Remarks',
            description: 'Identifier if the trippage result hit and surpass the target'
        },
        route: {
            name: 'Route',
            description: 'Site codes combination of origin and destination'
        },

        site: {
            name: 'Site',
            description: 'Name of site where the delay happen (Over CICO & Long Queueing)'
        },
        siteCode: {
            name: 'Site Code',
            description: 'Numerical identifier of the site'
        },
        siteRegion: {
            name: 'Site Region',
            description: 'Region where the site is located'
        },
        shipment: {
            name: 'Shipment',
            description: 'Numerical identifier of assigned shipment'
        },
        shipmentType: {
            name: 'Shipment Type',
            description: 'Identfies if the shipment assigned is unique (mother shipment)  or co-load'
        },
        shipmentCount_CheckedOut: {
            name: 'Shipment Count',
            description: 'Count of posted shipment that already checked out from the origin'
        },
        shipmentCount_All: {
            name: 'Shipment Count',
            description: 'Count of posted shipment from the origin'
        },
        supportUnit: {
            name: 'Support Unit?',
            description: 'Identifies if the assigned truck is a support unit or not'
        },

        trailer: {
            name: 'Trailer',
            description: 'Plate number of the trailer coupled to the tractor where the shipment is assigned'
        },
        transitDuration: {
            name: 'Transit Duration',
            description: 'Amount of time consumed in transporting the shipment from origin site to destination site'
        },
        transitDurationAve: {
            name: 'Average Transit Duration',
            description: 'Average of the amount of time consumed in transporting the shipment from origin site to destination site'
        },
        truckInventory: {
            name: 'Truck Inventory',
            description: 'Number of trucks accounted to the site'
        },
        trippage: {
            name: 'Trippage',
            description: 'A metric that assesses the productivity of trucks by the number of trips catered daily'
        },
        trippageTarget: {
            name: 'Trippage Target',
            description: 'Aim of site produtivity result'
        },
        trippageVariance: {
            name: 'Trippage Variance',
            description: 'Difference of trippage from its target'
        },
        totalDelays: {
            name: 'Total Delays',
            description: 'Sum of shipment that encountered delays'
        },

        vehicle: {
            name: 'Vehicle',
            description: 'Plate number of the tractor where the shipment is assigned'
        },
        vehicleBaseSite: {
            name: 'Vehicle Base Site',
            description: 'Site where the vehicle was allocated and will serve as its base site'
        },
        
        withinTransitDuration: {
            name: 'Within Transit Duration',
            description: 'Count of posted shipment that the transporting time is witin the estimated transit duration'
        },
    },
    columnHtml: ( arr, descriptionStyle, columnNameStyle ) => {
        var descriptionHtml = "";
        var columneNameHtml = "";
        arr.forEach(val => {
            var column = REPORTS.columns[val];
            if(val.indexOf('|') > -1){
                const valSplit = val.split('|');
                column = REPORTS.columns[valSplit[0]](valSplit[1]);
            }

            if(column){
                descriptionHtml += `<td style="${descriptionStyle||""}">${column.description}</td>`;
                columneNameHtml += `<td style="${columnNameStyle||""}">${column.name}</td>`;
            } else {
                console.log("Missing column:",val);
            }
        }); 
        return `
            ${descriptionStyle ? `<tr>${descriptionHtml}</tr>` : ''}
            ${columnNameStyle ? `<tr>${columneNameHtml}</tr>` : ''}
        `;
    },
    UI: {
        REPORT_MODAL_01: function(title,_siteTitle){
            return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                        <div id="small-modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                            <div role="document" class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class="modal-header pb-2">
                                        <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                        <h4 class="modal-title" id="myModalLabel2">${title}</h4>
                                    </div>
                                    <div class="modal-body row pt-2">
                                        <div class="col-sm-12">
                                            <small><span class="text-danger">*</span>Select Departure Date Range:</small>
                                            <input id="daterange" type="input" class="form-control">
                                        </div>
                                        <div class="col-sm-12">
                                            <small>${_siteTitle}:</small>
                                            <select id="_site" class="select-basic" style="width:100%;"></select>
                                        </div>
                                        <div class="col-sm-12"> 
                                            <button id="generate-btn" type="button" class="btn btn-primary col-sm-12 mt-4">Generate report</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
        },
        REPORT_MODAL_02: function(title,_siteTitle,_dateTitle){
            return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                        <div id="small-modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                            <div role="document" class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class="modal-header pb-2">
                                        <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                        <h4 class="modal-title" id="myModalLabel2">${title}</h4>
                                    </div>
                                    <div class="modal-body row pt-2">
                                        <div class="col-sm-12">
                                            <small><span class="text-danger">*</span>${_dateTitle || "Select Departure Date"}:</small>
                                            <input id="daterange" type="input" class="form-control">
                                        </div>
                                        <div class="col-sm-12">
                                            <small>${_siteTitle}:</small>
                                            <select id="_site" class="select-basic" style="width:100%;"></select>
                                        </div>
                                        <div class="col-sm-12"> 
                                            <button id="generate-btn" type="button" class="btn btn-primary col-sm-12 mt-4">Generate report</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
        },
        REPORT_MODAL_03: function(title){
            return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                        <div id="small-modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                            <div role="document" class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class="modal-header pb-2">
                                        <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                        <h4 class="modal-title" id="myModalLabel2">${title}</h4>
                                    </div>
                                    <div class="modal-body row pt-2">
                                        <div class="col-sm-12">
                                            <small><span class="text-danger">*</span>Select Date:</small>
                                            <input id="daterange" type="input" class="form-control">
                                        </div>
                                        <div class="col-sm-12"> 
                                            <button id="generate-btn" type="button" class="btn btn-primary col-sm-12 mt-4">Generate report</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
        },
        REPORT_MODAL_04: function(title,_siteTitle,_dateTitle){
            return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                        <div id="small-modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                            <div role="document" class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class="modal-header pb-2">
                                        <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                        <h4 class="modal-title" id="myModalLabel2">${title}</h4>
                                    </div>
                                    <div class="modal-body row pt-2">
                                        <div class="col-sm-12">
                                            <small><span class="text-danger">*</span>${_dateTitle || "Select Date"}:</small>
                                            <input id="daterange" type="input" class="form-control">
                                        </div>
                                        <div class="col-sm-12">
                                            <small>Origin Site:</small>
                                            <select id="_origin_site" class="select-basic" style="width:100%;"></select>
                                        </div>
                                        <div class="col-sm-12">
                                            <small>Destination Site:</small>
                                            <select id="_destination_site" class="select-basic" style="width:100%;"></select>
                                        </div>
                                        <div class="col-sm-12"> 
                                            <button id="generate-btn" type="button" class="btn btn-primary col-sm-12 mt-4">Generate report</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
        },
        REPORT_MODAL_05: function(title,_siteTitle,dateTitle="Select Date Range"){
            return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                        <div id="small-modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                            <div role="document" class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class="modal-header pb-2">
                                        <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                        <h4 class="modal-title" id="myModalLabel2">${title}</h4>
                                    </div>
                                    <div class="modal-body row pt-2">
                                        <div class="col-sm-12">
                                            <small><span class="text-danger">*</span>${dateTitle}:</small>
                                            <input id="daterange" type="input" class="form-control">
                                        </div>
                                        <div class="col-sm-12"> 
                                            <button id="generate-btn" type="button" class="btn btn-primary col-sm-12 mt-4">Generate report</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
        },
        REPORT_MODAL_06: function(title,dateTitle="Select Date Range"){
            return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                        <div id="small-modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                            <div role="document" class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class="modal-header pb-2">
                                        <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                        <h4 class="modal-title" id="myModalLabel2">${title}</h4>
                                    </div>
                                    <div class="modal-body row pt-2">
                                        <div class="col-sm-12"> 
                                            <button id="generate-btn" type="button" class="btn btn-primary col-sm-12 mt-4">Generate report</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
        },
        REPORT_MODAL_07: function(title,customButtons){ // month & year
            return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                        <div id="small-modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                            <div role="document" class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class="modal-header pb-2">
                                        <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                        <h4 class="modal-title" id="myModalLabel2">${title}</h4>
                                    </div>
                                    <div class="modal-body row pt-2">
                                        <div class="col-sm-12">
                                            <small><span class="text-danger">*</span>Select Month:</small>
                                            <input id="daterange" type="input" class="form-control" onkeydown="event.preventDefault()">
                                            ${(customButtons)?customButtons:`<button id="generate-btn" type="button" class="btn btn-primary col-sm-12 mt-4">Generate report</button>`}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
        },
        REPORTS: {
            cicor: {
                coket1: ( title, docs, originChosen, date_from, date_to ) => {
                    // Legend:
                    //    · GBO - Grouped by Origin
                    //    · GBR - Grouped by Region
                    //    · NTL - National

                    /****** CSS ******/
                    const rotateCSS = ` -webkit-transform: rotate(-90deg);
                                        -moz-transform: rotate(-90deg);
                                        -ms-transform: rotate(-90deg);
                                        -o-transform: rotate(-90deg);
                                        transform: rotate(-90deg);
                                        mso-rotate: 90;
                                        -webkit-transform-origin: 50% 50%;
                                        -moz-transform-origin: 50% 50%;
                                        -ms-transform-origin: 50% 50%;
                                        -o-transform-origin: 50% 50%;
                                        transform-origin: 50% 50%;
                                        position: absolute;
                                        filter: progid:DXImageTransform.Microsoft.BasicImage(rotation=3);
                                        
                                        color: #595959;
                                        background-color: #E2EFDA;
                                        height: 127px;
                                        border: none;
                                        border-right: thin dashed #595959;`;

                    const tblHeaderCSS = `  background-color: #404040;
                                        color: white;
                                        font-size: 13px;
                                        text-align: center;
                                        border: thin solid #404040;
                                        font-weight: bold;
                                        vertical-align: middle;
                                        font-family: Franklin Gothic Book;`;
                                    
                    const noBorderCSS = `border: none;
                                    font-size: 13px;
                                    vertical-align: middle;
                                    font-family: Franklin Gothic Book;
                                    mso-number-format:'\@';`;
                    /****** end CSS ******/

                    // GBO
                    var gboHtml = "";
                    var gboInfo = {};

                    // GBR
                    var gbrHtml = "";
                    var gbrInfo = {};

                    // NTL
                    var ntlHtml = "";
                    var ntlInfo = {};

                    // Detailed (Per shipment)
                    var detailsBodyHTML = "";

                    docs.forEach(function(val,i){
                    val.destination[0] = val.destination[0] || {};
                    var origin = getGeofence(val.origin_id) || {},
                        destination = getGeofence(val.destination[0].location_id) || {},
                        vehicle = getVehicle(val.vehicle_id) || {},
                        remarks2 = "In CICO",
                        beforeCheckOutTime = getDateTime("entered_origin",val) || getDateTime("queueingAtOrigin",val) || getDateTime("processingAtOrigin",val) || getDateTime("idlingAtOrigin",val);

                    const queueingDuration = getDuration("queueingAtOrigin",val);
                    const processingDuration = getDuration("processingAtOrigin",val);
                    const idlingDuration = getDuration("idlingAtOrigin",val);

                    var calcCICO = (beforeCheckOutTime) ?  (getDateTime(clientCustom.status.enrouteToDestination,val,"last") - beforeCheckOutTime) : 0;

                    const cico = Number(DATETIME.DH(calcCICO || 0,null,"0"));
                    const cappedCICO = (cico > 5) ? 5 : cico;

                    if(cico != null){
                        const key = origin.short_name;

                        gboInfo[key] = gboInfo[key] || {
                            totalShipments: 0,

                            cico: 0,
                            cappedCICO: 0,
                            totalWithCICO: 0,

                            over_cico: 0,
                            w_in_cico: 0,

                            queueingDuration: 0,
                            totalWithQueueingDuration: 0,

                            processingDuration: 0,
                            totalWithProcessingDuration: 0,

                            idlingDuration: 0,
                            totalWithIdlingDuration: 0,
                        };

                        gboInfo[key].totalShipments++;

                        gboInfo[key].cico += cico;
                        gboInfo[key].cappedCICO += cappedCICO;
                        (cico) ? gboInfo[key].totalWithCICO ++ : null;

                        gboInfo[key].queueingDuration += queueingDuration;
                        (queueingDuration) ? gboInfo[key].totalWithQueueingDuration ++ : null;

                        gboInfo[key].processingDuration += processingDuration;
                        (processingDuration) ? gboInfo[key].totalWithProcessingDuration ++ : null;

                        gboInfo[key].idlingDuration += idlingDuration;
                        (idlingDuration) ? gboInfo[key].totalWithIdlingDuration ++ : null;

                        if(cico > origin.cico){
                            remarks2 = "Over CICO";
                            gboInfo[key].over_cico ++;
                        } else {
                            gboInfo[key].w_in_cico ++;
                        }
                    }



                    const cicoDifference = cico - Number(origin.cico);
                    const cicoVariance = (cicoDifference > 0) ? DATETIME.HH_MM(null,cicoDifference).hour_minute : "-";

                    detailsBodyHTML += `<tr>
                                            <td style="${noBorderCSS}text-align: left;">${val._id}</td>
                                            <td style="${noBorderCSS}text-align: center;">${(vehicle.name || "")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${(val.trailer || vehicle["Trailer"] || "")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${(vehicle["Pal Cap"] || "")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${origin.short_name}</td>
                                            <td style="${noBorderCSS}text-align: center;">${destination.short_name}</td>
                                            <td style="${noBorderCSS}text-align: center;">${val.route}</td>
                                            <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(beforeCheckOutTime,"MM/DD/YYYY")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(beforeCheckOutTime,"H:mm")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(val.departure_date,"MM/DD/YYYY")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(val.departure_date,"H:mm")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${queueingDuration ? DATETIME.HH_MM(queueingDuration).hour_minute : "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${processingDuration ? DATETIME.HH_MM(processingDuration).hour_minute : "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${idlingDuration ? DATETIME.HH_MM(idlingDuration).hour_minute : "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${cico ? DATETIME.HH_MM(null,cico).hour_minute : "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${cappedCICO ? DATETIME.HH_MM(null,cappedCICO).hour_minute : "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${DATETIME.HH_MM(null,origin.cico).hour_minute}</td>
                                            <td style="${noBorderCSS}text-align: center;">${cicoVariance}</td>
                                            <td style="${noBorderCSS}text-align: center;">${vehicle["Base Site"]}</td>
                                            <td style="${noBorderCSS}text-align: center;">${remarks2}</td>
                                        </tr>`;
                    });
                    // GBO
                    const filteredGeofences = LIST["geofences"].filter(x => x.code);
                    const sortedGeofences = ARRAY.OBJECT.sort(filteredGeofences,"short_name",{ sortType: "asc" });
                    sortedGeofences.forEach(gVal => {

                        const val = gboInfo[gVal.short_name] || {};

                        const aveCICO = val.cico/val.totalWithCICO;
                        const aveCappedCICO = val.cappedCICO/val.totalWithCICO;
                        const cicoDifference = aveCappedCICO - Number(gVal.cico);
                        const cicoVariance = (cicoDifference > 0) ? DATETIME.HH_MM(null,cicoDifference).hour_minute : "-";

                        const aveQueueingDuration = val.queueingDuration/val.totalWithQueueingDuration;
                        const aveProcessingDuration = val.processingDuration/val.totalWithProcessingDuration;
                        const aveIdlingDuration = val.idlingDuration/val.totalWithIdlingDuration;

                        const region = getRegion(gVal.region_id) || {}; 

                        const remarks = (aveCICO > Number(gVal.cico)) ? "Over CICO" : "In CICO";

                        gboHtml += `<tr>
                                        <td style="${noBorderCSS}">${gVal.short_name}</td>
                                        <td style="${noBorderCSS}text-align: center;">${gVal.code || "-"}</td>
                                        <td style="${noBorderCSS}text-align: center;">${cluster.cluster || "-"}</td>
                                        <td style="${noBorderCSS}text-align: center;">${aveCICO ? DATETIME.HH_MM(null,aveCICO).hour_minute : "-"}</td>
                                        <td style="${noBorderCSS}text-align: center;">${aveCappedCICO ? DATETIME.HH_MM(null,aveCappedCICO).hour_minute : "-"}</td>
                                        <td style="${noBorderCSS}text-align: center;">${DATETIME.HH_MM(null,gVal.cico,"-").hour_minute}</td>
                                        <td style="${noBorderCSS}text-align: center;">${cicoVariance}</td>
                                        <td style="${noBorderCSS}text-align: center;">${aveQueueingDuration ? DATETIME.HH_MM(aveQueueingDuration).hour_minute : "-"}</td>
                                        <td style="${noBorderCSS}text-align: center;">${aveProcessingDuration ? DATETIME.HH_MM(aveProcessingDuration).hour_minute : "-"}</td>
                                        <td style="${noBorderCSS}text-align: center;">${aveIdlingDuration ? DATETIME.HH_MM(aveIdlingDuration).hour_minute : "-"}</td>
                                        <td style="${noBorderCSS}text-align: center;">${val.totalShipments || "-"}</td>
                                        <td style="${noBorderCSS}text-align: center;">${aveCICO ? remarks : "-"}</td>
                                    </tr>`;

                        if(gboInfo[gVal.short_name]) {

                            gbrInfo[gVal.region_id] = gbrInfo[gVal.region_id] || {
                                totalShipments: 0,

                                cico: 0,
                                cappedCICO: 0,
                                totalWithCICO: 0,

                                targetCICO: 0,

                                queueingDuration: 0,
                                totalWithQueueingDuration: 0,

                                processingDuration: 0,
                                totalWithProcessingDuration: 0,

                                idlingDuration: 0,
                                totalWithIdlingDuration: 0
                            };

                            gbrInfo[gVal.region_id].totalShipments += val.totalShipments;

                            gbrInfo[gVal.region_id].cico += aveCICO || 0;
                            gbrInfo[gVal.region_id].cappedCICO += aveCappedCICO || 0;
                            (val.cico) ? gbrInfo[gVal.region_id].totalWithCICO ++ : null;

                            gbrInfo[gVal.region_id].targetCICO += Number(gVal.cico) || 0;
                            
                            gbrInfo[gVal.region_id].queueingDuration += aveQueueingDuration || 0;
                            (aveQueueingDuration) ? gbrInfo[gVal.region_id].totalWithQueueingDuration ++ : null;
                            
                            gbrInfo[gVal.region_id].processingDuration += aveProcessingDuration || 0;
                            (aveProcessingDuration) ? gbrInfo[gVal.region_id].totalWithProcessingDuration ++ : null;

                            gbrInfo[gVal.region_id].idlingDuration += aveIdlingDuration || 0;
                            (aveIdlingDuration) ? gbrInfo[gVal.region_id].totalWithIdlingDuration ++ : null;

                        }
                    });
                    // GBR
                    const sortedRegions = ARRAY.OBJECT.sort(LIST["regions"],"sequence",{ sortType: "asc" });
                    sortedRegions.forEach(rVal => {

                        const val = gbrInfo[rVal._id] || {};

                        const aveCICO = val.cico/val.totalWithCICO;
                        const aveCappedCICO = val.cappedCICO/val.totalWithCICO;

                        const aveTargetCICO = val.targetCICO/val.totalWithCICO;

                        const cicoDifference = aveCICO - aveTargetCICO;
                        const cicoVariance = (cicoDifference > 0) ? DATETIME.HH_MM(null,cicoDifference).hour_minute : "-";

                        const aveQueueingDuration = val.queueingDuration/val.totalWithQueueingDuration;
                        const aveProcessingDuration = val.processingDuration/val.totalWithProcessingDuration;
                        const aveIdlingDuration = val.idlingDuration/val.totalWithIdlingDuration;

                        const remarks = (aveCICO > aveTargetCICO) ? "Over CICO" : "In CICO";

                        gbrHtml += `<tr>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;">${rVal.name || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${rVal.code || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;"> </td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${aveCICO ? DATETIME.HH_MM(null,aveCICO).hour_minute : "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${aveCappedCICO ? DATETIME.HH_MM(null,aveCappedCICO).hour_minute : "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${aveTargetCICO ? DATETIME.HH_MM(null,aveTargetCICO).hour_minute : "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${cicoVariance}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${aveQueueingDuration ? DATETIME.HH_MM(aveQueueingDuration).hour_minute : "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${aveProcessingDuration ? DATETIME.HH_MM(aveProcessingDuration).hour_minute : "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${aveIdlingDuration ? DATETIME.HH_MM(aveIdlingDuration).hour_minute : "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${val.totalShipments || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${aveCICO ? remarks : "-"}</td>
                                    </tr>`;

                        ntlInfo["ph"] = ntlInfo["ph"] || {
                            totalShipments: 0,

                            cico: 0,
                            cappedCICO: 0,
                            totalWithCICO: 0,

                            targetCICO: 0,

                            queueingDuration: 0,
                            totalWithQueueingDuration: 0,

                            processingDuration: 0,
                            totalWithProcessingDuration: 0,

                            idlingDuration: 0,
                            totalWithIdlingDuration: 0
                        };

                        ntlInfo["ph"].totalShipments += val.totalShipments || 0;

                        ntlInfo["ph"].cico += aveCICO || 0;
                        ntlInfo["ph"].cappedCICO += aveCappedCICO || 0;
                        (aveCICO) ? ntlInfo["ph"].totalWithCICO ++ : null;

                        ntlInfo["ph"].targetCICO += aveTargetCICO || 0;
                        
                        ntlInfo["ph"].queueingDuration += aveQueueingDuration || 0;
                        (aveQueueingDuration) ? ntlInfo["ph"].totalWithQueueingDuration ++ : null;

                        ntlInfo["ph"].processingDuration += aveProcessingDuration || 0;
                        (aveProcessingDuration) ? ntlInfo["ph"].totalWithProcessingDuration ++ : null;

                        ntlInfo["ph"].idlingDuration += aveIdlingDuration || 0;
                        (aveIdlingDuration) ? ntlInfo["ph"].totalWithIdlingDuration ++ : null;
                    });

                    console.log("ntlInfo",ntlInfo);

                    // NTL
                    const ntlVal = ntlInfo["ph"] || {};

                    const ntlAveCICO = ntlVal.cico/ntlVal.totalWithCICO;
                    const ntlAveCappedCICO = ntlVal.cappedCICO/ntlVal.totalWithCICO;
                    const ntlAveTargetCICO = ntlVal.targetCICO/ntlVal.totalWithCICO;

                    const ntlCicoDifference = ntlAveCappedCICO - ntlAveTargetCICO;
                    const ntlCicoVariance = (ntlCicoDifference > 0) ? DATETIME.HH_MM(null,ntlCicoDifference).hour_minute : "-";

                    const ntlAveQueueingDuration = ntlVal.queueingDuration/ntlVal.totalWithQueueingDuration;
                    const ntlAveProcessingDuration = ntlVal.processingDuration/ntlVal.totalWithProcessingDuration;
                    const ntlAveIdlingDuration = ntlVal.idlingDuration/ntlVal.totalWithIdlingDuration;

                    const ntlRemarks = (ntlAveCICO > ntlAveTargetCICO) ? "Over CICO" : "In CICO";

                    ntlHtml += `<tr>
                                <td style="${noBorderCSS}background-color:#FFE1E1;">NATIONAL</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">NAT</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;"> </td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlAveCICO ? DATETIME.HH_MM(null,ntlAveCICO).hour_minute : "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlAveCappedCICO ? DATETIME.HH_MM(null,ntlAveCappedCICO).hour_minute : "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlAveTargetCICO ? DATETIME.HH_MM(null,ntlAveTargetCICO).hour_minute : "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlCicoVariance}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlAveQueueingDuration ? DATETIME.HH_MM(ntlAveQueueingDuration).hour_minute : "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlAveProcessingDuration ? DATETIME.HH_MM(ntlAveProcessingDuration).hour_minute : "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlAveIdlingDuration ? DATETIME.HH_MM(ntlAveIdlingDuration).hour_minute : "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlVal.totalShipments || "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlAveCICO ? ntlRemarks : "-"}</td>
                            </tr>`;
                            

                    // to be exported to file
                    return `<table id="report-hidden" style="opacity:0;">
                            <tr>
                                <td style="${noBorderCSS}" colspan=2>Report name: <b style="color:#c00000;">${title}</b></td>
                            </tr>
                            <tr><td style="${noBorderCSS}" colspan=2></td></tr>
                            <tr>
                                <td style="${noBorderCSS}" colspan=2>Date Info:</td>
                            </tr>
                            <tr>
                                <td style="${noBorderCSS}" colspan=2>
                                    <div>
                                        <div>Date from: ${moment(new Date(date_from)).format("MM/DD/YYYY hh:mm A")}</div>
                                        <div>Date to: ${moment(new Date(date_to)).format("MM/DD/YYYY hh:mm A")}</div>
                                        <div>&nbsp;</div>
                                        <div>Generated on: ${moment(new Date()).format("MM/DD/YYYY hh:mm A")}</div>
                                    </div>
                                </td>
                            </tr>
                            <tr><td style="${noBorderCSS}" colspan=2></td></tr>
                            ${
                                REPORTS.columnHtml( 
                                    ['origin_1','originSiteCode','originRegion','actualCICOAve','cicoWithCappingAve','cicoTarget','cicoVariance','queueingDurationAve','processingDurationAve','idlingDurationAve','shipmentCount_All','remarksCicoAve'],
                                    rotateCSS,
                                    tblHeaderCSS
                                )
                            }
                            ${gboHtml}
                            <tr><td style="${noBorderCSS}"></td></tr>
                            ${ntlHtml}
                            ${gbrHtml}
                            <tr><td style="${noBorderCSS}"></td></tr>
                            <tr><td style="${noBorderCSS}"></td></tr>
                            <tr>
                                <td style="${noBorderCSS}"><b>Details:</b></td>
                            </tr>
                            <tr><td style="${noBorderCSS}"></td></tr>
                            ${
                                REPORTS.columnHtml( 
                                    ['shipment','vehicle','trailer','palCap','origin','destination','route','checkInDate','checkInTime','checkOutDate','checkOutTime','queueingDuration','processingDuration','idlingDuration','actualCICO','cicoWithCapping','cicoTarget','cicoVariance','vehicleBaseSite','remarksCico'],
                                    rotateCSS,
                                    tblHeaderCSS
                                )
                            }
                            ${detailsBodyHTML}
                        </table> `;
                },
                coket2: ( title, docs, originChosen, date_from, date_to ) => { 
                    return REPORTS.UI.REPORTS.cicor.wilcon( title, docs, originChosen, date_from, date_to );
                },
                wilcon: ( title, docs, originChosen, date_from, date_to ) => {
                    // var arr = ["destination","origin","route","sn","plate_num","trailer","pal_cap","hauler_name","cico_target","actual_timelapse","remarks1","remarks2","base_plant"];
                    var details = "",
                        summary = "",
                        summary_info = {},
                        summary_total = {
                            in_site: 0,
                            over_cico: 0,
                            w_in_cico: 0,
                            count_time_lapse: 0,
                            sum_time_lapse: 0,
                            count_cico: 0,
                            sum_cico: 0
                        },
                        detailsHeaderHTML = "",
                        detailsBodyHTML = "",
                        textCellStyle = `border:2px solid black;mso-number-format:'\@';`,
                        columns = clientCustom.reports.cicor || [];
                    columns.forEach(_val_ => {
                        switch (_val_) {
                            case "origin":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Origin (Plant)</td>`;
                                break;
                            case "destination":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Destination (DC)</td>`;
                                break;
                            case "route":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Route</td>`;
                                break;
                            case "sn":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">SN</td>`;
                                break;
                            case "plateNumber":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Plate No.</td>`;
                                break;
                            case "trailer":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Trailer</td>`;
                                break;
                            case "palCap":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Pal Cap</td>`;
                                break;
                            case "haulerName":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Hauler Name</td>`;
                                break;
                            case "targetCico":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Target CICO (hrs)</td>`;
                                break;
                            case "actualTimelapse":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Actual Time Lapse (hrs)</td>`;
                                break;
                            case "remarks1":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Remarks1</td>`;
                                break;
                            case "remarks2":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Remarks2</td>`;
                                break;
                            case "truckBasePlant":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Truck Base Plant</td>`;
                                break;
                            default:
                                break;
                        }
                    });

                    docs.forEach(function(val,i){
                        val.destination[0] = val.destination[0] || {};
                        var cico_time,actual_time_lapse = null,
                            remarks2Class = "",
                            origin = getGeofence(val.origin_id) || {},
                            destination = getGeofence(val.destination[0].location_id) || {},
                            vehicle = getVehicle(val.vehicle_id) || {},
                            orig_dest = `${origin.short_name}_${destination.short_name}`,
                            remarks2 = "w/in CICO Time",
                            beforeCheckOutTime = getDateTime("entered_origin",val) || getDateTime("queueingAtOrigin",val) || getDateTime("processingAtOrigin",val) || getDateTime("idlingAtOrigin",val);

                        var calcCICO = (beforeCheckOutTime) ?  (getDateTime("in_transit",val,"last") - beforeCheckOutTime) : 0;
                        cico_time = calcCICO || 0;

                        actual_time_lapse = Number(DATETIME.DH(cico_time,null,"0"));

                        if(!summary_info[orig_dest]){
                            summary_info[orig_dest] = {
                                destination:destination.short_name,
                                origin:origin.short_name,
                                in_site:1,
                                over_cico:0,
                                w_in_cico:0,
                                sum_time_lapse: actual_time_lapse,
                                count_time_lapse: (actual_time_lapse != null) ? 1 : 0,
                                cico_target: destination.cico || 0,
                            };
                        } else {
                            summary_info[orig_dest].in_site++;
                            if(actual_time_lapse != null){
                                summary_info[orig_dest].sum_time_lapse = summary_info[orig_dest].sum_time_lapse || 0; // in case value is null

                                summary_info[orig_dest].count_time_lapse++;
                                summary_info[orig_dest].sum_time_lapse += actual_time_lapse;
                            }
                        }
                        if(actual_time_lapse != null) {
                            if(actual_time_lapse > destination.cico){
                                remarks2Class = "background-color:#ffc7ce;color:#9c0006";
                                remarks2 = "Over CICO Time";
                                summary_info[orig_dest].over_cico ++;
                            } else {
                                summary_info[orig_dest].w_in_cico ++;
                            }
                        }

                        detailsBodyHTML += `<tr>`;
                        columns.forEach(_val_ => {
                            switch (_val_) {
                                case "destination":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${destination.short_name}</td>`;
                                    break;
                                case "origin":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${origin.short_name}</td>`;
                                    break;
                                case "route":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${val.route}</td>`;
                                    break;
                                case "sn":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${val._id}</td>`;
                                    break;
                                case "plateNumber":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${(vehicle.name || "")}</td>`;
                                    break;
                                case "trailer":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${(vehicle["Trailer"] || "")}</td>`;
                                    break;
                                case "palCap":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${(vehicle["Pal Cap"] || "")}</td>`;
                                    break;
                                case "haulerName":
                                    detailsBodyHTML += `<td style="${textCellStyle}"></td>`;
                                    break;
                                case "targetCico":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${DATETIME.HH_MM(null,destination.cico).hour_minute}</td>`;
                                    break;
                                case "actualTimelapse":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${DATETIME.HH_MM(null,actual_time_lapse).hour_minute}</td>`;
                                    break;
                                case "remarks1":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${(val.remarks || "")}</td>`;
                                    break;
                                case "remarks2":
                                    detailsBodyHTML += `<td style="${textCellStyle}${remarks2Class}">${remarks2}</td>`;
                                    break;
                                case "truckBasePlant":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${(vehicle["Site"] || "")}</td>`;
                                    break;
                                default:
                                    break;
                            }
                        });
                        detailsBodyHTML += `</tr>`;
                    });
                    Object.values(summary_info).forEach(val => {
                        var ave_time_lapse = val.sum_time_lapse/val.count_time_lapse;
                        summary += `<tr>
                                        <td style="${textCellStyle}">${val.destination}</td>
                                        <td style="${textCellStyle}">${val.origin}</td>
                                        <td style="${textCellStyle}">${val.in_site}</td>
                                        <td style="${textCellStyle}">${val.over_cico}</td>
                                        <td style="${textCellStyle}">${val.w_in_cico}</td>
                                        <td style="${textCellStyle}">${DATETIME.HH_MM(null,ave_time_lapse).hour_minute}</td>
                                        <td style="${textCellStyle}">${DATETIME.HH_MM(null,val.cico_target).hour_minute}</td>
                                    </tr>`;
                        summary_total.in_site += val.in_site;
                        summary_total.over_cico += val.over_cico;
                        summary_total.w_in_cico += val.w_in_cico;
                        summary_total.count_cico ++;
                        summary_total.sum_cico += Number(val.cico_target);
                        if(val.sum_time_lapse != null){
                            summary_total.count_time_lapse ++;
                            summary_total.sum_time_lapse += val.sum_time_lapse;
                        }
                    });
                    summary_total.ave_time_lapse = summary_total.sum_time_lapse/summary_total.count_time_lapse;
                    summary_total.ave_cico = summary_total.sum_cico/summary_total.count_cico;
                    console.log("summary_total",summary_total);
                    summary += `<tr>
                                    <td style="${textCellStyle}font-weight: bold;" colspan=2>TOTAL</td>
                                    <td style="${textCellStyle}font-weight: bold;">${(summary_total.in_site || 0)}</td>
                                    <td style="${textCellStyle}font-weight: bold;">${(summary_total.over_cico || 0)}</td>
                                    <td style="${textCellStyle}font-weight: bold;">${(summary_total.w_in_cico || 0)}</td>
                                    <td style="${textCellStyle}font-weight: bold;">${DATETIME.HH_MM(null,summary_total.ave_time_lapse).hour_minute}</td>
                                    <td style="${textCellStyle}font-weight: bold;">${DATETIME.HH_MM(null,summary_total.ave_cico).hour_minute}</td>
                                </tr>`;

                    return `<table id="report-hidden" style="opacity:0;">
                                <tr>
                                    <td style="border: none;">Report name: <b style="color:#c00000;">${title}</b></td>
                                </tr>
                                <tr><td style="border: none;"></td></tr>
                                <tr>
                                    <td style="border: none;"><b>Summary:</b></td>
                                </tr>
                                <tr>
                                    <td style="border: none;">
                                        <div>
                                            <div>Plant Site: ${originChosen}</div>
                                            <div>Date from: ${moment(new Date(date_from)).format("MM/DD/YYYY hh:mm A")}</div>
                                            <div>Date to: ${moment(new Date(date_to)).format("MM/DD/YYYY hh:mm A")}</div>
                                            <div>&nbsp;</div>
                                            <div>Generated on: ${moment(new Date()).format("MM/DD/YYYY hh:mm A")}</div>
                                        </div>
                                    </td>
                                </tr>
                                <tr><td style="border: none;"></td></tr>
                                <tr>
                                    <td style="background-color:black;color:white;">Destination (DC)</td>
                                    <td style="background-color:black;color:white;">Origin (Plant)</td>
                                    <td style="background-color:black;color:white;">In Site</td>
                                    <td style="background-color:#757070;color:white;">Over CICO</td>
                                    <td style="background-color:#757070;color:white;">W/in CICO</td>
                                    <td style="background-color:black;color:white;">Ave. Time Lapse (hrs)</td>
                                    <td style="background-color:black;color:white;">CICO Target (hrs)</td>
                                </tr>
                                ${summary}
                                <tr><td style="border: none;"></td></tr>
                                <tr>
                                    <td style="border: none;"><b>Details:</b></td>
                                </tr>
                                <tr>${detailsHeaderHTML}</tr>
                                ${detailsBodyHTML}
                            </table> `;
                }
            },
            otr: {
                coket1: ( title, docs, originChosen, date_from, date_to ) => {
                    // Legend:
                    //    · GBO - Grouped by Origin
                    //    · GBR - Grouped by Region
                    //    · NTL - National

                    /****** CSS ******/
                    const rotateCSS = ` -webkit-transform: rotate(-90deg);
                                        -moz-transform: rotate(-90deg);
                                        -ms-transform: rotate(-90deg);
                                        -o-transform: rotate(-90deg);
                                        transform: rotate(-90deg);
                                        mso-rotate: 90;
                                        -webkit-transform-origin: 50% 50%;
                                        -moz-transform-origin: 50% 50%;
                                        -ms-transform-origin: 50% 50%;
                                        -o-transform-origin: 50% 50%;
                                        transform-origin: 50% 50%;
                                        position: absolute;
                                        filter: progid:DXImageTransform.Microsoft.BasicImage(rotation=3);
                                        
                                        color: #595959;
                                        background-color: #E2EFDA;
                                        height: 127px;
                                        border: none;
                                        border-right: thin dashed #595959;`;

                    const tblHeaderCSS = `  background-color: #404040;
                                        color: white;
                                        font-size: 13px;
                                        text-align: center;
                                        border: thin solid #404040;
                                        font-weight: bold;
                                        vertical-align: middle;
                                        font-family: Franklin Gothic Book;`;
                                    
                    const noBorderCSS = `border: none;
                                    font-size: 13px;
                                    vertical-align: middle;
                                    font-family: Franklin Gothic Book;
                                    mso-number-format:'\@';`;
                    /****** end CSS ******/

                    // GBO
                    var gboHtml = "";
                    var gboInfo = {};

                    // GBR
                    var gbrHtml = "";
                    var gbrInfo = {};

                    // NTL
                    var ntlHtml = "";
                    var ntlInfo = {};

                    // Detailed (Per shipment)
                    var detailsBodyHTML = "";

                    docs.forEach(function(val,i){
                    val.destination[0] = val.destination[0] || {};
                    var origin = getGeofence(val.origin_id) || {},
                        destination = getGeofence(val.destination[0].location_id) || {},
                        vehicle = getVehicle(val.vehicle_id) || {};

                    const completeDateTime = getDateTime("complete",val,"last");

                    const transitDuration = getDuration("in_transit",val);
                    const estTransitDuration = (getRoute(val.route) || {}).transit_time;

                    const dhTransitDuration = DATETIME.DH(transitDuration);
                    const lapseTime = dhTransitDuration - estTransitDuration;

                    const isOverTransit = dhTransitDuration > estTransitDuration;
                    const remarks = isOverTransit ? "Over Transit" : "-";

                    const key = vehicle["Base Site Code"];

                    gboInfo[key] = gboInfo[key] || {
                        totalShipments: 0,

                        over_transit: 0,
                        w_in_transit: 0,

                        transitDuration: 0,
                        totalWithTransitDuration: 0,

                        lapseTime: 0,
                        totalWithLapseTime: 0,
                    };

                    gboInfo[key].totalShipments++;
                    (isOverTransit) ? gboInfo[key].over_transit ++ :  gboInfo[key].w_in_transit ++;

                    gboInfo[key].transitDuration += transitDuration;
                    (transitDuration) ? gboInfo[key].totalWithTransitDuration ++ : null;

                    (lapseTime > 0) ? gboInfo[key].lapseTime += lapseTime || 0 : null;
                    (lapseTime > 0) ? gboInfo[key].totalWithLapseTime ++ : null;

                    detailsBodyHTML += `<tr>
                                            <td style="${noBorderCSS}text-align: left;">${val._id}</td>
                                            <td style="${noBorderCSS}text-align: center;">${(vehicle.name || "")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${(val.trailer || vehicle["Trailer"] || "")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${(vehicle["Pal Cap"] || "")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${(vehicle["Base Site"] || "")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${(vehicle["Base Site Code"] || "")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${origin.short_name}</td>
                                            <td style="${noBorderCSS}text-align: center;">${destination.short_name}</td>
                                            <td style="${noBorderCSS}text-align: center;">${val.route}</td>
                                            <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(val.departure_date,"MM/DD/YYYY")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(val.departure_date,"H:mm")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(completeDateTime,"MM/DD/YYYY")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(completeDateTime,"H:mm")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${transitDuration ? DATETIME.HH_MM(transitDuration).hour_minute : "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${estTransitDuration ? DATETIME.HH_MM(null,estTransitDuration).hour_minute : "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${lapseTime > 0 ? DATETIME.HH_MM(null,lapseTime).hour_minute : "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${remarks}</td>
                                        </tr>`;
                    });

                    // GBO
                    const filteredGeofences = LIST["geofences"].filter(x => x.code);
                    const sortedGeofences = ARRAY.OBJECT.sort(filteredGeofences,"short_name",{ sortType: "asc" });
                    sortedGeofences.forEach(gVal => {

                        const val = gboInfo[gVal.code] || {};

                        const truckInventory = LIST['vehicles'].filter(x => x['Base Site Code'] == gVal.code).length;

                        const aveTransitDuration = val.transitDuration/val.totalWithTransitDuration;
                        const aveLapseTime = val.lapseTime/val.totalWithLapseTime;

                        const region = getRegion(gVal.region_id) || {}; 

                        if(truckInventory){
                            gboHtml += `<tr>
                                            <td style="${noBorderCSS}">${gVal.short_name}</td>
                                            <td style="${noBorderCSS}text-align: center;">${gVal.code || "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${region.code || "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${val.totalShipments || "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${val.w_in_transit || 0}</td>
                                            <td style="${noBorderCSS}text-align: center;">${val.over_transit || 0}</td>
                                            <td style="${noBorderCSS}text-align: center;">${aveTransitDuration ? DATETIME.HH_MM(aveTransitDuration).hour_minute : "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${aveLapseTime > 0 ? DATETIME.HH_MM(null,aveLapseTime).hour_minute : "-"}</td>
                                        </tr>`;
                        }

                        gbrInfo[gVal.region_id] = gbrInfo[gVal.region_id] || {
                            totalShipments: 0,

                            over_transit: 0,
                            w_in_transit: 0,
    
                            transitDuration: 0,
                            totalWithTransitDuration: 0,
    
                            lapseTime: 0,
                            totalWithLapseTime: 0,
                        };

                        gbrInfo[gVal.region_id].totalShipments += val.totalShipments || 0;
                        
                        gbrInfo[gVal.region_id].over_transit += val.over_transit || 0;
                        gbrInfo[gVal.region_id].w_in_transit += val.w_in_transit || 0;
    
                        (aveTransitDuration) ? gbrInfo[gVal.region_id].transitDuration += aveTransitDuration || 0 : null;
                        (aveTransitDuration) ? gbrInfo[gVal.region_id].totalWithTransitDuration ++ : null;
    
                        (aveLapseTime > 0) ? gbrInfo[gVal.region_id].lapseTime += aveLapseTime || 0 : null;
                        (aveLapseTime) ? gbrInfo[gVal.region_id].totalWithLapseTime ++ : null;
                    });

                    // GBR
                    const sortedRegions = ARRAY.OBJECT.sort(LIST["regions"],"sequence",{ sortType: "asc" });
                    sortedRegions.forEach(rVal => {

                        const val = gbrInfo[rVal._id] || {};

                        const aveTransitDuration = val.transitDuration/val.totalWithTransitDuration;
                        const aveLapseTime = val.lapseTime/val.totalWithLapseTime;

                        gbrHtml += `<tr>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;">${rVal.name || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${rVal.code || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;"> </td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${val.totalShipments || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${val.w_in_transit || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${val.over_transit || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${aveTransitDuration ? DATETIME.HH_MM(aveTransitDuration).hour_minute : "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${aveLapseTime > 0 ? DATETIME.HH_MM(null,aveLapseTime).hour_minute : "-"}</td>
                                    </tr>`;

                        ntlInfo["ph"] = ntlInfo["ph"] || {
                            totalShipments: 0,

                            over_transit: 0,
                            w_in_transit: 0,
    
                            transitDuration: 0,
                            totalWithTransitDuration: 0,
    
                            lapseTime: 0,
                            totalWithLapseTime: 0,
                        };

                        ntlInfo["ph"].totalShipments += val.totalShipments || 0;
                        
                        ntlInfo["ph"].over_transit += val.over_transit || 0;
                        ntlInfo["ph"].w_in_transit += val.w_in_transit || 0;
    
                        (aveTransitDuration) ? ntlInfo["ph"].transitDuration += aveTransitDuration || 0 : null;
                        (aveTransitDuration) ? ntlInfo["ph"].totalWithTransitDuration ++ : null;
    
                        (aveLapseTime > 0) ? ntlInfo["ph"].lapseTime += aveLapseTime || 0 : null;
                        (aveLapseTime > 0) ? ntlInfo["ph"].totalWithLapseTime ++ : null;
                    });

                    console.log("ntlInfo",ntlInfo);

                    // NTL
                    const ntlVal = ntlInfo["ph"] || {};

                    const aveTransitDuration = ntlVal.transitDuration/ntlVal.totalWithTransitDuration;
                    const aveLapseTime = ntlVal.lapseTime/ntlVal.totalWithLapseTime;

                    ntlHtml += `<tr>
                                <td style="${noBorderCSS}background-color:#FFE1E1;">NATIONAL</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">NAT</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;"> </td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlVal.totalShipments || "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlVal.w_in_transit || "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlVal.over_transit || "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${aveTransitDuration ? DATETIME.HH_MM(aveTransitDuration).hour_minute : "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${aveLapseTime > 0 ? DATETIME.HH_MM(null,aveLapseTime).hour_minute : "-"}</td>
                            </tr>`;
                            

                    // to be exported to file
                    
                    return `<table id="report-hidden" style="opacity:0;">
                                <tr>
                                    <td style="${noBorderCSS}" colspan=2>Report name: <b style="color:#c00000;">${title}</b></td>
                                </tr>
                                <tr><td style="${noBorderCSS}" colspan=2></td></tr>
                                <tr>
                                    <td style="${noBorderCSS}" colspan=2>Date Info:</td>
                                </tr>
                                <tr>
                                    <td style="${noBorderCSS}" colspan=2>
                                        <div>
                                            <div>Date from: ${moment(new Date(date_from)).format("MM/DD/YYYY hh:mm A")}</div>
                                            <div>Date to: ${moment(new Date(date_to)).format("MM/DD/YYYY hh:mm A")}</div>
                                            <div>&nbsp;</div>
                                            <div>Generated on: ${moment(new Date()).format("MM/DD/YYYY hh:mm A")}</div>
                                        </div>
                                    </td>
                                </tr>
                                <tr><td style="${noBorderCSS}" colspan=2></td></tr>
                                ${
                                    REPORTS.columnHtml( 
                                        ['baseSite','baseSiteCode','baseSiteRegion','shipmentCount_CheckedOut','withinTransitDuration','overTransitDuration','transitDurationAve','lapseTimeAve'],
                                        rotateCSS,
                                        tblHeaderCSS
                                    )
                                }
                                ${gboHtml}
                                <tr><td style="${noBorderCSS}"></td></tr>
                                ${ntlHtml}
                                ${gbrHtml}
                                <tr><td style="${noBorderCSS}"></td></tr>
                                <tr><td style="${noBorderCSS}"></td></tr>
                                <tr>
                                    <td style="${noBorderCSS}"><b>Details:</b></td>
                                </tr>
                                <tr><td style="${noBorderCSS}"></td></tr>
                                ${
                                    REPORTS.columnHtml( 
                                        ['shipment','vehicle','trailer','palCap','baseSite','baseSiteCode','origin','destination','route','checkOutDate','checkOutTime','completionDate','completionTime','transitDuration','estTransitDuration','lapseTime','remarksTransit'],
                                        rotateCSS,
                                        tblHeaderCSS
                                    )
                                }
                                ${detailsBodyHTML}
                            </table> `;
                },
                coket2: ( title, docs, originChosen, date_from, date_to ) => { 
                    return REPORTS.UI.REPORTS.otr.wilcon( title, docs, originChosen, date_from, date_to );
                },
                wilcon: ( title, docs, originChosen, date_from, date_to ) => {
                    var summary = "",
                        summary_info = {},
                        summary_total = {
                            in_site: 0,
                            over_transit: 0,
                            w_in_transit: 0,
                            sum_time_lapse: 0,
                            count_time_lapse: 0,
                            count_transit: 0,
                            sum_transit: 0
                        },
                        textCellStyle = `border:2px solid black;mso-number-format:'\@';`,
                        detailsHeaderHTML = "",
                        detailsBodyHTML = "",
                        columns = clientCustom.reports.otr || [];
                    columns.forEach(_val_ => {
                        switch (_val_) {
                            case "origin":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Origin (Plant)</td>`;
                                break;
                            case "destination":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Destination (DC)</td>`;
                                break;
                            case "route":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Route</td>`;
                                break;
                            case "sn":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">SN</td>`;
                                break;
                            case "plateNumber":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Plate No.</td>`;
                                break;
                            case "trailer":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Trailer</td>`;
                                break;
                            case "palCap":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Pal Cap</td>`;
                                break;
                            case "haulerName":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Hauler Name</td>`;
                                break;
                            case "targetTransit":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Target Transit (hrs)</td>`;
                                break;
                            case "actualTimelapse":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Actual Time Lapse (hrs)</td>`;
                                break;
                            case "remarks1":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Remarks1</td>`;
                                break;
                            case "remarks2":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Remarks2</td>`;
                                break;
                            case "truckBasePlant":
                                detailsHeaderHTML += `<td style="background-color:black;color:white;">Truck Base Plant</td>`;
                                break;
                            default:
                                break;
                        }
                    });
                        
                    docs.forEach(function(val,i){
                        var transit_time = getDuration("in_transit",val),
                            actual_time_lapse,
                            remarks2Class = "",
                            origin = getGeofence(val.origin_id) || {},
                            destination = getGeofence(val.destination[0].location_id) || {},
                            route = LIST["routes"].find(x => x.origin_id == origin._id && x.destination_id == destination._id) || {},
                            vehicle = getVehicle(val.vehicle_id) || {},
                            orig_dest = `${origin.short_name}_${destination.short_name}`,
                            remarks2 = "w/in Transit Time";
                            
                        if(transit_time){
                            actual_time_lapse = Number(DATETIME.DH(transit_time,null,"0"));
                        } else {
                            actual_time_lapse = null;
                        }
    
                        if(!summary_info[orig_dest]){
                            summary_info[orig_dest] = {
                                destination:destination.short_name,
                                origin:origin.short_name,
                                in_site:1,
                                over_transit:0,
                                w_in_transit:0,
                                count_time_lapse: (actual_time_lapse) ? 1 : 0,
                                sum_time_lapse: actual_time_lapse,
                                transit_target:route.transit_time || 0,
                            };
                        } else {
                            summary_info[orig_dest].in_site++;
                            if(actual_time_lapse != null){
                                summary_info[orig_dest].count_time_lapse++;
                                summary_info[orig_dest].sum_time_lapse += actual_time_lapse;
                            }
                        }
                        if(actual_time_lapse != null) {
                            if(actual_time_lapse > route.transit_time){
                                remarks2Class = "background-color:#ffc7ce;color:#9c0006";
                                remarks2 = "Over Transit Time";
                                summary_info[orig_dest].over_transit ++;
                            } else {
                                summary_info[orig_dest].w_in_transit ++;
                            }
                        }
    
                        detailsBodyHTML += `<tr>`;
                        columns.forEach(_val_ => {
                            switch (_val_) {
                                case "origin":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${origin.short_name}</td>`;
                                    break;
                                case "destination":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${destination.short_name}</td>`;
                                    break;
                                case "route":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${val.route}</td>`;
                                    break;
                                case "sn":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${val._id}</td>`;
                                    break;
                                case "plateNumber":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${(vehicle.name || "")}</td>`;
                                    break;
                                case "trailer":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${(vehicle["Trailer"] || "")}</td>`;
                                    break;
                                case "palCap":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${(vehicle["Pal Cap"] || "")}</td>`;
                                    break;
                                case "haulerName":
                                    detailsBodyHTML += `<td style="${textCellStyle}"></td>`;
                                    break;
                                case "targetTransit":
                                    detailsBodyHTML += `<td style="${textCellStyle}mso-number-format:'\@';">${DATETIME.HH_MM(null,route.transit_time).hour_minute}</td>`;
                                    break;
                                case "actualTimelapse":
                                    detailsBodyHTML += `<td style="${textCellStyle}mso-number-format:'\@';">${DATETIME.HH_MM(null,actual_time_lapse).hour_minute}</td>`;
                                    break;
                                case "remarks1":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${(val.remarks || "")}</td>`;
                                    break;
                                case "remarks2":
                                    detailsBodyHTML += `<td style="${textCellStyle}${remarks2Class}">${remarks2}</td>`;
                                    break;
                                case "truckBasePlant":
                                    detailsBodyHTML += `<td style="${textCellStyle}">${(vehicle["Site"] || "")}</td>`;
                                    break;
                                default:
                                    break;
                            }
                        });
                        detailsBodyHTML += `</tr>`;
                    });
                    Object.values(summary_info).forEach(val => {
                        var ave_time_lapse = val.sum_time_lapse/val.count_time_lapse;
                        summary += `<tr>
                                        <td style="${textCellStyle}">${val.origin}</td>
                                        <td style="${textCellStyle}">${val.destination}</td>
                                        <td style="${textCellStyle}">${val.in_site}</td>
                                        <td style="${textCellStyle}">${val.over_transit}</td>
                                        <td style="${textCellStyle}">${val.w_in_transit}</td>
                                        <td style="${textCellStyle}">${DATETIME.HH_MM(null,ave_time_lapse).hour_minute}</td>
                                        <td style="${textCellStyle}">${DATETIME.HH_MM(null,val.transit_target).hour_minute}</td>
                                    </tr>`;
                        summary_total.in_site += val.in_site;
                        summary_total.over_transit += val.over_transit;
                        summary_total.w_in_transit += val.w_in_transit;
                        summary_total.count_transit ++;
                        summary_total.sum_transit += Number(val.transit_target);
    
                        if(val.sum_time_lapse != null){
                            summary_total.count_time_lapse ++;
                            summary_total.sum_time_lapse += ave_time_lapse;
                        }
                    });
                    summary_total.ave_time_lapse = summary_total.sum_time_lapse/summary_total.count_time_lapse;
                    summary_total.ave_transit = summary_total.sum_transit/summary_total.count_transit;
                    
                    summary += `<tr>
                                    <td style="${textCellStyle}font-weight: bold;" colspan=2>TOTAL</td>
                                    <td style="${textCellStyle}font-weight: bold;">${(summary_total.in_site || 0)}</td>
                                    <td style="${textCellStyle}font-weight: bold;">${(summary_total.over_transit || 0)}</td>
                                    <td style="${textCellStyle}font-weight: bold;">${(summary_total.w_in_transit || 0)}</td>
                                    <td style="${textCellStyle}font-weight: bold;">${DATETIME.HH_MM(null,summary_total.ave_time_lapse).hour_minute}</td>
                                    <td style="${textCellStyle}font-weight: bold;">${DATETIME.HH_MM(null,summary_total.ave_transit).hour_minute}</td>
                                </tr>`;
    
                    return `<table id="report-hidden" style="opacity:0;">
                                <tr>
                                    <td style="border: none;">Report name: <b style="color:#c00000;">${title}</b></td>
                                </tr>
                                <tr><td style="border: none;"></td></tr>
                                <tr>
                                    <td style="border: none;"><b>Summary:</b></td>
                                </tr>
                                <tr>
                                    <td style="border: none;">
                                        <div>
                                            <div>Plant Site: ${originChosen}</div>
                                            <div>Date from: ${moment(new Date(date_from)).format("MM/DD/YYYY hh:mm A")}</div>
                                            <div>Date to: ${moment(new Date(date_to)).format("MM/DD/YYYY hh:mm A")}</div>
                                            <div>&nbsp;</div>
                                            <div>Generated on: ${moment(new Date()).format("MM/DD/YYYY hh:mm A")}</div>
                                        </div>
                                    </td>
                                </tr>
                                <tr><td style="border: none;"></td></tr>
                                <tr>
                                    <td style="background-color:black;color:white;">Origin (Plant)</td>
                                    <td style="background-color:black;color:white;">Destination (DC)</td>
                                    <td style="background-color:black;color:white;">In Site</td>
                                    <td style="background-color:#757070;color:white;">Over Transit</td>
                                    <td style="background-color:#757070;color:white;">W/in Transit</td>
                                    <td style="background-color:black;color:white;">Ave. Time Lapse (hrs)</td>
                                    <td style="background-color:black;color:white;">Ave. Transit Target (hrs)</td>
                                </tr>
                                ${summary}
                                <tr><td style="border: none;"></td></tr>
                                <tr>
                                    <td style="border: none;"><b>Details:</b></td>
                                </tr>
                                <tr>${detailsHeaderHTML}</tr>
                                ${detailsBodyHTML}
                            </table> `;
                }
            },
            dr: {
                coket1: ( title, docs, originChosen, date_from, date_to ) => {
                    // Legend:
                    //    · GBO - Grouped by Origin
                    //    · GBR - Grouped by Region
                    //    · NTL - National

                    /****** CSS ******/
                    const rotateCSS = ` -webkit-transform: rotate(-90deg);
                                        -moz-transform: rotate(-90deg);
                                        -ms-transform: rotate(-90deg);
                                        -o-transform: rotate(-90deg);
                                        transform: rotate(-90deg);
                                        mso-rotate: 90;
                                        -webkit-transform-origin: 50% 50%;
                                        -moz-transform-origin: 50% 50%;
                                        -ms-transform-origin: 50% 50%;
                                        -o-transform-origin: 50% 50%;
                                        transform-origin: 50% 50%;
                                        position: absolute;
                                        filter: progid:DXImageTransform.Microsoft.BasicImage(rotation=3);
                                        
                                        color: #595959;
                                        background-color: #E2EFDA;
                                        height: 127px;
                                        border: none;
                                        border-right: thin dashed #595959;`;

                    const tblHeaderCSS = `  background-color: #404040;
                                        color: white;
                                        font-size: 13px;
                                        text-align: center;
                                        border: thin solid #404040;
                                        font-weight: bold;
                                        vertical-align: middle;
                                        font-family: Franklin Gothic Book;`;
                                    
                    const noBorderCSS = `border: none;
                                    font-size: 13px;
                                    vertical-align: middle;
                                    font-family: Franklin Gothic Book;
                                    mso-number-format:'\@';`;
                    /****** end CSS ******/

                    // GBO
                    var gboHtml = "";
                    var gboInfo = {};

                    // GBR
                    var gbrHtml = "";
                    var gbrInfo = {};

                    // NTL
                    var ntlHtml = "";
                    var ntlInfo = {};

                    // Detailed (Per shipment)
                    var detailsBodyHTML = "";

                    docs.forEach(function(val,i){
                        const dispatch = val.dispatchDetails || {};

                        const vehicle = getVehicle(dispatch.vehicle_id) || {};

                        var lapseTime = null;
                        if(val.delay_type == "Over CICO"){
                            const geofence = getGeofence(val.site,'short_name') || {};
                            lapseTime = val.timelapse - geofence.cico;
                        }
                        if(val.delay_type == "Long Queueing"){
                            lapseTime = val.timelapse - 0.5; // default queueing time is 30 minutes (0.5 dh)
                        }
                        if(val.delay_type == "Over Transit"){
                            const route = getRoute(dispatch.route) || {};
                            lapseTime = val.timelapse - route.transit_time;
                        }

                        const key = val.site;

                        gboInfo[key] = gboInfo[key] || {
                            totalShipments: 0,

                            totalOverCICO: 0,
                            totalLongQueueing: 0,
                            totalOverTransit: 0,
                        };

                        (val.delay_type == "Over CICO") ? gboInfo[key].totalOverCICO ++ : null;
                        (val.delay_type == "Long Queueing") ? gboInfo[key].totalLongQueueing ++ : null;
                        (val.delay_type == "Over Transit") ? gboInfo[key].totalOverTransit ++ : null;

                        gboInfo[key].totalShipments++;

                        detailsBodyHTML += `<tr>
                                                <td style="${noBorderCSS}text-align: left;">${val.dispatch_id}</td>
                                                <td style="${noBorderCSS}text-align: center;">${(vehicle.name || "")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${(dispatch.trailer || vehicle["Trailer"] || "")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${(vehicle["Pal Cap"] || "")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${val.delay_type}</td>
                                                <td style="${noBorderCSS}text-align: center;">${val.escalation}</td>
                                                <td style="${noBorderCSS}text-align: center;">${lapseTime == null ? "-" : DATETIME.HH_MM(null,lapseTime).hour_minute}</td>
                                                <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(val.timestamp,"MM/DD/YYYY")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(val.timestamp,"H:mm")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${val.site}</td>
                                            </tr>`;
                    });

                    // GBO
                    const filteredGeofences = LIST["geofences"].filter(x => x.code);
                    const sortedGeofences = ARRAY.OBJECT.sort(filteredGeofences,"short_name",{ sortType: "asc" });
                    sortedGeofences.forEach(gVal => {

                        const val = gboInfo[gVal.short_name] || {};

                        const region = getRegion(gVal.region_id) || {}; 

                        gboHtml += `<tr>
                                        <td style="${noBorderCSS}">${gVal.short_name}</td>
                                        <td style="${noBorderCSS}text-align: center;">${gVal.code || "-"}</td>
                                        <td style="${noBorderCSS}text-align: center;">${region.code || "-"}</td>
                                        <td style="${noBorderCSS}text-align: center;">${val.totalOverCICO || "-"}</td>
                                        <td style="${noBorderCSS}text-align: center;">${val.totalLongQueueing || "-"}</td>
                                        <td style="${noBorderCSS}text-align: center;">${val.totalOverTransit || "-"}</td>
                                        <td style="${noBorderCSS}text-align: center;">${val.totalShipments || "-"}</td>
                                    </tr>`;

                        if(gboInfo[gVal.short_name]) {

                            gbrInfo[gVal.region_id] = gbrInfo[gVal.region_id] || {
                                totalShipments: 0,

                                totalOverCICO: 0,
                                totalLongQueueing: 0,
                                totalOverTransit: 0,
                            };

                            gbrInfo[gVal.region_id].totalOverCICO += val.totalOverCICO;
                            gbrInfo[gVal.region_id].totalLongQueueing += val.totalLongQueueing;
                            gbrInfo[gVal.region_id].totalOverTransit += val.totalOverTransit;
                            gbrInfo[gVal.region_id].totalShipments += val.totalShipments;
                        }
                    });

                    // GBR
                    const sortedRegions = ARRAY.OBJECT.sort(LIST["regions"],"sequence",{ sortType: "asc" });
                    sortedRegions.forEach(rVal => {

                        const val = gbrInfo[rVal._id] || {};

                        gbrHtml += `<tr>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;">${rVal.name || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${rVal.code || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;"> </td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${val.totalOverCICO || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${val.totalLongQueueing || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${val.totalOverTransit || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${val.totalShipments || "-"}</td>
                                    </tr>`;

                        ntlInfo["ph"] = ntlInfo["ph"] || {
                            totalShipments: 0,

                            totalOverCICO: 0,
                            totalLongQueueing: 0,
                            totalOverTransit: 0,
                        };

                        ntlInfo["ph"].totalOverCICO += val.totalOverCICO || 0;
                        ntlInfo["ph"].totalLongQueueing += val.totalLongQueueing || 0;
                        ntlInfo["ph"].totalOverTransit += val.totalOverTransit || 0;
                        ntlInfo["ph"].totalShipments += val.totalShipments || 0;
                    });

                    console.log("ntlInfo",ntlInfo);

                    // NTL
                    const ntlVal = ntlInfo["ph"] || {};

                    ntlHtml += `<tr>
                                <td style="${noBorderCSS}background-color:#FFE1E1;">NATIONAL</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">NAT</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;"> </td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlVal.totalOverCICO || "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlVal.totalLongQueueing || "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlVal.totalOverTransit || "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlVal.totalShipments || "-"}</td>
                            </tr>`;
                            

                    // to be exported to file
                    return `<table id="report-hidden" style="opacity:0;">
                            <tr>
                                <td style="${noBorderCSS}" colspan=2>Report name: <b style="color:#c00000;">${title}</b></td>
                            </tr>
                            <tr><td style="${noBorderCSS}" colspan=2></td></tr>
                            <tr>
                                <td style="${noBorderCSS}" colspan=2>Date Info:</td>
                            </tr>
                            <tr>
                                <td style="${noBorderCSS}" colspan=2>
                                    <div>
                                        <div>Date from: ${moment(new Date(date_from)).format("MM/DD/YYYY hh:mm A")}</div>
                                        <div>Date to: ${moment(new Date(date_to)).format("MM/DD/YYYY hh:mm A")}</div>
                                        <div>&nbsp;</div>
                                        <div>Generated on: ${moment(new Date()).format("MM/DD/YYYY hh:mm A")}</div>
                                    </div>
                                </td>
                            </tr>
                            <tr><td style="${noBorderCSS}" colspan=2></td></tr>
                            ${
                                REPORTS.columnHtml( 
                                    ['site','siteCode','siteRegion','overCICO','longQueueing','overTransit','totalDelays'],
                                    rotateCSS,
                                    tblHeaderCSS
                                )
                            }
                            ${gboHtml}
                            <tr><td style="${noBorderCSS}"></td></tr>
                            ${ntlHtml}
                            ${gbrHtml}
                            <tr><td style="${noBorderCSS}"></td></tr>
                            <tr><td style="${noBorderCSS}"></td></tr>
                            <tr>
                                <td style="${noBorderCSS}"><b>Details:</b></td>
                            </tr>
                            <tr><td style="${noBorderCSS}"></td></tr>
                            ${
                                REPORTS.columnHtml( 
                                    ['shipment','vehicle','trailer','palCap','delay','escalation','lapseTime','occurrenceDate','occurrenceTime','site'],
                                    rotateCSS,
                                    tblHeaderCSS
                                )
                            }
                            ${detailsBodyHTML}
                        </table> `;
                },
            },
            PBPA: function(title,docs,originChosen,date_from,date_to){
                var details = "",
                    inventory = 0,
                    textCellStyle = `border:2px solid black;mso-number-format:'\@';`,
                    width = ["width:280px;","width:150px;","width:150px;","width:150px;","width:150px;","width:150px;",
                            "width:150px;","width:300px;","width:300px;","width:150px;","width:175px;","width:150px;"];
            docs.forEach(function(val,i){
                inventory++;
                var transit_time = getDuration("in_transit",val),
                    actual_time_lapse,
                    remarks2Class = "",
                    origin = getGeofence(val.origin_id) || {},
                    destination = getGeofence(val.destination[0].location_id) || {},
                    vehicle = getVehicle(val.vehicle_id) || {},
                    remarks2 = "w/in Transit Time";
                    
                if(transit_time){
                    actual_time_lapse = Number(DATETIME.DH(transit_time,null,"0"));
                } else {
                    actual_time_lapse = null;
                }
                
                details += `<tr style="text-align:center;">
                                <td style="${textCellStyle}${width[0]}">${(vehicle.name || "")}</td>
                                <td style="${textCellStyle}${width[1]}">${(vehicle["Pal Cap"] || "")}</td>
                                <td style="${textCellStyle}${width[2]}">-</td>
                                <td style="${textCellStyle}${width[3]}">-</td>
                                <td style="${textCellStyle}${width[4]}">${(val.remarks || "")}</td>
                                <td style="${textCellStyle}${width[5]}${remarks2Class}">${remarks2}</td>
                                <td style="${textCellStyle}${width[6]}">${val._id}</td>
                                <td style="${textCellStyle}${width[7]}">${origin.short_name}</td>
                                <td style="${textCellStyle}${width[8]}">${destination.short_name}</td>
                                <td style="${textCellStyle}${width[9]}">${val.route}</td>
                                <td style="${textCellStyle}${width[10]}">${DATETIME.HH_MM(null,actual_time_lapse).hour_minute}</td>
                            </tr>`;
            });

            return `<table id="report-hidden" style="opacity:0;">
                        <tr>
                            <td style="border: none;" colspan=2>Report name: <b style="color:#c00000;">${title}</b></td>
                        </tr>
                        <tr><td style="border: none;"></td></tr>
                        <tr>
                            <td style="border: none;"><b>Summary:</b></td>
                        </tr>
                        <tr>
                            <td style="border: none;" colspan=2>
                                <div>
                                    <div>Plant Base: ${originChosen}</div>
                                    <div>Date from: ${moment(new Date(date_from)).format("MM/DD/YYYY hh:mm A")}</div>
                                    <div>Date to: ${moment(new Date(date_to)).format("MM/DD/YYYY hh:mm A")}</div>
                                    <div>&nbsp;</div>
                                    <div>Generated on: ${moment(new Date()).format("MM/DD/YYYY hh:mm A")}</div>
                                </div>
                            </td>
                        </tr>
                        <tr><td style="border: none;"></td></tr>
                        <tr>
                            <td style="background-color:black;color:white;"><b>Inventory:</b></td>
                            <td style="border:2px solid black;font-weight: bold;text-align:center;">${inventory}</td>
                        </tr>
                        <tr>
                            <td style="background-color:black;color:white;"><b>Attendance:</b></td>
                            <td style="border:2px solid black;font-weight: bold;text-align:center;">-%</td>
                        </tr>
                        <tr style="text-align:center;">
                            <td style="background-color:black;color:white;text-align:left;"><b>Breakdown:</b></td>
                            <td style="border:2px solid black;font-weight: bold;"></td>
                            <td style="background-color:black;color:white;"><b>In Transit</b></td>
                            <td style="background-color:#757070;color:white;"><b>Over Transit</b></td>
                            <td style="background-color:#757070;color:white;"><b>W/in Transit</b></td>
                            <td style="background-color:black;color:white;"><b>In Site</b></td>
                            <td style="background-color:#757070;color:white;"><b>Over CICO</b></td>
                            <td style="background-color:#757070;color:white;"><b>W/in CICO</b></td>
                        </tr>
                        <tr style="text-align:center;">
                            <td style="background-color:black;color:white;text-align:right;font-style:italic;"><b>Active Assigned</b></td>
                            <td style="border:2px solid black;font-weight: bold;">-</td>
                            <td style="border:2px solid black;font-weight: bold;">-</td>
                            <td style="border:2px solid black;font-weight: bold;color:red;">-</td>
                            <td style="border:2px solid black;font-weight: bold;color:red;">-</td>
                            <td style="border:2px solid black;font-weight: bold;">-</td>
                            <td style="border:2px solid black;font-weight: bold;color:red;">-</td>
                            <td style="border:2px solid black;font-weight: bold;color:red;">-</td>
                        </tr>
                        <tr style="text-align:center;">
                            <td style="background-color:black;color:white;text-align:right;font-style:italic;"><b>Waiting for Assignment</b></td>
                            <td style="border:2px solid black;font-weight: bold;">-</td>
                            <td style="border:2px solid black;font-weight: bold;">-</td>
                            <td style="border:2px solid black;font-weight: bold;color:red;">-</td>
                            <td style="border:2px solid black;font-weight: bold;color:red;">-</td>
                            <td style="border:2px solid black;font-weight: bold;">-</td>
                            <td style="border:2px solid black;font-weight: bold;color:red;">-</td>
                            <td style="border:2px solid black;font-weight: bold;color:red;">-</td>
                        </tr>
                        <tr style="text-align:center;">
                            <td style="background-color:black;color:white;text-align:right;font-style:italic;"><b>Inactive</b></td>
                            <td style="border:2px solid black;font-weight: bold;">-</td>
                            <td style="background-color:black;"></td>
                            <td style="background-color:black;"></td>
                            <td style="background-color:black;"></td>
                            <td style="background-color:black;"></td>
                            <td style="background-color:black;"></td>
                            <td style="background-color:black;"></td>
                        </tr>
                        <tr><td style="border: none;"></td></tr>
                        <tr>
                            <td style="border: none;"><b>Details:</b></td>
                        </tr>
                        <tr style="text-align:center;">
                            <td style="background-color:black;color:white;">Plate No.</td>
                            <td style="background-color:black;color:white;">Pal Cap</td>
                            <td style="background-color:black;color:white;">Activity</td>
                            <td style="background-color:black;color:white;">Activity Status</td>
                            <td style="background-color:black;color:white;">Remarks1</td>
                            <td style="background-color:black;color:white;">Remarks2</td>
                            <td style="background-color:black;color:white;">SN</td>
                            <td style="background-color:black;color:white;">Origin (Plant)</td>
                            <td style="background-color:black;color:white;">Destination (DC)</td>
                            <td style="background-color:black;color:white;">Route</td>
                            <td style="background-color:black;color:white;">Actual Time Lapse (hrs)</td>
                        </tr>
                        ${details}
                    </table>`;
            },
            HWTR: function(title,docs,originChosen,_date){
                var details = "",
                    breakdown = "",
                    tt1c = 0,
                    wctp = 0,
                    final_compliance = 0,
                    breakdown_info = {},
                    width = ["width:115px;","width:215px;","width:215px;","width:215px;"];
                function getDateItems(hours) {
                    var toDate = new Date();
                    var fromDate = new Date();
                    toDate.setHours(6);
                    toDate.setMinutes(00);
                    toDate.setSeconds(00);
                    fromDate.setHours(6);
                    fromDate.setMinutes(00);
                    fromDate.setSeconds(00);
                    toDate.setTime(toDate.getTime() + (hours * 60 * 60 * 1000));
                    var result = {};
                    
                    while (toDate >= fromDate) {
                        result[moment(fromDate).format("h a")] = {
                            time: moment(fromDate).format("h:mm A"),
                            ti_shipment: 0,
                            ti_arrived: 0,
                        };
                        fromDate.setTime(fromDate.getTime() + (1 * 60 * 60 * 1000));
                    }
                    
                    return result;
                }  
                var timeList = getDateItems(23);
                
                docs.forEach(function(val,i){
                    tt1c++;

                    var origin = getGeofence(val.origin_id) || {},
                        destination = getGeofence(val.destination[0].location_id) || {},
                        route = LIST["routes"].find(x => x.origin_id == origin._id && x.destination_id == destination._id) || {},
                        orig_dest = `${origin.short_name}_${destination.short_name}`,
                        timeKey = moment(val.departure_date).format("h a");

                    if(!breakdown_info[orig_dest]){
                        breakdown_info[orig_dest] = {
                            destination:destination.short_name,
                            origin:origin.short_name,
                            count:1,
                        };
                    } else {
                        breakdown_info[orig_dest].count++;
                    }

                    // departure time
                    timeList[timeKey].ti_shipment++;

                    
                    // # of shipments (bases in 2nd col) whose actual in transit time =< target transit time
                    var transit_time = getDuration("in_transit",val),
                        actual_time_lapse = Number(DATETIME.DH(transit_time,null,"0"));
                    timeList[timeKey].ti_arrived += ((route.transit_time || 0) >= actual_time_lapse)?1:0;
                });
                
                Object.keys(timeList).forEach(key => {
                    var time = timeList[key].time,
                        ti_shipment = timeList[key].ti_shipment,
                        ti_arrived = timeList[key].ti_arrived,
                        _compliance = ((ti_arrived<ti_shipment)?"Non Compliance":"Complied");
                    final_compliance = final_compliance + ((_compliance=="Complied")?1:0);
                    wctp += ti_shipment;
                    details += `<tr>
                                    <td style="border:2px solid black;text-align:center;">${time}</td>
                                    <td style="border:2px solid black;text-align:center;">${ti_shipment}</td>
                                    <td style="border:2px solid black;text-align:center;">${ti_arrived}</td>
                                    <td style="border:2px solid black;text-align:center;">${_compliance}</td>
                                </tr>`;
                });
                Object.values(breakdown_info).forEach(val => {
                    breakdown += `<tr>
                                    <td style="border:2px solid black;text-align:center;" colspan=2>${val.origin}</td>
                                    <td style="border:2px solid black;text-align:center;">${val.count}</td>
                                </tr>`;
                });

                return `<table id="report-hidden" style="opacity:0;">
                            <tr>
                                <td style="border: none;" colspan=3>Report name: <b style="color:#c00000;">${title}</b></td>
                            </tr>
                            <tr><td style="border: none;"></td></tr>
                            <tr>
                                <td style="border: none;"><b>Summary:</b></td>
                            </tr>
                            <tr>
                                <td style="border: none;" colspan=3>
                                    <div>
                                        <div>Destination Site: ${originChosen}</div>
                                        <div>Date: ${moment(new Date(_date)).format("MM/DD/YYYY")}</div>
                                        <div>&nbsp;</div>
                                        <div>Generated on: ${moment(new Date()).format("MM/DD/YYYY hh:mm A")}</div>
                                    </div>
                                </td>
                            </tr>
                            <tr><td style="border: none;"></td></tr>
                            <tr>
                                <td style="background-color:black;color:white;" colspan=2><b>Total T1 Shipment:</b></td>
                                <td style="border:2px solid black;font-weight: bold;text-align:center;">${tt1c}</td>
                            </tr>
                            <tr>
                                <td style="background-color:black;color:white;" colspan=2><b>Breakdown:</b></td>
                                <td style="border:2px solid black;"></td>
                            </tr>
                            ${breakdown}
                            <tr><td style="border: none;"></td></tr>
                            <tr>
                                <td style="border:2px solid black;text-align:center;" colspan=2>Whse Capacity to Process</td>
                                <td style="border:2px solid black;text-align:center;"><b>${wctp}</b></td>
                            </tr>
                            <tr><td style="border: none;"></td></tr>
                            <tr>
                                <td style="border:2px solid black;text-align:center;" colspan=2>Capacity vs Shipment</td>
                                <td style="border:2px solid black;text-align:center;"><b>${((tt1c>wctp)?"Capacity to Process Issue":"No Processing Issue")}</b></td>
                            </tr>
                            <tr>
                                <td style="border:2px solid black;text-align:center;" colspan=2>% Compliance</td>
                                <td style="border:2px solid black;text-align:center;"><b>${GET.ROUND_OFF((final_compliance/24)*100)}%</b></td>
                            </tr>
                            <tr><td style="border: none;"></td></tr>
                            <tr>
                                <td style="background-color:black;color:white;${width[0]}text-align:center;"><b>Time</b></td>
                                <td style="background-color:black;color:white;text-align:center;${width[1]}"><b>T1 Shipments/Hr</b></td>
                                <td style="background-color:black;color:white;text-align:center;${width[2]}"><b>T1 that arrived/Hr</b></td>
                                <td style="background-color:black;color:white;text-align:center;${width[3]}"><b>% compliance</b></td>
                            </tr>
                            ${details}
                        </table>`;
            },
            AR: function(docs,date_from,holidays){
                var overallTableHtml = "";
                var personnelTableHtml = "";

                // declare date variables
                const month = moment(date_from).format("MM");
                const year = moment(date_from).format("YYYY");
                const daysInMonth = moment(date_from).daysInMonth();
                const ignoreWeekDay = 0; // sunday

                // function to check if target is in between two dates (start and finish)
                function isSelectedMonth(target){
                    const start = moment(new Date(`${month}/01/${year}`)).startOf('month');
                    const finish = moment(new Date(`${month}/${daysInMonth}/${year}`)).endOf('month');

                    return target.isBetween(start, finish, 'months', '[]'); // all inclusive
                }

                // function to get how many specifid weekday there is in a month. Ex. There are 5 sundays in 08/01/2021
                function getAmountOfWeekDaysInMonth(date, weekday) {
                    date.date(1);
                    var dif = (7 + (weekday - date.weekday())) % 7 + 1;
                    return Math.floor((date.daysInMonth() - dif) / 7) + 1;
                }

                // function to check if date is a holiday
                function isDateHoliday(date){
                    var isHoliday = false;
                    holidays.forEach(val => {
                        const startDate = moment(val.start).startOf('day');
                        const endDate = moment(val.end).endOf('day');
                        
                        (date.isBetween(startDate, endDate, 'hours', true)) ? isHoliday = true : null;
                    });
                    return isHoliday;
                }

                // deduct sundays, holidays and rest days
                var noOfDaysWithWork = daysInMonth;

                // fill in the attendance status even if value is 0
                const overallAttendanceStatus = {};
                Object.keys(vehiclePersonnelCalendarOptions).forEach(key => { overallAttendanceStatus[key] = overallAttendanceStatus[key] || 0; });

                // formatted attendance sheet
                const attendaceSheet = {};
                // set values for all days in month as 'Present' (clone later)
                for(var i = 1; i < daysInMonth+1; i++){
                    const momentDate = moment(`${month}/${i}/${year}`);
                    // check if date is a holiday
                    if(isDateHoliday(momentDate)){
                        // deduct holidays
                        noOfDaysWithWork--;

                        attendaceSheet[momentDate.format("MM/DD/YYYY")] = `<td style="border: thin 1px #ddd;color: #0D0D0D;">Holiday</td>`;
                    } else if(momentDate.day() == ignoreWeekDay){
                        // deduct sundays
                        noOfDaysWithWork--;

                        attendaceSheet[momentDate.format("MM/DD/YYYY")] = `<td style="border: thin 1px #ddd;color: #0D0D0D;">Sunday</td>`;
                    } else {
                        attendaceSheet[momentDate.format("MM/DD/YYYY")] = `<td style="border: thin 1px #ddd;"></td>`;
                    }
                }

                // used for checking to avoid duplicate sheet names (there records with the same personnel name)
                const listOfPersonnel = [];
                // total present is the total number of 'Present' status in attendance sheet for all personnel
                var totalOverallPresentDays = 0;

                // loop through each personnel
                docs.forEach((val,i) => {
                    // if array does not include personnel name yet
                    if(!listOfPersonnel.includes(val.name)){
                        listOfPersonnel.push(val.name);

                        // total present is the total number of 'Present' status in attendance sheet PER personnel
                        var totalPresentDays = 0;

                        // fill in the attendance status even if value is 0
                        const personnelAttendanceStatus = {};
                        Object.keys(vehiclePersonnelCalendarOptions).forEach(key => { personnelAttendanceStatus[key] = personnelAttendanceStatus[key] || 0; });

                        // clone 'attendaceSheet'
                        const personnelAttendanceSheet = JSON.parse(JSON.stringify(attendaceSheet));
                        
                        // loop through the dispatch entries assigned to user for the month selected
                        (val.dispatchDetails||[]).forEach(dispatch => {
                            // update attendance status to 'Present' based on shipment's scheduled date
                            personnelAttendanceSheet[moment(dispatch.scheduled_date).format("MM/DD/YYYY")] = `<td style="border: thin 1px #ddd;color: #6f9f34;">Present</td>`;
                            // increase total Present days
                            totalPresentDays++;
                        });

                        totalOverallPresentDays+= totalPresentDays;
                        
    
                        // loop through each personnel's calendar info (restday,absent,...)
                        Object.keys((val.dates||{})).forEach(key => {
                            const dates = val.dates[key] || [];
                            dates.forEach(date => {
                                // check if date is the selected month
                                if(isSelectedMonth(moment(date))){
                                    // update the corresponding attendance status of personnel
                                    const dayInfo = vehiclePersonnelCalendarOptions[key];
                                    personnelAttendanceSheet[moment(date).format("MM/DD/YYYY")] = `<td style="border: thin 1px #ddd;color: ${dayInfo.hex};">${dayInfo.label}</td>`;

                                    // save attendance status
                                    personnelAttendanceStatus[key] = personnelAttendanceStatus[key] || 0;
                                    personnelAttendanceStatus[key] ++;
                                }
                            });
                        });

                        // save attendance status (overall)
                        Object.keys(personnelAttendanceStatus).forEach(key => {
                            overallAttendanceStatus[key] = overallAttendanceStatus[key] || 0;
                            overallAttendanceStatus[key] += personnelAttendanceStatus[key];
                        });
    
                        var personnelHtml = "";
                        // loop through the updated attendance sheet of personnel and add tr (html)
                        Object.keys(personnelAttendanceSheet).forEach(key => {
                            personnelHtml += `
                                <tr>
                                    <td style="border: thin 1px #ddd;mso-number-format:'\@';">${key}</td>
                                    <td style="border: thin 1px #ddd;">${val.occupation||""}</td>
                                    ${personnelAttendanceSheet[key]}
                                </tr>`;
                        });

                        // Formula: (Days in a month - sundays/holidays - rest days) * number or personnel = 100%
                        const totalNoOfDaysWithWork = noOfDaysWithWork - personnelAttendanceStatus["rest_days"]||0;
                
                        var attendanceStatusHtml = "";
                        Object.keys(personnelAttendanceStatus).forEach(key => {
                            const dayInfo = vehiclePersonnelCalendarOptions[key];
                            attendanceStatusHtml += `
                                <tr> 
                                    <td style="font-weight:bold;text-align:center;" colspan=3>${(dayInfo.label||"").toUpperCase()}</td>
                                    <td style="font-weight:bold;text-align:center;">${personnelAttendanceStatus[key]||0}</td>
                                </tr>`;
                        });
                        
                        // calcualte total attendance percentage
                        const totalAttendancePercent = GET.ROUND_OFF((totalPresentDays/totalNoOfDaysWithWork) * 100);
    
                        // add table as sheet
                        personnelTableHtml += `
                            <table id="report-hidden-${i}" data-SheetName="${val.name}" border="1" style="border-collapse: collapse;opacity:0;">
                                <tbody>
                                    <tr> <td style="text-align:left;" colspan=3>${val.name}</td> </tr>
                                    <tr> <td style="text-align:left;" colspan=3></td> </tr>
                                    <tr> 
                                        <td style="font-weight:bold;border: thin 1px #ddd;">Date</td>
                                        <td style="font-weight:bold;border: thin 1px #ddd;">Position</td>
                                        <td style="font-weight:bold;border: thin 1px #ddd;">Status</td>
                                    </tr>
                                    ${personnelHtml}
                                    <tr> <td style="text-align:center;" colspan=3></td> </tr>
                                    <tr> <td style="text-align:center;" colspan=3></td> </tr>
                                    <tr> <td style="text-align:center;" colspan=3></td> </tr>
                                    <tr> 
                                        <td style="font-weight:bold;text-align:center;" colspan=3>NO. OF DAYS WITH WORK / MONTH</td>
                                        <td style="font-weight:bold;text-align:center;">${totalNoOfDaysWithWork}</td>
                                    </tr>
                                    <tr> 
                                        <td style="font-weight:bold;text-align:center;" colspan=3>PRESENT</td>
                                        <td style="font-weight:bold;text-align:center;">${totalPresentDays}</td>
                                    </tr>
                                    <tr> <td style="text-align:center;" colspan=3></td> </tr>
                                    <tr> 
                                        <td style="font-weight:bold;text-align:center;" colspan=3>ATTENDANCE %</td>
                                        <td style="font-weight:bold;text-align:center;font-size:15px;">${totalAttendancePercent||0}%</td>
                                    </tr>
                                    <tr> <td style="text-align:center;" colspan=3></td> </tr>
                                    ${attendanceStatusHtml}
                                </tbody>
                            </table>`;
                    }
                });

                // Formula: (Days in a month - sundays/holidays - rest days) * number or personnel = 100%
                const totalOverallNoOfDaysWithWork = (noOfDaysWithWork * listOfPersonnel.length) - overallAttendanceStatus["rest_days"]||0;

                var overallAttendanceStatusHtml = "";
                Object.keys(overallAttendanceStatus).forEach(key => {
                    const dayInfo = vehiclePersonnelCalendarOptions[key];
                    overallAttendanceStatusHtml += `
                        <tr> 
                            <td style="font-weight:bold;text-align:center;">${(dayInfo.label||"").toUpperCase()}</td>
                            <td style="font-weight:bold;text-align:center;">${overallAttendanceStatus[key]||0}</td>
                        </tr>`;
                });
                
                // calcualte total attendance percentage
                const totalOverallAttendancePercent = GET.ROUND_OFF((totalOverallPresentDays/totalOverallNoOfDaysWithWork) * 100);

                overallTableHtml += `
                    <table id="report-hidden" data-SheetName="Overall" border="1" style="border-collapse: collapse;opacity:0;">
                        <tbody>
                            <tr> <td style="text-align:center;"></td> </tr>
                            <tr> <td style="text-align:center;"></td> </tr>
                            <tr> <td style="text-align:center;"></td> </tr>
                            <tr> 
                                <td style="font-weight:bold;text-align:center;">NO. OF DAYS WITH WORK / MONTH</td>
                                <td style="font-weight:bold;text-align:center;">${totalOverallNoOfDaysWithWork}</td>
                            </tr>
                            <tr> 
                                <td style="font-weight:bold;text-align:center;">PRESENT</td>
                                <td style="font-weight:bold;text-align:center;">${totalOverallPresentDays}</td>
                            </tr>
                            <tr> <td style="text-align:center;"></td> </tr>
                            <tr> 
                                <td style="font-weight:bold;text-align:center;">ATTENDANCE %</td>
                                <td style="font-weight:bold;text-align:center;font-size:15px;">${totalOverallAttendancePercent||0}%</td>
                            </tr>
                            <tr> <td style="text-align:center;"></td> </tr>
                            ${overallAttendanceStatusHtml}
                        </tbody>
                    </table>`;

                return overallTableHtml + personnelTableHtml;
            },
            tr: {
                coket1: ( title, docs, originChosen, date_from, date_to ) => {
                    // Legend:
                    //    · GBO - Grouped by Origin
                    //    · GBR - Grouped by Region
                    //    · NTL - National

                    /****** CSS ******/
                    const rotateCSS = ` -webkit-transform: rotate(-90deg);
                                        -moz-transform: rotate(-90deg);
                                        -ms-transform: rotate(-90deg);
                                        -o-transform: rotate(-90deg);
                                        transform: rotate(-90deg);
                                        mso-rotate: 90;
                                        -webkit-transform-origin: 50% 50%;
                                        -moz-transform-origin: 50% 50%;
                                        -ms-transform-origin: 50% 50%;
                                        -o-transform-origin: 50% 50%;
                                        transform-origin: 50% 50%;
                                        position: absolute;
                                        filter: progid:DXImageTransform.Microsoft.BasicImage(rotation=3);
                                        
                                        color: #595959;
                                        background-color: #E2EFDA;
                                        height: 127px;
                                        border: none;
                                        border-right: thin dashed #595959;`;

                    const tblHeaderCSS = `  background-color: #404040;
                                        color: white;
                                        font-size: 13px;
                                        text-align: center;
                                        border: thin solid #404040;
                                        font-weight: bold;
                                        vertical-align: middle;
                                        font-family: Franklin Gothic Book;`;
                                    
                    const noBorderCSS = `border: none;
                                    font-size: 13px;
                                    vertical-align: middle;
                                    font-family: Franklin Gothic Book;
                                    mso-number-format:'\@';`;
                    /****** end CSS ******/

                    // GBO
                    var gboHtml = "";
                    var gboInfo = {};

                    // GBR
                    var gbrHtml = "";
                    var gbrInfo = {};

                    // NTL
                    var ntlHtml = "";
                    var ntlInfo = {};

                    // Detailed (Per shipment)
                    var detailsBodyHTML = "";

                    docs.forEach(function(val,i){
                    val.destination[0] = val.destination[0] || {};
                    var origin = getGeofence(val.origin_id) || {},
                        destination = getGeofence(val.destination[0].location_id) || {},
                        vehicle = getVehicle(val.vehicle_id) || {};

                    // const key = origin.short_name;
                    const key = vehicle["Base Site Code"];

                    gboInfo[key] = gboInfo[key] || {
                        totalShipments: 0,
                    };

                    gboInfo[key].totalShipments++;

                    detailsBodyHTML += `<tr>
                                            <td style="${noBorderCSS}text-align: left;">${val._id}</td>
                                            <td style="${noBorderCSS}text-align: center;">${(vehicle.name || "")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${(val.trailer || vehicle["Trailer"] || "")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${(vehicle["Pal Cap"] || "")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${(vehicle["Base Site"] || "")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${(vehicle["Base Site Code"] || "")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${origin.short_name}</td>
                                            <td style="${noBorderCSS}text-align: center;">${destination.short_name}</td>
                                            <td style="${noBorderCSS}text-align: center;">${val.route}</td>
                                            <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(val.departure_date,"MM/DD/YYYY")}</td>
                                            <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(val.departure_date,"H:mm")}</td>
                                        </tr>`;
                    });

                    // GBO
                    const filteredGeofences = LIST["geofences"].filter(x => x.code);
                    const sortedGeofences = ARRAY.OBJECT.sort(filteredGeofences,"code",{ sortType: "asc" });
                    sortedGeofences.forEach(gVal => {

                        const val = gboInfo[gVal.code] || {};

                        const region = getRegion(gVal.region_id) || {}; 

                        const totalShipments = val.totalShipments || 0;
                        const truckInventory = LIST['vehicles'].filter(x => x['Base Site Code'] == gVal.code).length;
                        const trippage = totalShipments ? GET.ROUND_OFF(totalShipments / truckInventory) : "-";

                        const trippageTarget = gVal.trippage_target || 0;
                        const trippageVariance = totalShipments ? GET.ROUND_OFF(trippage - trippageTarget) : "-";

                        const remarks = totalShipments ? ((trippage > trippageTarget) ? "Hit" : "Miss") : "Miss";

                        if(truckInventory){
                            gboHtml += `<tr>
                                            <td style="${noBorderCSS}">${gVal.short_name}</td>
                                            <td style="${noBorderCSS}text-align: center;">${gVal.code || "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${region.code || "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${totalShipments || "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${truckInventory}</td>
                                            <td style="${noBorderCSS}text-align: center;">${trippage || "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${trippageTarget || "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${trippageVariance || "-"}</td>
                                            <td style="${noBorderCSS}text-align: center;">${remarks}</td>
                                        </tr>`;
                            gbrInfo[gVal.region_id] = gbrInfo[gVal.region_id] || {
                                totalShipments: 0,

                                truckInventory: 0,

                                trippageTarget: 0,
                                totalWithTrippageTarget: 0
                            };

                            gbrInfo[gVal.region_id].totalShipments += totalShipments;
                            gbrInfo[gVal.region_id].truckInventory += truckInventory || 0;

                            gbrInfo[gVal.region_id].trippageTarget += trippageTarget || 0;
                            (trippageTarget) ? gbrInfo[gVal.region_id].totalWithTrippageTarget ++ : null;
                        }
                    });

                    // GBR
                    const sortedRegions = ARRAY.OBJECT.sort(LIST["regions"],"sequence",{ sortType: "asc" });
                    sortedRegions.forEach(rVal => {

                        const val = gbrInfo[rVal._id] || {};

                        const totalShipments = val.totalShipments || 0;
                        const truckInventory = val.truckInventory || 0;
                        const trippage = totalShipments ? GET.ROUND_OFF(totalShipments / truckInventory) : "-";

                        const trippageTarget = GET.ROUND_OFF(val.trippageTarget / val.totalWithTrippageTarget) || 0;
                        const trippageVariance = totalShipments ? GET.ROUND_OFF(trippage - trippageTarget) : "-";

                        const remarks = totalShipments ? ((trippage > trippageTarget) ? "Hit" : "Miss") : "Miss";

                        gbrHtml += `<tr>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;">${rVal.name || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${rVal.code || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;"> </td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${totalShipments || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${truckInventory}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${trippage || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${trippageTarget || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${trippageVariance || "-"}</td>
                                        <td style="${noBorderCSS}background-color:#F2F2F2;text-align: center;">${remarks}</td>
                                    </tr>`;

                        ntlInfo["ph"] = ntlInfo["ph"] || {
                            totalShipments: 0,
                            truckInventory: 0,

                            trippageTarget: 0,
                            totalWithTrippageTarget: 0
                        };

                        ntlInfo["ph"].totalShipments += totalShipments;
                        ntlInfo["ph"].truckInventory += truckInventory || 0;

                        ntlInfo["ph"].trippageTarget += trippageTarget || 0;
                        (trippageTarget) ? ntlInfo["ph"].totalWithTrippageTarget ++ : null;
                    });

                    console.log("ntlInfo",ntlInfo);

                    // NTL
                    const ntlVal = ntlInfo["ph"] || {};

                    const ntlTotalShipments = ntlVal.totalShipments || 0;
                    const ntlTruckInventory = ntlVal.truckInventory;
                    const ntlTrippage = ntlTotalShipments ? GET.ROUND_OFF(ntlTotalShipments / ntlTruckInventory) : "-";

                    const ntlTrippageTarget = GET.ROUND_OFF(ntlVal.trippageTarget / ntlVal.totalWithTrippageTarget) || 0;
                    const ntlTrippageVariance = ntlTotalShipments ? GET.ROUND_OFF(ntlTrippage - ntlTrippageTarget) : "-";

                    const ntlRemarks = ntlTotalShipments ? ((ntlTrippage > ntlTrippageTarget) ? "Hit" : "Miss") : "Miss";

                    ntlHtml += `<tr>
                                <td style="${noBorderCSS}background-color:#FFE1E1;">NATIONAL</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">NAT</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;"> </td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlTotalShipments || "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlTruckInventory || "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlTrippage || "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlTrippageTarget || "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlTrippageVariance || "-"}</td>
                                <td style="${noBorderCSS}background-color:#FFE1E1;text-align: center;">${ntlRemarks}</td>
                            </tr>`;
                            

                    // to be exported to file
                    return `<table id="report-hidden" style="opacity:0;">
                            <tr>
                                <td style="${noBorderCSS}" colspan=2>Report name: <b style="color:#c00000;">${title}</b></td>
                            </tr>
                            <tr><td style="${noBorderCSS}" colspan=2></td></tr>
                            <tr>
                                <td style="${noBorderCSS}" colspan=2>Date Info:</td>
                            </tr>
                            <tr>
                                <td style="${noBorderCSS}" colspan=2>
                                    <div>
                                        <div>Date from: ${moment(new Date(date_from)).format("MM/DD/YYYY hh:mm A")}</div>
                                        <div>Date to: ${moment(new Date(date_to)).format("MM/DD/YYYY hh:mm A")}</div>
                                        <div>&nbsp;</div>
                                        <div>Generated on: ${moment(new Date()).format("MM/DD/YYYY hh:mm A")}</div>
                                    </div>
                                </td>
                            </tr>
                            <tr><td style="${noBorderCSS}" colspan=2></td></tr>
                            ${
                                REPORTS.columnHtml( 
                                    ['baseSite','baseSiteCode','baseSiteRegion','shipmentCount_CheckedOut','truckInventory','trippage','trippageTarget','trippageVariance','remarksTrippage'],
                                    rotateCSS,
                                    tblHeaderCSS
                                )
                            }
                            ${gboHtml}
                            <tr><td style="${noBorderCSS}"></td></tr>
                            ${ntlHtml}
                            ${gbrHtml}
                            <tr><td style="${noBorderCSS}"></td></tr>
                            <tr><td style="${noBorderCSS}"></td></tr>
                            <tr>
                                <td style="${noBorderCSS}"><b>Details:</b></td>
                            </tr>
                            <tr><td style="${noBorderCSS}"></td></tr>
                            ${
                                REPORTS.columnHtml( 
                                    ['shipment','vehicle','trailer','palCap','baseSite','baseSiteCode','origin','destination','route','checkOutDate','checkOutTime'],
                                    rotateCSS,
                                    tblHeaderCSS
                                )
                            }
                            ${detailsBodyHTML}
                        </table> `;
                },
                coket2: ( title, docs, location, date_from, date_to ) => {
                    return REPORTS.UI.REPORTS.tr.wilcon( title, docs, location, date_from, date_to );
                },
                wilcon: ( title, docs, location, date_from, date_to ) => {
                    var empty = "",
                        width = ["width:100px;","width:100px;","width:100px;","width:100px;"];

                    for(var i=0; i < 16; i++){
                        empty += `<tr style="text-align:center">
                                        <td style="border:2px solid black;"></td>
                                        <td style="border:2px solid black;"></td>
                                        <td style="border:2px solid black;"></td>
                                        <td style="border:2px solid black;"></td>
                                    </tr>`;
                    }

                    return `<table id="report-hidden" style="opacity:0;">
                                <tr>
                                    <td style="border: none;" colspan=4>Report name: <b style="color:#c00000;">${title}</b></td>
                                </tr>
                                <tr><td style="border: none;"></td></tr>
                                <tr>
                                    <td style="border: none;" colspan=4><b>Summary:</b></td>
                                </tr>
                                <tr>
                                    <td style="border: none;" colspan=4>
                                        <div>
                                            <div>Plant Site: ${location.origin}</div>
                                            <div>Destination Site: ${location.destination}</div>
                                            <div>Destination Region: ${location.region}</div>
                                            <div>&nbsp;</div>
                                            <div>Day: ${moment(new Date(date_from)).format("DD")}</div>
                                            <div>Week: ${moment(new Date(date_from)).format("dddd")}</div>
                                            <div>Month: ${moment(new Date(date_from)).format("MMMM")}</div>
                                            <div>&nbsp;</div>
                                            <div>Generated on: ${moment(new Date()).format("MM/DD/YYYY hh:mm A")}</div>
                                        </div>
                                    </td>
                                </tr>
                                <tr><td style="border: none;"></td></tr>
                                <tr><td style="border: none;"></td></tr>
                                <tr>
                                    <td style="background-color:black;color:white;${width[0]}text-align:center;"><b>Period</b></td>
                                    <td style="background-color:black;color:white;text-align:center;${width[1]}"><b>Week</b></td>
                                    <td style="background-color:black;color:white;text-align:center;${width[2]}"><b>Date</b></td>
                                    <td style="background-color:black;color:white;text-align:center;${width[3]}"><b>Trippage</b></td>
                                </tr>
                                ${empty}
                            </table>`;
                }
            },
            VCR: function(title,docs,date_from,date_to){
                var empty = "",
                    width = ["width:100px;","width:100px;","width:100px;","width:110px;","width:100px;","width:180px;","width:180px;"],
                    lastTimestamp,
                    lastGeofence,
                    timeToDeduct = 5, // 5 minutes
                    hasChangedGeofence = true; // to deduct 5 minutes from datetime

                docs.forEach((val,i) => {
                    function processReport(){
                        hasChangedGeofence = false;

                        var _prev = docs[i-1],
                            _next = docs[i+1],
                            timestamp = lastTimestamp || val.timestamp,
                            prevAddress = (_prev && _prev.USER_NAME == val.USER_NAME) ? _prev.GEOFENCE_NAME : null,
                            startAddress = val.GEOFENCE_NAME,
                            endAddress = (_next && _next.USER_NAME == val.USER_NAME) ? _next.GEOFENCE_NAME : null,
                            modifyAddress = function(addr){
                                var finalStr = "";
                                if(addr){
                                    var str = addr.split(" - "),
                                        modifyArea = function(area){
                                            finalStr += ` ${area}`;
                                            finalStr = finalStr.replace(" DC","").replace(" PL","").replace(/Ñ/g,"N").replace(/ñ/g,"n");
                                        };
                                    finalStr = str[0].capitalize(" ").replace(" Dc"," DC").replace(" Pl"," PL");
                                    if(addr.indexOf("Process") > -1) modifyArea(" Process");
                                    if(addr.indexOf("Queue") > -1) modifyArea(" Queue");
                                    if(addr.indexOf("Idle") > -1) modifyArea(" Idle");
                                } else {
                                    finalStr = "Unknown";
                                }
                                // console.log("finalStr",addr,finalStr);
                                return finalStr;
                            },
                            getAddressStyle = function(addr){
                                return (addr && addr.indexOf(" - ") == -1) ? "color:#ca294b;font-style: italic;" : "color:black;";
                            },
                            getOriginalAddress = function(addr){
                                addr = addr || "";
                                var str = addr.split(" - ");
                                return str[0];
                            },
                            startAddressColor = getAddressStyle(startAddress),
                            endAddressColor = getAddressStyle(endAddress),
                            sameCurrentAndPrevAddress = getOriginalAddress(startAddress) == getOriginalAddress(prevAddress),
                            sameCurrentAndNextAddress = getOriginalAddress(startAddress) == getOriginalAddress(endAddress),
                            endAddressTimestamp = (_next && _next.USER_NAME == val.USER_NAME) ? _next.timestamp : null,
                            duration = (endAddressTimestamp) ? Math.abs(new Date(timestamp).getTime() - new Date(endAddressTimestamp).getTime()) : null,
                            addHTML = function(addressColor,address){
                                // do not make condition like !duration. Duration could be 0.
                                var endAddressHTML = (duration != null) ? `<td style="font-family:Arial;font-size:15px;border:1px solid black;${addressColor}">${modifyAddress(address)}</td>` : 
                                                                `<td style="font-family:Arial;font-size:15px;border:1px solid black;">-</td>`,
                                    endDate = DATETIME.FORMAT(endAddressTimestamp,"D-M"),
                                    endTime = DATETIME.FORMAT(endAddressTimestamp,"hh:mm A"),
                                    status = "Finished",
                                    _duration_ = (duration != null) ? GET.ROUND_OFF(DATETIME.DH(duration,null,"0"))  : "-";
                                if(new Date(date_to).getTime() > new Date().getTime() && duration == null){
                                    endDate = "-";
                                    endTime = "-";
                                    status = "Pending"
                                }
                                return `<tr style="text-align:center">
                                            <td style="font-family:Arial;font-size:15px;border:1px solid black;mso-number-format:'\@';">${val.USER_NAME}</td>
                                            <td style="font-family:Arial;font-size:15px;border:1px solid black;mso-number-format:'\@';">${DATETIME.FORMAT(timestamp,"D-M")}</td>
                                            <td style="font-family:Arial;font-size:15px;border:1px solid black;mso-number-format:'\@';">${DATETIME.FORMAT(timestamp,"hh:mm A")}</td>
                                            <td style="font-family:Arial;font-size:15px;border:1px solid black;mso-number-format:'\@';">${endDate}</td>
                                            <td style="font-family:Arial;font-size:15px;border:1px solid black;mso-number-format:'\@';">${endTime}</td>
                                            <td style="font-family:Arial;font-size:15px;border:1px solid black;mso-number-format:'\@';">${_duration_}</td>
                                            <td style="font-family:Arial;font-size:15px;border:1px solid black;mso-number-format:'\@';">${status}</td>
                                            <td style="font-family:Arial;font-size:15px;border:1px solid black;mso-number-format:'\@';${startAddressColor}">${modifyAddress(startAddress)}</td>
                                            ${endAddressHTML}
                                        </tr>`;
                            };

                        if(!sameCurrentAndNextAddress){
                            hasChangedGeofence = true;
                        }
                        if(_next && _next.GEOFENCE_NAME == val.GEOFENCE_NAME && _next.USER_NAME == val.USER_NAME){
                            if(!lastTimestamp) lastTimestamp = val.timestamp; // do not put in parent condition ^. It will be false if timestamp has value
                        } else {
                            lastTimestamp = null;
                            if(sameCurrentAndNextAddress){
                                lastGeofence = getOriginalAddress(startAddress);
                                empty += addHTML(endAddressColor,endAddress);
                            } else if(!lastGeofence || !prevAddress || lastGeofence != getOriginalAddress(prevAddress)){
                                lastGeofence = getOriginalAddress(startAddress);
                                duration = Math.abs(new Date(timestamp).getTime() - new Date(val.timestamp).getTime());
                                endAddressTimestamp = val.timestamp;
                                empty += addHTML(startAddressColor,startAddress);
                            }
                        }
                    }
                    if(hasChangedGeofence){
                        if(val.GEOFENCE_NAME.indexOf("-") == -1){
                            processReport();
                        } else {
                            // extendSearchDone();
                        }
                    } else {
                        processReport();
                    }

                    // if(hasChangedGeofence){
                    //     if(val.GEOFENCE_NAME.indexOf("-") == -1){
                    //         // var date = new Date(val.timestamp);
                    //         // date.setMinutes(date.getMinutes() - timeToDeduct);

                    //         if(DATETIME.FORMAT(val.timestamp,"D-MMM") == DATETIME.FORMAT(date_from,"D-MMM")){
                    //             val.timestamp = date.getTime();
                    //             // if(DATETIME.FORMAT(date_from,"D-MMM") == DATETIME.FORMAT(date,"D-MMM")){
                    //             //     val.timestamp = date.getTime();
                    //             // }
                    //         } else {
                    //             val.timestamp = date.getTime();
                    //         }
                    //         processReport();
                    //     } else { }
                    // } else {
                    //     processReport();
                    // }
                });

                return `<table id="report-hidden" style="opacity:0;">
                            <tr>
                                <td style="font-family:Arial;font-size:15px;border: none;" colspan=4>Report name: <b style="color:#c00000;">${title}</b></td>
                            </tr>
                            <tr><td style="border: none;"></td></tr>
                            <tr>
                                <td style="font-family:Arial;font-size:15px;border: none;" colspan=4><b>Date Info:</b></td>
                            </tr>
                            <tr>
                                <td style="border: none;font-family:Arial;font-size:15px;" colspan=4>
                                    <div>
                                        <div>Date from: ${moment(new Date(date_from)).format("MM/DD/YYYY hh:mm A")}</div>
                                        <div>Date to: ${moment(new Date(date_to)).format("MM/DD/YYYY hh:mm A")}</div>
                                        <div>&nbsp;</div>
                                        <div>Generated on: ${moment(new Date()).format("MM/DD/YYYY hh:mm A")}</div>
                                    </div>
                                </td>
                            </tr>
                            <tr><td style="border: none;"></td></tr>
                            <tr><td style="border: none;"></td></tr>
                            <tr>
                                <td style="font-family:Arial;font-size:15px;background-color:black;color:white;${width[0]}text-align:center;"><b>Vehicle</b></td>
                                <td style="font-family:Arial;font-size:15px;background-color:black;color:white;text-align:center;${width[1]}"><b>Start Date</b></td>
                                <td style="font-family:Arial;font-size:15px;background-color:black;color:white;text-align:center;${width[2]}"><b>Start Time</b></td>
                                <td style="font-family:Arial;font-size:15px;background-color:black;color:white;text-align:center;${width[1]}"><b>End Date</b></td>
                                <td style="font-family:Arial;font-size:15px;background-color:black;color:white;text-align:center;${width[2]}"><b>End Time</b></td>
                                <td style="font-family:Arial;font-size:15px;background-color:black;color:white;text-align:center;${width[3]}"><b>Duration (hrs)</b></td>
                                <td style="font-family:Arial;font-size:15px;background-color:black;color:white;text-align:center;${width[4]}"><b>Event State</b></td>
                                <td style="font-family:Arial;font-size:15px;background-color:black;color:white;text-align:center;${width[5]}"><b>Start Address</b></td>
                                <td style="font-family:Arial;font-size:15px;background-color:black;color:white;text-align:center;${width[6]}"><b>End Address</b></td>
                            </tr>
                            ${empty}
                        </table>`;
            },
            ULAR: function(title,docs,date_from,date_to){
                var empty = "",
                    width = ["width:150px;","width:200px;","width:160px;","width:160px;","width:70px;","width:15px;","width:115px;","width:400px;"];

                docs.forEach((val,i) => {
                    var user = getUser(val.username) || {};
                    var duration = (val.logout_date) ? new Date(val.logout_date).getTime() - new Date(val.login_date).getTime() : "-";
                    empty += `<tr style="text-align:center">
                                <td style="font-family:Arial;font-size:15px;border:none;border-bottom:1px solid #eee;mso-number-format:'\@';text-align:left;">${val.username}</td>
                                <td style="font-family:Arial;font-size:15px;border:none;border-bottom:1px solid #eee;mso-number-format:'\@';text-align:left;">${user.name || "-"}</td>
                                <td style="font-family:Arial;font-size:15px;border:none;border-bottom:1px solid #eee;mso-number-format:'\@';text-align:left;">${DATETIME.FORMAT(val.login_date)}</td>
                                <td style="font-family:Arial;font-size:15px;border:none;border-bottom:1px solid #eee;mso-number-format:'\@';text-align:left;">${DATETIME.FORMAT(val.logout_date)}</td>
                                <td style="font-family:Arial;font-size:15px;border:none;border-bottom:1px solid #eee;mso-number-format:'\@';text-align:left;">${DATETIME.HH_MM(duration).hour_minute}</td>
                                <td style="font-family:Arial;font-size:15px;border:none;mso-number-format:'\@';">&nbsp;</td>
                                <td style="font-family:Arial;font-size:15px;border:none;border-bottom:1px solid #eee;mso-number-format:'\@';text-align:left;">${val.ip || "-"}</td>
                                <td style="font-family:Arial;font-size:15px;border:none;border-bottom:1px solid #eee;mso-number-format:'\@';text-align:left;">${val.location || "-"}</td>
                            </tr>`;
                });

                return `<table id="report-hidden" style="opacity:0;">
                            <tr>
                                <td style="font-family:Arial;font-size:15px;border: none;" colspan=4>Report name: <b style="color:#c00000;">${title}</b></td>
                            </tr>
                            <tr><td style="border: none;"></td></tr>
                            <tr>
                                <td style="font-family:Arial;font-size:15px;border: none;" colspan=4><b>Date Info:</b></td>
                            </tr>
                            <tr>
                                <td style="border: none;font-family:Arial;font-size:15px;" colspan=4>
                                    <div>
                                        <div>Date from: ${moment(new Date(date_from)).format("MM/DD/YYYY hh:mm A")}</div>
                                        <div>Date to: ${moment(new Date(date_to)).format("MM/DD/YYYY hh:mm A")}</div>
                                        <div>&nbsp;</div>
                                        <div>Generated on: ${moment(new Date()).format("MM/DD/YYYY hh:mm A")}</div>
                                    </div>
                                </td>
                            </tr>
                            <tr><td style="border: none;"></td></tr>
                            <tr><td style="border: none;"></td></tr>
                            <tr>
                                <td style="font-family:Arial;font-size:15px;border:none;border-bottom:1px solid #D0CECE;background-color:#D0CECE;color:#262626;${width[0]}text-align:left;"><b>Username</b></td>
                                <td style="font-family:Arial;font-size:15px;border:none;border-bottom:1px solid #D0CECE;background-color:#D0CECE;color:#262626;text-align:left;${width[1]}"><b>Name</b></td>
                                <td style="font-family:Arial;font-size:15px;border:none;border-bottom:1px solid #D0CECE;background-color:#D0CECE;color:#262626;text-align:left;${width[2]}"><b>Login Date</b></td>
                                <td style="font-family:Arial;font-size:15px;border:none;border-bottom:1px solid #D0CECE;background-color:#D0CECE;color:#262626;text-align:left;${width[3]}"><b>Logout Date</b></td>
                                <td style="font-family:Arial;font-size:15px;border:none;border-bottom:1px solid #D0CECE;background-color:#D0CECE;color:#262626;text-align:left;${width[4]}"><b>Duration</b></td>
                                <td style="font-family:Arial;font-size:15px;border:none;text-align:center;${width[5]}"><b></b></td>
                                <td style="font-family:Arial;font-size:15px;border:none;border-bottom:1px solid #D0CECE;background-color:#D0CECE;color:#262626;text-align:left;${width[6]}"><b>I.P. Address</b></td>
                                <td style="font-family:Arial;font-size:15px;border:none;border-bottom:1px solid #D0CECE;background-color:#D0CECE;color:#262626;text-align:left;${width[7]}"><b>Location (Based on I.P. Address)</b></td>
                            </tr>
                            ${empty}
                        </table>`;
            },
            desr:  {
                coket1: ( title, docs, customers, date_from, date_to ) => {
                    var rows = "";
                    var tblHeaderStyle = "font-family:Arial;font-size:15px;background-color:#404040;border-color:#404040;color:white;text-align:center;";
                    var tblBodyStyle = "font-family:Arial;font-size:15px;border:none;mso-number-format:'\@';vertical-align:top;";
    
                    function datetime(date){
                        var _date =  moment(new Date(date)).format("MM/DD/YYYY");
                        var _time = moment(new Date(date)).format("H:mm");
                        
                        return {
                            date: (_date == "Invalid date") ? "-" : _date,
                            time: (_time == "Invalid date") ? "-" : _time
                        }
                    }
    
                    docs.forEach(val => {
                        var data = new Dispatch(val);
    
                        var history = [];
                        var delay = { type: "", duration: "" };
                        Object.keys(data.history).forEach(key => {
                            var value = data.history[key] || "";
    
                            if(value.indexOf("Entry Update") > -1 || value.indexOf("Record updated") > -1){
                                var formattedDate = DATETIME.FORMAT(Number(key),"MM/DD/YYYY h:mm A");
                                var newValue = value.replace(/•/g,"-").replace(/Entry Update - /g,"- ").replace(/<br><br>/g,"<br>");
    
                                history.push(`${formattedDate}<br>${newValue}`);
                            }
    
                            function getEscalation(text){
                                const split = text.split(" - ");
                                const type = split[0]||"";
                                const escalationSplit = (split[1]||"").split(" ");
                                const escalationLevel = escalationSplit[1]||"";
    
                                var duration = 0;
    
                                var enteredOriginTimestamp = getDateTime("entered_origin",val,"last");
                                var queueingTimestamp = getDateTime("queueingAtOrigin",val,"first");
                                var processingTimestamp = getDateTime("processingAtOrigin",val,"first");
                                var idlingTimestamp = getDateTime("idlingAtOrigin",val,"first");
                                var inTransitTimestamp = getDateTime("in_transit",val,"last");
                                if(type == "Long Queueing") {
                                    (queueingTimestamp) ? duration = Number(key) - queueingTimestamp : null;
                                }
                                if(type == "Over CICO") {
                                    var finalTimestamp = [];
                                    enteredOriginTimestamp ? finalTimestamp.push(enteredOriginTimestamp) : null;
                                    queueingTimestamp ? finalTimestamp.push(queueingTimestamp) : null;
                                    processingTimestamp ? finalTimestamp.push(processingTimestamp) : null;
                                    idlingTimestamp ? finalTimestamp.push(idlingTimestamp) : null;
                                    finalTimestamp = finalTimestamp.sort()[0];
                                    (finalTimestamp) ? duration = Number(key) - finalTimestamp : null;
                                }
                                if(type == "Over Transit") {
                                    (inTransitTimestamp) ? duration = Number(key) - inTransitTimestamp : null;
                                }
    
                                return {
                                    type: type + " " + escalationLevel,
                                    duration: GET.ROUND_OFF(DATETIME.DH(duration)) + " h" 
                                }
                            }
                            if(value.toLowerCase().indexOf("over cico - escalation") > -1 || 
                               value.toLowerCase().indexOf("over transit - escalation") > -1 || 
                               value.toLowerCase().indexOf("long queueing - escalation") > -1){
                                    delay = getEscalation(value);
                               }
                        });
    
                        rows += `<tr>
                                    <td style="${tblBodyStyle}">${data._id}</td>
                                    <td style="${tblBodyStyle}">${data.vehicle}</td>
                                    <td style="${tblBodyStyle}">${data.trailer}</td>
                                    <td style="${tblBodyStyle}">${data.pal_cap}</td>
                                    <td style="${tblBodyStyle}">${data.origin}</td>
                                    <td style="${tblBodyStyle}">${data.destination}</td>
                                    <td style="${tblBodyStyle}">${data.route}</td>
                                    <td style="${tblBodyStyle}">${datetime(data.entered_datetime).date}</td>
                                    <td style="${tblBodyStyle}">${datetime(data.entered_datetime).time}</td>
                                    <td style="${tblBodyStyle}">${datetime(data.processing_datetime).date}</td>
                                    <td style="${tblBodyStyle}">${datetime(data.processing_datetime).time}</td>
                                    <td style="${tblBodyStyle}">${datetime(data.processing_out_datetime).date}</td>
                                    <td style="${tblBodyStyle}">${datetime(data.processing_out_datetime).time}</td>
                                    <td style="${tblBodyStyle}">${datetime(data.departure_date).date}</td>
                                    <td style="${tblBodyStyle}">${datetime(data.departure_date).time}</td>
                                    <td style="${tblBodyStyle}">${data.queueingDurationDh}</td>
                                    <td style="${tblBodyStyle}">${data.processingDurationDh}</td>
                                    <td style="${tblBodyStyle}">${data.idlingDurationDh}</td>
                                    <td style="${tblBodyStyle}">${data.cicoDh}</td>
                                    <td style="${tblBodyStyle}">${data.transitDurationDh}</td>
                                    <td style="${tblBodyStyle}">${datetime(data.complete_datetime).date}</td>
                                    <td style="${tblBodyStyle}">${datetime(data.complete_datetime).time}</td>
                                    <td style="${tblBodyStyle}">${data.postedByWithName}</td>
                                    <td style="${tblBodyStyle}">${datetime(data.posting_date).date}</td>
                                    <td style="${tblBodyStyle}">${datetime(data.posting_date).time}</td>
                                    <td style="${tblBodyStyle}">${data.shipment_type}</td>
                                    <td style="${tblBodyStyle}">${data.statusText}</td>
                                    <td style="${tblBodyStyle}">${$(`<span>${data.late_entry}</span>`).text()}</td>
                                    <td style="${tblBodyStyle}">${data.comments}</td>
                                    <td style="${tblBodyStyle}">${delay.type}</td>
                                    <td style="${tblBodyStyle}">${delay.duration}</td>
                                    <td style="${tblBodyStyle}width:500px;">${history.join("<br><br>")}</td>
                                </tr>`;
                    });
                    return `<table id="report-hidden" style="opacity:0;">
                                <tr>
                                    <td style="font-family:Arial;font-size:15px;border: none;" colspan=22>Report name: <b style="color:#c00000;">${title}</b></td>
                                </tr>
                                <tr><td style="border: none;"></td></tr>
                                <tr>
                                    <td style="font-family:Arial;font-size:15px;border: none;" colspan=22><b>Date Info:</b></td>
                                </tr>
                                <tr>
                                    <td style="border: none;font-family:Arial;font-size:15px;" colspan=22>
                                        <div>
                                            <div>Date from: ${moment(new Date(date_from)).format("MM/DD/YYYY hh:mm A")}</div>
                                            <div>Date to: ${moment(new Date(date_to)).format("MM/DD/YYYY hh:mm A")}</div>
                                            <div>&nbsp;</div>
                                            <div>Generated on: ${moment(new Date()).format("MM/DD/YYYY hh:mm A")}</div>
                                        </div>
                                    </td>
                                </tr>
                                <tr><td style="border: none;"></td></tr>
                                <tr><td style="border: none;"></td></tr>
                                <tr>
                                    <td style="${tblHeaderStyle}"><b>Shipment</b></td>
                                    <td style="${tblHeaderStyle}"><b>Vehicle</b></td>
                                    <td style="${tblHeaderStyle}"><b>Trailer</b></td>
                                    <td style="${tblHeaderStyle}"><b>Pal Cap</b></td>
                                    <td style="${tblHeaderStyle}"><b>Origin</b></td>
                                    <td style="${tblHeaderStyle}"><b>Destination</b></td>
                                    <td style="${tblHeaderStyle}"><b>Route</b></td>
                                    <td style="${tblHeaderStyle}"><b>Check In Date</b></td>
                                    <td style="${tblHeaderStyle}"><b>Check In Time</b></td>
                                    <td style="${tblHeaderStyle}"><b>Check In Processing Date</b></td>
                                    <td style="${tblHeaderStyle}"><b>Check In Processing Time</b></td>
                                    <td style="${tblHeaderStyle}"><b>Check Out Processing Date</b></td>
                                    <td style="${tblHeaderStyle}"><b>Check Out Processing Time</b></td>
                                    <td style="${tblHeaderStyle}"><b>Check Out Date</b></td>
                                    <td style="${tblHeaderStyle}"><b>Check Out Time</b></td>
                                    <td style="${tblHeaderStyle}"><b>Queueing Duration</b></td>
                                    <td style="${tblHeaderStyle}"><b>Processing Duration</b></td>
                                    <td style="${tblHeaderStyle}"><b>Idling Duration</b></td>
                                    <td style="${tblHeaderStyle}"><b>CICO Duration</b></td>
                                    <td style="${tblHeaderStyle}"><b>Transit Duration</b></td>
                                    <td style="${tblHeaderStyle}"><b>Completion Date</b></td>
                                    <td style="${tblHeaderStyle}"><b>Completion Time</b></td>
                                    <td style="${tblHeaderStyle}"><b>Posted By</b></td>
                                    <td style="${tblHeaderStyle}"><b>Posting Date</b></td>
                                    <td style="${tblHeaderStyle}"><b>Posting Time</b></td>
                                    <td style="${tblHeaderStyle}"><b>Shipment Type</b></td>
                                    <td style="${tblHeaderStyle}"><b>Status</b></td>
                                    <td style="${tblHeaderStyle}"><b>Late Entry</b></td>
                                    <td style="${tblHeaderStyle}"><b>Comments</b></td>
                                    <td style="${tblHeaderStyle}"><b>Delay</b></td>
                                    <td style="${tblHeaderStyle}"><b>Delay Duration</b></td>
                                    <td style="${tblHeaderStyle}width:500px;"><b>Remarks</b></td>
                                </tr>
                                ${rows}
                            </table>`;
                },
                coket2: ( title, docs, customers, date_from, date_to ) => {
                    // Legend:
                    //    · GBO - Grouped by Origin
                    //    · GBR - Grouped by Region
                    //    · NTL - National

                    /****** CSS ******/
                    const rotateCSS = ` -webkit-transform: rotate(-90deg);
                                        -moz-transform: rotate(-90deg);
                                        -ms-transform: rotate(-90deg);
                                        -o-transform: rotate(-90deg);
                                        transform: rotate(-90deg);
                                        mso-rotate: 90;
                                        -webkit-transform-origin: 50% 50%;
                                        -moz-transform-origin: 50% 50%;
                                        -ms-transform-origin: 50% 50%;
                                        -o-transform-origin: 50% 50%;
                                        transform-origin: 50% 50%;
                                        position: absolute;
                                        filter: progid:DXImageTransform.Microsoft.BasicImage(rotation=3);
                                        
                                        color: #595959;
                                        background-color: #E2EFDA;
                                        height: 127px;
                                        border: none;
                                        border-right: thin dashed #595959;`;

                    const tblHeaderCSS = `  background-color: #404040;
                                        color: white;
                                        font-size: 13px;
                                        text-align: center;
                                        border: thin solid #404040;
                                        font-weight: bold;
                                        vertical-align: middle;
                                        font-family: Franklin Gothic Book;`;
                                    
                    const noBorderCSS = `border: none;
                                    font-size: 13px;
                                    vertical-align: middle;
                                    font-family: Franklin Gothic Book;
                                    mso-number-format:'\@';`;
                    /****** end CSS ******/

                    // Detailed (Per shipment)
                    var detailsBodyHTML = "";

                    // maximum number of customers per shipment
                    var customerCount = 0;
                    var tempCount = 0;

                    // get highest number of customer per shipment
                    docs.forEach(val => { 
                        tempCount = (val.customers||[]).length;
                        
                        if(tempCount > customerCount){
                            customerCount = tempCount;
                        }
                    });

                    // default number of customer is 1
                    (customerCount == 0) ? customerCount = 1 : null;

                    // loop docs
                    docs.forEach(val => {

                        const origin = getGeofence(val.origin_id) || {};

                        const vehicle = getVehicle(val.vehicle_id) || {};

                        const beforeCheckOutTime = getDateTime("entered_origin",val) || getDateTime("dispatched",val);
                        const completeDateTime = getDateTime("complete",val,"last");

                        const calcCICO = (beforeCheckOutTime) ?  (getDateTime(clientCustom.status.enrouteToDestination,val,"last") - beforeCheckOutTime) : 0;
                        const cico = Number(DATETIME.DH(calcCICO || 0,null,"0"));
                        const cappedHours = 3;
                        const cappedCICO = (cico > cappedHours) ? cappedHours : cico;

                        const cicoDifference = cico - Number(origin.cico);
                        const cicoVariance = (cicoDifference > 0) ? DATETIME.HH_MM(null,cicoDifference).hour_minute : "-";

                        const transitDuration = getDuration("onDelivery",val);

                        var customersHtml = "";
                        var count = 0;
                        (val.customers||[]).forEach(cVal => {
                            count ++;

                            customersHtml += `
                                <td style="${noBorderCSS}text-align: center;">${(cVal.number || "")}</td>
                                <td style="${noBorderCSS}text-align: center;">${(cVal.name || "")}</td>
                            `;
                        });

                        // add empty td if this shipment's customer is less than the max customers
                        for(var i = count; i < customerCount; i++){
                            customersHtml += `
                                <td style="${noBorderCSS}text-align: center;"></td>
                                <td style="${noBorderCSS}text-align: center;"></td>
                            `;
                        }

                        detailsBodyHTML += `<tr>
                                                <td style="${noBorderCSS}text-align: left;">${val._id}</td>
                                                <td style="${noBorderCSS}text-align: center;">${(vehicle.name || "")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${(vehicle["Pal Cap"] || "")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${origin.short_name}</td>
                                                <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(beforeCheckOutTime,"MM/DD/YYYY")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(beforeCheckOutTime,"H:mm")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(val.departure_date,"MM/DD/YYYY")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(val.departure_date,"H:mm")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(completeDateTime,"MM/DD/YYYY")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${DATETIME.FORMAT(completeDateTime,"H:mm")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${cico ? DATETIME.HH_MM(null,cico).hour_minute : "-"}</td>
                                                <td style="${noBorderCSS}text-align: center;">${cappedCICO ? DATETIME.HH_MM(null,cappedCICO).hour_minute : "-"}</td>
                                                <td style="${noBorderCSS}text-align: center;">${DATETIME.HH_MM(null,origin.cico).hour_minute}</td>
                                                <td style="${noBorderCSS}text-align: center;">${cicoVariance}</td>
                                                <td style="${noBorderCSS}text-align: center;">${transitDuration ? DATETIME.HH_MM(transitDuration).hour_minute : "-"}</td>
                                                ${customersHtml}
                                                <td style="${noBorderCSS}text-align: center;">${(val.shipment_type || "")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${(val.delivery_sequence || "")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${(val.mdsd_usage || "")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${(val.support_unit || "")}</td>
                                                <td style="${noBorderCSS}text-align: center;">${vehicle["Site"] || ""}</td>
                                                <td style="${noBorderCSS}text-align: center;">${val.comments||""}</td>
                                            </tr>`;

                    });

                    const columns = ['shipment','vehicle','palCap','origin','checkInDate','checkInTime','checkOutDate','checkOutTime','arrivalDate','arrivalTime','actualCICO','cicoWithCapping_1','cicoTarget','cicoVariance',
                                     'deliveryDuration',  /** Insert Customers Here **/ 'shipmentType','deliverySequence','mdsdUsage','supportUnit','vehicleBaseSite','comments'];

                    var startIndex = 14;
                    for(var i = 0; i < customerCount; i++){
                        startIndex++;
                        columns.splice(startIndex, 0, ('customerNo|'+(i+1)));

                        startIndex++;
                        columns.splice(startIndex, 0, ('customerName|'+(i+1)));
                    }

                    // to be exported to file
                    return `<table id="report-hidden" style="opacity:0;">
                            <tr>
                                <td style="${noBorderCSS}" colspan=2>Report name: <b style="color:#c00000;">${title}</b></td>
                            </tr>
                            <tr><td style="${noBorderCSS}" colspan=2></td></tr>
                            <tr>
                                <td style="${noBorderCSS}" colspan=2>Date Info:</td>
                            </tr>
                            <tr>
                                <td style="${noBorderCSS}" colspan=2>
                                    <div>
                                        <div>Date from: ${moment(new Date(date_from)).format("MM/DD/YYYY hh:mm A")}</div>
                                        <div>Date to: ${moment(new Date(date_to)).format("MM/DD/YYYY hh:mm A")}</div>
                                        <div>&nbsp;</div>
                                        <div>Generated on: ${moment(new Date()).format("MM/DD/YYYY hh:mm A")}</div>
                                    </div>
                                </td>
                            </tr>
                            <tr><td style="${noBorderCSS}"></td></tr>
                            ${
                                REPORTS.columnHtml( 
                                    columns,
                                    rotateCSS,
                                    tblHeaderCSS
                                )
                            }
                            ${detailsBodyHTML}
                        </table> `;
                },
            },
            DESR: function(title,docs,date_from,date_to){
                var rows = "";
                var tblHeaderStyle = "font-family:Arial;font-size:15px;background-color:#404040;border-color:#404040;color:white;text-align:center;";
                var tblBodyStyle = "font-family:Arial;font-size:15px;border:none;mso-number-format:'\@';vertical-align:top;";

                function datetime(date){
                    var _date =  moment(new Date(date)).format("MM/DD/YYYY");
                    var _time = moment(new Date(date)).format("H:mm");
                    
                    return {
                        date: (_date == "Invalid date") ? "-" : _date,
                        time: (_time == "Invalid date") ? "-" : _time
                    }
                }

                docs.forEach(val => {
                    var data = new Dispatch(val);

                    var history = [];
                    var delay = { type: "", duration: "" };
                    Object.keys(data.history).forEach(key => {
                        var value = data.history[key] || "";

                        if(value.indexOf("Entry Update") > -1 || value.indexOf("Record updated") > -1){
                            var formattedDate = DATETIME.FORMAT(Number(key),"MM/DD/YYYY h:mm A");
                            var newValue = value.replace(/•/g,"-").replace(/Entry Update - /g,"- ").replace(/<br><br>/g,"<br>");

                            history.push(`${formattedDate}<br>${newValue}`);
                        }

                        function getEscalation(text){
                            const split = text.split(" - ");
                            const type = split[0]||"";
                            const escalationSplit = (split[1]||"").split(" ");
                            const escalationLevel = escalationSplit[1]||"";

                            var duration = 0;

                            var enteredOriginTimestamp = getDateTime("entered_origin",val,"last");
                            var queueingTimestamp = getDateTime("queueingAtOrigin",val,"first");
                            var processingTimestamp = getDateTime("processingAtOrigin",val,"first");
                            var idlingTimestamp = getDateTime("idlingAtOrigin",val,"first");
                            var inTransitTimestamp = getDateTime("in_transit",val,"last");
                            if(type == "Long Queueing") {
                                (queueingTimestamp) ? duration = Number(key) - queueingTimestamp : null;
                            }
                            if(type == "Over CICO") {
                                var finalTimestamp = [];
                                enteredOriginTimestamp ? finalTimestamp.push(enteredOriginTimestamp) : null;
                                queueingTimestamp ? finalTimestamp.push(queueingTimestamp) : null;
                                processingTimestamp ? finalTimestamp.push(processingTimestamp) : null;
                                idlingTimestamp ? finalTimestamp.push(idlingTimestamp) : null;
                                finalTimestamp = finalTimestamp.sort()[0];
                                (finalTimestamp) ? duration = Number(key) - finalTimestamp : null;
                            }
                            if(type == "Over Transit") {
                                (inTransitTimestamp) ? duration = Number(key) - inTransitTimestamp : null;
                            }

                            return {
                                type: type + " " + escalationLevel,
                                duration: GET.ROUND_OFF(DATETIME.DH(duration)) + " h" 
                            }
                        }
                        if(value.toLowerCase().indexOf("over cico - escalation") > -1 || 
                           value.toLowerCase().indexOf("over transit - escalation") > -1 || 
                           value.toLowerCase().indexOf("long queueing - escalation") > -1){
                                delay = getEscalation(value);
                           }
                    });

                    rows += `<tr>
                                <td style="${tblBodyStyle}">${data._id}</td>
                                <td style="${tblBodyStyle}">${data.vehicle}</td>
                                <td style="${tblBodyStyle}">${data.trailer}</td>
                                <td style="${tblBodyStyle}">${data.pal_cap}</td>
                                <td style="${tblBodyStyle}">${data.origin}</td>
                                <td style="${tblBodyStyle}">${data.destination}</td>
                                <td style="${tblBodyStyle}">${data.route}</td>
                                <td style="${tblBodyStyle}">${datetime(data.entered_datetime).date}</td>
                                <td style="${tblBodyStyle}">${datetime(data.entered_datetime).time}</td>
                                <td style="${tblBodyStyle}">${datetime(data.departure_date).date}</td>
                                <td style="${tblBodyStyle}">${datetime(data.departure_date).time}</td>
                                <td style="${tblBodyStyle}">${data.queueingDuration}</td>
                                <td style="${tblBodyStyle}">${data.processingDuration}</td>
                                <td style="${tblBodyStyle}">${data.idlingDuration}</td>
                                <td style="${tblBodyStyle}">${data.cico}</td>
                                <td style="${tblBodyStyle}">${data.transitDuration}</td>
                                <td style="${tblBodyStyle}">${datetime(data.complete_datetime).date}</td>
                                <td style="${tblBodyStyle}">${datetime(data.complete_datetime).time}</td>
                                <td style="${tblBodyStyle}">${data.postedByWithName}</td>
                                <td style="${tblBodyStyle}">${datetime(data.posting_date).date}</td>
                                <td style="${tblBodyStyle}">${datetime(data.posting_date).time}</td>
                                <td style="${tblBodyStyle}">${data.shipment_type}</td>
                                <td style="${tblBodyStyle}">${data.statusText}</td>
                                <td style="${tblBodyStyle}">${$(`<span>${data.late_entry}</span>`).text()}</td>
                                <td style="${tblBodyStyle}">${data.comments}</td>
                                <td style="${tblBodyStyle}">${delay.type}</td>
                                <td style="${tblBodyStyle}">${delay.duration}</td>
                                <td style="${tblBodyStyle}width:500px;">${history.join("<br><br>")}</td>
                            </tr>`;
                });
                return `<table id="report-hidden" style="opacity:0;">
                            <tr>
                                <td style="font-family:Arial;font-size:15px;border: none;" colspan=22>Report name: <b style="color:#c00000;">${title}</b></td>
                            </tr>
                            <tr><td style="border: none;"></td></tr>
                            <tr>
                                <td style="font-family:Arial;font-size:15px;border: none;" colspan=22><b>Date Info:</b></td>
                            </tr>
                            <tr>
                                <td style="border: none;font-family:Arial;font-size:15px;" colspan=22>
                                    <div>
                                        <div>Date from: ${moment(new Date(date_from)).format("MM/DD/YYYY hh:mm A")}</div>
                                        <div>Date to: ${moment(new Date(date_to)).format("MM/DD/YYYY hh:mm A")}</div>
                                        <div>&nbsp;</div>
                                        <div>Generated on: ${moment(new Date()).format("MM/DD/YYYY hh:mm A")}</div>
                                    </div>
                                </td>
                            </tr>
                            <tr><td style="border: none;"></td></tr>
                            <tr><td style="border: none;"></td></tr>
                            <tr>
                                <td style="${tblHeaderStyle}"><b>Shipment</b></td>
                                <td style="${tblHeaderStyle}"><b>Vehicle</b></td>
                                <td style="${tblHeaderStyle}"><b>Trailer</b></td>
                                <td style="${tblHeaderStyle}"><b>Pal Cap</b></td>
                                <td style="${tblHeaderStyle}"><b>Origin</b></td>
                                <td style="${tblHeaderStyle}"><b>Destination</b></td>
                                <td style="${tblHeaderStyle}"><b>Route</b></td>
                                <td style="${tblHeaderStyle}"><b>Check In Date</b></td>
                                <td style="${tblHeaderStyle}"><b>Check In Time</b></td>
                                <td style="${tblHeaderStyle}"><b>Check Out Date</b></td>
                                <td style="${tblHeaderStyle}"><b>Check Out Time</b></td>
                                <td style="${tblHeaderStyle}"><b>Queueing Duration</b></td>
                                <td style="${tblHeaderStyle}"><b>Processing Duration</b></td>
                                <td style="${tblHeaderStyle}"><b>Idling Duration</b></td>
                                <td style="${tblHeaderStyle}"><b>CICO Duration</b></td>
                                <td style="${tblHeaderStyle}"><b>Transit Duration</b></td>
                                <td style="${tblHeaderStyle}"><b>Completion Date</b></td>
                                <td style="${tblHeaderStyle}"><b>Completion Time</b></td>
                                <td style="${tblHeaderStyle}"><b>Posted By</b></td>
                                <td style="${tblHeaderStyle}"><b>Posting Date</b></td>
                                <td style="${tblHeaderStyle}"><b>Posting Time</b></td>
                                <td style="${tblHeaderStyle}"><b>Shipment Type</b></td>
                                <td style="${tblHeaderStyle}"><b>Status</b></td>
                                <td style="${tblHeaderStyle}"><b>Late Entry</b></td>
                                <td style="${tblHeaderStyle}"><b>Comments</b></td>
                                <td style="${tblHeaderStyle}"><b>Delay</b></td>
                                <td style="${tblHeaderStyle}"><b>Delay Duration</b></td>
                                <td style="${tblHeaderStyle}width:500px;"><b>Remarks</b></td>
                            </tr>
                            ${rows}
                        </table>`;
            },
            SER: function(title,docs,date_from,date_to){
                var rows = "";
                var tblHeaderStyle = "font-family:Arial;font-size:12px;font-weight:bold;text-align:center;height:22px;vertical-align:middle;";
                var tblBodyStyle = "font-family:Arial;font-size:12px;mso-number-format:'\@';font-weight:bold;text-align:center;";

                docs.forEach(val => {
                    var data = new Dispatch(val);
                    var comments = (data.comments == "-") ? "" : data.comments;

                    var timeIn = data.complete_datetime != "-" ? data.complete_datetime : data.incomplete_datetime;

                    const extraStyle = data.statusCode == "incomplete" ? "color: red;" : "";

                    rows += `<tr>
                                <td style="${tblBodyStyle}${extraStyle}">${data.truck_number}</td>
                                <td style="${tblBodyStyle}${extraStyle}">${data.destination}</td>
                                <td style="${tblBodyStyle}${extraStyle}">${data.shift_schedule}</td>
                                <td style="${tblBodyStyle}${extraStyle}">${data.departure_date}</td>
                                <td style="${tblBodyStyle}${extraStyle}">${timeIn}</td>
                                <td style="${tblBodyStyle}${extraStyle}">${(data.driver||"").toUpperCase()}</td>
                                <td style="${tblBodyStyle}${extraStyle}">${(data.checker||"").toUpperCase()}</td>
                                <td style="${tblBodyStyle}${extraStyle}">${(data.helper||"").toUpperCase()}</td>
                                <td style="${tblBodyStyle}${extraStyle}">${(comments||"").toUpperCase()}</td>
                            </tr>`;
                });
                var dateFrom = (moment(new Date(date_from)).format("MMMM DD, YYYY")).toUpperCase();
                var dateTo = (moment(new Date(date_to)).format("MMMM DD, YYYY")).toUpperCase();
                var finalDate = (dateFrom == dateTo) ? dateFrom : `${dateFrom} - ${dateTo}`;
                return `<table id="report-hidden" style="opacity:0;" data-SheetName="My custom sheet 0">
                            <tbody>
                                <tr> <td style="font-family:Arial;font-size:16.5px;text-align:center;" colspan=9><b>STRAIGHT AHEAD DELIVERY CORPORATION</b></td> </tr>
                                <tr> <td style="font-family:Arial;font-size:15px;text-align:center;" colspan=9><b>DELIVERY PERSONNEL TRUCK SCHEDULE</b></td> </tr>
                                <tr> <td style="font-family:Arial;font-size:13px;text-align:center;" colspan=9><b>SKELETAL WORK FORCE</b></td> </tr>
                                <tr> <td style="font-family:Arial;font-size:12px;text-align:center;" colspan=9><b>BASE TO BASE DELIVERY</b></td> </tr>
                                <tr> 
                                    <td style="font-family:Arial;font-size:12px;text-align:center;" colspan=7></td> 
                                    <td style="font-family:Arial;font-size:12px;text-align:right;"><b>DATE:</b></td> 
                                    <td style="font-family:Arial;font-size:12px;text-align:center;"><b>${finalDate}</b></td> 
                                </tr>
                                <tr>
                                    <td style="${tblHeaderStyle}width:70px;"><b>TRUCK</b></td>
                                    <td style="${tblHeaderStyle}width:65px;"><b>DEPOT</b></td>
                                    <td style="${tblHeaderStyle}width:125px;"><b>SCHEDULE</b></td>
                                    <td style="${tblHeaderStyle}width:100px;"><b>TIME OUT</b></td>
                                    <td style="${tblHeaderStyle}width:100px;"><b>TIME IN</b></td>
                                    <td style="${tblHeaderStyle}width:200px;"><b>DRIVER</b></td>
                                    <td style="${tblHeaderStyle}width:200px;"><b>CHECKER</b></td>
                                    <td style="${tblHeaderStyle}width:200px;"><b>HELPER</b></td>
                                    <td style="${tblHeaderStyle}width:300px;"><b>REMARKS</b></td>
                                </tr>
                                ${rows}
                            </tbody>
                        </table>`;
            },
            MTUR: function(title,docs,date_from,date_to,holidays){
                const sundayOrHolidayBG = "background-color:#FFF2CC;";

                // function to get how many specifid weekday there is in a month. Ex. There are 5 sundays in 08/01/2021
                function getAmountOfWeekDaysInMonth(date, weekday) {
                    date.date(1);
                    var dif = (7 + (weekday - date.weekday())) % 7 + 1;
                    return Math.floor((date.daysInMonth() - dif) / 7) + 1;
                }
                function getHolidaysOfThisMonth(date){
                    const dateMonth = moment(date).format("MM");
                    const dateYear = moment(date).format("YYYY");

                    var countHolidays = 0;

                    holidays.forEach(val => {
                        const startDateMonth = moment(val.start).format("MM");
                        const startDateYear = moment(val.start).format("YYYY");
                        const endDateMonth = moment(val.end).format("MM");
                        const endDateYear = moment(val.end).format("YYYY");
                        ((dateMonth == startDateMonth && dateYear == startDateYear) || (dateMonth == endDateMonth && dateYear == endDateYear)) ? countHolidays ++ : null;
                    });
                    return countHolidays;
                }
                function isDateHoliday(date){
                    var isHoliday = false;
                    holidays.forEach(val => {
                        const startDate = moment(val.start).startOf('day');
                        const endDate = moment(val.end).endOf('day');
                        
                        (date.isBetween(startDate, endDate, 'days', true)) ? isHoliday = true : null;
                    });
                    return isHoliday;
                }

                const ignoreWeekDay = 0;

                var excelHeaderStyle = "font-family:Arial;font-size:12px;font-weight:bold;vertical-align:middle;border:none;";
                var tblHeaderStyle = "font-family:Arial;font-size:12px;font-weight:bold;text-align:center;height:22px;vertical-align:middle;border:thin solid black;";
                var tblBodyStyle = "font-family:Arial;font-size:12px;mso-number-format:'\@';border:thin solid black;";
                var tblBottomStyle = "font-family:Arial;font-size:12px;font-weight:bold;vertical-align:middle;border:thin solid black;mso-number-format:'\@';text-align:center;";

                var finalClusters = [{cluster:"Total",sequence:0}];
                finalClusters = finalClusters.concat(LIST["clusters"]||[]);

                const month = moment(date_from).format("MMM");
                const year = moment(date_from).format("YYYY");
                const daysInMonth = moment(date_from).daysInMonth();
                const numberOfSundaysInMonth = getAmountOfWeekDaysInMonth(moment(date_from), ignoreWeekDay);
                const holidaysInMonth = getHolidaysOfThisMonth(date_from);
                const daysWithoutSundayAndHoliday = daysInMonth - numberOfSundaysInMonth - holidaysInMonth;

                var totalVehicles = LIST["vehicles"].length * daysWithoutSundayAndHoliday;
                var totalChassis = LIST["chassis"].length * daysWithoutSundayAndHoliday;
                var totalManpower = LIST["vehicle_personnel"].filter(x => x.occupation == "Driver" || x.occupation == "Checker" || x.occupation == "Helper").length * daysWithoutSundayAndHoliday;
                var totalDriver = LIST["vehicle_personnel"].filter(x => x.occupation == "Driver").length * daysWithoutSundayAndHoliday;
                var totalChecker = LIST["vehicle_personnel"].filter(x => x.occupation == "Checker").length * daysWithoutSundayAndHoliday;
                var totalHelper = LIST["vehicle_personnel"].filter(x => x.occupation == "Helper").length * daysWithoutSundayAndHoliday;


                var dataTotalVehicles = [];
                var dataTotalChassis = [];
                var dataTotalManpower = [];
                var dataTotalDriver = [];
                var dataTotalChecker = [];
                var dataTotalHelper = [];

                // for data from July 19, 2021 to present -- I don't know why they want that
                var aveDataTotalVehicles = [];
                var aveDataTotalChassis = [];
                var aveDataTotalManpower = [];
                var aveDataTotalDriver = [];
                var aveDataTotalChecker = [];
                var aveDataTotalHelper = [];

                var individualTableHtml = "";

                var dailyVehicleRows = {};
                var dailyChassisRows = {};
                var dailyDriverRows = {};
                var dailyCheckerRows = {};
                var dailyHelperRows = {};
                var countClusterColumns = 0;

                var dailyTableTitle = [];
                var dailyVehicleTableHeader = {};
                var dailyChassisTableHeader = {};
                var dailyDriverTableHeader = [];
                var dailyCheckerTableHeader = [];
                var dailyHelperTableHeader = [];
                var dailyTableSubHeader = [];

                var truckTypes = [];
                (LIST['vehicles']||[]).forEach(val => {
                    if(val.truck_type && !truckTypes.includes(val.truck_type)){
                        truckTypes.push(val.truck_type);
                    }
                });

                function generateRowData(cluster_id){
                    countClusterColumns ++;
                    var rowsArr = [];
                    for(var i = 1; i < daysInMonth+1; i++){
                        var dateMoment = moment(`${month} ${i}, ${year}`);
                        var date = dateMoment.format("MM/DD/YYYY");
                        var weekDay = Number(dateMoment.format("d"));
                        var isHoliday = isDateHoliday(dateMoment);

                        
                        var vehicle_ids = [];
                        var chassis_ids = [];
                        var manpower_driver_ids = [];
                        var manpower_checker_ids = [];
                        var manpower_helper_ids = [];

                        var uniqueVehicleList = [];
                        var uniqueChassisList = [];
                        var uniqueDriverList = [];
                        var uniqueCheckerList = [];
                        var uniqueHelperList = [];

                        var perTruckType = {};
                        truckTypes.forEach(val => {
                            perTruckType[val] = {
                                vehicle_ids: [],
                                chassis_ids: [],
                                manpower_driver_ids: [],
                                manpower_checker_ids: [],
                                manpower_helper_ids: [],

                                uniqueVehicleList: [],
                                uniqueChassisList: [],
                                uniqueDriverList: [],
                                uniqueCheckerList: [],
                                uniqueHelperList: [],
                            };
                        });

                        // if weekDay is not Sunday (0). Monday - 1 Saturday - 6
                        if(weekDay != ignoreWeekDay && !isHoliday){
    
                            var startEndDate = moment(date, "MM/DD/YYYY");
                            var filtered = docs.filter(x => moment(moment(x.scheduled_date).format("MM/DD/YYYY"), "MM/DD/YYYY").isBetween(startEndDate, startEndDate, 'days', '[]'));
        
        
                            filtered.forEach(val => {
                                var origin = getGeofence(val.origin_id) || {};
                                var vehicle = getVehicle(val.vehicle_id) || {};
                                var truck_type = vehicle.truck_type;
    
                                if(!cluster_id || origin.cluster_id == cluster_id){
                                    
                                    (val.vehicle_id) ? vehicle_ids.push(val.vehicle_id) : null;
                                    (val.chassis) ? chassis_ids.push(val.chassis) : null;
                                    (val.driver_id) ? manpower_driver_ids.push(val.driver_id) : null;
                                    (val.checker_id) ? manpower_checker_ids.push(val.checker_id) : null;
                                    (val.helper_id) ? manpower_helper_ids.push(val.helper_id) : null;
                                    
                                    (val.vehicle_id && !uniqueVehicleList.includes(val.vehicle_id)) ? uniqueVehicleList.push(val.vehicle_id) : null;
                                    (val.chassis && !uniqueChassisList.includes(val.chassis)) ? uniqueChassisList.push(val.chassis) : null;
                                    (val.driver_id && !uniqueDriverList.includes(val.driver_id)) ? uniqueDriverList.push(val.driver_id) : null;
                                    (val.checker_id && !uniqueCheckerList.includes(val.checker_id)) ? uniqueCheckerList.push(val.checker_id) : null;
                                    (val.helper_id && !uniqueHelperList.includes(val.helper_id)) ? uniqueHelperList.push(val.helper_id) : null;
            
                                    (val.vehicle_id) ? dataTotalVehicles.push(val.vehicle_id) : null;
                                    (val.chassis) ? dataTotalChassis.push(val.chassis) : null;
                                    (val.driver_id) ? dataTotalManpower.push(val.driver_id) : null;
                                    (val.checker_id) ? dataTotalManpower.push(val.checker_id) : null;
                                    (val.helper_id) ? dataTotalManpower.push(val.helper_id) : null;
                                    (val.driver_id) ? dataTotalDriver.push(val.driver_id) : null;
                                    (val.checker_id) ? dataTotalChecker.push(val.checker_id) : null;
                                    (val.helper_id) ? dataTotalHelper.push(val.helper_id) : null;
            
                                    if(new Date(val.posting_date).getTime() >= 1626624000000) {// July 19, 2021, 12:00 AM
                                        (val.vehicle_id) ? aveDataTotalVehicles.push(val.vehicle_id) : null;
                                        (val.chassis) ? aveDataTotalChassis.push(val.chassis) : null;
                                        (val.driver_id) ? aveDataTotalManpower.push(val.driver_id) : null;
                                        (val.checker_id) ? aveDataTotalManpower.push(val.checker_id) : null;
                                        (val.helper_id) ? aveDataTotalManpower.push(val.helper_id) : null;
                                        (val.driver_id) ? aveDataTotalDriver.push(val.driver_id) : null;
                                        (val.checker_id) ? aveDataTotalChecker.push(val.checker_id) : null;
                                        (val.helper_id) ? aveDataTotalHelper.push(val.helper_id) : null;
                                    }
    
                                    
                                    if(perTruckType[truck_type]){
                                        (val.vehicle_id) ? perTruckType[truck_type].vehicle_ids.push(val.vehicle_id) : null;
                                        (val.chassis) ? perTruckType[truck_type].chassis_ids.push(val.chassis) : null;
                                        (val.driver_id) ? perTruckType[truck_type].manpower_driver_ids.push(val.driver_id) : null;
                                        (val.checker_id) ? perTruckType[truck_type].manpower_checker_ids.push(val.checker_id) : null;
                                        (val.helper_id) ? perTruckType[truck_type].manpower_helper_ids.push(val.helper_id) : null;
                                        
                                        (val.vehicle_id && !perTruckType[truck_type].uniqueVehicleList.includes(val.vehicle_id)) ? perTruckType[truck_type].uniqueVehicleList.push(val.vehicle_id) : null;
                                        (val.chassis && !perTruckType[truck_type].uniqueChassisList.includes(val.chassis)) ? perTruckType[truck_type].uniqueChassisList.push(val.chassis) : null;
                                        (val.driver_id && !perTruckType[truck_type].uniqueDriverList.includes(val.driver_id)) ? perTruckType[truck_type].uniqueDriverList.push(val.driver_id) : null;
                                        (val.checker_id && !perTruckType[truck_type].uniqueCheckerList.includes(val.checker_id)) ? perTruckType[truck_type].uniqueCheckerList.push(val.checker_id) : null;
                                        (val.helper_id && !perTruckType[truck_type].uniqueHelperList.includes(val.helper_id)) ? perTruckType[truck_type].uniqueHelperList.push(val.helper_id) : null;
                                    }
                                }
                            });
        
                            var vehiclePercentage = GET.ROUND_OFF((uniqueVehicleList.length/totalVehicles)*100);
                            var chassisPercentage = GET.ROUND_OFF((uniqueChassisList.length/totalChassis)*100);
                            var driverPercentage = GET.ROUND_OFF((uniqueDriverList.length/totalManpower)*100);
                            var checkerPercentage = GET.ROUND_OFF((uniqueCheckerList.length/totalManpower)*100);
                            var helperPercentage = GET.ROUND_OFF((uniqueHelperList.length/totalManpower)*100);
    
                            rowsArr.push({
                                date,
    
                                totalVehicleCount: vehicle_ids.length || 0,
                                uniqueVehicleCount: uniqueVehicleList.length || 0,
                                totalVehiclePercentage: vehiclePercentage || 0,
                                
                                totalChassisCount: chassis_ids.length || 0,
                                uniqueChassisCount: uniqueChassisList.length || 0,
                                totalChassisPercentage: chassisPercentage || 0,
    
                                totalDriverCount: manpower_driver_ids.length || 0,
                                uniqueDriverCount: uniqueDriverList.length || 0,
                                totalDriverPercentage: driverPercentage || 0,
    
                                totalCheckerCount: manpower_checker_ids.length || 0,
                                uniqueCheckerCount: uniqueCheckerList.length || 0,
                                totalCheckerPercentage: checkerPercentage || 0,
    
                                totalHelperCount: manpower_helper_ids.length || 0,
                                uniqueHelperCount: uniqueHelperList.length || 0,
                                totalHelperPercentage: helperPercentage || 0,
    
                                perTruckType
                            });
                             
                            function dailyRows(id_list,tempDailyRows,totalCount,getCallback){
                                var tempList = {};
                                id_list.forEach(val => {
                                    var tempData = getCallback(val);
                                    if(tempData){
                                        tempList[tempData.name || tempData._id] = tempList[tempData.name || tempData._id] || 0;
                                        tempList[tempData.name || tempData._id]++;
                                    }
                                });
                                tempDailyRows[i] = tempDailyRows[i] || {}; 
        
                                Object.keys(tempList).forEach((key,i1) => {
                                    var percentage = GET.ROUND_OFF((tempList[key]/totalCount)*100);
                                    tempDailyRows[i][i1] = tempDailyRows[i][i1] || []; 
                                    tempDailyRows[i][i1].push(`<td style="${tblBodyStyle}text-align:center;">${i1+1}</td>
                                                                <td style="${tblBodyStyle}text-align:left;">${key}</td>
                                                                <td style="${tblBodyStyle}text-align:center;">${tempList[key]}</td>`);
                                    // tempDailyRows[i][i1].push(`<td style="${tblBodyStyle}text-align:center;font-weight:bold;">${key}</td>
                                    //                     <td style="${tblBodyStyle}text-align:center;">${tempList[key]}</td>
                                    //                     <td style="${tblBodyStyle}text-align:center;">${percentage}%</td>`);
                                });
                                if(Object.keys(tempDailyRows[i]).length > 0){
                                    Object.keys(tempDailyRows[i]).forEach((key) => {
                                        while(tempDailyRows[i][key].length < countClusterColumns){
                                            tempDailyRows[i][key].push(`<td></td><td></td><td></td>`);
                                        }
                                    });
                                } else {
                                    for(var r = 0; r < countClusterColumns; r++){
                                        tempDailyRows[i][r] = tempDailyRows[i][r] || []; 
                                        tempDailyRows[i][r].push(`<td></td><td></td><td></td>`);
                                    }
                                }
                                return tempDailyRows;
                            }
                            dailyVehicleRows = dailyRows(vehicle_ids,dailyVehicleRows,totalVehicles,(val) => { return getVehicle(val); });
                            dailyChassisRows = dailyRows(chassis_ids,dailyChassisRows,totalChassis,(val) => { return getChassis(val); });
                            dailyDriverRows = dailyRows(manpower_driver_ids,dailyDriverRows,totalManpower,(val) => { return getVehiclePersonnel(val); });
                            dailyCheckerRows = dailyRows(manpower_checker_ids,dailyCheckerRows,totalManpower,(val) => { return getVehiclePersonnel(val); });
                            dailyHelperRows = dailyRows(manpower_helper_ids,dailyHelperRows,totalManpower,(val) => { return getVehiclePersonnel(val); });
                        } else {
                            const ignoreType = isHoliday ? "Holiday" : "Sunday";

                            rowsArr.push({
                                date,
                                ignoreType,
    
                                totalVehicleCount: vehicle_ids.length || 0,
                                uniqueVehicleCount: uniqueVehicleList.length || 0,
                                totalVehiclePercentage: vehiclePercentage || 0,
                                
                                totalChassisCount: chassis_ids.length || 0,
                                uniqueChassisCount: uniqueChassisList.length || 0,
                                totalChassisPercentage: chassisPercentage || 0,
    
                                totalDriverCount: manpower_driver_ids.length || 0,
                                uniqueDriverCount: uniqueDriverList.length || 0,
                                totalDriverPercentage: driverPercentage || 0,
    
                                totalCheckerCount: manpower_checker_ids.length || 0,
                                uniqueCheckerCount: uniqueCheckerList.length || 0,
                                totalCheckerPercentage: checkerPercentage || 0,
    
                                totalHelperCount: manpower_helper_ids.length || 0,
                                uniqueHelperCount: uniqueHelperList.length || 0,
                                totalHelperPercentage: helperPercentage || 0,
    
                                perTruckType
                            });
                            // console.log("IT'S A SUNDAY",weekDay);
                        }
                    }
                    return rowsArr;
                }

                var tableTitle = [];
                var tableHeader = [];
                var tableSubHeader = [];
                var tableRows = [];

                var rows = {};

                finalClusters = SORT.ARRAY_OBJECT(finalClusters,"sequence",{sortType:"asc"});

                finalClusters.forEach(val => {
                    tableTitle.push(`<td style="${tblHeaderStyle}width:160px;text-align:left;" colspan=2><b>${val.cluster}</b></td>`);

                    dailyTableTitle.push(`<td style="${tblHeaderStyle}text-align:left;" colspan=2><b>${val.cluster}</b></td>`);

                    tableHeader.push(`<td style="${tblHeaderStyle}width:90px;" rowspan=2><b>Date</b></td>
                                      <td style="${tblHeaderStyle}width:90px;" rowspan=2><b>Truck Type</b></td>
                                      <td style="${tblHeaderStyle}width:160px;" colspan=2><b>Truck Utilization</b></td>
                                      <td style="${tblHeaderStyle}width:160px;" colspan=2><b>Chassis Utilization</b></td>
                                      <td style="${tblHeaderStyle}width:160px;" colspan=6><b>Manpower Utilization</b></td>`);

                    dailyTableSubHeader.push(`<td style="${tblHeaderStyle}width:30px;"><b>#</b></td>
                                              <td style="${tblHeaderStyle}width:180px;"><b>Truck</b></td>
                                              <td style="${tblHeaderStyle}width:60px;"><b>Trips</b></td>`);
                    // dailyTableSubHeader.push(`<td style="${tblHeaderStyle}width:80px;"><b>Truck</b></td>
                    //                             <td style="${tblHeaderStyle}width:80px;"><b>Trips</b></td>
                    //                             <td style="${tblHeaderStyle}width:80px;"><b>Percentage</b></td>`);

                    tableSubHeader.push(`<td style="${tblHeaderStyle}width:80px;"><b># Used</b></td>
                                         <td style="${tblHeaderStyle}width:80px;"><b>Percentage</b></td>
                                         <td style="${tblHeaderStyle}width:80px;"><b># Used</b></td>
                                         <td style="${tblHeaderStyle}width:80px;"><b>Percentage</b></td>
                                         <td style="${tblHeaderStyle}width:130px;"><b># Used (Driver)</b></td>
                                         <td style="${tblHeaderStyle}width:130px;"><b>Percentage (Driver)</b></td>
                                         <td style="${tblHeaderStyle}width:130px;"><b># Used (Checker)</b></td>
                                         <td style="${tblHeaderStyle}width:130px;"><b>Percentage (Checker)</b></td>
                                         <td style="${tblHeaderStyle}width:130px;"><b># Used (Helper)</b></td>
                                         <td style="${tblHeaderStyle}width:130px;"><b>Percentage (Helper)</b></td>`);
                    // [[data],[data1]]
                    
                    generateRowData(val._id).forEach((arr,i) => {   
                        const bgColor = arr.ignoreType ? sundayOrHolidayBG : "";

                        Object.keys(arr.perTruckType).forEach((key,iPtt) => {
                            var ptt = arr.perTruckType[key];
                            rows[`${arr.date}-${key}`] = rows[`${arr.date}-${key}`] || [];

                            var text = "";
                            (iPtt==0) ? text = arr.date : null;
                            (iPtt==1 && arr.ignoreType) ? text = `(${arr.ignoreType})` : null;

                            rows[`${arr.date}-${key}`].push(`<td class="test" style="${tblBodyStyle}text-align:center;font-weight:bold;${bgColor}">${text}</td>
                                                <td style="${tblBodyStyle}text-align:center;${bgColor}">${key}</td>
                                                <td style="${tblBodyStyle}text-align:center;${bgColor}">${ptt.uniqueVehicleList.length}</td>
                                                <td style="${tblBodyStyle}text-align:center;${bgColor}">${GET.ROUND_OFF((ptt.uniqueVehicleList.length/totalVehicles)*100)}%</td>
                                                <td style="${tblBodyStyle}text-align:center;${bgColor}">${ptt.uniqueChassisList.length}</td>
                                                <td style="${tblBodyStyle}text-align:center;${bgColor}">${GET.ROUND_OFF((ptt.uniqueChassisList.length/totalChassis)*100)}%</td>
                                                <td style="${tblBodyStyle}text-align:center;${bgColor}">${ptt.uniqueDriverList.length}</td>
                                                <td style="${tblBodyStyle}text-align:center;${bgColor}">${GET.ROUND_OFF((ptt.uniqueDriverList.length/totalManpower)*100)}%</td>
                                                <td style="${tblBodyStyle}text-align:center;${bgColor}">${ptt.uniqueCheckerList.length}</td>
                                                <td style="${tblBodyStyle}text-align:center;${bgColor}">${GET.ROUND_OFF((ptt.uniqueCheckerList.length/totalManpower)*100)}%</td>
                                                <td style="${tblBodyStyle}text-align:center;${bgColor}">${ptt.uniqueHelperList.length}</td>
                                                <td style="${tblBodyStyle}text-align:center;${bgColor}">${GET.ROUND_OFF((ptt.uniqueHelperList.length/totalManpower)*100)}%</td>`);
                        });

                        rows[`${arr.date}-total`] = rows[`${arr.date}-total`] || [];
                        rows[`${arr.date}-total`].push(`<td style="${tblBodyStyle}text-align:center;font-weight:bold;${bgColor}"></td>
                                            <td style="${tblBodyStyle}text-align:center;${bgColor}">Total</td>
                                            <td style="${tblBodyStyle}text-align:center;${bgColor}">${arr.uniqueVehicleCount}</td>
                                            <td style="${tblBodyStyle}text-align:center;${bgColor}">${arr.totalVehiclePercentage}%</td>
                                            <td style="${tblBodyStyle}text-align:center;${bgColor}">${arr.uniqueChassisCount}</td>
                                            <td style="${tblBodyStyle}text-align:center;${bgColor}">${arr.totalChassisPercentage}%</td>
                                            <td style="${tblBodyStyle}text-align:center;${bgColor}">${arr.uniqueDriverCount}</td>
                                            <td style="${tblBodyStyle}text-align:center;${bgColor}">${arr.totalDriverPercentage}%</td>
                                            <td style="${tblBodyStyle}text-align:center;${bgColor}">${arr.uniqueCheckerCount}</td>
                                            <td style="${tblBodyStyle}text-align:center;${bgColor}">${arr.totalCheckerPercentage}%</td>
                                            <td style="${tblBodyStyle}text-align:center;${bgColor}">${arr.uniqueHelperCount}</td>
                                            <td style="${tblBodyStyle}text-align:center;${bgColor}">${arr.totalHelperPercentage}%</td>`);
                                            
                                            
                        dailyVehicleTableHeader[i] = dailyVehicleTableHeader[i] || [];
                        dailyVehicleTableHeader[i].push(`<td style="${tblHeaderStyle}" colspan=3><b>Truck Utilization (${arr.totalVehiclePercentage}%)</b></td>`);
                                            
                        dailyChassisTableHeader[i] = dailyChassisTableHeader[i] || [];
                        dailyChassisTableHeader[i].push(`<td style="${tblHeaderStyle}" colspan=3><b>Chassis Utilization (${arr.totalChassisPercentage}%)</b></td>`);

                        dailyDriverTableHeader[i] = dailyDriverTableHeader[i] || [];
                        dailyDriverTableHeader[i].push(`<td style="${tblHeaderStyle}" colspan=3><b>Manpower Utilization - Driver (${arr.totalDriverPercentage}%)</b></td>`);

                        dailyCheckerTableHeader[i] = dailyCheckerTableHeader[i] || [];
                        dailyCheckerTableHeader[i].push(`<td style="${tblHeaderStyle}" colspan=3><b>Manpower Utilization - Checker (${arr.totalCheckerPercentage}%)</b></td>`);

                        dailyHelperTableHeader[i] = dailyHelperTableHeader[i] || [];
                        dailyHelperTableHeader[i].push(`<td style="${tblHeaderStyle}" colspan=3><b>Manpower Utilization - Helper (${arr.totalHelperPercentage}%)</b></td>`);
                    });
                });
                
                for(var i = 1; i < daysInMonth+1; i++){
                    var dateMoment = moment(`${month} ${i}, ${year}`);
                    var date = dateMoment.format("MM/DD/YYYY");
                    var weekDay = Number(dateMoment.format("d"));
                    var isHoliday = isDateHoliday(dateMoment);
                    const bgColor = (weekDay == ignoreWeekDay || isHoliday) ? sundayOrHolidayBG : "";
                    const holidayText = (isHoliday) ? " (Holiday)" : "";
                    // if weekDay is not Sunday (0). Monday - 1 Saturday - 6
                    // if(weekDay != ignoreWeekDay && !isHoliday){

                    function getRowsArr(rowArr){
                        var tempArr = [];
                        Object.keys(rowArr[i]||{}).forEach(i1 => {
                            tempArr.push(`<tr>${rowArr[i][i1].join(`<td style="border:none;"></td><td style="border:none;"></td>`)}</tr>`);
                        });
                        return tempArr;
                    }
                    
                    individualTableHtml += `<table id="report-hidden-${i}" data-SheetName="${dateMoment.format("MMM DD")}" border="1" style="border-collapse: collapse;opacity:0;">
                                        <tbody>
                                            <tr> <td style="${excelHeaderStyle}text-align:left;${bgColor}" colspan=5><b>Date: ${dateMoment.format("MMM DD, YYYY (dddd)")}${holidayText}</b></td> </tr>
                                            <tr> <td style="${excelHeaderStyle}text-align:left;" colspan=5><b>${title}</b></td> </tr>

                                            <tr> <td style="border:none;"></td><td style="border:none;"></td> </tr>
                                            <tr> <td style="border:none;"></td><td style="border:none;"></td> </tr>
                                            <tr> <td style="border:none;color:red;font-weight:bold;" colspan=3>TRUCK UTILIZATION</td> </tr>
                                            <tr>${dailyTableTitle.join(`<td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            <tr>${dailyVehicleTableHeader[i-1].join(`<td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            <tr>${dailyTableSubHeader.join(`<td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            ${getRowsArr(dailyVehicleRows).join("")}

                                            <tr> <td style="border:none;"></td><td style="border:none;"></td> </tr>
                                            <tr> <td style="border:none;"></td><td style="border:none;"></td> </tr>
                                            <tr> <td style="border:none;color:red;font-weight:bold;" colspan=3>CHASSIS UTILIZATION</td> </tr>
                                            <tr>${dailyTableTitle.join(`<td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            <tr>${dailyChassisTableHeader[i-1].join(`<td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            <tr>${dailyTableSubHeader.join(`<td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            ${getRowsArr(dailyChassisRows).join("")}

                                            <tr> <td style="border:none;"></td><td style="border:none;"></td> </tr>
                                            <tr> <td style="border:none;"></td><td style="border:none;"></td> </tr>
                                            <tr> <td style="border:none;color:red;font-weight:bold;" colspan=3>MANPOWER UTILIZATION (DRIVER)</td> </tr>
                                            <tr>${dailyTableTitle.join(`<td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            <tr>${dailyDriverTableHeader[i-1].join(`<td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            <tr>${dailyTableSubHeader.join(`<td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            ${getRowsArr(dailyDriverRows).join("")}

                                            <tr> <td style="border:none;"></td><td style="border:none;"></td> </tr>
                                            <tr> <td style="border:none;"></td><td style="border:none;"></td> </tr>
                                            <tr> <td style="border:none;color:red;font-weight:bold;" colspan=3>MANPOWER UTILIZATION (CHECKER)</td> </tr>
                                            <tr>${dailyTableTitle.join(`<td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            <tr>${dailyCheckerTableHeader[i-1].join(`<td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            <tr>${dailyTableSubHeader.join(`<td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            ${getRowsArr(dailyCheckerRows).join("")}

                                            <tr> <td style="border:none;"></td><td style="border:none;"></td> </tr>
                                            <tr> <td style="border:none;"></td><td style="border:none;"></td> </tr>
                                            <tr> <td style="border:none;color:red;font-weight:bold;" colspan=3>MANPOWER UTILIZATION (HELPER)</td> </tr>
                                            <tr>${dailyTableTitle.join(`<td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            <tr>${dailyHelperTableHeader[i-1].join(`<td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            <tr>${dailyTableSubHeader.join(`<td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                            ${getRowsArr(dailyHelperRows).join("")}
                                        </tbody>
                                    </table>`;
                }
                Object.keys(rows).forEach((key,i) => {
                    tableRows.push(`<tr>${rows[key].join(`<td style="border:none;"></td><td style="border:none;"></td>`)}</tr>`);
                });


                // trip based
                var monthlyVehicleUtilization = GET.ROUND_OFF((dataTotalVehicles.length/totalVehicles)*100);
                var monthlyChassisUtilization = GET.ROUND_OFF((dataTotalChassis.length/totalChassis)*100);
                var monthlyManpowerUtilization = GET.ROUND_OFF((dataTotalManpower.length/totalManpower)*100);
                var monthlyDriverUtilization = GET.ROUND_OFF((dataTotalDriver.length/totalDriver)*100);
                var monthlyCheckerUtilization = GET.ROUND_OFF((dataTotalChecker.length/totalChecker)*100);
                var monthlyHelperUtilization = GET.ROUND_OFF((dataTotalHelper.length/totalHelper)*100);
                
                var aveMonthlyVehicleUtilization = GET.ROUND_OFF((aveDataTotalVehicles.length/totalVehicles)*100);
                var aveMonthlyChassisUtilization = GET.ROUND_OFF((aveDataTotalChassis.length/totalChassis)*100);
                var aveMonthlyManpowerUtilization = GET.ROUND_OFF((aveDataTotalManpower.length/totalManpower)*100);
                var aveMonthlyDriverUtilization = GET.ROUND_OFF((aveDataTotalDriver.length/totalDriver)*100);
                var aveMonthlyCheckerUtilization = GET.ROUND_OFF((aveDataTotalChecker.length/totalChecker)*100);
                var aveMonthlyHelperUtilization = GET.ROUND_OFF((aveDataTotalHelper.length/totalHelper)*100);

                console.log("Vehicle",`${dataTotalVehicles.length}/${totalVehicles} = ${monthlyVehicleUtilization}%  |  ${aveDataTotalVehicles.length}/${totalVehicles} = ${aveMonthlyVehicleUtilization}%`);
                console.log("Chassis",`${dataTotalChassis.length}/${totalChassis} = ${monthlyChassisUtilization}%  |  ${aveDataTotalChassis.length}/${totalChassis} = ${aveMonthlyChassisUtilization}%`);
                console.log("Manpower",`${dataTotalManpower.length}/${totalManpower} = ${monthlyManpowerUtilization}%  |  ${aveDataTotalManpower.length}/${totalManpower} = ${aveMonthlyManpowerUtilization}%`);
                console.log("Driver",`${dataTotalDriver.length}/${totalDriver} = ${monthlyDriverUtilization}%  |  ${aveDataTotalDriver.length}/${totalDriver} = ${aveMonthlyDriverUtilization}%`);
                console.log("Checker",`${dataTotalChecker.length}/${totalChecker} = ${monthlyCheckerUtilization}%  |  ${aveDataTotalChecker.length}/${totalChecker} = ${aveMonthlyCheckerUtilization}%`);
                console.log("Helper",`${dataTotalHelper.length}/${totalHelper} = ${monthlyHelperUtilization}%  |  ${aveDataTotalHelper.length}/${totalHelper} = ${aveMonthlyHelperUtilization}%`);

                return `<table id="report-hidden" data-SheetName="Overview" border="1" style="border-collapse: collapse;opacity:0;">
                            <tbody>
                                <tr> <td style="${excelHeaderStyle}text-align:left;" colspan=5><b>${title}</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}text-align:left;" colspan=5><b>${moment(date_from).format("MM-YYYY")}</b></td> </tr>
                                <tr> <td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td> </tr>

                                <tr>${tableTitle.join(`<td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td>><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                <tr>${tableHeader.join(`<td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                <tr>${tableSubHeader.join(`<td style="border:none;"></td><td style="border:none;"></td>`)}</tr>
                                ${tableRows}
                                <tr> <td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td> </tr>
                                <tr> <td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td> </tr>

                                <tr> 
                                    <td style="${tblBottomStyle}"></td>
                                    <!--<td style="${tblBottomStyle}">Total #</td>-->
                                    <td style="${tblBottomStyle}">Monthly Utilization</td>
                                    <td style="${tblBottomStyle}">Average Monthly Utilization</td>
                                    <td style="${tblBottomStyle}">Total Trips</td>
                                </tr>
                                <tr> 
                                    <td style="${tblBottomStyle}">Truck</td>
                                    <!--<td style="${tblBottomStyle}">${totalVehicles}</td>-->
                                    <td style="${tblBottomStyle}">${monthlyVehicleUtilization}%</td>
                                    <td style="${tblBottomStyle}">${aveMonthlyVehicleUtilization}%</td>
                                    <td style="${tblBottomStyle}">${dataTotalVehicles.length}</td>
                                </tr>
                                <tr> 
                                    <td style="${tblBottomStyle}">Chassis</td>
                                    <!--<td style="${tblBottomStyle}">${totalChassis}</td>-->
                                    <td style="${tblBottomStyle}">${monthlyChassisUtilization}%</td>
                                    <td style="${tblBottomStyle}">${aveMonthlyChassisUtilization}%</td>
                                    <td style="${tblBottomStyle}">${dataTotalChassis.length}</td>
                                </tr>
                                <tr> 
                                    <td style="${tblBottomStyle}">Manpower</td>
                                    <!--<td style="${tblBottomStyle}">${totalManpower}</td>-->
                                    <td style="${tblBottomStyle}">${monthlyManpowerUtilization}%</td>
                                    <td style="${tblBottomStyle}">${aveMonthlyManpowerUtilization}%</td>
                                    <td style="${tblBottomStyle}">${dataTotalManpower.length}</td>
                                </tr>
                                <tr> 
                                    <td style="${tblBottomStyle}padding-left:25px;">Driver</td>
                                    <!--<td style="${tblBottomStyle}">${totalDriver}</td>-->
                                    <td style="${tblBottomStyle}">${monthlyDriverUtilization}%</td>
                                    <td style="${tblBottomStyle}">${aveMonthlyDriverUtilization}%</td>
                                    <td style="${tblBottomStyle}">${dataTotalDriver.length}</td>
                                </tr>
                                <tr> 
                                    <td style="${tblBottomStyle}padding-left:25px;">Checker</td>
                                    <!--<td style="${tblBottomStyle}">${totalChecker}</td>-->
                                    <td style="${tblBottomStyle}">${monthlyCheckerUtilization}%</td>
                                    <td style="${tblBottomStyle}">${aveMonthlyCheckerUtilization}%</td>
                                    <td style="${tblBottomStyle}">${dataTotalChecker.length}</td>
                                </tr>
                                <tr> 
                                    <td style="${tblBottomStyle}padding-left:25px;">Helper</td>
                                    <!--<td style="${tblBottomStyle}">${totalHelper}</td>-->
                                    <td style="${tblBottomStyle}">${monthlyHelperUtilization}%</td>
                                    <td style="${tblBottomStyle}">${aveMonthlyHelperUtilization}%</td>
                                    <td style="${tblBottomStyle}">${dataTotalHelper.length}</td>
                                </tr>


                                <!--<tr> <td style="${excelHeaderStyle}" colspan=5>Total # of Trucks: <b>${totalVehicles}</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}" colspan=5>Total # of Chassis: <b>${totalChassis}</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}" colspan=5>Total # of Manpower: <b>${totalManpower}</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}padding-left:25px;" colspan=5>Total # of Driver: <b>${totalDriver}</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}padding-left:25px;" colspan=5>Total # of Checker: <b>${totalChecker}</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}padding-left:25px;" colspan=5>Total # of Helper: <b>${totalHelper}</b></td> </tr>

                                <tr> <td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td> </tr>
                                <tr> <td style="${excelHeaderStyle}" colspan=5>Monthly Truck Utilization: <b>${monthlyVehicleUtilization}%</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}" colspan=5>Monthly Chassis Utilization: <b>${monthlyChassisUtilization}%</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}" colspan=5>Monthly Manpower Utilization: <b>${monthlyManpowerUtilization}%</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}padding-left:25px;" colspan=5>Monthly Driver Utilization: <b>${monthlyDriverUtilization}%</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}padding-left:25px;" colspan=5>Monthly Checker Utilization: <b>${monthlyCheckerUtilization}%</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}padding-left:25px;" colspan=5>Monthly Helper Utilization: <b>${monthlyHelperUtilization}%</b></td> </tr>

                                <tr> <td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td><td style="border:none;"></td> </tr>

                                <tr> <td style="${excelHeaderStyle}" colspan=5>Average Monthly Truck Utilization: <b>${aveMonthlyVehicleUtilization}%</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}" colspan=5>Average Monthly Chassis Utilization: <b>${aveMonthlyChassisUtilization}%</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}" colspan=5>Average Monthly Manpower Utilization: <b>${aveMonthlyManpowerUtilization}%</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}padding-left:25px;" colspan=5>Average Monthly Driver Utilization: <b>${aveMonthlyDriverUtilization}%</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}padding-left:25px;" colspan=5>Average Monthly Checker Utilization: <b>${aveMonthlyCheckerUtilization}%</b></td> </tr>
                                <tr> <td style="${excelHeaderStyle}padding-left:25px;" colspan=5>Average Monthly Helper Utilization: <b>${aveMonthlyHelperUtilization}%</b></td> </tr>-->
                            </tbody>
                        </table>
                        ${individualTableHtml}`;
            },
            CI_CO_R: function(title,docs,date_from,date_to){
                var lastGeofence,
                    lastTimestamp,
                    hasChangedGeofence = true,
                    extendSearchCount = 0;

                var tableHtml = `<table id="report-hidden" border="1" style="border-collapse: collapse;opacity:0;">
                                    <tr>
                                        <td style="font-size:15px;border:thin solid #ccc;">Parameter</td>
                                        <td style="font-size:15px;border:thin solid #ccc;" colspan=3>Check In and Check Out Time at Sites</td>
                                        ${emptyTd(2)}
                                        <td style="font-size:15px;border:thin solid #ccc;">ORIGIN</td>
                                        ${emptyTd(1)}
                                        <td style="font-size:15px;border:thin solid #ccc;">DESTINATION</td>
                                    </tr>
                                    <tr>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Vehicle</b></td>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Check In Date</b></td>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Check In Time</b></td>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Check Out Date</b></td>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Check Out Time</b></td>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Duration</b></td>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Site</b></td>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Site Code</b></td>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Destination</b></td>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Site Code</b></td>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Truck Status</b></td>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Equipt No</b></td>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Event State</b></td>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Truck Base Site</b></td>
                                        <td style="font-size:15px;border:thin solid #ccc;"><b>Truck Base Site Code</b></td>
                                    </tr>
                                    <tr>${emptyTd(15)}</tr>
                                </table>`;

                $(`body`).append(tableHtml);

                var extendSearchDetails = {};

                function getAddress(addr){
                    var finalStr = {
                        short_name: "",
                        code: ""
                    };
                    if(addr){
                        var str = addr.split(" - ");

                        var geofence = getGeofence(str[0],'short_name');

                        if(geofence){
                            finalStr = {
                                short_name: geofence.short_name || "",
                                code: geofence.code || ""
                            };
                        } else {
                            finalStr = {
                                short_name: str[0] || "",
                                code: ""
                            };
                        }
                    }
                    return finalStr;
                }
                function getOriginalAddress(addr){
                    addr = addr || "";
                    var separator = " - ";
                    
                    if(addr.indexOf(" - ") > -1)
                        separator = " - ";
                    else if(addr.indexOf("- ") > -1) 
                        separator = "- ";
                    else if(addr.indexOf(" -") > -1)
                        separator = " -";

                    var str = addr.split(separator);
                    return str[0];
                }

                docs.forEach((val,i) => {
                    
                    var _next = docs[i+1],
                        timestamp = lastTimestamp || val.timestamp,
                        startAddress = val.GEOFENCE_NAME,
                        endAddress = (_next && _next.USER_NAME == val.USER_NAME) ? _next.GEOFENCE_NAME : null,
                        sameCurrentAndNextAddress = getOriginalAddress(startAddress) == getOriginalAddress(endAddress),
                        sameCurrentAndNextVehicle = (_next && _next.USER_NAME == val.USER_NAME),
                        duration = (val.timestamp) ? Math.abs(new Date(timestamp).getTime() - new Date(val.timestamp).getTime()) : null;
                        
                    function processReport(){
                        hasChangedGeofence = false;

                        function addHTML(address,extendSearch){

                            function addTds(USER_NAME,startAddress,startTimestamp,endAddress,endTimestamp){
                                // do not make condition like !duration. Duration could be 0.
                                var site = getAddress(startAddress),
                                    destination = getAddress(endAddress),
                                    duration = (endTimestamp) ? Math.abs(new Date(startTimestamp).getTime() - new Date(endTimestamp).getTime()) : null,
                                    endDate = DATETIME.FORMAT(endTimestamp,"MM/DD/YYYY"),
                                    endTime = DATETIME.FORMAT(endTimestamp,"H:mm"),
                                    status = "Finished",
                                    _duration_ = (duration != null) ? GET.ROUND_OFF(DATETIME.DH(duration,null,"0"),1).toFixed(1) + ' h'  : "-";
                                if(new Date(date_to).getTime() > new Date().getTime() && duration == null){
                                    endDate = "-";
                                    endTime = "-";
                                    status = "Pending"
                                }
                                // do not use "ASSIGNED_VEHICLE_ID" because events from before does not save ASSIGNED_VEHICLE_ID
                                var vehicle = getVehicle(USER_NAME,"name") || {};

                                return `<td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;">${USER_NAME}</td>
                                        <td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;">${DATETIME.FORMAT(startTimestamp,"MM/DD/YYYY")}</td>
                                        <td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;">${DATETIME.FORMAT(startTimestamp,"H:mm")}</td>
                                        <td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;">${endDate}</td>
                                        <td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;">${endTime}</td>
                                        <td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;">${_duration_}</td>
                                        <td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;">${site.short_name}</td>
                                        <td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;text-align:center;">${site.code}</td>
                                        <td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;">${destination.short_name}</td>
                                        <td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;text-align:center;">${destination.code}</td>
                                        <td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;">${vehicle["Availability"]||""}</td>
                                        <td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;">${vehicle["Equipment Number"]||""}</td>
                                        <td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;">${status}</td>
                                        <td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;">${vehicle["Base Site"]||""}</td>
                                        <td style="font-size:15px;mso-number-format:'\@';border:thin solid #ccc;text-align:center;">${vehicle["Base Site Code"]||""}</td>`;
                            }

                            if(extendSearch){
                                $(`#report-hidden`).append(`<tr data-attribute="${val.USER_NAME}-${getOriginalAddress(val.GEOFENCE_NAME)}">${
                                    addTds(val.USER_NAME,startAddress,timestamp)
                                }</tr>`);
                                                
                                extendSearchDetails[`${val.USER_NAME}-${getOriginalAddress(val.GEOFENCE_NAME)}`] = timestamp;
                                $.ajax({
                                    url: `/api/events/${CLIENT.id}/${USER.username}/${JSON.stringify({
                                        USER_NAME: val.USER_NAME,
                                        // GEOFENCE_NAME: /DVO DC/, // do not include GEOFENCE_NAME because we need to know if geofenceHasBeenChanged - to know what event we will end
                                        timestamp: {
                                            $gte: new Date(val.timestamp).toISOString()
                                        }
                                    })}`,
                                    method: "GET",
                                    timeout: 90000, // 1 minute and 30 seconds
                                    headers: {
                                        "Authorization": SESSION_TOKEN
                                    },
                                    async: true
                                }).done(function (docs1) {
                                    var originalEvent = docs1[0];
                                    var found = false;

                                    docs1.forEach((val,i) => {
                                        /*** do not delete me. Code in events.js: XX001. Purpose:  originalEvent._id == val._id */
                                        if(!found && originalEvent._id == val._id){
                                            var endAddress = (docs1[i+1] && docs1[i+1].USER_NAME == val.USER_NAME) ? docs1[i+1].GEOFENCE_NAME : null;
                                            var sameCurrentAndNextAddress = getOriginalAddress(originalEvent.GEOFENCE_NAME) == getOriginalAddress(endAddress);

                                            extendSearchDetails[`${originalEvent.USER_NAME}-${getOriginalAddress(originalEvent.GEOFENCE_NAME)}`]
                                            var _timestamp = extendSearchDetails[`${originalEvent.USER_NAME}-${getOriginalAddress(originalEvent.GEOFENCE_NAME)}`];

                                            if(!sameCurrentAndNextAddress){
                                                found = true;
                                                $(`#report-hidden [data-attribute="${originalEvent.USER_NAME}-${getOriginalAddress(originalEvent.GEOFENCE_NAME)}"]`).html(
                                                    addTds(originalEvent.USER_NAME,originalEvent.GEOFENCE_NAME,_timestamp,null,val.timestamp)
                                                );
                                            }
                                        }
                                    });
                                    extendSearchDone();
                                });
                            } else {
                                if(duration == 0){
                                    extendSearchDone();
                                } else {
                                    $(`#report-hidden`).append(`<tr>${addTds(val.USER_NAME,startAddress,timestamp,address,val.timestamp)}</tr>`);
                                    extendSearchDone();
                                }
                            }
                        };

                        if(!sameCurrentAndNextAddress || val.RULE_NAME.indexOf("Outside") > -1){ //  || val.RULE_NAME.indexOf("Outside") > -1
                            hasChangedGeofence = true;
                        }
                        if(_next && getOriginalAddress(_next.GEOFENCE_NAME) == getOriginalAddress(val.GEOFENCE_NAME) && _next.USER_NAME == val.USER_NAME && !hasChangedGeofence){
                            if(!lastTimestamp) lastTimestamp = val.timestamp; // do not put in parent condition ^. It will be false if timestamp has value
                            extendSearchDone();
                        } else {
                            lastTimestamp = null;
                            lastGeofence = getOriginalAddress(startAddress);

                            // if current event vehicle is the same as next event vehicle
                            if(sameCurrentAndNextVehicle){

                                // if current event address is NOT the same as next event address
                                if(hasChangedGeofence){
                                    addHTML(endAddress);
                                } else {
                                    extendSearchDone();
                                }
                            } else {
                                // if rule name is NOT yet Outside Geofence (or Outside), 
                                // extend search to next possible event with date greater than current data's date and with the same vehicle - limited data response
                                if(val.RULE_NAME.indexOf("Outside") == -1){
                                    addHTML(endAddress,true);
                                } else {
                                    addHTML(endAddress);
                                }
                            }
                        }
                        if(!sameCurrentAndNextVehicle){
                            $(`#report-hidden`).append(`<tr>${emptyTd(15)}</tr><tr>${emptyTd(15)}</tr>`);
                        }
                    }
                    
                    if(hasChangedGeofence){
                        if(val.RULE_NAME == "Inside Geofence"){
                            processReport();
                        } else {
                            if(!sameCurrentAndNextVehicle){
                                $(`#report-hidden`).append(`<tr>${emptyTd(15)}</tr><tr>${emptyTd(15)}</tr>`);
                            }
                            extendSearchDone();
                        }
                    } else {
                        processReport();
                    }
                });

                function emptyTd(n){
                    var tds = "";
                    for(var i = 0; i < n; i++){
                        tds += '<td style="border:thin solid #ccc;"></td>';
                    }
                    return tds;
                }


                function extendSearchDone(){
                    extendSearchCount ++;
                    if(docs.length == extendSearchCount){
                        GENERATE.TABLE_TO_EXCEL.SINGLE("report-hidden",`${title}_${DATETIME.FORMAT(date_from,"MM_DD_YYYY_hh_mm_A")}_${DATETIME.FORMAT(date_to,"MM_DD_YYYY_hh_mm_A")}`);
                        $(`#report-hidden,#overlay,#temp-link,[data-SheetName]`).remove();
                    }
                }
            },
            OTDR: function(title,docs,date_from,date_to,notDownload){

                // Note:
                // Sample scenario: If TruckA departed SiteA 4 times and TruckB departed SiteB 2 times
                // Total Trucks = 2; // Unique vehicles (unique means no duplicates. 1 truck can have multiple events)
                // Number = 6; // total number of events
                // Percent = 33.33%; // = Number/Total Trucks

                // Also, Total Trucks is based on 'Site'

                // variable declation
                var totalEventsPerSite = docs.length;
                var extendSearchCount = 0;


                const summaryTotals = {
                    "total": (LIST['vehicles']||[]).length,
                    "12:00 AM - 07:00 AM-number": 0,
                    "12:00 AM - 07:00 AM-percent": 0,
                    "7:01 AM - 9:00 AM-number": 0,
                    "7:01 AM - 9:00 AM-percent": 0,
                    "9:01 AM - 12:00 PM-number": 0,
                    "9:01 AM - 12:00 PM-percent": 0,
                    "12:01 PM - 3:00 PM-number": 0,
                    "12:01 PM - 3:00 PM-percent": 0,
                    "3:01 PM - 5:00 PM-number": 0,
                    "3:01 PM - 5:00 PM-percent": 0,
                    "5:01 PM - 11:59 PM-number": 0,
                    "5:01 PM - 11:59 PM-percent": 0,
                };
                const summaryObject = {};
                const individualObject = {};

                // 'lastTimestamp' and 'lastGeofence' is used to save timestamp and geofence of previous event
                var lastTimestamp;
                var lastGeofence;

                var hasChangedGeofence = true;

                const date = moment(new Date(date_from)).format("MM/DD/YYYY");
                const timeDataPerSite = {};
                const eventsPerSite = {};
                const grayBackground = "background-color:#eee;";


                (LIST["vehicles"]||[]).forEach(val => {
                    if(val["Site"]){
                        timeDataPerSite[val["Site"]] = timeDataPerSite[val["Site"]] || {
                            "12:00 AM - 07:00 AM": [],
                            "7:01 AM - 9:00 AM": [],
                            "9:01 AM - 12:00 PM": [],
                            "12:01 PM - 3:00 PM": [],
                            "3:01 PM - 5:00 PM": [],
                            "5:01 PM - 11:59 PM": [],
                        };
                    }
                });


                // function to check if target is in between two dates (start and finish)
                function isBetween(target,start,finish){
                    target = moment(target);
                    start = moment(new Date(`${date}, ${start}`)).startOf('minute');
                    finish = moment(new Date(`${date}, ${finish}`)).endOf('minute');

                    return target.isBetween(start, finish, 'minutes', '[]'); // all inclusive
                }

                // loop through all events
                docs.forEach((val,i) => {
                    hasChangedGeofence = false;
                    
                    var _next = docs[i+1];
                    var timestamp = lastTimestamp || val.timestamp;
                    var startAddress = val.GEOFENCE_NAME;
                    var sameCurrentAndNextVehicle = (_next && _next.USER_NAME == val.USER_NAME);
                    var duration = (val.timestamp) ? Math.abs(new Date(timestamp).getTime() - new Date(val.timestamp).getTime()) : 0;
                        
                    // console.log(val.USER_NAME,startAddress,val.stage,lastTimestamp,duration);

                    function processEvent(){

                        function getEventData(USER_NAME,startAddress,startTimestamp,endAddress,endTimestamp){
                            // do not make condition like !duration. Duration could be 0.
                            var duration = (endTimestamp) ? Math.abs(new Date(startTimestamp).getTime() - new Date(endTimestamp).getTime()) : null,
                                endDate = DATETIME.FORMAT(endTimestamp,"MM/DD/YYYY"),
                                endTime = DATETIME.FORMAT(endTimestamp,"hh:mm:ss A"),
                                status = "Finished",
                                _duration_ = (duration != null) ? DATETIME.DURATION_TIME_FORMAT(duration,1,1,1)  : "-";

                            if(new Date(date_to).getTime() > new Date().getTime() && duration == null){
                                endDate = "";
                                endTime = "";
                                status = "Pending"
                            }
                            // do not use 'ASSIGNED_VEHICLE_ID because events from before does not save 'ASSIGNED_VEHICLE_ID'
                            var vehicle = getVehicle(USER_NAME,"name") || {};

                            return endAddress ? {
                                "Date": moment(startTimestamp).format("M/D/YYYY"),
                                "Time": moment(startTimestamp).format("hh:mm:ss A"),
                                "Duration": _duration_,
                                "Vehicle": vehicle.name||"",
                                "Status": status,
                                "Check Out": startAddress,
                                "Check In": endAddress,
                                "Truck Base Site": vehicle["Site"]||"",
                                "Equipt No": vehicle["Equipment Number"]||"",
                                "Check In Date": endDate,
                                "Check In Time": endTime,
                                "Truck Base Site Code": vehicle["Site Code"]||"",
                                timestamp: new Date(startTimestamp).getTime() // for sorting later
                            } : null;
                        }

                        if(duration == 0){
                            extendSearchDone();
                        } else {
                            const eventData = getEventData(val.USER_NAME,lastGeofence,timestamp,startAddress,val.timestamp);
                            eventsPerSite[lastGeofence] = eventsPerSite[lastGeofence] || [];
                            eventData ? eventsPerSite[lastGeofence].push(eventData) : null;

                            extendSearchDone();
                        }
                    };

                    // only set 'hasChangedGeofence' to true if event stage is 'end'
                    (val.stage == "end") ? hasChangedGeofence = true : null;
                    
                    // if this event and next event has the same vehicle AND 'hasChangedGeofence' is false
                    if(_next && _next.USER_NAME == val.USER_NAME && !hasChangedGeofence){
                        // save timestamp and address
                        if(!lastTimestamp) {  // do not put in parent condition ^. It will be false if timestamp has value
                            lastTimestamp = val.timestamp;
                            lastGeofence = startAddress;
                        }
                        extendSearchDone();
                    } else {

                        // set 'lastTimestamp' to null because it's already either different vehicle or geofence
                        lastTimestamp = null;

                        // if current event vehicle is the same as next event vehicle
                        if(sameCurrentAndNextVehicle){
                            // if current event geofence is NOT the same as next event geofence
                            (hasChangedGeofence) ? processEvent() : extendSearchDone();
                        } else {
                            // if event stage is 'start', ignore
                            // else add data to html
                            (val.stage == "start") ? extendSearchDone() : processEvent();
                        }
                    }
                });

                function extendSearchDone(){
                    extendSearchCount ++;
                    
                    if(totalEventsPerSite == extendSearchCount){
                       
                        // get total vehicles per site
                        const totalVehicles = {};
                        (LIST["vehicles"]||[]).forEach(val => {
                            totalVehicles[val["Site"]] = totalVehicles[val["Site"]] || 0;
                            totalVehicles[val["Site"]] ++;
                        });

                        // sort events per site by geofence name (or key)
                        const sortedEventsPerSite = OBJECT.sortByKey(eventsPerSite);
                        Object.keys(sortedEventsPerSite).forEach((dc,i) => {

                            const sortedEvents = ARRAY.OBJECT.sort(sortedEventsPerSite[dc],"timestamp",{ sortType: "asc" });

                            const totalEvents = sortedEvents.length;
                            const totalVehicles = [];

                            var trsPerSite = "";

                            // the following variables are used to know if the period has changed.
                            // should add a blank tr everytime period changed
                            var periodChanged = false;
                            var lastPeriod = null;


                            // loop through the sorted events
                            sortedEvents.forEach(val => {
                                
                                // save list of vehicles per site per period
                                timeDataPerSite[val["Check Out"]] = timeDataPerSite[val["Check Out"]] || {
                                    "12:00 AM - 07:00 AM": [],
                                    "7:01 AM - 9:00 AM": [],
                                    "9:01 AM - 12:00 PM": [],
                                    "12:01 PM - 3:00 PM": [],
                                    "3:01 PM - 5:00 PM": [],
                                    "5:01 PM - 11:59 PM": [],
                                };

                                // 12:00 AM - 07:00 AM
                                if (isBetween(val.timestamp,"12:00 AM","7:00 AM")) {
                                    timeDataPerSite[val["Check Out"]]["12:00 AM - 07:00 AM"].push(val["Vehicle"]);
                                    lastPeriod = "12:00 AM - 07:00 AM";
                                }
                                // 7:01 AM - 9:00 AM
                                if (isBetween(val.timestamp,"7:01 AM","9:00 AM")) {
                                    timeDataPerSite[val["Check Out"]]["7:01 AM - 9:00 AM"].push(val["Vehicle"]);

                                    periodChanged = (lastPeriod && lastPeriod != "7:01 AM - 9:00 AM") ? true : false;
                                    lastPeriod = "7:01 AM - 9:00 AM";
                                }
                                // 9:01 AM - 12:00 PM
                                if (isBetween(val.timestamp,"9:01 AM","12:00 PM")) {
                                    timeDataPerSite[val["Check Out"]]["9:01 AM - 12:00 PM"].push(val["Vehicle"]);

                                    periodChanged = (lastPeriod && lastPeriod != "9:01 AM - 12:00 PM") ? true : false;
                                    lastPeriod = "9:01 AM - 12:00 PM";
                                }
                                // 12:01 PM - 3:00 PM
                                if (isBetween(val.timestamp,"12:01 PM","3:00 PM")) {
                                    timeDataPerSite[val["Check Out"]]["12:01 PM - 3:00 PM"].push(val["Vehicle"]);

                                    periodChanged = (lastPeriod && lastPeriod != "12:01 PM - 3:00 PM") ? true : false;
                                    lastPeriod = "12:01 PM - 3:00 PM";
                                }
                                // 3:01 PM - 5:00 PM
                                if (isBetween(val.timestamp,"3:01 PM","5:00 PM")) {
                                    timeDataPerSite[val["Check Out"]]["3:01 PM - 5:00 PM"].push(val["Vehicle"]);

                                    periodChanged = (lastPeriod && lastPeriod != "3:01 PM - 5:00 PM") ? true : false;
                                    lastPeriod = "3:01 PM - 5:00 PM";
                                }
                                // 5:01 PM - 11:59 PM
                                if (isBetween(val.timestamp,"5:01 PM","11:59 PM")) {
                                    timeDataPerSite[val["Check Out"]]["5:01 PM - 11:59 PM"].push(val["Vehicle"]);

                                    periodChanged = (lastPeriod && lastPeriod != "5:01 PM - 11:59 PM") ? true : false;
                                }
                                // end save list of vehicles per site per period
                                        

                                // add blank tr everytime period changed
                                periodChanged ? trsPerSite += `<tr><td colspan=12></td></tr>` : null;

                                // add tr data per site (html)
                                trsPerSite += `
                                    <tr>
                                        <td style="text-align:center;">${val["Date"]}</td>
                                        <td style="text-align:center;">${val["Time"]}</td>
                                        <td style="text-align:center;">${val["Duration"]}</td>
                                        <td style="text-align:center;">${val["Vehicle"]}</td>
                                        <td style="text-align:center;">${val["Status"]}</td>
                                        <td style="text-align:center;">${val["Check Out"]}</td>
                                        <td style="text-align:center;">${val["Check In"]}</td>
                                        <td style="text-align:center;">${val["Truck Base Site"]}</td>
                                        <td style="text-align:center;">${val["Equipt No"]}</td>
                                        <td style="text-align:center;">${val["Check In Date"]}</td>
                                        <td style="text-align:center;">${val["Check In Time"]}</td>
                                        <td style="text-align:center;">${val["Truck Base Site Code"]}</td>
                                    </tr>`;

                                // total unique vehicles per site
                                (totalVehicles.includes(val["Vehicle"])) ? null : totalVehicles.push(val["Vehicle"]);
                            });
                            individualObject[dc] = {
                                totalVehicles: totalVehicles.length,
                                sortedEvents
                            };

                            // append to body the table/sheet per site
                            $('body').append(`
                                <table id="report-hidden-${i}" data-SheetName="${dc}" border="1" style="border-collapse: collapse;opacity:0;">
                                    <tr>
                                        <td style="border: none;" colspan=4><b>OTD Report</b></td>
                                    </tr>
                                    <tr>
                                        <td style="border: none;" colspan=4><b>Geofence: ${dc}</b></td>
                                    </tr>
                                    <tr>
                                        <td style="border: none;" colspan=4><b>Period Start: ${moment(date_from).format("MM/DD/YYYY")}</b></td>
                                    </tr>
                                    <tr>
                                        <td style="border: none;" colspan=4><b>Period End: ${moment(date_from).format("MM/DD/YYYY")}</b></td>
                                    </tr>
                                    <tr>
                                        <td style="border: none;" colspan=4><b>Generated On: ${moment().format("MM/DD/YYYY, hh:mm A")}</b></td>
                                    </tr>
                                    <tr><td style="border: none;" colspan=4></td></tr>
                                    <tr>
                                        <td style="border: none;" colspan=4><b>Total Events: ${totalEvents}</b></td>
                                    </tr>
                                    <tr>
                                        <td style="border: none;" colspan=4><b>Total Vehicles: ${totalVehicles.length}</b></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight:bold;text-align:left;">Date</td>
                                        <td style="font-weight:bold;text-align:left;">Time</td>
                                        <td style="font-weight:bold;text-align:center;">Duration</td>
                                        <td style="font-weight:bold;text-align:center;">Vehicle</td>
                                        <td style="font-weight:bold;text-align:center;">Status</td>
                                        <td style="font-weight:bold;text-align:center;">Check Out</td>
                                        <td style="font-weight:bold;text-align:center;">Check In</td>
                                        <td style="font-weight:bold;text-align:center;">Truck Base Site</td>
                                        <td style="font-weight:bold;text-align:center;">Equipt No</td>
                                        <td style="font-weight:bold;text-align:center;">Check In Date</td>
                                        <td style="font-weight:bold;text-align:center;">Check In Time</td>
                                        <td style="font-weight:bold;text-align:center;">Truck Base Site Code</td>
                                    </tr>
                                    ${trsPerSite}
                                </table>`);
                        });

                        // used for Summary Sheet
                        // sort object by geofence name (or key)
                        const sortedTimeDataPerSite = OBJECT.sortByKey(timeDataPerSite);

                        console.log("sortedTimeDataPerSite",sortedTimeDataPerSite);

                        var summaryTableHtml = "";
                        Object.keys(sortedTimeDataPerSite).forEach(dc => {
                            var tdsSummary = "";

                            // set default value of this Site/DC = empty object
                            summaryObject[dc] = summaryObject[dc] || {};

                            // loop data per period for this site
                            Object.keys(sortedTimeDataPerSite[dc]).forEach((key,i) => {
                                // get events per site/dc per period
                                const eventsPerPeriod = sortedTimeDataPerSite[dc][key];
                                // calculate percentage
                                const percent = GET.ROUND_OFF((eventsPerPeriod.length/totalVehicles[dc]||0)*100);

                                tdsSummary += ` <td style="text-align:center;width:70px;${((i+1)%2 != 0) ? grayBackground : ""}">${eventsPerPeriod.length||""}</td>
                                                <td style="text-align:center;width:70px;${((i+1)%2 != 0) ? grayBackground : ""}">${percent?percent+"%":""}</td>`;

                                // save PERIOD-number to 'summaryTotals'
                                summaryTotals[key+"-number"] += eventsPerPeriod.length||0;

                                // save PERIOD-number and PERIOD-percent per Site/DC to 'summaryObject'
                                summaryObject[dc][key+"-number"] = eventsPerPeriod.length||0;
                                summaryObject[dc][key+"-percent"] = (percent||0)+"%";
                            });

                            // add row per site (html)
                            summaryTableHtml += `<tr>
                                                    <td style="">${dc}</td>
                                                    <td style="text-align:center;">${totalVehicles[dc]||0}</td>
                                                    <td style="width:5px;"></td>
                                                    ${tdsSummary}
                                                </tr>`;

                            // save totalVehicles per Site/DC to 'summaryObject'
                            summaryObject[dc]["totalVehicles"] = totalVehicles[dc]||0;
                        });

                        // calculate percent per period
                        // the reason for calculating them at the end is for us to already have the total Number
                        Object.keys(summaryTotals).forEach(key => {
                            // if key has a substring of "-number"
                            if(key.indexOf("-number") > -1){
                                // get the main key (period)
                                const mainKey = key.replace("-number","");
                                // calculate percentage = ( Number / Total Trucks ) * 100
                                const percent = (summaryTotals[key]/summaryTotals["total"])*100;

                                // save each percent per period to 'summaryTotals'
                                summaryTotals[mainKey+"-percent"] = GET.ROUND_OFF(percent) + "%";
                            }
                        });

                        // append Summary Table
                        $(`body`).prepend(`
                            <table id="report-hidden" data-SheetName="Summary" border="1" style="border-collapse: collapse;opacity:0;">
                                <tr>
                                    <td style="border: none;"><b>OTD Report (Summary)</b></td>
                                </tr>
                                <tr>
                                    <td style="border: none;"><b>Date: ${moment(date_from).format("MM/DD/YYYY")}</b></td>
                                </tr>
                                <tr>
                                    <td style="border: none;"><b>Generated On: ${moment().format("MM/DD/YYYY, hh:mm A")}</b></td>
                                </tr>
                                <tr><td style="border: none;"></td></tr>
                                <tr>
                                    <td style="font-weight:bold;text-align:right;" colspan=2>Period</td>
                                    <td style="font-weight:bold;text-align:right;"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}" colspan=2>12:00 AM to 7:00 AM</td>
                                    <td style="font-weight:bold;text-align:center;" colspan=2>7:01 AM to 9:00 AM</td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}" colspan=2>9:01 AM to 12:00 PM</td>
                                    <td style="font-weight:bold;text-align:center;" colspan=2>12:01 PM to 3:00 PM</td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}" colspan=2>3:01 PM to 5:00 PM</td>
                                    <td style="font-weight:bold;text-align:center;" colspan=2>5:01 PM to 11:59 PM</td>
                                </tr>
                                <tr>
                                    <td style="font-weight:bold;text-align:left;" rowspan=2></td>
                                    <td style="font-weight:bold;text-align:center;">Total Trucks</td>
                                    <td style="font-weight:bold;text-align:right;"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}">Number</td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}">%</td>
                                    <td style="font-weight:bold;text-align:center;">Number</td>
                                    <td style="font-weight:bold;text-align:center;">%</td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}">Number</td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}">%</td>
                                    <td style="font-weight:bold;text-align:center;">Number</td>
                                    <td style="font-weight:bold;text-align:center;">%</td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}">Number</td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}">%</td>
                                    <td style="font-weight:bold;text-align:center;">Number</td>
                                    <td style="font-weight:bold;text-align:center;">%</td>
                                </tr>
                                <tr>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}"></td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}"></td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}"></td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                </tr>
                                <tr>
                                    <td style="font-weight:bold;text-align:center;">TOTAL</td>
                                    <td style="font-weight:bold;text-align:center;">${summaryTotals["total"]}</td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}">${summaryTotals["12:00 AM - 07:00 AM-number"]}</td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}">${summaryTotals["12:00 AM - 07:00 AM-percent"]}</td>
                                    <td style="font-weight:bold;text-align:center;">${summaryTotals["7:01 AM - 9:00 AM-number"]}</td>
                                    <td style="font-weight:bold;text-align:center;">${summaryTotals["7:01 AM - 9:00 AM-percent"]}</td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}">${summaryTotals["9:01 AM - 12:00 PM-number"]}</td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}">${summaryTotals["9:01 AM - 12:00 PM-percent"]}</td>
                                    <td style="font-weight:bold;text-align:center;">${summaryTotals["12:01 PM - 3:00 PM-number"]}</td>
                                    <td style="font-weight:bold;text-align:center;">${summaryTotals["12:01 PM - 3:00 PM-percent"]}</td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}">${summaryTotals["3:01 PM - 5:00 PM-number"]}</td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}">${summaryTotals["3:01 PM - 5:00 PM-percent"]}</td>
                                    <td style="font-weight:bold;text-align:center;">${summaryTotals["5:01 PM - 11:59 PM-number"]}</td>
                                    <td style="font-weight:bold;text-align:center;">${summaryTotals["5:01 PM - 11:59 PM-percent"]}</td>
                                </tr>
                                <tr>
                                    <td style="font-weight:bold;text-align:left;">DC</td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}"></td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}"></td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}"></td>
                                    <td style="font-weight:bold;text-align:center;${grayBackground}"></td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                    <td style="font-weight:bold;text-align:center;"></td>
                                </tr>
                                ${summaryTableHtml}
                            </table>`);
                                 
                        // if 'notDownload' is null or undefined, it means it's for the Report
                        // else it's for Dashboard
                        if(notDownload !== true){
                            // loop each table with attribute '[data-SheetName]'.
                            var tableIds = [];
                            $(`[data-SheetName]`).each((i,el) => { tableIds.push(`#${$(el).attr("id")}`); });
                            GENERATE.TABLE_TO_EXCEL.MULTISHEET(tableIds.join(","), `${title}_${DATETIME.FORMAT(date_from,"MM_DD_YYYY")}.xls`);
                        }
                        // remove table anyway
                        $(`#report-hidden,#overlay,#temp-link,[data-SheetName]`).remove();
                    }
                }

                return {
                    summaryTotals,
                    summaryObject,
                    individualObject
                };
            },
        }
    }, 
    FUNCTION: {
        init:function(){
            PAGE.DISPLAY();

            var _l_GeofenceList = [],
                _new_ = true,
                initializePage = function(){
                    var geofencesOptions = `<option value="">All</option>`;
                    (LIST["geofences"]||[]).forEach(val => {
                        geofencesOptions += `<option value="${val._id}">${val.value}</option>`;
                    });
                    
                    var _siteId = "",
                        _siteText = "All",
                        date_from,
                        date_to,
                        df_dt_dest = function(title,modal,_siteTitle,dateTitle,callback){
                            _siteId = "";

                            $(`body`).append(REPORTS.UI[modal](title,_siteTitle,dateTitle));
                            $(`#date_from,#date_to`).val(DATETIME.FORMAT(new Date(),"YYYY-MM-DD"));
                            $("#_site,#_origin_site,#_destination_site").html(geofencesOptions).select2().val("").change(function(){
                                _siteId = $(this).find("option:selected").val();
                                _siteText = $(this).find("option:selected").text();
                            });
                            $(`#generate-btn,#generate-1-btn`).click(function(){
                                callback($(this).attr("id"));
                            });
                        },
                        pagination = function(x){
                            $(`#generate-btn,#generate-1-btn`).html(`<i class="la la-spinner la-spin mr-1"></i> Calculating document size...`).attr("disabled",true);
                            // $(`#generate-btn,#generate-1-btn`).html(`<i class="la la-spinner la-spin mr-1"></i> 0%`).attr("disabled",true);

                            $.ajax({
                                url: x.countURL,
                                method: "GET",
                                timeout: 90000, // 1 minute and 30 seconds
                                headers: {
                                    "Authorization": SESSION_TOKEN
                                },
                                async: true
                            }).done(function (count) {
                                console.log("count",count);

                                var pb = new ProgressBar(count);
                                var docs = [];
                                var skip = 0;
                                var percent = 0;


                                function retrieveData(length){
                                    if(length == null || length == LIMIT){
                                        $.ajax({
                                            url: `${x.dataURL}/${skip}/${LIMIT}`,
                                            method: "GET",
                                            timeout: 90000, // 1 minute and 30 seconds
                                            headers: {
                                                "Authorization": SESSION_TOKEN
                                            },
                                            async: true
                                        }).done(function (_docs_) {
                                            if(!_docs_.error){
                                                length = _docs_.length;
                        
                                                if(_docs_.error){
                                                    toastr.error(_docs_.error.message);
                                                } else {
                                                    skip += length;
                                                    docs = docs.concat(_docs_);
                                                    percent = pb.calculate();
                                                    console.log("percent|pb.origPerc",percent,pb.origPerc);
                                                    
                                                    $(`#generate-btn,#generate-1-btn`).html(`<i class="la la-spinner la-spin mr-1"></i> ${percent}%`);
                                                    pb.increase(percent,percent+pb.origPerc,'#generate-btn,#generate-1-btn');
                                                    
                                                    retrieveData(length);
                                                }
                                            }
                                        });
                                    } else {
                                        console.log("percent",percent);
                                        pb.increase(percent,100,'#generate-btn,#generate-1-btn',2);
                                        setTimeout(function(){
                                            $(`#generate-btn,#generate-1-btn`).html(`<i class="la la-spinner la-spin mr-1"></i> 100%`);
                                            setTimeout(function(){
                                                x.callback(docs);
                                                if(!x.doNotRemoveTable){
                                                    $(`#report-hidden,#overlay,#temp-link,[data-SheetName]`).remove();
                                                }
                                            },150);
                                        },300);
                                    }
                                }
                                retrieveData();

                            });
                        },
                        cicor_report = function(_filter,callback){
                            var daterange = $(`#daterange`).val(),
                                filteredDaterange = FILTER.DATERANGE(daterange);
                                
                            date_from = filteredDaterange.$gte;
                            date_to = filteredDaterange.$lt;

                            if(date_from.isEmpty() || date_to.isEmpty()){
                                toastr.error("Please fill all the required fields.");
                            } else {
                                var filter = {
                                        status: _filter.status || "complete",
                                        posting_date: FILTER.DATERANGE(`${DATETIME.FORMAT(date_from,"MM/DD/YYYY")} - ${DATETIME.FORMAT(date_to,"MM/DD/YYYY")}`)
                                    },
                                    filterSite = (_siteId != "") ? _filter : {};
                                    
                                filter = $.extend(filter,filterSite);

                                pagination({
                                    countURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                                    dataURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}`,
                                    callback
                                });
                            }
                        },
                        otr_report = function(_filter,callback){
                            var daterange = $(`#daterange`).val(),
                                filteredDaterange = FILTER.DATERANGE(daterange);
                                
                            date_from = filteredDaterange.$gte;
                            date_to = filteredDaterange.$lt;

                            if(date_from.isEmpty() || date_to.isEmpty()){
                                toastr.error("Please fill all the required fields.");
                            } else {
                                var filter = {
                                        status: _filter.status || "complete",
                                        posting_date: FILTER.DATERANGE(`${DATETIME.FORMAT(date_from,"MM/DD/YYYY")} - ${DATETIME.FORMAT(date_to,"MM/DD/YYYY")}`)
                                    },
                                    filterSite = (_siteId != "") ? _filter : {};
                                    
                                filter = $.extend(filter,filterSite);

                                pagination({
                                    countURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                                    dataURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}`,
                                    callback
                                });
                            }
                        },
                        dr_report = function(_filter,callback){
                            var daterange = $(`#daterange`).val(),
                                filteredDaterange = FILTER.DATERANGE(daterange);
                                
                            date_from = filteredDaterange.$gte;
                            date_to = filteredDaterange.$lt;

                            if(date_from.isEmpty() || date_to.isEmpty()){
                                toastr.error("Please fill all the required fields.");
                            } else {
                                var filter = {
                                    timestamp: FILTER.DATERANGE(`${DATETIME.FORMAT(date_from,"MM/DD/YYYY")} - ${DATETIME.FORMAT(date_to,"MM/DD/YYYY")}`)
                                };

                                pagination({
                                    countURL: `/api/notifications/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                                    dataURL: `/api/notifications/${CLIENT.id}/${USER.username}/dr/${JSON.stringify(filter)}`,
                                    callback
                                });
                            }
                        },
                        pbpa_report = function(_filter,callback){
                            var daterange = $(`#daterange`).val(),
                                filteredDaterange = FILTER.DATERANGE(daterange);
                                
                            date_from = filteredDaterange.$gte;
                            date_to = filteredDaterange.$lt;

                            if(date_from.isEmpty() || date_to.isEmpty()){
                                toastr.error("Please fill all the required fields.");
                            } else {
                                var filter = {
                                        status: "complete",
                                        departure_date: FILTER.DATERANGE(`${DATETIME.FORMAT(date_from,"MM/DD/YYYY")} - ${DATETIME.FORMAT(date_to,"MM/DD/YYYY")}`)
                                    },
                                    filterSite = (_siteId != "") ? _filter : {};
                                filter = $.extend(filter,filterSite);

                                pagination({
                                    countURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                                    dataURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}`,
                                    callback
                                });
                            }
                        },
                        hwtr_report = function(_filter,callback){
                            var daterange = $(`#daterange`).val(),
                                filteredDaterange = FILTER.DATERANGE(daterange);

                            date_from = filteredDaterange.$gte;

                            if(date_from.isEmpty()){
                                toastr.error("Please fill all the required fields.");
                            } else {
                                var filter = {
                                        // status: "complete",
                                        departure_date: FILTER.DATERANGE(`${DATETIME.FORMAT(date_from,"MM/DD/YYYY")}`)
                                    },
                                    filterSite = (_siteId != "") ? _filter : {};
                                filter = $.extend(filter,filterSite);

                                pagination({
                                    countURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                                    dataURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}`,
                                    callback
                                });
                            }
                        },
                        ar_report = function(callback){
                            var _date = $('#daterange').val().split("/"),
                                _month = _date[0],
                                _year = _date[1],
                                dateMoment = moment(`${_month} 01, ${_year}`),
                                startDate = dateMoment.clone().startOf('month').format("MM/DD/YYYY"),
                                endDate = dateMoment.clone().endOf('month').format("MM/DD/YYYY"),
                                daterange = `${startDate} - ${endDate}`,
                                filteredDaterange = FILTER.DATERANGE(daterange),
                                filter = {
                                    scheduled_date: filteredDaterange
                                }
                                
                            date_from = filteredDaterange.$gte;
                            date_to = filteredDaterange.$lt;

                            pagination({
                                countURL: `/api/vehicle_personnel/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                                dataURL: `/api/vehicle_personnel/${CLIENT.id}/${USER.username}/all/withShipments/${JSON.stringify(filter)}`,
                                callback: function(docs){
                                    
                                    /* get holidays from Google Calendar API
                                    -----------------------------------------------------------------*/
                                    
                                    const publicAPIKey = "AIzaSyC4GSP3uLbIvfO_RPqUzlEyxb9Duy5vjYk";
                                    const country = "philippines";
                                    var calendarUrl = 'https://www.googleapis.com/calendar/v3/calendars/en.' + country
                                                    + '%23holiday%40group.v.calendar.google.com/events?key=' + publicAPIKey;

                                    $.getJSON(calendarUrl).done(function(data) {
                                        console.log(data);
                                        const holidays = [];
                                        data.items.forEach(val => {
                                            holidays.push({
                                                title: val.summary,
                                                start: moment(val.start.date).format("YYYY-MM-DD"),
                                                end: moment(val.end.date).subtract(1,'day').format("YYYY-MM-DD")
                                            });
                                        });

                                        console.log("holidays",holidays)
                                    
                                        docs.sort(function (a, b) {
                                            return a.name.localeCompare(b.name);
                                        });
                                        callback(docs,holidays);
                                        
                                    }).fail(function(error) {
                                        console.log("error",error)
                                    });
                                }
                            });
                        },
                        tr_report = function(_filter,callback){
                            var daterange = $(`#daterange`).val(),
                                filteredDaterange = FILTER.DATERANGE(daterange);
                                
                            date_from = filteredDaterange.$gte;
                            date_to = filteredDaterange.$lt;

                            if(date_from.isEmpty() || date_to.isEmpty()){
                                toastr.error("Please fill all the required fields.");
                            } else {
                                var filter = {
                                        status: _filter.status || "complete",
                                        posting_date: FILTER.DATERANGE(`${DATETIME.FORMAT(date_from,"MM/DD/YYYY")} - ${DATETIME.FORMAT(date_to,"MM/DD/YYYY")}`)
                                    };

                                (_filter.destination_id) ? filter.destination_id = _filter.destination_id : null;
                                (_filter.origin_id) ? filter.origin_id = _filter.origin_id : null;
                                
                                pagination({
                                    countURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                                    dataURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}`,
                                    callback
                                });
                            }
                        },
                        vcr_report = function(callback){
                            var daterange = $(`#daterange`).val(),
                                filter = {
                                    timestamp: FILTER.DATERANGE(daterange,true,true),
                                };
                            date_from = filter.timestamp.$gte;
                            date_to = filter.timestamp.$lt;

                            pagination({
                                countURL: `/api/events/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                                dataURL: `/api/events/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}`,
                                callback: function(docs){
                                    docs.sort(function (a, b) {
                                        return a.USER_NAME.localeCompare(b.USER_NAME) || new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
                                    });
                                    callback(docs);
                                }
                            });
                        },
                        ular_report = function(callback){
                            var daterange = $(`#daterange`).val(),
                                filteredDaterange = FILTER.DATERANGE(daterange,true,true),
                                filter = {
                                    $or: [
                                        {login_date: filteredDaterange},
                                        {logout_date: filteredDaterange},
                                    ]
                                };
                            date_from = filteredDaterange.$gte;
                            date_to = filteredDaterange.$lt;

                            pagination({
                                countURL: `/api/user_login_activity/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                                dataURL: `/api/user_login_activity/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}`,
                                callback: function(docs){
                                    docs.sort(function (a, b) {
                                        return a.username.localeCompare(b.username) || new Date(a.login_date).getTime() - new Date(b.login_date).getTime();
                                    });
                                    callback(docs);
                                }
                            });
                        },
                        desr_report = function(callback){
                            var daterange = $(`#daterange`).val(),
                                filteredDaterange = FILTER.DATERANGE(daterange,true,true),
                                filter = { posting_date: filteredDaterange };
                                
                            date_from = filteredDaterange.$gte;
                            date_to = filteredDaterange.$lt;

                            pagination({
                                countURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                                dataURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}`,
                                callback: function(docs){
                                    docs.sort(function (a, b) {
                                        return new Date(a.posting_date).getTime() - new Date(b.posting_date).getTime();
                                    });
                                    callback(docs);
                                }
                            });
                        },
                        ser_report = function(callback){
                            var daterange = $(`#daterange`).val(),
                                filteredDaterange = FILTER.DATERANGE(daterange),
                                filter = { scheduled_date: filteredDaterange }; // , status: "scheduled"
                                
                            date_from = filteredDaterange.$gte;
                            date_to = filteredDaterange.$lt;

                            pagination({
                                countURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                                dataURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}`,
                                callback: function(docs){
                                    docs.sort(function (a, b) {
                                        return new Date(a.posting_date).getTime() - new Date(b.posting_date).getTime();
                                    });
                                    callback(docs);
                                }
                            });
                        },
                        mtur_report = function(callback){
                            var _date = $('#daterange').val().split("/"),
                                _month = _date[0],
                                _year = _date[1],
                                dateMoment = moment(`${_month} 01, ${_year}`),
                                startDate = dateMoment.clone().startOf('month').format("MM/DD/YYYY"),
                                endDate = dateMoment.clone().endOf('month').format("MM/DD/YYYY"),
                                daterange = `${startDate} - ${endDate}`,
                                filteredDaterange = FILTER.DATERANGE(daterange),
                                filter = { scheduled_date: filteredDaterange };
                                
                            date_from = filteredDaterange.$gte;
                            date_to = filteredDaterange.$lt;

                            pagination({
                                countURL: `/api/dispatch/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                                dataURL: `/api/dispatch/${CLIENT.id}/${USER.username}/mtur/${JSON.stringify(filter)}`,
                                callback: function(docs){
                                    console.log("docs",docs);

                                    /* get holidays from Google Calendar API
                                    -----------------------------------------------------------------*/
                                    
                                    const publicAPIKey = "AIzaSyC4GSP3uLbIvfO_RPqUzlEyxb9Duy5vjYk";
                                    const country = "philippines";
                                    var calendarUrl = 'https://www.googleapis.com/calendar/v3/calendars/en.' + country
                                                    + '%23holiday%40group.v.calendar.google.com/events?key=' + publicAPIKey;

                                    $.getJSON(calendarUrl).done(function(data) {
                                        console.log(data);
                                        const holidays = [];
                                        data.items.forEach(val => {
                                            holidays.push({
                                                title: val.summary,
                                                start: moment(val.start.date).toDate(),
                                                end: moment(val.end.date).subtract(1,'day').toDate()
                                            });
                                        });
                                        
                                        docs.sort(function (a, b) {
                                            return new Date(a.scheduled_date).getTime() - new Date(b.scheduled_date).getTime();
                                        });
                                        callback(docs,holidays);
                                        
                                    }).fail(function(error) {
                                        console.log("error",error)
                                    });
                                }
                            });
                        },
                        ci_co_r_report = function(callback){
                            var daterange = $(`#daterange`).val(),
                                filter = {
                                    timestamp: FILTER.DATERANGE(daterange,true,true),
                                };
                            date_from = filter.timestamp.$gte;
                            date_to = filter.timestamp.$lt;

                            pagination({
                                countURL: `/api/events/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                                dataURL: `/api/events/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}`,
                                callback: function(docs){
                                    docs.sort(function (a, b) {
                                        return a.USER_NAME.localeCompare(b.USER_NAME) || new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
                                    });
                                    callback(docs);
                                },
                                doNotRemoveTable: true
                            });
                        },
                        otdr_report = function(callback){
                            var daterange = $(`#daterange`).val(),
                                filter = {
                                    timestamp: FILTER.DATERANGE(daterange)
                                };
                            date_from = filter.timestamp.$gte;
                            date_to = filter.timestamp.$lt;

                            pagination({
                                countURL: `/api/events/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}/count`,
                                dataURL: `/api/events/${CLIENT.id}/${USER.username}/all/${JSON.stringify(filter)}`,
                                callback: function(docs){
                                    docs.sort(function (a, b) {
                                        return a.USER_NAME.localeCompare(b.USER_NAME) || new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime();
                                    });
                                    callback(docs);
                                },
                                doNotRemoveTable: true
                            });
                        };

                    // dependent of geofences!!!!!

                    /**************** REPORT LISTENER ****************/
                    $(`[cicor]`).click(function(){
                        var title = "CICO Report";
                        df_dt_dest(title,"REPORT_MODAL_02","Plant Site","Select Posting Date",function(){
                            cicor_report(
                                { origin_id: _siteId, status: { $nin: ["plan","scheduled","incomplete"] } },
                                function(docs){
                                    $(`body`).append(REPORTS.UI.REPORTS.cicor[CLIENT.id]( title, docs, _siteText, date_from, date_to ));
                                    GENERATE.TABLE_TO_EXCEL.SINGLE("report-hidden",`${title}_${DATETIME.FORMAT(date_from,"MM_DD_YYYY")}`);
                                }
                            );
                        });
                        $('#daterange').daterangepicker({
                            locale: {
                                format: 'MM/DD/YYYY'
                            }
                        });
                    });
                    $(`[dr]`).click(function(){
                        var title = "Delay Report";
                        df_dt_dest(title,"REPORT_MODAL_05",null,"Select Occurence Date",function(){
                            dr_report(
                                null,
                                function(docs){
                                    console.log("docs",docs);
                                    $(`body`).append(REPORTS.UI.REPORTS.dr[CLIENT.id](title,docs,_siteText,date_from,date_to));
                                    GENERATE.TABLE_TO_EXCEL.SINGLE("report-hidden",`${title}_${DATETIME.FORMAT(date_from,"MM_DD_YYYY")}`);
                                } 
                            );
                        });
                        $('#daterange').daterangepicker({
                            locale: {
                                format: 'MM/DD/YYYY'
                            }
                        });
                    });
                    $(`[otr]`).click(function(){
                        var title = "Transit Report";
                        df_dt_dest(title,"REPORT_MODAL_02","Plant Site","Select Posting Date",function(){
                            otr_report(
                                {origin_id: _siteId,status: { $nin: ["plan","scheduled","incomplete"] }},
                                function(docs){
                                    $(`body`).append(REPORTS.UI.REPORTS.otr[CLIENT.id](title,docs,_siteText,date_from,date_to));
                                    GENERATE.TABLE_TO_EXCEL.SINGLE("report-hidden",`${title}_${DATETIME.FORMAT(date_from,"MM_DD_YYYY")}`);
                                } 
                            );
                        });
                        $('#daterange').daterangepicker({
                            locale: {
                                format: 'MM/DD/YYYY'
                            }
                        });
                    });
                    $(`[pbpa]`).click(function(){
                        var title = "Per Base Plant Activity";
                        df_dt_dest(title,"REPORT_MODAL_01","Plant Base",undefined,function(){
                            pbpa_report(
                                {origin_id: _siteId},
                                function(docs){
                                    $(`body`).append(REPORTS.UI.REPORTS.PBPA(title,docs,_siteText,date_from,date_to));
                                    GENERATE.TABLE_TO_EXCEL.SINGLE("report-hidden",`${title}_${DATETIME.FORMAT(date_from,"MM_DD_YYYY")}`);
                                }
                            );
                        });
                        $('#daterange').daterangepicker({
                            locale: {
                                format: 'MM/DD/YYYY'
                            }
                        });
                    });
                    $(`[hwtr]`).click(function(){
                        var title = "Haulage Window Time Report";
                        df_dt_dest(title,"REPORT_MODAL_02","Destination Site",undefined,function(){
                            hwtr_report(
                                {destination: { $elemMatch: { "location_id": _siteId } }},
                                function(docs){
                                    $(`body`).append(REPORTS.UI.REPORTS.HWTR(title,docs,_siteText,date_from));
                                    GENERATE.TABLE_TO_EXCEL.SINGLE("report-hidden",`${title}_${DATETIME.FORMAT(date_from,"MM_DD_YYYY")}`);
                                }
                            );
                        });
                        $('#daterange').daterangepicker({
                            singleDatePicker: true,
                            locale: {
                                format: 'MM/DD/YYYY'
                            }
                        });
                    });
                    $(`[ar]`).click(function(){
                        
                        const title = "Attendance Report";
                        var customButtons = `<div class="col-sm-12 mt-4 p-0 mb-1">Generate report in:</div>
                                             <div class="col-sm-6 pl-0 pr-1"><button id="generate-btn" type="button" class="btn btn-primary col-sm-12"><b>.xls</b> format</button></div>
                                             <div class="col-sm-6 pl-1 pr-0"><button id="generate-1-btn" type="button" class="btn btn-primary col-sm-12"><b>.ods</b> format</button></div>`;
                        df_dt_dest(title,"REPORT_MODAL_07",customButtons,undefined,function(btnId){
                            ar_report(function(docs,holidays){
                                    const fileName = `${title}_${DATETIME.FORMAT(date_from,"MM_YYYY")}`;
                                    $(`body`).append(REPORTS.UI.REPORTS.AR(docs,date_from,holidays));

                                    if(btnId == "generate-1-btn"){
                                        // for OpenOffice
                                        function doExcel1 () {
                                            var blob,
                                                wb = {SheetNames:[], Sheets:{}};
                                            $(`[data-SheetName]`).each((i,el) => { 
                                                var sheetname = $(`#${$(el).attr("id")}`).attr("data-SheetName");
                                                var ws1 = XLSX.utils.table_to_sheet(el, {raw:true});
                                                if(!wb.SheetNames.includes(sheetname)){
                                                    wb.SheetNames.push(sheetname); 
                                                    wb.Sheets[sheetname] = ws1;
                                                }
                                            });
                                            
                                            blob = new Blob([s2ab(XLSX.write(wb, {bookType:'ods', type:'binary'}))], {
                                                type: "application/octet-stream"
                                            });
                                            
                                            saveAs(blob, `${fileName}.ods`);
                                            $(`#report-hidden,#overlay,#temp-link,[data-SheetName]`).remove();
                                        }
                                        doExcel1();
                                        // end for OpenOffice
                                    } else {
                                        const tableIds = [];
                                        $(`[data-SheetName]`).each((i,el) => { tableIds.push(`#${$(el).attr("id")}`); });
                                        GENERATE.TABLE_TO_EXCEL.MULTISHEET(tableIds.join(","), `${fileName}.xls`);
                                        $(`#report-hidden,#overlay,#temp-link,[data-SheetName]`).remove();
                                    }
                                }
                            );
                        });

                        $('#daterange').datepicker('remove').datepicker({
                            format: "mm/yyyy",
                            minViewMode: 1,
                            autoclose: true,
                            todayHighlight: true,
                            endDate: new Date()
                        }).datepicker("setDate",moment().format("MM/YYYY"));
                    });
                    $(`[tr]`).click(function(){
                        var title = "Trippage Report";
                        df_dt_dest(title,"REPORT_MODAL_04",null,"Select Posting Date",function(){
                            var origin = $(`#_origin_site option:selected`).text() || "All",
                                origin_id = $(`#_origin_site option:selected`).val() || null,
                                destination = $(`#_destination_site option:selected`).text() || "All",
                                destination_id = $(`#_destination_site option:selected`).val() || null,
                                
                                region = "-";
                            tr_report(
                                { origin_id, destination_id, status: { $nin: ["plan","scheduled","incomplete"] } }, function(docs){
                                    
                                    if(origin != "All"){
                                        const geofence = getGeofence(origin_id) || {};
                                        region = (getRegion(geofence.region_id)||{}).code || "-";
                                    }

                                    const location = { origin, destination, region };

                                    $(`body`).append(REPORTS.UI.REPORTS.tr[CLIENT.id]( title, docs, location, date_from, date_to ));
                                    GENERATE.TABLE_TO_EXCEL.SINGLE("report-hidden",`${title}_${DATETIME.FORMAT(date_from,"MM_DD_YYYY")}`);
                                    $(`#report-hidden,#overlay,#temp-link,[data-SheetName]`).remove();
                                }
                            );
                        });
                        $('#daterange').daterangepicker({
                            // singleDatePicker: true,
                            locale: {
                                format: 'MM/DD/YYYY'
                            }
                        });
                    });
                    $(`[vcr]`).click(function(){
                        var title = "Vehicle CICO Report";
                        df_dt_dest(title,"REPORT_MODAL_05",null,undefined,function(){
                            vcr_report(function(docs){
                                    $(`body`).append(REPORTS.UI.REPORTS.VCR(title,docs,date_from,date_to));
                                    GENERATE.TABLE_TO_EXCEL.SINGLE("report-hidden",`${title}_${DATETIME.FORMAT(date_from,"MM_DD_YYYY_hh_mm_A")}_${DATETIME.FORMAT(date_to,"MM_DD_YYYY_hh_mm_A")}`);
                                    $(`#report-hidden,#overlay,#temp-link,[data-SheetName]`).remove();
                                }
                            );
                        });
                        $('#daterange').daterangepicker({
                            timePicker: true,
                            locale: {
                                format: 'MM/DD/YYYY hh:mm A'
                            }
                        });
                    });
                    $(`[ular]`).click(function(){
                        var title = "User Login Activity Report";
                        df_dt_dest(title,"REPORT_MODAL_05",null,undefined,function(){
                            ular_report(function(docs){
                                    $(`body`).append(REPORTS.UI.REPORTS.ULAR(title,docs,date_from,date_to));
                                    GENERATE.TABLE_TO_EXCEL.SINGLE("report-hidden",`${title}_${DATETIME.FORMAT(date_from,"MM_DD_YYYY_hh_mm_A")}_${DATETIME.FORMAT(date_to,"MM_DD_YYYY_hh_mm_A")}`);
                                    $(`#report-hidden,#overlay,#temp-link,[data-SheetName]`).remove();
                                }
                            );
                        });
                        $('#daterange').daterangepicker({
                            timePicker: true,
                            locale: {
                                format: 'MM/DD/YYYY hh:mm A'
                            }
                        });
                    });
                    $(`[desr]`).click(function(){
                        const title = (CLIENT.id == "coket2") ? "Data Entry Summary Report" : "Dispatch Entries Summary Report";
                        df_dt_dest(title,"REPORT_MODAL_05",null,undefined,function(){
                            desr_report(function(docs){
                                $(`body`).append(REPORTS.UI.REPORTS.desr[CLIENT.id](title,docs,null,date_from,date_to));
                                GENERATE.TABLE_TO_EXCEL.SINGLE("report-hidden",`${title}_${DATETIME.FORMAT(date_from,"MM_DD_YYYY_hh_mm_A")}_${DATETIME.FORMAT(date_to,"MM_DD_YYYY_hh_mm_A")}`);
                                $(`#report-hidden,#overlay,#temp-link,[data-SheetName]`).remove();
                            });
                        });
                        $('#daterange').daterangepicker({
                            timePicker: true,
                            locale: {
                                format: 'MM/DD/YYYY hh:mm A'
                            }
                        });
                    });
                    $(`[ser]`).click(function(){
                        var title = "Scheduled Entries Report";
                        df_dt_dest(title,"REPORT_MODAL_05",null,undefined,function(){
                            ser_report(function(docs){
                                $(`body`).append(REPORTS.UI.REPORTS.SER(title,docs,date_from,date_to));
                                GENERATE.TABLE_TO_EXCEL.SINGLE("report-hidden",`${title}_${DATETIME.FORMAT(date_from,"MM_DD_YYYY_hh_mm_A")}_${DATETIME.FORMAT(date_to,"MM_DD_YYYY_hh_mm_A")}`);
                                $(`#report-hidden,#overlay,#temp-link,[data-SheetName]`).remove();
                            });
                        });

                        var minDate = moment().add(1,'days').format("MM/DD/YYYY");
                        var maxDate = moment().add(2,'days').format("MM/DD/YYYY");
                        $('#daterange').daterangepicker({
                            opens: 'left',
                            // singleDatePicker:true,
                            // minDate,
                            locale: {
                                format: 'MM/DD/YYYY'
                            },
                        }).val(`${minDate} - ${maxDate}`);
                        
                        $('#daterange').data('daterangepicker').setStartDate(minDate);
                        $('#daterange').data('daterangepicker').setEndDate(maxDate);
                    });
                    $(`[mtur]`).click(function(){
                        var title = "Manpower and Truck Utilization Report";
                        var customButtons = `<div class="col-sm-12 mt-4 p-0 mb-1">Generate report in:</div>
                                             <div class="col-sm-6 pl-0 pr-1"><button id="generate-btn" type="button" class="btn btn-primary col-sm-12"><b>.xls</b> format</button></div>
                                             <div class="col-sm-6 pl-1 pr-0"><button id="generate-1-btn" type="button" class="btn btn-primary col-sm-12"><b>.ods</b> format</button></div>`;
                        df_dt_dest(title,"REPORT_MODAL_07",customButtons,undefined,function(btnId){
                            mtur_report(function(docs,holidays){
                                $(`body`).append(REPORTS.UI.REPORTS.MTUR(title,docs,date_from,date_to,holidays));
                                var fileName = `${title}_${DATETIME.FORMAT(date_from,"MM_DD_YYYY_hh_mm_A")}_${DATETIME.FORMAT(date_to,"MM_DD_YYYY_hh_mm_A")}`;

                                if(btnId == "generate-1-btn"){
                                    // for OpenOffice
                                    function doExcel1 () {
                                        var blob,
                                            wb = {SheetNames:[], Sheets:{}};
                                        $(`[data-SheetName]`).each((i,el) => { 
                                            var sheetname = $(`#${$(el).attr("id")}`).attr("data-SheetName");
                                            var ws1 = XLSX.utils.table_to_sheet(el, {raw:true});
                                            wb.SheetNames.push(sheetname); 
                                            wb.Sheets[sheetname] = ws1;
                                        });
                                        
                                        blob = new Blob([s2ab(XLSX.write(wb, {bookType:'ods', type:'binary'}))], {
                                            type: "application/octet-stream"
                                        });
                                        
                                        saveAs(blob, `${fileName}.ods`);
                                        $(`#report-hidden,#overlay,#temp-link,[data-SheetName]`).remove();
                                    }
                                    doExcel1();
                                    // end for OpenOffice
                                } else {
                                    var tableIds = [];
                                    $(`[data-SheetName]`).each((i,el) => { tableIds.push(`#${$(el).attr("id")}`); });
                                    GENERATE.TABLE_TO_EXCEL.MULTISHEET(tableIds.join(","), `${fileName}.xls`);
                                    $(`#report-hidden,#overlay,#temp-link,[data-SheetName]`).remove();
                                }
                            });
                        });

                        $('#daterange').datepicker('remove').datepicker({
                            format: "mm/yyyy",
                            minViewMode: 1,
                            autoclose: true,
                            todayHighlight: true,
                            endDate: new Date()
                        }).datepicker("setDate",moment().format("MM/YYYY"));
                    });
                    $(`[ci_co_r]`).click(function(){
                        var title = "Check In Check Out Report";
                        df_dt_dest(title,"REPORT_MODAL_05",null,undefined,function(){
                            ci_co_r_report(function(docs){
                                REPORTS.UI.REPORTS.CI_CO_R(title,docs,date_from,date_to);
                            });
                        });

                        $('#daterange').daterangepicker({
                            timePicker: true,
                            locale: {
                                format: 'MM/DD/YYYY hh:mm A'
                            }
                        });
                    });
                    $(`[otdr]`).click(function(){
                        var title = "On Time Departure";
                        df_dt_dest(title,"REPORT_MODAL_03",null,undefined,function(){
                            otdr_report(function(docs){
                                REPORTS.UI.REPORTS.OTDR(title,docs,date_from,date_to);
                            });
                        });

                        $(`#daterange`).daterangepicker({
                            opens: 'left',
                            autoUpdateInput: false,
                            singleDatePicker:true,
                            autoApply: true,
                            locale: {
                                format: 'MM/DD/YYYY'
                            }
                        }, function(start, end, label) { }).on('apply.daterangepicker', function(ev,picker){
                            console.log("picker.startDate",picker.startDate)
                            var formattedDate = moment(new Date(picker.startDate)).format('MM/DD/YYYY');
                            $(this).val(formattedDate);
                            $(this).data('daterangepicker').setStartDate(formattedDate);
                            $(this).data('daterangepicker').setEndDate(formattedDate);
                        }).val(moment().format("MM/DD/YYYY"));
                    });
                    /**************** END REPORT LISTENER ****************/
                };

            /******** TABLE CHECK ********/
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                isFinishedLoading(["GEOFENCES","ROUTES","VEHICLES","CLUSTERS","VEHICLE_PERSONNEL","CHASSIS"], _new_, function(){
                    _new_ = false;
                    (LIST["geofences"]||[]).forEach(val => {
                        val.value = val.short_name;
                        _l_GeofenceList.push(val);
                    });

                    initializePage();
                    $(`.custom-btn-01 i`).removeClass("la-spin la-spinner").addClass("la-download");
                    $(`.custom-btn-01:not([no_function])`).removeClass("disabled");
                });
            }
            TABLE.FINISH_LOADING.START_CHECK();
            /******** END TABLE CHECK ********/
        }
    }
};
var NOTIFICATIONS = {
    FUNCTION: {
        stream: null,
        init: function(){
            var urlParams = new URLSearchParams(window.location.search),
                __data = CRYPTO.DECRYPT(urlParams.get('data')),
                urlPath = "notifications",
                _new_ = true,
                filter = __data.filter || {},  //username: USER.username
                _ids = __data._ids || [],
                _escalation = __data.escalation;
            __data.for = urlPath;

            if(_ids.length > 0){
                filter = {};
                var __ids = [];
                _ids.forEach(val => {
                    __ids.push(val);
                });
                filter["dispatch_id"] = {$in: __ids};
                filter["username"] = USER.username;
                if(_escalation){
                    filter["escalation"] = Number(_escalation);
                }
            }

            /******** TABLE ********/
            var table_id = '#tbl-notifications',
                dt = null,
                rowData = function(obj){
                    var dispatch = obj.dispatchDetails || {status:"deleted"},
                        action = TABLE.ROW_BUTTONS(PAGE.GET(),{username:obj.username,status:dispatch.status,loadView:["comment"],readonlyArr:["comment"]}); 
                    $(`${table_id} th:last-child`).css({"min-width":action.width,"width":action.width});
                    
                    (obj._row) ? null : obj._row = GENERATE.RANDOM(36);
                    LIST[urlPath].push(obj);

                    var user = getUser(obj.username||"") || {};
                    var sent_to = ((USER.username == obj.username)?"You":(user.name || obj.username || "-"));
                    var type = "lq";
                    if(obj.delay_type == "Over CICO") type = "oc";
                    if(obj.delay_type == "Over Transit") type = "ot";

                    return TABLE.COL_ROW(null,{
                        'dispatch_id': obj.dispatch_id,
                        '_row':  obj._row,
                        '_id':  obj._id,
                        'type': type,
                        'Shipment No': dispatch._id || obj.dispatch_id,
                        'Departure Date': DATETIME.FORMAT(dispatch.departure_date),
                        'Delay Type': obj.delay_type || "-",
                        'Escalation': obj.escalation || "-",
                        'Timelapse': DATETIME.HH_MM(null,obj.timelapse).hour_minute,
                        'Site': obj.site || "-",
                        'Status': GET.STATUS(dispatch.status).html,
                        'DateTime': DATETIME.FORMAT(obj.timestamp),
                        'Sent to': sent_to,
                        'Action': action.buttons,
                    },"Sent to").row;
                },
                populateTable = function(newlyLoaded){
                    LIST[urlPath] = [];
                    var __filter = ($.isEmptyObject(filter)) ? {timestamp: FILTER.DATERANGE()} : filter; //username: USER.username
                    var dt_buttons = TABLE.BUTTONS({
                        goto: PAGE.GET(),
                        actions:{
                            refresh: function(){
                                populateTable(null);
                            },
                            filter: function(){
                                $(`#export-container`).hide("slide", {direction:'right'},100);
                                $(`#filter-container`).toggle("slide", {direction:'right'},100);
                            },
                            export: function(){
                                $(`#filter-container`).hide("slide", {direction:'right'},100);
                                $(`#export-container`).toggle("slide", {direction:'right'},100);
                            }
                        }
                    });

                    if(ISMOBILE){
                        $(`#refresh-toggle .la-refresh`).addClass("la-spin");
                        $(`#refresh-toggle`).addClass("disabled");
                        $(`#filter-container input,#filter-container select`).attr("disabled",true);
                        $(`#filter-container button,#filter-container a`).addClass("disabled");
                        
                        (ENVIRONMENT == "development") ? null : __filter.username = USER.username;
                        
                        GET.AJAX({
                            url: `/api/${urlPath}/${CLIENT.id}/${USER.username}/all/${JSON.stringify(__filter)}/0/0`,
                            method: "GET",
                            headers: {
                                "Authorization": SESSION_TOKEN
                            },
                        }, function(docs){
                            console.log("docs",docs);
                            var listHTML = "";
                            docs.forEach((val,i) => {
                                var index = LIST[urlPath].findIndex(x => x._id.toString() == val._id.toString());
                                if(index > -1){
                                    LIST[urlPath][index] = val;
                                } else {
                                    val._row = GENERATE.RANDOM(36);
                                    LIST[urlPath].push(val);
                                }
                                listHTML += NOTIFICATIONS.FUNCTION.mobileAddToList({val,urlPath});
                            });
                            $(`#refresh-toggle .la-refresh`).removeClass("la-spin");
                            $(`#refresh-toggle`).removeClass("disabled");
                            $(`#filter-container input,#filter-container select`).attr("disabled",false);
                            $(`#filter-container button,#filter-container a`).removeClass("disabled");
                            $(`#filter-btn`).html("Apply");
                            if(newlyLoaded){
                                PAGE.DISPLAY();
                                $(`#filter-container`).css({width:"70%","top":"69px",height:"calc(100% - 134px)"});
                                $(`.panel.panel-profile .page-box`).css("margin-top","30px");
                                $(`.panel.panel-profile .clearfix`).before(mobileOptions.notifications.filter());
                                $(`#refresh-toggle`).click(function(){
                                    if(dt){}
                                    else { $(`.page-box.row > .col-sm-12`).html(`<div style="text-align: center;margin-top: 15px;">Loading...</div>`); }
                                    populateTable(null);
                                });
                                $(`#filter-toggle`).click(function(){
                                    $(`#filter-container`).toggle("slide", {direction:'right'},100);
                                });
                                initializeFilter();
                                $(`.page-box.row`).addClass("p-2");
                                $(`.page-box.row > .col-sm-12`).removeClass().addClass("col-sm-12 p-0");
                                $(`.main-content`).addClass("p-0");
                            }

                            if(docs.length > 0){
                                $(`.page-box.row > .col-sm-12`).html(listHTML);
                            } else {
                                $(`.page-box.row > .col-sm-12`).html(`<div style="text-align: center;margin-top: 15px;">You do not have any notifications</div>`);
                            }
                            TABLE.WATCH({urlPath,options:function(){TABLE.FINISH_LOADING.START_CHECK();}});
                        });
                    
                    } else {
                        if(dt) dt.clear().draw();
                        TABLE.POPULATE({
                            url: `${urlPath}/${CLIENT.id}/${USER.username}/all`,
                            withFilter: true,
                            goto: urlPath,
                            urlPath,
                            withPagination: true,
                            filter: __filter, // add username: USER.username
                            commentTitle: "Notifications",
                            newlyLoaded,
                            table_id,
                            dataTableOptions: {
                                columns: TABLE.COL_ROW(CUSTOM.COLUMN.notifications(),null,"Sent to").column,
                                order: [[ 6, "desc" ]],
                                createdRow: function (row, data, dataIndex) {
                                    var _row = data._row;
                                    $(row).attr(`_row`, data._row);

                                    var _id = data.dispatch_id;
                                    var type = data.type;
                                    var docId = data._id;
                                    TABLE.ROW_LISTENER({table_id,_row,urlPath:urlPath,_id:docId,
                                        additionalListeners: function(){
                                            $(table_id).on('click', `[_row="${_row}"] [comment],[_row="${_row}"] + tr.child [comment]`,function(e){
                                                e.stopImmediatePropagation();
                                                var __escalation = Number(data["Escalation"]);
                                                var position = "";
                                                if(__escalation == 1){
                                                    position = "ESCALATION 1";
                                                }
                                                if(__escalation == 2){
                                                    position = "ESCALATION 2";
                                                }
                                                if(__escalation == 3){
                                                    position = "ESCALATION 3";
                                                }
                                                MODAL.CONFIRMATION_W_FIELD({
                                                    content: `<div style="font-weight: normal;border-bottom: 1px solid #eee;padding: 3px 0px;border-top: 1px solid #eee;">${position}</div>Please add your comments/remarks below.<a id="${_id}-view" href="javascript:void(0);" class="mt-1 d-block">View shipment entry</a>`,
                                                    confirmCloseCondition: true,
                                                    confirmButtonText: "Submit",
                                                    confirmBGStyle: "background-color: #00a548;",
                                                    cancelButtonText: "Cancel",
                                                    confirmCallback: function(field_val){
                                                        var set = {};
                                                        var timestamp = new Date().getTime();
                                                        if(__escalation == 1){
                                                            set[`esc1_remarks.${timestamp}`] = {
                                                                remarks: field_val,
                                                                username: USER.username,
                                                                type
                                                            };
                                                        }
                                                        if(__escalation == 2){
                                                            set[`esc2_remarks.${timestamp}`] = {
                                                                remarks: field_val,
                                                                username: USER.username,
                                                                type
                                                            };
                                                        }
                                                        if(__escalation == 3){
                                                            set[`esc3_remarks.${timestamp}`] = {
                                                                remarks: field_val,
                                                                username: USER.username,
                                                                type
                                                            };
                                                        }
                                                        if(Object.keys(set).length > 0){
                                                            set[`history.${timestamp}`] = `<username>${USER.username}</username> added a comment/remark.`;
                                                            GET.AJAX({
                                                                url: `/api/dispatch/${CLIENT.id}/${USER.username}/${_id}`,
                                                                method: "PUT",
                                                                headers: {
                                                                    "Content-Type": "application/json; charset=utf-8",
                                                                    "Authorization": SESSION_TOKEN
                                                                },
                                                                data: JSON.stringify(set)
                                                            }, function(docs){
                                                                if(docs.ok == 1){
                                                                    toastr.success("Comment/remark added successfully.",null,{timeOut: 1500});
                                                                } else {
                                                                    toastr.error("Something went wrong</br></br>Error Code - ec023/03");
                                                                }
                                                                $(`#confirm-modal`).remove(); 
                                                            },function(error){
                                                                console.log(error);
                                                                $(`#confirm-modal`).remove();
                                                                toastr.error("Something went wrong</br></br>Error Code - ec023/03");
                                                            });
                                                        }
                                                    }
                                                });

                                                $(`#${_id}-view`).click(function(){
                                                    $(`body`).append(modalViews.dispatch.view[CLIENT.id](_id));
                                                    $("html, body,#modal").animate({ scrollTop: 0 }, "fast");
                                                });
                                            });
                                        }
                                    });
                                },
                                dom: 'lB<"toolbar">frtip',
                                buttons: dt_buttons
                            },
                            initializeCallback: function(data,_dt){
                                dt = _dt;
                                initializeFilter();
                                TABLE.WATCH({urlPath,rowData,options:function(){TABLE.FINISH_LOADING.START_CHECK();}});
                            },
                            populateCallback: function(data){
                                var rows = [];
                                $.each(data, function(i,val){
                                    rows.push(rowData(val));
                                });
                                dt.rows.add(rows).draw(false);
                            },
                        });
                    }
                },
                initializeFilter = function(){
                    $(`.page-box`).append(SLIDER.EXPORT()); 
                    TABLE.TOOLBAR(dt);
                    $(`.buttons-copy span`).html("Copy Table");
                    $(`.buttons-csv span`).html("Export Table As CSV File");
                    $(`.buttons-excel span`).html("Export Table As Excel File");

                    FILTER.RESET({
                        dateEl: `#_timestamp`,
                        selectEl: `#_delay_type,#_escalation`,
                        populateTable
                    });
                    
                    $(`#_timestamp`).daterangepicker({
                        opens: 'left',
                        autoUpdateInput: false,
                        autoApply: true
                    }, function(start, end, label) {
                        FILTER.INITIALIZE($(this)["0"].element,start,end);
                        $('.clearable').trigger("input");
                    }).on('apply.daterangepicker', function (ev, picker) {
                        FILTER.INITIALIZE($(this),picker.startDate,picker.endDate);
                        $('.clearable').trigger("input");
                    });
                    
                    if(!filter.dispatch_id){
                        if(filter.timestamp) FILTER.INITIALIZE(`#_timestamp`,filter.timestamp["$gte"],filter.timestamp["$lt"]);
                        if(filter.delay_type) $(`#_delay_type`).val(filter.delay_type);
                        if(filter.escalation) $(`#_escalation`).val(filter.escalation);
                        if(filter.timestamp || filter.delay_type || filter.escalation) {
                            $(`#filter-container`).toggle("slide", {direction:'right'},100);
                            $('.clearable').trigger("input");
                            $(`#reset-btn`).removeClass("disabled");
                            FILTER.STATUS = "new";
                        }
                    }
                    $(`#filter-btn`).click(function(){
                        filter = {};
                        var _timestamp = $(`#_timestamp`).val() || DEFAULT_DATE,
                            _delay_type = $(`#_delay_type`).val(),
                            _escalation = $(`#_escalation`).val();
                        (!_timestamp.isEmpty()) ? filter["timestamp"] = FILTER.DATERANGE(_timestamp) : null;
                        (_delay_type != "all") ? filter["delay_type"] = _delay_type : null;
                        (_escalation != "all") ? filter["escalation"] = Number(_escalation) : null;

                        FILTER.STATUS = "new";
                        
                        $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");

                        __data = $.extend(__data,{filter});
                        window.history.pushState({}, null, `?data=${CRYPTO.ENCRYPT(__data)}#${PAGE.GET()}`);

                        if(dt){}
                        else { $(`.page-box.row > .col-sm-12`).html(`<div style="text-align: center;margin-top: 15px;">Loading...</div>`); }
                        populateTable();
                    });
                };
            LIST[urlPath] = [];
            populateTable(true);
            /******** END TABLE ********/

            /******** TABLE CHECK ********/
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                isFinishedLoading(["GEOFENCES","ROUTES","VEHICLES"], _new_, function(){
                    _new_ = false;
                   
                    TABLE.FINISH_LOADING.UPDATE();

                    $(table_id).on('page.dt length.dt draw.dt order.dt', function () {
                        TABLE.FINISH_LOADING.START_CHECK();
        
                        $(`${table_id} thead tr th`).each((i,el) => {
                            if(!$(el).is(":visible")){
                                $(`${table_id} tr:not(.child)`).each((i1,el1) => {
                                    $(el1).find("td").eq(i).hide();
                                });
                            }
                        });
                    });
                });
                isFinishedLoading(["GEOFENCES","ROUTES","VEHICLES"], true, function(){
                    TABLE.FINISH_LOADING.UPDATE();
                });
            }
            TABLE.FINISH_LOADING.START_CHECK();
            /******** END TABLE CHECK ********/
        },
        mobileAddToList: function(x,isWatch){
            var val = x.val,
                urlPath = x.urlPath,
                dispatch_id = val.dispatch_id,
                template = function(x){
                    // #91c151
                    var dispatch = ((x.dispatchDetails) ? x.dispatchDetails[0] : {status:"deleted"}) || {status:"deleted"},
                        user = getUser(x.username) || {},
                        status = dispatch.status,
                        action = (status == "deleted") ? {buttons:""} : TABLE.ROW_BUTTONS(PAGE.GET(),{username:x.username,status}),
                        readClass = (x.read === false) ? "unread" : "",
                        ongoingHTML = (!["complete","incomplete","deleted"].includes(status)) ? `<span class="ongoing" style="width: 7px;height: 7px;background: #00a548;border-radius: 20px;top: 14px;margin-left: 4px;position: absolute;"></span>` : "";
                        
                        return `<div class="container-parent col-sm-12 p-0 text-dark p-0" _row="${x._row}">
                                    <div class="container-header pt-2 pl-4 pr-4 pb-2 ${readClass}">
                                        <span class="container-header-title">${dispatch_id || "-"}${ongoingHTML}</span>
                                        <div class="container-header-body">${x.site}, ${x.escalation}, ${x.delay_type}</div>
                                        <i class="la la-angle-up" style="display:none;"></i>
                                    </div>
                                    <div class="container-body pr-4 pb-2" style="display:none;">
                                        <div><span style="display: table-cell;width: 80px;">Site</span><span style="display: table-cell;">${x.site}</span></div>
                                        <div><span style="display: table-cell;width: 80px;">Date/Time</span><span style="display: table-cell;">${DATETIME.FORMAT(x.timestamp)}</span></div>
                                        <div><span style="display: table-cell;width: 80px;">Escalation</span><span style="display: table-cell;">${x.escalation}</span></div>
                                        <div><span style="display: table-cell;width: 80px;">Timelapse</span><span style="display: table-cell;">${DATETIME.HH_MM(null,x.timelapse).hour_minute}</span></div>
                                        <div><span style="display: table-cell;width: 80px;">Delay Type</span><span style="display: table-cell;">${x.delay_type}</span></div>
                                        <div><span style="display: table-cell;width: 80px;">Sent to</span><span style="display: table-cell;">${user.name || x.username}</span></div>
                                        <div><span style="display: table-cell;width: 80px;">Action</span><span style="display: table-cell;">${action.buttons}</span></div>
                                    </div>
                                </div>`;
                },
                initializeListeners = function(){
                    var dispatch = ((val.dispatchDetails) ? val.dispatchDetails[0] : {status:"deleted"}) || {status:"deleted"};

                    $("body").on('click', `[_row="${val._row}"] > .container-header`,function(){
                        var el = $(this).parent(),
                            index = LIST[urlPath].findIndex(x => x._row == $(el).attr("_row")),
                            obj = LIST[urlPath][index],
                            removeActive = function(_el){
                                $(_el).removeClass("active");
                                $(_el).find(".container-body").slideUp(100,null,function(){
                                    $(_el).find(".container-header-body").slideDown(50);
                                });
                                $(_el).find(".la-angle-up").hide();
                                $(_el).find(".container-header-title .ongoing").css("opacity",1);
                                $(_el).find(".container-header-title > [status]").remove();
                            };
                        if($(el).hasClass("active")){
                            removeActive(el);
                        } else {
                            $(`.container-parent`).each((i,el1) => { removeActive(el1); });
                            $(el).addClass("active");
                            $(el).find(".container-body").slideDown(100,null,function(){
                                $(el).find(".container-header-body").slideUp(50);
                                $(el).find(".la-angle-up").slideDown(50);
                            });
                            $(el).find(".container-header-title .ongoing").css("opacity",0);
                            $(el).find(".container-header-title").append(`<span status> - ${dispatch.status.capitalize()}</span>`);
                            if(obj && !obj.read){
                                LIST[urlPath][index].read = true;
                                $(el).find(".container-header").removeClass("unread");
                                GET.AJAX({
                                    url: `/api/${urlPath}/${CLIENT.id}/${USER.username}/${obj._id}/read`,
                                    method: "PUT",
                                    headers: {
                                        "Content-Type": "application/json; charset=utf-8",
                                        "Authorization": SESSION_TOKEN
                                    },
                                    data: JSON.stringify({})
                                });
                            }
                        }
                    });

                    $("body").on('click', `[_row="${val._row}"] [view]`,function(e){
                        e.stopImmediatePropagation();
                        $(`body`).append(MODAL.CREATE.EMPTY(`View Dispatch Entry`,modalViews.dispatch.form[CLIENT.id]()));
                        DISPATCH.FUNCTION.form({_id:dispatch_id});
                        $("html, body,#modal").animate({ scrollTop: 0 }, "fast");
                    });
                    $("body").on('click', `[_row="${val._row}"] [comment]`,function(e){
                        e.stopImmediatePropagation();
                        $(`body`).append(MODAL.CREATE.EMPTY(`Add Comment on Dispatch Entry`,modalViews.dispatch.form[CLIENT.id]()));
                        DISPATCH.FUNCTION.form({_id:dispatch_id,escalation:val.escalation,type:"delay"});
                        $("html, body,#modal").animate({ scrollTop: 0 }, "fast");
                    });
                };

            if(isWatch === true) {
                return new Promise((resolve,reject) => {
                    GET.AJAX({
                        url: `/api/dispatch/${CLIENT.id}/${USER.username}/${val.dispatch_id}`,
                        method: "GET",
                        headers: {
                            "Authorization": SESSION_TOKEN
                        },
                    }, function(docs){
                        var doc = docs[0];
                        if(doc){
                            val.dispatchDetails = [doc];
                        }
                        initializeListeners();
                        resolve(template(val));
                    });
                });
            } else {
                initializeListeners();
                return template(val);
            }
        }
    }
};
var EVENT_VIEWER = {
    FUNCTION: {
        stream:null,
        init:function(){
            var table = new Table({
                id: "#tbl-events",
                urlPath: "events",
                goto: "events_sn",
                dataTableOptions: {
                    columns: TABLE.COL_ROW(CUSTOM.COLUMN.event_viewer()).column,
                    order: [[ 0, "desc" ]],
                    createdRow: function (row, data, dataIndex) {
                        var _row = data._row;
                        $(row).attr(`_row`, _row);
                        table.rowListeners(_row,data._id);
                    },
                    dom: 'lB<"toolbar">frti<"tbl-progress-bar">p',
                }
            });
            USER.filters["events"] = (CLIENT.type != 2) ? {timestamp: FILTER.DATERANGE(), shipment_number: {$exists:true}} : {timestamp: FILTER.DATERANGE()};
            table.setButtons({ });
            table.addRow = function(obj){
                const self = this;
                var _class = (obj.stage=="start") ? "text-success" : "text-danger",
                    action = TABLE.ROW_BUTTONS(PAGE.GET()); 
                $(`${self.id} th:last-child`).css({"min-width":action.width,"width":action.width});

                obj.shipment_number = obj.shipment_number || [];
    
                return TABLE.COL_ROW(null,{
                    '_id': obj._id,
                    '_row':  obj._row,
                    'Date': DATETIME.FORMAT(obj.timestamp),
                    'Shipment Numbers': `${obj.shipment_number[0]}${GET.LENGTH(obj.shipment_number.length).text}`,
                    'Rule Name': `${obj.RULE_NAME} (<span class="${_class}">${obj.stage}</span>)`,
                    'Vehicle Name': obj.USER_NAME || "-",
                    'Geofence Name': obj.GEOFENCE_NAME || "-",
                    'Action': action.buttons,
                }).row;
            };
            table.rowListeners = function(_row,_id){
                const self = this;
                $(self.id).on('click', `[_row="${_row}"] [view],[_row="${_row}"] + tr.child [view]`,function(e){
                    e.stopImmediatePropagation();
                    var obj = LIST[self.urlPath].find(x => x._id.toString() == _id.toString());
                    if(obj){
                        var _show = ["stage", "GEOFENCE_NAME","GEOFENCE_ID","RULE_NAME","USER_NAME","USER_USERNAME","ASSIGNED_VEHICLE_ID","Region","Cluster","Site"],
                            tbody = "";
                        $(`body`).append(modalViews.events.details(obj._id,obj.shipment_number));
                        
                        _show.forEach(key => {
                            tbody += `<tr>
                                <td>${key}</td>
                                <td>${obj[key] || "-"}</td>
                            </tr>`;
                        });
                        $(`#tbl-notification > tbody`).html(tbody);
                    }
                });
            };
            table.filterListener = function(_row,_id){
                FILTER.RESET({
                    dateEl: `#_date`,
                    populateTable: function(){
                        var _date = $(`#_date`).val() || DEFAULT_DATE;

                        FILTER.STATUS = "new";

                        $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");
                        
                        USER.filters["events"] = (CLIENT.type != 2) ? {timestamp: FILTER.DATERANGE(_date), shipment_number: {$exists:true}} : {timestamp: FILTER.DATERANGE(_date)};
                        table.countRows();
                    }
                });
                $(`#_date`).daterangepicker({
                    opens: 'left',
                    autoUpdateInput: false,
                    singleDatePicker:true,
                    autoApply: true
                }, function(start, end, label) {
                    FILTER.INITIALIZE($(this)["0"].element,start,end);
                    $('.clearable').trigger("input");
                }).on('apply.daterangepicker', function (ev, picker) {
                    FILTER.INITIALIZE($(this),picker.startDate,picker.endDate);
                    $('.clearable').trigger("input");
                });
                $(`#filter-btn`).click(function(){
                    var _date = $(`#_date`).val() || DEFAULT_DATE;

                    FILTER.STATUS = "new";

                    $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");

                    
                    USER.filters["events"] = (CLIENT.type != 2) ? {timestamp: FILTER.DATERANGE(_date), shipment_number: {$exists:true}} : {timestamp: FILTER.DATERANGE(_date)};
                    table.countRows();
                });
            };
            table.initialize();
            table.countRows();
        }
    }
};
var ALL_EVENTS = {
    FUNCTION: {
        stream:null,
        init:function(){
            var table = new Table({
                id: "#tbl-all-events",
                urlPath: "events",
                perColumnSearch: true,
                goto: "all_events",
                dataTableOptions: {
                    columns: TABLE.COL_ROW(CUSTOM.COLUMN.all_events).column,
                    order: [[ 0, "desc" ]],
                    createdRow: function (row, data, dataIndex) {
                        var _row = data._row;
                        $(row).attr(`_row`, _row);
                        table.rowListeners(_row,data._id);
                    },
                    dom: 'lBrti<"tbl-progress-bar">p',
                }
            });
            USER.filters["events"] = {timestamp: FILTER.DATERANGE()};
            table.setButtons({});
            table.addRow = function(obj){
                const self = this;
                var _class = (obj.stage=="start") ? "text-success" : "text-danger",
                    action = TABLE.ROW_BUTTONS(PAGE.GET()); 
                $(`${self.id} th:last-child`).css({"min-width":action.width,"width":action.width});

                obj.shipment_number = obj.shipment_number || [];
    
                return TABLE.COL_ROW(null,{
                    '_id': obj._id,
                    '_row':  obj._row,
                    'Date': DATETIME.FORMAT(obj.timestamp,"MMM D, YYYY, h:mm:ss A"),
                    'Rule Name': `${obj.RULE_NAME} (<span class="${_class}">${obj.stage}</span>)`,
                    'Vehicle Name': obj.USER_NAME || "-",
                    'Geofence Name': obj.GEOFENCE_NAME || "-",
                    'Action': action.buttons,
                }).row;
            };
            table.rowListeners = function(_row,_id){
                const self = this;
                $(table.id).on('click', `[_row="${_row}"] [view],[_row="${_row}"] + tr.child [view]`,function(e){
                    e.stopImmediatePropagation();
                    var obj = LIST[self.urlPath].find(x => x._id.toString() == _id.toString());
                    if(obj){
                        var _show = ["stage","GEOFENCE_NAME","GEOFENCE_ID","RULE_NAME","USER_NAME","USER_USERNAME","ASSIGNED_VEHICLE_ID","Region","Cluster","Site"],
                            tbody = "";
                        $(`body`).append(modalViews.events.details(obj._id));
                        
                        _show.forEach(key => {
                            tbody += `<tr>
                                <td>${key}</td>
                                <td>${obj[key] || "-"}</td>
                            </tr>`;
                        });
                        $(`#tbl-notification > tbody`).html(tbody);
                    }
                });
            };
            table.filterListener = function(_row,_id){
                // initialize filter
                FILTER.RESET({
                    dateEl: `#_date`,
                    populateTable: function(){
                        var _date = $(`#_date`).val() || DEFAULT_DATE;

                        FILTER.STATUS = "new";

                        $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");

                        
                        USER.filters["events"] = {timestamp: FILTER.DATERANGE(_date)};
                        table.countRows();
                    }
                });
                $(`#_date`).daterangepicker({
                    opens: 'left',
                    autoUpdateInput: false,
                    singleDatePicker:true,
                    autoApply: true
                }, function(start, end, label) {
                    FILTER.INITIALIZE($(this)["0"].element,start,end);
                    $('.clearable').trigger("input");
                }).on('apply.daterangepicker', function (ev, picker) {
                    FILTER.INITIALIZE($(this),picker.startDate,picker.endDate);
                    $('.clearable').trigger("input");
                });
                $(`#filter-btn`).click(function(){
                    var _date = $(`#_date`).val() || DEFAULT_DATE;

                    FILTER.STATUS = "new";

                    $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");

                    USER.filters["events"] = {timestamp: FILTER.DATERANGE(_date)};
                    table.countRows();
                });
                // initialize filter
            };
            table.initialize();
            table.countRows();
        }
    }
};
var ECO_DRIVING = {
    FUNCTION: {
        stream:null,
        init:function(){
            var _new1_ = true;
            var isFullview = true

            function fullTable() {

                var table = new Table({
                    id: "#tbl-eco_driving",
                    urlPath: "eco_driving",
                    perColumnSearch: true,
                    goto: "eco_driving",
                    autoPopulateData: false,
                    dataTableOptions: {
                        columns: TABLE.COL_ROW(CUSTOM.COLUMN.eco_driving).column,
                        order: [[ 0, "asc" ]],
                        createdRow: function (row, data, dataIndex) {
                            var _row = data._row;
                            $(row).attr(`_row`, _row);
                            table.rowListeners(_row,data._id);
                        },
                        dom: 'lBrti<"tbl-progress-bar">p',
                    }
                });

                USER.filters["eco_driving"] = { 'Value.Event Start': FILTER.DATERANGE(), RuleName: { $in: ['Over speeding > 70kph','Harsh Braking','Harsh Acceleration'] } };

                table.setButtons({
                    actions: {

                        summary: function(){
                            if (isFullview) {
                                summaryTable()
                            } else {
                                fullTable()
                            }
                            isFullview = false
                            $("#tbl-eco_driving").hide()
                            $("#tbl-eco_driving_summary").show()
                        },
                    }
                });
                table.addRow = function(obj){
    
                    // SPEED
                    // convert speed from meter/second to kilometer/hour -> (speed * 18) / 5
                    const maxSpeed = ((obj['MaxSpeed']||0) * 18) / 5;
                    const totalEvents = obj['Brake'] + obj['Acc'] + obj['O_spd'];
                    const avgSpeed = (((obj['Speed']||0) / totalEvents) * 18) / 5;
    
                    // const oSpdTime = Number(obj['O_spd_Time']) * (1/3600); // seconds to decimal hour
                    const oSpdTime = DATETIME.DURATION_TIME_FORMAT((obj['O_spd_Time']*1000),true,true,true); // Format: HH:MM:SS
        
                    return TABLE.COL_ROW(null,{
                        '_id': obj._id,
                        '_row':  obj._row,
                        'Name': obj['Name'] || "-",
                        'Days': Object.keys(obj.Days).length,
                        'Class': obj.Class || "",
                        'Score': totalEvents || "",
                        'Dist': obj.Dist || "",
                        'Max': (GET.ROUND_OFF(maxSpeed) || "") + ' kph',
                        'Avg': (GET.ROUND_OFF(avgSpeed) || "") + ' kph',
                        'Brake': obj.Brake || "",
                        'Acc': obj.Acc || "",
                        'O_spd': obj.O_spd || "",
                        'Trip': obj.Trip || "",
                        'Idle': obj.Idle || "",
                        'O_spd_Time': oSpdTime || "",
                        'Site': (Object.keys(obj.Site)||{}).join(", ") || "",
                        'Cluster': (Object.keys(obj.Cluster)||{}).join(", ") || "",
                        'Region': (Object.keys(obj.Region)||{}).join(", ") || "",
                    }).row;
                };
                table.customPopulate = function(){
                    
                    const filteredArr = {};
    
    
                    LIST['eco_driving'].forEach(val => {
    
                        if((val.RuleName == 'Over speeding > 70kph' && val.State == 'Finished') || (val.RuleName != 'Over speeding > 70kph' && val.State == 'New')){
                            var value = val.Value || {};
                            try {
                                value = JSON.parse("{"+val.Value+"}");
                            } catch(error){}
        
                            filteredArr[val.userID] = filteredArr[val.userID] || {
                                '_id': val._id,
                                'Name': value['Vehicle Name'] || "-",
                                'Brake': 0,
                                'Acc': 0,
                                'O_spd': 0,
                                'Speed': 0,
                                'MaxSpeed': 0,
                                'Days': {},
                                'O_spd_Time': 0,
                                'Site': {},
                                'Cluster': {},
                                'Region': {},
                            };
    
                            // Days
                            filteredArr[val.userID]['Days'][DATETIME.FORMAT(value['Event Start'],"YYYYMMDD")] = true;
    
                            // Events
                            (val.RuleName == 'Harsh Braking') ? filteredArr[val.userID]['Brake'] ++ : null;
                            (val.RuleName == 'Harsh Acceleration') ? filteredArr[val.userID]['Acc'] ++ : null;
                            (val.RuleName == 'Over speeding > 70kph') ? filteredArr[val.userID]['O_spd'] ++ : null;
        
                            // Speed
                            var speed = Number(value['Speed']) || 0;
                            if(val.RuleName == 'Over speeding > 70kph'){
                                const stateNew = LIST['eco_driving'].find(x => x.id == val.id && x.State == 'New');
    
                                if(stateNew){
                                    speed = Number(stateNew.Value['Speed']) || 0;
                                }
                            }
                            filteredArr[val.userID]['Speed'] += speed;
                            (filteredArr[val.userID]['MaxSpeed'] < speed) ? filteredArr[val.userID]['MaxSpeed'] = speed : null;
    
                            // Time
                            filteredArr[val.userID]['O_spd_Time'] += Number(value['Duration']) || 0;
    
                            // Location
                            const geofence = getGeofence(value['Site'],'short_name');
    
                            if(geofence){
                                filteredArr[val.userID]['Site'][geofence.short_name] = true;
    
                                const cluster = getCluster(geofence.cluster_id);
                                cluster ? filteredArr[val.userID]['Cluster'][cluster.cluster] = true : null;
    
                                const region = getRegion(geofence.region_id);
                                region ? filteredArr[val.userID]['Region'][region.code] = true : null;
                            } else {
                                filteredArr[val.userID]['Site'][value['Site']] = true;
                            }
                        }
    
                    });
    
                    table.populateRows(Object.values(filteredArr),true);
                };
                table.rowListeners = function(_row,_id){
                    const self = this;
                };
                table.filterListener = function(_row,_id){
                    // initialize filter
                    FILTER.RESET({
                        selectEl: `#_region_id,#_cluster_id`,
                        dateEl: `#_date`,
                        populateTable: function(){
                            var _date = $(`#_date`).val() || DEFAULT_DATE;
    
                            FILTER.STATUS = "new";
    
                            $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");
    
                            
                            USER.filters["eco_driving"] = {'Value.Event Start': FILTER.DATERANGE(_date), RuleName: { $in: ['Over speeding > 70kph','Harsh Braking','Harsh Acceleration'] } };
                            table.countRows();
                        }
                    });
    
    
                    /********* DATE FILTER *********/
                    var selectedDate = new Date();
                    var calendarview = "day";
    
                    // Date filter
                    $(`[calendarview]`).click(function(){
                        calendarview = $(this).attr("calendarview");
        
                        // initializeExportButton();
        
                        if(calendarview == "day"){
                            $('#_date').replaceWith(`<input id="_date" class="form-control" type="text" readonly>`);
                            
                            $(`#_date`).daterangepicker({
                                opens: 'left',
                                // singleDatePicker:true,
                                autoUpdateInput: false,
                                maxDate: new Date(),
                                startDate: DATETIME.FORMAT(new Date(selectedDate),"MM/DD/YYYY"),
                                autoApply: true
                            }, function(start, end, label) {
                                selectedDate = new Date(start);
                                
                                FILTER.INITIALIZE($(this)["0"].element,start,end);
                            }).on('apply.daterangepicker', function (ev, picker) {
                                $(this).val(DATETIME.FORMAT(new Date(picker.startDate),"MM/DD/YYYY"));
                                selectedDate = new Date(picker.startDate);
                                FILTER.INITIALIZE($(this),picker.startDate,picker.endDate);
    
                            });
                            $(`#_date`).trigger('apply.daterangepicker',{ startDate: DATETIME.FORMAT(new Date(selectedDate),"MM/DD/YYYY") });
                            FILTER.INITIALIZE($(`#_date`),selectedDate,selectedDate);
                        }
                        if(calendarview == "month"){
                            $('#_date').replaceWith(`<input id="_date" class="form-control" type="text" readonly>`);
                            $('#_date').datepicker('remove').datepicker({
                                format: "mm/yyyy",
                                minViewMode: 1,
                                autoclose: true,
                                todayHighlight: true,
                                endDate: new Date()
                            }).on("changeDate",function (e) {
                                selectedDate = new Date(e.date);
                                // saveFilter();
                                // populatePage(GENERATE.RANDOM(36));
                                
                                // FILTER.INITIALIZE($(this)["0"].element,selectedDate,selectedDate);
                                $('.clearable').trigger("input");
                            }).datepicker("setDate",new Date(selectedDate));
                        }
                        if(calendarview == "year"){
                            $('#_date').replaceWith(`<input id="_date" class="form-control" type="text" readonly>`);
                            $('#_date').datepicker('remove').datepicker({
                                format: "yyyy",
                                minViewMode: 2,
                                autoclose: true,
                                todayHighlight: true,
                                endDate: new Date()
                            }).on("changeDate",function (e) {
                                selectedDate = new Date(e.date);
                                // saveFilter();
                                // populatePage(GENERATE.RANDOM(36));
                                // FILTER.INITIALIZE($(this)["0"].element,selectedDate,selectedDate);
                                $('.clearable').trigger("input");
                            }).datepicker("setDate",new Date(selectedDate));
                        }
                        $(`[calendarview]`).removeClass("active");
                        $(`[calendarview="${calendarview}"]`).addClass("active");
                        $(this).parents(".dropdown").find(".dropdown-toggle b").html(calendarview.toUpperCase());
        
                        // saveFilter();
                    });
                    $(`[calendarview="${calendarview}"]`).trigger("click");
                    /********* end DATE FILTER *********/
    
    
                    // Region filter
                    $(`#_region_id`).on("select2:select", function() {
                        $(`#_cluster_id`).val("").trigger('change');
                    });
    
                    // Cluster filter
                    $(`#_cluster_id`).on("select2:select", function() {
                        $(`#_region_id`).val("").trigger('change');
                    });
    
                    // Site filter
    
    
    
                    // filter button is clicked
                    $(`#filter-btn`).click(function(){
                        const _date = $(`#_date`).val() || DEFAULT_DATE;
                        const _region_id = $(`#_region_id`).val();
                        const _cluster_id = $(`#_cluster_id`).val();
    
                        FILTER.STATUS = "new";
    
                        $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");
    
                        // Day
                        var finalSelectedDate = DATETIME.FORMAT(new Date(selectedDate),"MM/DD/YYYY");
    
                        // Month
                        if(calendarview == "month"){
                            var monthYear = moment(selectedDate).format("MM/DD/YYYY").split("/");
                            console.log('selectedDate',selectedDate)
                            var month = monthYear[0];
                            var year = monthYear[2];
    
                            // month in moment is 0 based, so 9 is actually october, subtract 1 to compensate
                            // array is 'year', 'month', 'day', etc
                            var startDate = moment([year, month - 1]);
                        
                            // Clone the value before .endOf()
                            var endDate = moment(startDate).endOf('month');
    
                            finalSelectedDate = `${startDate.format("MM/DD/YYYY")} - ${endDate.format("MM/DD/YYYY")}`;
                        }
                        
                        // Year
                        if(calendarview == "year"){
                            // start date of year
                            var startDate = moment(selectedDate).startOf('year');
                            // end date of year
                            var endDate = moment(selectedDate).endOf('year');
    
                            finalSelectedDate = `${startDate.format("MM/DD/YYYY")} - ${endDate.format("MM/DD/YYYY")}`;
                        }
                        console.log("finalSelectedDate",finalSelectedDate);
    
                        USER.filters["eco_driving"] = { 
                            'Value.Event Start': FILTER.DATERANGE(finalSelectedDate), 
                            RuleName: { $in: ['Over speeding > 70kph','Harsh Braking','Harsh Acceleration'] } 
                        };
                        
                        (_region_id) ?  USER.filters["eco_driving"]['_region_id'] = _region_id : null;
                        (_cluster_id) ?  USER.filters["eco_driving"]['_cluster_id'] = _cluster_id : null;
                        
                        table.countRows();
                    });
                    // initialize filter
                };
                table.initialize();
                table.countRows()
            }

            function summaryTable() {
                var summaryTable = new Table({
                    id: "#tbl-eco_driving_summary",
                    urlPath: "eco_driving",
                    perColumnSearch: true,
                    goto: "eco_driving",
                    autoPopulateData: false,
                    dataTableOptions: {
                        columns: TABLE.COL_ROW(CUSTOM.COLUMN.eco_driving_summary).column,
                        order: [[ 0, "asc" ]],
                        dom: 'lBrti<"tbl-progress-bar">p',
                    }
                });

                summaryTable.setButtons({
                    actions: {

                        summary: function(){
                            if (isFullview) {
                                summaryTable()
                            } else {
                                fullTable()
                            }
                            isFullview = true
                            $("#tbl-eco_driving").show()
                            $("#tbl-eco_driving_summary").hide()
                        }
                    }
                });
    
                summaryTable.addRow = function(obj){
                    return TABLE.COL_ROW(null,{
                        '_id': obj._id,
                        '_row':  obj._row,
                        'Cluster': obj.Cluster || "",
                        'Region': obj.Region || "",
                        'Brake': obj.Brake || "",
                        'Acc': obj.Acc || "",
                        'O_spd': obj.O_spd || "",
                        'Total': obj.Total || "",
                    }).row;
                }
                summaryTable.customPopulate = function(){
                    const filteredArr = {};
                    
                    LIST['eco_driving'].forEach(val => {
    
                        if((val.RuleName == 'Over speeding > 70kph' && val.State == 'Finished') || (val.RuleName != 'Over speeding > 70kph' && val.State == 'New')){
                            var value = val.Value || {};
                            try {
                                value = JSON.parse("{"+val.Value+"}");
                            } catch(error){}
    
                            // Location
                            const geofence = getGeofence(value['Site'],'short_name');
    
                            if(geofence){
    
                                const cluster = getCluster(geofence.cluster_id);
    
                                const region = getRegion(geofence.region_id);
    
                                if (region && cluster) {
    
                                    var regionCluster = filteredArr[`${region.code}${cluster.cluster}`] || {
                                        '_id': `${region.code}${cluster.cluster}`,
                                        'Region': region.name,
                                        'Cluster': cluster.cluster,
                                        'Brake': null,
                                        'Acc': null,
                                        'O_spd': null,
                                        'Total': null,
                                    }
    
                                    switch (val.RuleName) {
                                        case "Harsh Acceleration":
                                            regionCluster['Acc'] += 1;
                                            break;
                                        case "Harsh Braking":
                                            regionCluster['Brake'] += 1;
                                            break;
                                        case "Over speeding > 70kph":
                                            regionCluster['O_spd'] += 1;
                                            break;
                                        default:
                                            break;
                                    }
                                    regionCluster['Total'] = regionCluster.Acc + regionCluster.Brake + regionCluster.O_spd;
                                    filteredArr[`${region.code}${cluster.cluster}`] = regionCluster
                                    
                                } else if (region && (!cluster)) {
    
                                    var NoClusterRegion = filteredArr[region.code] || {
                                        '_id': region.code,
                                        'Region': region.name,
                                        'Cluster': "",
                                        'Brake': null,
                                        'Acc': null,
                                        'O_spd': null,
                                        'Total': null,
                                    }
    
                                    switch (val.RuleName) {
                                        case "Harsh Acceleration":
                                            NoClusterRegion['Acc'] += 1;
                                            break;
                                        case "Harsh Braking":
                                            NoClusterRegion['Brake'] += 1;
                                            break;
                                        case "Over speeding > 70kph":
                                            NoClusterRegion['O_spd'] += 1;
                                            break;
                                        default:
                                            break;
                                    }
                                    NoClusterRegion['Total'] = NoClusterRegion.Acc + NoClusterRegion.Brake + NoClusterRegion.O_spd;
                                    filteredArr[region.code] = NoClusterRegion
                                } else if (cluster && (!region)) {
    
                                    var noRegionCluster = filteredArr[cluster.cluster] || {
                                        '_id': cluster.cluster,
                                        'Region': "",
                                        'Cluster': cluster.cluster,
                                        'Brake': null,
                                        'Acc': null,
                                        'O_spd': null,
                                        'Total': null,
                                    }
    
                                    switch (val.RuleName) {
                                        case "Harsh Acceleration":
                                            noRegionCluster['Acc'] += 1;
                                            break;
                                        case "Harsh Braking":
                                            noRegionCluster['Brake'] += 1;
                                            break;
                                        case "Over speeding > 70kph":
                                            noRegionCluster['O_spd'] += 1;
                                            break;
                                        default:
                                            break;
                                    }
                                    noRegionCluster['Total'] = noRegionCluster.Acc + noRegionCluster.Brake + noRegionCluster.O_spd;
                                    filteredArr[cluster.cluster] = noRegionCluster
                                } else {
    
                                    var noClusterNoRegion = filteredArr['None'] || {
                                        '_id': 'none',
                                        'Region': "None",
                                        'Cluster': "None",
                                        'Brake': null,
                                        'Acc': null,
                                        'O_spd': null,
                                        'Total': null,
                                    }
    
                                    switch (val.RuleName) {
                                        case "Harsh Acceleration":
                                            noClusterNoRegion['Acc'] += 1;
                                            break;
                                        case "Harsh Braking":
                                            noClusterNoRegion['Brake'] += 1;
                                            break;
                                        case "Over speeding > 70kph":
                                            noClusterNoRegion['O_spd'] += 1;
                                            break;
                                        default:
                                            break;
                                    }
                                    noClusterNoRegion['Total'] = noClusterNoRegion.Acc + noClusterNoRegion.Brake + noClusterNoRegion.O_spd;
                                    filteredArr['None'] = noClusterNoRegion
                                }
                            } else {
                                var noClusterNoRegion = filteredArr['None'] || {
                                    '_id': 'none',
                                    'Region': "None",
                                    'Cluster': "None",
                                    'Brake': null,
                                    'Acc': null,
                                    'O_spd': null,
                                    'Total': null,
                                }
    
                                switch (val.RuleName) {
                                    case "Harsh Acceleration":
                                        noClusterNoRegion['Acc'] += 1;
                                        break;
                                    case "Harsh Braking":
                                        noClusterNoRegion['Brake'] += 1;
                                        break;
                                    case "Over speeding > 70kph":
                                        noClusterNoRegion['O_spd'] += 1;
                                        break;
                                    default:
                                        break;
                                }
                                noClusterNoRegion['Total'] = noClusterNoRegion.Acc + noClusterNoRegion.Brake + noClusterNoRegion.O_spd;
                                filteredArr['None'] = noClusterNoRegion
                            }
                        }
                    })
                    console.log("SUMMARY")
                    console.log(filteredArr)
                    summaryTable.populateRows(Object.values(filteredArr),true);
                }
                summaryTable.initialize();
                summaryTable.countRows();
            }

            fullTable()
            $("#tbl-eco_driving_summary").hide()

            /******** TABLE CHECK ********/
            // always put before POPULATE functions
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                isFinishedLoading(["REGIONS","CLUSTERS"], _new1_, function(){
                    _new1_ = false;

                    var regionOptions = `<option value="">&nbsp;</option>`;
                    (LIST["regions"]||[]).forEach(val => {
                        regionOptions += `<option value="${val._id}">${val.code}</option>`;
                    });
                    $(`#_region_id`).html(regionOptions).select2({
                        placeholder: "Select an option",
                        allowClear: true,
                    }).val(table.filter.region_id || "").trigger("change");

                    // cluster
                    var clusterOptions = `<option value="">&nbsp;</option>`;
                    (LIST["clusters"]||[]).forEach(val => {
                        clusterOptions += `<option value="${val._id}">${val.cluster}</option>`;
                    });
                    $(`#_cluster_id`).html(clusterOptions).select2({
                        placeholder: "Select an option",
                        allowClear: true,
                    }).val(table.filter.cluster_id || "").trigger("change");
                });
            }
                /******** END TABLE CHECK ********/
        }
    }
};
var OTD_EVENTS = {
    FUNCTION: {
        stream:null,
        init:function(){

            var _new_ = true;

            var table = new Table({
                id: "#tbl-otd-events",
                urlPath: "otd_events",
                perColumnSearch: true,
                goto: "otd_events",
                dataTableOptions: {
                    columns: TABLE.COL_ROW(CUSTOM.COLUMN.otd_events).column,
                    order: [[ 1, "desc" ]],
                    createdRow: function (row, data, dataIndex) {
                        var _row = data._row;
                        $(row).attr(`_row`, _row);
                        table.rowListeners(_row,data._id);
                    },
                    dom: 'lBrti<"tbl-progress-bar">p',
                }
            });
            USER.filters["otd_events"] = { 'Value.Check Out': FILTER.DATERANGE(), RuleName: "Check Out" };
            table.setButtons({});
            table.addRow = function(obj){
                var value = obj.Value;
                try {
                    value = JSON.parse("{"+obj.Value+"}");
                } catch(error){}
    
                return TABLE.COL_ROW(null,{
                    '_id': obj._id,
                    'ID': obj.id || "-",
                    '_row':  obj._row,
                    'DateTime': DATETIME.FORMAT(value['Check Out'],"MMM D, YYYY, h:mm:ss A"),
                    'Date': DATETIME.FORMAT(value['Check Out'],"MM/DD/YYYY"),
                    'Time': DATETIME.FORMAT(value['Check Out'],"h:mm:ss A"),
                    'RuleName': obj.RuleName,
                    'State': obj.State || "-",
                    'Vehicle Name': value['Vehicle Name'] || value['Vehicle'] || "-",
                    'Equipt No': value['Equipment #'] || "-",
                    'Location': value['Location'] || "-",
                    'DC Tag': value['DC Tag'] || "-",
                    'ODO': value.ODO || "-",
                    'Site Code': value['Site Code'] || "-",
                    'Namespace': obj.Namespace || "-",
                    'Lng': obj.lng || "",
                    'Lat': obj.lat || "",
                    'Alt': obj.alt || "-",
                    'Moving': value.Moving || "",
                    'Truck Type': value['Truck Type'] || "",
                }).row;
            };
            table.rowListeners = function(_row,_id){
                const self = this;
            };
            table.filterListener = function(_row,_id){
                // initialize filter
                FILTER.RESET({
                    dateEl: `#_date`,
                    populateTable: function(){
                        var _date = $(`#_date`).val() || DEFAULT_DATE;

                        FILTER.STATUS = "new";

                        $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");

                        
                        USER.filters["otd_events"] = {'Value.Check Out': FILTER.DATERANGE(_date), RuleName: "Check Out"};
                        table.countRows();
                    }
                });
                $(`#_date`).daterangepicker({
                    opens: 'left',
                    autoUpdateInput: false,
                    singleDatePicker:true,
                    autoApply: true
                }, function(start, end, label) {
                    FILTER.INITIALIZE($(this)["0"].element,start,end);
                    $('.clearable').trigger("input");
                }).on('apply.daterangepicker', function (ev, picker) {
                    FILTER.INITIALIZE($(this),picker.startDate,picker.endDate);
                    $('.clearable').trigger("input");
                });
                $(`#filter-btn`).click(function(){
                    var _date = $(`#_date`).val() || DEFAULT_DATE;

                    FILTER.STATUS = "new";

                    $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");

                    USER.filters["otd_events"] = { 'Value.Check Out': FILTER.DATERANGE(_date), RuleName: "Check Out" };
                    table.countRows();
                });
                // initialize filter
            };
            table.initialize();
            table.countRows();

            /******** TABLE CHECK ********/
            // TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
            //     isFinishedLoading(["VEHICLES"], _new_, function(){
            //         _new_ = false;
            //         table.updateRows(LIST['otd_events']);
            //     });
            // }
            // TABLE.FINISH_LOADING.START_CHECK();
            /******** END TABLE CHECK ********/
        }
    }
};
var CICO_EVENTS = {
    FUNCTION: {
        stream:null,
        init:function(){
            var table = new Table({
                id: "#tbl-cico-events",
                urlPath: "cico_events",
                perColumnSearch: true,
                goto: "cico_events",
                dataTableOptions: {
                    columns: TABLE.COL_ROW(CUSTOM.COLUMN.cico_events).column,
                    order: [[ 1, "desc" ]],
                    createdRow: function (row, data, dataIndex) {
                        var _row = data._row;
                        $(row).attr(`_row`, _row);
                        table.rowListeners(_row,data._id);
                    },
                    dom: 'lBrti<"tbl-progress-bar">p',
                }
            });
            USER.filters["cico_events"] = { 'Value.Event Start': FILTER.DATERANGE(), RuleName: "Check In, Check Out" };
            table.setButtons({});
            table.addRow = function(obj){
                var value = obj.Value;
                try {
                    value = JSON.parse("{"+obj.Value+"}");
                } catch(error){}
    
                const duration = Number(value['Duration']) * (1/3600); // seconds to decimal hour

                return TABLE.COL_ROW(null,{
                    '_id': obj._id,
                    'ID': obj.id || "-",
                    '_row':  obj._row,
                    'DateTime': DATETIME.FORMAT(value['Event Start'],"MMM D, YYYY, h:mm:ss A"),
                    'Date': DATETIME.FORMAT(value['Event Start'],"MM/DD/YYYY"),
                    'Time': DATETIME.FORMAT(value['Event Start'],"h:mm:ss A"),
                    'RuleName': obj.RuleName,
                    'State': obj.State || "-",
                    'Vehicle Name': value['Vehicle Name'] || "-",
                    'Equipt No': value['Equipt No'] || "-",
                    'Site': value['Site'] || "-",
                    'Site Code': value['Site Code'] || "-",
                    'Duration': GET.ROUND_OFF(duration) || "-",
                    'Namespace': obj.Namespace || "-",
                    'Lng': obj.lng || "",
                    'Lat': obj.lat || "",
                    'Alt': obj.alt || "-",
                    'Address': value['Address'] || "-",
                    'Truck Base Code': value['Truck Base Code'] || "-",
                    'Truck Base Site': value['Truck Base Site'] || "",
                    'Truck Status': value['Truck Status'] || "",
                    'Truck Type': value['Truck Type'] || "",
                }).row;
            };
            table.rowListeners = function(_row,_id){
                const self = this;
            };
            table.filterListener = function(_row,_id){
                // initialize filter
                FILTER.RESET({
                    dateEl: `#_date`,
                    populateTable: function(){
                        var _date = $(`#_date`).val() || DEFAULT_DATE;

                        FILTER.STATUS = "new";

                        $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");

                        
                        USER.filters["cico_events"] = {'Value.Event Start': FILTER.DATERANGE(_date), RuleName: "Check In, Check Out"};
                        table.countRows();
                    }
                });
                $(`#_date`).daterangepicker({
                    opens: 'left',
                    autoUpdateInput: false,
                    singleDatePicker:true,
                    autoApply: true
                }, function(start, end, label) {
                    FILTER.INITIALIZE($(this)["0"].element,start,end);
                    $('.clearable').trigger("input");
                }).on('apply.daterangepicker', function (ev, picker) {
                    FILTER.INITIALIZE($(this),picker.startDate,picker.endDate);
                    $('.clearable').trigger("input");
                });
                $(`#filter-btn`).click(function(){
                    var _date = $(`#_date`).val() || DEFAULT_DATE;

                    FILTER.STATUS = "new";

                    $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");

                    USER.filters["cico_events"] = { 'Value.Event Start': FILTER.DATERANGE(_date), RuleName: "Check In, Check Out" };
                    table.countRows();
                });
                // initialize filter
            };
            table.initialize();
            table.countRows();
        }
    }
};
var USERS = {
    FUNCTION: {
        stream: null,
        init: function(){
            var urlPath = "users",
                actionWidth = "0px",
                _new_ = true,
                allowedChangeableRoles = (CLIENT.allowRolesToChangeUserRole||{})[USER.role], // do not make || []
                table = new Table({
                    id: "#tbl-users",
                    urlPath,
                    goto: "users",
                    dataTableOptions: {
                        columns: TABLE.COL_ROW(CUSTOM.COLUMN.users()).column,
                        createdRow: function (row, data, dataIndex) {
                            var _row = data._row;

                            if(data._id.indexOf("wru_") > -1 || data['Email'].indexOf("wru.ph") > -1) {
                                $(row).addClass("notExport");
                            }

                            $(row).attr(`_row`, data._row);
                            table.rowListeners(_row,data._id);
                        },
                        dom: 'lB<"toolbar">frti<"tbl-progress-bar">p',
                    }
                });
            table.setButtons({
                actions:{
                    create: function(){
                        initializeModal({
                            url: `/api/users/${CLIENT.id}/${USER.username}`,
                            method: "POST",
                        });
                    },
                }
            });
            table.addRow = function(obj){
                const self = this;
                var action = TABLE.ROW_BUTTONS(PAGE.GET(),{username:obj._id});
                    (action.width != "0px") ? actionWidth = action.width : null;
                    $(`${self.id} th:last-child`).css({"min-width":actionWidth,"width":actionWidth});
    
                return TABLE.COL_ROW(null,{
                    '_row':  obj._row,
                    'Name': obj.name || "-",
                    '_id': obj._id,
                    'Title': obj.title || "-",
                    'Email': obj.email || "-",
                    'Phone Number': obj.phoneNumber || "-",
                    'Role': (obj.role || "User").capitalize(),
                    'Exempted': (obj.exemptAutoLogout) ? "Yes" : "No",
                    'Action': action.buttons,
                }).row;
            };
            table.rowListeners = function(_row,_id){
                const self = this;
                TABLE.ROW_LISTENER({table_id:self.id,_row,urlPath,_id,initializeModal});
            };

            var initializeModal = function(x){
                var title = (x.method == "POST") ? "Create New User" : "Edit User";
                $(`body`).append(modalViews.user.create(title,x.obj,null,"Please note that upon creating or updating user's information here will <u>not</u> affect the user in WRU Main."));
                x.obj = x.obj || {}; // put after append
                x.obj.role = x.obj.role || "user";
                GET.INTLTELINPUT("#phoneNumber");

                if(!allowedChangeableRoles){
                    $(`#role,#priv-title,#exemptAutoLogout`).parent().remove();
                    $(`.modal-dialog.modal-md`).removeClass("modal-md").addClass("modal-sm").css({"width":""});
                    $(`.modal-body > div`).removeClass("col-sm-5").addClass("col-sm-12");
                }
                if(!CLIENT.tabCloseAutoLogout){
                    $(`#exemptAutoLogout`).parent().remove();
                }

                var new_permission = PERMISSION_BY_ROLE[x.obj.role] || {};
                
                var populatePages = function(_role_){
                    var _obj_ = PERMISSION_BY_ROLE[_role_];
                    new_permission = {};
                    $(`#tbl-permission > tbody`).html("");
                    
                    Object.keys(_obj_).forEach(key => {
                        if(PAGE_FUNCTIONALITIES[key]){
                            var subText = "",
                                readPermission = _obj_[key].read || "None",
                                createPermission = _obj_[key].create || "None",
                                updatePermission = _obj_[key].update || "None",
                                deletePermission = _obj_[key].delete || "None";
                            new_permission[key] = _obj_[key];
                            if(key == "users" && (CLIENT.allowRolesToChangeUserRole||{})[_role_]){
                                subText = `<small class="d-block text-muted">Allowed to Update User's Role & Privileges</small>`;
                            }
                            $(`#tbl-permission > tbody`).append(`
                                <tr>
                                    <td class="font-normal" style="word-break: break-word;">${PAGE_FUNCTIONALITIES[key].title || "Unknown"}${subText}</td>
                                    <td>${readPermission.capitalize()}</td>
                                    <td>${createPermission.capitalize()}</td>
                                    <td>${updatePermission.capitalize()}</td>
                                    <td>${deletePermission.capitalize()}</td>
                                </tr>`);
                        }
                    });
                };

                var roleOptions = "";
                Object.keys(PERMISSION_BY_ROLE).forEach(key => {
                    var isValid = true;
                    clientCustom.ignoreRolesWithString.forEach(val => {
                        if(key.indexOf(val) > -1) isValid = false;
                    });
                    (!(allowedChangeableRoles||[]).includes(key)) ? isValid = false : null;
                    if(isValid){
                        var selected = (x.obj.role == key) ? "selected" : "";
                        roleOptions += `<option value="${key}" ${selected}>${key.capitalize()}</option>`;
                    }
                });
                $(`#role`).html(roleOptions).select2().val(x.obj.role || "user").change(function(){
                    var role = $(this).val();
                    
                    if(role){
                        populatePages(role.toLowerCase());
                        $(`#priv-title`).text(`Privileges of ${role.capitalize()}`);
                    } else {
                        $(`#tbl-permission > tbody`).html("");
                        $(`#priv-title`).text(`Privileges`);
                    }
                }).trigger("change");

                var roleSelected = $(`#role option:selected`).val() || "user";
                populatePages(roleSelected);
                $(`#priv-title`).text(`Privileges of ${roleSelected.capitalize()}`);

                if(!(allowedChangeableRoles||[]).includes(x.obj.role)){
                    var role = x.obj.role;
                    $(`#role`).html(`<option value="${(role||"user")}" selected>${(role||"user").capitalize()}</option>`).attr('disabled',true);
                    populatePages(role.toLowerCase());
                    $(`#priv-title`).text(`Privileges of ${role.capitalize()}`);
                }

                $(`#exemptAutoLogout`).val((x.obj.exemptAutoLogout||"false").toString());
                
                $(`#submit`).click(function(){
                    var name = ($(`#name`).val()||"")._trim(),
                        username = ($(`#username`).val()||"")._trim().toLowerCase(),
                        email = ($(`#email`).val()||"")._trim(),
                        role = ($(`#role option:selected`).val() || x.obj.role)._trim(),
                        phoneNumber = GET.INTLTELINPUT_VALUE("#phoneNumber"),
                        exemptAutoLogout = $(`#exemptAutoLogout option:selected`).val() || x.obj.exemptAutoLogout || false;

                    if(!(allowedChangeableRoles||[]).includes(role)){
                        role = x.obj.role || "user";
                    }
                    if(ALERT.REQUIREDFIELDS(`#modal-error`,$(this).parents("#overlay"))){}
                    else {
                        $(`#submit`).html(`<i class="la la-spinner la-spin mr-2"></i>Submit`).attr("disabled",true);
                        var body = {
                            _id: username,
                            name,
                            email,
                            phoneNumber,
                            role: role.toLowerCase(),
                            exemptAutoLogout: (exemptAutoLogout=='true'||exemptAutoLogout==true)
                        };
                        var historyOptions = {
                            fields: [
                                {
                                    key: "exemptAutoLogout",
                                    custom: true,
                                    customFunction: function(original,updated){
                                        (original?'Yes':'No')
                                        return (updated != original) ? HISTORY.fromTo('Exempted to Auto Logout',(original?'Yes':'No'),(updated?'Yes':'No')) : null;
                                    }
                                },
                                {
                                    key: "phoneNumber",
                                    customTitle: "Phone Number"
                                },
                                {
                                    key: "role",
                                    custom: true,
                                    customFunction: function(original,updated){
                                        return (updated != original) ? HISTORY.fromTo('Role',(original||"").capitalize(),(updated||"").capitalize()) : null;
                                    }
                                }
                            ]
                        };
                        
                        if(x.method == "PUT"){
                            delete body._id;
                            body = HISTORY.check(x.obj,body,USER.username,historyOptions);
                        }
                        GET.AJAX({
                            url: x.url,
                            method: x.method,
                            headers: {
                                "Content-Type": "application/json; charset=utf-8",
                                "Authorization": SESSION_TOKEN
                            },
                            data: JSON.stringify(body)
                        }, function(docs){
                            if(docs.ok == 1){
                                $(`#overlay`).remove();
                                (x.method == "PUT") ? TOASTR.UPDATEDSUCCESSFULLY() : TOASTR.CREATEDSUCCESSFULLY();
                            } else {
                                console.log(docs);
                                TOASTR.ERROR(docs);
                                $(`#submit`).html(`Submit`).attr("disabled",false);
                            }
                        }, function(error){
                            console.log(error);
                            TOASTR.ERROR(error.responseJSON);
                            $(`#submit`).html(`Submit`).attr("disabled",false);
                        });
                    }
                });
            };

            /******** TABLE CHECK ********/
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                isFinishedLoading(["USERS"], _new_, function(){
                    _new_ = false;
                    table.initialize();
                    table.populateRows(LIST[urlPath]);
                    table.hideProgressBar();
                });
            }
            TABLE.FINISH_LOADING.START_CHECK();
            /******** END TABLE CHECK ********/
        },
    }
};
var LOCATIONS = {
    FUNCTION: {
        regions: {
            stream: null,
            init: function(){
                var urlPath = "regions",
                    _new_ = true,  
                    _userData = null,
                    table = new Table({
                        id: "#tbl-regions",
                        urlPath,
                        goto: "regions",
                        dataTableOptions: {
                            columns: TABLE.COL_ROW(CUSTOM.COLUMN.regions).column,
                            order: [[ 2, "asc" ]],
                            // sDom: "t" + "<'row'<'col-sm-6'i><'col-sm-6'p>>", // remove all filter container
                            createdRow: function (row, data, dataIndex) {
                                var _row = data._row;
                                $(row).attr(`_row`,_row);
                                table.rowListeners(_row,data._id);
                            },
                            dom: 'lB<"toolbar">frti<"tbl-progress-bar">p',
                        },
                        initializeCallback: function(){
                            TABLE.WATCH({urlPath,rowData:table.addRow,options:function(){TABLE.FINISH_LOADING.START_CHECK();}});
                            if(_userData){
                                TABLE.FINISH_LOADING.UPDATE();
                            }
                        }
                    });
                table.setButtons({
                    loadView: ["create"],
                    actions:{
                        create: function(){
                            initializeModal({
                                url: `/api/${urlPath}/${CLIENT.id}/${USER.username}`,
                                method: "POST"
                            });
                        },
                    }
                });
                table.addRow = function(obj){
                    const self = this;
                    var action = TABLE.ROW_BUTTONS(PAGE.GET(),{loadView:["edit"],readonlyArr:["edit"]});
                    $(`${table.id} th:last-child`).css({"min-width":action.width,"width":action.width});

                    var getEscalationUsers = function(escalation,type){
                        var person_in_charge = obj.person_in_charge || {};
                        person_in_charge[escalation] = person_in_charge[escalation] || {};
                        var arr = person_in_charge[escalation][type] || [];

                        var str = null;
                        if(_userData){
                            var names = [];
                            arr.forEach(val => {
                                // did not use _userData because if _users is already in LIST[urlPath], it will not load the users' name
                                var user = LIST["users"].find(x => x._id === val);
                                (user) ? names.push(user.name || val) : names.push(`<span class="text-danger" style="font-style: italic;">${val}</span>`);
                            });
                            str = names.join(", ") || `<span class="text-muted font-italic">Unassigned</span>`;
                        } else {
                            str = `<small class="font-italic text-muted">loading...</small>`;
                        }
                        return str;
                    };

                    return TABLE.COL_ROW(null,{
                        '_id': obj._id,
                        '_row':  obj._row,
                        'Region Name': obj.name || "-",
                        'Region Code': obj.code || "-",
                        'Sequence': obj.sequence,
                        'esq1_lq': getEscalationUsers("escalation1","lq"),
                        'esq1_oc': getEscalationUsers("escalation1","oc"),
                        'esq1_ot': getEscalationUsers("escalation1","ot"),
                        'esq2_lq': getEscalationUsers("escalation2","lq"),
                        'esq2_oc': getEscalationUsers("escalation2","oc"),
                        'esq2_ot': getEscalationUsers("escalation2","ot"),
                        'esq3_lq': getEscalationUsers("escalation3","lq"),
                        'esq3_oc': getEscalationUsers("escalation3","oc"),
                        'esq3_ot': getEscalationUsers("escalation3","ot"),
                        'Action': action.buttons,
                    }).row;
                };
                table.rowListeners = function(_row,_id){
                    const self = this;
                    
                    TABLE.ROW_LISTENER({table_id:table.id,_row,urlPath,_id,initializeModal,
                        deleteModalContent: `All of the clusters and geofences linked to this region will be deleted too. Are you sure you still want to delete this region?`,
                    });
                };

                var initializeModal = function(x){
                    var title = (x.method == "PUT") ? `Edit Region Data` : `Create New Region`,
                        modalElements = function(obj){
                            obj = obj || {};
                            return [
                                {title:"Region Name",id:"name",type:"text",required:true,value:obj.name},
                                {title:"Region Code",id:"code",type:"text",required:true,value:obj.code},
                                {title:"Sequence",id:"sequence",type:"number",required:true,value:obj.sequence,sub_title:"Please enter a number. This refers to the sequence of the tabs in the Deployment Dashboard."},
                            ];
                        };
                        var column2Content = `${ALERT.HTML.INFO("This will be overridden by the Person In-Charge set in clusters and/or sites linked to this region.","m-0 mb-3",true)}
                                            <div class="panel panel-tab">
                                                <div class="panel-heading">
                                                    <h3 class="panel-title">Person In-Charge</h3>
                                                    <ul class="nav nav-tabs pull-right">
                                                        <li class="active"><a href="#esc1" data-toggle="tab" aria-expanded="false"><i class="fa fa-user"></i> Escalation 1</a></li>
                                                        <li class=""><a href="#esc2" data-toggle="tab" aria-expanded="true"><i class="fa fa-feed"></i> Escalation 2</a></li>
                                                        <li class=""><a href="#esc3" data-toggle="tab" aria-expanded="false"><i class="fa fa-gear"></i> Escalation 3</a></li>
                                                    </ul>
                                                </div>
                                                <div class="panel-body p-0">
                                                    <div class="tab-content no-padding">
                                                        <div class="tab-pane fade active in" id="esc1">
                                                            <div class="panel panel-tab" style="border: none;">
                                                                <div class="panel-heading">
                                                                    <h3 class="panel-title"></h3>
                                                                    <ul class="nav nav-tabs pull-right">
                                                                        <li class="active"><a href="#_esc1-lq_" data-toggle="tab" aria-expanded="false"><i class="fa fa-user"></i>Long Queueing</a></li>
                                                                        <li class=""><a href="#_esc1-oc_" data-toggle="tab" aria-expanded="false"><i class="fa fa-feed"></i> Over CICO</a></li>
                                                                        <li class=""><a href="#_esc1-ot_" data-toggle="tab" aria-expanded="true"><i class="fa fa-gear"></i>Over Transit</a></li>
                                                                    </ul>
                                                                </div>
                                                                <div class="panel-body">
                                                                    <div class="tab-content no-padding">
                                                                        <div class="tab-pane fade active in" id="_esc1-lq_">
                                                                            <select id="esc1-lq" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                            <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                        </div>
                                                                        <div class="tab-pane fade" id="_esc1-oc_">
                                                                        <select id="esc1-oc" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                        </div>
                                                                        <div class="tab-pane fade" id="_esc1-ot_">
                                                                            <select id="esc1-ot" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                            <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="tab-pane fade" id="esc2">
                                                            <div class="panel panel-tab" style="border: none;">
                                                                <div class="panel-heading">
                                                                    <h3 class="panel-title"></h3>
                                                                    <ul class="nav nav-tabs pull-right">
                                                                        <li class="active"><a href="#_esc2-lq_" data-toggle="tab" aria-expanded="true"><i class="fa fa-user"></i>Long Queueing</a></li>
                                                                        <li class=""><a href="#_esc2-oc_" data-toggle="tab" aria-expanded="true"><i class="fa fa-feed"></i> Over CICO</a></li>
                                                                        <li class=""><a href="#_esc2-ot_" data-toggle="tab" aria-expanded="true"><i class="fa fa-gear"></i>Over Transit</a></li>
                                                                    </ul>
                                                                </div>
                                                                <div class="panel-body">
                                                                    <div class="tab-content no-padding">
                                                                        <div class="tab-pane fade active in" id="_esc2-lq_">
                                                                            <select id="esc2-lq" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                            <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                        </div>
                                                                        <div class="tab-pane fade" id="_esc2-oc_">
                                                                            <select id="esc2-oc" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                            <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                        </div>
                                                                        <div class="tab-pane fade" id="_esc2-ot_">
                                                                            <select id="esc2-ot" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                            <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="tab-pane fade" id="esc3">
                                                            <div class="panel panel-tab" style="border: none;">
                                                                <div class="panel-heading">
                                                                    <h3 class="panel-title"></h3>
                                                                    <ul class="nav nav-tabs pull-right">
                                                                        <li class="active"><a href="#_esc3-lq_" data-toggle="tab" aria-expanded="true"><i class="fa fa-user"></i>Long Queueing</a></li>
                                                                        <li class=""><a href="#_esc3-oc_" data-toggle="tab" aria-expanded="true"><i class="fa fa-feed"></i> Over CICO</a></li>
                                                                        <li class=""><a href="#_esc3-ot_" data-toggle="tab" aria-expanded="true"><i class="fa fa-gear"></i>Over Transit</a></li>
                                                                    </ul>
                                                                </div>
                                                                <div class="panel-body">
                                                                    <div class="tab-content no-padding">
                                                                        <div class="tab-pane fade active in" id="_esc3-lq_">
                                                                            <select id="esc3-lq" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                            <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                        </div>
                                                                        <div class="tab-pane fade" id="_esc3-oc_">
                                                                            <select id="esc3-oc" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                            <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                        </div>
                                                                        <div class="tab-pane fade" id="_esc3-ot_">
                                                                            <select id="esc3-ot" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                            <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>`;

                        $(`body`).append(MODAL.CREATE.BASIC({
                            modalStyle: "width:900px;",
                            title,
                            el: modalElements(x.obj),
                            columned:true,
                            column1Style: "col-sm-5",
                            column2Style: "col-sm-7",
                            column2Content,
                        }));

                        var obj = x.obj || {};
                        var person_in_charge = obj.person_in_charge || {};
                        var options = "";
                        _userData.forEach(op => {
                            options += `<option value="${op.id}">${op.value || op.id}</option>`;
                        });
                        $(`#esc1-lq,#esc2-lq,#esc3-lq,#esc1-oc,#esc2-oc,#esc3-oc,#esc1-ot,#esc2-ot,#esc3-ot`).html(options).select2({
                            multiple: true,
                            tokenSeparators: [',', ', '],
                            matcher: function(query, data) {
                                var term = query.term;
                                var text = data.text;
                                var id = data.id;
                                if(text.toUpperCase().indexOf(term.toUpperCase()) > -1 || id.toUpperCase().indexOf(term.toUpperCase()) > -1){
                                    return data;
                                } else {
                                    return null;
                                }
                            }
                        });
                        function populateSelect2(escalation,short,type){
                            if(person_in_charge[escalation]){
                                if(person_in_charge[escalation][type]){
                                    var value = person_in_charge[escalation][type] || [];
                                    var options = "";
                                    _userData.forEach(op => {
                                        var selected = (value.includes(op.id)) ? "selected" : "";
                                        options += `<option value="${op.id}" ${selected}>${op.value || op.id}</option>`;
                                    });
                                    $(`#${short}-${type}`).html(options).select2({
                                        multiple: true,
                                        tokenSeparators: [',', ', '],
                                        matcher: function(query, data) {
                                            var term = query.term;
                                            var text = data.text;
                                            var id = data.id;
                                            if(text.toUpperCase().indexOf(term.toUpperCase()) > -1 || id.toUpperCase().indexOf(term.toUpperCase()) > -1){
                                                return data;
                                            } else {
                                                return null;
                                            }
                                        }
                                    });
                                }
                            }
                        }
                        populateSelect2("escalation1","esc1","lq");
                        populateSelect2("escalation1","esc1","oc");
                        populateSelect2("escalation1","esc1","ot");
                        populateSelect2("escalation2","esc2","lq");
                        populateSelect2("escalation2","esc2","oc");
                        populateSelect2("escalation2","esc2","ot");
                        populateSelect2("escalation3","esc3","lq");
                        populateSelect2("escalation3","esc3","oc");
                        populateSelect2("escalation3","esc3","ot");

                        MODAL.SUBMIT(x,null, function(){
                            var pic = {
                                escalation1: {
                                    lq: $(`#esc1-lq`).val() || [],
                                    oc: $(`#esc1-oc`).val() || [],
                                    ot: $(`#esc1-ot`).val() || [],
                                },
                                escalation2: {
                                    lq: $(`#esc2-lq`).val() || [],
                                    oc: $(`#esc2-oc`).val() || [],
                                    ot: $(`#esc2-ot`).val() || [],
                                },
                                escalation3: {
                                    lq: $(`#esc3-lq`).val() || [],
                                    oc: $(`#esc3-oc`).val() || [],
                                    ot: $(`#esc3-ot`).val() || [],
                                },
                            };
                            return {
                                person_in_charge: pic
                            };
                        });
                        
                    // $(`#person_in_charge`).select2({
                    //     tokenSeparators: [',', ', '],
                    //     matcher: function(query, data) {
                    //         var term = query.term;
                    //         var text = data.text;
                    //         var id = data.id;
                    //         if(text.toUpperCase().indexOf(term.toUpperCase()) > -1 || id.toUpperCase().indexOf(term.toUpperCase()) > -1){
                    //             return data;
                    //         } else {
                    //             return null;
                    //         }
                    //     }
                    // });
                };

                /******** TABLE CHECK ********/
                // always put before POPULATE functions
                LIST[urlPath] = LIST[urlPath] || [];
                TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                    isFinishedLoading(["REGIONS"], _new_, function(){
                        _new_ = false;
                        table.initialize();
                        table.populateRows(LIST[urlPath]);
                        table.hideProgressBar();
                    });
                    if(_userData) {
                        if(LIST[urlPath].length > 0 && !LIST[urlPath][0]._users && table.dt){
                            table.updateRows(LIST[urlPath]);
                        }
                        TABLE.FINISH_LOADING.UPDATE();
                    }
                }
                /******** END TABLE CHECK ********/
                
                /******** USERS ********/
                var _USERS_ = {
                    urlPath: "users",
                    populate: function(){
                        var _THIS_ = this;
                        _userData = [];
                        LIST[_THIS_.urlPath].forEach(val => {
                            _userData.push({
                                id: val._id,
                                value: val.name
                            });
                        });
                        _userData = SORT.ARRAY_OBJECT(_userData,"value",{sortType:"asc"});
                        TABLE.FINISH_LOADING.START_CHECK();
                    },
                    fetch: function(){
                        var _THIS_ = this;
                        if(LIST[_THIS_.urlPath]){
                            _USERS_.populate();
                        } else {
                            GET.AJAX({
                                url: `/api/${_THIS_.urlPath}/${CLIENT.id}/${USER.username}/all/${JSON.stringify({})}/0/0`,
                                method: "GET",
                                headers: {
                                    "Authorization": SESSION_TOKEN
                                },
                            }, function(docs){
                                console.log("Users",docs);
                                LIST[_THIS_.urlPath] = LIST[_THIS_.urlPath] || [];
                                docs.forEach(val => {
                                    var index = LIST[_THIS_.urlPath].findIndex(x => x._id == val._id);
                                    if(index > -1){
                                        LIST[_THIS_.urlPath][index] = val;
                                    } else {
                                        val._row = GENERATE.RANDOM(36);
                                        LIST[_THIS_.urlPath].push(val);
                                    }
                                });
                                _USERS_.populate();
                            });
                        }
                    }
                };
                _USERS_.fetch();
                /******** END USERS ********/

                TABLE.FINISH_LOADING.START_CHECK();
            }
        },
        clusters: {
            stream: null,
            init: function(){
                var urlPath = "clusters",
                    _new1_ = true,
                    _new2_ = true,
                    _new3_ = true,
                    _userData = null,
                    _USERS_,
                    table = new Table({
                        id: "#tbl-clusters",
                        urlPath,
                        goto: "clusters",
                        dataTableOptions: {
                            columns: TABLE.COL_ROW(CUSTOM.COLUMN.clusters()).column,
                            order: [[ 3, "asc" ]],
                            // sDom: "t" + "<'row'<'col-sm-6'i><'col-sm-6'p>>", // remove all filter container
                            createdRow: function (row, data, dataIndex) {
                                var _row = data._row;
                                $(row).attr(`_row`, data._row);
                                table.rowListeners(_row,data._id);
                                
                            },
                            dom: 'lB<"toolbar">frti<"tbl-progress-bar">p',
                        },
                        initializeCallback: function(){
                            TABLE.WATCH({urlPath,rowData:table.addRow,options:function(){TABLE.FINISH_LOADING.START_CHECK();}});
                            if(_userData && GGS.STATUS.REGIONS){
                                TABLE.FINISH_LOADING.UPDATE();
                            }
                        }
                    });
                table.setButtons({
                    loadView: ["create"],
                    actions:{
                        create: function(){
                            initializeModal({
                                url: `/api/${urlPath}/${CLIENT.id}/${USER.username}`,
                                method: "POST"
                            });
                        },
                    }
                });
                table.addRow = function(obj){
                    new loadInBackground("regions","REGIONS").g_select_settings();

                    const self = this;
                    var action = TABLE.ROW_BUTTONS(PAGE.GET(),{loadView:["edit"],readonlyArr:["edit"]});
                    $(`${self.id} th:last-child`).css({"min-width":action.width,"width":action.width});

                    var region = (LIST["regions"]) ? (getRegion(obj.region_id) || {}).code : `<small class="font-italic text-muted">loading...</small>`;
                    var totalGeofences = (GGS.STATUS.GEOFENCES) ? (getGeofence(obj._id,"cluster_id","filter") || {}).length : `<small class="font-italic text-muted">loading...</small>`;

                    (LIST["regions"]) ? obj._region = region : null;
                    (GGS.STATUS.GEOFENCES) ? obj.totalGeofences = totalGeofences : null;
                    
                    var getEscalationUsers = function(escalation,type){
                        var person_in_charge = obj.person_in_charge || {};
                        person_in_charge[escalation] = person_in_charge[escalation] || {};
                        var arr = person_in_charge[escalation][type] || [];

                        var str = null;
                        if(_userData){
                            var names = [];
                            arr.forEach(val => {
                                // did not use _userData because if _users is already in LIST[urlPath], it will not load the users' name
                                var user = LIST["users"].find(x => x._id === val);
                                (user) ? names.push(user.name || val) : names.push(`<span class="text-danger" style="font-style: italic;">${val}</span>`);
                            });
                            str = names.join(", ") || `<span class="text-muted font-italic">Unassigned</span>`;
                        } else {
                            str = `<small class="font-italic text-muted">loading...</small>`;
                        }
                        return str;
                    };
        
                    return TABLE.COL_ROW(null,{
                        '_id': obj._id,
                        '_row':  obj._row,
                        'Cluster': obj.cluster || "-",
                        'Region': region || "-",
                        'Geofences': totalGeofences + `<a viewSites href="javascript:void(0);" class="ml-2" style="font-size: 11px;"><i class="la la-search-plus" style="margin-right: 3px;"></i>View sites</a>`,
                        'Sequence': obj.sequence || "-",
                        'esq1_lq': getEscalationUsers("escalation1","lq"),
                        'esq1_oc': getEscalationUsers("escalation1","oc"),
                        'esq1_ot': getEscalationUsers("escalation1","ot"),
                        'esq2_lq': getEscalationUsers("escalation2","lq"),
                        'esq2_oc': getEscalationUsers("escalation2","oc"),
                        'esq2_ot': getEscalationUsers("escalation2","ot"),
                        'esq3_lq': getEscalationUsers("escalation3","lq"),
                        'esq3_oc': getEscalationUsers("escalation3","oc"),
                        'esq3_ot': getEscalationUsers("escalation3","ot"),
                        'Action': action.buttons,
                    }).row;
                };
                table.rowListeners = function(_row,_id){
                    const self = this;
                    TABLE.ROW_LISTENER({table_id:self.id,_row,urlPath,_id,initializeModal,
                        deleteModalContent: `All of the geofences linked to this cluster will be deleted too. Are you sure you still want to delete this cluster?`,
                        additionalListeners: function(){
                            $(self.id).on('click', `[_row="${_row}"] [viewSites],[_row="${_row}"] + tr.child [viewSites]`,function(e){
                                e.stopImmediatePropagation();
                                USER.filters["geofences"] = { cluster_id: _id };
                                window.history.pushState({}, null, `${window.location.pathname}#geofences`);
                                PAGE.GO_TO();
                            });
                        
                        }
                    });
                };

                var initializeModal = function(x){
                    new loadInBackground("regions","REGIONS").g_select_settings();

                    var obj = x.obj || {};
                    var title = (x.method == "PUT") ? `Edit Cluster Data` : `Create New Cluster`,
                        modalElements = function(){
                            var arr = [];
                            clientCustom.modalFields.clusters.forEach(val => {
                                switch (val) {
                                    case "cluster":
                                        arr.push({title:"Cluster",id:"cluster",type:"text",required:true,value:obj.cluster});
                                        break;
                                    case "region_id":
                                        arr.push({title:"Region",id:"region_id",type:"select",required:true,value:obj.region_id,options:G_SELECT["regions"]});
                                        break;
                                    case "sequence":
                                        arr.push({title:"Sequence",id:"sequence",type:"number",value:obj.sequence,sub_title:"Please enter a number. This refers to the sequence/order of the clusters in the reports."});
                                        break;
                                    default:
                                        break;
                                }
                            });
                            return arr;
                        };
                    var column2Content = `${ALERT.HTML.INFO("This will override the Person In-Charge set in cluster's region but will be overridden by the Person In-Charge set per Site, if any.","m-0 mb-3",true)}
                                        <div class="panel panel-tab">
                                            <div class="panel-heading">
                                                <h3 class="panel-title">Person In-Charge</h3>
                                                <ul class="nav nav-tabs pull-right">
                                                    <li class="active"><a href="#esc1" data-toggle="tab" aria-expanded="false"><i class="fa fa-user"></i> Escalation 1</a></li>
                                                    <li class=""><a href="#esc2" data-toggle="tab" aria-expanded="true"><i class="fa fa-feed"></i> Escalation 2</a></li>
                                                    <li class=""><a href="#esc3" data-toggle="tab" aria-expanded="false"><i class="fa fa-gear"></i> Escalation 3</a></li>
                                                </ul>
                                            </div>
                                            <div class="panel-body p-0">
                                                <div class="tab-content no-padding">
                                                    <div class="tab-pane fade active in" id="esc1">
                                                        <div class="panel panel-tab" style="border: none;">
                                                            <div class="panel-heading">
                                                                <h3 class="panel-title"></h3>
                                                                <ul class="nav nav-tabs pull-right">
                                                                    <li class="active"><a href="#_esc1-lq_" data-toggle="tab" aria-expanded="false"><i class="fa fa-user"></i>Long Queueing</a></li>
                                                                    <li class=""><a href="#_esc1-oc_" data-toggle="tab" aria-expanded="false"><i class="fa fa-feed"></i> Over CICO</a></li>
                                                                    <li class=""><a href="#_esc1-ot_" data-toggle="tab" aria-expanded="true"><i class="fa fa-gear"></i>Over Transit</a></li>
                                                                </ul>
                                                            </div>
                                                            <div class="panel-body">
                                                                <div class="tab-content no-padding">
                                                                    <div class="tab-pane fade active in" id="_esc1-lq_">
                                                                        <select id="esc1-lq" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                    <div class="tab-pane fade" id="_esc1-oc_">
                                                                    <select id="esc1-oc" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                    <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                    <div class="tab-pane fade" id="_esc1-ot_">
                                                                        <select id="esc1-ot" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="tab-pane fade" id="esc2">
                                                        <div class="panel panel-tab" style="border: none;">
                                                            <div class="panel-heading">
                                                                <h3 class="panel-title"></h3>
                                                                <ul class="nav nav-tabs pull-right">
                                                                    <li class="active"><a href="#_esc2-lq_" data-toggle="tab" aria-expanded="true"><i class="fa fa-user"></i>Long Queueing</a></li>
                                                                    <li class=""><a href="#_esc2-oc_" data-toggle="tab" aria-expanded="true"><i class="fa fa-feed"></i> Over CICO</a></li>
                                                                    <li class=""><a href="#_esc2-ot_" data-toggle="tab" aria-expanded="true"><i class="fa fa-gear"></i>Over Transit</a></li>
                                                                </ul>
                                                            </div>
                                                            <div class="panel-body">
                                                                <div class="tab-content no-padding">
                                                                    <div class="tab-pane fade active in" id="_esc2-lq_">
                                                                        <select id="esc2-lq" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                    <div class="tab-pane fade" id="_esc2-oc_">
                                                                        <select id="esc2-oc" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                    <div class="tab-pane fade" id="_esc2-ot_">
                                                                        <select id="esc2-ot" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="tab-pane fade" id="esc3">
                                                        <div class="panel panel-tab" style="border: none;">
                                                            <div class="panel-heading">
                                                                <h3 class="panel-title"></h3>
                                                                <ul class="nav nav-tabs pull-right">
                                                                    <li class="active"><a href="#_esc3-lq_" data-toggle="tab" aria-expanded="true"><i class="fa fa-user"></i>Long Queueing</a></li>
                                                                    <li class=""><a href="#_esc3-oc_" data-toggle="tab" aria-expanded="true"><i class="fa fa-feed"></i> Over CICO</a></li>
                                                                    <li class=""><a href="#_esc3-ot_" data-toggle="tab" aria-expanded="true"><i class="fa fa-gear"></i>Over Transit</a></li>
                                                                </ul>
                                                            </div>
                                                            <div class="panel-body">
                                                                <div class="tab-content no-padding">
                                                                    <div class="tab-pane fade active in" id="_esc3-lq_">
                                                                        <select id="esc3-lq" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                    <div class="tab-pane fade" id="_esc3-oc_">
                                                                        <select id="esc3-oc" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                    <div class="tab-pane fade" id="_esc3-ot_">
                                                                        <select id="esc3-ot" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>`;

                    $(`body`).append(MODAL.CREATE.BASIC({
                        modalStyle: "width:900px;",
                        title,
                        el: modalElements(),
                        columned:true,
                        column1Style: "col-sm-5",
                        column2Style: "col-sm-7",
                        column2Content,
                    }));

                    var person_in_charge = obj.person_in_charge || {};
                    var options = "";
                    _userData.forEach(op => {
                        options += `<option value="${op.id}">${op.value || op.id}</option>`;
                    });
                    $(`#esc1-lq,#esc2-lq,#esc3-lq,#esc1-oc,#esc2-oc,#esc3-oc,#esc1-ot,#esc2-ot,#esc3-ot`).html(options).select2({
                        multiple: true,
                        tokenSeparators: [',', ', '],
                        matcher: function(query, data) {
                            var term = query.term;
                            var text = data.text;
                            var id = data.id;
                            if(text.toUpperCase().indexOf(term.toUpperCase()) > -1 || id.toUpperCase().indexOf(term.toUpperCase()) > -1){
                                return data;
                            } else {
                                return null;
                            }
                        }
                    });
                    function populateSelect2(escalation,short,type){
                        if(person_in_charge[escalation]){
                            if(person_in_charge[escalation][type]){
                                var value = person_in_charge[escalation][type] || [];
                                var options = "";
                                _userData.forEach(op => {
                                    var selected = (value.includes(op.id)) ? "selected" : "";
                                    options += `<option value="${op.id}" ${selected}>${op.value || op.id}</option>`;
                                });
                                $(`#${short}-${type}`).html(options).select2({
                                    multiple: true,
                                    tokenSeparators: [',', ', '],
                                    matcher: function(query, data) {
                                        var term = query.term;
                                        var text = data.text;
                                        var id = data.id;
                                        if(text.toUpperCase().indexOf(term.toUpperCase()) > -1 || id.toUpperCase().indexOf(term.toUpperCase()) > -1){
                                            return data;
                                        } else {
                                            return null;
                                        }
                                    }
                                });
                            }
                        }
                    }
                    populateSelect2("escalation1","esc1","lq");
                    populateSelect2("escalation1","esc1","oc");
                    populateSelect2("escalation1","esc1","ot");
                    populateSelect2("escalation2","esc2","lq");
                    populateSelect2("escalation2","esc2","oc");
                    populateSelect2("escalation2","esc2","ot");
                    populateSelect2("escalation3","esc3","lq");
                    populateSelect2("escalation3","esc3","oc");
                    populateSelect2("escalation3","esc3","ot");

                    MODAL.SUBMIT(x,null, function(){
                        var pic = {
                            escalation1: {
                                lq: $(`#esc1-lq`).val() || [],
                                oc: $(`#esc1-oc`).val() || [],
                                ot: $(`#esc1-ot`).val() || [],
                            },
                            escalation2: {
                                lq: $(`#esc2-lq`).val() || [],
                                oc: $(`#esc2-oc`).val() || [],
                                ot: $(`#esc2-ot`).val() || [],
                            },
                            escalation3: {
                                lq: $(`#esc3-lq`).val() || [],
                                oc: $(`#esc3-oc`).val() || [],
                                ot: $(`#esc3-ot`).val() || [],
                            },
                        };
                        return {
                            person_in_charge: pic
                        };
                    });
                };

                /******** TABLE CHECK ********/
                // always put before POPULATE functions
                LIST[urlPath] = LIST[urlPath] || [];
                TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                    if(_userData) {
                        if(LIST[urlPath].length > 0 && !LIST[urlPath][0]._users && table.dt){
                            table.updateRows(LIST[urlPath]);
                        }
                    }
                    isFinishedLoading(["GEOFENCES"], _new1_, function(){
                        _new1_ = false;
    
                        if(LIST[urlPath].length > 0 && LIST[urlPath][0].totalGeofences == null && table.dt){
                            table.updateRows(LIST[urlPath]);
                        }
                    });
                    isFinishedLoading(["REGIONS"], _new2_, function(){
                        _new2_ = false;
    
                        if(LIST[urlPath].length > 0 && !LIST[urlPath][0]._region){
                            table.updateRows(LIST[urlPath]);
                        }
                    });
                    isFinishedLoading(["CLUSTERS"], _new3_, function(){
                        _new3_ = false;
    
                        table.initialize();
                        table.populateRows(LIST[urlPath]);
                        table.hideProgressBar();
                    });
                    isFinishedLoading(["REGIONS"], true, function(){
                        if(_userData){
                            TABLE.FINISH_LOADING.UPDATE();
                        }
                    });
                }
                /******** END TABLE CHECK ********/
                
                /******** USERS & REGIONS********/
                _USERS_ = {
                    urlPath: "users",
                    populate: function(){
                        var _THIS_ = this;
                        _userData = [];
                        LIST[_THIS_.urlPath].forEach(val => {
                            _userData.push({
                                id: val._id,
                                value: val.name
                            });
                        });
                        _userData = SORT.ARRAY_OBJECT(_userData,"value",{sortType:"asc"});
                        TABLE.FINISH_LOADING.START_CHECK();
                    },
                    fetch: function(){
                        var _THIS_ = this;
                        if(LIST[_THIS_.urlPath]){
                            _USERS_.populate();
                        } else {
                            GET.AJAX({
                                url: `/api/${_THIS_.urlPath}/${CLIENT.id}/${USER.username}/all/${JSON.stringify({})}/0/0`,
                                method: "GET",
                                headers: {
                                    "Authorization": SESSION_TOKEN
                                },
                            }, function(docs){
                                console.log("Users",docs);
                                LIST[_THIS_.urlPath] = LIST[_THIS_.urlPath] || [];
                                docs.forEach(val => {
                                    var index = LIST[_THIS_.urlPath].findIndex(x => x._id == val._id);
                                    if(index > -1){
                                        LIST[_THIS_.urlPath][index] = val;
                                    } else {
                                        val._row = GENERATE.RANDOM(36);
                                        LIST[_THIS_.urlPath].push(val);
                                    }
                                });
                                _USERS_.populate();
                            });
                        }
                    }
                };
                _USERS_.fetch();
                /******** END USERS & REGIONS ********/

                TABLE.FINISH_LOADING.START_CHECK();
            }
        },
        geofences: {
            stream: null,
            init: function(){
                var urlPath = "geofences", 
                    _new1_ = true,  
                    _new2_ = true,  
                    _new3_ = true,   
                    _userData = null,
                    _USERS_,
                    table = new Table({
                        id: "#tbl-geofences",
                        urlPath,
                        goto: "geofences",
                        filterType: "basic",
                        dataTableOptions: {
                            columns: TABLE.COL_ROW(CUSTOM.COLUMN.geofences()).column,
                            order: [[ 0, "desc" ]],
                            createdRow: function (row, data, dataIndex) {
                                var _row = data._row;
                                $(row).attr(`_row`, data._row);
                                table.rowListeners(_row,data._id);
                            },
                            dom: 'lB<"toolbar">frti<"tbl-progress-bar">p',
                        },
                        initializeCallback: function(){
                            $(`.row-filter`).hide();
                            PAGE.TOOLTIP();
                            TABLE.WATCH({urlPath,rowData:table.addRow,options:function(){TABLE.FINISH_LOADING.START_CHECK();}});
                            if(_userData && GGS.STATUS.REGIONS && GGS.STATUS.CLUSTERS){
                                TABLE.FINISH_LOADING.UPDATE();
                            }
                        }
                    });
                table.setButtons({
                    loadView: ["create"],
                });
                table.addRow = function(obj){
                    const self = this;
                    var action = TABLE.ROW_BUTTONS(PAGE.GET(),{loadView:["edit"],readonlyArr:["edit"]}),
                        getGGSRowValue = function(arr,_v_,_o_){
                            var str;
                            if(arr){
                                str = arr.find(x => x.id == obj[_v_]) || {};
                                obj[_o_] = str.value;
                            } else {
                                str = {value:`<small class="font-italic text-muted">loading...</small>`};
                            }
                            return str;
                        },
                        getUsersValue = function(_v_,_o_){
                            var str = null;
                            if(_userData){
                                obj[_v_] = obj[_v_] || [];
                                var names = [];
                                obj[_v_].forEach(val => {
                                    // did not use _userData because if _users is already in LIST[urlPath], it will not load the users' name
                                    var user = LIST["users"].find(x => x._id === val);
                                    (user) ? names.push(user.name || val) : names.push(`<span class="text-danger" style="font-style: italic;">${val}</span>`);
                                });
                                obj[_o_] = names.join(", ") || `<span class="text-muted font-italic">Unassigned</span>`;
        
                                // added additional variable because obj[_o_] is needed for checking in GGS
                                str = obj[_o_];
                            } else {
                                str = `<small class="font-italic text-muted">loading...</small>`;
                            }
                            return str;
                        },
                        getEscalationUsers = function(escalation,type){
                            var person_in_charge = obj.person_in_charge || {};
                            person_in_charge[escalation] = person_in_charge[escalation] || {};
                            var arr = person_in_charge[escalation][type] || [];

                            var str = null;
                            if(_userData){
                                var names = [];
                                arr.forEach(val => {
                                    // did not use _userData because if _users is already in LIST[urlPath], it will not load the users' name
                                    var user = LIST["users"].find(x => x._id === val);
                                    (user) ? names.push(user.name || val) : names.push(`<span class="text-danger" style="font-style: italic;">${val}</span>`);
                                });
                                str = names.join(", ") || `<span class="text-muted font-italic">Unassigned</span>`;
                            } else {
                                str = `<small class="font-italic text-muted">loading...</small>`;
                            }
                            return str;
                        },
                        region = getGGSRowValue(G_SELECT["regions"],"region_id","_region"),
                        cluster = getGGSRowValue(G_SELECT["clusters"],"cluster_id","_cluster"),
                        dUsers = getUsersValue("dispatcher","_dUsers");
        
                    $(`${table.id} th:last-child`).css({"min-width":action.width,"width":action.width});
        
                    return TABLE.COL_ROW(null,{
                        '_id': obj._id,
                        '_row':  obj._row,
                        'Site Code': obj.code || "-",
                        'Site Name': obj.site_name || "-",
                        'Short Name': obj.short_name || "-",
                        'CICO': DATETIME.HH_MM(null,obj.cico).hour_minute,
                        'Trippage Target': obj.trippage_target || "-",
                        'Cluster': cluster.value || "-",
                        'Region': region.value || "-",
                        'Dispatcher': dUsers,
                        'esq1_lq': getEscalationUsers("escalation1","lq"),
                        'esq1_oc': getEscalationUsers("escalation1","oc"),
                        'esq1_ot': getEscalationUsers("escalation1","ot"),
                        'esq2_lq': getEscalationUsers("escalation2","lq"),
                        'esq2_oc': getEscalationUsers("escalation2","oc"),
                        'esq2_ot': getEscalationUsers("escalation2","ot"),
                        'esq3_lq': getEscalationUsers("escalation3","lq"),
                        'esq3_oc': getEscalationUsers("escalation3","oc"),
                        'esq3_ot': getEscalationUsers("escalation3","ot"),
                        'Action': action.buttons,
                    }).row;
                };
                table.rowListeners = function(_row,_id){
                    const self = this;
                    TABLE.ROW_LISTENER({table_id:self.id,_row,urlPath,_id,initializeModal});
                };
                table.filterListener = function(){
                    if(table.filter && Object.keys(table.filter).length > 0) {
                        $(`.dt-button[data-original-title="Filter"]`).click();
                        $('.clearable').trigger("input");
                    }
                    FILTER.RESET({
                        selectEl: `#_region_id,#_cluster_id`,
                        urlPath,
                        populateTable: function(){
                            FILTER.STATUS = "new";
                            $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");
        
                            table.countRows();
                        }
                    });
                    FILTER.CLICK( table , urlPath, true, [
                        { id: "#_region_id", key: "region_id", type: "string" }, // string, number, date
                        { id: "#_cluster_id", key: "cluster_id", type: "string" }, // string, number, date
                    ]);
                }
        
                var initializeModal = function(x){
                    new loadInBackground("regions","REGIONS").g_select_settings();
                    new loadInBackground("clusters","CLUSTERS").g_select_settings();

                    var obj = x.obj || {};

                    function modalElements(){
                        var arr = [];
                        var readonly = (obj.code) ? true : false;
                        
                        clientCustom.modalFields.geofences.forEach(val => {
                            switch (val) {
                                case "site_name":
                                    arr.push({title:"Site Name",id:"site_name",type:"text",required:true,value:obj.site_name});
                                    break;
                                case "short_name":
                                    arr.push({title:"Short Name",id:"short_name",type:"text",required:true,value:obj.short_name});
                                    break;
                                case "code":
                                    arr.push({title:"Site Code",id:"code",type:"text",required:true,value:obj.code, readonly, sub_title:"You <u>cannot</u> change the site code once saved."});
                                    break;
                                case "cico":
                                    arr.push({title:"CICO (HH:MM)",id:"cico",type:"time",required:true,value:obj.cico});
                                break;
                                case "trippage_target":
                                    arr.push({title:"Trippage Target",id:"trippage_target",type:"text",required:false,value:obj.trippage_target||0});
                                break;
                                case "cluster_id":
                                    arr.push({title:"Cluster",id:"cluster_id",type:"select",value:obj.cluster_id,options:G_SELECT["clusters"]});
                                    break;
                                case "region_id":
                                    arr.push({title:"Region",id:"region_id",type:"select",required:true,value:obj.region_id,options:G_SELECT["regions"]});
                                    break;
                                case "dispatcher":
                                    arr.push({title:"Dispatcher",id:"dispatcher",type:"select2",multiple:true,value:obj.dispatcher,options:_userData});
                                    break;
                                default:
                                    break;
                            }
                        });
                        return arr;
                    };

                    var column2Content = `${ALERT.HTML.INFO("This will override the Person In-Charge set in site's region and cluster.","m-0 mb-3",true)}
                                        <div class="panel panel-tab">
                                            <div class="panel-heading">
                                                <h3 class="panel-title">Person In-Charge</h3>
                                                <ul class="nav nav-tabs pull-right">
                                                    <li class="active"><a href="#esc1" data-toggle="tab" aria-expanded="false"><i class="fa fa-user"></i> Escalation 1</a></li>
                                                    <li class=""><a href="#esc2" data-toggle="tab" aria-expanded="true"><i class="fa fa-feed"></i> Escalation 2</a></li>
                                                    <li class=""><a href="#esc3" data-toggle="tab" aria-expanded="false"><i class="fa fa-gear"></i> Escalation 3</a></li>
                                                </ul>
                                            </div>
                                            <div class="panel-body p-0">
                                                <div class="tab-content no-padding">
                                                    <div class="tab-pane fade active in" id="esc1">
                                                        <div class="panel panel-tab" style="border: none;">
                                                            <div class="panel-heading">
                                                                <h3 class="panel-title"></h3>
                                                                <ul class="nav nav-tabs pull-right">
                                                                    <li class="active"><a href="#_esc1-lq_" data-toggle="tab" aria-expanded="false"><i class="fa fa-user"></i>Long Queueing</a></li>
                                                                    <li class=""><a href="#_esc1-oc_" data-toggle="tab" aria-expanded="false"><i class="fa fa-feed"></i> Over CICO</a></li>
                                                                    <li class=""><a href="#_esc1-ot_" data-toggle="tab" aria-expanded="true"><i class="fa fa-gear"></i>Over Transit</a></li>
                                                                </ul>
                                                            </div>
                                                            <div class="panel-body">
                                                                <div class="tab-content no-padding">
                                                                    <div class="tab-pane fade active in" id="_esc1-lq_">
                                                                        <select id="esc1-lq" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                    <div class="tab-pane fade" id="_esc1-oc_">
                                                                    <select id="esc1-oc" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                    <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                    <div class="tab-pane fade" id="_esc1-ot_">
                                                                        <select id="esc1-ot" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="tab-pane fade" id="esc2">
                                                        <div class="panel panel-tab" style="border: none;">
                                                            <div class="panel-heading">
                                                                <h3 class="panel-title"></h3>
                                                                <ul class="nav nav-tabs pull-right">
                                                                    <li class="active"><a href="#_esc2-lq_" data-toggle="tab" aria-expanded="true"><i class="fa fa-user"></i>Long Queueing</a></li>
                                                                    <li class=""><a href="#_esc2-oc_" data-toggle="tab" aria-expanded="true"><i class="fa fa-feed"></i> Over CICO</a></li>
                                                                    <li class=""><a href="#_esc2-ot_" data-toggle="tab" aria-expanded="true"><i class="fa fa-gear"></i>Over Transit</a></li>
                                                                </ul>
                                                            </div>
                                                            <div class="panel-body">
                                                                <div class="tab-content no-padding">
                                                                    <div class="tab-pane fade active in" id="_esc2-lq_">
                                                                        <select id="esc2-lq" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                    <div class="tab-pane fade" id="_esc2-oc_">
                                                                        <select id="esc2-oc" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                    <div class="tab-pane fade" id="_esc2-ot_">
                                                                        <select id="esc2-ot" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="tab-pane fade" id="esc3">
                                                        <div class="panel panel-tab" style="border: none;">
                                                            <div class="panel-heading">
                                                                <h3 class="panel-title"></h3>
                                                                <ul class="nav nav-tabs pull-right">
                                                                    <li class="active"><a href="#_esc3-lq_" data-toggle="tab" aria-expanded="true"><i class="fa fa-user"></i>Long Queueing</a></li>
                                                                    <li class=""><a href="#_esc3-oc_" data-toggle="tab" aria-expanded="true"><i class="fa fa-feed"></i> Over CICO</a></li>
                                                                    <li class=""><a href="#_esc3-ot_" data-toggle="tab" aria-expanded="true"><i class="fa fa-gear"></i>Over Transit</a></li>
                                                                </ul>
                                                            </div>
                                                            <div class="panel-body">
                                                                <div class="tab-content no-padding">
                                                                    <div class="tab-pane fade active in" id="_esc3-lq_">
                                                                        <select id="esc3-lq" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                    <div class="tab-pane fade" id="_esc3-oc_">
                                                                        <select id="esc3-oc" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                    <div class="tab-pane fade" id="_esc3-ot_">
                                                                        <select id="esc3-ot" class="select-multiple-basic" multiple="multiple" style="width:100%;" doNotSave="true"></select>
                                                                        <small class="text-muted">Search by name or username.<br>Press enter key or comma (,) to add value to list.</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>`;

                    $(`body`).append(MODAL.CREATE.BASIC({
                        modalStyle: "width:900px;",
                        title:`Edit Site Data`, 
                        el: modalElements(x.obj),
                        columned:true,
                        column1Style: "col-sm-5",
                        column2Style: "col-sm-7",
                        column2Content,
                    }));

                    var person_in_charge = obj.person_in_charge || {};
                    var options = "";
                    _userData.forEach(op => {
                        options += `<option value="${op.id}" data-subtext="Username: ${op.id}<br>Email: ${op.email||"-"}" data-token-separators="[',']">${op.value || op.id}</option>`;
                    });
                    // clear all
                    //  $(`#esc1-lq,#esc2-lq,#esc3-lq,#esc1-oc,#esc2-oc,#esc3-oc,#esc1-ot,#esc2-ot,#esc3-ot`).val([]).change();
                    $(`#esc1-lq,#esc2-lq,#esc3-lq,#esc1-oc,#esc2-oc,#esc3-oc,#esc1-ot,#esc2-ot,#esc3-ot`).html(options).select2({
                        multiple: true,
                        tokenSeparators: [',', ', '],
                        matcher,
                        templateResult: templateResult
                    });
                    $("#trippage_target").on('keypress', function (e) {
                        return e.metaKey || e.which <= 0 || e.which == 8 || e.which == 46 || /[0-9]/.test(String.fromCharCode(e.which));
                        //      cmd/ctrl ||  arrow keys  ||   delete key ||   dot key     || numbers
                    });
                
                    function populateSelect2(escalation,short,type){
                        if(person_in_charge[escalation]){
                            if(person_in_charge[escalation][type]){
                                var value = person_in_charge[escalation][type] || [];
                                var options = "";
                                _userData.forEach(op => {
                                    var selected = (value.includes(op.id)) ? "selected" : "";
                                    options += `<option value="${op.id}" data-subtext="Username: ${op.id}<br>Email: ${op.email||"-"}" ${selected}>${op.value || op.id}</option>`;
                                });
                                $(`#${short}-${type}`).html(options).select2({
                                    multiple: true,
                                    tokenSeparators: [',', ', '],
                                    matcher,
                                    templateResult: templateResult
                                });
                            }
                        }
                    }
                    populateSelect2("escalation1","esc1","lq");
                    populateSelect2("escalation1","esc1","oc");
                    populateSelect2("escalation1","esc1","ot");
                    populateSelect2("escalation2","esc2","lq");
                    populateSelect2("escalation2","esc2","oc");
                    populateSelect2("escalation2","esc2","ot");
                    populateSelect2("escalation3","esc3","lq");
                    populateSelect2("escalation3","esc3","oc");
                    populateSelect2("escalation3","esc3","ot");
                    
                    $(`#dispatcher`).select2();
                    $(`#cico-hh,#cico-mm`).change(function(){
                        var hh = $(`#cico-hh`).val() || 0,
                            mm = $(`#cico-mm`).val() || 0,
                            dh = Number(DATETIME.DH(null,`${hh}:${mm}`,"0"));
                        $(`#cico`).val(dh);
                    });
                    $(`#region_id`).change(function(){
                        $(`#cluster_id option`).hide();
                        var clusterFiltered = G_SELECT["clusters"].filter(x => x.region_id.toString() == $(this).val()),
                            cluster_id =  $(`#cluster_id`).val(),
                            boolCluster = false;
                        clusterFiltered.forEach(val => {
                            $(`#cluster_id option[value="${val.id}"]`).show();
                            if(cluster_id == val.id.toString()) boolCluster = true;
                        });
                        if(!boolCluster) $(`#cluster_id`).val("");
                    });
                    $(`#cluster_id`).change(function(){
                        var cluster = G_SELECT["clusters"].find(x => x.id.toString() == $(this).val());
                        var region = G_SELECT["regions"].find(x => x.id == cluster.region_id);
                        $(`#region_id`).val(region.id);
                    });
                    
                    MODAL.SUBMIT(x, {id: "short_name",method:"POST",url:`api/geofences/${CLIENT.id}/${USER.username}/short_name/`}, function(){
                        var pic = {
                            escalation1: {
                                lq: $(`#esc1-lq`).val() || [],
                                oc: $(`#esc1-oc`).val() || [],
                                ot: $(`#esc1-ot`).val() || [],
                            },
                            escalation2: {
                                lq: $(`#esc2-lq`).val() || [],
                                oc: $(`#esc2-oc`).val() || [],
                                ot: $(`#esc2-ot`).val() || [],
                            },
                            escalation3: {
                                lq: $(`#esc3-lq`).val() || [],
                                oc: $(`#esc3-oc`).val() || [],
                                ot: $(`#esc3-ot`).val() || [],
                            },
                        };
                        return {
                            person_in_charge: pic
                        };
                    });
                };
        
                /******** TABLE CHECK ********/
                // always put before POPULATE functions
                TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                    if(_userData) {
                        if(LIST[urlPath] && LIST[urlPath].length > 0 && !LIST[urlPath][0]._picUsers && table.dt){
                            table.updateRows(LIST[urlPath]);
                        }
                    }
                    isFinishedLoading(["REGIONS"], _new1_, function(){
                        _new1_ = false;
    
                        if(LIST[urlPath] && LIST[urlPath].length > 0 && !LIST[urlPath][0]._region && table.dt){
                            table.updateRows(LIST[urlPath]);
                        }
                    });
                    isFinishedLoading(["CLUSTERS"], _new2_, function(){
                        _new2_ = false;
    
                        if(LIST[urlPath] && LIST[urlPath].length > 0 && !LIST[urlPath][0]._cluster && table.dt){
                            table.updateRows(LIST[urlPath]);
                        }
                    });
                    isFinishedLoading(["GEOFENCES"], _new3_, function(){
                        _new3_ = false;
    
                        table.initialize();
                        table.populateRows(LIST[urlPath]);
                        table.hideProgressBar();
                    });
                    isFinishedLoading(["REGIONS","CLUSTERS"], true, function(){
                        if(_userData) { 
                            TABLE.FINISH_LOADING.UPDATE();
                        }
                        
                        // regions
                        var regionOptions = `<option value="">&nbsp;</option>`;
                        (LIST["regions"]||[]).forEach(val => {
                            regionOptions += `<option value="${val._id}">${val.code}</option>`;
                        });
                        $(`#_region_id`).html(regionOptions).select2().val(table.filter.region_id || "").trigger("change");

                        // cluster
                        var clusterOptions = `<option value="">&nbsp;</option>`;
                        (LIST["clusters"]||[]).forEach(val => {
                            clusterOptions += `<option value="${val._id}">${val.cluster}</option>`;
                        });
                        $(`#_cluster_id`).html(clusterOptions).select2().val(table.filter.cluster_id || "").trigger("change");
                    });
                }
                /******** END TABLE CHECK ********/
                
                /******** USERS & REGIONS********/
                _USERS_ = {
                    urlPath: "users",
                    populate: function(){
                        var _THIS_ = this;
                        _userData = [];
                        LIST[_THIS_.urlPath].forEach(val => {
                            _userData.push({
                                id: val._id,
                                value: val.name,
                                email: val.email
                            });
                        });
                        _userData = SORT.ARRAY_OBJECT(_userData,"value",{sortType:"asc"});
                        TABLE.FINISH_LOADING.START_CHECK();
                    },
                    fetch: function(){
                        var _THIS_ = this;
                        if(LIST[_THIS_.urlPath]){
                            _USERS_.populate();
                        } else {
                            GET.AJAX({
                                url: `/api/${_THIS_.urlPath}/${CLIENT.id}/${USER.username}/all/${JSON.stringify({})}/0/0`,
                                method: "GET",
                                headers: {
                                    "Authorization": SESSION_TOKEN
                                },
                            }, function(docs){
                                console.log("Users",docs);
                                LIST[_THIS_.urlPath] = LIST[_THIS_.urlPath] || [];
                                docs.forEach(val => {
                                    var index = LIST[_THIS_.urlPath].findIndex(x => x._id == val._id);
                                    if(index > -1){
                                        LIST[_THIS_.urlPath][index] = val;
                                    } else {
                                        val._row = GENERATE.RANDOM(36);
                                        LIST[_THIS_.urlPath].push(val);
                                    }
                                });
                                _USERS_.populate();
                            });
                        }
                    }
                };
                _USERS_.fetch();
                /******** END USERS & REGIONS ********/
        
                TABLE.FINISH_LOADING.START_CHECK(); // always put at the bottom
        
            }
        },
        routes: {
            stream: null,
            init: function(){
                var urlPath = "routes",
                    _new_ = true,  
                    _GEOFENCES_,
                    _geofencesData = null,
                    table = new Table({
                        id: "#tbl-routes",
                        urlPath,
                        goto: "routes",
                        perColumnSearch: true,
                        dataTableOptions: {
                            columns: TABLE.COL_ROW(CUSTOM.COLUMN.routes).column,
                            // sDom: "t" + "<'row'<'col-sm-6'i><'col-sm-6'p>>", // remove all filter container
                            createdRow: function (row, data, dataIndex) {
                                var _row = data._row;
                                $(row).attr(`_row`, data._row);
                                table.rowListeners(_row,data._id);
                            },
                            dom: 'lBrti<"tbl-progress-bar">p',
                        },
                        initializeCallback: function(){
                            TABLE.WATCH({urlPath,rowData:table.addRow,options:function(){TABLE.FINISH_LOADING.START_CHECK();}});
                            if(GGS.STATUS.GEOFENCES){
                                TABLE.FINISH_LOADING.UPDATE();
                            }
                        }
                    });
                table.setButtons({
                    loadView: ["create"],
                    actions:{
                        create: function(){
                            initializeModal({
                                url: `/api/${urlPath}/${CLIENT.id}/${USER.username}`,
                                method: "POST"
                            });
                        },
                    }
                });
                table.addRow = function(obj){
                    new loadInBackground("geofences","GEOFENCES").g_select_settings();

                    const self = this;
                    var action = TABLE.ROW_BUTTONS(PAGE.GET(),{loadView:["edit"],readonlyArr:["edit"]});
                    $(`${self.id} th:last-child`).css({"min-width":action.width,"width":action.width});

                    var origin = (LIST["geofences"]) ? (getGeofence(obj.origin_id) || {}).short_name : `<small class="font-italic text-muted">loading...</small>`;
                    var destination = (LIST["geofences"]) ? (getGeofence(obj.destination_id) || {}).short_name : `<small class="font-italic text-muted">loading...</small>`;
                    
                    (LIST["geofences"]) ? obj._origin = origin : null;
                    (LIST["geofences"]) ? obj._destination = destination : null;
        
                    return TABLE.COL_ROW(null,{
                        '_id': obj._id,
                        '_row':  obj._row,
                        'Origin': obj._origin || origin || "-",
                        'Destination': obj._destination || destination || "-",
                        'Transit Time': DATETIME.HH_MM(null,obj.transit_time).hour_minute,
                        'Action': action.buttons,
                    }).row;
                };
                table.rowListeners = function(_row,_id){
                    const self = this;
                    TABLE.ROW_LISTENER({table_id:self.id,_row,urlPath,_id,initializeModal});
                };

                var initializeModal = function(x){
                    new loadInBackground("geofences","GEOFENCES").g_select_settings();

                    var title = (x.method == "PUT") ? `Edit Route Data` : `Create New Route`,
                        modalElements = function(obj){
                            var disabled = (obj) ? true : false;
                            obj = obj || {};
                            var finalOptions = G_SELECT["geofences"].filter(x => x.code);
                            return [
                                {title:"Origin",id:"origin_id",type:"select2",multiple:false,required:true,value:obj.origin_id,options:finalOptions,disabled,sub_title:"Site Code is required for site to apper in the options"},
                                {title:"Destination",id:"destination_id",type:"select2",multiple:false,required:true,value:obj.destination_id,options:finalOptions,disabled,sub_title:"Site Code is required for site to apper in the options"},
                                {title:"Route",id:"_id",type:"text",required:true,value:obj._id,readonly:true},
                                {title:"Transit Time (HH:MM)",id:"transit_time",type:"time",required:true,value:obj.transit_time},
                            ];
                        };
                    $(`body`).append(MODAL.CREATE.BASIC({title, el: modalElements(x.obj)}));
                    $(`#origin_id,#destination_id`).select2().change(function(){
                        var origin_id = $(`#origin_id`).val(),
                            destination_id = $(`#destination_id`).val(),
                            originGeofence = G_SELECT["geofences"].find(x => x.id == origin_id) || {},
                            destinationGeofence = G_SELECT["geofences"].find(x => x.id == destination_id) || {};
                        $(`#_id`).val(`${originGeofence.code||""}${clientCustom.originDestinationSeparator}${destinationGeofence.code||""}`);
                    }).trigger("change");
                    $(`#transit_time-hh,#transit_time-mm`).change(function(){
                        var hh = $(`#transit_time-hh`).val() || 0,
                            mm = $(`#transit_time-mm`).val() || 0,
                            dh = Number(DATETIME.DH(null,`${hh}:${mm}`,"0"));
                        $(`#transit_time`).val(dh);
                    });
                    
                    MODAL.SUBMIT(x);
                };

                /******** TABLE CHECK ********/
                TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                    isFinishedLoading(["ROUTES"], _new_, function(){
                        _new_ = false;
                        table.initialize();
                        table.populateRows(LIST[urlPath]);
                        table.hideProgressBar();
                    });
                    isFinishedLoading(["GEOFENCES"], true, function(){
                        if(LIST[urlPath].length > 0 && !LIST[urlPath][0]._origin && table.dt){
                            table.updateRows(LIST[urlPath]);
                        }
                        TABLE.FINISH_LOADING.UPDATE();
                    });
                }
                /******** END TABLE CHECK ********/

                /******** GEOFENCES ********/
                _GEOFENCES_ = {
                    urlPath: "geofences",
                    populate: function(){
                        var _THIS_ = this;
                        _geofencesData = [];
                        LIST[_THIS_.urlPath].forEach(val => {
                            if(val.code){
                                _geofencesData.push({
                                    id: val._id,
                                    value: val.short_name,
                                    code: val.code
                                });
                            }
                        });
                        _geofencesData = SORT.ARRAY_OBJECT(_geofencesData,"value",{sortType:"asc"});
                        TABLE.FINISH_LOADING.START_CHECK();
                    }
                };
                /******** END GEOFENCES ********/
                TABLE.FINISH_LOADING.START_CHECK();
                /******** END TABLE CHECK ********/
            }
        }
    }
};
var VEHICLES = {
    STATUS: [
        {id:"Available",desc:"Working vehicle."},
        {id:"For Restoration (WRU)",desc:"WRU has been informed that the device is offline and has to be restored."},
        {id:"Standby",desc:"Working vehicle but not used."},
        {id:"Preventive Maintenance",desc:"Vehicle undergoing rehabilitation work."},
        {id:"Truck Breakdown",desc:"Vehicle is under repair."},
    ],
    FUNCTION: {
        init: function(){
            var urlPath = "vehicles",
                _new_ = true,  
                _new1_ = true,  
                table = new Table({
                    id: "#tbl-vehicles",
                    urlPath,
                    goto: "vehicles",
                    dataTableOptions: {
                        columns: TABLE.COL_ROW(CUSTOM.COLUMN.vehicles()).column,
                        order: clientCustom.columnOrder.vehicles,
                        createdRow: function (row, data, dataIndex) {
                            var _row = data._row;
                            $(row).attr(`_row`, data._row);

                            table.rowListeners(_row,data._id);
                        },
                        dom: 'lBfrti<"tbl-progress-bar">p',
                    },
                    initializeCallback: function(){
                        TABLE.WATCH({urlPath,rowData:table.addRow,options:function(){TABLE.FINISH_LOADING.START_CHECK();}});
                    }
                });
            table.setButtons({
                actions:{
                    data_maintenance: function(){
                        var ID = CLIENT.id;
                        var USERNAME = USER.username;
                        var ROLE = USER.role;
                        var modalHTML = modalViews.vehicles.data_maintenance();
                        var initializeArray = [
                            { urlPath: "vehicles_section", key: "section", objectData: (_id) => { return getVehiclesSection(_id); } },
                            { urlPath: "vehicles_company", key: "company", objectData: (_id) => { return getVehiclesCompany(_id); } },
                        ];
                        HISTORY.defaults.data_maintenance(ID,USERNAME,ROLE,SESSION_TOKEN,modalHTML,initializeArray);
                    }
                }
            });
            table.addRow = function(obj){
                const self = this;
                var action = TABLE.ROW_BUTTONS(PAGE.GET(),{loadView:["edit","view"],readonlyArr:["edit","view"]}),
                    status = VEHICLES.STATUS.find(x => x.id == (obj.Availability||"")) || {value:"Available"};
                $(`${self.id} th:last-child`).css({"min-width":action.width,"width":action.width});

                var vehiclesHistory = getVehicleHistory(obj._id) || {};
                var location = vehiclesHistory.location || [],
                    loc0 = location[location.length-2],
                    loc1 = location[location.length-1],
                    lastLocHTML = "";
                // location
                if(loc1){
                    var timestamp = loc1.events[loc1.events.length-1].timestamp;
                    lastLocHTML += `<div><i class="la la-map-marker text-muted font-16"></i>${loc1.short_name} (2)<small class="text-muted ml-2">[${DATETIME.FORMAT(timestamp,"MM/DD/YYYY hh:mm A")}]</small></div>`;
                }
                if(loc0){
                    var timestamp = loc0.events[loc0.events.length-1].timestamp;
                    lastLocHTML += `<div><i class="la la-map-marker text-muted font-16"></i>${loc0.short_name} (1)<small class="text-muted ml-2">[${DATETIME.FORMAT(timestamp,"MM/DD/YYYY hh:mm A")}]</small></div>`;
                }
                // end location

                if(obj["Site"]){
                    if($(`#_site`).find(`option[value='${obj["Site"]}']`).length == 0){
                        $(`#_site`).append(`<option value="${obj["Site"]}">${obj["Site"]}</option>`);
                    }
                }
                
                var section = (LIST["vehicles_section"]) ? (getVehiclesSection(obj.section_id) || {}).section : `<small class="font-italic text-muted">loading...</small>`;
                var company = (LIST["vehicles_company"]) ? (getVehiclesCompany(obj.company_id) || {}).company : `<small class="font-italic text-muted">loading...</small>`;
    
                return TABLE.COL_ROW(null,{
                    '_id': obj._id,
                    '_row':  obj._row,
                    'Name': obj.name || "-",
                    'Plate Number': obj["Plate Number"] || "-",
                    'Trailer': obj["Trailer"] || "-",
                    'Equipment Number': obj["Equipment Number"] || "-",
                    'Conduction Number': obj["Tractor Conduction"] || "-",
                    'Truck Number': obj["Truck Number"] || "-",
                    'Truck Type': obj.truck_type || "-",
                    'Site': obj["Site"] || "-",
                    'CN1': obj["CN1"] || "-",
                    'CN2': obj["CN2"] || "-",
                    'Fuel Capacity': obj["Fuel Capacity"] || "-",
                    'Truck Model': obj["Truck Model"] || "-",
                    'Section': section || "-",
                    'Company': company || "-",
                    'Body Type': obj.body_type || "-",
                    'Year Model': obj.year_model || "-",
                    'Registration Month': obj.registration_month || "-",
                    'Registration Status': obj.registration_status || "-",
                    'Case Number': obj.case_number || "-",
                    'LTFRB Status': obj.ltfrb_status || "-",
                    'Issued Date': DATETIME.FORMAT(obj.issued_date,"MMM DD, YYYY"),
                    'Expiry Date': DATETIME.FORMAT(obj.expiry_date,"MMM DD, YYYY"),
                    'Availability': obj.Availability||"Available",
                    'Last 2 Locations': lastLocHTML || "-",
                    'Action': action.buttons,
                }).row;
            };
            table.rowListeners = function(_row,_id){
                const self = this;
                TABLE.ROW_LISTENER({table_id:self.id,_row,urlPath,_id,
                    editCallback: function(){
                        // LOAD SELECT 2 OPTIONS FOR: ORIGIN,DESTINATION,VEHICLES
                        getSelect2Options();

                        var obj = LIST[self.urlPath].find(x => x._id == _id) || {};

                        if(clientCustom.modalFields.vehicles == "custom"){
                            if(CLIENT.id == "wilcon"){
                                $(`body`).append(modalViews.vehicles.create[CLIENT.id](obj));
                                // adjust modal height
                                $('.modal-body-content').css('height',($('body').innerHeight()-200)+'px');

                                $(`#section_id`).html(G_SELECT2["form-vehicles_section"]).select2().val(obj.section_id || "").trigger("change");
                                $(`#company_id`).html(G_SELECT2["form-vehicles_company"]).select2().val(obj.company_id || "").trigger("change");

                                /*********** DATES ***********/
                                // Issued Date & Expiry Date
                                $(`#issued_date,#expiry_date`).datepicker({
                                    maxViewMode: 2,
                                    autoclose: true,
                                    todayHighlight: true,
                                    format: "mm/dd/yyyy",
                                }).on("changeDate",function (e) {}).attr("onkeydown","event.preventDefault()");
                    
                                (obj.issued_date) ? $(`#issued_date`).datepicker("setDate",new Date(obj.issued_date)) : null;
                                (obj.expiry_date) ? $(`#expiry_date`).datepicker("setDate",new Date(obj.expiry_date)) : null;

                                // Registration Month
                                $(`#registration_month`).datepicker({
                                    minViewMode: 1,
                                    autoclose: true,
                                    todayHighlight: true,
                                    format: "MM",
                                }).on("changeDate",function (e) {}).attr("onkeydown","event.preventDefault()");
                                (obj.registration_month) ? $(`#registration_month`).datepicker("setDate",new Date(`${obj.registration_month} 1, 2021`)) : null;

                                // Year Model
                                $(`#year_model`).datepicker({
                                    minViewMode: 2,
                                    autoclose: true,
                                    todayHighlight: true,
                                    format: "yyyy",
                                }).on("changeDate",function (e) {}).attr("onkeydown","event.preventDefault()");
                                (obj.year_model) ? $(`#year_model`).datepicker("setDate",new Date(obj.year_model)) : null;
                                /*********** END DATES ***********/

                                ATTACHMENTSV2.initialize("#lto-attachments","#lto_attachments");
                                ATTACHMENTSV2.initialize("#ltfrb-attachments","#ltfrb_attachments");

                                ATTACHMENTSV2.set("#lto_attachments",obj.lto_attachments);
                                ATTACHMENTSV2.set("#ltfrb_attachments",obj.ltfrb_attachments);

                                $(`#submit`).click(function(){
                                    $(`#submit`).html('<i class="la la-spin la-spinner"></i> Submit').attr("disabled",true);

                                    var body = {
                                        truck_type: $(`#truck_type`).val(),
                                        body_type: $(`#body_type`).val(),
                                        year_model: $(`#year_model`).val(),
                                        section_id: $(`#section_id`).val(),
                                        company_id: $(`#company_id`).val(),
                                        registration_month: $(`#registration_month`).val(),
                                        registration_status: $(`#registration_status`).val(),
                                        case_number: $(`#case_number`).val(),
                                        ltfrb_status: $(`#ltfrb_status`).val(),
                                        issued_date: $(`#issued_date`).val(),
                                        expiry_date: $(`#expiry_date`).val(),
                                        lto_attachments: ATTACHMENTSV2.get("#lto_attachments",CLIENT.dsName),
                                        ltfrb_attachments: ATTACHMENTSV2.get("#ltfrb_attachments",CLIENT.dsName),
                                    },
                                    historyOptions = {
                                        excludeKeys: ["history"],
                                        fields: [
                                            {
                                                key: "section_id",
                                                customTitle: "Section",
                                                dataExtended: true,
                                                data: LIST["vehicles_section"],
                                                dataCompareKey: "_id",
                                                dataValueKey: "section"
                                            },
                                            {
                                                key: "company_id",
                                                customTitle: "Company",
                                                dataExtended: true,
                                                data: LIST["vehicles_company"],
                                                dataCompareKey: "_id",
                                                dataValueKey: "company"
                                            },
                                            {
                                                key: "ltfrb_status",
                                                customTitle: "LTFRB Status"
                                            },
                                            {
                                                key: "lto_attachments",
                                                customTitle: "LTO Attachments",
                                                type: "attachments"
                                            },
                                            {
                                                key: "ltfrb_attachments",
                                                customTitle: "LTFRB Attachments",
                                                type: "attachments"
                                            },
                                        ]
                                    };

                                    body = HISTORY.check(obj,body,USER.username,historyOptions);
                                    console.log("body",body);
                                    $.ajax({
                                        url: `/api/${table.urlPath}/${CLIENT.id}/${USER.username}/${_id}`,
                                        method: "put",
                                        timeout: 90000, // 1 minute and 30 seconds
                                        headers: {
                                            "Content-Type": "application/json; charset=utf-8",
                                            "Authorization": SESSION_TOKEN
                                        },
                                        async: true,
                                        data: JSON.stringify(body)
                                    }).done(function (result) {
                                        TOASTR.UPDATEDSUCCESSFULLY();
                                        $(`#overlay`).remove();
                                    }).fail(function(error) {
                                        console.log("Error",error);
                                        $('#modal-error').html(ALERT.HTML.ERROR("An error has occured. Please try again.",true));
                                        $("html, body,.modal-body-content").animate({ scrollTop: 0 }, "fast");
                                        $(`#submit`).html('Submit').attr("disabled",false);
                                    });
                                });
                            }
                        } else {
                            var title = `Edit Vehicle Details`,
                                modalElements = function(){
                                    var arr = [];
                                    clientCustom.modalFields.vehicles.forEach(val => {
                                        switch (val) {
                                            case "Trailer":
                                                arr.push({title:"Trailer",id:"Trailer",type:"select2",attr:"blankStringIfEmpty"});
                                                break;
                                            case "truck_type":
                                                arr.push({ title:"Truck Type", id:"truck_type", type:"text", value: obj.truck_type||""});
                                                break;
                                            case "section_id":
                                                arr.push({ title:"Section", id:"section_id", type:"select2"});
                                                break;
                                            case "company_id":
                                                arr.push({title:"Company",id:"company_id",type:"select2"});
                                                break;
                                            case "Availability":
                                                arr.push({title:"Availability",id:"Availability",type:"select",value:obj.Availability,options:VEHICLES.STATUS,noDefault:true});
                                                break;
                                            case "desc":
                                                arr.push({title:"Description",id:"desc",type:"textarea",disabled:true,notInclude:true});
                                                break;
                                            default:
                                                break;
                                        }
                                    });
                                    return arr;
                                };
                            $(`body`).append(MODAL.CREATE.BASIC({title, el: modalElements()}));
                            $(`#Availability`).change(function(){
                                var option = VEHICLES.STATUS.find(x => x.id == $(this).val()) || {desc:""};
                                $(`#desc`).val(option.desc);
                            }).trigger("change");
    
                            $(`#Trailer`).html(G_SELECT2["form-trailers"]).select2({
                                matcher: matcher,
                                templateResult: templateResult
                            }).val(obj["Trailer"] || "").trigger("change");
                            
                            $(`#section_id`).html(G_SELECT2["form-vehicles_section"]).select2().val(obj.section_id || "").trigger("change");
                            $(`#company_id`).html(G_SELECT2["form-vehicles_company"]).select2().val(obj.company_id || "").trigger("change");
    
                            var ggsUpdate = {
                                object: [],
                                ggsURL:`https://${CLIENT.ggsURL}/comGpsGate/api/v.1/batch/applications/${CLIENT.appId}/users/${_id}/customfields`
                            };
                            clientCustom.modalFields.vehicles.forEach(val => {
                                switch (val) {
                                    case "Trailer":
                                        ggsUpdate.object.push({name:"Trailer",el:"#Trailer option:selected"});
                                        break;
                                    case "Availability":
                                        ggsUpdate.object.push({name:"Availability",el:"#Availability option:selected"});
                                        break;
                                    default:
                                        break;
                                }
                            });
    
                            MODAL.SUBMIT({
                                method:"PUT",
                                url:`/api/${self.urlPath}/${CLIENT.id}/${USER.username}/${_id}`,
                            },ggsUpdate);
                        }
                    },
                });
            };
            table.filterListener = function(){
                const self = this;
                var filter = USER.filters.vehicles || {};
                try {
                    filter = JSON.parse(USER.filters.vehicles);
                } catch(error){ }

                if(filter.site && filter.site != "All"){
                    $(`#filter-container`).toggle("slide", {direction:'right'},100);
                    setTimeout(function(){
                        $(`#_site`).val(filter.site);
                        $(`#filter-btn`).trigger("click");
                    },100);
                }
                
                function saveFilter(_filter_){
                    if(filter.site != _filter_.site){
                        var data = {};
                        data[`filter.vehicles`] = JSON.stringify(_filter_);
                        GET.AJAX({
                            url: `/api/users/${CLIENT.id}/${USER.username}/${USER.username}`,
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8",
                                "Authorization": SESSION_TOKEN
                            },
                            data: JSON.stringify(data)
                        }, function(docs){
                            console.log("docs1",docs);
                            self.dt.column(4).search(_filter_.site).draw(false);
                            USER.filters.vehicles = _filter_;
                            filter.site = _filter_.site;
                            $(`#filter-btn`).html("Apply").removeClass("disabled");
                        });
                    } else {
                        self.dt.column(4).search(_filter_.site).draw(false);
                        $(`#filter-btn`).html("Apply").removeClass("disabled");
                    }
                }
                $(`#filter-btn`).click(function(){
                    $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");
                    var _site = ($(`#_site`).val() == "All") ? "" : $(`#_site`).val();

                    saveFilter({site: _site});
                });
                $(`#reset-btn`).click(function(){
                    $(`#_site`).val("All");
                    $(`#filter-btn`).trigger("click");
                });
            };

            /******** TABLE CHECK ********/
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                isFinishedLoading(["VEHICLES"], _new_, function(){
                    _new_ = false;
                    table.initialize();
                    table.populateRows(LIST[urlPath]);
                    table.hideProgressBar();
                });
                isFinishedLoading(["TRAILERS","VEHICLES_SECTION","VEHICLES_COMPANY","VEHICLES_HISTORY"], _new1_, function(){
                    if((LIST[urlPath]||[]).length > 0 && table.dt && _new1_){
                        _new1_ = false;
                        table.updateRows(LIST[urlPath]);
                    }
                });
                isFinishedLoading(["TRAILERS","VEHICLES_SECTION","VEHICLES_COMPANY","VEHICLES_HISTORY"], true, function(){
                    TABLE.FINISH_LOADING.UPDATE();
                });
            }
            TABLE.FINISH_LOADING.START_CHECK();
            /******** END TABLE CHECK ********/
        }
    }
};
var VEHICLE_PERSONNEL = {
    FUNCTION: {
        init: function(){
            var urlPath = "vehicle_personnel",
                _new_ = true,  
                _new1_ = true,  
                table = new Table({
                    id: "#tbl-vehicle_personnel",
                    urlPath,
                    goto: "vehicle_personnel",
                    dataTableOptions: {
                        columns: TABLE.COL_ROW(CUSTOM.COLUMN.vehicle_personnel).column,
                        order: [[ 3, "asc" ]],
                        createdRow: function (row, data, dataIndex) {
                            var _row = data._row;
                            $(row).attr(`_row`, data._row);

                            table.rowListeners(_row,data._id);
                        },
                        dom: 'lBfrti<"tbl-progress-bar">p',
                    },
                    initializeCallback: function(){
                        TABLE.WATCH({urlPath,rowData:table.addRow,options:function(){TABLE.FINISH_LOADING.START_CHECK();}});
                    }
                });
            table.setButtons({
                loadView: ["create"],
                actions:{
                    create: function(){
                        initializeModal({
                            url: `/api/${urlPath}/${CLIENT.id}/${USER.username}`,
                            method: "POST"
                        });
                    },
                    data_maintenance: function(){
                        var ID = CLIENT.id;
                        var USERNAME = USER.username;
                        var ROLE = USER.role;
                        var modalHTML = modalViews.vehicle_personnel.data_maintenance();
                        var initializeArray = [
                            { urlPath: "vehicle_personnel_section", key: "section", objectData: (_id) => { return getVehiclePersonnelSection(_id); } },
                            { urlPath: "vehicle_personnel_company", key: "company", objectData: (_id) => { return getVehiclePersonnelCompany(_id); } },
                        ];
                        HISTORY.defaults.data_maintenance(ID,USERNAME,ROLE,SESSION_TOKEN,modalHTML,initializeArray);
                    }
                }
            });
            table.addRow = function(obj){
                const self = this;
                var action = TABLE.ROW_BUTTONS(PAGE.GET(),{
                    loadView:["edit"],
                    readonlyArr:["edit"],
                    deleteArr:[
                        { button: "edit-rest-days", byPassCondition: (obj.occupation!="Driver" && obj.occupation!="Checker" && obj.occupation!="Helper") },
                    ]
                });
                $(`${self.id} th:last-child`).css({"min-width":action.width,"width":action.width});

                var vehicle = (LIST["vehicles"]) ? (getVehicle(obj.vehicle_id) || {}).name : `<small class="font-italic text-muted">loading...</small>`;
                var section = (LIST["vehicle_personnel_section"]) ? (getVehiclePersonnelSection(obj.section_id) || {}).section : `<small class="font-italic text-muted">loading...</small>`;
                var company = (LIST["vehicle_personnel_company"]) ? (getVehiclePersonnelCompany(obj.company_id) || {}).company : `<small class="font-italic text-muted">loading...</small>`;

                return TABLE.COL_ROW(null,{
                    '_id': obj._id,
                    '_row':  obj._row,
                    'Name': obj.name || "-",
                    'Occupation': obj.occupation || "-",
                    'Vehicle': vehicle || "-",
                    'Section': section || "-",
                    'Company': company || "-",
                    'Action': action.buttons,
                }).row;
            };
            table.rowListeners = function(_row,_id){
                const self = this;
                TABLE.ROW_LISTENER({table_id:table.id,_row,urlPath,_id,initializeModal,
                    additionalListeners: function(){
                        $(table.id).on('click', `[_row="${_row}"] [edit-rest-days],[_row="${_row}"] + tr.child [edit-rest-days]`,function(e){
                            e.stopImmediatePropagation();
                            $(`body`).append(modalViews.vehicle_personnel.rest_days(_id));
                            $("html, body,#modal").animate({ scrollTop: 0 }, "fast");

                            var obj = LIST["vehicle_personnel"].find(x => x._id.toString() == _id.toString()) || {};

                            var calendarValue = {};

                            /********** CALENDAR TYPE **********/
                            $(`#calendar_type`).change(function(){
                                var calendarType = $(this).val();
                                
                                $(`#inline-calendar`).data('daterangepicker').setDates(calendarValue[calendarType]||[]);

                                // console.log("calendarValue",calendarValue)
                                if(calendarType == "_rest_days"){
                                    $(`#recurring`).parent().parent().show();
                                    if(calendarValue[calendarType].length == 0){
                                        $(`#recurring`).attr("disabled",true);
                                        $(`#recurring`).parent().parent().addClass("text-muted").css({"pointer-events":"none"});
                                    } else {
                                        $(`#recurring`).attr("disabled",false);
                                        $(`#recurring`).parent().parent().removeClass("text-muted").css({"pointer-events":""});
                                    }
                                } else {
                                    $(`#recurring`).parent().parent().hide();
                                }
                            });
                            /********** END CALENDAR TYPE **********/


                            /********** INLINE CALENDAR **********/
                            $(`#inline-calendar`).daterangepicker({
                                multipleDates: true,
                                showSingleCalendar: true,
                                displayAsInlineCalendar: true,
                                alwaysShowCalendars: true,
                                customStyle: {
                                    width: "268px",
                                    adjustTop: 40
                                },
                                parentEl: $(`#inline-calendar`).parent(),
                                isInvalidDate: function(ele) {
                                    var currDate = moment(ele._d).format('YY-MM-DD');
                                    var calendarType = $(`#calendar_type`).val();
                                    var otherCalendarDates = [];
                                    Object.keys(calendarValue).forEach(key => {
                                        if(key != calendarType){
                                            (calendarValue[key]||[]).forEach(val => {
                                                otherCalendarDates.push(moment(val).format('YY-MM-DD'));
                                            });
                                        }
                                    });
                                    return otherCalendarDates.indexOf(currDate) != -1;
                                }
                            }).on('apply.daterangepicker', function(ev,picker){
                                var calendarType = $(`#calendar_type`).val();
                                calendarValue[calendarType] = $(`#inline-calendar`).data('daterangepicker').getDates(); 

                                if(calendarType == "_rest_days"){
                                    if(calendarValue[calendarType].length == 0){
                                        $(`#recurring`).attr("disabled",true);
                                        $(`#recurring`).parent().parent().addClass("text-muted").css({"pointer-events":"none"});
                                    } else {
                                        $(`#recurring`).attr("disabled",false);
                                        $(`#recurring`).parent().parent().removeClass("text-muted").css({"pointer-events":""});
                                    }
                                }
                            });
                            
                            // open the calendar after initialization
                            $('#inline-calendar').trigger('click');
                            /********** END INLINE CALENDAR **********/


                            /********** RECURRING **********/
                            $(`#recurring`).change(function(){
                                var arr = [];
                                var firstDate = $(`#inline-calendar`).data('daterangepicker').getDates()[0];
                                if(firstDate){
                                    arr.push(new Date(firstDate));

                                    if($(this).is(":checked")){
                                        var nextDate = null;

                                        function addPerWeek(){
                                            nextDate = moment(new Date(nextDate||firstDate)).add(7,"day").format("MM/DD/YYYY");
                                            arr.push(new Date(nextDate));
                                        }
                                        var recurringWeeks = 29; // total of 30 (included firstDate)
                                        for(var i = 0; i < recurringWeeks; i++){
                                            addPerWeek();
                                        }
                                    }
                                
                                    $(`#inline-calendar`).data('daterangepicker').setDates(arr);
                                }
                            });
                            /********** END RECURRING **********/


                            /********** OBJECT DATA INITIALIZATION **********/
                            // add this after datepicker is initialized 
                            $(`#recurring`).prop("checked",obj.recurring||false);

                            var dates = obj.dates || {};
                            $(`#calendar_type option`).each((i,el) => {
                                var calendarType = $(el).val();
                                var key = calendarType.substring(1);

                                var arrDates = [];
                                (dates[key]||[]).forEach(val => { arrDates.push(new Date(val)); });
                                calendarValue[calendarType] = arrDates;
                            });
                            $(`#calendar_type`).trigger("change");
                            /********** END OBJECT DATA INITIALIZATION **********/


                            /********** SUBMIT **********/
                            $(`#submit`).click(function(){
                                var body = {
                                    recurring: $('#recurring').is(":checked"),
                                    dates: {}
                                };
                                Object.keys(calendarValue).forEach(key => {
                                    var new_key = key.substring(1);
                                    var values = (calendarValue[key]||[]).map(d => moment(d).startOf("day").toISOString());
                                    body.dates[new_key] = values;
                                });

                                $(`#submit`).html(`<i class="la la-spin la-spinner"></i> Submit`).attr("disabled",true);
                                GET.AJAX({
                                    url: `/api/${urlPath}/${CLIENT.id}/${USER.username}/${_id}`,
                                    method: "PUT",
                                    headers: {
                                        "Content-Type": "application/json; charset=utf-8",
                                        "Authorization": SESSION_TOKEN
                                    },
                                    data: JSON.stringify(body)
                                }, function(docs){
                                    $(`.daterangepicker`).hide();
                                    $(`#overlay`).remove();
                                    TOASTR.UPDATEDSUCCESSFULLY();
                                });
                            });
                            /********** END SUBMIT **********/
                        });
                    }
                });
            };
            table.filterListener = function(){
                const self = this;
                var filter = USER.filters.vehicles || {};
                try {
                    filter = JSON.parse(USER.filters.vehicles);
                } catch(error){ }

                if(filter.site && filter.site != "All"){
                    $(`#filter-container`).toggle("slide", {direction:'right'},100);
                    setTimeout(function(){
                        $(`#_site`).val(filter.site);
                        $(`#filter-btn`).trigger("click");
                    },100);
                }
                
                function saveFilter(_filter_){
                    if(filter.site != _filter_.site){
                        var data = {};
                        data[`filter.vehicles`] = JSON.stringify(_filter_);
                        GET.AJAX({
                            url: `/api/users/${CLIENT.id}/${USER.username}/${USER.username}`,
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8",
                                "Authorization": SESSION_TOKEN
                            },
                            data: JSON.stringify(data)
                        }, function(docs){
                            console.log("docs1",docs);
                            self.dt.column(4).search(_filter_.site).draw(false);
                            USER.filters.vehicles = _filter_;
                            filter.site = _filter_.site;
                            $(`#filter-btn`).html("Apply").removeClass("disabled");
                        });
                    } else {
                        self.dt.column(4).search(_filter_.site).draw(false);
                        $(`#filter-btn`).html("Apply").removeClass("disabled");
                    }
                }
                $(`#filter-btn`).click(function(){
                    $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");
                    var _site = ($(`#_site`).val() == "All") ? "" : $(`#_site`).val();

                    saveFilter({site: _site});
                });
                $(`#reset-btn`).click(function(){
                    $(`#_site`).val("All");
                    $(`#filter-btn`).trigger("click");
                });
            };

            var initializeModal = function(x={}){
                // LOAD SELECT 2 OPTIONS FOR: VEHICLES
                getSelect2Options();
                x.obj = x.obj || {};
                
                var title = (x.method == "PUT") ? `Edit Personnel Data` : `Create New Vehicle Personnel`,
                    modalElements = function(obj){
                        //  Name, Occupation, Vehicle, ID number
                        var occupationOptions = [{
                            id: "Driver",
                            value: "Driver"
                        },{
                            id: "Checker",
                            value: "Checker"
                        },{
                            id: "Helper",
                            value: "Helper"
                        }]
                        return [
                            {title:"Name",id:"name",type:"text",required:true,value:obj.name},
                            {title:"Occupation",id:"occupation",type:"select",required:true,value:obj.occupation,options:occupationOptions},
                            {title:"Vehicle",id:"vehicle_id",type:"select2",attr:"blankStringIfEmpty"},
                            {title:"Section",id:"section_id",type:"select2",attr:"blankStringIfEmpty"},
                            {title:"Company",id:"company_id",type:"select2",attr:"blankStringIfEmpty"},
                            // {title:"ID number",id:"id_number",type:"text",required:true,value:obj.id_number},
                        ];
                    };
                $(`body`).append(MODAL.CREATE.BASIC({title, el: modalElements(x.obj)}));
                
                
                $(`#vehicle_id`).html(G_SELECT2["form-vehicles"]).select2({
                    matcher: matcher,
                    templateResult: templateResult
                }).val(x.obj.vehicle_id || "").trigger("change");

                $(`#section_id`).html(G_SELECT2["form-vehicle_personnel_section"]).select2().val(x.obj.section_id || "").trigger("change");
                $(`#company_id`).html(G_SELECT2["form-vehicle_personnel_company"]).select2().val(x.obj.company_id || "").trigger("change");

                MODAL.SUBMIT(x);
            };

            /******** TABLE CHECK ********/
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                isFinishedLoading(["VEHICLE_PERSONNEL"], _new_, function(){
                    _new_ = false;
                    table.initialize();
                    table.populateRows(LIST[urlPath]);
                    table.hideProgressBar();
                });
                isFinishedLoading(["VEHICLES","VEHICLE_PERSONNEL_SECTION","VEHICLE_PERSONNEL_COMPANY"], _new1_, function(){
                    if((LIST[urlPath]||[]).length > 0 && table.dt){
                        _new1_ = false;
                        table.updateRows(LIST[urlPath]);
                    }
                });
                isFinishedLoading(["VEHICLES","VEHICLE_PERSONNEL_SECTION","VEHICLE_PERSONNEL_COMPANY"], true, function(){
                    TABLE.FINISH_LOADING.UPDATE();
                });
            }
            TABLE.FINISH_LOADING.START_CHECK();
            /******** END TABLE CHECK ********/
        }
    }
};
var FUEL_REFILL = {
    xlsxHTML: `<span style="background-color: #00a548;border-radius: 2px;padding: 1px 2px;color: white;font-size: 9px;font-weight: bold;margin-right: 3px;letter-spacing: 1px;">XLSX</span>`,
    xmlHTML: `<span style="background-color: gray;border-radius: 2px;padding: 1px 2px;color: white;font-size: 9px;font-weight: bold;margin-right: 3px;letter-spacing: 1px;">XML</span>`,
    aStyle: `overflow: hidden;text-overflow: ellipsis;display: block;white-space: nowrap;margin-bottom:4px;`,
    FUNCTION: {
        init: function(){
            var urlPath = "fuel_refill",
                _new_ = true,
                table = new Table({
                    id: "#tbl-fuel_refill",
                    urlPath,
                    goto: "fuel_refill",
                    dataTableOptions: {
                        columns: TABLE.COL_ROW(CUSTOM.COLUMN.fuel_refill).column,
                        order: [[ 4, "desc" ]],
                        createdRow: function (row, data, dataIndex) {
                            var _row = data._row;
                            $(row).attr(`_row`, data._row);
                            $(row).children(':nth-child(2)').attr("style",`white-space: nowrap; text-overflow:ellipsis; overflow: hidden; max-width:1px;`);
                            $(row).children(':nth-child(3)').attr("style",`white-space: nowrap; text-overflow:ellipsis; overflow: hidden; max-width:1px;`);
                            $(row).children(':nth-child(4)').attr("style",`white-space: nowrap; text-overflow:ellipsis; overflow: hidden; max-width:1px;`);

                            table.rowListeners(_row,data._id);
                        },
                        dom: 'lBfrti<"tbl-progress-bar">p',
                    },
                    initializeCallback: function(){
                        TABLE.WATCH({urlPath,rowData:table.addRow,options:function(){TABLE.FINISH_LOADING.START_CHECK();}});
                    }
                });
            table.setButtons({
                loadView: ["import"],
                actions:{
                    import: function(){
                        $(`body`).append(MODAL.CREATE.EMPTY(`Import Batch File`,modalViews.fuel_refill.import()));
                        FUEL_REFILL.FUNCTION.import({});
                        PAGE.TOOLTIP();
                    },
                }
            });
            table.addRow = function(obj){
                const self = this;
                var action = TABLE.ROW_BUTTONS(PAGE.GET());
                $(`${self.id} th:last-child`).css({"min-width":action.width,"width":action.width});

                var created_by = (LIST["users"]) ? (getUser(obj.created_by) || {}).name : `<small class="font-italic text-muted">loading...</small>`;
    
                var style = `style="width: 100%;${FUEL_REFILL.aStyle}"`;
                
                var successfulxlsx = null;
                var successfulxml = null;
                var failedImportxlsx = null;
                var failedImportxml = null;
                var errorxlsx = null;

                (obj.attachments||[]).forEach(val => {
                    if((val.options||{}).type == "successful-xlsx") successfulxlsx = val;
                    if((val.options||{}).type == "successful-xml") successfulxml = val;
                    if((val.options||{}).type == "failedImport-xlsx") failedImportxlsx = val;
                    if((val.options||{}).type == "failedImport-xml") failedImportxml = val;
                    if((val.options||{}).type == "error-xlsx") errorxlsx = val;
                });

                return TABLE.COL_ROW(null,{
                    '_id': obj._id,
                    '_row':  obj._row,
                    'Summary':  `<div>Successful: <b style="text-decoration: underline;">${obj.success_count||"0"}</b></div><div>Failed to Import: <b style="text-decoration: underline;">${obj.fail_import_count||"0"}</b></div><div>Error/No Match: <b style="text-decoration: underline;">${obj.error_count||"0"}</b></div>`,
                    'Converted': (successfulxlsx) ? 
                                `<a href="${successfulxlsx.url}" normaldownload ${style}>${FUEL_REFILL.xlsxHTML}${successfulxlsx.filename}</a>
                                 <a href="javascript:void(0);" src="${successfulxml.url}" filename="${successfulxml.filename}" downloadxml ${style}>${FUEL_REFILL.xmlHTML}${successfulxml.filename}</a>`: ``,
                    'Failed to Import': (failedImportxlsx) ? 
                                        `<a href="${failedImportxlsx.url}" normaldownload ${style}>${FUEL_REFILL.xlsxHTML}${failedImportxlsx.filename}</a>
                                         <a href="javascript:void(0);" src="${failedImportxml.url}" filename="${failedImportxml.filename}" downloadxml ${style}>${FUEL_REFILL.xmlHTML}${failedImportxml.filename}</a>` : ``,
                    'Error': (errorxlsx) ? `<a href="${errorxlsx.url}" normaldownload ${style}>${FUEL_REFILL.xlsxHTML}${errorxlsx.filename}</a>` : ``,
                    'Upload Date':  DATETIME.FORMAT(obj.created_on),
                    'Uploaded By': created_by || "-",
                    'Action': action.buttons,
                }).row;
            };
            table.rowListeners = function(_row,_id){
                const self = this;

                TABLE.ROW_LISTENER({table_id:self.id,_row,urlPath,_id});
                function xmlToString(xmlData) { 

                    var xmlString;
                    //IE
                    if (window.ActiveXObject){
                        xmlString = xmlData.xml;
                    }
                    // code for Mozilla, Firefox, Opera, etc.
                    else{
                        xmlString = (new XMLSerializer()).serializeToString(xmlData);
                    }
                    return xmlString;
                }   
                $(table.id).on('click', `[_row="${_row}"] [normaldownload]`,function(e){
                    e.stopImmediatePropagation();
                    toastr.success("Download success!");
                });

                $(table.id).on('click', `[_row="${_row}"] [downloadxml]`,function(e){
                    e.stopImmediatePropagation();
                    var src = $(this).attr("src");
                    var filename = $(this).attr("filename");
                    var mytoast = toastr.info("Downloading..");
                    
                    $.ajax({
                        type: "get",
                        url: src,
                        dataType: "xml",
                        crossDomain: true,
                        success: function(data) {
                            $(mytoast).removeClass("toast-info").addClass("toast-success");
                            $(mytoast).children('.toast-message').html("Download success!");

                            const xmlString = xmlToString(data);
                            var blob = new Blob([xmlString], {type: "text/xml"});
                            saveAs(blob, filename);
                        },
                        error: function(xhr, status) {
                            console.log(status,xhr);
                            $(mytoast).removeClass("toast-info").addClass("toast-error");
                            $(mytoast).children('.toast-message').html("Download failed.");
                        }
                    });
                });
            };
            table.initialize();
            table.countRows();
            

            /******** TABLE CHECK ********/
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                isFinishedLoading(["USERS"], _new_, function(){
                    if((LIST[urlPath]||[]).length > 0 && table.dt && _new_){
                        _new_ = false;
                        table.updateRows(LIST[urlPath]);
                    }
                });
                isFinishedLoading(["VEHICLES"], true, function(){
                    TABLE.FINISH_LOADING.UPDATE();
                });
            }
            TABLE.FINISH_LOADING.START_CHECK();
            /******** END TABLE CHECK ********/
        },
        import: function(){
            $(`#download-template-btn`).click(function(){
                $(`body`).append(CUSTOM.IMPORT_TEMPLATE.fuel_refill.fleet());
                exportTableToExcel("Fuel Refill Import Template");
                
                $(`#report-hidden,#temp-link,[data-SheetName]`).remove();
            });

            var fileExtension = ["xls","xlsx","ods"];
            $('.dropify').dropify();
            $(`.dropify`).change(function(){
                $(`#import-btn`).attr("disabled",false);
                $(`#reportSuccessfulList,#reportErrorList,#reportImportFailureList`).html(`<div class="text-muted font-italic">No link available.</div>`);
            });
            $(`#import-btn`).click(function(){
                $(this).html(`<i class="la la-spinner la-spin mr-2"></i>Import`).attr("disabled",true);
                $(`.dropify-wrapper`).css("pointer-events","none");
                read(`.dropify`);
            }).attr("disabled",true);

            var requiredFields = {
                fleet: [
                    { name: "Delivery Date", required: true, error: ["Date is not valid."]  },
                    { name: "Time", required: true, error: ["Time is not valid."] },
                    { name: "Quantity", key: "Volume", required: true },
                    { name: "Vehicle License Number", required: true },
                    { name: "VehicleID", required: false },
                    { name: "TimeStamp", required: false },
                    { name: "Volume", required: false },
                ],
            };

            var listChildEl = `#reportImportFailureList .text-muted.font-italic,#reportSuccessfulList .text-muted.font-italic,#reportErrorList .text-muted.font-italic`;
            
            function read(el){
                $(listChildEl).html("Reading file...");
                var ext = $(el).val().split('.').pop().toLowerCase();
                
                console.log(fileExtension,ext);
                if(fileExtension.includes(ext) == true){
                    var reader = new FileReader();
                    reader.onload = function () {
                        var result = reader.result;
                        // console.log(result);
                        var workbook = XLSX.read(result, { type: 'binary' }),
                            XL_row_object = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[workbook.SheetNames[0]],{defval: ""}),
                            finalRowObject = [];

                        $.each(XL_row_object, function(key,value){
                            // XL_row_object[key].key = GENERATE.RANDOM(36);
                            var hasValue = false;
                            requiredFields[CLIENT.id].forEach(_val_ => {
                                if(XL_row_object[key][_val_.name]){
                                    hasValue = true;
                                }
                            });
                            if(hasValue === true){
                                finalRowObject.push(XL_row_object[key]);
                            }
                        });
                        console.log("finalRowObject",finalRowObject)
                        convert(finalRowObject,$(el)[0].files[0].name);
                    };
                    // start reading the file. When it is done, calls the onload event defined above.
                    ($(el)[0].files.length > 0) ? reader.readAsBinaryString($(el)[0].files[0]) : console.log("No file selected.");
                } else {
                    toastr.error(`Only ${fileExtension.join(", ")} files are allowed.`);
                    
                    $(`#import-btn`).html(`Import`).attr("disabled",false);
                    $(`.dropify-wrapper`).css("pointer-events","");
                    $(`.dropify-clear`).click();
                }
            }
            function convert(import_data,filename){
                $(listChildEl).html("Converting file...");
                filename = filename.split('.').slice(0, -1).join('.');

                var errorList = {},
                    warningList = {},
                    importData = [],
                    errorData = [],
                    parseDateExcel = (excelTimestamp) => {
                        const secondsInDay = 24 * 60 * 60;
                        const excelEpoch = new Date(1899, 11, 31);
                        const excelEpochAsUnixTimestamp = excelEpoch.getTime();
                        const missingLeapYearDay = secondsInDay * 1000;
                        const delta = excelEpochAsUnixTimestamp - missingLeapYearDay;
                        const excelTimestampAsUnixTimestamp = excelTimestamp * secondsInDay * 1000;
                        const parsed = excelTimestampAsUnixTimestamp + delta;
                        return isNaN(parsed) ? null : parsed;
                    };
                
                if(import_data.length > 0){
                    console.log(import_data)
                    if(import_data[0]["VehicleID"] != undefined && import_data[0]["TimeStamp"] != undefined && import_data[0]["Volume"] != undefined) {
                        importData = import_data;
                    } else {
                        import_data.forEach((val,i) => {
                            var license_number = val["Vehicle License Number"],
                                username = (LIST["vehicles"].find(x => x.CN1 == license_number || x.CN2 == license_number || x.name == license_number)||{}).username,
                                delivery_date = DATETIME.FORMAT(parseDateExcel(val["Delivery Date"]),"MM/DD/YYYY"),
                                delivery_time = moment(new Date(parseDateExcel(val["Time"]))).format("H:mm:ss"),
                                errorShipment = false,
                                identifierKey = val.__rowNum__;
    
                            var obj = {
                                    "VehicleID": "",
                                    "TimeStamp": "",
                                    "Volume": ""
                                },
                                addToNoteList = function(text,causes,key,type,isField){
                                    key = key || (Number(val.__rowNum__) + 1);
                                    if(type == "error"){
                                        var causesHTML = (causes) ? `<ul level=2><li>${causes.join("</li><li>")}</li></ul>` : "";
                                        (errorList[key]) ? errorList[key].push(text+causesHTML) : errorList[key] = [(text+causesHTML)];
                                        errorShipment = true;
                                    } 
                                    if(type == "warning"){
                                        var causesHTML = (causes) ? `<ul level=2><li>${causes.join("</li><li>")}</li></ul>` : "";
                                        text = (isField === true) ? `<small class="text-muted">[FIELD NOT SAVED]</small> ${text}` : text;
                                        (warningList[key]) ? warningList[key].push(text+causesHTML) : warningList[key] = [(text+causesHTML)];
                                    }
                                };
                                
                            if((val.__rowNum__).toString()._trim()){
                                requiredFields[CLIENT.id].forEach(_val_ => {
                                    if((val[_val_.name]||"").toString()._trim()){
                                        // okay
                                        if(_val_.key){
                                            obj[_val_.key] = val[_val_.name].toString()._trim();
                                        } else {
                                            deepChecking(_val_.name,_val_.error);
                                        }
                                    } else {
                                        if(_val_.required === true){
                                            // error
                                            addToNoteList(`Missing data in '${_val_.name}'. `,null,val[identifierKey],"error");
                                        } else {
                                            if(_val_.codependent){
                                                if(val[_val_.codependent]){
                                                    // error
                                                    addToNoteList(`Missing data in '${_val_.name}'. `,null,val[identifierKey],"warning");
                                                } else {
                                                    // okay. no error
                                                    obj[_val_.key] = "";
                                                }
                                            }
                                        }
                                    }
                                });
                            } else {
                                addToNoteList(`Missing data in '${identifierKey}'.`,null,val[identifierKey],"error");
                            }
                            
                            function deepChecking(columnKey,error){
                                if(columnKey == "Vehicle License Number"){
                                    if(username){
                                        obj["VehicleID"] = username;
                                    } else {
                                        addToNoteList(`Missing data in '${columnKey}'. `,null,val[identifierKey],"error");
                                    }
                                }
    
                                if(columnKey == "Delivery Date"){
                                    var momentDeliveryDate = moment(delivery_date, 'MM/DD/YYYY', true);
                                    var formattedDeliveryDate = momentDeliveryDate.format("MM/DD/YYYY");
                                    if(momentDeliveryDate.isValid()){
                                        if(moment(delivery_time, 'H:mm:ss', true).isValid()){
                                            // Remove the milliseconds and 'Z'
                                            // Original: 2021-06-18T16:08:26.000Z
                                            // Output: 2021-06-18T16:08:26
                                            obj["TimeStamp"] = new Date(`${formattedDeliveryDate}, ${delivery_time}`).toISOString().split('.')[0];
                                        }
                                    } else {
                                        addToNoteList(`Invalid data in '${columnKey}'.  Possible causes:`,error,val[identifierKey],"error",true);
                                    }
                                }
    
                                if(columnKey == "Time"){
                                    if(moment(delivery_time, 'H:mm:ss', true).isValid()){
                                        var momentDeliveryDate = moment(delivery_date, 'MM/DD/YYYY', true);
                                        var formattedDeliveryDate = momentDeliveryDate.format("MM/DD/YYYY");
                                        if(momentDeliveryDate.isValid()){
                                            // Remove the milliseconds and 'Z'
                                            // Original: 2021-06-18T16:08:26.000Z
                                            // Output: 2021-06-18T16:08:26
                                            obj["TimeStamp"] = new Date(`${formattedDeliveryDate}, ${delivery_time}`).toISOString().split('.')[0];
                                        }
                                    } else {
                                        addToNoteList(`Invalid data in '${columnKey}'.  Possible causes:`,error,val[identifierKey],"error",true);
                                    }
                                }
                            }
    
                            // importData.push(obj);
                            if(errorShipment === false){
                                importData.push(obj); // merged
                            } else {
                                delete val.__rowNum__;
                                val["Delivery Date"] = delivery_date;
                                val["Time"] = delivery_time;
                                errorData.push(val);
                            }
    
                        });
                        console.log("errorList",errorList);
                        console.log("LENGTH: "+importData.length);
                        console.log("final",importData);
                    }

                    exportFiles(importData,errorData,filename);
                } else {
                    toastr.error("Invalid file. Please download or follow the excel template provided.");
                    $('.dropify-clear').click();
                    $('.dropify-wrapper').css("pointer-events","");
                    $(`#import-btn`).html("Import").attr("disabled",true);
                }
            }
            function exportFiles(importData,errorData,filename){
                function json_to_sheet_to_base64(arr,filename){
                    /* make the worksheet */
                    var ws = XLSX.utils.json_to_sheet(arr);

                    /* add to workbook */
                    var wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

                    /* generate an XLSX file */
                    // XLSX.writeFile(wb, "sheetjs.xlsx");
                    
                    /* generate XLSX as array buffer */
                    var bufferArray = XLSX.write(wb, {bookType: 'xlsx', type: 'array'});
                    return {
                        // add comma(",") before base64, refer to storage.js (_storage.upload === var base64 = (val.base64||"").split(',')[1];)
                        base64: ","+btoa([].reduce.call(new Uint8Array(bufferArray),function(p,c){return p+String.fromCharCode(c)},'')),
                        filename,
                        wb
                    }
                }
                function json_to_xml_to_base64(arr,rawFilename,filename){
                    var refills = [];
                    arr.forEach(val => {
                        refills.push(`          <Refill>\n` +
                                     `               <VehicleID>${val["VehicleID"]}</VehicleID>\n`+
                                     `               <TimeStamp>${val["TimeStamp"]}</TimeStamp>\n`+
                                     `               <Volume>${val["Volume"]}</Volume>\n`+
                                     `          </Refill>\n`);
                    });
                    // note!! do not change spacing.
                    var xml =   `<?xml version="1.0" encoding="utf-8"?>\n` +
                                `<Fuel fileid="${rawFilename}">\n` +
                                `     <Refills>\n` +
                                        refills.join("") +
                                `     </Refills>\n` + 
                                `</Fuel>`;

                    var base64 = "";
                    if (!("TextEncoder" in window)) alert("Sorry, this browser does not support TextEncoder...");
                    else {
                        var enc = new TextEncoder(); // always utf-8
                        base64 = ","+btoa([].reduce.call(enc.encode(xml),function(p,c){return p+String.fromCharCode(c)},''));
                    }

                    return {
                        base64,
                        save: function(){
                            var blob = new Blob([xml], {type: "text/xml"});
                            saveAs(blob, filename);
                        },
                        filename,

                    }
                }

                var tempImportData = JSON.parse(JSON.stringify(importData));

                var successfulData = [];
                var errorValidTemplate = [];
                var countAjax = 0;
                var tries = 0;

                $(listChildEl).html("Importing data to WRU Main...");
                function callAjax(obj) {
                    var userId = (LIST["vehicles"].find(x => x.username == obj["VehicleID"])||{})._id;
                    if(userId){
                        // import to main
                        $.ajax({
                            url: `https://${CLIENT.ggsURL}/comGpsGate/api/v.1/applications/${CLIENT.appId}/users/${userId}/fuelconsumption`,
                            method: "post", 
                            timeout: 90000 ,
                            headers: {
                                "Content-Type": "application/json; charset=utf-8",
                                "Authorization": USER.apiKey
                            },
                            data: JSON.stringify({
                                "id": 0, // automatically set by WRU Main
                                "userId": Number(userId),
                                "refilledOn": obj["TimeStamp"],
                                "volume": obj["Volume"]
                            }),
                            async: true
                        }).done(()=>{
                            successfulData.push(obj);
                            doneAjax();
                        }).fail(()=>{
                            errorValidTemplate.push(obj);
                            doneAjax();
                        });
                    } else {
                        console.log("obj",obj)
                    }
                }
                tempImportData.forEach(val => { callAjax(val); });

                function doneAjax(){
                    $(listChildEl).html(`Importing data to WRU Main (${successfulData.length}/${importData.length})...`);
                    countAjax++;
                    if(tempImportData.length == countAjax){
                        if(errorValidTemplate.length > 0){
                            tries++;
                            // retry to import the errors for 5 times.
                            if(tries < 5){
                                countAjax = 0;
                                tempImportData = JSON.parse(JSON.stringify(errorValidTemplate));
                                errorValidTemplate = [];
                                tempImportData.forEach(val => {
                                    callAjax(val);
                                });
                            } else {
                                console.log("DONE TRYING AFTER " + tries + " TRIES.");
                                uploadToDatabase();
                            }
                        } else {
                            // no errors in importing
                            uploadToDatabase();
                        }
                    }
                }

                function uploadToDatabase(){
                    var attachments = [];

                    function addLink(listId,arr,filename,finalFilename,optionType,hasXML,attachOnly){
                        var xlsx = json_to_sheet_to_base64(arr,`${finalFilename}.xlsx`);
                        var xml = json_to_xml_to_base64(arr,filename,`${finalFilename}.xml`);

                        if(!attachOnly && arr.length > 0){
                            var xmlHTML = (hasXML) ? `<div style="display: table-row;">
                                                        <div style="display: table-cell;"></div>
                                                        <a href="javascript:void(0);" style="display: table-cell;${FUEL_REFILL.aStyle}width:330px;" xml>${FUEL_REFILL.xmlHTML}${xml.filename}</a>
                                                    </div>` : "";
                            $(listId).html(`
                            <div style="display: table;">
                                <div style="display: table-row;">
                                    <b style="display: table-cell;" class="pr-2">(${arr.length} rows)</b>
                                    <a href="javascript:void(0);" style="display: table-cell;padding-bottom: 3px;${FUEL_REFILL.aStyle}width:330px;" xlsx>${FUEL_REFILL.xlsxHTML}${xlsx.filename}</a>
                                </div>
                                ${xmlHTML}
                            </div>
                            `);
                            $(`${listId} a[xlsx]`).click(function(){
                            XLSX.writeFile(xlsx.wb, xlsx.filename);
                            });
                            $(`${listId} a[xml]`).click(function(){
                            xml.save();
                            });
                        } else {
                            $(`${listId} .text-muted.font-italic`).html("No link available.")
                        }
                        

                        if(arr.length > 0){
                            attachments.push({ 
                                base64: xlsx.base64, 
                                filename: xlsx.filename, 
                                storageFilename: `attachments/<INSERT_ID_HERE>/${xlsx.filename}`,
                                url: `https://storage.googleapis.com/${CLIENT.dsName}/`,
                                options: {
                                    type: optionType.xlsx
                                }
                            });
                            if(hasXML){
                                attachments.push({ 
                                    base64: xml.base64, 
                                    filename: xml.filename, 
                                    storageFilename: `attachments/<INSERT_ID_HERE>/${xml.filename}`,
                                    url: `https://storage.googleapis.com/${CLIENT.dsName}/`,
                                    options: {
                                        type: optionType.xml
                                    }
                                });
                            }
                        }
                    }
                    addLink("#reportImportFailureList",errorValidTemplate,filename,`[Converted_Error] ${filename}`,{ xlsx: "failedImport-xlsx", xml: "failedImport-xml" },true); 
                    addLink(undefined,successfulData,filename,`[Converted] ${filename}`,{ xlsx: "successful-xlsx", xml: "successful-xml" },true,true);  
                    addLink(undefined,errorData,filename,`[Error] ${filename}`,{ xlsx: "error-xlsx" },false,true);  

                    $(`#reportSuccessfulList .text-muted.font-italic,#reportErrorList .text-muted.font-italic`).html("Uploading files to database...");

                    $.ajax({ 
                        url: `/api/fuel_refill/${CLIENT.id}/${USER.username}`, 
                        method: "post", 
                        timeout: 90000 ,
                        headers: {
                            "Content-Type": "application/json; charset=utf-8",
                            "Authorization": SESSION_TOKEN
                        },
                        data: JSON.stringify({
                            _id: GENERATE.RANDOM(36),
                            attachments,
                            success_count: successfulData.length,
                            fail_import_count: errorValidTemplate.length,
                            error_count: errorData.length
                        }),
                        async: true
                    }).done(function (docs) {
                        addLink("#reportSuccessfulList",successfulData,filename,`[Converted] ${filename}`,{ xlsx: "successful-xlsx", xml: "successful-xml" },true);  
                        addLink("#reportErrorList",errorData,filename,`[Error] ${filename}`,{ xlsx: "error-xlsx" },false);  

                        if(docs.ok == 1){
                            toastr.success("Download links are now available.");
                            $('.dropify-clear').click();
                            $('.dropify-wrapper').css("pointer-events","");
                            $(`#import-btn`).html("Import").attr("disabled",true);
                        } else {
                            TOASTR.ERROR(docs);
                            $('.dropify-clear').click();
                            $('.dropify-wrapper').css("pointer-events","");
                            $(`#import-btn`).html("Import").attr("disabled",true);
                        }
                    }).fail(function(error){
                        TOASTR.ERROR(error);
                        $('.dropify-clear').click();
                        $('.dropify-wrapper').css("pointer-events","");
                        $(`#import-btn`).html("Import").attr("disabled",true);
                    });
                }
            }
        }
    }
};
var TRAILERS = {
    FUNCTION: {
        init: function(){
            var urlPath = "trailers",
                _new_ = true,  
                table = new Table({
                    id: "#tbl-trailers",
                    urlPath,
                    goto: "trailers",
                    dataTableOptions: {
                        columns: TABLE.COL_ROW(CUSTOM.COLUMN.trailers).column,
                        order: [[ 4, "asc" ]],
                        createdRow: function (row, data, dataIndex) {
                            var _row = data._row;
                            $(row).attr(`_row`, data._row);

                            table.rowListeners(_row,data._id);
                        },
                        dom: 'lBfrti<"tbl-progress-bar">p',
                    },
                    initializeCallback: function(){
                        // TABLE.WATCH({urlPath,rowData:table.addRow,options:function(){TABLE.FINISH_LOADING.START_CHECK();}});
                    }
                });
            table.setButtons({
                loadView: ["create"],
                actions:{
                    create: function(){ 
                        initializeModal({
                            url: `/api/${urlPath}/${CLIENT.id}/${USER.username}`,
                            method: "POST"
                        });
                        },
                }
            });
            table.addRow = function(obj){
                const self = this;
                var action = TABLE.ROW_BUTTONS(PAGE.GET());
                $(`${self.id} th:last-child`).css({"min-width":action.width,"width":action.width});
    
                if(obj.site){
                    if($(`#_site`).find(`option[value='${obj.site}']`).length == 0){
                        $(`#_site`).append(`<option value="${obj.site}">${obj.site}</option>`);
                    }
                }

                return TABLE.COL_ROW(null,{
                    '_row':  obj._row,
                    '_id': obj._id,
                    'Pal Cap': obj.pal_cap || "-",
                    'Region': obj.region || "-",
                    'Cluster': obj.cluster || "-",
                    'Site': obj.site || "-",
                    'Action': action.buttons,
                }).row;
            };
            table.rowListeners = function(_row,_id){
                const self = this;
                TABLE.ROW_LISTENER({table_id:self.id,_row,urlPath,_id,initializeModal});
            };
            table.filterListener = function(){
                const self = this;
                var filter = USER.filters.trailers || {};
                try {
                    filter = JSON.parse(USER.filters.trailers);
                } catch(error){ }

                if(filter.site && filter.site != "All"){
                    $(`#filter-container`).toggle("slide", {direction:'right'},100);
                    setTimeout(function(){
                        $(`#_site`).val(filter.site);
                        $(`#filter-btn`).trigger("click");
                    },100);
                }
                
                function saveFilter(_filter_){
                    if(filter.site != _filter_.site){
                        var data = {};
                        data[`filter.trailers`] = JSON.stringify(_filter_);
                        GET.AJAX({
                            url: `/api/users/${CLIENT.id}/${USER.username}/${USER.username}`,
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8",
                                "Authorization": SESSION_TOKEN
                            },
                            data: JSON.stringify(data)
                        }, function(docs){
                            console.log("docs1",docs);
                            self.dt.column(4).search(_filter_.site).draw(false);
                            USER.filters.trailers = _filter_;
                            filter.site = _filter_.site;
                            $(`#filter-btn`).html("Apply").removeClass("disabled");
                        });
                    } else {
                        self.dt.column(4).search(_filter_.site).draw(false);
                        $(`#filter-btn`).html("Apply").removeClass("disabled");
                    }
                }
                $(`#filter-btn`).click(function(){
                    $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");
                    var _site = ($(`#_site`).val() == "All") ? "" : $(`#_site`).val();

                    saveFilter({site: _site});
                });
                $(`#reset-btn`).click(function(){
                    $(`#_site`).val("All");
                    $(`#filter-btn`).trigger("click");
                });
            };

            var initializeModal = function(x){
                var title = (x.method == "PUT") ? `Edit Trailer Data` : `Create New Trailer`,
                    modalElements = function(obj){
                        var readonly = (x.method == "PUT") ? true : false;
                        obj = obj || {};
                        return [
                            {title:"Trailer",id:"_id",type:"text",required:true,value:obj._id,readonly,sub_title:"Once saved, trailer cannot be edited."},
                            {title:"Pal Cap",id:"pal_cap",type:"text",required:true,value:obj.pal_cap},
                            {title:"Region",id:"region",type:"text",required:true,value:obj.region},
                            {title:"Cluster",id:"cluster",type:"text",required:true,value:obj.cluster},
                            {title:"Site",id:"site",type:"text",required:true,value:obj.site},
                        ];
                    };
                $(`body`).append(MODAL.CREATE.BASIC({title, el: modalElements(x.obj)}));
                MODAL.SUBMIT(x);
            };

            /******** TABLE CHECK ********/
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                isFinishedLoading(["TRAILERS"], _new_, function(){
                    _new_ = false;
                    table.initialize();
                    table.populateRows(LIST[urlPath]);
                    table.hideProgressBar();
                    TABLE.FINISH_LOADING.UPDATE(); 
                });
            }
            TABLE.FINISH_LOADING.START_CHECK();
            /******** END TABLE CHECK ********/
        }
    }
};
var CHASSIS = {
    FUNCTION: {
        init: function(){
            var urlPath = "chassis",
                _new_ = true,  
                _new1_ = true,  
                table = new Table({
                    id: "#tbl-chassis",
                    urlPath,
                    goto: "chassis",
                    dataTableOptions: {
                        columns: TABLE.COL_ROW(CUSTOM.COLUMN.chassis).column,
                        order: [[ 3, "asc" ]],
                        createdRow: function (row, data, dataIndex) {
                            var _row = data._row;
                            $(row).attr(`_row`, data._row);

                            table.rowListeners(_row,data._id);
                        },
                        dom: 'lBfrti<"tbl-progress-bar">p',
                    },
                    initializeCallback: function(){
                        TABLE.WATCH({urlPath,rowData:table.addRow,options:function(){TABLE.FINISH_LOADING.START_CHECK();}});
                    }
                });
            table.setButtons({
                loadView: ["create"],
                actions:{
                    create: function(){
                        initializeModal({
                            url: `/api/${urlPath}/${CLIENT.id}/${USER.username}`,
                            method: "POST"
                        });
                    },
                    data_maintenance: function(){
                        var ID = CLIENT.id;
                        var USERNAME = USER.username;
                        var ROLE = USER.role;
                        var modalHTML = modalViews.chassis.data_maintenance();
                        var initializeArray = [
                            { urlPath: "chassis_section", key: "section", objectData: (_id) => { return getChassisSection(_id); } },
                            { urlPath: "chassis_company", key: "company", objectData: (_id) => { return getChassisCompany(_id); } },
                            { urlPath: "chassis_type", key: "type", objectData: (_id) => { return getChassisType(_id); } },
                        ];
                        HISTORY.defaults.data_maintenance(ID,USERNAME,ROLE,SESSION_TOKEN,modalHTML,initializeArray);
                    }
                }
            });
            table.addRow = function(obj){
                const self = this;
                var action = TABLE.ROW_BUTTONS(PAGE.GET(),{
                    loadView:["edit"],
                    readonlyArr:["edit"],
                });
                $(`${self.id} th:last-child`).css({"min-width":action.width,"width":action.width});

                var vehicle = (LIST["vehicles"]) ? (getVehicle(obj.vehicle_id) || {})["Plate Number"] : `<small class="font-italic text-muted">loading...</small>`;
                var section = (LIST["chassis_section"]) ? (getChassisSection(obj.section_id) || {}).section : `<small class="font-italic text-muted">loading...</small>`;
                var company = (LIST["chassis_company"]) ? (getChassisCompany(obj.company_id) || {}).company : `<small class="font-italic text-muted">loading...</small>`;
                var type = (LIST["chassis_type"]) ? (getChassisType(obj.type_id) || {}).type : `<small class="font-italic text-muted">loading...</small>`;

                return TABLE.COL_ROW(null,{
                    '_id': obj._id,
                    '_row':  obj._row,
                    'Name': obj.name || "-",
                    'Chassis Type': type || "-",
                    'Plate Number': vehicle || "-",
                    'Section': section || "-",
                    'Company': company || "-",
                    'Action': action.buttons,
                }).row;
            };
            table.rowListeners = function(_row,_id){
                const self = this;
                TABLE.ROW_LISTENER({table_id:table.id,_row,urlPath,_id,initializeModal});
            };
            table.filterListener = function(){
                const self = this;
                var filter = USER.filters.vehicles || {};
                try {
                    filter = JSON.parse(USER.filters.vehicles);
                } catch(error){ }

                if(filter.site && filter.site != "All"){
                    $(`#filter-container`).toggle("slide", {direction:'right'},100);
                    setTimeout(function(){
                        $(`#_site`).val(filter.site);
                        $(`#filter-btn`).trigger("click");
                    },100);
                }
                
                function saveFilter(_filter_){
                    if(filter.site != _filter_.site){
                        var data = {};
                        data[`filter.vehicles`] = JSON.stringify(_filter_);
                        GET.AJAX({
                            url: `/api/users/${CLIENT.id}/${USER.username}/${USER.username}`,
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json; charset=utf-8",
                                "Authorization": SESSION_TOKEN
                            },
                            data: JSON.stringify(data)
                        }, function(docs){
                            console.log("docs1",docs);
                            self.dt.column(4).search(_filter_.site).draw(false);
                            USER.filters.vehicles = _filter_;
                            filter.site = _filter_.site;
                            $(`#filter-btn`).html("Apply").removeClass("disabled");
                        });
                    } else {
                        self.dt.column(4).search(_filter_.site).draw(false);
                        $(`#filter-btn`).html("Apply").removeClass("disabled");
                    }
                }
                $(`#filter-btn`).click(function(){
                    $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");
                    var _site = ($(`#_site`).val() == "All") ? "" : $(`#_site`).val();

                    saveFilter({site: _site});
                });
                $(`#reset-btn`).click(function(){
                    $(`#_site`).val("All");
                    $(`#filter-btn`).trigger("click");
                });
            };

            var initializeModal = function(x={}){
                // LOAD SELECT 2 OPTIONS FOR: VEHICLES
                getSelect2Options();
                x.obj = x.obj || {};
                
                var title = (x.method == "PUT") ? `Edit Chassis` : `Create New Chassis`,
                    modalElements = function(obj){
                        var readonly = x.method == "PUT";
                        return [
                            {title:"Name",id:"_id",type:"text",required:true,value:obj._id,readonly,sub_title:"Once saved, name cannot be edited."},
                            {title:"Chassis Type",id:"type_id",type:"select2",required:true,attr:"blankStringIfEmpty"},
                            {title:"Vehicle",id:"vehicle_id",type:"select2",attr:"blankStringIfEmpty"},
                            {title:"Section",id:"section_id",type:"select2",attr:"blankStringIfEmpty"},
                            {title:"Company",id:"company_id",type:"select2",attr:"blankStringIfEmpty"},
                        ];
                    };
                $(`body`).append(MODAL.CREATE.BASIC({title, el: modalElements(x.obj)}));
                
                
                $(`#vehicle_id`).html(G_SELECT2["form-vehicles"]).select2({
                    matcher: matcher,
                    templateResult: templateResult
                }).val(x.obj.vehicle_id || "").trigger("change");

                $(`#type_id`).html(G_SELECT2["form-chassis_type"]).select2().val(x.obj.type_id || "").trigger("change");
                $(`#section_id`).html(G_SELECT2["form-chassis_section"]).select2().val(x.obj.section_id || "").trigger("change");
                $(`#company_id`).html(G_SELECT2["form-chassis_company"]).select2().val(x.obj.company_id || "").trigger("change");

                /**
                 Section
                 60e54a78eeaae10734c5be1a - Importation
                 60e54a7beeaae10734c5be1b - local shiping
                 60e54a80eeaae10734c5be1c - base to base
                 60e54a83eeaae10734c5be1d - he movilasdas...

                 Company
                 60e54a90eeaae10734c5be22 - SADC
                 60e54a94eeaae10734c5be23 - MOVEEASY

                 Type
                 60e549062cad040e0c2cf2fe - flatbed
                 60e5490a2cad040e0c2cf2ff - lowbed
                 60e5490e2cad040e0c2cf300 - alum..
                 60e549142cad040e0c2cf301 - trailer van
                 60e549192cad040e0c2cf302 - ske 1x20
                 60e5491e2cad040e0c2cf303 - ske 1x40
                 */

                MODAL.SUBMIT(x);
            };

            /******** TABLE CHECK ********/
            TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
                isFinishedLoading(["CHASSIS"], _new_, function(){
                    _new_ = false;
                    table.initialize();
                    table.populateRows(LIST[urlPath]);
                    table.hideProgressBar();
                });
                isFinishedLoading(["VEHICLES","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE"], _new1_, function(){
                    if((LIST[urlPath]||[]).length > 0 && table.dt){
                        _new1_ = false;
                        table.updateRows(LIST[urlPath]);
                    }
                });
                isFinishedLoading(["CHASSIS","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE"], true, function(){
                    TABLE.FINISH_LOADING.UPDATE();
                });
            }
            TABLE.FINISH_LOADING.START_CHECK();
            /******** END TABLE CHECK ********/
        }
    }
};
var CALENDAR = {
    init: function(){
        PAGE.DISPLAY();

        /* initialize the calendar
        -----------------------------------------------------------------*/

        var calendar = $('#calendar').fullCalendar({
            header: {
                left: 'agendaDay,agendaWeek,month ',
                center: 'title',
                right: 'today prev,next'
            },
            eventClick: function(info) {
                console.log('Event: ', info);
            },
            eventRender: function(event, element) {
                console.log("event",event)
                element.find(".fc-event-inner").append("<span class='closeon float-right'><i class='la la-times'></i></span>");
                element.find(".closeon").click(function() {
                    var text = (event.eventType == "holiday") ? "National Holiday" : "Custom Event";
                    MODAL.CONFIRMATION({
                        content: `Are you sure you want to delete this ${text}?<br><br><b>${event.title}</b>`,
                        confirmCloseCondition: true,
                        confirmCallback: function(){
                            $('#calendar').fullCalendar('removeEvents', event._id);
                            $(`#confirm-modal,#overlay`).remove(); 
                        },
                        cancelCallback: function(){
                            $(`#modal #submit`).html(`Submit`).attr("disabled",false);
                        }
                    });
                });
            },
            editable: true,
            firstDay: 0, //  1(Monday) this can be changed to 0(Sunday) for the USA system
            selectable: true,
            defaultView: 'month',

            axisFormat: 'h:mm',
            columnFormat: {
                month: 'ddd', // Mon
                week: 'ddd d', // Mon 7
                day: 'dddd M/d', // Monday 9/7
                agendaDay: 'dddd d'
            },
            titleFormat: {
                month: 'MMMM yyyy', // September 2009
                week: "MMMM yyyy", // September 2009
                day: 'MMMM yyyy' // Tuesday, Sep 8, 2009
            },
            allDaySlot: false,
            selectHelper: true,
            select: function(start, end, allDay) {
                var title = prompt('Event Title:');
                if (title) {
                    calendar.fullCalendar('renderEvent', {
                            title: title,
                            start: start,
                            end: end,
                            allDay: allDay
                        },
                        true // make the event "stick"
                    );
                }
                calendar.fullCalendar('unselect');
            },
            droppable: true, // this allows things to be dropped onto the calendar !!!
            drop: function(date, allDay) { // this function is called when something is dropped

                // retrieve the dropped element's stored Event Object
                var originalEventObject = $(this).data('eventObject');

                // we need to copy it, so that multiple events don't have a reference to the same object
                var copiedEventObject = $.extend({}, originalEventObject);

                // assign it the date that was reported
                copiedEventObject.start = date;
                copiedEventObject.allDay = allDay;

                // render the event on the calendar
                // the last `true` argument determines if the event "sticks" (http://arshaw.com/fullcalendar/docs/event_rendering/renderEvent/)
                $('#calendar').fullCalendar('renderEvent', copiedEventObject, true);

                // is the "remove after drop" checkbox checked?
                if ($('#drop-remove').is(':checked')) {
                    // if so, remove the element from the "Draggable Events" list
                    $(this).remove();
                }

            },

            // events: [
            //     {
            //         title: 'All Day Event',
            //         start: new Date(y, m, 1)
            //     },
            //     {
            //         id: 999,
            //         title: 'Repeating Event',
            //         start: new Date(y, m, d - 3, 16, 0),
            //         allDay: false,
            //         className: 'info'
            //     },
            //     {
            //         id: 999,
            //         title: 'Repeating Event',
            //         start: new Date(y, m, d + 4, 16, 0),
            //         allDay: false,
            //         className: 'info'
            //     },
            //     {
            //         title: 'Meeting',
            //         start: new Date(y, m, d, 10, 30),
            //         allDay: false,
            //         className: 'important'
            //     },
            //     {
            //         title: 'Lunch',
            //         start: new Date(y, m, d, 12, 0),
            //         end: new Date(y, m, d, 14, 0),
            //         allDay: false,
            //         className: 'important'
            //     },
            //     {
            //         title: 'Birthday Party',
            //         start: new Date(y, m, d + 1, 19, 0),
            //         end: new Date(y, m, d + 1, 22, 30),
            //         allDay: false,
            //     },
            //     {
            //         title: 'Click for Google',
            //         start: new Date(y, m, 28),
            //         end: new Date(y, m, 29),
            //         url: 'https://ccp.cloudaccess.net/aff.php?aff=5188',
            //         className: 'success'
            //     }
            // ],
        });


        /* Add customized button in header
        -----------------------------------------------------------------*/
        $('.fc-header .fc-header-left').append(
            $('<button type="button" class="fc-button fc-state-default fc-corner-left fc-corner-right"><i class="la la-plus"></i> Event</button>')
                .on('click', function() {
                    $(`body`).append(MODAL.CREATE.BASIC({title:"New Event", el: [
                        {title:"Event Title",id:"title",type:"text",required:true},
                        {title:"Start Date",id:"start",type:"text",required:true},
                        {title:"End Date",id:"end",type:"text",required:true},
                    ]}));
                    $(`#start`).replaceWith(`<div class="input-group">
                                                <span class="input-group-addon"><i id="icon-date" class="la la-calendar"></i></span>
                                                <input id="start" class="form-control" type="text" required=true onkeydown="event.preventDefault()">
                                            </div>`);
                    $(`#end`).replaceWith(`<div class="input-group">
                                                <span class="input-group-addon"><i id="icon-date" class="la la-calendar"></i></span>
                                                <input id="end" class="form-control" type="text" required=true onkeydown="event.preventDefault()" disabled>
                                            </div>`);
                    
                    $(`#start`).daterangepicker({
                        opens: 'left',
                        singleDatePicker:true,
                        autoUpdateInput: false,
                        autoApply: true
                    }).on('apply.daterangepicker', function (ev, picker) {
                        $(this).val(DATETIME.FORMAT(new Date(picker.startDate),"MM/DD/YYYY"));

                        $(`#end`).daterangepicker({
                            opens: 'left',
                            singleDatePicker:true,
                            autoUpdateInput: false,
                            minDate: new Date(picker.startDate),
                            autoApply: true
                        }).on('apply.daterangepicker', function (ev, picker) {
                            $(this).val(DATETIME.FORMAT(new Date(picker.startDate),"MM/DD/YYYY"));
                        }).attr("disabled",false);
                        
                        if(new Date(picker.startDate).getTime() >= new Date($(`#end`).val()||undefined).getTime()){
                            $(`#end`).trigger('apply.daterangepicker',{ startDate: new Date(picker.startDate) });
                        }
                    });

                    
                    $('#submit').click(function(){
                        const title = $('#title').val();
                        const start = $('#start').val();
                        const end = $('#end').val();

                        calendar.fullCalendar('renderEvent', {
                                title: title,
                                start: start,
                                end: end,
                                allDay: true,
                                eventType: "custom",
                                className: "custom-event"
                            },
                            true // make the event "stick"
                        );
                        $('#overlay').remove();
                    });
            })
        );


        /* get holidays from Google Calendar API
        -----------------------------------------------------------------*/
        
        const publicAPIKey = "AIzaSyC4GSP3uLbIvfO_RPqUzlEyxb9Duy5vjYk";
        const country = "philippines";
        var calendarUrl = 'https://www.googleapis.com/calendar/v3/calendars/en.' + country
                        + '%23holiday%40group.v.calendar.google.com/events?key=' + publicAPIKey;

        $.getJSON(calendarUrl).done(function(data) {
            console.log(data);
            data.items.forEach(val => {
                const event = {
                    title: val.summary,
                    start: val.start.date,
                    end: moment(val.end.date).subtract(1,'day').toDate(),
                    allDay: true,
                    eventType: "holiday"
                };
                $('#calendar').fullCalendar( 'renderEvent', event, true);
            });
        }).fail(function(error) {
            console.log("error",error)
        });
    }
};
const CUSTOMERS = {
    init: function(){
        var urlPath = "customers",
            _new_ = true,  
            _new1_ = true,  
            table = new Table({
                id: "#tbl-customers",
                urlPath,
                goto: "customers",
                dataTableOptions: {
                    columns: TABLE.COL_ROW(CUSTOM.COLUMN.customers).column,
                    order: [[ 3, "asc" ]],
                    createdRow: function (row, data, dataIndex) {
                        var _row = data._row;
                        $(row).attr(`_row`, data._row);

                        table.rowListeners(_row,data._id);
                    },
                    dom: 'lBr<"tbl-options">ti<"tbl-progress-bar">p',
                },
                initializeCallback: function(){
                    TABLE.WATCH({urlPath,rowData:table.addRow,options:function(){TABLE.FINISH_LOADING.START_CHECK();}});

                    // add tbl options elements (1-9 and A-Z)
                    $('.tbl-options').css({
                        "width": "235px",
                        "float": "right",
                    });

                    $('.tbl-options').html(`
                        <div>
                            <div style="width: 100%;" class="input-group">
                                <input type="text" id="searchTerm" class="form-control" style="width: 100%;height: 31px;" placeholder="Search by Number or Name">
                                <span class="input-group-btn">
                                    <button id="search" type="button" style="padding-left: 10px;padding-right: 10px;" class="btn btn-default"><i class="la la-search m-0"></i></button>
                                </span>
                            </div>
                        </div`);

                    function search(){
                        const term = $('#searchTerm').val();

                        if(term._trim() != ""){
                            $('#search,#searchTerm').attr("disabled",true).html(`<i class="la la-spin la-spinner m-0"></i>`).blur();

                            table.customFilter = [{
                                field: "term",
                                value: term,
                                dataType: "string",
                            }];
                            table.loadId = GENERATE.RANDOM(12);
                            table.countRows();
                        }
                    }
                    $('#search').click(search);
                    $('#searchTerm').on('keypress', function (e) {
                        if(e.which === 13){
                            search();
                        }
                    });
                }
            });
        table.setButtons({
            loadView: ["create"],
            actions:{
                create: function(){
                    initializeModal({
                        url: `/api/${urlPath}/${CLIENT.id}/${USER.username}`,
                        method: "POST"
                    });
                },
            }
        });
        table.addRow = function(obj){
            const self = this;
            var action = TABLE.ROW_BUTTONS(PAGE.GET(),{
                loadView:["edit"],
                readonlyArr:["edit"],
            });
            $(`${self.id} th:last-child`).css({"min-width":action.width,"width":action.width});

            var region = (LIST["regions"]) ? (getRegion(obj.region_id) || {}).code : `<small class="font-italic text-muted">loading...</small>`;
            var geofence = (LIST["geofences"]) ? (getGeofence(obj.dc_id) || {}).short_name : `<small class="font-italic text-muted">loading...</small>`;

            return TABLE.COL_ROW(null,{
                '_id': obj._id,
                '_row':  obj._row,
                'Number': obj.number || "-",
                'Name': obj.name || "-",
                'Service Model': obj.service_model || "-",
                'Territory': obj.territory || "-",
                'Region': region || "-",
                'DC': geofence || "-",
                'Mode of Transport': obj.mode_of_transport || "-",
                'Type': obj.type || "-",
                'Action': action.buttons,
            }).row;
        };
        table.rowListeners = function(_row,_id){
            const self = this;
            TABLE.ROW_LISTENER({table_id:table.id,_row,urlPath,_id,initializeModal});
        };
        table.filterListener = function(){
            const self = this;
            var filter = USER.filters.customers || {};
            try {
                filter = JSON.parse(USER.filters.customers);
            } catch(error){ }

            if(filter.region_id && filter.region_id != "All"){
                $(`#filter-container`).toggle("slide", {direction:'right'},100);
                setTimeout(function(){
                    $(`#_region_id`).val(filter.region_id);
                    $(`#filter-btn`).trigger("click");
                },100);
            }
            if(filter.cluster_id && filter.cluster_id != "All"){
                $(`#filter-container`).toggle("slide", {direction:'right'},100);
                setTimeout(function(){
                    $(`#_cluster_id`).val(filter.cluster_id);
                    $(`#filter-btn`).trigger("click");
                },100);
            }
            
            function saveFilter(_filter_){
                var data = {};
                data[`filter.customers`] = JSON.stringify(_filter_);
                GET.AJAX({
                    url: `/api/users/${CLIENT.id}/${USER.username}/${USER.username}`,
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8",
                        "Authorization": SESSION_TOKEN
                    },
                    data: JSON.stringify(data)
                }, function(docs){
                    console.log("docs1",docs);
                    self.dt.column(2).search(_filter_.region_id).draw(false);
                    self.dt.column(3).search(_filter_.cluster_id).draw(false);
                    USER.filters.customers = _filter_;
                    filter = _filter_;
                    $(`#filter-btn`).html("Apply").removeClass("disabled");
                });
            }
            $(`#filter-btn`).click(function(){
                $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");
                var _region_id = ($(`#_region_id`).val() == "All") ? "" : $(`#_region_id`).val();
                var _cluster_id = ($(`#_cluster_id`).val() == "All") ? "" : $(`#_cluster_id`).val();

                saveFilter({ region_id: _region_id, cluster_id: _cluster_id });
            });
            $(`#reset-btn`).click(function(){
                $(`#_site`).val("All");
                $(`#filter-btn`).trigger("click");
            });
        };

        table.filterDataExtend = true;

        var initializeModal = function(x={}){
            // LOAD SELECT 2 OPTIONS FOR: VEHICLES
            getSelect2Options();
            x.obj = x.obj || {};
            
            var title = (x.method == "PUT") ? `Edit Customer` : `Add New Customer`,
                modalElements = function(obj){
                    var readonly = x.method == "PUT";
                    return [
                        {title:"Customer Number",id:"number",type:"text",required:true,value:obj.number,readonly},
                        {title:"Customer Name",id:"name",type:"text",value:obj.name,required:true,},
                        {title:"Service Model",id:"service_model",type:"text",value:obj.service_model,required:true,},
                        {title:"Territory",id:"territory",type:"text",value:obj.territory,required:true,},
                        {title:"Region",id:"region_id",type:"select2",attr:"blankStringIfEmpty"},
                        {title:"DC",id:"dc_id",type:"select2",attr:"blankStringIfEmpty"},
                        {title:"Mode of Transport",id:"mode_of_transport",type:"select2",attr:"blankStringIfEmpty",required:true,},
                        {title:"Type",id:"type",type:"select2",attr:"blankStringIfEmpty",required:true,},
                    ];
                };
            $(`body`).append(MODAL.CREATE.BASIC({title, el: modalElements(x.obj)}));

            $(`#region_id`).html(G_SELECT2["form-regions"]).select2().val(x.obj.region_id || "").trigger("change");
            $(`#dc_id`).html(G_SELECT2["form-geofences"]).select2().val(x.obj.dc_id || "").trigger("change");
            $(`#mode_of_transport`).html(`
                <option>OTR</option>
                <option>Inland</option>
                <option>Offshore</option>
            `).select2().val(x.obj.mode_of_transport || "").trigger("change");
            $(`#type`).html(`
                <option>Delivery</option>
                <option>Pick-up</option>
            `).select2().val(x.obj.type || "").trigger("change");

            MODAL.SUBMIT(x);
        };

        /******** TABLE CHECK ********/
        TABLE.FINISH_LOADING.CHECK = function(){ // add immediately after variable initialization
            isFinishedLoading(["REGIONS"], _new_, function(){
                _new_ = false;
                table.initialize();
                table.populateRows([]);
                table.hideProgressBar();
            });
            isFinishedLoading(["REGIONS","GEOFENCES"], _new1_, function(){
                if(table.dt){
                    _new1_ = false;
                    table.updateRows(LIST[urlPath]);
                }
            });
            isFinishedLoading(["REGIONS","GEOFENCES"], true, function(){
                TABLE.FINISH_LOADING.UPDATE();
            });
        }
        TABLE.FINISH_LOADING.START_CHECK();
        /******** END TABLE CHECK ********/
    }
};
var CHANGELOG = {
    FUNCTION: {
        init:function(){
            PAGE.DISPLAY();
            PAGE.TOOLTIP();

            var template = function(version,val,i){
                var className = function(){
                        return (i > 0) ? "mt-3":"";
                    },
                    logType = function(type,text){
                        var bgColors = {
                            feature: "#7ac943",
                            fix: "#ff1d25",
                            release: "#3fa9f5",
                            other: "gray",
                            improved: "#ff931e",
                            refactor: "#a9489a"
                        };
                        text = text.replace("aPAGE",`<span style="color: #334fe5;">`);
                        text = text.replace("zPAGE",`</span>`);
                        text = text.replace("aVERSION",`<span style="color: #adadad;">`);
                        text = text.replace("zVERSION",`</span>`);
                        return `<li>
                                    <div style="display: table-cell;"><span style="background: ${bgColors[type]};color: white;padding: 1px 5px;border-radius: 2px;font-weight: bold;font-size: 10px;margin-right: 2px;">${type}</span></div>
                                    <span style="display: table-cell;padding-left: 3px;">${text}</span>
                                </li>`;
                    },
                    liHTML = "";
                    Object.keys(val).forEach(key => {
                        if(!["hotfix","date"].includes(key)){
                            val[key].forEach(text => {
                                liHTML += logType(key,text);
                            });
                        }
                    });
                return `<div class="col-sm-12 ${className()}">
                            <div class="p-3" style="border: 1px solid #eee;">
                                <h4 style="border-bottom: 1px solid #dcdcdc;font-weight: bold;" class="pb-2 mb-3 mt-1">v.${version}<span class="text-muted" style="font-size: 11px;font-weight: 100;float: right;">${val.date}</span></h4>
                                <ul>${liHTML}</ul>
                            </div>
                        </div>`;
            },
            changelogs = CHANGELOG.FUNCTION.changelogs,
            listHTML = "";

            Object.keys(changelogs).forEach((key,i) => {
                if(i === 0) {
                    $(`#version`).html(key);
                }
                listHTML += template(key,changelogs[key],i);
            });
            $(`.page-box`).append(listHTML);
            $(`#guide-btn`).click(function(){
                $(`body`).append(modalViews.changelogs.guide());
            });
        },
        changelogs: changelogList
    }
};
var LOADING = {
    SPINNER: {
        UI: function(){
            return `<div class="loading-screen">
                        <div>
                            <i class="la la-spinner la-spin"></i>
                            <div id="loading-description" class="col-md-12 text-muted" style="font-size: 10px;font-weight: 100;margin-top: 8px;"></div>
                        </div>
                    </div>`;
        }
    },
    PROGRESSBAR: {
        UI: function(){
            return `<div id="progress-striped-active" class="progress progress-striped active" style="width: 100%;">
                        <div class="progress-bar progress-bar-success" data-transitiongoal="0"></div>
                    </div>`;
        },
        INITIALIZE: function(){
            $('#progress-striped .progress-bar, #progress-striped-active .progress-bar').progressbar({
                display_text: 'fill'
            });
        },
        MOVE: function(minWidth,maxWidth){
            var i = 0;
            function moveProgressBar() {
                if (i == 0) {
                    i = 1;
                    var elem = $(`#progress-striped-active .progress-bar`);
                    var id = setInterval(frame, 10);
                    function frame() {
                        if (minWidth >= maxWidth) {
                            clearInterval(id);
                            i = 0;
                            TABLE.FINISH_LOADING.START_CHECK();
                        } else {
                            minWidth++;
                            $(elem).css("width",`${minWidth}%`).html(`${minWidth}%`);
                        }
                    }
                }
            } 
            moveProgressBar();
        }
    },

};
/************** END USER INTERFACE **************/

/************** FUNCTIONS **************/
var PAGE = {
    EXISTING: [],
    MAIN: {
        UI: {
            PAGE: function(){
                return `<!-- WRAPPER -->
                        <div id="wrapper">
                            ${PAGE.MAIN.UI.NAVBAR()}
                            ${PAGE.MAIN.UI.LEFT_SIDEBAR()}
                            ${PAGE.MAIN.UI.BODY()}
                            <div class="clearfix"></div>
                        </div>
                        <!-- END WRAPPER -->`;
            },
            NAVBAR: function(){
                return `<!-- NAVBAR -->
                        <nav class="navbar navbar-default navbar-fixed-top">
                            <div class="container-fluid pl-0">
                                <div class="brand">
                                    <img src="public/img/logo-02.png" alt="WRU Logo" class="img-responsive logo" style="image-rendering: -webkit-optimize-contrast;">
                                </div>
                                <div id="tour-fullwidth" class="navbar-btn pl-2">
                                    <button type="button" class="btn-toggle-fullwidth"><i class="la la-arrow-circle-left"></i></button>
                                    <button type="button" class="btn-fullscreen pl-2 p-2"><i class="la la-expand-arrows-alt"></i></button>
                                </div>
                                <div id="navbar-menu">
                                    <ul class="nav navbar-nav navbar-right">
                                        <li class="dropdown">
                                            <a href="#" class="dropdown-toggle pt-0 pr-2 mr-3" style="float: right;text-align: right;" data-toggle="dropdown">
                                                <span><i style="top: -1px;position: absolute;" class="la la-eye mr-2 font-16"></i><span class="pl-4" viewas-title></span></span>
                                            </a>
                                            <ul id="viewas-container" class="dropdown-menu logged-user-menu"></ul>
                                        </li>
                                        <li class="dropdown">
                                            <img src="../public/img/${CLIENT.id}-dashboard.png" style="height: 17px;margin-top: 13px;image-rendering: -webkit-optimize-contrast;">
                                            <a href="#" class="dropdown-toggle pt-0 pr-2 pl-1" style="min-width: 100px;float: right;text-align: right;" data-toggle="dropdown">
                                                <span>${USER.username}<i style="font-size: 9px;margin-left: 6px;" class="icon-submenu la la-angle-down"></i></span>
                                            </a>
                                            <ul class="dropdown-menu logged-user-menu">
                                                <li><a href="#profile"><i class="la la-user"></i> <span>Profile</span></a></li>
                                                <!-- <li><a href="appviews-inbox.html"><i class="la la-email"></i> <span>Message</span></a></li> -->
                                                <li><a href="#settings"><i class="la la-cog"></i> <span>Settings</span></a></li>
                                                <li><a href="#logout"><i class="la la-sign-out-alt"></i> <span>Logout</span></a></li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </nav>
                        <!-- END NAVBAR -->`;
            },
            LEFT_SIDEBAR: function(){
                var link = function(page){
                        var badge = (page.notification) ? `<span id="${page.name}-badge" class="badge" style="display:none;">0</span>` : "";
                        return `<li><a href="#${page.name}"><i class="${page.icon}"></i> <span class="title">${page.title}</span>${badge}</a></li>`;
                    },
                    menubar = function(sub_menu,parentText){
                        // var badge = (notification) ? `<span class="badge">15</span>` : "";
                        var finalParentText = parentText || "Parent Menu";
                        finalParentText = finalParentText.capitalize();
                        var __sub = "",
                            icon = "";
                        sub_menu.forEach(val => {
                            var page = PAGE_FUNCTIONALITIES[val];
                            __sub += link(page);
                            icon = page.icon;
                        });
                        return `<li class="panel">
                                    <a href="#${parentText}" data-toggle="collapse" class="collapsed" aria-expanded="false"><i class="${icon}"></i> <span class="title">${finalParentText}</span> <i class="icon-submenu la la-angle-left"></i></a>
                                    <div id="${parentText}" class="collapse" aria-expanded="false" style="height: 0px;">
                                        <ul class="submenu">${__sub}</ul>
                                    </div>
                                </li>`;
                    },
                    li = "";
                GRANTED_PAGES.forEach(x => {
                    if(!ISMOBILE  || (ISMOBILE && x.allowOnMobile === true)) {
                        var menu_group = "";
                        if(x.menu_group){
                            var menu_group_class = x.menu_group.class || "";
                            menu_group = `<li class="menu-group ${menu_group_class}">${x.menu_group.title}</li>`
                        }
                        li+=menu_group;
                        if(x.sub_menu) li+=menubar(x.sub_menu,x.name);
                        else li+=link(x);
                    }
                });
                return `<!-- LEFT SIDEBAR -->
                        <div id="sidebar-nav" class="sidebar">
                            <nav>
                                <ul class="nav" id="sidebar-nav-menu">
                                    <!-- <li class="menu-group">Menu</li> -->
                                    <li class="panel">${li}</li>
                                </ul>
                            </nav>
                        </div>
                        <!-- END LEFT SIDEBAR -->`;
            },
            BODY: function(){
                var version = "";
                Object.keys(CHANGELOG.FUNCTION.changelogs).forEach((key,i) => { if(i === 0) { version = key; } });
                return `<!-- MAIN -->
                        <div class="main">
                            <!-- MAIN CONTENT -->
                            <div class="main-content">
                                <div class="container-fluid p-0">
                                    <a href="javascript:void(0)" class="btn-close-fullscreen" style="display:none;position: absolute;width: 100%;text-align: center;padding: 7px 0px 2px;">Click here to exit fullscreen or press ESC key</a>
                                    <div class="panel panel-profile">
                                        <div class="clearfix"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- END MAIN CONTENT -->
                            <footer>
                                <div class="container-fluid">
                                    <p class="copyright">
                                        <span>Version ${version}</span>
                                        <span class="float-right">&copy; 2020 - ${new Date().getFullYear()} <a href="https://www.wru.ph" target="_blank">WRU Corporation</a>. All Rights Reserved.</span>
                                    </p>
                                </div>
                            </footer>
                        </div>
                        <!-- END MAIN -->`;
            },
            BOTTOM_NAVBAR: function(){
                var link = function(page){
                        return `<a href="#${page.name}" class="navbar-bottom-button"><i class="${page.icon}"></i><div>${page.title_m || page.title}</div></a>`;
                    },
                    li = "",
                    MOBILE_PAGES = GRANTED_PAGES;
                MOBILE_PAGES.push(PAGE_FUNCTIONALITIES["profile"]);
                MOBILE_PAGES.push(PAGE_FUNCTIONALITIES["settings"]);
                MOBILE_PAGES.forEach(x => {
                    if(ISMOBILE && x.allowOnMobile === true) {
                        li+=link(x);
                    }
                });
                return `<!-- BOTTOM NAVBAR -->
                        <div class="navbar navbar-bottom">
                            <div class="navbar-bottom-toggle">
                                <i class="la la-ellipsis-h"></i>
                            </div>
                            <div class="flex-container">
                                ${li}
                            </div>
                        </div>
                        <!-- END BOTTOM NAVBAR -->`;
            },
            MOBILE: function(){
                return `<!-- WRAPPER -->
                            <div id="wrapper">
                                <!-- MAIN -->
                                <div class="main pt-0" style="height: calc(100% - 65px);position: fixed;overflow-y: auto;overflow-x: hidden;">
                                    <!-- MAIN CONTENT -->
                                    <div class="main-content">
                                        <div class="container-fluid p-0">
                                            <div class="panel panel-profile" style="margin-bottom:10px;">
                                                <div style="height: 40px;position: fixed;top: 0;z-index: 99;background: white;width: 100%;">
                                                    <img src="../public/img/logo-02.png" style="width: 190px;padding-top: 7px;display: block;margin: auto;image-rendering: -webkit-optimize-contrast;">
                                                </div>
                                                <div class="clearfix"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- END MAIN CONTENT -->
                                </div>
                                <!-- END MAIN -->
                                ${PAGE.MAIN.UI.BOTTOM_NAVBAR()}
                            </div>
                            <!-- END WRAPPER -->`;
            }
        }, 
        FUNCTION:{
            init:function(){
                // get page options sent by server
                ENVIRONMENT = $(`#ENVIRONMENT`).text() || "development";
                s = $(`#PAGE`).text() || "";

                // VERSION
                Object.keys(CHANGELOG.FUNCTION.changelogs).forEach((key,i) => { if(i === 0) { VERSION = key; } });

                DEFAULT_DATE = moment(new Date()).format("MM/DD/YYYY");

                PAGE.SET_FUNCTIONALITIES();
                GRANTED_PAGES = [];
                Object.keys(PERMISSION).forEach(key => {
                    if(["all","self"].includes(PERMISSION[key].read)){
                        var page = PAGE_FUNCTIONALITIES[key];
                        if(page){
                            GRANTED_PAGES.push({
                                name: page.name,
                                title: page.title,
                                notification: page.notification,
                                title_m: page.title_m,
                                icon: page.icon,
                                allowOnMobile: page.allowOnMobile,
                                menu_group: page.menu_group
                            });
                        }
                    }
                });

                if(USER.username){
                    if(ISMOBILE){
                        $(`#version`).remove();
                        $(`#body-main`).html(PAGE.MAIN.UI.MOBILE());
                        $(`.navbar-bottom-toggle`).click(function(){
                            $(`.navbar-bottom,.main,#filter-container`).toggleClass("navbar-bottom-hidden");
                        });
                        $(`.panel.panel-profile .clearfix`).css({"margin-top":"40px"});
                        if(HASNOTIFICATION){
                            $(`a[href="#notifications"] > .la-business-time`).html(`<div style="width: 10px;height: 10px;background: #fce146;border-radius: 20px;position: absolute;top: 22px;margin-left: -2px;border: 1px solid #daeb60;"></div>`);
                        }
                    } else {
                        $(`#body-main`).html(PAGE.MAIN.UI.PAGE());
                        // PING.GET();
                    }
                    PAGE.GO_TO();

                    if(USER.role.toLowerCase() != "user"){
                        $(`#sidebar-nav`).css("padding-top","27px").prepend(`
                        <div style="padding: 3px;text-align: center;color: white;background-color: #00a548;font-size: 10px;">${USER.role.capitalize().toUpperCase()}</div>
                        `);
                    }

                    PAGE_SETUP();
                    
                    window.onhashchange = function () {
                        window.history.pushState({}, null, `${window.location.pathname}#${PAGE.GET()}`);
                        PAGE.GO_TO();
                    }
                } else {
                    LOGOUT();
                }

                if((CLIENT.allowRolesToViewAs||{})[USER.originalRole]){
                    ((CLIENT.allowRolesToViewAs||{})[USER.originalRole]||[]).forEach(val => {
                        var text = val.capitalize();
    
                        var active = USER.role==val ? "active" : "";
                        (USER.role==val) ? $(`[viewas-title]`).text(text) : null;
                        
                        $(`#viewas-container`).append(`<li><a href="javascript:void(0);" class="${active}" viewas="${val}"><span>${text}</span></a></li>`);
                    });
                    $(`#viewas-container`).append(`<li class="p-2" style="line-height: 10px;cursor: default;background-color: #089d4b;color: white;"><span style="font-size: 10px;">Please note that viewing as a certain role will only take effect on this current tab. Opening another tab will allow you to view as a different role.</span></li>`);
                    $(`[viewas]`).click(function(){
                        var viewas = $(this).attr("viewas");
                        sessionStorage.setItem("view_as",viewas);
                        location.reload();
                    });
                } else {
                    $(`#viewas-container`).parents(".dropdown").remove();
                }

                $(`body`).append(`<audio id="audio01" src="public/sounds/notif.mp3" autostart="0" ></audio>`);
                $(`.btn-toggle-fullwidth`).click(function(){
                    setTimeout(function(){
                        $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
                    },400);
                });
                $(`.btn-fullscreen`).click(function(){
                    $(`.main,.main .main-content .container-fluid`).attr("style","position: absolute;top: 0;left: 0;width: 100%;height: 100%;z-index:9999;");
                    
                    if(PAGE.GET() == "de_dashboard") document.body.style.zoom = 1.3;

                    setTimeout(function(){
                        $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
                    },400);
                    
                    var docElm = document.documentElement;
                    if (docElm.requestFullscreen) {
                        docElm.requestFullscreen();
                    } else if (docElm.msRequestFullscreen) {
                        docElm.msRequestFullscreen();
                    } else if (docElm.mozRequestFullScreen) {
                        docElm.mozRequestFullScreen();
                    } else if (docElm.webkitRequestFullScreen) {
                        docElm.webkitRequestFullScreen();
                    }
                });
                document.addEventListener('fullscreenchange', exitHandler);
                document.addEventListener('webkitfullscreenchange', exitHandler);
                document.addEventListener('mozfullscreenchange', exitHandler);
                document.addEventListener('MSFullscreenChange', exitHandler);

                function exitHandler() {
                    if (!document.fullscreenElement && !document.webkitIsFullScreen && !document.mozFullScreen && !document.msFullscreenElement) {
                        ///fire your event
                        if($(`.main,.main .main-content .container-fluid`).attr("style")){
                            $(`.main,.main .main-content .container-fluid`).attr("style","");
                            if(PAGE.GET() == "de_dashboard") document.body.style.zoom = 1;
                            setTimeout(function(){
                                $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
                            },400);
                        }
                    }
                }  
                $(document).keyup(function(e) {
                    if (e.key === "Escape") { // escape key maps to keycode `27`
                        $(`.main,.main .main-content .container-fluid`).attr("style","");
                        if(PAGE.GET() == "de_dashboard") document.body.style.zoom = 1;
                        setTimeout(function(){
                            $.fn.dataTable.tables({ visible: true, api: true }).columns.adjust();
                        },400);
                    }
                });

                var timeout = 2000,
                    loadDataInBackground = function(instant,delayed){
                        if((CLIENT.loadInBackground||[]).includes(instant)){
                            instant ? new loadInBackground(instant.toLowerCase(),instant.toUpperCase()).load() : null;
                        }

                        setTimeout(function(){ 
                            delayed.forEach(val => { 
                                if((CLIENT.loadInBackground||[]).includes(val)){
                                    new loadInBackground(val.toLowerCase(),val.toUpperCase()).load();
                                }
                            }); 
                        },timeout);
                    },
                    tableWatch = function(urlPath){
                        if((CLIENT.loadInBackground||[]).includes(urlPath.toUpperCase())){
                            TABLE.WATCH({ urlPath });
                        }
                    };

                if(PAGE.GET() == "regions") loadDataInBackground("REGIONS",["CLUSTERS","GEOFENCES","ROUTES","VEHICLES","TRAILERS","VEHICLE_PERSONNEL","SHIFT_SCHEDULE","USERS","VEHICLES_SECTION","VEHICLES_COMPANY","VEHICLE_PERSONNEL_SECTION","VEHICLE_PERSONNEL_COMPANY","VEHICLES_HISTORY","CHASSIS","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE"]);
                else if(PAGE.GET() == "clusters")loadDataInBackground("CLUSTERS",["REGIONS","GEOFENCES","ROUTES","VEHICLES","TRAILERS","VEHICLE_PERSONNEL","SHIFT_SCHEDULE","USERS","VEHICLES_SECTION","VEHICLES_COMPANY","VEHICLE_PERSONNEL_SECTION","VEHICLE_PERSONNEL_COMPANY","VEHICLES_HISTORY","CHASSIS","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE"]);
                else if(PAGE.GET() == "geofences") loadDataInBackground("GEOFENCES",["REGIONS","CLUSTERS","ROUTES","VEHICLES","TRAILERS","VEHICLE_PERSONNEL","SHIFT_SCHEDULE","USERS","VEHICLES_SECTION","VEHICLES_COMPANY","VEHICLE_PERSONNEL_SECTION","VEHICLE_PERSONNEL_COMPANY","VEHICLES_HISTORY","CHASSIS","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE"]);
                else if(PAGE.GET() == "routes" || PAGE.GET() == "dashboard") loadDataInBackground("ROUTES",["GEOFENCES","REGIONS","CLUSTERS","VEHICLES","TRAILERS","VEHICLE_PERSONNEL","SHIFT_SCHEDULE","USERS","VEHICLES_SECTION","VEHICLES_COMPANY","VEHICLE_PERSONNEL_SECTION","VEHICLES_HISTORY","CHASSIS","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE"]);
                else if(PAGE.GET() == "trailers") loadDataInBackground("TRAILERS",["REGIONS","CLUSTERS","GEOFENCES","ROUTES","VEHICLES","VEHICLE_PERSONNEL","SHIFT_SCHEDULE","USERS","VEHICLES_SECTION","VEHICLES_COMPANY","VEHICLE_PERSONNEL_SECTION","VEHICLE_PERSONNEL_COMPANY","VEHICLES_HISTORY","CHASSIS","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE"]);
                else if(PAGE.GET() == "vehicles") loadDataInBackground("VEHICLES",["REGIONS","CLUSTERS","GEOFENCES","ROUTES","TRAILERS","VEHICLE_PERSONNEL","SHIFT_SCHEDULE","USERS","VEHICLES_SECTION","VEHICLES_COMPANY","VEHICLE_PERSONNEL_SECTION","VEHICLE_PERSONNEL_COMPANY","VEHICLES_HISTORY","CHASSIS","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE"]);
                else if(PAGE.GET() == "vehicle_personnel") loadDataInBackground("VEHICLE_PERSONNEL",["REGIONS","CLUSTERS","GEOFENCES","ROUTES","VEHICLES","TRAILERS","USERS","VEHICLES_SECTION","VEHICLES_COMPANY","VEHICLE_PERSONNEL_SECTION","VEHICLE_PERSONNEL_COMPANY","VEHICLES_HISTORY","CHASSIS","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE","SHIFT_SCHEDULE"]);
                else if(PAGE.GET() == "chassis") loadDataInBackground("CHASSIS",["REGIONS","CLUSTERS","GEOFENCES","ROUTES","VEHICLES","TRAILERS","USERS","VEHICLES_SECTION","VEHICLES_COMPANY","VEHICLE_PERSONNEL_SECTION","VEHICLE_PERSONNEL_COMPANY","VEHICLES_HISTORY","VEHICLE_PERSONNEL","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE","SHIFT_SCHEDULE"]);
                else if(PAGE.GET() == "shift_schedule") loadDataInBackground("SHIFT_SCHEDULE",["REGIONS","CLUSTERS","GEOFENCES","ROUTES","VEHICLES","TRAILERS","VEHICLE_PERSONNEL","USERS","VEHICLES_SECTION","VEHICLES_COMPANY","VEHICLE_PERSONNEL_SECTION","VEHICLE_PERSONNEL_COMPANY","VEHICLES_HISTORY","CHASSIS","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE"]);
                else if(PAGE.GET() == "users") loadDataInBackground("USERS",["REGIONS","CLUSTERS","GEOFENCES","ROUTES","VEHICLES","TRAILERS","VEHICLE_PERSONNEL","SHIFT_SCHEDULE","VEHICLES_SECTION","VEHICLES_COMPANY","VEHICLE_PERSONNEL_SECTION","VEHICLE_PERSONNEL_COMPANY","VEHICLES_HISTORY","CHASSIS","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE"]);
                // else if(PAGE.GET() == "customers") loadDataInBackground("CUSTOMERS",["USERS","REGIONS","CLUSTERS","GEOFENCES","ROUTES","VEHICLES","TRAILERS","VEHICLE_PERSONNEL","SHIFT_SCHEDULE","VEHICLES_SECTION","VEHICLES_COMPANY","VEHICLE_PERSONNEL_SECTION","VEHICLE_PERSONNEL_COMPANY","VEHICLES_HISTORY","CHASSIS","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE"]);
                else loadDataInBackground("VEHICLES",["REGIONS","CLUSTERS","GEOFENCES","ROUTES","TRAILERS","VEHICLE_PERSONNEL","SHIFT_SCHEDULE","USERS","VEHICLES_SECTION","VEHICLES_COMPANY","VEHICLE_PERSONNEL_SECTION","VEHICLE_PERSONNEL_COMPANY","VEHICLES_HISTORY","CHASSIS","CHASSIS_SECTION","CHASSIS_COMPANY","CHASSIS_TYPE"]);

                tableWatch("notifications");
                tableWatch("users");
                tableWatch("sessions");
                tableWatch("vehicles_history");
                tableWatch("vehicles_section");
                tableWatch("vehicles_company");
                tableWatch("vehicle_personnel_section");
                tableWatch("vehicle_personnel_company");

                // PAGE.IDLE();

                $(`.menu-group`).each((i,el) => {
                    var option = (CLIENT.menuGroupOptions||[]).find(x => x.title == $(el).text());
                    if(option && (option.roles||[]).includes(USER.role)){
                        $(el).addClass(option.class);
                    }
                });

                (USER) ? _SESSION_.lastActive(CLIENT.id,USER.username,SESSION_TOKEN) : null;
            },
        }
    },
    GO_TO: function(){
        var goto = PAGE.GET(),
            a_href = `a[href="#${goto}"]`,
            urlParams = new URLSearchParams(window.location.search),
            __data = CRYPTO.DECRYPT(urlParams.get('data'));
        PAGE.SET_TITLE(goto);

        (__data.for != goto) ? window.history.pushState({}, null, `/${CLIENT.name}#${goto}`) : null;
        $(`.panel-profile > .dt-buttons`).remove();
        
        DASHBOARD.FUNCTION.addDataToTable = null;
        DASHBOARD.FUNCTION.addDataToTable2 = null;

        TABLE.FINISH_LOADING.CHECK = null;

        Object.keys(INTERVALS).forEach(key => { clearInterval(INTERVALS[key]); });
        clearInterval(DE_CHECKDUPS);

        // set so that at 12 midnight, it will change DEFAULT_DATE
        DEFAULT_DATE = moment(new Date()).format("MM/DD/YYYY");

        // if(goto == "dispatch"){
        //     $(`.main-content .clearfix`).css({"height":(($(window).innerHeight()-167)+"px")}).html(LOADING.PROGRESSBAR.UI());
        //     LOADING.PROGRESSBAR.FUNCTION();
        // } else {
            $(`.main-content .clearfix`).css({"height":(($(window).innerHeight()-167)+"px")}).html(LOADING.SPINNER.UI());
        // }

        // add "active" class to menu. For dropdown menus. Do not delete for future references.
        var __parent_id = $(a_href).parents(".collapse").attr("id");
        ($(`#${__parent_id}`).attr("aria-expanded") == "false") ?  $(`[href="#${__parent_id}"]`).click() : null;
        $(`[aria-expanded="true"][href!="#${__parent_id}"]:not(#${__parent_id})`).click();

        $(`li > a.active,.navbar > .flex-container > a.active`).removeClass("active");
        ($(a_href).length > 0) ? $(a_href).addClass("active") : $(`a[href="#create"]`).addClass("active");

        if(PAGE_FUNCTIONALITIES[goto] && (["profile","settings","logout"].includes(goto) || GRANTED_PAGES.some(x=>x.name==goto))){
            if(ISMOBILE){
                if(PAGE_FUNCTIONALITIES[goto] && PAGE_FUNCTIONALITIES[goto].allowOnMobile === true){} 
                else {
                    goto = "default";
                }
            }
        } else {
            goto = "default";
        }
        PAGE_FUNCTIONALITIES[goto].function(goto);

        $("html, body").animate({ scrollTop: 0 }, "fast");
    },
    DISPLAY:function(){
        var goto = (PAGE_FUNCTIONALITIES[PAGE.GET()]) ? PAGE.GET() : "default";
        $(`.main-content .clearfix`).html(PAGE_FUNCTIONALITIES[goto].display()).css({"height":""});
    },
    SET_TITLE: function(goto){
        goto = (PAGE_FUNCTIONALITIES[goto]) ? goto : "default";
        document.title = `${PAGE_FUNCTIONALITIES[goto].title} | WRU Dispatch`;
    },
    DEFAULT: function(){
        var page = null;
        GRANTED_PAGES.forEach(x => {
            if(x.name == "dispatch_entry" && authorizationLevel .dispatcher() && !USER.dc){

            } else {
                if(x.sub_menu && page == null && PAGE_FUNCTIONALITIES[x.name]) page = x.sub_menu[0];
                else if(page == null && PAGE_FUNCTIONALITIES[x.name]) page = x.name;
            }
        });
        window.history.pushState({}, null, `#${page}`);
        return page;
    },
    GET: function(){
        return window.location.hash.replace("#","") || PAGE.DEFAULT();
    },
    TOOLTIP: function(){
        $('[data-toggle="tooltip"]').tooltip({
            html: "true", 
            container : "body",
            delay: {"show": 50, "hide": 50}
        });
    },
    SET_FUNCTIONALITIES: function(){
        var notificationsTblBtn = (clientCustom.allowExportTable.notifications) ? ["refresh","filter","export"] : ["refresh","filter"],
            dispatchTblBtn = (ENVIRONMENT == "development") ? ["create","import","refresh","column","export","filter","clone"] : ["create","import","refresh","column","export","filter"];
        
        function getClientTableButtons(key){
            var buttons = (clientCustom.tableButtons[key]||{}).buttons || [];
            ((clientCustom.tableButtons[key]||{}).condition||[]).forEach(val => {
                if((val.roles||[]).includes(USER.role)){
                    buttons = buttons.concat(val.additionalButton||[]);
                }
            });
            return buttons;
        }
        function getRowButtons(key){
            var buttons = (clientCustom.rowButtons[key]||{}).buttons || [];
            ((clientCustom.rowButtons[key]||{}).condition||[]).forEach(val => {
                if(val.not){
                    if(!(val.roles||[]).includes(USER.role)){
                        (val.removeButtons||[]).forEach(val1 => {
                            var index = buttons.indexOf(val1);
                            if (index !== -1) {
                                buttons.splice(index, 1);
                            }
                        });
                    }
                } else {
                    if((val.roles||[]).includes(USER.role)){
                        buttons = buttons.concat(val.additionalButton||[]);
                    }
                }
            });
            return buttons;
        }

        PAGE_FUNCTIONALITIES = {
            dashboard: {
                title: "Deployment Dashboard",
                title_m: "Dashboard",
                name: "dashboard",
                icon: "la la-chart-line",
                display: function() { return views.dashboard(); },
                function: function() { DASHBOARD.FUNCTION.init() },
                buttons: {
                    table:["column"],
                    row: ["view"]
                },
                allowOnMobile:true
            },
            de_dashboard: {
                title: "Delay Escalation Dashboard",
                name: "de_dashboard",
                icon: "la la-chart-line",
                display: function() { return views.de_dashboard(); },
                function: function() { DE_DASHBOARD.FUNCTION.init() },
                notification: true,
                buttons: {
                    table:["column"]
                },
            },
            otd_dashboard: {
                title: "Dashboard",
                name: "otd_dashboard",
                icon: "la la-chart-line",
                display: function() { return views.otd_dashboard(); },
                function: function() { OTD_DASHBOARD.init() },
                buttons: {
                    table:["column"]
                },
            },
            dispatch: {
                title: "Dispatch Entries",
                name: "dispatch",
                icon: "la la-table",
                display: function() { return views.dispatch(); },
                function: function() { DISPATCH.FUNCTION.monitoring() },
                buttons: {
                    table: dispatchTblBtn,// dispatchTblBtn,
                    row: getRowButtons("dispatch")  //dispatchRowBtn
                }
            },
            shift_schedule: {
                title: "Shift Schedule",
                name: "shift_schedule",
                icon: "la la-clock",
                display: function() { return views.shift_schedule(); },
                function: function() { SHIFT_SCHEDULE.FUNCTION.init() },
                buttons: {
                    table:["create","refresh"],
                    row:["delete"]
                }
            },
            dispatch_deleted: {
                title: "Dispatch Entries (Deleted)",
                name: "dispatch_deleted",
                icon: "la la-table",
                display: function() { return views.dispatch_deleted(); },
                function: function() { DISPATCH.FUNCTION.monitoring_deleted() },
                buttons: {
                    table: ["refresh","column","export","filter"],// dispatchTblBtn,
                    row: ["view"]  //dispatchRowBtn
                }
            },
            customers: {
                title: "Customers",
                name: "customers",
                icon: "la la-user-tie",
                display: function() { return views.customers(); },
                function: function() { CUSTOMERS.init() },
                buttons: {
                    table:["create","refresh"],
                    row:["edit","delete"]
                }
            },
            reports: {
                title: "Reports",
                name: "reports",
                icon: "la la-chart-bar",
                display: function() { return views.reports(); },
                function: function() { REPORTS.FUNCTION.init(); },
                buttons: {}
            },
            users: {
                title: "Users",
                name: "users",
                icon: "la la-users",
                display: function() { return views.users(); },
                function: function() { USERS.FUNCTION.init() },
                buttons: {
                    table: getClientTableButtons("users"),
                    row:["edit","delete"]
                }
            },
            notifications: {
                title: "Delay Notifications",
                title_m: "Notifications",
                name: "notifications",
                icon: "la la-business-time",
                display: function() { return views.notifications(); },
                function: function() { NOTIFICATIONS.FUNCTION.init() },
                buttons: {
                    table: notificationsTblBtn,
                    row:["comment","delete"]
                },
                allowOnMobile:true
            },
            events_sn: {
                title: "Event Viewer",
                name: "events_sn",
                icon: "la la-calendar-day",
                display: function() { return views.event_viewer(); },
                function: function() { EVENT_VIEWER.FUNCTION.init() },
                buttons: {
                    table: ["refresh","filter"],
                    row:["view"]
                }
            },
            vehicles: {
                title: "Vehicles",
                name: "vehicles",
                icon: "la la-truck",
                display: function() { return views.vehicles(); },
                function: function() { VEHICLES.FUNCTION.init() },
                menu_group: {
                    title: "Vehicles",
                },
                buttons: {
                    table: getClientTableButtons("vehicles"),
                    row: getRowButtons("vehicles") 
                }
            },
            fuel_refill: {
                title: "Fuel Refill",
                name: "fuel_refill",
                icon: "la la-truck",
                display: function() { return views.fuel_refill(); },
                function: function() { FUEL_REFILL.FUNCTION.init() },
                buttons: {
                    table: ["import","refresh","column"],
                    row: ["delete"]
                }
            },
            vehicle_personnel: {
                title: "Vehicle Personnel",
                name: "vehicle_personnel",
                icon: "la la-users-cog",
                display: function() { return views.vehicle_personnel(); },
                function: function() { VEHICLE_PERSONNEL.FUNCTION.init() },
                buttons: {
                    table: getClientTableButtons("vehicle_personnel"),
                    row: ["edit","edit-rest-days","delete"] // ,"edit-rest-days"
                }
            },
            trailers: {
                title: "Trailers",
                name: "trailers",
                icon: "la la-truck-loading",
                display: function() { return views.trailers(); },
                function: function() { TRAILERS.FUNCTION.init() },
                buttons: {
                    table:["create","refresh","filter"],
                    row: ["edit","delete"]
                }
            },
            chassis: {
                title: "Chassis",
                name: "chassis",
                icon: "la la-truck-loading",
                display: function() { return views.chassis(); },
                function: function() { CHASSIS.FUNCTION.init() },
                buttons: {
                    table: getClientTableButtons("chassis"),
                    row: ["edit","delete"]
                }
            },
            regions: {
                title: "Regions",
                name: "regions",
                icon: "la la-map-marked-alt",
                display: function() { return views.regions(); },
                function: function() { LOCATIONS.FUNCTION.regions.init() },
                menu_group: {
                    title: "Locations",
                },
                buttons: {
                    table:["create","refresh","column"],
                    row:["edit","delete"]
                }
            },
            clusters: {
                title: "Clusters",
                name: "clusters",
                icon: "la la-sitemap",
                display: function() { return views.clusters(); },
                function: function() { LOCATIONS.FUNCTION.clusters.init() },
                buttons: {
                    table:["create","refresh","column"],
                    row: getRowButtons("clusters")
                }
            },
            geofences: {
                title: "Sites",
                name: "geofences",
                icon: "la la-warehouse",
                display: function() { return views.geofences(); },
                function: function() { LOCATIONS.FUNCTION.geofences.init() },
                buttons: {
                    table:["refresh","filter","column"],
                    row: ((USER.role == "developer") ? ["edit","delete"] : ["edit"])
                }
            },
            routes: {
                title: "Routes",
                name: "routes",
                icon: "la la-route",
                display: function() { return views.routes(); },
                function: function() { LOCATIONS.FUNCTION.routes.init() },
                buttons: {
                    table:["create","refresh","search"],
                    row:["edit","delete"]
                }
            },
            calendar: {
                title: "Calendar",
                name: "calendar",
                icon: "la la-calendar",
                display: function() { return views.calendar(); },
                function: function() { CALENDAR.init() },
                buttons: {
                    table:["create","refresh","search"],
                    row:["edit","delete"]
                }
            },
            eco_driving: {
                title: "Eco Driving",
                name: "eco_driving",
                icon: "la la-calendar",
                display: function() { return views.eco_driving(); },
                function: function() { ECO_DRIVING.FUNCTION.init() },
                buttons: {
                    table: ["refresh","export","filter","search","summary"],
                    row:["view"]
                },
                menu_group: {
                    title: "Events",
                }
            },
            eco_driving_summary: {
                title: "Eco Driving Summary",
                name: "eco_driving_summary",
                icon: "la la-calendar",
                display: function() { return views.eco_driving(); },
                function: function() { ECO_DRIVING.FUNCTION.init() },
                buttons: {
                    table: ["refresh","export","filter","search","summary"],
                    row:["view"]
                },
                menu_group: {
                    title: "Events",
                }
            },
            otd_events: {
                title: "OTD",
                name: "otd_events",
                icon: "la la-calendar",
                display: function() { return views.otd_events(); },
                function: function() { OTD_EVENTS.FUNCTION.init() },
                buttons: {
                    table: ["refresh","export","filter","search"],
                    row:["view"]
                },
            },
            cico_events: {
                title: "Check IN, Check Out",
                name: "cico_events",
                icon: "la la-calendar",
                display: function() { return views.cico_events(); },
                function: function() { CICO_EVENTS.FUNCTION.init() },
                buttons: {
                    table: ["refresh","export","filter","search"],
                    row:["view"]
                },
            },
            all_events: {
                title: "All Events",
                name: "all_events",
                icon: "la la-calendar",
                display: function() { return views.all_events(); },
                function: function() { ALL_EVENTS.FUNCTION.init() },
                buttons: {
                    table: ["refresh","export","filter","search"],
                    row:["view"]
                },
                menu_group: {
                    title: "For Developers",
                }
            },
            changelog: {
                title: "Changelog",
                name: "changelog",
                icon: "la la-tasks",
                display: function() { return views.changelogs(); },
                function: function() { CHANGELOG.FUNCTION.init() },
            },
            profile: {
                title: "Profile",
                name: "profile",
                icon: "la la-user",
                display: function() { return views.profile(); },
                function: function() { PROFILE.FUNCTION.init() },
                allowOnMobile:true
            },
            settings: {
                title: "Settings",
                name: "settings",
                icon: "la la-cog",
                display: function() { return views.settings(); },
                function: function() { SETTINGS.FUNCTION.init() },
                allowOnMobile:true
            },
            logout: {
                title: "Logging out...",
                display: function() { return LOADING.SPINNER.UI(); },
                function: function() { LOGOUT() },
                allowOnMobile:true
            },
            default: {
                title: "Profile",
                display: function() { return views.profile(); },
                function: function(goto) {
                    var new_go_to = (PAGE.EXISTING.includes(goto)) ? PAGE.DEFAULT() : "profile";
                    window.history.pushState({}, null, `#${new_go_to}`)
                    PAGE.GO_TO();
                },
                allowOnMobile:true
            },
        };
    }
};
GET.STATUS = function(status=""){
    var stat = { color: "label-default", text: "" };
    if(status == "plan") stat = { color: "label-info", text: "Plan" }; // light blue
    if(status == "assigned") stat = { color: "label-brown", text: "Assigned" }; // brown
    // if(status == "dispatched") stat = { color: "label-lime", text: "Dispatched" }; // lime
    if(status == "scheduled") stat = { color: "label-default", text: "Scheduled" }; // default
    if(status == "queueingAtOrigin") stat = { color: "label-warning", text: "Queueing (Origin)" }; // yellow
    if(status == "processingAtOrigin") stat = { color: "label-lime", text: "Processing (Origin)" }; // lime
    if(status == "idlingAtOrigin") stat = { color: "label-purple", text: "Idling (Origin)" }; // purple

    if(status == "in_transit") stat = { color: "label-orange", text: "In Transit" }; // orange
    if(status == "onDelivery") stat = { color: "label-orange", text: "On Delivery" }; // orange

    if(status == "onSite") stat = { color: "label-blue", text: "On-Site" }; // blue
    if(status == "returning") stat = { color: "label-pink", text: "Returning" }; // pink
    if(status == "complete") stat = { color: "label-success", text: "Complete" }; // green
    if(status == "incomplete") stat = { color: "label-danger", text: "Incomplete" }; // red
    if(status == "incompleteByReturningToOrigin") stat = { color: "label-danger", text: "Incomplete (Returned to Origin)" }; // red
    if(status == "deleted") stat = { color: "label-default", text: "Deleted" }; // gray
    
    return {
        html:`<span class="label ${stat.color} label-transparent">${stat.text.toUpperCase()}</span>`,
        color: stat.color,
        text: stat.text
    };
};
var FILTER = {
    INITIALIZE: function(el,start,end,format='MM/DD/YYYY'){
        var start_formatted = DATETIME.FORMAT(new Date(start),format),
            end_formatted = DATETIME.FORMAT(new Date(end),format);
        // console.log(start_formatted,end_formatted,format,format.indexOf("h:mm") > -1);
        if(start_formatted == end_formatted){
            if(format.indexOf("h:mm") > -1){
                start_formatted = moment(new Date(start)).startOf('day').format(format);
                end_formatted = moment(new Date(end)).endOf('day').format(format);
                $(el).val(`${start_formatted} - ${end_formatted}`);
            } else {
                $(el).val(start_formatted);
            }
        } else {
            $(el).val(`${start_formatted} - ${end_formatted}`);
        }
        $(el).data('daterangepicker').setStartDate(start_formatted);
        $(el).data('daterangepicker').setEndDate(end_formatted);
    },
    CLICK: function( table, urlPath, simpleTableFilter, elements ){
        $(`#filter-btn`).click(function(){
            var _filter = {};

            elements.forEach(val => {
                var value = $(val.id).val();
                if(value){
                    if(val.type == 'date')
                        _filter[val.key] = FILTER.DATE(value);
                    
                    if(val.type == 'string'){
                        if (typeof val.customValue === 'function') { 
                            var _value = val.customValue(value);
                            _value ? _filter[val.key] = _value : null; 
                        }
                        else  _filter[val.key] = value;
                    }
    
                    if(val.type == 'number')
                        _filter[val.key] = Number(value);
    
                    if(val.type == 'array')
                        _filter[val.key] = { $in: value };
                }
            });

            FILTER.STATUS = "new";

            USER.filters[urlPath] = _filter;

            table.dt.clear().draw();

            if(simpleTableFilter){
                var filtered = LIST[urlPath].filter(x => {
                    var condition = true;
                    Object.keys(_filter).forEach(key => {
                        (x[key] != _filter[key]) ? condition = false : null;
                    });
                    return condition;
                });
                table.populateRows(filtered);
                table.hideProgressBar();
            } else {
                $(this).html(`<i class="la la-spinner la-spin"></i> Apply`).addClass("disabled");
                table.countRows();
            }
        });

        $(`#save-btn`).click(function(){
            USER.filters[urlPath] = USER.filters[urlPath] || {};

            var data = {};
            var filter = {};
            var userDefinedFilter = USER.filters[urlPath];
    
            if(typeof userDefinedFilter == 'string'){
                try { filter = JSON.parse(USER.filters[urlPath]) } catch(error) {}
            }
            if(typeof userDefinedFilter == 'object'){
                filter = userDefinedFilter;
            }

            data[`filter.${urlPath}`] = JSON.stringify(filter);

            console.log(filter);
    
            $.ajax({
                url: `/api/users/${CLIENT.id}/${USER.username}/${USER.username}`,
                method: "put",
                headers: {
                    "Content-Type": "application/json; charset=utf-8",
                    "Authorization": SESSION_TOKEN
                },
                data: JSON.stringify(data)
            }).done(docs => {
                toastr.success("Filter saved!");
            }).fail(error => {
                console.log("Error",error);
            });  
        });
    },
    ISEMPTY: function(x){
        var emptyFilter = true;
        x.forEach(val => {
            if(val === false) emptyFilter = false;
        });
        if(emptyFilter === true) $(`#filter-btn,#reset-btn`).addClass("disabled");

        return emptyFilter;
    },
    CHECKING: function(x){
        x.dateEl = x.dateEl || [];
        x.dateElnoVal = x.dateElnoVal || [];
        x.selectEl = x.selectEl || [];
        if($(x.dateEl[0]).length > 0 || $(x.dateElnoVal[0]).length > 0 || $(x.selectEl[0]).length > 0){
            var arr = [];
            x.dateEl.forEach(el => { arr.push($(el).val() == DEFAULT_DATE); });
            x.dateElnoVal.forEach(el => { arr.push($(el).val().isEmpty()); });
            x.selectEl.forEach(el => { arr.push($(el).val() == "all"); });
            if(!x.isPopulate && FILTER.ISEMPTY(arr) === true) {
                $(`#filter-btn,#reset-btn`).addClass("disabled");
                if(FILTER.STATUS != "reset"){
                    $(`#reset-btn`).removeClass("disabled");
                }
            } else {
                $(`#filter-btn`).removeClass("disabled");
            }
        }
    },
    CALLBACK: null,
    DATE: function(__date=DATETIME.FORMAT(new Date(),"MM/DD/YYYY")){
        var _date = new Date(__date),
            dateStart = _date.setHours(0,0,0,0),
            dateEnd = _date.setHours(23,59,59,999);
        return {
            start: new Date(dateStart).toISOString(), 
            end: new Date(dateEnd).toISOString()
        };
    },
    convertTZ: function(date, tzString){
        // convertTZ(_date,"Asia/Manila")
        return new Date((typeof date === "string" ? new Date(date) : date).toLocaleString("en-US", {timeZone: tzString}));
    },
    DATERANGE: function(__date=DATETIME.FORMAT(new Date(),"MM/DD/YYYY")){
        var _date = __date.split(" - "),
            _date1 = new Date(_date[0]),
            _date2 = (_date[1]) ? new Date(_date[1]) : new Date(_date[0]),
            hasTime0 = false,
            hasTime1 = false;

        ((_date[0]||"").indexOf(":") > -1) ? hasTime0 = true : null;
        ((_date[1]||"").indexOf(":") > -1) ? hasTime1 = true : null;
            
        _date1 = moment(_date1).startOf('minute');
        _date2 = moment(_date2).endOf('minute');

        if(!hasTime0) _date1 = moment(_date1).startOf('day');
        if(!hasTime1) _date2 = moment(_date2).endOf('day');

        if(new Date(_date1).getTime() == new Date(_date2).getTime()){
            _date1 = moment(_date1).startOf('day');
            _date2 = moment(_date2).endOf('day');
        }
        // console.log(_date1,_date2)
        
        return {
            $gte: _date1.toISOString(),
            $lt: _date2.toISOString()
        };
    },
    RESET: function(x){
        $(`#reset-btn`).click(function(){
            FILTER.STATUS = "reset";
            // $(`#filter-btn,#reset-btn`).addClass("disabled");
            if(x.dateEl || x.dateElnoVal){
                if($(x.dateEl).data('daterangepicker')){
                    try { $(x.dateEl).data('daterangepicker').setStartDate(DEFAULT_DATE); } catch (error) {}
                    try { $(x.dateEl).data('daterangepicker').setEndDate(DEFAULT_DATE); } catch (error) {}
                } else {
                    try { 
                        x.dateEl.split(",").forEach(val => {
                            $(`${val} [name="start"],${val} [name="end"]`).datepicker("setDate",new Date(DEFAULT_DATE));
                        });
                    } catch (error) {}
                }
                if($(x.dateElnoVal).data('daterangepicker')){
                    try { $(x.dateElnoVal).data('daterangepicker').setStartDate(DEFAULT_DATE); } catch (error) {}
                    try { $(x.dateElnoVal).data('daterangepicker').setEndDate(DEFAULT_DATE); } catch (error) {}
                } else {
                    try { $(x.dateElnoVal).datepicker("setDate",new Date(DEFAULT_DATE)); } catch (error) {}
                    try { 
                        x.dateElnoVal.split(",").forEach(val => {
                            $(`${val} [name="start"],${val} [name="end"]`).datepicker("setDate","");
                        });
                    } catch (error) {}
                }
    
                if(x.dateEl) $(x.dateEl).removeClass('x onX').val(DEFAULT_DATE).change().blur();
                if(x.dateElnoVal) $(x.dateElnoVal).removeClass('x onX').val('').change().blur();
            }

            $(`[calendarview="day"]`).trigger("click");

            // if(x.dateEl || x.dateElnoVal){
            //     $(x.dateEl).data('daterangepicker').setStartDate(DEFAULT_DATE);
            //     $(x.dateEl).data('daterangepicker').setEndDate(DEFAULT_DATE);
            //     if(x.dateEl) $(x.dateEl).removeClass('x onX').val(DEFAULT_DATE).change().blur();
            //     if(x.dateElnoVal) $(x.dateElnoVal).removeClass('x onX').val('').change().blur();
            // }
            if(x.selectEl){
                $(x.selectEl).val("all").trigger("change");
            }

            var data = {};
            data[`filter.${x.urlPath}`] = JSON.stringify({});
            USER.filters[x.urlPath] = {};
            GET.AJAX({
                url: `/api/users/${CLIENT.id}/${USER.username}/${USER.username}`,
                method: "PUT",
                headers: {
                    "Content-Type": "application/json; charset=utf-8",
                    "Authorization": SESSION_TOKEN
                },
                data: JSON.stringify(data)
            }, function(docs){
                console.log("docs1",docs);
            });

            if (typeof x.populateTable === 'function') { x.populateTable(); }
        });
    },
    STATUS: "new",
    APPROVAL: {
        dispatch: function(docs=[],dt,rowData){
            var filter = USER.filters.dispatch || {};

            try {
                filter = JSON.parse(filter);
            } catch(error){}

            console.log(filter);
            // departure_date
            // posting_date
            // status
            // region - NONE YET
            // cluster - NONE YET
            var rows = [];
            docs.forEach(val => {
                var approved = true;
                if(filter.departure_date){
                    if(val.departure_date){
                        var gte = new Date(filter.departure_date.$gte).getTime();
                        var lt = new Date(filter.departure_date.$lt).getTime();
                        var date = new Date(val.departure_date).getTime();
                        // gte: march 01
                        // lt:  march 25
                        // date: march 15
                        // gte <= date && date < lt
                        if(gte <= date && date < lt){} 
                        else {
                            approved = false;
                        }
                    } else {
                        approved = false;
                    }
                }
                if(filter.posting_date){
                    if(val.posting_date){
                        var gte = new Date(filter.posting_date.$gte).getTime();
                        var lt = new Date(filter.posting_date.$lt).getTime();
                        var date = new Date(val.posting_date).getTime();
                        if(gte <= date && date < lt){} 
                        else {
                            approved = false;
                        }
                    } else {
                        approved = false;
                    }
                }
                if(filter.scheduled_date){
                    if(val.scheduled_date){
                        var gte = new Date(filter.scheduled_date.$gte).getTime();
                        var lt = new Date(filter.scheduled_date.$lt).getTime();
                        var date = new Date(val.scheduled_date).getTime();
                        if(gte <= date && date < lt){} 
                        else {
                            approved = false;
                        }
                    } else {
                        approved = false;
                    }
                }
                if(filter.status){
                    if(filter.status == val.status){}
                    else {
                        approved = false;
                    }
                }
                
                if(approved){
                    if(filter.$or){
                        approved = false;
                        filter.$or.forEach(_f => {
                            if(_f.posting_date){
                                if(val.posting_date){
                                    var gte = new Date(_f.posting_date.$gte).getTime();
                                    var lt = new Date(_f.posting_date.$lt).getTime();
                                    var date = new Date(val.posting_date).getTime();
                                    if(gte <= date && date < lt){
                                        approved = true;
                                    }
                                }
                            }
                            if(_f.scheduled_date){
                                if(val.scheduled_date){
                                    var gte = new Date(_f.scheduled_date.$gte).getTime();
                                    var lt = new Date(_f.scheduled_date.$lt).getTime();
                                    var date = new Date(val.scheduled_date).getTime();
                                    if(gte <= date && date < lt){
                                        approved = true;
                                    }
                                }
                            }
                            if(_f.status){
                                if(_f.status == val.status){
                                    approved = true;
                                }
                            }
                            if(_f.$and){
                                _f.$and.forEach(_f2 => {
                                    console.log("HIIII",_f2)
                                    if(_f2.scheduled_date){
                                        if(val.scheduled_date){
                                            var gte = new Date(_f2.scheduled_date.$gte).getTime();
                                            var lt = new Date(_f2.scheduled_date.$lt).getTime();
                                            var date = new Date(val.scheduled_date).getTime();
                                            if(gte <= date && date < lt){
                                                approved = true;
                                            }
                                        }
                                    }
                                });
                            }
                        });
                    }
                }
                
                if(approved){
                    rows.push(rowData(val));
                }
            });
            dt.rows.add(rows).draw(false);
        }
    }
};
var SLIDER = {
    FILTER: function(filterOptionsHTML){
        return `<div id="filter-container" class="slider-container" style="display:none;">
                    <h5 class="pl-3">Filter<i id="slider-close" class="la la-times" style="float: right;font-size: 13px;line-height: 20px;padding: 0px 8px;cursor: pointer;"></i></h5>
                    <div class="p-3" style="border-top: 1px solid #eee;">
                        ${filterOptionsHTML}
                        <button id="filter-btn" style="width: 100%;" class="btn btn-success mt-3">Apply</button>
                        <a href="javascript:void(0)" id="reset-btn" style="font-size: 11px;width: max-content;margin: auto;" class="text-success p-2 d-block">Reset filters</a>
                    </div>
                </div>`;
    },
    CLONE: function(cloneOptionsHTML){
        return `<div id="clone-container" class="slider-container" style="display:none;">
                    <h5 class="pl-3">Clone Live Data<i id="slider-close" class="la la-times" style="float: right;font-size: 13px;line-height: 20px;padding: 0px 8px;cursor: pointer;"></i></h5>
                    <div class="p-3" style="border-top: 1px solid #eee;">
                        ${cloneOptionsHTML}
                        <button id="clone-btn" style="width: 100%;" class="btn btn-success mt-3">Apply</button>
                    </div>
                </div>`;
    },
    COLUMN_VISIBILITY: function(x){
        var checkbox = "";
        x.forEach((val,i) => {
            var fancyClass = (val.disabled)?"":"custom-bgcolor-green",
                pointerEvent = (val.disabled)?`style="pointer-events: none;"`:"",
                visible = (val.visible)?"checked":"";
            if(!val.hiddenInCustomVisibilityOptions) {
                checkbox += `<div class="fancy-checkbox ${fancyClass}" ${pointerEvent}>
                                <label>
                                    <input type="checkbox" ${visible}>
                                    <span class="toggle-vis" data-column="${i}">${val.title}</span>
                                </label>
                            </div>`;
            }
        });
        return `<div id="cv-container" class="slider-container" style="display:none;">
                    <h5 class="pl-3">Customize Display Options<i id="slider-close" class="la la-times" style="float: right;font-size: 13px;line-height: 20px;padding: 0px 8px;cursor: pointer;"></i></h5>
                    <div class="p-3" style="border-top: 1px solid #eee;">
                    ${checkbox}
                    </div>
                </div>`;
    },
    EXPORT: function(){
        return `<div id="export-container" class="slider-container" style="display:none;">
                    <h5 class="pl-3">Export Options<i id="slider-close" class="la la-times" style="float: right;font-size: 13px;line-height: 20px;padding: 0px 8px;cursor: pointer;"></i></h5>
                    <div class="p-3" style="border-top: 1px solid #eee;"></div>
                </div>`;
    },
    MORE_INFO: {
        view: function(x){
            // delete existing more-info-container's
            $(`.more-info-container`).each((i,el) => {
                $(el).hide("slide", {direction:'right'},100, function(){
                    $(el).remove();
                });
            });

            var headerRightHTML = `<i id="close-btn" class="custom-btn-03 la la-times ml-2" data-toggle="tooltip" data-original-title="Close" data-placement="bottom"></i>`;
            (x.headerRightButtons||[]).forEach(val => {
                headerRightHTML += `<i id="${val.id}" class="custom-btn-03 la ${val.icon} ml-2" data-toggle="tooltip" data-original-title="${val.title}" data-placement="bottom"></i>`;
            });

            return `<div id="${x._row||""}container" class="more-info-container slider-container" style="display:none;width: 70%;">
                        <div class="status-details col-sm-12" style="padding: 10px 15px !important;border-top: aliceblue;border-bottom: 1px solid #eee;">
                            <div class="float-left">
                                <div class="main-details-header">${x.headerLeftHTML||""}</div>
                                <div class="log-details-header" style="display:none;"><span style="font-size: 20px;">Logs</span></div>
                            </div>
                            <div class="header-right-button float-right">${headerRightHTML||""}</div>
                        </div>
                        <div style="border-top: 1px solid #eee;">
                            <div class="main-details col-sm-12" style="padding: 15px 0px 10px 20px !important;overflow-y: auto;">
                                ${x.bodyTitleHTML || ""}
                                ${x.bodyContentHTML || ""}
                            </div>
                            <div class="log-details col-sm-12" style="padding: 15px 0px 10px 20px !important;overflow-y: auto;display:none;">
                                <div id="history-logs"></div>
                            </div>
                        </div>
                    </div>`;
        },
        buttons: function(goto,options){
            options = options || {};
            var status = options.status,
                loadView = options.loadView || [],
                username = options.username,
                deleteArr = options.deleteArr || [],
                permission = PERMISSION[goto] || {},
                buttons = [],
                buttonDetails = {
                    print: {
                        permission: "read",
                        icon: "la-print",
                        title: "Print",
                        id: "print-btn"
                    },
                    logs: {
                        permission: "read",
                        icon: "la-history",
                        title: "Logs",
                        id: "logs-btn"
                    },
                    delete: {
                        permission: "delete",
                        icon: "la-trash",
                        title: "Delete",
                        id: "delete-btn"
                    },
                    edit: {
                        permission: "update",
                        icon: "la-edit",
                        title: "Edit",
                        id: "edit-btn"
                    },
                },
                permissionValid = function(type){
                    console.log("permission[type]",permission[type],username);
                    var valid = false;
                    if(permission[type] == "all" || (permission[type] == "self" && username == USER.username)){
                        valid = true;
                    }
                    return valid;
                };
            ((PAGE_FUNCTIONALITIES[goto].buttons||{}).modalButtons||[]).forEach(val => {
                var button = buttonDetails[val];
                if(button){
                    function shouldDelete(){
                        var delete_ = false;
                        deleteArr.forEach(val_ => {
                            if(val_.button == val && val_.byPassCondition){
                                delete_ = true;
                            } else {
                                if(val_.button == val && (val_.status||[]).includes(status)){
                                    delete_ = true;
                                }
                            }
                        });
                        return delete_;
                    }
                    if(permissionValid(button.permission) && !shouldDelete()) {
                        (loadView.includes(val)) ? button.icon = "la-spin la-spinner" : null;
                        buttons.push(button);
                    }
                }
            });
    
            return { buttons };
        },
        listeners: function(x){
            var table_id = x.table_id,
                _row = x._row,
                _id = x._id,
                urlPath = x.urlPath,
                deleteURL = x.deleteURL || `/api/${urlPath}/${CLIENT.id}/${USER.username}/${_id}`,
                editCallback = x.editCallback || function(){
                    var obj = LIST[urlPath].find(y => y._id.toString() == _id.toString());
                    x.initializeModal({
                        url: `/api/${urlPath}/${CLIENT.id}/${USER.username}/${_id}`,
                        method: "put",
                        obj
                    });
                };
            $(`#${_row}container #edit-btn`).click(function(e){
                e.stopImmediatePropagation();
                editCallback();
            });
            $(`#${_row}container #delete-btn`).click(function(e){
                MODAL.CONFIRMATION({
                    confirmCloseCondition: true,
                    content: x.deleteModalContent,
                    confirmCallback: function(){
                        $.ajax({ 
                            url: deleteURL, 
                            method: "delete", 
                            timeout: 90000, 
                            headers: {
                                "Authorization": SESSION_TOKEN
                            },
                            async: true
                        }).done(function (docs) {
                            if(docs.ok == 1){
                                $(`#confirm-modal,#${_row}container`).remove();
                                (table_id) ? $(table_id).DataTable().row(`[_row="${_row}"]`).remove().draw(false) : null;
                                TOASTR.DELETEDSUCCESSFULLY();
                            } else {
                                TOASTR.UNAUTHORIZED(docs);
                            }
                        }).fail(function(error){
                            console.log("Error:",error);
                        });
                    }
                });
            });
            $(`#${_row}container #logs-btn`).click(function(e){
                e.stopImmediatePropagation();
                if($(`.main-details,.main-details-header`).is(":hidden")){ // show main details
                    $(this).removeClass("active");
                    $(`.main-details,.main-details-header`).show();
                    $(`.log-details,.log-details-header`).hide();
                    $(`.header-right-button i`).each((i,el) => { $(el).show(); });
                } else { // show logs
                    var obj = LIST[urlPath].find(x => x._id == _id) || {};
                    $(`#history-logs`).html(HISTORY.view(obj.history,LIST["users"]));

                    $(this).addClass("active");
                    $(`.main-details,.main-details-header`).hide();
                    $(`.log-details,.log-details-header`).show();
                    $(`.header-right-button i`).each((i,el) => {
                        if(!["logs-btn","close-btn"].includes($(el).attr("id"))){
                            $(el).hide();
                        }
                    });
                }
            });
        }
    }
};
var MODAL = {
    CONFIRMATION: function(data){
        var content = data.content || `Are you sure you want to delete this entry?`;
        var confirmBGStyle = data.confirmBGStyle || ``;
        var _modal = `<div class="cd-popup" id="confirm-modal">
                        <div class="cd-popup-container">
                            <p class="mb-0">${content}</p>
                            <ul class="cd-buttons">
                                <li><a style="${confirmBGStyle}" confirm>${data.confirmButtonText || "Yes"}</a></li>
                                <li><a cancel>No</a></li>
                            </ul>
                            <a close class="cd-popup-close img-replace"></a>
                        </div>
                    </div>`;
                    
        $(`body`).append(_modal);

        $(`#confirm-modal [confirm]`).click(function(){
            $(`#confirm-modal [confirm]`).html(`<i class="la la-spinner la-spin mr-2"></i>${data.confirmButtonText || "Yes"}`).addClass("disabled");
            if (typeof data.confirmCallback === 'function') { data.confirmCallback(); }
            if (data.confirmCloseCondition !== true) { $(`#confirm-modal`).remove(); }
        });
        $(`#confirm-modal [cancel],#confirm-modal [close]`).click(function(){
            if (typeof data.cancelCallback === 'function') { data.cancelCallback(); }
            $(`#confirm-modal`).remove();
        });          
    },
    CONFIRMATION_W_FIELD: function(data){
        var content = data.content || `Are you sure you want to delete this entry?`;
        var confirmBGStyle = data.confirmBGStyle || ``;
        var _modal = `<div class="cd-popup" id="confirm-modal">
                        <div class="cd-popup-container">
                            <div class="pt-5 pb-4">${content}</div>
                            <div class="col-sm-12 mb-3">
                                <textarea class="form-control" id="modal-field"></textarea>
                            </div>
                            <ul class="cd-buttons">
                                <li><a style="${confirmBGStyle}" confirm>${data.confirmButtonText || "Yes"}</a></li>
                                <li><a cancel>${data.cancelButtonText || "No"}</a></li>
                            </ul>
                            <a close class="cd-popup-close img-replace"></a>
                        </div>
                    </div>`;
        $(`body`).append(_modal);
        $(`#confirm-modal [confirm]`).click(function(){
            var field_val = $(`#modal-field`).val();

            if(field_val.isEmpty()){} 
            else {
                $(`#confirm-modal [confirm]`).html(`<i class="la la-spinner la-spin mr-2"></i>${data.confirmButtonText || "Yes"}`).addClass("disabled");
                if (typeof data.confirmCallback === 'function') { data.confirmCallback($(`#modal-field`).val()); }
                if (data.confirmCloseCondition !== true) { $(`#confirm-modal`).remove(); }
            }
        });
        $(`#confirm-modal [cancel],#confirm-modal [close]`).click(function(){
            if (typeof data.cancelCallback === 'function') { data.cancelCallback(); }
            $(`#confirm-modal`).remove();
        });          
    },
    MINI_MONITOR: function(x){
        var container = `<div class="col-sm-12 mt-2" style="height: 100%;overflow: auto;">
                            <div class="table-wrapper">
                                <table id="tbl-mini-monitor" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>`;
        if(ISMOBILE) {
            container = `<div id="mini-monitor-container" class="col-sm-12 p-0" style="max-height: 100%;overflow: auto;"></div>`;
        }
        return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                    <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                        <div role="document" class="modal-dialog" style="width: 100%;margin: 0;height: 100%;">
                            <div class="modal-content" style="height: 100%;">
                                <div class="modal-header pb-2">
                                    <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                    <h4 class="modal-title" id="myModalLabel2">${x.title}</h4>
                                </div>
                                <div class="modal-body row pt-2" style="height: calc(100% - 70px);">${container}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
    },
    CREATE: {
        EMPTY: function( title="Modal", html="", modalSize="lg" ){
            return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                        <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                            <div role="document" class="modal-dialog modal-${modalSize}" style="margin:20px auto;">
                                <div class="modal-content">
                                    <div class="modal-header pb-2">
                                        <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                        <h4 class="modal-title" id="myModalLabel2">${title}</h4>
                                    </div>
                                    <div class="modal-body row pl-4 pr-4 pt-2">
                                        ${html}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
        },
        BASIC: function(x){
            var inputs = "";

            x.el.forEach(val => {
                var _reqHtml = (val.required) ? `<span class="text-danger">*</span>` : "",
                    required = (val.required) ? `required` : "",
                    attr = val.attr || "",
                    readonly = (val.readonly) ? `readonly` : "",
                    disabled = (val.disabled) ? `disabled="disabled"` : "",
                    notInclude = (val.notInclude) ? `time=true` : "",
                    type = val.type||"text",
                    multiple = val.multiple || false,
                    value = val.value||"",
                    sub_title = (val.sub_title) ? `<small class="text-muted mb-1 d-block">${val.sub_title}</small>` : "",
                    placeholder = val.placeholder || "";
                if(type == "select"){
                    val.value = val.value || [];

                    var options = (val.noDefault) ? "" : `<option value="" disabled selected>Select ${val.title}</option>`;
                    val.options.forEach(op => {
                        var selected = (value.includes(op.id)) ? "selected" : "";
                        options += `<option value="${op.id}" ${selected}>${op.value || op.id}</option>`;
                    });
                    inputs += `<div class="col-sm-12">
                                    <small>${_reqHtml}${val.title}:</small>
                                    <select id="${val.id}" class="form-control" ${attr} ${required} ${readonly} ${disabled}>${options}</select>
                                </div>`;
                } else if(type == "select2"){
                    var options = ``,
                        selectClass = (multiple === true) ? "select-multiple-basic" : "select-basic",
                        selectAttr = (multiple === true) ? `multiple="multiple"` : "";
                    val.value = val.value || [];
                    val.options = val.options || [];
                    val.options.forEach(op => {
                        var selected = (val.value.includes(op.id)) ? "selected" : "";
                        options += `<option value="${op.id}" ${selected}>${op.value || op.id}</option>`;
                    });
                    inputs += `<div class="col-sm-12">
                                    <small>${_reqHtml}${val.title}:</small>
                                    <select id="${val.id}" class="${selectClass}" ${selectAttr} style="width: 100%;" ${attr} ${required} ${disabled}>${options}</select>
                                    ${sub_title}
                                </div>`;
                } else if(type == "time") {
                    var hh_mm = DATETIME.HH_MM(null,val.value);
                    inputs += `<div class="col-sm-12 mb-4">
                                    <small>${_reqHtml}${val.title}:</small>
                                    <div class="form-control">
                                        <input id="${val.id}-hh" time=true type="number" class="wo_arrow" step="any" min="0" value="${hh_mm.hour}" style="border:none;width: 48%;text-align: center;background: transparent;" placeholder="HH">:<input type="number" id="${val.id}-mm" class="wo_arrow" time=true step="any" min="0" value="${hh_mm.minute}" style="border:none;width: 48%;text-align: center;background: transparent;" placeholder="MM">
                                        <input id="${val.id}" type="number" value="${val.value}" class="hidden">
                                    </div>
                                </div>`;
                } else if(type == "textarea") {
                    inputs += `<div class="col-sm-12">
                                    <small>${_reqHtml}${val.title}:</small>
                                    <textarea id="${val.id}" class="form-control" ${attr} ${notInclude} ${required} ${readonly} ${disabled}></textarea>
                                </div>`;
                } else {
                    inputs += `<div class="col-sm-12">
                                    <small>${_reqHtml}${val.title}:</small>
                                    <input id="${val.id}" type="${type}" ${attr} class="form-control" placeholder="${placeholder}" value="${value}" autocomplete="off" ${required} ${readonly}>
                                    ${sub_title}
                                </div>`;
                }
            });

            var content = inputs;
            if(x.columned){
                content = `<div class="${x.column1Style||"col-sm-6"}">${inputs}</div>
                            <div class="${x.column2Style||"col-sm-6"}">${x.column2Content}</div>`;
            }
            return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                        <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                            <div role="document" class="modal-dialog modal-sm" style="${x.modalStyle||""}">
                                <div class="modal-content">
                                    <div class="modal-header pb-2">
                                        <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                        <h4 class="modal-title" id="myModalLabel2">${x.title}</h4>
                                    </div>
                                    <div class="modal-body row pt-2">
                                        <div id="modal-error"></div>
                                        ${content}
                                        <div class="col-sm-12"> 
                                            <button id="submit" type="button" class="btn btn-primary col-sm-12 mt-4">Submit</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
        },
    },
    TABLEVIEW: function(){
        var tr = `width: 50%;float: left !important;padding-bottom: 2px;`;
        var tdFirst = `style="width: 200px;font-weight: bold;vertical-align:top;"`;
        return {
            tr,
            tdFirst,
            empty:  `<tr style="${tr}">
                        <td ${tdFirst}>&nbsp;</td>
                        <td>&nbsp;</td>
                    </tr>`,
            getTr: (key,value,color="",attr="",customTr,customtdFirst) => {
                return `<tr style="${customTr||tr} ${color}">
                            <td ${customtdFirst||tdFirst}>${key}</td>
                            <td ${attr}>${(value?`: ${value}`:": -")}</td>
                        </tr>`
            }
                
        };
    },
    FIELDCHECK: function(id,value,errorCallback){
        var css_default = {"background-color":"white"},
            css_error = {"background-color":"#ffe4e4"},
            condition = false;

        if(value != null){
            if(typeof value == 'string' && (value||"")._trim()) condition = true;
            if(typeof value == 'number' && value != null) condition = true;
            if(typeof value == 'object' && Object.keys(value).length > 0) condition = true;
            if($.isArray(value) && value.length > 0) condition = true;
        }

        if(condition === true) {
            $(`#${id}`).css(css_default);
            $(`#${id}`).next(".select2-container").find(".select2-selection").css(css_default);
            $('[name="'+id+'"]').parents('.radio-parent').css(css_default);
        } else {
            $(`#${id}`).css(css_error);
            $(`#${id}`).next(".select2-container").find(".select2-selection").css(css_error);
            $('[name="'+id+'"]').parents('.radio-parent').css(css_error);
            try { $(`#${id}`).get(0).scrollIntoView(); } catch(error) {}
            if (typeof errorCallback === 'function') { errorCallback(); }
        }
    },
    SUBMIT: function(x,options,additionalValues){
        $(`#submit`).click(function(){
            $(`#modal-error`).hide();
            var body = {},
                css_default = {"background-color":"white"},
                css_error = {"background-color":"#ffe4e4"},
                completeFields = true;
            $(`#modal :input[type="text"],#modal :input[type="number"],#modal :input[type="email"],#modal select`).each((i,el) => {
                var defaultValue = ($(el).is("select")) ? [] : ($.isNumeric(($(el).val())) ? 0 : "");
                
                if($(el).attr("doNotSave") == null){
                    if($(el).attr("blankStringIfEmpty") != null){
                        defaultValue = "";
                    }
                    var _el = {
                        id: $(el).attr("id"),
                        value: $(el).val() || defaultValue,
                        valueTemp: $(el).val() || defaultValue,
                        time: $(el).attr("time"),
                        required: $(el).attr("required"),
                    };
                    if(_el.id){
                        if(_el.id == "phoneNumber"){
                            _el.value = GET.INTLTELINPUT_VALUE("#phoneNumber");
                        }
                        if(!_el.time) {
                            // if time-true, ignore
                            body[_el.id] = _el.value;
                        }
                    } else {
                        var id = $(el).parents("table").attr("id");
                        _el.id = id;
                        if(!body[_el.id]){
                            var trs = $(el).parents("table").find("tr");
                            trs.each((i1,el1) => {
                                var inputs = $(el1).find("input");
                                var _tdData = {};
                                inputs.each((i2,el2) => {
                                    var attr = $(el2).attr("_attr");
                                    if(attr.substring(0, 3) != "___"){
                                        _tdData[attr] = $(el2).val() || "";
                                    }
                                });
                                if(!body[_el.id]){
                                    body[_el.id] = [];
                                }
                                if(Object.keys(_tdData).length > 0){
                                    body[_el.id].push(_tdData);
                                }
                            });
                        }
                    }
                    if(_el.required && _el.valueTemp.isEmpty()) {
                        $(el).css(css_error);
                        $(el).next(".select2-container").find(".select2-selection").css(css_error);
                        completeFields = false;
                    } else {
                        $(el).css(css_default);
                        $(el).next(".select2-container").find(".select2-selection").css(css_default);
                    }
                }
            });
            
            if (typeof additionalValues === 'function') { 
                console.log("additionalValues()",additionalValues())
                body = $.extend(body,additionalValues());
            }
            if(!completeFields) {
                ALERT.REQUIREDFIELDS(`#modal-error`);
            } else {
                $(`#submit`).html(`<i class="la la-spinner la-spin mr-2"></i>Submit`).attr("disabled",true);
                (x.method == "PUT") ? delete body._id : null;
                if(options){
                    if(x.method == "POST" && options.method == "POST"){
                        GET.AJAX({
                            url: `${options.url}${$(`#${options.id}`).val()}`,
                            method: "GET",
                            headers: {
                                "Authorization": SESSION_TOKEN
                            },
                        }, function(docs){
                            if(docs.length > 0){
                                MODAL.CONFIRMATION({
                                    content: `A geofence with short name "${$(`#${options.id}`).val()}" already exists. This will overwrite the existing geofence. Do you want to continue?`,
                                    confirmCloseCondition: true,
                                    confirmBGStyle: "background-color:#64b03a;",
                                    confirmCallback: function(){
                                        proceedSubmit();
                                        $(`#confirm-modal,#overlay`).remove(); 
                                    },
                                    cancelCallback: function(){
                                        $(`#modal #submit`).html(`Submit`).attr("disabled",false);
                                    }
                                });
                            } else {
                                proceedSubmit();
                            }
                        });
                    } else if(options.ggsURL){
                        var ggsFunction = function(tries){
                                if(options.object && options.object.length > 0){
                                    var new_object = [];
                                    (options.object||[]).forEach(val => {
                                        new_object.push({name: val.name, value:$(val.el).val()||" "});
                                        if(val.name == "Trailer" && $(val.el).val()){
                                            var trailer = getTrailer($(val.el).val());
                                            if(trailer){
                                                new_object.push({name:"Pal Cap", value:trailer.pal_cap});
                                                new_object.push({name:"Region", value:trailer.region});
                                                new_object.push({name:"Cluster", value:trailer.cluster});
                                                new_object.push({name:"Site", value:trailer.site});
                                            }
                                        }
                                    });
                                    console.log("new_object",new_object);
                                    console.log("body",body);
                                    
                                    GET.AJAX({
                                        "url": options.ggsURL,
                                        "method": "PUT",
                                        "headers": {
                                            // "Content-Type": "application/json",
                                            "Authorization": USER.apiKey
                                        },
                                        "data": JSON.stringify(new_object),
                                    }, function(response){
                                        proceedSubmit();
                                    }, function(error){
                                        if(error.status == 0 && tries < MAX_TRIES){
                                            tries++;
                                            ggsFunction(tries);
                                        } else {
                                            proceedSubmit();
                                        }
                                        TOASTR.ERROR(error);
                                    });
                                } else {
                                    proceedSubmit();
                                }
                            };
                        ggsFunction(0);
                    } else {
                        proceedSubmit();
                    }
                } else {
                    proceedSubmit();
                }
                function proceedSubmit(){
                    GET.AJAX({
                        url: x.url,
                        method: x.method,
                        headers: {
                            "Content-Type": "application/json; charset=utf-8",
                            "Authorization": SESSION_TOKEN
                        },
                        data: JSON.stringify(body)
                    }, function(docs){
                        if(docs.ok == 1){
                            $(`#overlay`).remove();
                            (x.method == "PUT") ? TOASTR.UPDATEDSUCCESSFULLY() : TOASTR.CREATEDSUCCESSFULLY();
                        } else {

                            toastr.error(`${docs.error.message}</br></br>Error Code - ec014/01`);
                            $(`#submit`).html(`Submit`).attr("disabled",false);
                        }
                    }, function(error) {
                        console.log(error);
                        if(error.status == 409){
                            toastr.error(`Record already exists.</br></br>Error Code - ec014/01`);
                        } else {
                            toastr.error(`${error.responseJSON.error.message}</br></br>Error Code - ec014/01`);
                        }
                        $(`#submit`).html(`Submit`).attr("disabled",false);
                    });
                }
            }
        });
    },
};
var TABLE = {
    BUTTONS: function(x){
        var goto = x.goto,
            pageButtons = PAGE_FUNCTIONALITIES[goto].buttons.table || [],
            dt_buttons = x.dt_buttons || [],
            loadView = x.loadView || [],
            dispatcherCondition = true,//(authorizationLevel .dispatcher()) ? ((!USER.dc)?false:true) : true,
            actions = x.actions || {};
        
        pageButtons.forEach(val => {
            var className = (dt_buttons.length == 0) ? "ml-1" : "";
            var condClass =(dispatcherCondition == null || dispatcherCondition == true) ? "" : "dispatcherCondition";
            className += (loadView.includes(val)) ? " disabled" : "";
            if(PERMISSION[goto].create && PERMISSION[goto].create != "none"){
                // if(val == "create"){
                //     var icon = (loadView.includes(val)) ? "la-spin la-spinner" : "la-plus";
                //     dt_buttons.push({
                //         text: `<i class="la ${icon}" data-toggle="tooltip" title="Create New Record"></i> Create`,
                //         className: `create-btn ${className} ${condClass}`,
                //         action: function ( e, dt, node, config ) {
                //             if (typeof actions[val] === 'function') { actions[val](); }
                //         },
                //     });
                // }
                if(val == "create"){ // create-admin
                    var icon = (loadView.includes(val)) ? "la-spin la-spinner" : "la-plus";
                    var title = "Create New Record";
                    var text = "Create";
                    dt_buttons.push({
                        text: `<i class="la ${icon}" data-toggle="tooltip" title="${title}"></i> ${text}`,
                        className: `create-btn ${className} ${condClass}`,
                        action: function ( e, dt, node, config ) {
                            if (typeof actions[val] === 'function') { actions[val](); }
                        },
                    });
                }
                if(val == "import"){
                    var icon = (loadView.includes(val)) ? "la-spin la-spinner" : "la-file-upload";
                    dt_buttons.push({
                        text: `<i class="la ${icon}" data-toggle="tooltip" title="Import Batch File"></i> Import`,
                        className: `import-btn ${className} ${condClass}`,
                        action: function ( e, dt, node, config ) {
                            if (typeof actions[val] === 'function') { actions[val](); }
                        },
                    });
                }
            }
            if(val == "refresh"){
                dt_buttons.push({
                    text: '<i class="la la-refresh" data-toggle="tooltip" title="Refresh Table"></i>',
                    className,
                    action: function ( e, dt, node, config ) {
                        if (typeof actions[val] === 'function') { actions[val](); }
                    }
                });
            }
            if(val == "filter"){
                dt_buttons.push({
                    text: '<i class="la la-filter" data-toggle="tooltip" title="Filter"></i>',
                    className,
                    action: function ( e, dt, node, config ) {
                        if (typeof actions[val] === 'function') { actions[val](); }
                    }
                });
            }
            if(val == "export"){
                dt_buttons.push({
                    text: '<i class="la la-file-export" data-toggle="tooltip" title="Export Options"></i>',
                    className,
                    action: function ( e, dt, node, config ) {
                        if (typeof actions[val] === 'function') { actions[val](); }
                    }
                });
            }
            if(val == "report"){
                dt_buttons.push({
                    text: '<i class="la la-download" data-toggle="tooltip" title="Generate Report"></i>',
                    className,
                    action: function ( e, dt, node, config ) {
                        if (typeof actions[val] === 'function') { actions[val](); }
                    }
                });
            }
            if(val == "column"){
                dt_buttons.push({
                    text: '<i class="la la-columns" data-toggle="tooltip" title="Customize Display Options"></i>',
                    className,
                    action: function ( e, dt, node, config ) {
                        if (typeof actions[val] === 'function') { actions[val](); }
                    },
                });
            }
            if(val == "search"){
                dt_buttons.push({
                    text: '<i class="la la-search" data-toggle="tooltip" title="Search Table"></i>',
                    className,
                    action: function ( e, dt, node, config ) {
                        if (typeof actions[val] === 'function') { actions[val](); }
                    },
                });
            }
            if(val == "eye"){
                dt_buttons.push({
                    text: '<i class="la la-eye" data-toggle="tooltip" title="Hide/Show All In Transit Entries (Including from previous dates)"></i>',
                    className,
                    action: function ( e, dt, node, config ) {
                        if (typeof actions[val] === 'function') { actions[val](); }
                    },
                });
            }
            if(val == "clone"){
                dt_buttons.push({
                    text: '<i class="la la-copy" data-toggle="tooltip" title="Clone Live Data"></i>',
                    className,
                    action: function ( e, dt, node, config ) {
                        if (typeof actions[val] === 'function') { actions[val](); }
                    },
                });
            }
        });
        return dt_buttons;
    },
    POPULATE: function(x){
        $(`.dt-button .la-refresh`).addClass("la-spin disabled");
        $(`.dt-button .la-refresh`).parents(".dt-button").addClass("disabled");
        $(`.cb-container .la-refresh`).addClass("la-spin disabled");
        
        $(`#filter-container input,#filter-container select`).attr("disabled",true);
        $(`#filter-container button,#filter-container a`).addClass("disabled");

        x.filter = x.filter || {};
        x.dataTableOptions = $.extend(x.dataTableOptions,{
            language: { search: '', searchPlaceholder: "Search", sLengthMenu: "_MENU_" },
        });
        if (ISMOBILE) {
            x.dataTableOptions = $.extend(x.dataTableOptions,{responsive: true});
        }
        x.dataTableOptions = $.extend(x.dataTableOptions,{responsive: true});

        var _dt = null,
            skip = 0,
            table_id = x.table_id,
            paginationLoad = function(length){
                if(length == null || length == LIMIT){
                    var urlExtend = (x.withFilter)?`/${JSON.stringify(x.filter)}`:``;
                    urlExtend += (x.withPagination)?`/${skip}/${LIMIT}`:``;

                    GET.AJAX({
                        url: `/api/${x.url}${urlExtend}`,
                        method: "GET",
                        headers: {
                            "Authorization": SESSION_TOKEN
                        },
                    }, function(docs){
                        console.log(`${x.commentTitle}:`,docs);
                        if(!docs.error){
                            if (typeof FILTER.CALLBACK === 'function') { FILTER.CALLBACK(true); }
                            $(`#filter-btn`).html("Apply").removeClass("disabled");
                            
                            $(`.dt-button .la-refresh`).removeClass("la-spin");
                            $(`.dt-button .la-refresh`).parents(".dt-button").removeClass("disabled");
                            if(FILTER.STATUS == "reset") $(`.cb-container .la-refresh`).removeClass("la-spin");
                            else $(`.cb-container .la-refresh`).removeClass("la-spin disabled");

                            
                            $(`#filter-container input,#filter-container select`).attr("disabled",false);
                            $(`#filter-container button,#filter-container a`).removeClass("disabled");
                            
                            length = docs.length;

                            if(x.newlyLoaded === true){
                                x.newlyLoaded = false;

                                if([x.goto].includes(PAGE.GET())){
                                    PAGE.DISPLAY();
                                    initDT();
                                    
                                    // always put end of datatable
                                    if (typeof x.initializeCallback === 'function') { x.initializeCallback(docs,_dt); }
                                }
                            } 

                            if(docs.error){
                                toastr.error(docs.error.message);
                            } else {
                                docs.forEach(val => {
                                    var index = LIST[x.urlPath].findIndex(x => x._id.toString() == val._id.toString());
                                    if(index > -1){} 
                                    else {
                                        val._row = GENERATE.RANDOM(36);
                                        LIST[x.urlPath].push(val);
                                    }
                                });

                                skip += length;
                                if([x.goto].includes(PAGE.GET())){
                                    if (typeof x.populateCallback === 'function') { x.populateCallback(docs); }
                                    ($(table_id).length > 0) ? paginationLoad(length) : null;
                                }
                            }
                            // TABLE.FINISH_LOADING.START_CHECK();
                        }
                    });
                } else {
                    $(`#progress-striped-active .progress-bar`).css("width",`0%`).html(`0%`);
                    $("div.tbl-progress-bar").hide();
                    if(x.newlyLoaded === true){
                        x.newlyLoaded = false;
                        if([x.goto].includes(PAGE.GET())){
                            PAGE.DISPLAY();
                            initDT();
                            
                            // always put end of datatable
                            if (typeof x.initializeCallback === 'function') { x.initializeCallback(null,_dt); }
                        }
                    }
                }
        }

        if(x.noData === true){
            PAGE.DISPLAY();
            initDT();
            if (typeof x.initializeCallback === 'function') { x.initializeCallback(null,_dt); }
            if (typeof x.noDataFunction === 'function') { x.noDataFunction(); }
            TABLE.FINISH_LOADING.START_CHECK();
        } else {
            paginationLoad();
        }

        function initDT(){
            if ($.fn.DataTable.isDataTable(table_id) ) {
                $(table_id).DataTable().clear().destroy();
            }
            _dt = $(table_id).DataTable(x.dataTableOptions);

            if(ISMOBILE){
                $(`.dt-buttons`).addClass("d-inline-block");
                $(`.dataTables_wrapper`).css("text-align","center");
                $(`.table.dataTable`).css("text-align","unset");
            }

            $(table_id).on('page.dt length.dt draw.dt order.dt', function () {
                PAGE.TOOLTIP();
                TABLE.FINISH_LOADING.START_CHECK();

                $(`${table_id} thead tr th`).each((i,el) => {
                    if(!$(el).is(":visible")){
                        $(`${table_id} tr:not(.child)`).each((i1,el1) => {
                            $(el1).find("td").eq(i).hide();
                        });
                    }
                });
            });
            
            $(`.dt-button [data-toggle="tooltip"]`).each((i,el) => {
                var title = $(el).attr("data-original-title") || $(el).attr("title");
                $(el).parents(".dt-button").attr({"data-toggle":"tooltip","data-original-title":title});
                $(el).removeAttr("data-toggle data-original-title");
            });
            PAGE.TOOLTIP();

            if(x.perColumnSearch){
                $(table_id).find('thead').append('<tr class="row-filter"><th></th><th></th><th></th><th></th><th></th></tr>');
                $(table_id).find('thead .row-filter th:not(:last-child)').each(function() {
                    $(this).html('<input type="text" class="form-control input-sm" placeholder="Search...">');
                });
                $(table_id).find('.row-filter input').on('keyup change', function() {
                    _dt.column($(this).parent().index() + ':visible')
                        .search(this.value)
                        .draw();
                });
            }
        }
    },
    ROW_LISTENER: function(x){
        var table_id = x.table_id,
            _row = x._row,
            _id = x._id,
            urlPath = x.urlPath,
            deleteURL = x.deleteURL || `/api/${urlPath}/${CLIENT.id}/${USER.username}/${_id}`,
            editCallback = x.editCallback || function(){
                var obj = LIST[urlPath].find(y => y._id.toString() == _id.toString());
                x.initializeModal({
                    url: `/api/${urlPath}/${CLIENT.id}/${USER.username}/${_id}`,
                    method: "PUT",
                    obj
                });
            };
        $(table_id).on('click', `[_row="${_row}"] [view],[_row="${_row}"] + tr.child [view]`,function(e){
            e.stopImmediatePropagation();
            if(typeof modalViews[urlPath].view == 'function') $(`body`).append(modalViews[urlPath].view(_id));
            else $(`body`).append(modalViews[urlPath].view[CLIENT.id](_id));
            
            $(`.main-details,.log-details`).css({"max-height": $(`body`).innerHeight()-200, "overflow-y": "auto"});
            var innerHeight = $(`.main-parent-details`).innerHeight() || $(`.main-details`).innerHeight()-44;
            $(`#history-logs`).css("height",innerHeight);
            $(`.history-details`).css("max-height",$(`.main-details`).outerHeight() + "px");
            $("html, body,#modal").animate({ scrollTop: 0 }, "fast");

            if (typeof x.viewCallback === 'function') { x.viewCallback(); }
        });
        $(table_id).on('click', `[_row="${_row}"] [edit],[_row="${_row}"] + tr.child [edit]`,function(e){
            e.stopImmediatePropagation();
            editCallback();
        });
        $(table_id).on('click', `[_row="${_row}"] [delete],[_row="${_row}"] + tr.child [delete]`,function(e){
            e.stopImmediatePropagation();
            MODAL.CONFIRMATION({
                confirmCloseCondition: true,
                content: x.deleteModalContent,
                confirmCallback: function(){
                    $.ajax({ 
                        url: deleteURL, 
                        method: "DELETE", 
                        timeout: 90000 ,
                        headers: {
                            "Authorization": SESSION_TOKEN
                        },
                        async: true
                    }).done(function (docs) {
                        // console.log("docs2222",docs)
                        if(docs.ok == 1){
                            $(`#confirm-modal`).remove();
                            $(table_id).DataTable().row(`[_row="${_row}"]`).remove().draw(false);
                            TOASTR.DELETEDSUCCESSFULLY();
                        } else {
                            TOASTR.ERROR(docs);
                        }
                    }).fail(function(error){
                        TOASTR.ERROR(error);
                    });
                }
            });
        });
        if (typeof x.additionalListeners === 'function') { x.additionalListeners(); }
    },
    ROW_BUTTONS: function(goto,options={}){
        options = options || {};
        var status = options.status,
            attrs = options.attrs || "",
            readonlyArr = options.readonlyArr || [],
            disabledArr = options.disabledArr || [],
            adminArr = options.adminArr || [],
            loadView = options.loadView || [],
            customButtons = options.customButtons,
            dispatcherCondition = (authorizationLevel .dispatcher()) ? ((!USER.dc)?false:true) : true,
            username = options.username,
            deleteArr = options.deleteArr || [];
        var condClass =(dispatcherCondition == null || dispatcherCondition == true) ? "" : "dispatcherCondition";
            
        var pageButtons = PAGE_FUNCTIONALITIES[goto].buttons || {},
            permission = PERMISSION[goto] || {},
            grantedActions = pageButtons.row || [],
            count = 0,
            buttonDetails = {
                add: {
                    permission: "update",
                    icon: "la-plus",
                    title: "Add Record",
                    attr: "add"
                },
                view: {
                    permission: "read",
                    icon: "la-search-plus",
                    title: "View Record",
                    attr: "view"
                },
                edit: {
                    permission: "update",
                    icon: "la-pencil",
                    title: "Edit Record",
                    attr: "edit",
                    statusCheck: true,
                },
                "edit-admin": {
                    permission: "update",
                    icon: "la-pencil",
                    title: "Edit Record",
                    attr: "edit-admin",
                    statusCheck: true,
                },
                "edit-rest-days": {
                    permission: "update",
                    icon: "la-calendar-week",
                    title: "Edit Rest Days",
                    attr: "edit-rest-days",
                },
                comment: {
                    permission: "update",
                    icon: "la-comment",
                    title: "Add Comment",
                    attr: "comment",
                    statusCheck: true,
                },
                delete: {
                    permission: "delete",
                    icon: "la-trash-o",
                    title: "Delete Record",
                    attr: "delete"
                },
                statusUpdate: {
                    permission: "update",
                    icon: "la-stream",
                    title: "Update Record's Status",
                    attr: "statusUpdate"
                },
                history: {
                    permission: "read",
                    icon: "la-history",
                    title: "History",
                    attr: "history"
                }
            },
            permissionValid = function(type){
                var valid = false;
                if(permission[type] == "all" || (permission[type] == "self" && username == USER.username)){
                    valid = true;
                }
                return valid;
            },
            buttonsHTML = "";
        grantedActions.forEach(val => {
            if(customButtons) {
                if(customButtons.includes(val)){
                    loadButton();
                }
            } else {
                loadButton();
            }
            function loadButton(){
                var button = buttonDetails[val],
                    admin = (adminArr.includes(val))?"admin":"",
                    disable = (disabledArr.includes(val))?"disabled":"",
                    readonly = (readonlyArr.includes(val))?"readonly":"";
                if(button){
                    var icon = (loadView.includes(val))?"la-spin la-spinner":button.icon;
    
                    function shouldDelete(){
                        var delete_ = false;
                        deleteArr.forEach(val_ => {
                            if(val_.button == val && val_.byPassCondition){
                                delete_ = true;
                            } else {
                                if(val_.button == val && (val_.status||[]).includes(status)){
                                    delete_ = true;
                                }
                            }
                        });
                        return delete_;
                    }

                    if(permissionValid(button.permission) && !shouldDelete()) {
                        buttonsHTML += `<a title="${button.title}" class="dt-button action-icon ${admin} ${disable} ${readonly} ${condClass}" ${attrs} ${button.attr}><i class="la ${icon}"></i></a>`;
                        count++;
                    }
                }
            }
        });

        return { buttons: `<div style="text-align:center;">${buttonsHTML}</div>`, width: `${(count*22)}px` };
    },
    WATCH: function(x){
        var urlPath = x.urlPath;
        CHANGESTREAMS[urlPath] = function(event){
            var table_id = `#tbl-${urlPath}`,
                dt = null,
                operationType = event.operationType,
                _id = event.documentKey._id,
                docs = event.fullDocument,
                id_index = (LIST[urlPath]) ? LIST[urlPath].findIndex(x =>x._id.toString() == _id.toString()) : null,
                obj = (LIST[urlPath]) ? LIST[urlPath][id_index] : null;

            console.log(urlPath,operationType,_id,docs);
            if(operationType == "insert"){
                if(urlPath == "notifications" && docs.type != "test" && PERMISSION["de_dashboard"]){
                    var txt = `${docs.escalation}_${docs.delay_type}_${docs.dispatch_id}_${docs.site}`;
                    if(!DE_NOTIF_COUNT.includes(txt)){
                        
                        DE_NOTIF_COUNT.push(txt);
                        DE_DASHBOARD.FUNCTION.setBadge("add");

                        if(USER.settings.push_notification == "none"){} 
                        else {
                            var sound = document.getElementById("audio01");
                            sound.play();

                            var redDot = `<span style="background-color:red; display:inline-block;border-radius:20px; width:7px;height:7px;margin-right:4px;"></span>`;
                            var runningDurationType = "Transit";
                            if(docs.delay_type.indexOf("Queueing") > -1) runningDurationType = "Queueing";
                            if(docs.delay_type.indexOf("CICO") > -1) runningDurationType = "CICO";

                            try {
                                if(USER.settings.push_notification == "desktop"){
                                    try {
                                        if(Notification.permission == "granted"){
                                            var notification = new Notification(`${docs.dispatch_id} | Escalation ${docs.escalation}`, {
                                                // icon: 'http://cdn.sstatic.net/stackexchange/img/logos/so/so-icon.png',
                                                body: `Running ${runningDurationType} Duration: ${DATETIME.HH_MM(null,docs.timelapse).hour_minute}`,
                                                tag: `${docs.dispatch_id} | Escalation ${docs.escalation}`
                                            });
                                            // will not work if onclick is included upon initialization of the notification.
                                            notification.onclick = function(e){
                                                // e.preventDefault(); // prevent the browser from focusing the Notification's tab; will not go to the tab that called the browser
                                                window.history.pushState({}, null, `#de_dashboard`);
                                                PAGE.GO_TO();
                                            }
                                        }
                                    } catch(error){}
                                } else { // unset or set to toast notif
                                    toastr.error(`${redDot}<b>${docs.dispatch_id}</b> | Escalation ${docs.escalation}<br>Running ${runningDurationType} Duration: ${DATETIME.HH_MM(null,docs.timelapse).hour_minute}`,"",{
                                        positionClass: "toast-bottom-right toastr-white-bg",
                                        showDuration: "300",
                                        closeButton: true,
                                        hideDuration: "1000",
                                        timeOut: "20000",
                                        preventDuplicates: true,
                                        onclick: function(){
                                            window.history.pushState({}, null, `#de_dashboard`);
                                            PAGE.GO_TO();
                                        }
                                    });
                                }
                            } catch (error) {
                                
                            }
                        }
                    }
                }
                if(LIST[urlPath]){ //  && docs.type != "test"
                    var index = LIST[urlPath].findIndex(x => x._id.toString() == docs._id.toString());
                    
                    // put before docs._row = (index > -1) ?  ....
                    if(urlPath == "notifications" && $.fn.DataTable.isDataTable("#tbl-oc")){
                        var arr = [100,500,1000,1500,2000];
                        var minRandom = Math.floor(Math.random() * arr.length);
                        var maxRandom = Math.floor(Math.random() * arr.length);
                        var ms = (Math.floor(Math.random() * arr[maxRandom]) + arr[minRandom]);
                        console.log("ms",minRandom,maxRandom,ms);
                        setTimeout(function(){
                            if(docs.delay_type == "Over Transit") table_id = "#tbl-ot";
                            if(docs.delay_type == "Long Queueing") table_id = "#tbl-lq";
                            if(docs.delay_type == "Over CICO") table_id = "#tbl-oc";
                            dt = $(table_id).DataTable();

                            // docs.id = docs._id;
                            var same = LIST[urlPath].find(x=> x.dispatch_id == docs.dispatch_id && x.delay_type == docs.delay_type);
                            if(same){
                                if(docs.escalation > same.escalation){
                                    // if escalation level increased, delete lower escalation level and replace by higher escalation level
                                    dt.row(`[_row="${same._row}"]`).remove().draw(false);
                                    var newList = $.grep(LIST[urlPath], function(x){ return x.dispatch_id != docs.dispatch_id; });
                                    LIST["notifications"] = newList;
                                    DE_DASHBOARD.FUNCTION.setSummary();

                                    docs.id = docs._id;

                                    DE_DASHBOARD.FUNCTION.addDataToTable(docs).then(result => {
                                        dt.row.add(result).draw(false);
                                        DE_DASHBOARD.FUNCTION.setSummary();
                                    });
                                }
                            } else {
                                docs.id = docs._id;
                                DE_DASHBOARD.FUNCTION.addDataToTable(docs).then(result => {
                                    dt.row.add(result).draw(false);
                                    DE_DASHBOARD.FUNCTION.setSummary();
                                });
                            }
                        },ms);
                    }
                    // end put before docs._row = (index > -1) ?  .... 
                    if(urlPath == "notifications" && $.fn.DataTable.isDataTable(table_id)){
                        $.ajax({ 
                            url: `/api/dispatch/${CLIENT.id}/${USER.username}/${docs.dispatch_id}`, 
                            method: "GET", 
                            timeout: 90000, 
                            headers: {
                                "Authorization": SESSION_TOKEN
                            },
                            async: true
                        }).done(function (_docs_) {
                            var _doc_ = _docs_[0];
                            docs.dispatchDetails = {
                                status: _doc_.status,
                                departure_date: _doc_.departure_date
                            };
                            docs._row = (index > -1) ? obj._row : GENERATE.RANDOM(36);
                            (index > -1) ? LIST[urlPath][index] = docs : LIST[urlPath].push(docs);

                            if ($.fn.DataTable.isDataTable(table_id) && x.rowData) {
                                dt = $(table_id).DataTable();
                                if(FILTER.APPROVAL[urlPath] && PAGE.GET() == urlPath){
                                    FILTER.APPROVAL[urlPath]([docs],dt,x.rowData);
                                } else {
                                    dt.row.add(x.rowData(docs)).draw(false);
                                }
                            }
                        });
                    } else {
                        if(!(urlPath == "notifications" && $.fn.DataTable.isDataTable("#tbl-oc"))){
                            docs._row = (index > -1) ? obj._row : GENERATE.RANDOM(36);
                            (index > -1) ? LIST[urlPath][index] = docs : LIST[urlPath].push(docs);
                        }
    
                        if ($.fn.DataTable.isDataTable(table_id) && x.rowData) {
                            dt = $(table_id).DataTable();
                            if(FILTER.APPROVAL[urlPath] && PAGE.GET() == urlPath){
                                FILTER.APPROVAL[urlPath]([docs],dt,x.rowData);
                            } else {
                                dt.row.add(x.rowData(docs)).draw(false);
                            }
                        }
                    }
                    if(urlPath == "dispatch" && $.fn.DataTable.isDataTable("#tbl-dashboard")){
                        // if(DASHBOARD_COUNTER > 5) {
                        //     DASHBOARD_COUNTER = 0;
                            if (typeof DASHBOARD.FUNCTION.addDataToTable === 'function') { DASHBOARD.FUNCTION.addDataToTable([docs],false); }
                            if (typeof DASHBOARD.FUNCTION.addDataToTable2 === 'function') { DASHBOARD.FUNCTION.addDataToTable2([docs],false); }
                        // }
                    }
                    if(urlPath == "notifications" && ISMOBILE){
                        NOTIFICATIONS.FUNCTION.mobileAddToList({val:docs,urlPath},true).then(template => {
                            if($(`.page-box.row > .col-sm-12 [_row]`).length > 0){
                                $(`.page-box.row > .col-sm-12`).prepend(template);
                            } else {
                                $(`.page-box.row > .col-sm-12`).html(template);
                            }
                        });
                    }
                }
            }
            if(operationType == "update" || operationType == "replace"){
                if(obj){
                    docs._row = obj._row;

                    var index = LIST[urlPath].findIndex(x => x._row == docs._row);
                    (index > -1) ? LIST[urlPath][index] = docs : LIST[urlPath].push(docs);

                    if ($.fn.DataTable.isDataTable(table_id)) {
                        dt = $(table_id).DataTable();
                        var rowNode = dt.row(`[_row="${obj._row}"]`).node();
                        (rowNode && x.rowData) ? dt.row(rowNode).data(x.rowData(docs)).draw(false) : null;
                    }
                }
                if(urlPath == "dispatch" && $.fn.DataTable.isDataTable("#tbl-dashboard")){
                    if (typeof DASHBOARD.FUNCTION.addDataToTable === 'function') { DASHBOARD.FUNCTION.addDataToTable([docs],false); }
                    if (typeof DASHBOARD.FUNCTION.addDataToTable2 === 'function') { DASHBOARD.FUNCTION.addDataToTable2([docs],false); }
                }
                if(urlPath == "dispatch" && $.fn.DataTable.isDataTable("#tbl-oc")){
                    var _table_id_;
                    if(["processingAtOrigin","idlingAtOrigin","in_transit","complete","incomplete"].includes(docs.status)){
                        _table_id_ = "#tbl-lq";
                    }
                    if(["in_transit","complete","incomplete"].includes(docs.status)){
                        _table_id_ = "#tbl-oc";
                    }
                    if(["complete","incomplete"].includes(docs.status)){
                        _table_id_ = "#tbl-ot";
                    }
                    if(_table_id_ && LIST["notifications"]){
                        var notifArr = LIST["notifications"].filter(x => x.dispatch_id == docs._id);
                        notifArr.forEach(val => {
                            if ($.fn.DataTable.isDataTable(_table_id_)) {
                                var _dt_ = $(_table_id_).DataTable();
                                _dt_.row(`[_row="${val._row}"]`).remove().draw(false);
                            }
                        });
                        var newList = $.grep(LIST["notifications"], function(x){ return x.dispatch_id != docs._id; });
                        LIST["notifications"] = newList;
                        DE_DASHBOARD.FUNCTION.setSummary();
                    }
                }
            }
            if(operationType == "delete"){
                var newList = $.grep((LIST[urlPath]||[]), function(x){ return x._id.toString() != _id.toString(); });
                if ($.fn.DataTable.isDataTable(table_id)) {
                    dt = $(table_id).DataTable();
                    dt.row(`[_row="${obj._row}"]`).remove().draw(false);
                }
                
                if(urlPath == "dispatch" && $.fn.DataTable.isDataTable("#tbl-oc")){
                    var _table_id_ = "#tbl-ot,#tbl-lq,#tbl-oc";
                    var notifArr = LIST["notifications"].filter(x => x.dispatch_id == _id);
                    notifArr.forEach(val => {
                        if ($.fn.DataTable.isDataTable(_table_id_)) {
                            var _dt_ = $(_table_id_).DataTable();
                            _dt_.row(`[_row="${val._row}"]`).remove().draw(false);
                        }
                    });
                    var newList = $.grep(LIST["notifications"], function(x){ return x.dispatch_id != _id; });
                    LIST["notifications"] = newList;
                    DE_DASHBOARD.FUNCTION.setSummary();
                }
                if(urlPath == "notifications" && $.fn.DataTable.isDataTable("#tbl-oc")){
                    console.log("Deleted notifications",_id);
                    var _table_id_ = "#tbl-ot,#tbl-lq,#tbl-oc";
                    var notifArr = LIST[urlPath].filter(x => ((x.id && x.id.toString() == _id.toString()) || (x._id.toString() == _id.toString())));
                    notifArr.forEach(val => {
                        if ($.fn.DataTable.isDataTable(_table_id_)) {
                            var _dt_ = $(_table_id_).DataTable();
                            _dt_.row(`[_row="${val._row}"]`).remove().draw(false);
                        }
                    });
                    var newList = $.grep(LIST[urlPath], function(x){ return ((x.id && x.id.toString() != _id.toString()) || (x._id.toString() != _id.toString())); });
                    LIST[urlPath] = newList;
                    DE_DASHBOARD.FUNCTION.setSummary();
                }
                // end put before LIST[urlPath] = newList;

                if(!(urlPath == "notifications" && $.fn.DataTable.isDataTable("#tbl-oc")) || !(urlPath == "dispatch" && $.fn.DataTable.isDataTable("#tbl-oc"))){
                    LIST[urlPath] = newList;
                }
                
                if(urlPath == "dispatch" && $.fn.DataTable.isDataTable("#tbl-dashboard")){
                    if (typeof DASHBOARD.FUNCTION.addDataToTable === 'function') { DASHBOARD.FUNCTION.addDataToTable(null,false,obj); }
                    if (typeof DASHBOARD.FUNCTION.addDataToTable2 === 'function') { DASHBOARD.FUNCTION.addDataToTable2(null,false,obj); }
                }
                if(urlPath == "notifications" && ISMOBILE){
                    $(`.page-box.row > .col-sm-12 [_row="${obj._row}"]`).remove();
                    if($(`.page-box.row > .col-sm-12 [_row]`).length == 0){
                        $(`.page-box.row > .col-sm-12`).html(`<div style="text-align: center;margin-top: 15px;">You do not have any notifications</div>`);
                    }
                }
                if(urlPath == "sessions"){
                    (_id == SESSION_TOKEN) ? LOGOUT() : null;
                }
            }

            if(urlPath == "users"){
                if(docs && docs._id == USER.username){
                    var originalRole = USER.originalRole;
                    USER.fullName = docs.name;
                    USER.email = docs.email;
                    USER.phoneNumber = docs.phoneNumber;
                    USER.role = docs.role;

                    $(`#profile-page #fullname`).html(docs.name);
                    $(`#profile-page #email`).html(docs.email);
                    $(`#profile-page #phoneNumber`).html(docs.phoneNumber);
                    $(`#profile-page #role`).html(USER.role.capitalize());

                    if((docs.role||"user") != originalRole){
                        sessionStorage.removeItem("view_as");
                        toastr.warning("Your privileges has been changed. This page will automatically refresh in 5 seconds.",null,{timeOut: 5000});
                        setTimeout(function(){
                            location.reload();
                        },5000);
                    }
                }
            }
            
            if (typeof x.options === 'function') { x.options(); }
        };
    },
    COL_ROW: function(column,row,userKey){
        // if Action column is not visible, try making create/update/delete from auth.js "all". 
        var permission = PERMISSION[PAGE.GET()] || {},
            removeColRow = function(key){
                if(column){
                    var index = column.findIndex(x => x.data == key);
                    (index > -1) ? column.splice(index, 1) : null;
                }
                (row) ? delete row[key] : null;

                if(CUSTOM.COLUMN[PAGE.GET()] && key){
                    var index = CUSTOM.COLUMN[PAGE.GET()].findIndex(x => x.text == key);
                    (index > -1) ? CUSTOM.COLUMN[PAGE.GET()].splice(index, 1) : null;
                }
            };

        if(!["all","self"].includes(permission.read) && !["all","self"].includes(permission.update) && !["all","self"].includes(permission.delete)){
            removeColRow("Action");
            removeColRow(userKey);
        }
        return {column,row};
    },
    TOOLBAR: function(dt,filenameCallback,customizeCallback){

        try {
            new $.fn.dataTable.Buttons(dt, {
                    buttons: [
                        {
                            extend: 'copy',
                            text: 'Copy',
                            title: filenameCallback ? filenameCallback() : undefined,
                            exportOptions: {
                                modifier: {
                                    search: 'applied',
                                    order: 'applied',
                                },
                                columns: ":not(.notExport)",
                                rows: ":not(.notExport)",
                                format: {
                                    body: function ( data, row, column, node ) {
                                        var _data = data;
                                        
                                        (_data === "You") ? _data = _data.replace("You", USER.fullName) : null; // change "You" to user's full name
                                        try { (_data.indexOf("<") > -1) ? _data = $(_data).text() : null; } catch(error){} // return text inside html tags

                                        try {
                                            _data = _data.replace('<span class="text-success">', '')  // remove specific html tags
                                                         .replace('<span class="text-danger">', '')
                                                         .replace('</span>', '');
        
                                        } catch (error) { }
    
                                        return _data;
                                    }
                                }
                            }
                        },
                        {
                            extend: 'csv',
                            text: 'CSV',
                            title: filenameCallback ? filenameCallback() : undefined,
                            exportOptions: {
                                modifier: {
                                    search: 'applied',
                                    order: 'applied',
                                },
                                columns: ":not(.notExport)",
                                rows: ":not(.notExport)",
                                format: {
                                    body: function ( data, row, column, node ) {
                                        var _data = data;
                                        
                                        (_data === "You") ? _data = _data.replace("You", USER.fullName) : null; // change "You" to user's full name
                                        try { (_data.indexOf("<") > -1) ? _data = $(_data).text() : null; } catch(error){} // return text inside html tags 

                                        try {
                                            _data = _data.replace('<span class="text-success">', '')  // remove specific html tags
                                                         .replace('<span class="text-danger">', '')
                                                         .replace('</span>', '');
        
                                        } catch (error) { }
                                        return _data;
                                    }
                                }
                            }
                        },
                        {
                            extend: 'excel',
                            text: 'Excel',
                            title: filenameCallback ? filenameCallback() : undefined,
                            customize: customizeCallback ? customizeCallback : undefined,
                            exportOptions: {
                                modifier: {
                                    search: 'applied',
                                    order: 'applied',
                                },
                                columns: ":not(.notExport)",
                                rows: ":not(.notExport)",
                                format: {
                                    body: function ( data, row, column, node ) {
                                        var _data = data;
                                        
                                        (_data === "You") ? _data = _data.replace("You", USER.fullName) : null; // change "You" to user's full name
                                        try { (_data.indexOf("<") > -1) ? _data = $(_data).text() : null; } catch(error){} // return text inside html tags 

                                        try {
                                            _data = _data.replace('<span class="text-success">', '')  // remove specific html tags
                                                         .replace('<span class="text-danger">', '')
                                                         .replace('</span>', '');
        
                                        } catch (error) { }
    
                                        return _data;
                                    }
                                }
                            }
                        }
                ]
            }).container().appendTo($('#export-container'));
        } catch(error) {}
    },
    FINISH_LOADING: {
        CHECK: null,
        START_CHECK: function(){
            if (typeof TABLE.FINISH_LOADING.CHECK === 'function') { TABLE.FINISH_LOADING.CHECK(); }
        },
        UPDATE: function(){
            $(`.create-btn:not(.dispatcherCondition),.import-btn:not(.dispatcherCondition),.create-admin-btn:not(.dispatcherCondition),.data_maintenance-btn`).removeClass("disabled");
            $(`.create-btn i,.create-admin-btn i`).removeClass("la-spin la-spinner").addClass("la-plus");
            $(`.import-btn i`).removeClass("la-spin la-spinner").addClass("la-file-upload");
            $(`.table a[edit]:not(.dispatcherCondition),.table a[edit-admin]:not(.dispatcherCondition),.table a[view],.table a[comment]`).removeClass("readonly");
            $(`.table a[edit] i,.table a[edit-admin] i`).removeClass("la-spin la-spinner").addClass("la-pencil");
            $(`.table a[view] i`).removeClass("la-spin la-spinner").addClass("la-search-plus");
            $(`.table a[comment] i`).removeClass("la-spin la-spinner").addClass("la-comment");
            $(`.data_maintenance-btn i`).removeClass("la-spin la-spinner").addClass("la-tasks");
        }
    }
};
/************** END FUNCTIONS **************/


function getGeofence(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["geofences"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getVehicle(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["vehicles"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getVehicleHistory(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["vehicles_history"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getVehiclesSection(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["vehicles_section"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getVehiclesCompany(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["vehicles_company"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getVehiclePersonnel(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["vehicle_personnel"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getVehiclePersonnelSection(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["vehicle_personnel_section"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getVehiclePersonnelCompany(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["vehicle_personnel_company"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getTrailer(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["trailers"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getChassis(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["chassis"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getChassisSection(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["chassis_section"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getChassisCompany(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["chassis_company"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getChassisType(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["chassis_type"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getRoute(value="",key="_id",type="find",callback=function(){return true;}){ // STILL HAVE
    return (LIST["routes"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getRegion(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["regions"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getCluster(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["clusters"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getUser(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["users"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getShiftSchedule(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["shift_schedule"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}
function getCustomer(value="",key="_id",type="find",callback=function(){return true;}){
    return (LIST["customers"]||[])[type](x => (x[key]||"").toString() == (value||"").toString() && callback(x));
}

/************** VIEWS **************/
const views = new function(){
    return {
        profile: function(dl_btn=""){
            if(CLIENT.allowDownloadFromOtherDB) 
                dl_btn = `<div class="text-right mt-2"><button id="dl-odb-btn" class="btn btn-default" style="width: 241px;white-space:normal;"><i class="la la-user"></i>Download Profile From WRU Dispatch - ${CLIENT.allowDownloadFromOtherDB}</a></div>`;
            
            return `<div class="page-box">
                        <div id="profile-page" class="col-md-6 mt-4">
                            <h6 class="mt-0">Details</h6>
                            <table class="table">
                                <tr>
                                    <td>Username</td>
                                    <td class="text-dark">${USER.username}</td>
                                </tr>
                                <tr>
                                    <td>Full Name</td>
                                    <td id="fullname" class="text-dark">${USER.fullName}</td>
                                </tr>
                                <tr>
                                    <td>Email</td>
                                    <td id="email" class="text-dark">${USER.email}</td>
                                </tr>
                                <tr>
                                    <td>Phone Number</td>
                                    <td id="phoneNumber" class="text-dark">${USER.phoneNumber}</td>
                                </tr>
                            </table>
                            <h6>Role</h6>
                            <table class="table">
                                <tr>
                                    <td id="role" class="text-dark">${USER.role.capitalize()}</td>
                                </tr>
                            </table>
                            <h6>Location Assigned <i class="text-muted">(for dispatchers only)</i></h6>
                            <table class="table">
                                <tr>
                                    <td class="text-dark" granted_dc><small class="font-italic text-muted">loading...</small></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-12">
                            <h6 style="border-bottom: 1px solid #eee;" class="mb-0 pb-3">Locations In-Charge</h6>
                            <table class="table" style="table-layout: fixed;">
                                <tbody>
                                    <tr>
                                        <td style="border-color: #fff !important;" class="p-0 pt-2 pb-2"><small>Region</small></td>
                                        <td style="border-color: #fff !important;" class="p-0 pt-2 pb-2"><small>Cluster</small></td>
                                        <td style="border-color: #fff !important;" class="p-0 pt-2 pb-2"><small>Site</small></td>
                                    </tr>
                                    <tr>
                                        <td class="p-0 pt-2" regions><small class="font-italic text-muted">loading...</small></td>
                                        <td class="p-0 pt-2" clusters><small class="font-italic text-muted">loading...</small></td>
                                        <td class="p-0 pt-2" geofences><small class="font-italic text-muted">loading...</small></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="text-right"><button id="dl-btn" class="btn btn-default" style="width: 241px;"><i class="la la-user"></i>Download Profile From WRU Main</a></div>
                        ${dl_btn}
                        <div class="text-right"><button id="edit-btn" class="btn btn-default mt-2" style="width: 241px;"><i class="la la-pencil"></i>Edit Details</a></div>
                    </div>`;
        },
        settings: function(){
            var versionHTML = `<div class="col-md-12 mt-4">
                                        <h5>Current Version</h5>
                                        <span class="text-muted">${VERSION}</span>
                                    </div>`;

                return `<div class="page-box">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="col-md-12">
                                        <h5>Push Notifications</h5>
                                    </div>
                                    <div class="col-md-12 mt-1">
                                        <div class="fancy-radio">
                                            <label class="m-0">
                                                <input name="push_notification" value="toast" type="radio">
                                                <span><i></i>Toast Notification<a id="toast-test" href="javascript:void(0);" class="ml-2" style="font-size: 10px;color: #00a548c7;font-style: italic;">Test Me!</a></span>
                                            </label>
                                        </div>
                                        <div class="text-muted mb-2 ml-4">A Toast Notification will only appear on the browser while using this website. It will not appear when the user is on a different website/tabs or uses a different application.</div>
                                        <div class="fancy-radio">
                                            <label class="m-0">
                                                <input name="push_notification" value="desktop" type="radio">
                                                <span><i></i>Desktop Notification<a id="desktop-test" href="javascript:void(0);" class="ml-2" style="font-size: 10px;color: #00a548c7;font-style: italic;">Test Me!</a></span>
                                            </label>
                                        </div>
                                        <div class="text-muted mb-2 ml-4">
                                            A Desktop Notification allows the user to be notified even when the user uses a different application, is on a different website/tab, or when the browser is minimized.
                                            <div style="font-style: italic;">Note: Please <b>allow</b> the browser to send you notifications from this website.</div>
                                        </div>
                                        <div class="fancy-radio">
                                            <label class="m-0">
                                                <input name="push_notification" value="none" type="radio">
                                                <span><i></i>None</span>
                                            </label>
                                        </div>
                                        <div class="text-muted mb-2 ml-4">The user will not receive any type of push notifications from this website.</div>
                                    </div>
                                    <div class="col-md-12" style="padding-top: 15px;border-top: 1px solid #eee;margin-top: 15px;">
                                        <h5>Log-in Sessions</h5>
                                        <span class="text-muted">If you notice any unfamiliar devices or locations, click 'Logout' to end the session.</span>
                                    </div>
                                    <div class="col-md-12 mt-1">
                                        <div class="table-wrapper">
                                            <table id="tbl-sessions" class="table table-hover table-bordered">
                                                <thead></thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                    ${((ISMOBILE === true) ? versionHTML : "")}
                                </div>
                            </div>
                        </div>`;
        },
        dashboard: function(){
            var summaryStatusHTML = "";
            var calendarViewHTML = "";
            var exportBtnHTML = "";

            (clientCustom.visibleStatus||[]).forEach(val => {
                switch (val) {
                    case "in_transit":
                        summaryStatusHTML += `<div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.5%;">
                                                <div class="summary-container" style="height: 92px;">
                                                    <b in_transit><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></b>
                                                    <div class="summary-red font-11 font-normal">In Transit</div>
                                                </div>
                                            </div>`;
                        break;
                    case "total_shipment":
                        summaryStatusHTML += `<div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                                <div class="summary-container" style="height: 92px;">
                                                    <b total_shipment><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></b>
                                                    <div class="summary-red font-11 font-normal">Total Shipment</div>
                                                </div>
                                            </div>`;
                        break;
                    case "incomplete":
                        summaryStatusHTML += `<div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                                <div class="summary-container" style="height: 92px;">
                                                    <b incomplete><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></b>
                                                    <div class="summary-red font-11 font-normal">Incomplete</div>
                                                </div>
                                            </div>`;
                        break; 
                    case "scheduled":
                        summaryStatusHTML += `<div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                                <div class="summary-container" style="height: 92px;">
                                                    <b scheduled><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></b>
                                                    <div class="summary-red font-11 font-normal">Scheduled</div>
                                                </div>
                                            </div>`;
                        break;
                    case "assigned":
                        summaryStatusHTML += `<div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                                <div class="summary-container" style="height: 92px;">
                                                    <b assigned><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></b>
                                                    <div class="summary-red font-11 font-normal">Assigned</div>
                                                </div>
                                            </div>`;
                        break;
                    case "queueingAtOrigin":
                        summaryStatusHTML += `<div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                                <div class="summary-container" style="height: 92px;">
                                                    <b queueingAtOrigin><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></b>
                                                    <div class="summary-red font-11 font-normal">Queueing (Origin)</div>
                                                </div>
                                            </div>`;
                        break;
                    case "processingAtOrigin":
                        summaryStatusHTML += `<div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                                <div class="summary-container" style="height: 92px;">
                                                    <b processingAtOrigin><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></b>
                                                    <div class="summary-red font-11 font-normal">Processing (Origin)</div>
                                                </div>
                                            </div>`;
                        break;
                    case "onSite":
                        summaryStatusHTML += ` <div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                                    <div class="summary-container" style="height: 92px;">
                                                        <b onSite><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></b>
                                                        <div class="summary-red font-11 font-normal">On-Site</div>
                                                    </div>
                                                </div>`;
                        break;
                    case "returning":
                        summaryStatusHTML += `<div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                                <div class="summary-container" style="height: 92px;">
                                                    <b returning><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></b>
                                                    <div class="summary-red font-11 font-normal">Returning</div>
                                                </div>
                                            </div>`;
                        break;
                    case "complete":
                        summaryStatusHTML += `<div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                                <div class="summary-container" style="height: 92px;">
                                                    <b complete><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></b>
                                                    <div class="summary-red font-11 font-normal">Complete</div>
                                                </div>
                                            </div>`;
                        break;
                    default:
                        break;
                }
            });
            if((clientCustom.calendarView.dashboard||[]).length > 1){
                var options = "";
                (clientCustom.calendarView.dashboard||[]).forEach(val => {
                    switch (val) {
                        case "day":
                            options += `<li><a href="javascript:void(0);" calendarView="day" class="active"><span>Day</span></a></li>`;
                            break;
                        case "month":
                            options += `<li><a href="javascript:void(0);" calendarView="month"><span>Month</span></a></li>`;
                            break;
                        case "year":
                            options += `<li><a href="javascript:void(0);" calendarView="year"><span>Year</span></a></li>`;
                            break;
                        default:
                            break;
                    }
                });
                calendarViewHTML = `<span class="input-group-addon p-0">
                                        <ul class="nav navbar-nav navbar-right">
                                            <li class="dropdown">
                                                <a href="#" data-toggle="dropdown" class="dropdown-toggle p-0" style="line-height:  10px !important;color: unset !important;padding: 6px 12px !important;vertical-align: top;display: inline;" aria-expanded="false">
                                                    <span><b>DAY</b></span>
                                                </a>
                                                <ul class="dropdown-menu logged-user-menu" style="min-width: 80px;">${options}</ul>
                                            </li>
                                        </ul>
                                    </span>`;
            } else {
                calendarViewHTML = `<span class="input-group-addon"><i id="icon-date" class="la la-calendar"></i></span>`;
            }
            if(clientCustom.exportTable.dashboard){
                exportBtnHTML = `<span id="export-container" class="normal-button d-inline-block"></span>`;
            }

            return `<div id="dashboard-page" class="page-box row">
                        <div class="col-sm-12" style="height: 66px;">
                            <span style="font-size: 30px;font-family: Montserrat;" class="font-lighter mt-2 d-inline-block">
                                <span class="text-success" style="font-weight: 500;">Deployment</span> Dashboard
                            </span>
                        </div>
                        <div class="col-sm-12 mb-2"><a id="reset-btn" href="javascript:void(0);" style="display:none;color: gray;text-decoration: underline;pointer-events:none;">Reset filters</a></div>
                        <div class="col-sm-12" style="height: 28px;">
                            <div class="d-inline-block" style="width: 160px;">
                                <div class="switch-toggle switch-3 switch-candy">
                                    <input id="on" name="view-d" type="radio" checked="checked" value="destination">
                                    <label for="on">Destination</label>
                                    <input id="off" name="view-d" type="radio" value="origin">
                                    <label for="off">Origin</label>
                                    <a></a>
                                </div>
                            </div>
                            <span class="float-right" style="max-width:420px;display:inline-block;">
                                ${exportBtnHTML}
                                <span class="d-inline-block"">
                                    <div class="input-group" style="max-width: 250px;">
                                        ${calendarViewHTML}
                                        <input id="_date" class="form-control" type="text" readonly>
                                    </div>
                                </span>
                            </span>
                        </div>
                        <div class="summary-parent-container col-sm-12 mt-2">
                            ${summaryStatusHTML}
                        </div>
                        <div class="col-sm-12 mt-3">
                            <ul id="_regions" class="nav nav-tabs" role="tablist" style="pointer-events: none;width: 84%;"></ul>
                            <div style="position: absolute;top: -9px;right: 15px;z-index: 0;">
                                <select id="_site" style="width:160px !important;display:none;"></select>
                            </div>
                            <div class="table-wrapper">
                                <table id="tbl-dashboard" class="table table-hover table-bordered" style="margin-top:0px !important;">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        de_dashboard: function(){
            return `<div id="dashboard-page" class="page-box row">
                        <div class="col-sm-12" style="height: 66px;">
                            <span style="font-size: 30px;font-family: Montserrat;" class="font-lighter mt-2 d-inline-block">
                                <span class="text-success" style="font-weight: 500;">Delay Escalation</span> Dashboard
                            </span>
                            <span class="float-right" style="max-width:200px;display:inline-block;">
                                <h2 _TIME_ class="m-0 font-italic font-bold">00:00</h2>
                                <span _DATE_ style="color: gray;font-size: 16px;">-/-/-</span>
                            </span>
                        </div>
                        <div id="filter-container" class="col-sm-12" style="pointer-events: none;">
                            <ul id="_regions" class="nav nav-tabs" role="tablist" style="width: 70%;"></ul>
                            <div style="position: absolute;top: -9px;right: 15px;z-index: 0;">
                                <select id="_baseplant" style="width:160px !important;;display:none;"></select>
                            </div>
                            <div style="position: absolute;top: -9px;right: 180px;z-index: 0;">
                                <select id="_site" class="select-multiple-basic" multiple="multiple" style="min-width:160px !important;display:none;"></select>
                            </div>
                        </div>
                        <!-- LONG QUEUEING -->
                        <div class="col-sm-4 p-0">
                            <div class="d-flex col-sm-12">
                                <div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.5%;">
                                    <div class="summary-container summary-red" style="height: 92px;background: #f2f2f2;">
                                        <span lq_esc_1 class="font-lighter" style="font-size: 37px;"><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></span>
                                        <div class="summary-red font-11 font-normal" style="color: #939393;">Escalation 1</div>
                                    </div>
                                </div>
                                <div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                    <div class="summary-container summary-red" style="height: 92px;background: #f2f2f2;">
                                        <span lq_esc_2 class="font-lighter" style="font-size: 37px;"><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></span>
                                        <div class="summary-red font-11 font-normal" style="color: #939393;">Escalation 2</div>
                                    </div>
                                </div>
                                <div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                    <div class="summary-container summary-red" style="height: 92px;background: #f2f2f2;">
                                        <span lq_esc_3 class="font-lighter" style="font-size: 37px;"><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></span>
                                        <div class="summary-red font-11 font-normal" style="color: #939393;">Escalation 3</div>
                                    </div>
                                </div>
                            </div>
                            <h5 class="col-sm-12 summary-red text-center font-bold">LONG QUEUEING</h5>
                            <div class="table-wrapper p-3">
                                <table id="tbl-lq" class="table table-hover table-bordered" style="margin-top:0px !important;">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- END LONG QUEUEING -->
                        <!-- OVER CICO -->
                        <div class="col-sm-4 p-0">
                            <div class="d-flex col-sm-12">
                                <div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.5%;">
                                    <div class="summary-container summary-red" style="height: 92px;background: #f2f2f2;">
                                        <span oc_esc_1 class="font-lighter" style="font-size: 37px;"><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></span>
                                        <div class="summary-red font-11 font-normal" style="color: #939393;">Escalation 1</div>
                                    </div>
                                </div>
                                <div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                    <div class="summary-container summary-red" style="height: 92px;background: #f2f2f2;">
                                        <span oc_esc_2 class="font-lighter" style="font-size: 37px;"><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></span>
                                        <div class="summary-red font-11 font-normal" style="color: #939393;">Escalation 2</div>
                                    </div>
                                </div>
                                <div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                    <div class="summary-container summary-red" style="height: 92px;background: #f2f2f2;">
                                        <span oc_esc_3 class="font-lighter" style="font-size: 37px;"><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></span>
                                        <div class="font-11 font-normal" style="color: #939393;">Escalation 3</div>
                                    </div>
                                </div>
                            </div>
                            <h5 class="col-sm-12 summary-red text-center font-bold">OVER CICO</h5>
                            <div class="table-wrapper p-3">
                                <table id="tbl-oc" class="table table-hover table-bordered" style="margin-top:0px !important;">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- END OVER CICO -->
                        <!-- OVER TRANSIT -->
                        <div class="col-sm-4 p-0">
                            <div class="d-flex col-sm-12">
                                <div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.5%;">
                                    <div class="summary-container summary-red" style="height: 92px;background: #f2f2f2;">
                                        <span ot_esc_1 class="font-lighter" style="font-size: 37px;"><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></span>
                                        <div class="summary-red font-11 font-normal" style="color: #939393;">Escalation 1</div>
                                    </div>
                                </div>
                                <div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                    <div class="summary-container summary-red" style="height: 92px;background: #f2f2f2;">
                                        <span ot_esc_2 class="font-lighter" style="font-size: 37px;"><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></span>
                                        <div class="summary-red font-11 font-normal" style="color: #939393;">Escalation 2</div>
                                    </div>
                                </div>
                                <div class="col-sm-1 p-0 mt-1 summary-parent" style="min-width: 9.4%;">
                                    <div class="summary-container summary-red" style="height: 92px;background: #f2f2f2;">
                                        <span ot_esc_3 class="font-lighter" style="font-size: 37px;"><i class="la la-spin la-spinner" style="opacity: 0.3;"></i></span>
                                        <div class="summary-red font-11 font-normal" style="color: #939393;">Escalation 3</div>
                                    </div>
                                </div>
                            </div>
                            <h5 class="col-sm-12 summary-red text-center font-bold">OVER TRANSIT</h5>
                            <div class="table-wrapper p-3">
                                <table id="tbl-ot" class="table table-hover table-bordered" style="margin-top:0px !important;">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- END OVER TRANSIT -->
                    </div>`;
        },
        otd_dashboard: function(){
            return `<div id="dashboard-page" class="page-box row">
                        <div class="col-sm-12" style="height: 66px;">
                            <span style="font-size: 30px;font-family: Montserrat;" class="font-lighter mt-2 d-inline-block">
                                <span class="text-success" style="font-weight: 500;">On Time Departure</span> Dashboard
                            </span>
                            <span class="float-right" style="max-width:420px;margin-top: 17px;">
                                <span id="export-container" class="normal-button d-inline-block"></span>
                                <span class="d-inline-block">
                                    <div class="input-group" style="max-width: 250px;">
                                        <span class="input-group-addon"><i id="icon-date" class="la la-calendar"></i></span>
                                        <input id="_date" class="form-control" type="text" readonly>
                                    </div>
                                </span>
                            </span>
                            <div class="text-muted">Last Refresh: <span id="last-refresh">-</span></div>
                        </div>
                        <div class="col-sm-12">
                            <div class="col-sm-12 p-0">
                                <ul style="list-style: none;padding: 0;display: table;width: 100%;table-layout: fixed;margin-bottom: -1px;">
                                    <li style="border: 1px solid #d1d6e6;padding: 10px;display: table-cell;">
                                        <span style="font-size: 10px;display: block;color: #919191;">Total Trucks</span>
                                        <span style="font-size: 32px;display: block;font-weight: bold;" summary="total">0</span>
                                    </li>
                                    <li style="border: 1px solid #d1d6e6;padding: 10px;display: table-cell;">
                                        <span style="font-size: 10px;display: block;color: #919191;">12:00 AM to 7:00 AM</span>
                                        <span style="font-size: 20px;display: block;font-weight: bold;" summary="12:00 AM - 07:00 AM-number">0</span>
                                        <span style="font-size: 12px;color: #02a249;" summary="12:00 AM - 07:00 AM-percent">-%</span>
                                    </li>
                                    <li style="border: 1px solid #d1d6e6;padding: 10px;display: table-cell;">
                                        <span style="font-size: 10px;display: block;color: #919191;">7:01 AM to 9:00 AM</span>
                                        <span style="font-size: 20px;display: block;font-weight: bold;" summary="7:01 AM - 9:00 AM-number">0</span>
                                        <span style="font-size: 12px;color: #02a249;" summary="7:01 AM - 9:00 AM-percent">-%</span>
                                    </li>
                                    <li style="border: 1px solid #d1d6e6;padding: 10px;display: table-cell;">
                                        <span style="font-size: 10px;display: block;color: #919191;">9:01 AM to 12:00 PM</span>
                                        <span style="font-size: 20px;display: block;font-weight: bold;" summary="9:01 AM - 12:00 PM-number">0</span>
                                        <span style="font-size: 12px;color: #02a249;" summary="9:01 AM - 12:00 PM-percent">-%</span>
                                    </li>
                                    <li style="border: 1px solid #d1d6e6;padding: 10px;display: table-cell;">
                                        <span style="font-size: 10px;display: block;color: #919191;">12:01 PM to 3:00 PM</span>
                                        <span style="font-size: 20px;display: block;font-weight: bold;" summary="12:01 PM - 3:00 PM-number">0</span>
                                        <span style="font-size: 12px;color: #02a249;" summary="12:01 PM - 3:00 PM-percent">-%</span>
                                    </li>
                                    <li style="border: 1px solid #d1d6e6;padding: 10px;display: table-cell;">
                                        <span style="font-size: 10px;display: block;color: #919191;">3:01 PM to 5:00 PM</span>
                                        <span style="font-size: 20px;display: block;font-weight: bold;" summary="3:01 PM - 5:00 PM-number">0</span>
                                        <span style="font-size: 12px;color: #02a249;" summary="3:01 PM - 5:00 PM-percent">-%</span>
                                    </li>
                                    <li style="border: 1px solid #d1d6e6;padding: 10px;display: table-cell;">
                                        <span style="font-size: 10px;display: block;color: #919191;">5:01 PM to 11:59 PM</span>
                                        <span style="font-size: 20px;display: block;font-weight: bold;" summary="5:01 PM - 11:59 PM-number">0</span>
                                        <span style="font-size: 12px;color: #02a249;" summary="5:01 PM - 11:59 PM-percent">-%</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-sm-12 p-0 mb-3" style="border: 1px solid #d1d6e6;">
                                <div id="area-chart-loading" style="position: absolute;text-align: center;width: 100%;height: 100%;padding-top: 100px;background-color: #0d0d0d17;">Loading...</div>
                                <canvas id="area-chart" height="100" style="padding:20px 0px;"></canvas>
                            </div>
                            <div class="col-sm-12 p-0">
                                <table id="summary-tbl" class="display" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th colspan="2">Period</th>
                                            <th colspan="2">12:00 AM to 7:00 AM</th>
                                            <th colspan="2">7:01 AM to 9:00 AM</th>
                                            <th colspan="2">9:01 AM to 12:00 PM</th>
                                            <th colspan="2">12:01 PM to 3:00 PM</th>
                                            <th colspan="2">3:01 PM to 5:00 PM</th>
                                            <th colspan="2">5:01 PM to 11:59 PM</th>
                                        </tr>
                                        <tr>
                                            <th>DC</th>
                                            <th>Total Trucks</th>
                                            <th>Number</th>
                                            <th>%</th>
                                            <th>Number</th>
                                            <th>%</th>
                                            <th>Number</th>
                                            <th>%</th>
                                            <th>Number</th>
                                            <th>%</th>
                                            <th>Number</th>
                                            <th>%</th>
                                            <th>Number</th>
                                            <th>%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        dispatch: function(){
            var scheduledDateHTML = "";            
            var roundtripHTML = "";
            
            if(clientCustom.roundtrip === true){
                roundtripHTML = `<option value="onSite">On-Site</option>
                                <option value="returning">Returning</option>`;
            }
            if(clientCustom.scheduled === true){
                scheduledDateHTML = `<div>
                                        <div style="font-size: 10px;">Scheduled Date:</div>
                                        <input type="text" id="_scheduled_date" class="clearable form-control" style="padding-left: 10px;" noval=true readonly>
                                    </div>`;
            }

            var sliderClone = "";
            if(ENVIRONMENT == "development"){
                sliderClone = SLIDER.CLONE(`<div>
                                                <div style="font-size: 10px;">Posting Date:</div>
                                                <input type="text" id="clone_posting_date" class="clearable form-control" style="padding-left: 10px;" value="${DEFAULT_DATE}" default=true readonly>
                                            </div>
                                            <div class="mt-2 font-10">Note: Existing shipment numbers will not be cloned.</div>`);
            }

            return `<div class="page-box row">
                        ${SLIDER.FILTER(`<div>
                                            <div style="font-size: 10px;">Departure Date:</div>
                                            <input type="text" id="_departure_date" class="clearable form-control" style="padding-left: 10px;" noval=true readonly>
                                        </div>
                                        <div>
                                            <div style="font-size: 10px;">Posting Date:</div>
                                            <input type="text" id="_posting_date" class="clearable form-control" style="padding-left: 10px;" value="${DEFAULT_DATE}" default=true readonly>
                                        </div>
                                        ${scheduledDateHTML}
                                        <div class="mt-2">
                                            <div style="font-size: 10px;">Status:</div>
                                            <select id="_status" class="form-control" style="width:100%;">
                                                <option value="all">All</option>
                                                <option value="plan">Plan</option>
                                                <option value="scheduled">Scheduled</option>
                                                <option value="assigned">Assigned</option>
                                                <option value="queueingAtOrigin">Queueing (Origin)</option>
                                                <option value="processingAtOrigin">Processing (Origin)</option>
                                                <option value="idlingAtOrigin">Idling (Origin)</option>
                                                <option value="in_transit">In Transit</option>
                                                ${roundtripHTML}
                                                <option value="complete">Complete</option>
                                                <option value="incomplete">Incomplete</option>
                                            </select>
                                        </div>
                                        <div class="mt-2">
                                            <div style="font-size: 10px;">Region:</div>
                                            <select id="_region" class="form-control" style="width:100%;"></select>
                                        </div>
                                        <div class="mt-2">
                                            <div style="font-size: 10px;">Cluster:</div>
                                            <select id="_cluster" class="form-control" style="width:100%;"></select>
                                        </div>
                                        <div class="mt-2">
                                            <div style="font-size: 10px;">Origin:</div>
                                            <select id="_origin_id" class="form-control" style="width:100%;"></select>
                                        </div>
                                        <div class="mt-2">
                                            <div style="font-size: 10px;">Destination:</div>
                                            <select id="_destination_id" class="form-control" style="width:100%;"></select>
                                        </div>`)}
                        ${sliderClone}
                        <div id="alert"></div>
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-dispatch" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="search-alert" class="col-sm-12 p-0" style="display:none;"></div>
                    </div>`;
        },
        shift_schedule: function(){
            return `<div class="page-box row">
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-shift_schedule" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        dispatch_deleted: function(){
            return `<div class="page-box row">
                        ${SLIDER.FILTER(`<div>
                                            <div style="font-size: 10px;">Deleted Date:</div>
                                            <input type="text" id="_timestamp" class="clearable form-control" style="padding-left: 10px;" value="${DEFAULT_DATE}" default=true readonly>
                                        </div>
                                        <div>
                                            <div style="font-size: 10px;">Posting Date:</div>
                                            <input type="text" id="_posting_date" class="clearable form-control" style="padding-left: 10px;" noval=true readonly>
                                        </div>`)}
                        <div id="alert"></div>
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-dispatch_deleted" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="search-alert" class="col-sm-12 p-0" style="display:none;"></div>
                    </div>`;
        },
        reports: function(){
            /*
                Deployment Visibility Report - dvr 
                CICO Report - cicor
                Delay Report - dr
                Over Transit Report - otr
                Per Base Plant Activity - pbpa
                Haulage Window Time Report - hwtr
                Attendance Report - ar
                Trippage Report - tr
                Vehicle CICO Report - vcr
                User Login Activity Report - ular
                DE Summary Report - desr
                Scheduled Entries Report - ser
                Manpower and Truck Utilization Report - mtur
                Check In Check Out Report - ci_co_r
            */
           
            var reportsHTML = "";
            var i = 0;
            function htmlTags(buttonHTML){
                if(i == 0) reportsHTML +=  '<div class="col-sm-4 mt-3">';

                buttonHTML ? reportsHTML +=  buttonHTML : null;
                i++;

                if(i == 9) {
                    reportsHTML +=  '</div>';
                    i = 0;
                }
            }
            htmlTags();
            if(clientCustom.reports.dvr){
                htmlTags(`<div class="custom-btn-01 col-sm-12 pt-2 pb-2 pr-3 pl-3 disabled" no_function>
                            <span>Deployment Visibility Report</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }
            if(clientCustom.reports.cicor){
                htmlTags(`<div cicor class="custom-btn-01 col-sm-12 mt-1 pt-2 pb-2 pr-3 pl-3 disabled">
                            <span>CICO Report</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }
            if(clientCustom.reports.dr){
                htmlTags(`<div dr class="custom-btn-01 col-sm-12 mt-1 pt-2 pb-2 pr-3 pl-3 disabled">
                            <span>Delay Report</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }
            if(clientCustom.reports.otr){
                htmlTags(`<div otr class="custom-btn-01 col-sm-12 mt-1 pt-2 pb-2 pr-3 pl-3 disabled">
                            <span>Transit Report</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }
            if(clientCustom.reports.pbpa){
                htmlTags(`<div pbpa class="custom-btn-01 col-sm-12 mt-1 pt-2 pb-2 pr-3 pl-3 disabled">
                            <span>Per Base Plant Activity</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }
            if(clientCustom.reports.hwtr){
                htmlTags(`<div hwtr class="custom-btn-01 col-sm-12 mt-1 pt-2 pb-2 pr-3 pl-3 disabled">
                            <span>Haulage Window Time Report</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }
            if(clientCustom.reports.ar){
                const attr = (clientCustom.reports.ar == "no_function") ? "" : "ar";
                const noFunction = (clientCustom.reports.ar == "no_function") ? "no_function" : "";
                htmlTags(`<div ${attr} class="custom-btn-01 col-sm-12 mt-1 pt-2 pb-2 pr-3 pl-3 disabled" ${noFunction}>
                            <span>Attendance Report</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }
            if(clientCustom.reports.tr){
                htmlTags(`<div tr class="custom-btn-01 col-sm-12 mt-1 pt-2 pb-2 pr-3 pl-3 disabled">
                            <span>Trippage Report</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }
            if(clientCustom.reports.vcr){
                htmlTags(`<div vcr class="custom-btn-01 col-sm-12 mt-1 pt-2 pb-2 pr-3 pl-3 disabled">
                            <span>Vehicle CICO Report</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }
            if(((clientCustom.reports.ular||{}).roles||[]).includes(USER.role)){
                htmlTags(`<div ular class="custom-btn-01 col-sm-12 pt-2 pb-2 pr-3 pl-3 disabled">
                            <span>User Login Activity Report</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }
            if(clientCustom.reports.desr){
                htmlTags(`<div desr class="custom-btn-01 col-sm-12 mt-1 pt-2 pb-2 pr-3 pl-3 disabled">
                            <span>Dispatch Entries Summary Report</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }
            if(clientCustom.reports.ser){
                htmlTags(`<div ser class="custom-btn-01 col-sm-12 mt-1 pt-2 pb-2 pr-3 pl-3 disabled">
                            <span>Scheduled Entries Report</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }
            if(clientCustom.reports.mtur){
                htmlTags(`<div mtur class="custom-btn-01 col-sm-12 mt-1 pt-2 pb-2 pr-3 pl-3 disabled">
                            <span>Manpower and Truck Utilization Report</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }
            if(clientCustom.reports.ci_co_r){
                htmlTags(`<div ci_co_r class="custom-btn-01 col-sm-12 mt-1 pt-2 pb-2 pr-3 pl-3 disabled">
                            <span>Check In Check Out Report</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }
            if(clientCustom.reports.otdr){
                htmlTags(`<div otdr class="custom-btn-01 col-sm-12 mt-1 pt-2 pb-2 pr-3 pl-3 disabled">
                            <span>On Time Departure Report</span>
                            <span class="float-right pt-1 pl-3 "><i class="la la-spin la-spinner"></i></span>
                        </div>`);
            }


            if(i < 9){
                i = 8;
                htmlTags();
            }
            
            

            return `<div class="page-box row">
                        ${reportsHTML}
                        <div style="font-size: 9px;font-weight: 100;" class="col-sm-12 text-muted mt-5">
                            Please click 'Yes' when a pop-up appears saying "The file format and extension of 'FILENAME.xls' don't match. The file could be corrupted or unsafe. Unless you trust its source, don't open it. Do you want to open it anyway?".
                        </div>
                    </div>`;
        },
        notifications: function(){
            return `<div class="page-box row">
                        ${SLIDER.FILTER(`<div>
                                                <div style="font-size: 10px;">Date & Time:</div>
                                                <input type="text" id="_timestamp" class="clearable form-control" style="padding-left: 10px;" value="${DEFAULT_DATE}" readonly>
                                            </div>
                                            <div class="mt-2">
                                                <div style="font-size: 10px;">Delay Type:</div>
                                                <select id="_delay_type" class="form-control">
                                                    <option value="all">All</option>
                                                    <option value="Over CICO">Over CICO</option>
                                                    <option value="Long Queueing">Long Queueing</option>
                                                    <option value="Over Transit">Over Transit</option>
                                                </select>
                                            </div>
                                            <div class="mt-2">
                                                <div style="font-size: 10px;">Escalation:</div>
                                                <select id="_escalation" class="form-control">
                                                    <option value="all">All</option>
                                                    <option value="1">1</option>
                                                    <option value="2">2</option>
                                                    <option value="3">3</option>
                                                </select>
                                            </div>`)}
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-notifications" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        event_viewer: function(){
            return `<div class="page-box row">
                        ${SLIDER.FILTER(`<div>
                                                <div style="font-size: 10px;">Date:</div>
                                                <input type="text" id="_date" class="clearable form-control" style="padding-left: 10px;" value="${DEFAULT_DATE}" readonly>
                                            </div>`)}
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-events" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        all_events: function(){
            return `<div class="page-box row">
                        ${SLIDER.FILTER(`<div>
                                                <div style="font-size: 10px;">Date:</div>
                                                <input type="text" id="_date" class="clearable form-control" style="padding-left: 10px;" value="${DEFAULT_DATE}" readonly>
                                            </div>`)}
                        <div class="col-sm-12 mt-2">
                            ${ALERT.HTML.INFO("This page displays all events sent by vehicles to WRU Dispatch. These events are saved regardless of conditions unlike in Event Viewer Page.","ml-0 mr-0 mt-2 mb-3",true)}
                            <div class="table-wrapper">
                                <table id="tbl-all-events" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        eco_driving: function(){
            return `<div class="page-box row">
                        ${SLIDER.FILTER(`<div class="mt-2">
                                            <div style="font-size: 10px;">Date:</div>
                                            <span class="d-block"">
                                                <div class="input-group" style="width: 100%;">
                                                    <span class="input-group-addon p-0">
                                                        <ul class="nav navbar-nav navbar-left">
                                                            <li class="dropdown">
                                                                <a href="#" data-toggle="dropdown" class="dropdown-toggle p-0" style="line-height:  10px !important;color: unset !important;padding: 6px 12px !important;vertical-align: top;display: inline;" aria-expanded="false">
                                                                    <span><b>DAY</b></span>
                                                                </a>
                                                                <ul class="dropdown-menu logged-user-menu" style="min-width: 65px;z-index: 999999;">
                                                                    <li><a href="javascript:void(0);" calendarView="day" class="active"><span>Day</span></a></li>
                                                                    <li><a href="javascript:void(0);" calendarView="month"><span>Month</span></a></li>
                                                                    <li><a href="javascript:void(0);" calendarView="year"><span>Year</span></a></li>
                                                                </ul>
                                                            </li>
                                                        </ul>
                                                    </span>
                                                    <input id="_date" class="form-control" type="text" value="${DEFAULT_DATE}" readonly>
                                                </div>
                                            </span>
                                        </div>
                                        <div class="mt-2">
                                            <div style="font-size: 10px;">Region:</div>
                                            <select id="_region_id" class="form-control" style="width:100%;"> </select>
                                        </div>
                                        <div class="mt-2">
                                            <div style="font-size: 10px;">Cluster:</div>
                                            <select id="_cluster_id" class="form-control" style="width:100%;"></select>
                                        </div>
                                        `)}
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-eco_driving" class="table table-hover table-bordered">
                                    <thead>
                                        <tr>
                                            <th rowspan="2">Name</th>
                                            <th rowspan="2">Days</th>
                                            <th rowspan="2">Class</th>
                                            <th rowspan="2">Score</th>
                                            <th rowspan="2">Dist</th>
                                            <th colspan="2">Speed</th>
                                            <th colspan="3">Events</th>
                                            <th colspan="3">Time</th>
                                            <th colspan="3">Location</th>
                                        </tr>
                                        <tr>
                                            <th>Max</th>
                                            <th>Avg</th>
                                            <th>Brake</th>
                                            <th>Acc</th>
                                            <th>O-spd</th>
                                            <th>Trip</th>
                                            <th>Idle</th>
                                            <th>O-spd</th>
                                            <th>Site</th>
                                            <th>Cluster</th>
                                            <th>Region</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="summary-table-wrapper">
                                <table id="tbl-eco_driving_summary" class="table table-hover table-bordered">
                                    <thead>
                                        <tr>                                            
                                            <th>Region</th>
                                            <th>Cluster</th>
                                            <th>Brake</th>
                                            <th>Acc</th>
                                            <th>O-spd</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        otd_events: function(){
            return `<div class="page-box row">
                        ${SLIDER.FILTER(`<div>
                                                <div style="font-size: 10px;">Date:</div>
                                                <input type="text" id="_date" class="clearable form-control" style="padding-left: 10px;" value="${DEFAULT_DATE}" readonly>
                                            </div>`)}
                        <div class="col-sm-12 mt-2">
                            ${ALERT.HTML.INFO("This page displays all overspeeding events sent by vehicles to WRU Dispatch.","ml-0 mr-0 mt-2 mb-3",true)}
                            <div class="table-wrapper">
                                <table id="tbl-otd-events" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        cico_events: function(){
            return `<div class="page-box row">
                        ${SLIDER.FILTER(`<div>
                                                <div style="font-size: 10px;">Date:</div>
                                                <input type="text" id="_date" class="clearable form-control" style="padding-left: 10px;" value="${DEFAULT_DATE}" readonly>
                                            </div>`)}
                        <div class="col-sm-12 mt-2">
                            ${ALERT.HTML.INFO("This page displays all overspeeding events sent by vehicles to WRU Dispatch.","ml-0 mr-0 mt-2 mb-3",true)}
                            <div class="table-wrapper">
                                <table id="tbl-cico-events" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        users: function(){
            return `<div class="page-box row">
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-users" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        regions: function(){
            return `<div class="page-box row">
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-regions" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        clusters: function(){
            return `<div class="page-box row">
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-clusters" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        geofences: function(){
            return `<div class="page-box row">
                ${SLIDER.FILTER(`<div class="mt-2">
                                    <div style="font-size: 10px;">Region:</div>
                                    <select id="_region_id" class="form-control" style="width:100%;"> </select>
                                </div>
                                <div class="mt-2">
                                    <div style="font-size: 10px;">Cluster:</div>
                                    <select id="_cluster_id" class="form-control" style="width:100%;"></select>
                                </div>`)}
                        <div class="col-sm-12 mt-2">
                            <small class="text-muted mb-2 d-block font-italic">Note: Changes made in <u data-toggle="tooltip" title="${CLIENT.ggsURL}">WRU Main</u> will reflect here after 2-4 minutes.</small>
                            <div class="table-wrapper">
                                <table id="tbl-geofences" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        routes: function(){
            return `<div class="page-box row">
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-routes" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        vehicles: function(){
            return `<div class="page-box row">
                        ${SLIDER.FILTER(`<div class="mt-2">
                                            <div style="font-size: 10px;">Site:</div>
                                            <select id="_site" class="form-control">
                                                <option value="All">All</option>
                                            </select>
                                        </div>`)}
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <small class="text-muted mb-2 d-block font-italic">Note: Changes made in <u data-toggle="tooltip" title="${CLIENT.ggsURL}">WRU Main</u> will reflect here after 2-4 minutes.</small>
                                <table id="tbl-vehicles" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        fuel_refill: function(){
            return `<div class="page-box row">
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-fuel_refill" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        vehicle_personnel: function(){
            return `<div class="page-box row">
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-vehicle_personnel" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        trailers: function(){
            return `<div class="page-box row">
                        ${SLIDER.FILTER(`<div class="mt-2">
                                            <div style="font-size: 10px;">Site:</div>
                                            <select id="_site" class="form-control">
                                                <option value="All">All</option>
                                            </select>
                                        </div>`)}
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-trailers" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        customers: function(){
            return `<div class="page-box row">
                        ${ALERT.HTML.INFO('Please search by filtering the Customer Number or Name from the search box below.','ml-3 mr-3 mt-2 mb-1')}
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-customers" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        chassis: function(){
            return `<div class="page-box row">
                        ${SLIDER.FILTER(`<div class="mt-2">
                                            <div style="font-size: 10px;">Site:</div>
                                            <select id="_site" class="form-control">
                                                <option value="All">All</option>
                                            </select>
                                        </div>`)}
                        <div class="col-sm-12 mt-2">
                            <div class="table-wrapper">
                                <table id="tbl-chassis" class="table table-hover table-bordered">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
        },
        calendar: function(){
            return `<div id='wrap'>
                        <div id='calendar'></div>
                        <div style='clear:both'></div>
                        <div>
                            <div class="col-sm-12 mt-3 mb-3">
                                <div style="font-weight: normal;margin-bottom: 3px;">Legend:</div>
                                <div>
                                    <span style="width: 10px;height: 10px;display: inline-block;background-color: #b79e7d;border-radius: 20px;margin-right: 13px;"></span>National Holiday
                                </div>
                                <div>
                                    <span style="width: 10px;height: 10px;display: inline-block;background-color: #9abd8d;border-radius: 20px;margin-right: 13px;"></span>Custom Event
                                </div>
                            </div>
                        </div>
                    </div>`;
        },
        changelogs: function(){
            return `<div class="page-box row">
                        <div>
                            <span class="ml-3 font-16">Current version: <b id="version"></b></span>
                            <i id="guide-btn" class="la la-info-circle float-right pl-3 pr-3 pb-3 font-18" data-toggle="tooltip" title="Changelog Guide" style="cursor:pointer;"></i>
                        </div>
                    </div>`;
        },
        new_version: function(){
            return `<div style="height: 100%;width: 100%;position: absolute;top: 0px;left: 0px;z-index: 99999999999;background-color: #0000002b;">
                        <div style="display: table; height: 100%;  overflow: hidden;margin: auto;text-align: center;">
                            <div style="#position: absolute; #top: 50%;display: table-cell; vertical-align: middle;">
                                <div style="  background-color: white;padding: 75px 100px;color: #404040;font-size: 14px;border-radius: 4px;">
                                    <h3>A new version of WD is available.</h3>
                                    <div style="margin-top: 12px;"><a href="javascript:window.location.reload(true)">Click this to refresh.</a></div>
                                </div>
                            </div>
                        </div>
                    </div>`;
        }
    };
};
const modalViews = new function(){
    return {
        vehicles: {
            view: {
                coket1: function(_id){
                    var obj = getVehicle(_id) || {};
            
                    return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;z-index:999999 !important;">
                                    <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                                        <div role="document" class="modal-dialog modal-lg" style="margin:20px auto;width:90%;">
                                            <div class="modal-content">
                                                <div class="modal-header pb-2">
                                                    <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                                    <div id="title-container" class="float-left">
                                                        <h4 class="modal-title" id="myModalLabel2"><b>Vehicles</b></h4>
                                                        <div>Full Details</div>
                                                    </div>
                                                </div>
                                                <div class="modal-body row pl-0 pt-0 pb-0">
                                                    <div class="main-details col-sm-8" style="padding: 15px 0px 10px 30px !important;min-height:350px;">
                                                        <h5 class="mt-0">Truck Details</h5>
                                                        <table style="width: 100%;">
                                                            <tbody>
                                                                ${MODAL.TABLEVIEW().getTr("Vehicle Name",obj.name || "-")} 
                                                                ${MODAL.TABLEVIEW().getTr("Trailer",obj["Trailer"]||"-")}
                                                                ${MODAL.TABLEVIEW().getTr("Equipment Number",obj["Equipment Number"]||"-")}
                                                                ${MODAL.TABLEVIEW().getTr("Conduction Number",obj["Tractor Conduction"]||"-")}
                                                                ${MODAL.TABLEVIEW().getTr("Site",obj["Site"]||"-")}
                                                                ${MODAL.TABLEVIEW().getTr("Availability",obj["Availability"]||"-")}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="history-details col-sm-4" style="overflow-y: auto;padding: 0px !important;border-left:1px solid #eee;">
                                                        <h5 style="border-bottom:1px solid #eee;" class="pl-2 pb-2 border-bottom">Location Logs</h5>
                                                        <div id="history-logs" class="pl-2 pr-2" style="width: 100%; overflow: auto;white-space: nowrap;">${modalViews.vehicles.location_history(_id)}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
                },
                wilcon: function(_id){
                    const modalWidth = USER.role == "developer" ? "width:90%;" : "";
                    const mainModalBodyWidth = USER.role == "developer" ? "col-sm-8" : "col-sm-12";
                    const locationLogs = USER.role == "developer" ? `
                                            <div class="history-details col-sm-4" style="overflow-y: auto;padding: 0px !important;border-left:1px solid #eee;">
                                                <h5 style="border-bottom:1px solid #eee;" class="pl-2 pb-2 border-bottom">Location Logs</h5>
                                                <div id="history-logs" class="pl-2 pr-2" style="width: 100%; overflow: auto;white-space: nowrap;">${modalViews.vehicles.location_history(_id)}</div>
                                            </div>` : "";
                    var obj = getVehicle(_id) || {};
            
                    var section = (LIST["vehicles_section"]) ? (getVehiclesSection(obj.section_id) || {}).section : `<small class="font-italic text-muted">loading...</small>`;
                    var company = (LIST["vehicles_company"]) ? (getVehiclesCompany(obj.company_id) || {}).company : `<small class="font-italic text-muted">loading...</small>`;
            
                    return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;z-index:999999 !important;">
                                    <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                                        <div role="document" class="modal-dialog modal-lg" style="margin:20px auto;${modalWidth}">
                                            <div class="modal-content">
                                                <div class="modal-header pb-2">
                                                    <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                                    <div id="title-container" class="float-left">
                                                        <h4 class="modal-title" id="myModalLabel2"><b>Vehicles</b></h4>
                                                        <div>Full Details</div>
                                                    </div>
                                                </div>
                                                <div class="modal-body row pl-0 pt-0 pb-0">
                                                    <div class="main-details ${mainModalBodyWidth}" style="padding: 15px 0px 10px 30px !important;min-height:350px;">
                                                        <h5 class="mt-0">Truck Details</h5>
                                                        <table style="width: 100%;">
                                                            <tbody>
                                                                ${MODAL.TABLEVIEW().getTr("Vehicle Name",obj.name || "-")} 
                                                                ${MODAL.TABLEVIEW().getTr("Plate Number",obj["Plate Number"]||"-")}
                                                                ${MODAL.TABLEVIEW().getTr("Truck Number",obj["Truck Number"]||"-")}
                                                                ${MODAL.TABLEVIEW().getTr("Truck Type",obj.truck_type||"-")}
                                                                ${MODAL.TABLEVIEW().getTr("Body Type",obj.body_type||"-")}
                                                                ${MODAL.TABLEVIEW().getTr("Year Model",obj.year_model||"-")}
                                                                ${MODAL.TABLEVIEW().getTr("Section",section || "-")}
                                                                ${MODAL.TABLEVIEW().getTr("Company",company || "-")}
                                                            </tbody>
                                                        </table>
                                                        <h5 class="mt-4 col-sm-12 p-0">LTO Registration</h5>
                                                        <table style="width: 100%;">
                                                            <tbody>
                                                                ${MODAL.TABLEVIEW().getTr("Registration Month",obj.registration_month || "-")} 
                                                                ${MODAL.TABLEVIEW().getTr("Registration Status",obj.registration_status||"-")}
                                                            </tbody>
                                                        </table>
                                                        <h5 class="mt-4 col-sm-12 p-0">LTFRB Registration</h5>
                                                        <table style="width: 100%;">
                                                            <tbody>
                                                                ${MODAL.TABLEVIEW().getTr("Case Number",obj.case_number || "-")} 
                                                                ${MODAL.TABLEVIEW().getTr("Status",obj.ltfrb_status||"-")}
                                                                ${MODAL.TABLEVIEW().getTr("Issued Date",DATETIME.FORMAT(obj.issued_date,"MMM DD, YYYY"))}
                                                                ${MODAL.TABLEVIEW().getTr("Expiry Date",DATETIME.FORMAT(obj.expiry_date,"MMM DD, YYYY"))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    ${locationLogs}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
                },
                coket2: function(_id){
                    var obj = getVehicle(_id) || {};
            
                    return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;z-index:999999 !important;">
                                    <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                                        <div role="document" class="modal-dialog modal-lg" style="margin:20px auto;width:90%;">
                                            <div class="modal-content">
                                                <div class="modal-header pb-2">
                                                    <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                                    <div id="title-container" class="float-left">
                                                        <h4 class="modal-title" id="myModalLabel2"><b>Vehicles</b></h4>
                                                        <div>Full Details</div>
                                                    </div>
                                                </div>
                                                <div class="modal-body row pl-0 pt-0 pb-0">
                                                    <div class="main-details col-sm-8" style="padding: 15px 0px 10px 30px !important;min-height:350px;">
                                                        <h5 class="mt-0">Truck Details</h5>
                                                        <table style="width: 100%;">
                                                            <tbody>
                                                                ${MODAL.TABLEVIEW().getTr("Vehicle Name",obj.name || "-")} 
                                                                ${MODAL.TABLEVIEW().getTr("Trailer",obj["Trailer"]||"-")}
                                                                ${MODAL.TABLEVIEW().getTr("Equipment Number",obj["Equipment Number"]||"-")}
                                                                ${MODAL.TABLEVIEW().getTr("Conduction Number",obj["Tractor Conduction"]||"-")}
                                                                ${MODAL.TABLEVIEW().getTr("Site",obj["Site"]||"-")}
                                                                ${MODAL.TABLEVIEW().getTr("Availability",obj["Availability"]||"-")}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="history-details col-sm-4" style="overflow-y: auto;padding: 0px !important;border-left:1px solid #eee;">
                                                        <h5 style="border-bottom:1px solid #eee;" class="pl-2 pb-2 border-bottom">Location Logs</h5>
                                                        <div id="history-logs" class="pl-2 pr-2" style="width: 100%; overflow: auto;white-space: nowrap;">${modalViews.vehicles.location_history(_id)}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>`;
                },
            },
            location_history: function(_id){
                var obj = getVehicleHistory(_id) || {};
                var loc = obj.location || [];
                var modalBody = "",  
                    locationTbl = function(id,short_name,tr,_class){
                        _class = _class || "";
                        modalBody += `<div class="col-sm-12 p-0 ${_class}">
                                        <span class="font-14 font-normal">${short_name}</span>
                                        <table id="${id}" class="table " style="width:100%;">
                                            <thead></thead>
                                            <tbody>
                                                ${tr}
                                            </tbody>
                                        </table>
                                    </div>`;
                    };
                for(var i = loc.length-1; i >= 0; i--){
                    var trs = "";
                    loc[i].events.forEach(val => {
                        trs += `<tr>
                                    <td style="border:none;">${DATETIME.FORMAT(new Date(val.timestamp),"MMM D, YYYY, h:mm:ss A")}</td>
                                    <td>${val.RULE_NAME} (<span class="${((val.stage=="start")?"text-success":"text-danger")}">${val.stage}</span>)</td>
                                </tr>`
                    });
                    locationTbl(`vehicleLocation${i}`,`${loc[i].short_name} (${i+1})`,trs);
                }
                return modalBody;
            },
            data_maintenance: function(){
                return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                            <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                                <div role="document" class="modal-dialog modal-md">
                                    <div class="modal-content">
                                        <div class="modal-header pb-2">
                                            <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                            <h4 class="modal-title" id="myModalLabel2">Data Maintenance</h4>
                                        </div>
                                        <div class="modal-body row pt-2">
                                            <div id="modal-error"></div>
                                            <div class="col-sm-12">
                                                <ul class="nav nav-tabs" role="tablist">
                                                    <li class="active"><a href="#vehicles_section" role="tab" data-toggle="tab">Section</a></li>
                                                    <li class=""><a href="#vehicles_company" role="tab" data-toggle="tab">Company</a></li>
                                                </ul>
                                                <div class="tab-content">
                                                    <div class="tab-pane fade in active" id="vehicles_section">
                                                        <div class="pb-2" style="border-bottom: 1px solid #eee;">
                                                            <input id="section" class="form-control" type="text" placeholder="Enter item" style="width: 80%;display: inline-block;">
                                                            <div style="width: 19%;" class="d-inline-block pl-2">
                                                                <button id="section-btn" class="form-control">Submit</button>
                                                            </div>
                                                        </div>
                                                        <div id="section-list" style="max-height: 300px;overflow-y: auto;">
                                                            <i class="la la-spin la-spinner" style="font-size: 18px;margin-top: 10px;color: #cecece;"></i>
                                                        </div>
                                                    </div>
                                                    <div class="tab-pane fade" id="vehicles_company">
                                                        <div class="pb-2" style="border-bottom: 1px solid #eee;">
                                                            <input id="company" class="form-control" type="text" placeholder="Enter item" style="width: 80%;display: inline-block;">
                                                            <div style="width: 19%;" class="d-inline-block pl-2">
                                                                <button id="company-btn" class="form-control">Submit</button>
                                                            </div>
                                                        </div>
                                                        <div id="company-list" style="max-height: 300px;overflow-y: auto;">
                                                            <i class="la la-spin la-spinner" style="font-size: 18px;margin-top: 10px;color: #cecece;"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
            },
            create: {}
        },
        vehicle_personnel: {
            rest_days: function(_id){
                var calendarOptions = "";
                Object.keys(vehiclePersonnelCalendarOptions).forEach(key => {
                    var val = vehiclePersonnelCalendarOptions[key];
                    calendarOptions += `<option value="_${key}">${val.optionTitle}</option>`;
                });
                var obj = getVehiclePersonnel(_id);
                return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                            <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                                <div role="document" class="modal-dialog modal-sm">
                                    <div class="modal-content">
                                        <div class="modal-header pb-2">
                                            <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                            <h4 class="modal-title" id="myModalLabel2">
                                                ${obj.name || "-"}
                                                <div class="text-muted font-10">Rest Days/On-Leave Dates</div>
                                            </h4>
                                        </div>
                                        <div class="modal-body row pt-2">
                                            <div class="col-sm-12 p-0" style="border-right: 1px solid #eee;">
                                                <div id="modal-error"></div>
                                                <div class="col-sm-12">
                                                    <small>Please choose:</small>
                                                    <select id="calendar_type" class="form-control">${calendarOptions}</select>
                                                </div>
                                                <div class="col-sm-12 mt-3" style="height: 310px;">
                                                    <input type="text" id="inline-calendar" style="opacity:0;">
                                                    <div class="fancy-checkbox custom-bgcolor-green" style="display:none;margin-top:265px;">
                                                        <label>
                                                            <input id="recurring" type="checkbox">
                                                            <span class="toggle-vis">Recurring (for the next 30 weeks)</span>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="col-sm-12"> 
                                                    <button id="submit" type="button" class="btn btn-primary col-sm-12 mt-4">Submit</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
            },
            data_maintenance: function(){
                return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                            <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                                <div role="document" class="modal-dialog modal-md">
                                    <div class="modal-content">
                                        <div class="modal-header pb-2">
                                            <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                            <h4 class="modal-title" id="myModalLabel2">Data Maintenance</h4>
                                        </div>
                                        <div class="modal-body row pt-2">
                                            <div id="modal-error"></div>
                                            <div class="col-sm-12">
                                                <ul class="nav nav-tabs" role="tablist">
                                                    <li class="active"><a href="#vehicle_personnel_section" role="tab" data-toggle="tab">Section</a></li>
                                                    <li class=""><a href="#vehicle_personnel_company" role="tab" data-toggle="tab">Company</a></li>
                                                </ul>
                                                <div class="tab-content">
                                                    <div class="tab-pane fade in active" id="vehicle_personnel_section">
                                                        <div class="pb-2" style="border-bottom: 1px solid #eee;">
                                                            <input id="section" class="form-control" type="text" placeholder="Enter item" style="width: 80%;display: inline-block;">
                                                            <div style="width: 19%;" class="d-inline-block pl-2">
                                                                <button id="section-btn" class="form-control">Submit</button>
                                                            </div>
                                                        </div>
                                                        <div id="section-list" style="max-height: 300px;overflow-y: auto;">
                                                            <i class="la la-spin la-spinner" style="font-size: 18px;margin-top: 10px;color: #cecece;"></i>
                                                        </div>
                                                    </div>
                                                    <div class="tab-pane fade" id="vehicle_personnel_company">
                                                        <div class="pb-2" style="border-bottom: 1px solid #eee;">
                                                            <input id="company" class="form-control" type="text" placeholder="Enter item" style="width: 80%;display: inline-block;">
                                                            <div style="width: 19%;" class="d-inline-block pl-2">
                                                                <button id="company-btn" class="form-control">Submit</button>
                                                            </div>
                                                        </div>
                                                        <div id="company-list" style="max-height: 300px;overflow-y: auto;">
                                                            <i class="la la-spin la-spinner" style="font-size: 18px;margin-top: 10px;color: #cecece;"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
            }
        },
        chassis: {
            data_maintenance: function(){
                return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                            <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                                <div role="document" class="modal-dialog modal-md">
                                    <div class="modal-content">
                                        <div class="modal-header pb-2">
                                            <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                            <h4 class="modal-title" id="myModalLabel2">Data Maintenance</h4>
                                        </div>
                                        <div class="modal-body row pt-2">
                                            <div id="modal-error"></div>
                                            <div class="col-sm-12">
                                                <ul class="nav nav-tabs" role="tablist">
                                                    <li class="active"><a href="#chassis_section" role="tab" data-toggle="tab">Section</a></li>
                                                    <li class=""><a href="#chassis_company" role="tab" data-toggle="tab">Company</a></li>
                                                    <li class=""><a href="#chassis_type" role="tab" data-toggle="tab">Chassis Type</a></li>
                                                </ul>
                                                <div class="tab-content">
                                                    <div class="tab-pane fade in active" id="chassis_section">
                                                        <div class="pb-2" style="border-bottom: 1px solid #eee;">
                                                            <input id="section" class="form-control" type="text" placeholder="Enter item" style="width: 80%;display: inline-block;">
                                                            <div style="width: 19%;" class="d-inline-block pl-2">
                                                                <button id="section-btn" class="form-control">Submit</button>
                                                            </div>
                                                        </div>
                                                        <div id="section-list" style="max-height: 300px;overflow-y: auto;">
                                                            <i class="la la-spin la-spinner" style="font-size: 18px;margin-top: 10px;color: #cecece;"></i>
                                                        </div>
                                                    </div>
                                                    <div class="tab-pane fade" id="chassis_company">
                                                        <div class="pb-2" style="border-bottom: 1px solid #eee;">
                                                            <input id="company" class="form-control" type="text" placeholder="Enter item" style="width: 80%;display: inline-block;">
                                                            <div style="width: 19%;" class="d-inline-block pl-2">
                                                                <button id="company-btn" class="form-control">Submit</button>
                                                            </div>
                                                        </div>
                                                        <div id="company-list" style="max-height: 300px;overflow-y: auto;">
                                                            <i class="la la-spin la-spinner" style="font-size: 18px;margin-top: 10px;color: #cecece;"></i>
                                                        </div>
                                                    </div>
                                                    <div class="tab-pane fade" id="chassis_type">
                                                        <div class="pb-2" style="border-bottom: 1px solid #eee;">
                                                            <input id="type" class="form-control" type="text" placeholder="Enter item" style="width: 80%;display: inline-block;">
                                                            <div style="width: 19%;" class="d-inline-block pl-2">
                                                                <button id="type-btn" class="form-control">Submit</button>
                                                            </div>
                                                        </div>
                                                        <div id="type-list" style="max-height: 300px;overflow-y: auto;">
                                                            <i class="la la-spin la-spinner" style="font-size: 18px;margin-top: 10px;color: #cecece;"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
            }
        },
        events: {
            details: function(id,shipment_number=[]){
                var li = "",
                        sns = "";
                    shipment_number.forEach(val => {
                        li += `<li>${val}</li>`
                    });
                    if(!CLIENT.allowDownloadFromOtherDB) {
                        sns = `<div class="col-sm-12">
                                    <b>SHIPMENT NUMBERS:</b>
                                    <ol class="pl-4">${li}</ol>
                                </div>
                                <div class="col-sm-12"><hr class="mt-2"></div>`;
                    } 
                    return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                                <div id="small-modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                                    <div class="modal-dialog modal-lg" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                                <h4 class="modal-title" id="myModalLabel2">${id}</h4>
                                            </div>
                                            <div class="modal-body row">
                                                ${sns}
                                                <div class="col-sm-12 mt-2">
                                                    <div class="table-wrapper">
                                                        <table id="tbl-notification" class="table table-hover table-bordered">
                                                            <thead>
                                                                <tr>
                                                                    <th class="col-md-3">Key</th>
                                                                    <th class="col-md-9">Value</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody></tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
            },
        },
        dispatch: {
            form: {
                coket1: function(){
                    var previousCheckIns = "";
                    if((clientCustom.previousCheckIns.roles||[]).includes(USER.role)){
                        previousCheckIns = `<div id="previous-checkins-container" style="word-break: break-word;" class="col-sm-7 mb-2">
                                                <div>Truck's Previous Check-Ins (Based on Origin)</div>
                                                <div>
                                                    <table id="previous-checkins" class="table mb-0 mt-2">
                                                        <thead>
                                                            <tr>
                                                                <td class="pt-0" style="border-color: #fff !important;">&nbsp;</td>
                                                                <td class="pt-0" style="border-color: #fff !important;"><small>Check-In Time</small></td>
                                                                <td class="pt-0" style="border-color: #fff !important;"><small>Check-Out Time</small></td>
                                                                <td class="pt-0" style="border-color: #fff !important;"><small>Origin</small></td>
                                                                <td class="pt-0" style="border-color: #fff !important;"><small>Destination</small></td>
                                                            </tr>
                                                        </thead>
                                                        <tbody></tbody>
                                                    </table>
                                                </div>
                                            </div>`;
                    }
                    return `<div class="page-box row">
                                <div id="modal-error" class="col-sm-12" style="display:none;"></div>
                                <div id="loading-text" style="display:none;" class="col-sm-12 pb-3">
                                    <small class="text-danger"><i class="la la-circle-o-notch la-spin mr-2"></i>Loading data...</small>
                                </div>
                                <div class="col-sm-12 p-0">
                                    <div class="col-sm-4">
                                        <div class="font-normal"><span class="text-danger">*</span>Shipment Number</div>
                                        <input id="shipment_number" type="text" class="form-control" placeholder="Shipment Number" autocomplete="off">
                                        <small class="text-muted" style="font-style: italic;">Once saved, shipment number cannot be edited.</small>
                                    </div>
                                    <div class="col-sm-3" id="coket1-shipment_type">
                                        <div class="font-normal"><span class="text-danger">*</span>Shipment Type</div>
                                        <div class="radio-parent" style="border: 1px solid #eee;padding: 5px 0px 6px;text-align: center;">
                                            <label class="radio radio-inline" style="margin: 0;width: 40%;">
                                                <input type="radio" name="shipment_type" value="Normal" style="margin-top: 2px;" checked> Normal
                                            </label>
                                            <label class="radio radio-inline" style="width: 40%;">
                                                <input type="radio" name="shipment_type" value="Pick-up" style="margin-top: 2px;"> Pick-up
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-12 mt-3 p-0">
                                    <div class="col-sm-4">
                                        <div class="font-normal">Origin</div>
                                        <input id="origin" type="text" class="form-control" autocomplete="off" readonly>
                                    </div>
                                    <div class="col-sm-5">
                                        <div class="font-normal"><span class="text-danger">*</span>Route</div>
                                        <select id="route" class="select-multiple-basic" style="width:100%;"></select>
                                        <small class="text-muted">Separate origin and destination by comma (,). e.g., Calasiao,BALANGA</small>
                                    </div>
                                </div>
                                <div class="col-sm-12 mt-2">
                                    <div class="table-wrapper" style="overflow: auto;">
                                        <div class="table-title">
                                            <small style="line-height: 28px;">Destination:</small>
                                        </div>
                                        <table id="tbl-destination" class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th></th>
                                                    <th class="col-md-6">Location</th>
                                                    <th class="col-md-3">Transit Time (HH:MM)</th>
                                                    <th class="col-md-3">CICO (HH:MM)</th>
                                                </tr>
                                            </thead>
                                            <tbody> </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-sm-12 p-0">
                                    <div class="col-sm-3">
                                        <div class="font-normal"><span class="text-danger">*</span>Truck</div>
                                        <select id="vehicle_id" class="select-multiple-basic" style="width:100%;"></select>
                                    </div>
                                    <div class="col-sm-3">
                                        <div class="font-normal"><span class="text-danger">*</span>Trailer</div>
                                        <select id="trailer" class="select-multiple-basic" style="width:100%;"></select>
                                    </div>
                                    <div class="col-sm-6" style="word-break: break-word;">
                                        <table class="table mb-0" trailer-based>
                                            <tbody>
                                                <tr>
                                                    <td class="pt-0" style="border-color: #fff !important;"><small>Conduction #</small></td>
                                                    <td class="pt-0" style="border-color: #fff !important;"><small>Cluster</small></td>
                                                    <td class="pt-0" style="border-color: #fff !important;"><small>Base</small></td>
                                                    <td class="pt-0" style="border-color: #fff !important;"><small>Region</small></td>
                                                    <td class="pt-0" style="border-color: #fff !important;"><small>Pallet Type</small></td>
                                                </tr>
                                            <tr>
                                                <td class="text-muted" conduction_number>-</td>
                                                <td class="text-muted" cluster>-</td>
                                                <td class="text-muted" base>-</td>
                                                <td class="text-muted" region>-</td>
                                                <td class="text-muted" pallet_type>-</td>
                                            </tr>
                                            </tbody>
                                        </table>      
                                    </div>
                                </div>
                                ${previousCheckIns}
                                <div class="col-sm-12 p-0">
                                    <div class="col-sm-7">
                                        <div class="font-normal">Comments</div>
                                        <textarea id="comments" class="form-control" rows="2"></textarea>
                                    </div>
                                </div>
                                <div class="col-sm-7 mt-3">
                                    <div class="table-wrapper">
                                        <div class="table-title">
                                            <div class="font-normal" style="display: inline-block;padding-top: 6px;">Attachments</div>
                                            <input id="new-file" type="file" class="hide">
                                            <button id="new-attachment" type="button" class="btn btn-default float-right" style="padding: 4px 10px;top: -3px;position: relative;"><i class="la la-plus"></i> Add Attachment</button>
                                        </div>
                                        <table id="tbl-attachment" class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th style="width: 35px;">#</th>
                                                    <th>Filename</th>
                                                    <th style="width: 50px;">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-sm-12"><hr></div>
                                <div class="col-sm-12"><button id="submit" type="button" class="btn btn-primary">Update</button></div>
                            </div>`;
                },
                wilcon: function(){
                    return `<div class="page-box row">
                                <div id="modal-error" class="col-sm-12" style="display:none;"></div>
                                <div id="loading-text" style="display:none;" class="col-sm-12 pb-3">
                                    <small class="text-danger"><i class="la la-circle-o-notch la-spin mr-2"></i>Loading data...</small>
                                </div>
                                <div class="col-sm-12 p-0">
                                    <div class="col-sm-4">
                                        <small><span class="text-danger">*</span>Ticket Number:</small>
                                        <input id="ticket_number" class="form-control" type="text" placeholder="Ticket Number" autocomplete="off">
                                    </div>
                                    <div class="col-sm-4">
                                        <small><span class="text-danger">*</span>Scheduled Date:</small>
                                        <input id="scheduled_date" class="form-control" type="text" onkeydown="event.preventDefault()">
                                    </div>
                                    <div class="col-sm-4">
                                        <small><span class="text-danger">*</span>Shift Schedule:</small>
                                        <select id="shift_schedule" class="select-multiple-basic" style="width:100%;"></select>
                                    </div>
                                </div>
                                <div class="col-sm-12 mt-3 p-0">
                                    <div class="col-sm-4">
                                        <small>Origin:</small>
                                        <input id="origin" type="text" class="form-control" autocomplete="off" readonly>
                                    </div>
                                    <div class="col-sm-5">
                                        <small><span class="text-danger">*</span>Route:</small>
                                        <select id="route" class="select-multiple-basic" style="width:100%;"></select>
                                        <small class="text-muted">Separate origin and destination by comma (,). e.g., Calasiao,BALANGA</small>
                                    </div>
                                </div>
                                <div class="col-sm-12 mt-2">
                                    <div class="table-wrapper" style="overflow: auto;">
                                        <div class="table-title">
                                            <small style="line-height: 28px;">Destination:</small>
                                        </div>
                                        <table id="tbl-destination" class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th></th>
                                                    <th class="col-md-6">Location</th>
                                                    <th class="col-md-3">Transit Time (HH:MM)</th>
                                                    <th class="col-md-3">CICO (HH:MM)</th>
                                                </tr>
                                            </thead>
                                            <tbody> </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-sm-12 p-0">
                                    <div class="col-sm-3">
                                        <small><span class="text-danger">*</span>Truck:</small>
                                        <select id="vehicle_id" class="select-multiple-basic" style="width:100%;"></select>
                                    </div>
                                    <div class="col-sm-3">
                                        <small>Chassis:</small>
                                        <select id="chassis" class="select-multiple-basic" style="width:100%;"></select>
                                    </div>
                                    <div class="col-sm-6" style="word-break: break-word;">
                                        <table class="table mb-0" chassis-based>
                                            <tbody>
                                                <tr>
                                                    <td class="pt-0" style="border-color: #fff !important;"><small>Chassis Type</small></td>
                                                    <td class="pt-0" style="border-color: #fff !important;"><small>Section</small></td>
                                                    <td class="pt-0" style="border-color: #fff !important;"><small>Company</small></td>
                                                </tr>
                                            <tr>
                                                <td class="text-muted" chassis_type>-</td>
                                                <td class="text-muted" section>-</td>
                                                <td class="text-muted" company>-</td>
                                            </tr>
                                            </tbody>
                                        </table>      
                                    </div>
                                </div>
                                <div class="col-sm-12 p-0 mb-3">
                                    <div class="col-sm-4">
                                        <small><span class="text-danger">*</span>Driver:</small>
                                        <select id="driver_id" class="select-multiple-basic" style="width:100%;"></select>
                                    </div>
                                    <div class="col-sm-4">
                                        <small>Checker:</small>
                                        <select id="checker_id" class="select-multiple-basic" style="width:100%;"></select>
                                    </div>
                                    <div class="col-sm-4">
                                        <small>Helper:</small>
                                        <select id="helper_id" class="select-multiple-basic" style="width:100%;"></select>
                                    </div>
                                </div>
                                <div class="col-sm-12 p-0">
                                    <div class="col-sm-7">
                                        <small>Comments:</small>
                                        <textarea id="comments" class="form-control" rows="2"></textarea>
                                    </div>
                                </div>
                                <div class="col-sm-7 mt-3">
                                    <div class="table-wrapper">
                                        <div class="table-title">
                                            <small style="line-height: 28px;">Attachment:</small>
                                            <input id="new-file" type="file" class="hide">
                                            <button id="new-attachment" type="button" class="btn btn-default float-right" style="padding: 4px 10px;top: -3px;position: relative;"><i class="la la-plus"></i> Add Attachment</button>
                                        </div>
                                        <table id="tbl-attachment" class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th style="width: 35px;">#</th>
                                                    <th>Filename</th>
                                                    <th style="width: 50px;">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="col-sm-12"><hr></div>
                                <div class="col-sm-12"><button id="submit" type="button" class="btn btn-primary">Update</button></div>
                            </div>`;
                },
                coket2: function(){
                    return `<div class="page-box row">
                                <div id="modal-error" class="col-sm-12" style="display:none;"></div>
                                <div id="loading-text" style="display:none;" class="col-sm-12 pb-3">
                                    <small class="text-danger"><i class="la la-circle-o-notch la-spin mr-2"></i>Loading data...</small>
                                </div>
                                <div class="col-sm-12 p-0">
                                    <div class="col-sm-4">
                                        <div class="font-normal"><span class="text-danger">*</span>Shipment Number</div>
                                        <input id="shipment_number" type="text" class="form-control" placeholder="Shipment Number" autocomplete="off">
                                        <small class="text-muted" style="font-style: italic;">Once saved, shipment number cannot be edited.</small>
                                    </div>
                                </div>
                                <div class="col-sm-12 mt-3 p-0">
                                    <div class="col-sm-4 p-0">
                                        <div class="col-sm-12">
                                            <div class="font-normal"><span class="text-danger">*</span>Origin</div>
                                            <select id="origin_id" class="select-multiple-basic" style="width:100%;"></select>
                                        </div>
                                        <div class="col-sm-12 mt-2">
                                            <div class="font-normal">Origin Site Code</div>
                                            <input id="origin_code" type="text" class="form-control" autocomplete="off" readonly>
                                        </div>
                                    </div>
                                    <div class="col-sm-8">
                                        <div class="font-normal"><span class="text-danger">*</span>Delivery For (Customer(s))</div>
                                        <select id="customers" class="select-multiple-basic" multiple="multiple" style="width:100%;"></select>
                                        <small class="text-muted" style="font-style: italic;">If has multiple customers, use comma in separating each customer name or customer number</small>
                                    </div>
                                </div>
                                <div class="col-sm-12 mt-3">
                                    <div class="col-sm-12" style="border: 1px solid #eee;padding: 11px 0 4px;">
                                        <div class="col-sm-3">
                                            <div class="font-normal"><span class="text-danger">*</span>Truck Plate Number</div>
                                            <select id="vehicle_id" class="select-multiple-basic" style="width:100%;"></select>
                                        </div>
                                        <div class="col-sm-2 p-0">
                                            <div class="font-normal"><span class="text-danger">*</span>Support Unit?</div>
                                            <div class="radio-parent" style="border: 1px solid #eee;padding: 5px 0px 6px;text-align: center;">
                                                <label class="radio radio-inline" style="margin: 0;width: 40%;">
                                                    <input type="radio" name="support_unit" value="Yes" style="margin-top: 2px;"> Yes
                                                </label>
                                                <label class="radio radio-inline" style="width: 40%;">
                                                    <input type="radio" name="support_unit" value="No" style="margin-top: 2px;"> No
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-sm-7" style="word-break: break-word;">
                                            <table class="table mb-0" truck-based>
                                                <tbody>
                                                    <tr>
                                                        <td class="pt-0" style="border-color: #fff !important;font-weight: normal;">Truck Base</td>
                                                        <td class="pt-0" style="border-color: #fff !important;font-weight: normal;">Base Region</td>
                                                        <td class="pt-0" style="border-color: #fff !important;font-weight: normal;">Cluster</td>
                                                        <td class="pt-0" style="border-color: #fff !important;font-weight: normal;">Pallet Capacity</td>
                                                    </tr>
                                                <tr>
                                                    <td class="text-muted" base>-</td>
                                                    <td class="text-muted" region>-</td>
                                                    <td class="text-muted" cluster>-</td>
                                                    <td class="text-muted" pallet_capacity>-</td>
                                                </tr>
                                                </tbody>
                                            </table>      
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-4 p-0 mt-3">
                                    <div class="col-sm-12">
                                        <div class="font-normal"><span class="text-danger">*</span>Shipment Type</div>
                                        <div class="radio-parent" style="border: 1px solid #eee;padding: 5px 0px 6px;text-align: center;">
                                            <label class="radio radio-inline" style="margin: 0;width: 40%;">
                                                <input type="radio" name="shipment_type" value="Unique" style="margin-top: 2px;"> Unique
                                            </label>
                                            <label class="radio radio-inline" style="width: 40%;">
                                                <input type="radio" name="shipment_type" value="Co-Load" style="margin-top: 2px;"> Co-Load
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-sm-12 mt-2">
                                        <div class="font-normal"><span class="text-danger">*</span>Delivery Sequence</div>
                                        <div class="radio-parent" style="border: 1px solid #eee;padding: 5px 0px 6px;text-align: center;">
                                            <label class="radio radio-inline" style="margin: 0;width: 40%;">
                                                <input type="radio" name="delivery_sequence" value="Initial" style="margin-top: 2px;"> Initial
                                            </label>
                                            <label class="radio radio-inline" style="width: 40%;">
                                                <input type="radio" name="delivery_sequence" value="Reload" style="margin-top: 2px;"> Reload
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-sm-12 mt-2">
                                        <div class="font-normal"><span class="text-danger">*</span>MDSD Usage</div>
                                        <div class="radio-parent" style="border: 1px solid #eee;padding: 5px 0px 6px;text-align: center;">
                                            <label class="radio radio-inline" style="margin: 0;width: 40%;">
                                                <input type="radio" name="mdsd_usage" value="Yes" style="margin-top: 2px;"> Yes
                                            </label>
                                            <label class="radio radio-inline" style="width: 40%;">
                                                <input type="radio" name="mdsd_usage" value="No" style="margin-top: 2px;"> No
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-8 p-0 mt-3">
                                    <div class="col-sm-12">
                                        <div class="font-normal">Comments</div>
                                        <textarea id="comments" class="form-control" rows="2"></textarea>
                                    </div>
                                    <div class="col-sm-12 mt-3">
                                        <div class="table-wrapper">
                                            <div class="table-title">
                                                <div class="font-normal" style="line-height: 28px;display: unset;">Attachments</div>
                                                <input id="new-file" type="file" class="hide">
                                                <button id="new-attachment" type="button" class="btn btn-default float-right" style="padding: 4px 10px;top: -3px;position: relative;"><i class="la la-plus"></i> Add Attachment</button>
                                            </div>
                                            <table id="tbl-attachment" class="table table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 35px;">#</th>
                                                        <th>Filename</th>
                                                        <th style="width: 50px;">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-12 p-0">
                                    <div style="border-top: 1px solid #eee;" class="col-sm-12 mt-2 pt-3"> 
                                        <button id="submit" type="button" class="btn btn-primary float-right">Submit</button>
                                        <button id="cancel" type="button" class="btn btn-default float-right mr-2">Cancel</button>
                                    </div>
                                </div>
                            </div>`;
                },
            },
            statusUpdate: function(_id){
                var statusHTML = "";
                (clientCustom.status.all||[]).forEach(val => {
                    const stat = GET.STATUS(val);
                    statusHTML += `<span status="${val}" class="col-sm-12 label ${stat.color} label-transparent font-12 cursor-pointer active pb-2 pt-2 mt-1 d-block">${stat.text.toUpperCase()}</span>`;
                });
                return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                            <div id="small-modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                                <div role="document" class="modal-dialog modal-sm">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                            <h4 class="modal-title" id="myModalLabel2">Update Status</h4>
                                            <small class="text-muted">Shipment Number: <b>${_id}</b></small>
                                            <small id="incomplete-data" class="text-danger d-block"></small>
                                        </div>
                                        <div class="modal-body row">
                                            <div class="col-sm-12 mb-3">${statusHTML}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
            },
            import: function(){
                return `<div class="page-box row">
                            <div class="col-md-12">
                                <span class="text-muted">Click <a id="download-template-btn" href="javascript:void(0);"class="font-normal">here</a> to download the excel template.</span>
                                <small class="text-info d-block font-italic">Excel Template Updated On: <u>04/21/2021</u></small>
                            </div>
                            <div class="col-md-12"><hr></div>
                            <div class="col-md-6">
                                <input type="file" class="dropify">
                                <button id="import-btn" class="btn btn-primary mt-3">Import</button>
                            </div>
                            <div class="col-md-6">
                                <div>
                                    <h5>Report Import:<small class="float-right"><a id="reportDL" href="#" style="display:none;" target="_blank" download="WRU Dispatch Report.txt">Download report</a></small></h5>
                                    <div>Successful imports: <b class="text-success" success_count>0</b> rows</div>
                                    <div>Warnings:</div>
                                    <ul warning_list></ul>
                                    <div>Unsuccessful imports: <b class="text-danger" error_count>0</b> rows</div>
                                    <div>Errors:</div>
                                    <ul error_list></ul>
                                </div>
                            </div>
                        </div>`;
            },
            view: {
                coket1: function(_id){
                    LIST["dispatch"] = LIST["dispatch"] || [];
                    var id_index = LIST["dispatch"].findIndex(x => x._id == _id);
                    var obj = LIST["dispatch"][id_index];
    
                    if(id_index > -1){
                        displayModal();
                    } else {
                        GET.AJAX({
                            url: `/api/dispatch/${CLIENT.id}/${USER.username}/${_id}`,
                            method: "GET",
                            headers: {
                                "Authorization": SESSION_TOKEN
                            },
                        }, function(docs){
                            obj = docs[0];
                            displayModal();
                        });
                    }
    
                    function displayModal() {
                        if(obj){
                            var de = new Dispatch(obj);
                            $(`body`).append(de.fullView());
                        }
                    }
                },
                coket2: function(_id){
                    LIST["dispatch"] = LIST["dispatch"] || [];
                    var id_index = LIST["dispatch"].findIndex(x => x._id == _id);
                    var obj = LIST["dispatch"][id_index];
    
                    if(id_index > -1){
                        displayModal();
                    } else {
                        GET.AJAX({
                            url: `/api/dispatch/${CLIENT.id}/${USER.username}/${_id}`,
                            method: "GET",
                            headers: {
                                "Authorization": SESSION_TOKEN
                            },
                        }, function(docs){
                            obj = docs[0];
                            displayModal();
                        });
                    }
    
                    function displayModal() {
                        if(obj){
                            var de = new Dispatch(obj);
                            $(`body`).append(de.fullView_2());
                        }
                    }
                },
                wilcon: function(_id){
                    LIST["dispatch"] = LIST["dispatch"] || [];
                    var id_index = LIST["dispatch"].findIndex(x => x._id == _id);
                    var obj = LIST["dispatch"][id_index];
    
                    if(id_index > -1){
                        displayModal();
                    } else {
                        GET.AJAX({
                            url: `/api/dispatch/${CLIENT.id}/${USER.username}/${_id}`,
                            method: "GET",
                            headers: {
                                "Authorization": SESSION_TOKEN
                            },
                        }, function(docs){
                            obj = docs[0];
                            displayModal();
                        });
                    }
    
                    function displayModal() {
                        if(obj){
                            var de = new Dispatch(obj);
                            $(`body`).append(de.fullView());
                        }
                    }
                }
            }
        },
        fuel_refill: {
            import: function(){
                return `<div class="page-box row">
                            <div class="col-md-12">
                                <span class="text-muted"><div style="color: #5e6773;font-weight: normal;margin-bottom: 6px;">Accepts custom tempate file** and converted file.</div>**Click <a id="download-template-btn" href="javascript:void(0);"class="font-normal">here</a> to download the excel template.</span>
                                <small class="text-info d-block font-italic">Excel Template Updated On: <u>05/07/2021</u></small>
                            </div>
                            <div class="col-md-12"><hr></div>
                            <div class="col-md-6">
                                <input type="file" class="dropify">
                                <button id="import-btn" class="btn btn-primary mt-3">Import</button>
                            </div>
                            <div class="col-md-6">
                                <div>
                                    <h5 class="mt-0">Download Links:</h5>
                                    <div class="mb-2">Successfully Converted and Imported
                                        <img src="https://icon-library.com/images/more-info-icon/more-info-icon-27.jpg" style="margin-top: -3px;" class="ml-1" width="12" data-toggle="tooltip" title="Data that were successfully converted and imported to WRU Main.">
                                        <div id="reportSuccessfulList">
                                            <div class="text-muted font-italic">No link available.</div>
                                        </div>
                                    </div>
                                    <div class="mb-2">Failed to Import
                                        <img src="https://icon-library.com/images/more-info-icon/more-info-icon-27.jpg" style="margin-top: -3px;" class="ml-1" width="12" data-toggle="tooltip" title="Data that were successfully converted but failed to import to WRU Main due to some reasons such as connectivity issue.">
                                        <div id="reportImportFailureList">
                                            <div class="text-muted font-italic">No link available.</div>
                                        </div>
                                    </div>
                                    <div class="mb-2">Error (Original Format)
                                        <img src="https://icon-library.com/images/more-info-icon/more-info-icon-27.jpg" style="margin-top: -3px;" class="ml-1" width="12" data-toggle="tooltip" title="Data that were unsuccessfully converted because of incomplete data or unable to find match for the specified Vehicle License Number.">
                                        <div id="reportErrorList">
                                            <div class="text-muted font-italic">No link available.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
            },
        },
        user: {
            create: function(title,obj,user,subtitle){
                var subtitleHTML = (subtitle) ? `<small class="text-muted">${subtitle}</small>` : "";
                var readonly = (obj||user) ? "readonly" : "";
                var finalObj = obj || user || {};
                return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                            <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                                <div role="document" class="modal-dialog modal-md" style="width:700px;">
                                    <div class="modal-content">
                                        <div class="modal-header pb-2">
                                            <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                            <h4 class="modal-title" id="myModalLabel2">${title}</h4>
                                            ${subtitleHTML}
                                        </div>
                                        <div class="modal-body row pt-2">
                                            <div class="col-sm-5 p-0" style="border-right: 1px solid #eee;">
                                                <div id="modal-error"></div>
                                                <div class="col-sm-12">
                                                    <small><span class="text-danger">*</span>Name:</small>
                                                    <input id="name" type="text" class="form-control" value="${(finalObj.name||finalObj.fullName||"")}" placeholder="Name" autocomplete="off" required>
                                                </div>
                                                <div class="col-sm-12">
                                                    <small><span class="text-danger">*</span>Username:</small>
                                                    <input id="username" type="text" class="form-control" value="${finalObj._id||finalObj.username||""}" placeholder="Username" autocomplete="off" ${readonly} required>
                                                </div>
                                                <div class="col-sm-12">
                                                    <small><span class="text-danger">*</span>Email:</small>
                                                    <input id="email" type="email" class="form-control" value="${(finalObj.email||"")}" placeholder="Email" autocomplete="off" required>
                                                </div>
                                                <div class="col-sm-12">
                                                    <small>Phone Number:</small>
                                                    <input id="phoneNumber" type="text" class="form-control" value="${(finalObj.phoneNumber||"")}" autocomplete="off">
                                                </div>
                                                <div class="col-sm-12">
                                                    <small>Role:</small>
                                                    <select id="role" class="form-control" required></select>
                                                </div>
                                                <div class="col-sm-12">
                                                    <small>Auto-logout on Window/Tab Closure:</small>
                                                    <select id="exemptAutoLogout" class="form-control">
                                                        <option value="false">No</option>
                                                        <option value="true">Yes</option>
                                                    </select>
                                                </div>
                                                <div class="col-sm-12"> 
                                                    <button id="submit" type="button" class="btn btn-primary col-sm-12 mt-4">Submit</button>
                                                </div>
                                            </div>
                                            <div clas="col-sm-7">
                                                <div id="priv-title" class="col-sm-7 font-normal mb-2 pb-2" style="border-bottom: 1px solid #eee;">Privileges of User</div>
                                                <div class="col-sm-7" style="max-height: 270px;overflow: auto;">
                                                    <table id="tbl-permission" class="table">
                                                        <thead>
                                                            <tr>
                                                                <th style="width: 60%;">Page</th>
                                                                <th>Read</th>
                                                                <th>Create</th>
                                                                <th>Update</th>
                                                                <th>Delete</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody></tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
            }
        },
        changelogs: {
            guide: function(){
                // https://ivanjov.com/short-guide-to-awesome-changelogs/
                var logDescription = {
                    chore: "Changes to the build process or auxiliary tools and libraries such as documentation generation.",
                    feature: "A new feature.",
                    fix: "A bug fix.",
                    improved: "Significant improvements on UI/UX but neither fixes a bug or adds a feature.",
                    other: "Changes in the system that does not fall under the other changelog types.",
                    refactor: "A code change that neither fixes a bug, adds a feature, or provides significant changes/improvements.",
                    release: "A new version release.",
                    style: "Changes that do not affect the meaning of the code (white-space, formatting, missing semi-colons, etc).",
                },
                othersDescription = {
                    "[PAGE_NAME]": {
                        desc: "Refers to the page/s where changes have been made.",
                        color: "#334fe5"
                    },
                    "(SITE_VERSION)": {
                        desc: "The version of the website. Either a Mobile version or Web version.",
                        color: "#adadad"
                    },
                },
                tbody = "";

                Object.keys(logDescription).forEach(key => {
                    var desc = logDescription[key];
                    tbody += ` <tr>
                                    <td style="font-family: courier;">${key.capitalize()}</td>
                                    <td>${desc}</td>
                                </tr>`;
                });
                tbody += ` <tr>
                                <td style="font-family: courier;">&nbsp;</td>
                                <td>&nbsp;</td>
                            </tr>`;
                Object.keys(othersDescription).forEach(key => {
                    var val = othersDescription[key];
                    tbody += ` <tr>
                                    <td style="font-family: courier;color: ${val.color};">${key}</td>
                                    <td>${val.desc}</td>
                                </tr>`;
                });
                return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                            <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                                <div role="document" class="modal-dialog modal-sm" style="width:500px;">
                                    <div class="modal-content">
                                        <div class="modal-header pb-2">
                                            <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                            <h4 class="modal-title" id="myModalLabel2">Changelog Guide</h4>
                                        </div>
                                        <div class="modal-body row pt-2 pl-4 pr-4">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th style="width: 22%;">Title</th>
                                                        <th>Description</th>
                                                    </tr>
                                                </thead>
                                                <tbody>${tbody}</tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
            }
        },
        notice: {
            emptyProfile: function(){
                var li = "";
                if(CLIENT.allowDownloadFromOtherDB) {
                    li = `<li>Download Profile From WRU Dispatch - ${CLIENT.allowDownloadFromOtherDB}</li>`;
                }
                return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                                <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                                    <div role="document" class="modal-dialog modal-sm">
                                        <div class="modal-content">
                                            <div class="modal-header pb-2">
                                                <button type="button" class="close" id="close" aria-hidden="true">×</button>
                                                <h5 class="modal-title" id="myModalLabel2">Set up your profile</h5>
                                            </div>
                                            <div class="modal-body row pt-2">
                                                <div class="col-sm-12" style="text-align: justify;">
                                                    Your <b class="text-primary">name</b> and/or <b class="text-primary">email</b> is empty. You can set up your profile by clicking the 'Go to Profile' button below.
                                                    <br><br>
                                                    You will be given the following options in setting up your profile:
                                                    <ul style="padding-left: 20px;">
                                                        <li>Download Profile From WRU Main</li>${li}
                                                        <li>Manually edit your profile details</li>
                                                    </ul>
                                                    <div id="empty_profile" type="button" class="btn btn-primary col-sm-12 mt-3" style="width:100%;">Go to Profile</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
            },
            browserNotSupported: function(){
                return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                        <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                            <div role="document" class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class="modal-header p-0" style="background: #00a548">                                         
                                        <img src="https://www.pngkit.com/png/full/150-1507719_png-file-frown.png" style="width: 100px;padding: 25px;margin: auto;display: block;filter: invert();image-rendering: -webkit-optimize-contrast;">
                                    </div>
                                    <div class="modal-body row pt-2">
                                        <div class="col-sm-12" style="text-align: center;">
                                            <h5>Browser version is not supported</h5>
                                            We're very sorry but the version of this browser is not supported. We recommend updating your browser, or try using other browsers such as Google Chrome, Firefox, or Microsoft Edge.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
            },
            sessionTimeout: function(){
                return `<div id="overlay" class="swal2-container swal2-fade swal2-shown" style="overflow-y: auto;">
                                <div id="modal" class="modal" role="dialog" aria-labelledby="myLargeModalLabel">
                                    <div role="document" class="modal-dialog modal-sm">
                                        <div class="modal-content">
                                            <div class="modal-header pb-2">
                                                <h5 class="modal-title" id="myModalLabel2">You have been idle</h5>
                                            </div>
                                            <div class="modal-body row pt-2">
                                                <div class="col-sm-12">This page is being timed out due to inactivity for over 30 minutes. Please refresh the page.</div>
                                                <div class="col-sm-12"> 
                                                    <button type="button" class="btn btn-primary col-sm-12 mt-2" onClick="window.location.reload();">Refresh</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
            }
        }
    };
}
const mobileOptions = new function(){
    return {
        notifications: {
            filter: function(){
                return `<div style="height: 30px;border-bottom: 1px solid #eee;box-shadow: 1px 1px 8px -6px black;position: fixed;width: 100%;z-index: 9;background: white;top: 40px;" class="dt-buttons pl-3">
                            <button id="refresh-toggle" tabindex="0" aria-controls="tbl-notifications" type="button" data-toggle="tooltip" data-original-title="Refresh Table" style="float: left;color: green;border: none;background: none;font-size: 16px;padding: 0px 10px 0px 0px !important;font-weight: bold;" class="dt-button m-0">
                                <span><i title="Refresh Table" class="la la-refresh"></i></span>
                            </button>
                            <button id="filter-toggle" class="dt-button" tabindex="0" aria-controls="tbl-notifications" type="button" data-toggle="tooltip" data-original-title="Filter" style="float: left;color: green;border: none;border-top-width: medium;border-right-width: medium;border-bottom-width: medium;border-left-width: medium;background: none;font-size: 16px;padding: 0px 10px 0px 8px !important;font-weight: bold;">
                                <span><i class="la la-filter" title="Filter"></i></span>
                            </button>
                        </div>`;
            }
        }
    };
};
/************** END VIEWS **************/

if(s == "main"){
    (ENVIRONMENT == "development") ? null : LOGGER.disableLogger();
    WEBSOCKET.connect().then(() => {
        SESSION_FROM_DB(function(){
            PAGE.MAIN.FUNCTION.init();
        },function(){
            LOGOUT();
        });
    });
}